import{r as A,u as Z,c as jm,a as Ee,_ as ie,D as Tt,V as b,O as vt,P as nt,b as de,R as is,d as Ho,e as bs,Q as Be,M as ce,f as Ci,C as xe,g as ft,E as ai,S as _c,h as Nu,i as Ce,j as q2,k as X2,l as xr,m as ye,I as Rh,n as ln,o as jt,F as Jt,p as ui,N as Xe,B as Ye,T as Z2,q as Gu,s as Jm,t as St,v as Gt,w as si,x as Dt,U as _o,y as Cr,z as Ls,A as qm,G as ac,H as cc,J as Dh,K as ey,L as ir,W as hn,X as lt,Y as bc,Z as Cs,$ as or,a0 as gi,a1 as Rt,a2 as Qe,a3 as Vs,a4 as Ji,a5 as Ko,a6 as Xm,a7 as qc,a8 as ws,a9 as st,aa as Xc,ab as ty,ac as It,ad as Zm,ae as iy,af as zt,ag as fn,ah as ar,ai as ss,aj as e1,ak as zu,al as t1,am as bi,an as lc,ao as Bs,ap as sy,aq as ny,ar as Po,as as i1,at as $a,au as Rc,av as bo,aw as Mh,ax as ry,ay as oy,az as ay,aA as s1,aB as Hu,aC as n1,aD as cy,aE as ly,aF as uy,aG as Ro,aH as hy,aI as fy,aJ as Do,aK as tn,aL as as,aM as Ku,aN as dy,aO as Ay,aP as r1,aQ as my,aR as Zc,aS as Lh,aT as py,aU as gy,aV as yy,aW as Ey,aX as Ps,aY as Dc,aZ as vy,a_ as Yt,a$ as xy,b0 as Cy,b1 as Iy,b2 as Sy,b3 as wy,b4 as Ty,b5 as By,b6 as _y,b7 as by,b8 as Qi,b9 as sr,ba as Is,bb as bf,bc as Ry,bd as Dy,be as o1,bf as el,bg as a1,bh as Vu,bi as My,bj as Yu,bk as ns,bl as Ly,bm as Py,bn as c1,bo as Fy,bp as gt,bq as ky,br as dn,bs as Oy,bt as Ph,bu as dt,bv as Uy,bw as Ss,bx as Ir,by as Qy,bz as l1,bA as u1,bB as uc,bC as cr,bD as wi,bE as Fh,bF as h1,bG as Ny,bH as Gy,bI as Sr,bJ as f1,bK as d1,bL as zy,bM as A1,bN as Hy,bO as Ky,bP as kh,bQ as m1,bR as Oh,bS as Uh,bT as Qh,bU as Mc,bV as p1,bW as Vy,bX as Fo,bY as tl,bZ as Rf,b_ as Yy,b$ as g1,c0 as $y,c1 as mo,c2 as xo,c3 as ri,c4 as Wy,c5 as jy,c6 as Jy,c7 as qy,c8 as Xy,c9 as Zy,ca as e3,cb as t3,cc as i3,cd as il,ce as s3,cf as n3,cg as sl}from"./index-nxzWG6Kc.js";import{co as Ub,cp as Qb,cq as Nb,cm as Gb,cn as zb,ci as Hb,cj as Kb,cl as Vb,ck as Yb,ch as $b,cr as Wb}from"./index-nxzWG6Kc.js";const ko=new b,Nh=new b,r3=new b,Df=new de;function o3(n,e,t){const i=ko.setFromMatrixPosition(n.matrixWorld);i.project(e);const s=t.width/2,r=t.height/2;return[i.x*s+s,-(i.y*r)+r]}function a3(n,e){const t=ko.setFromMatrixPosition(n.matrixWorld),i=Nh.setFromMatrixPosition(e.matrixWorld),s=t.sub(i),r=e.getWorldDirection(r3);return s.angleTo(r)>Math.PI/2}function c3(n,e,t,i){const s=ko.setFromMatrixPosition(n.matrixWorld),r=s.clone();r.project(e),Df.set(r.x,r.y),t.setFromCamera(Df,e);const o=t.intersectObjects(i,!0);if(o.length){const a=o[0].distance;return s.distanceTo(t.ray.origin)<a}return!0}function l3(n,e){if(e instanceof vt)return e.zoom;if(e instanceof nt){const t=ko.setFromMatrixPosition(n.matrixWorld),i=Nh.setFromMatrixPosition(e.matrixWorld),s=e.fov*Math.PI/180,r=t.distanceTo(i);return 1/(2*Math.tan(s/2)*r)}else return 1}function u3(n,e,t){if(e instanceof nt||e instanceof vt){const i=ko.setFromMatrixPosition(n.matrixWorld),s=Nh.setFromMatrixPosition(e.matrixWorld),r=i.distanceTo(s),o=(t[1]-t[0])/(e.far-e.near),a=t[1]-o*e.far;return Math.round(o*r+a)}}const $u=n=>Math.abs(n)<1e-10?0:n;function y1(n,e,t=""){let i="matrix3d(";for(let s=0;s!==16;s++)i+=$u(e[s]*n.elements[s])+(s!==15?",":")");return t+i}const h3=(n=>e=>y1(e,n))([1,-1,1,1,1,-1,1,1,1,-1,1,1,1,-1,1,1]),f3=(n=>(e,t)=>y1(e,n(t),"translate(-50%,-50%)"))(n=>[1/n,1/n,1/n,1,-1/n,-1/n,-1/n,-1,1/n,1/n,1/n,1,1,1,1,1]);function d3(n){return n&&typeof n=="object"&&"current"in n}const Lc=A.forwardRef(({children:n,eps:e=.001,style:t,className:i,prepend:s,center:r,fullscreen:o,portal:a,distanceFactor:c,sprite:l=!1,transform:u=!1,occlude:h,onOcclude:f,castShadow:d,receiveShadow:p,material:m,geometry:g,zIndexRange:y=[16777271,0],calculatePosition:v=o3,as:E="div",wrapperClass:C,pointerEvents:x="auto",...I},S)=>{const{gl:w,camera:B,scene:T,size:R,raycaster:_,events:L,viewport:O}=Z(),[U]=A.useState(()=>document.createElement(E)),Q=A.useRef(),G=A.useRef(null),z=A.useRef(0),H=A.useRef([0,0]),N=A.useRef(null),V=A.useRef(null),$=(a==null?void 0:a.current)||L.connected||w.domElement.parentNode,Y=A.useRef(null),M=A.useRef(!1),k=A.useMemo(()=>h&&h!=="blending"||Array.isArray(h)&&h.length&&d3(h[0]),[h]);A.useLayoutEffect(()=>{const q=w.domElement;h&&h==="blending"?(q.style.zIndex=`${Math.floor(y[0]/2)}`,q.style.position="absolute",q.style.pointerEvents="none"):(q.style.zIndex=null,q.style.position=null,q.style.pointerEvents=null)},[h]),A.useLayoutEffect(()=>{if(G.current){const q=Q.current=jm(U);if(T.updateMatrixWorld(),u)U.style.cssText="position:absolute;top:0;left:0;pointer-events:none;overflow:hidden;";else{const re=v(G.current,B,R);U.style.cssText=`position:absolute;top:0;left:0;transform:translate3d(${re[0]}px,${re[1]}px,0);transform-origin:0 0;`}return $&&(s?$.prepend(U):$.appendChild(U)),()=>{$&&$.removeChild(U),q.unmount()}}},[$,u]),A.useLayoutEffect(()=>{C&&(U.className=C)},[C]);const P=A.useMemo(()=>u?{position:"absolute",top:0,left:0,width:R.width,height:R.height,transformStyle:"preserve-3d",pointerEvents:"none"}:{position:"absolute",transform:r?"translate3d(-50%,-50%,0)":"none",...o&&{top:-R.height/2,left:-R.width/2,width:R.width,height:R.height},...t},[t,r,o,R,u]),F=A.useMemo(()=>({position:"absolute",pointerEvents:x}),[x]);A.useLayoutEffect(()=>{if(M.current=!1,u){var q;(q=Q.current)==null||q.render(A.createElement("div",{ref:N,style:P},A.createElement("div",{ref:V,style:F},A.createElement("div",{ref:S,className:i,style:t,children:n}))))}else{var re;(re=Q.current)==null||re.render(A.createElement("div",{ref:S,style:P,className:i,children:n}))}});const J=A.useRef(!0);Ee(q=>{if(G.current){B.updateMatrixWorld(),G.current.updateWorldMatrix(!0,!1);const re=u?H.current:v(G.current,B,R);if(u||Math.abs(z.current-B.zoom)>e||Math.abs(H.current[0]-re[0])>e||Math.abs(H.current[1]-re[1])>e){const he=a3(G.current,B);let fe=!1;k&&(Array.isArray(h)?fe=h.map(me=>me.current):h!=="blending"&&(fe=[T]));const ae=J.current;if(fe){const me=c3(G.current,B,_,fe);J.current=me&&!he}else J.current=!he;ae!==J.current&&(f?f(!J.current):U.style.display=J.current?"block":"none");const ue=Math.floor(y[0]/2),ge=h?k?[y[0],ue]:[ue-1,0]:y;if(U.style.zIndex=`${u3(G.current,B,ge)}`,u){const[me,W]=[R.width/2,R.height/2],K=B.projectionMatrix.elements[5]*W,{isOrthographicCamera:pe,top:Fe,left:Se,bottom:be,right:De}=B,Ne=h3(B.matrixWorldInverse),ot=pe?`scale(${K})translate(${$u(-(De+Se)/2)}px,${$u((Fe+be)/2)}px)`:`translateZ(${K}px)`;let Je=G.current.matrixWorld;l&&(Je=B.matrixWorldInverse.clone().transpose().copyPosition(Je).scale(G.current.scale),Je.elements[3]=Je.elements[7]=Je.elements[11]=0,Je.elements[15]=1),U.style.width=R.width+"px",U.style.height=R.height+"px",U.style.perspective=pe?"":`${K}px`,N.current&&V.current&&(N.current.style.transform=`${ot}${Ne}translate(${me}px,${W}px)`,V.current.style.transform=f3(Je,1/((c||10)/400)))}else{const me=c===void 0?1:l3(G.current,B)*c;U.style.transform=`translate3d(${re[0]}px,${re[1]}px,0) scale(${me})`}H.current=re,z.current=B.zoom}}if(!k&&Y.current&&!M.current)if(u){if(N.current){const re=N.current.children[0];if(re!=null&&re.clientWidth&&re!=null&&re.clientHeight){const{isOrthographicCamera:he}=B;if(he||g)I.scale&&(Array.isArray(I.scale)?I.scale instanceof b?Y.current.scale.copy(I.scale.clone().divideScalar(1)):Y.current.scale.set(1/I.scale[0],1/I.scale[1],1/I.scale[2]):Y.current.scale.setScalar(1/I.scale));else{const fe=(c||10)/400,ae=re.clientWidth*fe,ue=re.clientHeight*fe;Y.current.scale.set(ae,ue,1)}M.current=!0}}}else{const re=U.children[0];if(re!=null&&re.clientWidth&&re!=null&&re.clientHeight){const he=1/O.factor,fe=re.clientWidth*he,ae=re.clientHeight*he;Y.current.scale.set(fe,ae,1),M.current=!0}Y.current.lookAt(q.camera.position)}});const se=A.useMemo(()=>({vertexShader:u?void 0:`
          /*
            This shader is from the THREE's SpriteMaterial.
            We need to turn the backing plane into a Sprite
            (make it always face the camera) if "transfrom"
            is false.
          */
          #include <common>

          void main() {
            vec2 center = vec2(0., 1.);
            float rotation = 0.0;

            // This is somewhat arbitrary, but it seems to work well
            // Need to figure out how to derive this dynamically if it even matters
            float size = 0.03;

            vec4 mvPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );
            vec2 scale;
            scale.x = length( vec3( modelMatrix[ 0 ].x, modelMatrix[ 0 ].y, modelMatrix[ 0 ].z ) );
            scale.y = length( vec3( modelMatrix[ 1 ].x, modelMatrix[ 1 ].y, modelMatrix[ 1 ].z ) );

            bool isPerspective = isPerspectiveMatrix( projectionMatrix );
            if ( isPerspective ) scale *= - mvPosition.z;

            vec2 alignedPosition = ( position.xy - ( center - vec2( 0.5 ) ) ) * scale * size;
            vec2 rotatedPosition;
            rotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;
            rotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;
            mvPosition.xy += rotatedPosition;

            gl_Position = projectionMatrix * mvPosition;
          }
      `,fragmentShader:`
        void main() {
          gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0);
        }
      `}),[u]);return A.createElement("group",ie({},I,{ref:G}),h&&!k&&A.createElement("mesh",{castShadow:d,receiveShadow:p,ref:Y},g||A.createElement("planeGeometry",null),m||A.createElement("shaderMaterial",{side:Tt,vertexShader:se.vertexShader,fragmentShader:se.fragmentShader})))});function KB({onChanged:n,portal:e,preventDefault:t=!0,scroll:i=!0,keyCode:s=9}){const r=A.useRef(0),o=Z(l=>l.setEvents),a=Z(l=>l.get),c=Z(l=>l.gl);return A.useEffect(()=>{var l;let u=[],h;const f=a().events.filter,d=(l=e==null?void 0:e.current)!==null&&l!==void 0?l:c.domElement.parentNode,p=()=>d&&n&&n(u,Math.round(r.current)%u.length);o({filter:(E,C)=>{let x=[...E];(x.length!==u.length||!u.every(I=>x.map(S=>S.object.uuid).includes(I.object.uuid)))&&(r.current=0,u=x,p()),f&&(x=f(x,C));for(let I=0;I<Math.round(r.current)%x.length;I++){const S=x.shift();x=[...x,S]}return x}});const m=E=>{var C,x;r.current=E(r.current),(C=a().events.handlers)==null||C.onPointerCancel(void 0),(x=a().events.handlers)==null||x.onPointerMove(h),p()},g=E=>{(E.keyCode||E.which)===s&&(t&&E.preventDefault(),u.length>1&&m(C=>C+1))},y=E=>{t&&E.preventDefault();let C=0;E||(E=window.event),E.wheelDelta?C=E.wheelDelta/120:E.detail&&(C=-E.detail/3),u.length>1&&m(x=>Math.abs(x-C))},v=E=>h=E;return document.addEventListener("pointermove",v,{passive:!0}),i&&document.addEventListener("wheel",y),s!==void 0&&document.addEventListener("keydown",g),()=>{o({filter:f}),s!==void 0&&document.removeEventListener("keydown",g),i&&document.removeEventListener("wheel",y),document.removeEventListener("pointermove",v)}},[c,a,o,t,i,s]),null}function VB(n,e="pointer",t="auto",i=document.body){A.useEffect(()=>{if(n)return i.style.cursor=e,()=>void(i.style.cursor=t)},[n])}const Mf=n=>{let e;const t=new Set,i=(l,u)=>{const h=typeof l=="function"?l(e):l;if(!Object.is(h,e)){const f=e;e=u??(typeof h!="object"||h===null)?h:Object.assign({},e,h),t.forEach(d=>d(e,f))}},s=()=>e,a={setState:i,getState:s,getInitialState:()=>c,subscribe:l=>(t.add(l),()=>t.delete(l))},c=e=n(i,s,a);return a},A3=n=>n?Mf(n):Mf,m3=n=>n;function p3(n,e=m3){const t=is.useSyncExternalStore(n.subscribe,()=>e(n.getState()),()=>e(n.getInitialState()));return is.useDebugValue(t),t}const Lf=n=>{const e=A3(n),t=i=>p3(e,i);return Object.assign(t,e),t},E1=n=>n?Lf(n):Lf;let Rr=0;const v1=E1(n=>(Ho.onStart=(e,t,i)=>{n({active:!0,item:e,loaded:t,total:i,progress:(t-Rr)/(i-Rr)*100})},Ho.onLoad=()=>{n({active:!1})},Ho.onError=e=>n(t=>({errors:[...t.errors,e]})),Ho.onProgress=(e,t,i)=>{t===i&&(Rr=i),n({active:!0,item:e,loaded:t,total:i,progress:(t-Rr)/(i-Rr)*100||100})},{errors:[],active:!1,progress:0,item:"",loaded:0,total:0}));function YB({children:n}){const e=v1();return A.createElement(A.Fragment,null,n==null?void 0:n(e))}const g3=n=>`Loading ${n.toFixed(2)}%`;function $B({containerStyles:n,innerStyles:e,barStyles:t,dataStyles:i,dataInterpolation:s=g3,initialState:r=o=>o}){const{active:o,progress:a}=v1(),c=A.useRef(0),l=A.useRef(0),u=A.useRef(null),[h,f]=A.useState(r(o));A.useEffect(()=>{let p;return o!==h&&(p=setTimeout(()=>f(o),300)),()=>clearTimeout(p)},[h,o]);const d=A.useCallback(()=>{u.current&&(c.current+=(a-c.current)/2,(c.current>.95*a||a===100)&&(c.current=a),u.current.innerText=s(c.current),c.current<a&&(l.current=requestAnimationFrame(d)))},[s,a]);return A.useEffect(()=>(d(),()=>cancelAnimationFrame(l.current)),[d]),h?A.createElement("div",{style:{...Vo.container,opacity:o?1:0,...n}},A.createElement("div",null,A.createElement("div",{style:{...Vo.inner,...e}},A.createElement("div",{style:{...Vo.bar,transform:`scaleX(${a/100})`,...t}}),A.createElement("span",{ref:u,style:{...Vo.data,...i}})))):null}const Vo={container:{position:"absolute",top:0,left:0,width:"100%",height:"100%",background:"#171717",display:"flex",alignItems:"center",justifyContent:"center",transition:"opacity 300ms ease",zIndex:1e3},inner:{width:100,height:3,background:"#272727",textAlign:"center"},bar:{height:3,width:"100%",background:"white",transition:"transform 200ms",transformOrigin:"left center"},data:{display:"inline-block",position:"relative",fontVariantNumeric:"tabular-nums",marginTop:"0.8em",color:"#f0f0f0",fontSize:"0.6em",fontFamily:'-apple-system, BlinkMacSystemFont, "Inter", "Segoe UI", "Helvetica Neue", Helvetica, Arial, Roboto, Ubuntu, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"',whiteSpace:"nowrap"}};function y3(n,e,t){return Math.max(e,Math.min(n,t))}const tt={toVector(n,e){return n===void 0&&(n=e),Array.isArray(n)?n:[n,n]},add(n,e){return[n[0]+e[0],n[1]+e[1]]},sub(n,e){return[n[0]-e[0],n[1]-e[1]]},addTo(n,e){n[0]+=e[0],n[1]+=e[1]},subTo(n,e){n[0]-=e[0],n[1]-=e[1]}};function Pf(n,e,t){return e===0||Math.abs(e)===1/0?Math.pow(n,t*5):n*e*t/(e+t*n)}function Ff(n,e,t,i=.15){return i===0?y3(n,e,t):n<e?-Pf(e-n,t-e,i)+e:n>t?+Pf(n-t,t-e,i)+t:n}function E3(n,[e,t],[i,s]){const[[r,o],[a,c]]=n;return[Ff(e,r,o,i),Ff(t,a,c,s)]}function v3(n,e){if(typeof n!="object"||n===null)return n;var t=n[Symbol.toPrimitive];if(t!==void 0){var i=t.call(n,e||"default");if(typeof i!="object")return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(n)}function x3(n){var e=v3(n,"string");return typeof e=="symbol"?e:String(e)}function At(n,e,t){return e=x3(e),e in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function kf(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);e&&(i=i.filter(function(s){return Object.getOwnPropertyDescriptor(n,s).enumerable})),t.push.apply(t,i)}return t}function ct(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?kf(Object(t),!0).forEach(function(i){At(n,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):kf(Object(t)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(t,i))})}return n}const x1={pointer:{start:"down",change:"move",end:"up"},mouse:{start:"down",change:"move",end:"up"},touch:{start:"start",change:"move",end:"end"},gesture:{start:"start",change:"change",end:"end"}};function Of(n){return n?n[0].toUpperCase()+n.slice(1):""}const C3=["enter","leave"];function I3(n=!1,e){return n&&!C3.includes(e)}function S3(n,e="",t=!1){const i=x1[n],s=i&&i[e]||e;return"on"+Of(n)+Of(s)+(I3(t,s)?"Capture":"")}const w3=["gotpointercapture","lostpointercapture"];function T3(n){let e=n.substring(2).toLowerCase();const t=!!~e.indexOf("passive");t&&(e=e.replace("passive",""));const i=w3.includes(e)?"capturecapture":"capture",s=!!~e.indexOf(i);return s&&(e=e.replace("capture","")),{device:e,capture:s,passive:t}}function B3(n,e=""){const t=x1[n],i=t&&t[e]||e;return n+i}function Pc(n){return"touches"in n}function C1(n){return Pc(n)?"touch":"pointerType"in n?n.pointerType:"mouse"}function _3(n){return Array.from(n.touches).filter(e=>{var t,i;return e.target===n.currentTarget||((t=n.currentTarget)===null||t===void 0||(i=t.contains)===null||i===void 0?void 0:i.call(t,e.target))})}function b3(n){return n.type==="touchend"||n.type==="touchcancel"?n.changedTouches:n.targetTouches}function I1(n){return Pc(n)?b3(n)[0]:n}function Wu(n,e){try{const t=e.clientX-n.clientX,i=e.clientY-n.clientY,s=(e.clientX+n.clientX)/2,r=(e.clientY+n.clientY)/2,o=Math.hypot(t,i);return{angle:-(Math.atan2(t,i)*180)/Math.PI,distance:o,origin:[s,r]}}catch{}return null}function R3(n){return _3(n).map(e=>e.identifier)}function Uf(n,e){const[t,i]=Array.from(n.touches).filter(s=>e.includes(s.identifier));return Wu(t,i)}function nl(n){const e=I1(n);return Pc(n)?e.identifier:e.pointerId}function dr(n){const e=I1(n);return[e.clientX,e.clientY]}const Qf=40,Nf=800;function S1(n){let{deltaX:e,deltaY:t,deltaMode:i}=n;return i===1?(e*=Qf,t*=Qf):i===2&&(e*=Nf,t*=Nf),[e,t]}function D3(n){var e,t;const{scrollX:i,scrollY:s,scrollLeft:r,scrollTop:o}=n.currentTarget;return[(e=i??r)!==null&&e!==void 0?e:0,(t=s??o)!==null&&t!==void 0?t:0]}function M3(n){const e={};if("buttons"in n&&(e.buttons=n.buttons),"shiftKey"in n){const{shiftKey:t,altKey:i,metaKey:s,ctrlKey:r}=n;Object.assign(e,{shiftKey:t,altKey:i,metaKey:s,ctrlKey:r})}return e}function hc(n,...e){return typeof n=="function"?n(...e):n}function L3(){}function P3(...n){return n.length===0?L3:n.length===1?n[0]:function(){let e;for(const t of n)e=t.apply(this,arguments)||e;return e}}function Gf(n,e){return Object.assign({},e,n||{})}const F3=32;class w1{constructor(e,t,i){this.ctrl=e,this.args=t,this.key=i,this.state||(this.state={},this.computeValues([0,0]),this.computeInitial(),this.init&&this.init(),this.reset())}get state(){return this.ctrl.state[this.key]}set state(e){this.ctrl.state[this.key]=e}get shared(){return this.ctrl.state.shared}get eventStore(){return this.ctrl.gestureEventStores[this.key]}get timeoutStore(){return this.ctrl.gestureTimeoutStores[this.key]}get config(){return this.ctrl.config[this.key]}get sharedConfig(){return this.ctrl.config.shared}get handler(){return this.ctrl.handlers[this.key]}reset(){const{state:e,shared:t,ingKey:i,args:s}=this;t[i]=e._active=e.active=e._blocked=e._force=!1,e._step=[!1,!1],e.intentional=!1,e._movement=[0,0],e._distance=[0,0],e._direction=[0,0],e._delta=[0,0],e._bounds=[[-1/0,1/0],[-1/0,1/0]],e.args=s,e.axis=void 0,e.memo=void 0,e.elapsedTime=e.timeDelta=0,e.direction=[0,0],e.distance=[0,0],e.overflow=[0,0],e._movementBound=[!1,!1],e.velocity=[0,0],e.movement=[0,0],e.delta=[0,0],e.timeStamp=0}start(e){const t=this.state,i=this.config;t._active||(this.reset(),this.computeInitial(),t._active=!0,t.target=e.target,t.currentTarget=e.currentTarget,t.lastOffset=i.from?hc(i.from,t):t.offset,t.offset=t.lastOffset,t.startTime=t.timeStamp=e.timeStamp)}computeValues(e){const t=this.state;t._values=e,t.values=this.config.transform(e)}computeInitial(){const e=this.state;e._initial=e._values,e.initial=e.values}compute(e){const{state:t,config:i,shared:s}=this;t.args=this.args;let r=0;if(e&&(t.event=e,i.preventDefault&&e.cancelable&&t.event.preventDefault(),t.type=e.type,s.touches=this.ctrl.pointerIds.size||this.ctrl.touchIds.size,s.locked=!!document.pointerLockElement,Object.assign(s,M3(e)),s.down=s.pressed=s.buttons%2===1||s.touches>0,r=e.timeStamp-t.timeStamp,t.timeStamp=e.timeStamp,t.elapsedTime=t.timeStamp-t.startTime),t._active){const I=t._delta.map(Math.abs);tt.addTo(t._distance,I)}this.axisIntent&&this.axisIntent(e);const[o,a]=t._movement,[c,l]=i.threshold,{_step:u,values:h}=t;if(i.hasCustomTransform?(u[0]===!1&&(u[0]=Math.abs(o)>=c&&h[0]),u[1]===!1&&(u[1]=Math.abs(a)>=l&&h[1])):(u[0]===!1&&(u[0]=Math.abs(o)>=c&&Math.sign(o)*c),u[1]===!1&&(u[1]=Math.abs(a)>=l&&Math.sign(a)*l)),t.intentional=u[0]!==!1||u[1]!==!1,!t.intentional)return;const f=[0,0];if(i.hasCustomTransform){const[I,S]=h;f[0]=u[0]!==!1?I-u[0]:0,f[1]=u[1]!==!1?S-u[1]:0}else f[0]=u[0]!==!1?o-u[0]:0,f[1]=u[1]!==!1?a-u[1]:0;this.restrictToAxis&&!t._blocked&&this.restrictToAxis(f);const d=t.offset,p=t._active&&!t._blocked||t.active;p&&(t.first=t._active&&!t.active,t.last=!t._active&&t.active,t.active=s[this.ingKey]=t._active,e&&(t.first&&("bounds"in i&&(t._bounds=hc(i.bounds,t)),this.setup&&this.setup()),t.movement=f,this.computeOffset()));const[m,g]=t.offset,[[y,v],[E,C]]=t._bounds;t.overflow=[m<y?-1:m>v?1:0,g<E?-1:g>C?1:0],t._movementBound[0]=t.overflow[0]?t._movementBound[0]===!1?t._movement[0]:t._movementBound[0]:!1,t._movementBound[1]=t.overflow[1]?t._movementBound[1]===!1?t._movement[1]:t._movementBound[1]:!1;const x=t._active?i.rubberband||[0,0]:[0,0];if(t.offset=E3(t._bounds,t.offset,x),t.delta=tt.sub(t.offset,d),this.computeMovement(),p&&(!t.last||r>F3)){t.delta=tt.sub(t.offset,d);const I=t.delta.map(Math.abs);tt.addTo(t.distance,I),t.direction=t.delta.map(Math.sign),t._direction=t._delta.map(Math.sign),!t.first&&r>0&&(t.velocity=[I[0]/r,I[1]/r],t.timeDelta=r)}}emit(){const e=this.state,t=this.shared,i=this.config;if(e._active||this.clean(),(e._blocked||!e.intentional)&&!e._force&&!i.triggerAllEvents)return;const s=this.handler(ct(ct(ct({},t),e),{},{[this.aliasKey]:e.values}));s!==void 0&&(e.memo=s)}clean(){this.eventStore.clean(),this.timeoutStore.clean()}}function k3([n,e],t){const i=Math.abs(n),s=Math.abs(e);if(i>s&&i>t)return"x";if(s>i&&s>t)return"y"}class Oo extends w1{constructor(...e){super(...e),At(this,"aliasKey","xy")}reset(){super.reset(),this.state.axis=void 0}init(){this.state.offset=[0,0],this.state.lastOffset=[0,0]}computeOffset(){this.state.offset=tt.add(this.state.lastOffset,this.state.movement)}computeMovement(){this.state.movement=tt.sub(this.state.offset,this.state.lastOffset)}axisIntent(e){const t=this.state,i=this.config;if(!t.axis&&e){const s=typeof i.axisThreshold=="object"?i.axisThreshold[C1(e)]:i.axisThreshold;t.axis=k3(t._movement,s)}t._blocked=(i.lockDirection||!!i.axis)&&!t.axis||!!i.axis&&i.axis!==t.axis}restrictToAxis(e){if(this.config.axis||this.config.lockDirection)switch(this.state.axis){case"x":e[1]=0;break;case"y":e[0]=0;break}}}const O3=n=>n,zf=.15,T1={enabled(n=!0){return n},eventOptions(n,e,t){return ct(ct({},t.shared.eventOptions),n)},preventDefault(n=!1){return n},triggerAllEvents(n=!1){return n},rubberband(n=0){switch(n){case!0:return[zf,zf];case!1:return[0,0];default:return tt.toVector(n)}},from(n){if(typeof n=="function")return n;if(n!=null)return tt.toVector(n)},transform(n,e,t){const i=n||t.shared.transform;return this.hasCustomTransform=!!i,i||O3},threshold(n){return tt.toVector(n,0)}},U3=0,An=ct(ct({},T1),{},{axis(n,e,{axis:t}){if(this.lockDirection=t==="lock",!this.lockDirection)return t},axisThreshold(n=U3){return n},bounds(n={}){if(typeof n=="function")return r=>An.bounds(n(r));if("current"in n)return()=>n.current;if(typeof HTMLElement=="function"&&n instanceof HTMLElement)return n;const{left:e=-1/0,right:t=1/0,top:i=-1/0,bottom:s=1/0}=n;return[[e,t],[i,s]]}}),Hf={ArrowRight:(n,e=1)=>[n*e,0],ArrowLeft:(n,e=1)=>[-1*n*e,0],ArrowUp:(n,e=1)=>[0,-1*n*e],ArrowDown:(n,e=1)=>[0,n*e]};class Q3 extends Oo{constructor(...e){super(...e),At(this,"ingKey","dragging")}reset(){super.reset();const e=this.state;e._pointerId=void 0,e._pointerActive=!1,e._keyboardActive=!1,e._preventScroll=!1,e._delayed=!1,e.swipe=[0,0],e.tap=!1,e.canceled=!1,e.cancel=this.cancel.bind(this)}setup(){const e=this.state;if(e._bounds instanceof HTMLElement){const t=e._bounds.getBoundingClientRect(),i=e.currentTarget.getBoundingClientRect(),s={left:t.left-i.left+e.offset[0],right:t.right-i.right+e.offset[0],top:t.top-i.top+e.offset[1],bottom:t.bottom-i.bottom+e.offset[1]};e._bounds=An.bounds(s)}}cancel(){const e=this.state;e.canceled||(e.canceled=!0,e._active=!1,setTimeout(()=>{this.compute(),this.emit()},0))}setActive(){this.state._active=this.state._pointerActive||this.state._keyboardActive}clean(){this.pointerClean(),this.state._pointerActive=!1,this.state._keyboardActive=!1,super.clean()}pointerDown(e){const t=this.config,i=this.state;if(e.buttons!=null&&(Array.isArray(t.pointerButtons)?!t.pointerButtons.includes(e.buttons):t.pointerButtons!==-1&&t.pointerButtons!==e.buttons))return;const s=this.ctrl.setEventIds(e);t.pointerCapture&&e.target.setPointerCapture(e.pointerId),!(s&&s.size>1&&i._pointerActive)&&(this.start(e),this.setupPointer(e),i._pointerId=nl(e),i._pointerActive=!0,this.computeValues(dr(e)),this.computeInitial(),t.preventScrollAxis&&C1(e)!=="mouse"?(i._active=!1,this.setupScrollPrevention(e)):t.delay>0?(this.setupDelayTrigger(e),t.triggerAllEvents&&(this.compute(e),this.emit())):this.startPointerDrag(e))}startPointerDrag(e){const t=this.state;t._active=!0,t._preventScroll=!0,t._delayed=!1,this.compute(e),this.emit()}pointerMove(e){const t=this.state,i=this.config;if(!t._pointerActive)return;const s=nl(e);if(t._pointerId!==void 0&&s!==t._pointerId)return;const r=dr(e);if(document.pointerLockElement===e.target?t._delta=[e.movementX,e.movementY]:(t._delta=tt.sub(r,t._values),this.computeValues(r)),tt.addTo(t._movement,t._delta),this.compute(e),t._delayed&&t.intentional){this.timeoutStore.remove("dragDelay"),t.active=!1,this.startPointerDrag(e);return}if(i.preventScrollAxis&&!t._preventScroll)if(t.axis)if(t.axis===i.preventScrollAxis||i.preventScrollAxis==="xy"){t._active=!1,this.clean();return}else{this.timeoutStore.remove("startPointerDrag"),this.startPointerDrag(e);return}else return;this.emit()}pointerUp(e){this.ctrl.setEventIds(e);try{this.config.pointerCapture&&e.target.hasPointerCapture(e.pointerId)&&e.target.releasePointerCapture(e.pointerId)}catch{}const t=this.state,i=this.config;if(!t._active||!t._pointerActive)return;const s=nl(e);if(t._pointerId!==void 0&&s!==t._pointerId)return;this.state._pointerActive=!1,this.setActive(),this.compute(e);const[r,o]=t._distance;if(t.tap=r<=i.tapsThreshold&&o<=i.tapsThreshold,t.tap&&i.filterTaps)t._force=!0;else{const[a,c]=t._delta,[l,u]=t._movement,[h,f]=i.swipe.velocity,[d,p]=i.swipe.distance,m=i.swipe.duration;if(t.elapsedTime<m){const g=Math.abs(a/t.timeDelta),y=Math.abs(c/t.timeDelta);g>h&&Math.abs(l)>d&&(t.swipe[0]=Math.sign(a)),y>f&&Math.abs(u)>p&&(t.swipe[1]=Math.sign(c))}}this.emit()}pointerClick(e){!this.state.tap&&e.detail>0&&(e.preventDefault(),e.stopPropagation())}setupPointer(e){const t=this.config,i=t.device;t.pointerLock&&e.currentTarget.requestPointerLock(),t.pointerCapture||(this.eventStore.add(this.sharedConfig.window,i,"change",this.pointerMove.bind(this)),this.eventStore.add(this.sharedConfig.window,i,"end",this.pointerUp.bind(this)),this.eventStore.add(this.sharedConfig.window,i,"cancel",this.pointerUp.bind(this)))}pointerClean(){this.config.pointerLock&&document.pointerLockElement===this.state.currentTarget&&document.exitPointerLock()}preventScroll(e){this.state._preventScroll&&e.cancelable&&e.preventDefault()}setupScrollPrevention(e){this.state._preventScroll=!1,N3(e);const t=this.eventStore.add(this.sharedConfig.window,"touch","change",this.preventScroll.bind(this),{passive:!1});this.eventStore.add(this.sharedConfig.window,"touch","end",t),this.eventStore.add(this.sharedConfig.window,"touch","cancel",t),this.timeoutStore.add("startPointerDrag",this.startPointerDrag.bind(this),this.config.preventScrollDelay,e)}setupDelayTrigger(e){this.state._delayed=!0,this.timeoutStore.add("dragDelay",()=>{this.state._step=[0,0],this.startPointerDrag(e)},this.config.delay)}keyDown(e){const t=Hf[e.key];if(t){const i=this.state,s=e.shiftKey?10:e.altKey?.1:1;this.start(e),i._delta=t(this.config.keyboardDisplacement,s),i._keyboardActive=!0,tt.addTo(i._movement,i._delta),this.compute(e),this.emit()}}keyUp(e){e.key in Hf&&(this.state._keyboardActive=!1,this.setActive(),this.compute(e),this.emit())}bind(e){const t=this.config.device;e(t,"start",this.pointerDown.bind(this)),this.config.pointerCapture&&(e(t,"change",this.pointerMove.bind(this)),e(t,"end",this.pointerUp.bind(this)),e(t,"cancel",this.pointerUp.bind(this)),e("lostPointerCapture","",this.pointerUp.bind(this))),this.config.keys&&(e("key","down",this.keyDown.bind(this)),e("key","up",this.keyUp.bind(this))),this.config.filterTaps&&e("click","",this.pointerClick.bind(this),{capture:!0,passive:!1})}}function N3(n){"persist"in n&&typeof n.persist=="function"&&n.persist()}const Uo=typeof window<"u"&&window.document&&window.document.createElement;function B1(){return Uo&&"ontouchstart"in window}function G3(){return B1()||Uo&&window.navigator.maxTouchPoints>1}function z3(){return Uo&&"onpointerdown"in window}function H3(){return Uo&&"exitPointerLock"in window.document}function K3(){try{return"constructor"in GestureEvent}catch{return!1}}const Ii={isBrowser:Uo,gesture:K3(),touch:B1(),touchscreen:G3(),pointer:z3(),pointerLock:H3()},V3=250,Y3=180,$3=.5,W3=50,j3=250,J3=10,Kf={mouse:0,touch:0,pen:8},q3=ct(ct({},An),{},{device(n,e,{pointer:{touch:t=!1,lock:i=!1,mouse:s=!1}={}}){return this.pointerLock=i&&Ii.pointerLock,Ii.touch&&t?"touch":this.pointerLock?"mouse":Ii.pointer&&!s?"pointer":Ii.touch?"touch":"mouse"},preventScrollAxis(n,e,{preventScroll:t}){if(this.preventScrollDelay=typeof t=="number"?t:t||t===void 0&&n?V3:void 0,!(!Ii.touchscreen||t===!1))return n||(t!==void 0?"y":void 0)},pointerCapture(n,e,{pointer:{capture:t=!0,buttons:i=1,keys:s=!0}={}}){return this.pointerButtons=i,this.keys=s,!this.pointerLock&&this.device==="pointer"&&t},threshold(n,e,{filterTaps:t=!1,tapsThreshold:i=3,axis:s=void 0}){const r=tt.toVector(n,t?i:s?1:0);return this.filterTaps=t,this.tapsThreshold=i,r},swipe({velocity:n=$3,distance:e=W3,duration:t=j3}={}){return{velocity:this.transform(tt.toVector(n)),distance:this.transform(tt.toVector(e)),duration:t}},delay(n=0){switch(n){case!0:return Y3;case!1:return 0;default:return n}},axisThreshold(n){return n?ct(ct({},Kf),n):Kf},keyboardDisplacement(n=J3){return n}});function _1(n){const[e,t]=n.overflow,[i,s]=n._delta,[r,o]=n._direction;(e<0&&i>0&&r<0||e>0&&i<0&&r>0)&&(n._movement[0]=n._movementBound[0]),(t<0&&s>0&&o<0||t>0&&s<0&&o>0)&&(n._movement[1]=n._movementBound[1])}const X3=30,Z3=100;class eE extends w1{constructor(...e){super(...e),At(this,"ingKey","pinching"),At(this,"aliasKey","da")}init(){this.state.offset=[1,0],this.state.lastOffset=[1,0],this.state._pointerEvents=new Map}reset(){super.reset();const e=this.state;e._touchIds=[],e.canceled=!1,e.cancel=this.cancel.bind(this),e.turns=0}computeOffset(){const{type:e,movement:t,lastOffset:i}=this.state;e==="wheel"?this.state.offset=tt.add(t,i):this.state.offset=[(1+t[0])*i[0],t[1]+i[1]]}computeMovement(){const{offset:e,lastOffset:t}=this.state;this.state.movement=[e[0]/t[0],e[1]-t[1]]}axisIntent(){const e=this.state,[t,i]=e._movement;if(!e.axis){const s=Math.abs(t)*X3-Math.abs(i);s<0?e.axis="angle":s>0&&(e.axis="scale")}}restrictToAxis(e){this.config.lockDirection&&(this.state.axis==="scale"?e[1]=0:this.state.axis==="angle"&&(e[0]=0))}cancel(){const e=this.state;e.canceled||setTimeout(()=>{e.canceled=!0,e._active=!1,this.compute(),this.emit()},0)}touchStart(e){this.ctrl.setEventIds(e);const t=this.state,i=this.ctrl.touchIds;if(t._active&&t._touchIds.every(r=>i.has(r))||i.size<2)return;this.start(e),t._touchIds=Array.from(i).slice(0,2);const s=Uf(e,t._touchIds);s&&this.pinchStart(e,s)}pointerStart(e){if(e.buttons!=null&&e.buttons%2!==1)return;this.ctrl.setEventIds(e),e.target.setPointerCapture(e.pointerId);const t=this.state,i=t._pointerEvents,s=this.ctrl.pointerIds;if(t._active&&Array.from(i.keys()).every(o=>s.has(o))||(i.size<2&&i.set(e.pointerId,e),t._pointerEvents.size<2))return;this.start(e);const r=Wu(...Array.from(i.values()));r&&this.pinchStart(e,r)}pinchStart(e,t){const i=this.state;i.origin=t.origin,this.computeValues([t.distance,t.angle]),this.computeInitial(),this.compute(e),this.emit()}touchMove(e){if(!this.state._active)return;const t=Uf(e,this.state._touchIds);t&&this.pinchMove(e,t)}pointerMove(e){const t=this.state._pointerEvents;if(t.has(e.pointerId)&&t.set(e.pointerId,e),!this.state._active)return;const i=Wu(...Array.from(t.values()));i&&this.pinchMove(e,i)}pinchMove(e,t){const i=this.state,s=i._values[1],r=t.angle-s;let o=0;Math.abs(r)>270&&(o+=Math.sign(r)),this.computeValues([t.distance,t.angle-360*o]),i.origin=t.origin,i.turns=o,i._movement=[i._values[0]/i._initial[0]-1,i._values[1]-i._initial[1]],this.compute(e),this.emit()}touchEnd(e){this.ctrl.setEventIds(e),this.state._active&&this.state._touchIds.some(t=>!this.ctrl.touchIds.has(t))&&(this.state._active=!1,this.compute(e),this.emit())}pointerEnd(e){const t=this.state;this.ctrl.setEventIds(e);try{e.target.releasePointerCapture(e.pointerId)}catch{}t._pointerEvents.has(e.pointerId)&&t._pointerEvents.delete(e.pointerId),t._active&&t._pointerEvents.size<2&&(t._active=!1,this.compute(e),this.emit())}gestureStart(e){e.cancelable&&e.preventDefault();const t=this.state;t._active||(this.start(e),this.computeValues([e.scale,e.rotation]),t.origin=[e.clientX,e.clientY],this.compute(e),this.emit())}gestureMove(e){if(e.cancelable&&e.preventDefault(),!this.state._active)return;const t=this.state;this.computeValues([e.scale,e.rotation]),t.origin=[e.clientX,e.clientY];const i=t._movement;t._movement=[e.scale-1,e.rotation],t._delta=tt.sub(t._movement,i),this.compute(e),this.emit()}gestureEnd(e){this.state._active&&(this.state._active=!1,this.compute(e),this.emit())}wheel(e){const t=this.config.modifierKey;t&&(Array.isArray(t)?!t.find(i=>e[i]):!e[t])||(this.state._active?this.wheelChange(e):this.wheelStart(e),this.timeoutStore.add("wheelEnd",this.wheelEnd.bind(this)))}wheelStart(e){this.start(e),this.wheelChange(e)}wheelChange(e){"uv"in e||e.cancelable&&e.preventDefault();const i=this.state;i._delta=[-S1(e)[1]/Z3*i.offset[0],0],tt.addTo(i._movement,i._delta),_1(i),this.state.origin=[e.clientX,e.clientY],this.compute(e),this.emit()}wheelEnd(){this.state._active&&(this.state._active=!1,this.compute(),this.emit())}bind(e){const t=this.config.device;t&&(e(t,"start",this[t+"Start"].bind(this)),e(t,"change",this[t+"Move"].bind(this)),e(t,"end",this[t+"End"].bind(this)),e(t,"cancel",this[t+"End"].bind(this)),e("lostPointerCapture","",this[t+"End"].bind(this))),this.config.pinchOnWheel&&e("wheel","",this.wheel.bind(this),{passive:!1})}}const tE=ct(ct({},T1),{},{device(n,e,{shared:t,pointer:{touch:i=!1}={}}){if(t.target&&!Ii.touch&&Ii.gesture)return"gesture";if(Ii.touch&&i)return"touch";if(Ii.touchscreen){if(Ii.pointer)return"pointer";if(Ii.touch)return"touch"}},bounds(n,e,{scaleBounds:t={},angleBounds:i={}}){const s=o=>{const a=Gf(hc(t,o),{min:-1/0,max:1/0});return[a.min,a.max]},r=o=>{const a=Gf(hc(i,o),{min:-1/0,max:1/0});return[a.min,a.max]};return typeof t!="function"&&typeof i!="function"?[s(),r()]:o=>[s(o),r(o)]},threshold(n,e,t){return this.lockDirection=t.axis==="lock",tt.toVector(n,this.lockDirection?[.1,3]:0)},modifierKey(n){return n===void 0?"ctrlKey":n},pinchOnWheel(n=!0){return n}});class iE extends Oo{constructor(...e){super(...e),At(this,"ingKey","moving")}move(e){this.config.mouseOnly&&e.pointerType!=="mouse"||(this.state._active?this.moveChange(e):this.moveStart(e),this.timeoutStore.add("moveEnd",this.moveEnd.bind(this)))}moveStart(e){this.start(e),this.computeValues(dr(e)),this.compute(e),this.computeInitial(),this.emit()}moveChange(e){if(!this.state._active)return;const t=dr(e),i=this.state;i._delta=tt.sub(t,i._values),tt.addTo(i._movement,i._delta),this.computeValues(t),this.compute(e),this.emit()}moveEnd(e){this.state._active&&(this.state._active=!1,this.compute(e),this.emit())}bind(e){e("pointer","change",this.move.bind(this)),e("pointer","leave",this.moveEnd.bind(this))}}const sE=ct(ct({},An),{},{mouseOnly:(n=!0)=>n});class nE extends Oo{constructor(...e){super(...e),At(this,"ingKey","scrolling")}scroll(e){this.state._active||this.start(e),this.scrollChange(e),this.timeoutStore.add("scrollEnd",this.scrollEnd.bind(this))}scrollChange(e){e.cancelable&&e.preventDefault();const t=this.state,i=D3(e);t._delta=tt.sub(i,t._values),tt.addTo(t._movement,t._delta),this.computeValues(i),this.compute(e),this.emit()}scrollEnd(){this.state._active&&(this.state._active=!1,this.compute(),this.emit())}bind(e){e("scroll","",this.scroll.bind(this))}}const rE=An;class oE extends Oo{constructor(...e){super(...e),At(this,"ingKey","wheeling")}wheel(e){this.state._active||this.start(e),this.wheelChange(e),this.timeoutStore.add("wheelEnd",this.wheelEnd.bind(this))}wheelChange(e){const t=this.state;t._delta=S1(e),tt.addTo(t._movement,t._delta),_1(t),this.compute(e),this.emit()}wheelEnd(){this.state._active&&(this.state._active=!1,this.compute(),this.emit())}bind(e){e("wheel","",this.wheel.bind(this))}}const aE=An;class cE extends Oo{constructor(...e){super(...e),At(this,"ingKey","hovering")}enter(e){this.config.mouseOnly&&e.pointerType!=="mouse"||(this.start(e),this.computeValues(dr(e)),this.compute(e),this.emit())}leave(e){if(this.config.mouseOnly&&e.pointerType!=="mouse")return;const t=this.state;if(!t._active)return;t._active=!1;const i=dr(e);t._movement=t._delta=tt.sub(i,t._values),this.computeValues(i),this.compute(e),t.delta=t.movement,this.emit()}bind(e){e("pointer","enter",this.enter.bind(this)),e("pointer","leave",this.leave.bind(this))}}const lE=ct(ct({},An),{},{mouseOnly:(n=!0)=>n}),Gh=new Map,ju=new Map;function uE(n){Gh.set(n.key,n.engine),ju.set(n.key,n.resolver)}const hE={key:"drag",engine:Q3,resolver:q3},fE={key:"hover",engine:cE,resolver:lE},dE={key:"move",engine:iE,resolver:sE},AE={key:"pinch",engine:eE,resolver:tE},mE={key:"scroll",engine:nE,resolver:rE},pE={key:"wheel",engine:oE,resolver:aE};function gE(n,e){if(n==null)return{};var t={},i=Object.keys(n),s,r;for(r=0;r<i.length;r++)s=i[r],!(e.indexOf(s)>=0)&&(t[s]=n[s]);return t}function yE(n,e){if(n==null)return{};var t=gE(n,e),i,s;if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(n);for(s=0;s<r.length;s++)i=r[s],!(e.indexOf(i)>=0)&&Object.prototype.propertyIsEnumerable.call(n,i)&&(t[i]=n[i])}return t}const EE={target(n){if(n)return()=>"current"in n?n.current:n},enabled(n=!0){return n},window(n=Ii.isBrowser?window:void 0){return n},eventOptions({passive:n=!0,capture:e=!1}={}){return{passive:n,capture:e}},transform(n){return n}},vE=["target","eventOptions","window","enabled","transform"];function Wa(n={},e){const t={};for(const[i,s]of Object.entries(e))switch(typeof s){case"function":t[i]=s.call(t,n[i],i,n);break;case"object":t[i]=Wa(n[i],s);break;case"boolean":s&&(t[i]=n[i]);break}return t}function xE(n,e,t={}){const i=n,{target:s,eventOptions:r,window:o,enabled:a,transform:c}=i,l=yE(i,vE);if(t.shared=Wa({target:s,eventOptions:r,window:o,enabled:a,transform:c},EE),e){const u=ju.get(e);t[e]=Wa(ct({shared:t.shared},l),u)}else for(const u in l){const h=ju.get(u);h&&(t[u]=Wa(ct({shared:t.shared},l[u]),h))}return t}class b1{constructor(e,t){At(this,"_listeners",new Set),this._ctrl=e,this._gestureKey=t}add(e,t,i,s,r){const o=this._listeners,a=B3(t,i),c=this._gestureKey?this._ctrl.config[this._gestureKey].eventOptions:{},l=ct(ct({},c),r);e.addEventListener(a,s,l);const u=()=>{e.removeEventListener(a,s,l),o.delete(u)};return o.add(u),u}clean(){this._listeners.forEach(e=>e()),this._listeners.clear()}}class CE{constructor(){At(this,"_timeouts",new Map)}add(e,t,i=140,...s){this.remove(e),this._timeouts.set(e,window.setTimeout(t,i,...s))}remove(e){const t=this._timeouts.get(e);t&&window.clearTimeout(t)}clean(){this._timeouts.forEach(e=>void window.clearTimeout(e)),this._timeouts.clear()}}class IE{constructor(e){At(this,"gestures",new Set),At(this,"_targetEventStore",new b1(this)),At(this,"gestureEventStores",{}),At(this,"gestureTimeoutStores",{}),At(this,"handlers",{}),At(this,"config",{}),At(this,"pointerIds",new Set),At(this,"touchIds",new Set),At(this,"state",{shared:{shiftKey:!1,metaKey:!1,ctrlKey:!1,altKey:!1}}),SE(this,e)}setEventIds(e){if(Pc(e))return this.touchIds=new Set(R3(e)),this.touchIds;if("pointerId"in e)return e.type==="pointerup"||e.type==="pointercancel"?this.pointerIds.delete(e.pointerId):e.type==="pointerdown"&&this.pointerIds.add(e.pointerId),this.pointerIds}applyHandlers(e,t){this.handlers=e,this.nativeHandlers=t}applyConfig(e,t){this.config=xE(e,t,this.config)}clean(){this._targetEventStore.clean();for(const e of this.gestures)this.gestureEventStores[e].clean(),this.gestureTimeoutStores[e].clean()}effect(){return this.config.shared.target&&this.bind(),()=>this._targetEventStore.clean()}bind(...e){const t=this.config.shared,i={};let s;if(!(t.target&&(s=t.target(),!s))){if(t.enabled){for(const o of this.gestures){const a=this.config[o],c=Vf(i,a.eventOptions,!!s);if(a.enabled){const l=Gh.get(o);new l(this,e,o).bind(c)}}const r=Vf(i,t.eventOptions,!!s);for(const o in this.nativeHandlers)r(o,"",a=>this.nativeHandlers[o](ct(ct({},this.state.shared),{},{event:a,args:e})),void 0,!0)}for(const r in i)i[r]=P3(...i[r]);if(!s)return i;for(const r in i){const{device:o,capture:a,passive:c}=T3(r);this._targetEventStore.add(s,o,"",i[r],{capture:a,passive:c})}}}}function yn(n,e){n.gestures.add(e),n.gestureEventStores[e]=new b1(n,e),n.gestureTimeoutStores[e]=new CE}function SE(n,e){e.drag&&yn(n,"drag"),e.wheel&&yn(n,"wheel"),e.scroll&&yn(n,"scroll"),e.move&&yn(n,"move"),e.pinch&&yn(n,"pinch"),e.hover&&yn(n,"hover")}const Vf=(n,e,t)=>(i,s,r,o={},a=!1)=>{var c,l;const u=(c=o.capture)!==null&&c!==void 0?c:e.capture,h=(l=o.passive)!==null&&l!==void 0?l:e.passive;let f=a?i:S3(i,s,u);t&&h&&(f+="Passive"),n[f]=n[f]||[],n[f].push(r)},wE=/^on(Drag|Wheel|Scroll|Move|Pinch|Hover)/;function TE(n){const e={},t={},i=new Set;for(let s in n)wE.test(s)?(i.add(RegExp.lastMatch),t[s]=n[s]):e[s]=n[s];return[t,e,i]}function En(n,e,t,i,s,r){if(!n.has(t)||!Gh.has(i))return;const o=t+"Start",a=t+"End",c=l=>{let u;return l.first&&o in e&&e[o](l),t in e&&(u=e[t](l)),l.last&&a in e&&e[a](l),u};s[i]=c,r[i]=r[i]||{}}function BE(n,e){const[t,i,s]=TE(n),r={};return En(s,t,"onDrag","drag",r,e),En(s,t,"onWheel","wheel",r,e),En(s,t,"onScroll","scroll",r,e),En(s,t,"onPinch","pinch",r,e),En(s,t,"onMove","move",r,e),En(s,t,"onHover","hover",r,e),{handlers:r,config:e,nativeHandlers:i}}function _E(n,e={},t,i){const s=is.useMemo(()=>new IE(n),[]);if(s.applyHandlers(n,i),s.applyConfig(e,t),is.useEffect(s.effect.bind(s)),is.useEffect(()=>s.clean.bind(s),[]),e.target===void 0)return s.bind.bind(s)}function bE(n){return n.forEach(uE),function(t,i){const{handlers:s,nativeHandlers:r,config:o}=BE(t,i||{});return _E(s,o,void 0,r)}}function R1(n,e){return bE([hE,AE,mE,pE,dE,fE])(n,e||{})}const rl=new b,Yf=new de,Ys=new b,Yo=new b,Dr=new b,$f=new bs,WB=A.forwardRef(({autoTransform:n=!0,matrix:e,axisLock:t,dragLimits:i,onHover:s,onDragStart:r,onDrag:o,onDragEnd:a,children:c,dragConfig:l,...u},h)=>{const f=Z(E=>E.controls),{camera:d,size:p,raycaster:m,invalidate:g}=Z(),y=A.useRef(null),v=R1({onHover:({hovering:E})=>s&&s(E??!1),onDragStart:({event:E})=>{f&&(f.enabled=!1);const{point:C}=E;y.current.matrix.decompose(rl,new Be,new b),Ys.copy(C),Yo.copy(Ys).sub(rl),r&&r(rl),g()},onDrag:({xy:[E,C],intentional:x})=>{if(!x)return;const I=(E-p.left)/p.width*2-1,S=-((C-p.top)/p.height)*2+1;if(Yf.set(I,S),m.setFromCamera(Yf,d),!t)d.getWorldDirection(Dr).negate();else switch(t){case"x":Dr.set(1,0,0);break;case"y":Dr.set(0,1,0);break;case"z":Dr.set(0,0,1);break}$f.setFromNormalAndCoplanarPoint(Dr,Ys),m.ray.intersectPlane($f,Ys);const w=y.current.matrix.clone(),B=y.current.matrixWorld.clone(),T=new b(Ys.x-Yo.x,Ys.y-Yo.y,Ys.z-Yo.z);if(i&&(T.x=i[0]?Math.max(Math.min(T.x,i[0][1]),i[0][0]):T.x,T.y=i[1]?Math.max(Math.min(T.y,i[1][1]),i[1][0]):T.y,T.z=i[2]?Math.max(Math.min(T.z,i[2][1]),i[2][0]):T.z),n){y.current.matrix.setPosition(T);const R=y.current.matrix.clone().multiply(w.invert()),_=y.current.matrix.clone().multiply(B.invert());o&&o(y.current.matrix,R,y.current.matrixWorld,_)}else{const R=new ce().copy(y.current.matrix);R.setPosition(T);const _=R.clone().multiply(w.invert()),L=R.clone().multiply(B.invert());o&&o(R,_,y.current.matrixWorld,L)}g()},onDragEnd:()=>{f&&(f.enabled=!0),a&&a(),g()}},{drag:{filterTaps:!0,threshold:1,...typeof l=="object"?l:{}}});return A.useImperativeHandle(h,()=>y.current,[]),A.useLayoutEffect(()=>{e&&(y.current.matrix=e)},[e]),A.createElement("group",ie({ref:y},v(),{matrix:e,matrixAutoUpdate:!1},u),c)});function Co(n,e,t){return e in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function Ju(n,e){return Ju=Object.setPrototypeOf||function(i,s){return i.__proto__=s,i},Ju(n,e)}function RE(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function DE(){for(var n=arguments.length,e=new Array(n),t=0;t<n;t++)e[t]=arguments[t];var i=e[0],s=e[1],r=e[2],o=e[3],a=e[4],c=e[5],l=e[6],u=e[7],h=e[8];return i*a*h+s*c*l+r*o*u-r*a*l-s*o*h-i*c*u}function Wf(n,e){for(var t=[],i=n.toArray(),s=e.toArray(),r=0;r<i.length;r++)t[r]=i[r]+s[r];return new Ci().fromArray(t)}function ME(n){if(Array.isArray(n))return n}function LE(n,e){var t=n==null?null:typeof Symbol<"u"&&n[Symbol.iterator]||n["@@iterator"];if(t!=null){var i=[],s=!0,r=!1,o,a;try{for(t=t.call(n);!(s=(o=t.next()).done)&&(i.push(o.value),!(e&&i.length===e));s=!0);}catch(c){r=!0,a=c}finally{try{!s&&t.return!=null&&t.return()}finally{if(r)throw a}}return i}}function qu(n,e){(e==null||e>n.length)&&(e=n.length);for(var t=0,i=new Array(e);t<e;t++)i[t]=n[t];return i}function D1(n,e){if(n){if(typeof n=="string")return qu(n,e);var t=Object.prototype.toString.call(n).slice(8,-1);if(t==="Object"&&n.constructor&&(t=n.constructor.name),t==="Map"||t==="Set")return Array.from(n);if(t==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t))return qu(n,e)}}function PE(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function rs(n,e){return ME(n)||LE(n,e)||D1(n,e)||PE()}function FE(n){if(Array.isArray(n))return qu(n)}function kE(n){if(typeof Symbol<"u"&&n[Symbol.iterator]!=null||n["@@iterator"]!=null)return Array.from(n)}function OE(){throw new TypeError(`Invalid attempt to spread non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function fc(n){return FE(n)||kE(n)||D1(n)||OE()}function ja(n,e,t){return RE()?ja=Reflect.construct:ja=function(s,r,o){var a=[null];a.push.apply(a,r);var c=Function.bind.apply(s,a),l=new c;return o&&Ju(l,o.prototype),l},ja.apply(null,arguments)}function UE(n){var e=rs(n[0],2),t=e[0],i=e[1],s=rs(n[1],2),r=s[0],o=s[1],a=rs(n[2],2),c=a[0],l=a[1];return DE(t,i,1,r,o,1,c,l,1)}function QE(n){return UE(n)===0}var NE=new de,GE=new de;function jf(n){var e=n.map(function(l){return Array.isArray(l)?ja(de,fc(l)):l}),t=rs(e,3),i=t[0],s=t[1],r=t[2];if(QE(n))return!1;var o=NE.subVectors(s,i),a=GE.subVectors(r,i),c=a.cross(o);return c>0}function M1(n,e,t){return Math.max(e,Math.min(t,n))}function L1(n,e){return M1(n-Math.floor(n/e)*e,0,e)}function P1(n,e){var t=L1(e-n,Math.PI*2);return t>Math.PI&&(t-=Math.PI*2),t}function zE(n){return n/180*Math.PI}function HE(n){return n*180/Math.PI}function KE(n,e){for(var t=e.radius,i=t===void 0?1:t,s=n.length/3,r=2/s,o=Math.PI*(3-2.2360679775),a=0;a<n.length;a+=3){var c=a*r-1+r/2,l=Math.sqrt(1-Math.pow(c,2)),u=a%s*o,h=Math.cos(u)*l,f=Math.sin(u)*l;n[a]=h*i,n[a+1]=c*i,n[a+2]=f*i}}function VE(n,e){var t=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Number.EPSILON;return Math.abs(n.x-e.x)<t&&Math.abs(n.y-e.y)<t&&Math.abs(n.z-e.z)<t}function F1(n,e){return n.x===e.x?typeof n.z<"u"&&n.y===e.y?n.z-e.z:n.y-e.y:n.x-e.x}function YE(n){for(var e=n.sort(F1),t=[e[0],e[1]],i=2;i<e.length;i++)for(t.push(e[i]);t.length>2&&jf(fc(t.slice(-3)));)t.splice(t.length-2,1);for(var s=[e[e.length-1],e[e.length-2]],r=e.length-3;r>=0;r--)for(s.push(e[r]);s.length>2&&jf(fc(s.slice(-3)));)s.splice(s.length-2,1);s.splice(0,1),s.splice(s.length-1,1);var o=[].concat(t,s);return o}function $E(n,e,t){var i=rs(e,2),s=i[0],r=i[1],o=rs(t,2),a=o[0],c=o[1];return a+(n-s)*(c-a)/(r-s)}function WE(n){return n*n*n*(n*(n*6-15)+10)}function jE(n,e,t){return n*(1-t)+e*t}function k1(n,e,t){return(t-n)/(e-n)}function JE(n,e,t){var i=Math.sqrt(n*n+e*e+t*t);return[n/i,e/i,t/i]}function qE(n,e,t){var i=n*n,s=e*e,r=t*t,o=n*Math.sqrt(1-(s+r)/2+s*r/3),a=e*Math.sqrt(1-(r+i)/2+r*i/3),c=t*Math.sqrt(1-(i+s)/2+i*s/3);return[o,a,c]}function O1(n,e){var t=new b().crossVectors(n,e),i=n.dot(e),s=new Ci().identity(),r=new Ci().set(0,-t.z,t.y,t.z,0,-t.x,-t.y,t.x,0),o=new Ci().multiplyMatrices(r,r).multiplyScalar(1/(1+i)),a=Wf(Wf(s,r),o);return a}function XE(n,e,t){var i=Math.asin(e),s=Math.atan2(n,-t);return[i,s]}function ZE(n,e){var t=Math.sin(n),i=Math.cos(n),s=Math.sin(e)*i,r=-Math.cos(e)*i;return[s,t,r]}function ev(n,e){var t=rs(e,2),i=t[0],s=t[1],r=O1(n.normal,new b(0,1,0)),o=k1(i.clone().applyMatrix3(r).y,s.clone().applyMatrix3(r).y,0);return new b().lerpVectors(i,s,o)}function tv(n,e){var t=e.normal.dot(n);return t}function iv(n,e){var t=rs(n,3),i=t[0],s=t[1],r=t[2],o=rs(e,2),a=o[0],c=o[1];return r*a*c+s*a+i}function sv(n,e){var t=rs(e,2),i=t[0],s=t[1],r=i*s,o=n/r,a=n-r*o,c=a/i,l=a%i;return[l,c,o]}function nv(n,e){return n[0]+e[0]*n[1]}function rv(n,e){var t=n%e,i=Math.floor(n/e);return[t,i]}var ol=Object.freeze({__proto__:null,clamp:M1,repeat:L1,deltaAngle:P1,degToRad:zE,radToDeg:HE,fibonacciOnSphere:KE,vectorEquals:VE,lexicographic:F1,convexHull:YE,remap:$E,fade:WE,lerp:jE,inverseLerp:k1,normalize:JE,pointOnCubeToPointOnSphere:qE,rotateVectorOnVector:O1,pointToCoordinate:XE,coordinateToPoint:ZE,planeSegmentIntersection:ev,pointToPlaneDistance:tv,getIndexFrom3D:iv,get3DFromIndex:sv,getIndexFrom2D:nv,get2DFromIndex:rv});function U1(n,e){if(!(n instanceof e))throw new TypeError("Cannot call a class as a function")}var fi=function n(e,t,i){var s=this;U1(this,n),Co(this,"dot2",function(r,o){return s.x*r+s.y*o}),Co(this,"dot3",function(r,o,a){return s.x*r+s.y*o+s.z*a}),this.x=e,this.y=t,this.z=i},ov=[new fi(1,1,0),new fi(-1,1,0),new fi(1,-1,0),new fi(-1,-1,0),new fi(1,0,1),new fi(-1,0,1),new fi(1,0,-1),new fi(-1,0,-1),new fi(0,1,1),new fi(0,-1,1),new fi(0,1,-1),new fi(0,-1,-1)],Jf=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180],qf=new Array(512),Xf=new Array(512),av=function(e){e>0&&e<1&&(e*=65536),e=Math.floor(e),e<256&&(e|=e<<8);for(var t=0;t<256;t++){var i;t&1?i=Jf[t]^e&255:i=Jf[t]^e>>8&255,qf[t]=qf[t+256]=i,Xf[t]=Xf[t+256]=ov[i%12]}};av(0);function cv(n){if(typeof n=="number")n=Math.abs(n);else if(typeof n=="string"){var e=n;n=0;for(var t=0;t<e.length;t++)n=(n+(t+1)*(e.charCodeAt(t)%96))%2147483647}return n===0&&(n=311),n}function Zf(n){var e=cv(n);return function(){var t=e*48271%2147483647;return e=t,t/2147483647}}var lv=function n(e){var t=this;U1(this,n),Co(this,"seed",0),Co(this,"init",function(i){t.seed=i,t.value=Zf(i)}),Co(this,"value",Zf(this.seed)),this.init(e)};new lv(Math.random());var uv=function(e){var t=arguments.length>1&&arguments[1]!==void 0?arguments[1]:.01,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,s=arguments.length>3&&arguments[3]!==void 0?arguments[3]:1/(2*Math.PI);return i/Math.atan(1/t)*Math.atan(Math.sin(2*Math.PI*e*s)/t)},Q1=function(e){return 1/(1+e+.48*e*e+.235*e*e*e)},hv=function(e){return e},fv={in:function(e){return 1-Math.cos(e*Math.PI/2)},out:function(e){return Math.sin(e*Math.PI/2)},inOut:function(e){return-(Math.cos(Math.PI*e)-1)/2}},dv={in:function(e){return e*e*e},out:function(e){return 1-Math.pow(1-e,3)},inOut:function(e){return e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2}},Av={in:function(e){return e*e*e*e*e},out:function(e){return 1-Math.pow(1-e,5)},inOut:function(e){return e<.5?16*e*e*e*e*e:1-Math.pow(-2*e+2,5)/2}},mv={in:function(e){return 1-Math.sqrt(1-Math.pow(e,2))},out:function(e){return Math.sqrt(1-Math.pow(e-1,2))},inOut:function(e){return e<.5?(1-Math.sqrt(1-Math.pow(2*e,2)))/2:(Math.sqrt(1-Math.pow(-2*e+2,2))+1)/2}},pv={in:function(e){return e*e*e*e},out:function(e){return 1- --e*e*e*e},inOut:function(e){return e<.5?8*e*e*e*e:1-8*--e*e*e*e}},gv={in:function(e){return e===0?0:Math.pow(2,10*e-10)},out:function(e){return e===1?1:1-Math.pow(2,-10*e)},inOut:function(e){return e===0?0:e===1?1:e<.5?Math.pow(2,20*e-10)/2:(2-Math.pow(2,-20*e+10))/2}};function wt(n,e,t){var i=arguments.length>3&&arguments[3]!==void 0?arguments[3]:.25,s=arguments.length>4&&arguments[4]!==void 0?arguments[4]:.01,r=arguments.length>5&&arguments[5]!==void 0?arguments[5]:1/0,o=arguments.length>6&&arguments[6]!==void 0?arguments[6]:Q1,a=arguments.length>7&&arguments[7]!==void 0?arguments[7]:.001,c="velocity_"+e;if(n.__damp===void 0&&(n.__damp={}),n.__damp[c]===void 0&&(n.__damp[c]=0),Math.abs(n[e]-t)<=a)return n[e]=t,!1;i=Math.max(1e-4,i);var l=2/i,u=o(l*s),h=n[e]-t,f=t,d=r*i;h=Math.min(Math.max(h,-d),d),t=n[e]-h;var p=(n.__damp[c]+l*h)*s;n.__damp[c]=(n.__damp[c]-l*p)*u;var m=t+(h+p)*u;return f-n[e]>0==m>f&&(m=f,n.__damp[c]=(m-f)/s),n[e]=m,!0}var yv=function(e){return e&&e.isCamera},Ev=function(e){return e&&e.isLight},Mr=new b,ed=new Be,td=new Be,Lr=new ce,al=new b;function vv(n,e,t,i,s,r,o){typeof e=="number"?Mr.setScalar(e):Array.isArray(e)?Mr.set(e[0],e[1],e[2]):Mr.copy(e);var a=n.parent;n.updateWorldMatrix(!0,!1),al.setFromMatrixPosition(n.matrixWorld),yv(n)||Ev(n)?Lr.lookAt(al,Mr,n.up):Lr.lookAt(Mr,al,n.up),dc(n.quaternion,td.setFromRotationMatrix(Lr),t,i,s,r,o),a&&(Lr.extractRotation(a.matrixWorld),ed.setFromRotationMatrix(Lr),dc(n.quaternion,td.copy(n.quaternion).premultiply(ed.invert()),t,i,s,r,o))}function lr(n,e,t,i,s,r,o,a){return wt(n,e,n[e]+P1(n[e],t),i,s,r,o,a)}var Pr=new de,id,sd;function xv(n,e,t,i,s,r,o){return typeof e=="number"?Pr.setScalar(e):Array.isArray(e)?Pr.set(e[0],e[1]):Pr.copy(e),id=wt(n,"x",Pr.x,t,i,s,r,o),sd=wt(n,"y",Pr.y,t,i,s,r,o),id||sd}var vn=new b,nd,rd,od;function Xu(n,e,t,i,s,r,o){return typeof e=="number"?vn.setScalar(e):Array.isArray(e)?vn.set(e[0],e[1],e[2]):vn.copy(e),nd=wt(n,"x",vn.x,t,i,s,r,o),rd=wt(n,"y",vn.y,t,i,s,r,o),od=wt(n,"z",vn.z,t,i,s,r,o),nd||rd||od}var $s=new ft,ad,cd,ld,ud;function Cv(n,e,t,i,s,r,o){return typeof e=="number"?$s.setScalar(e):Array.isArray(e)?$s.set(e[0],e[1],e[2],e[3]):$s.copy(e),ad=wt(n,"x",$s.x,t,i,s,r,o),cd=wt(n,"y",$s.y,t,i,s,r,o),ld=wt(n,"z",$s.z,t,i,s,r,o),ud=wt(n,"w",$s.w,t,i,s,r,o),ad||cd||ld||ud}var Fr=new ai,hd,fd,dd;function Iv(n,e,t,i,s,r,o){return Array.isArray(e)?Fr.set(e[0],e[1],e[2],e[3]):Fr.copy(e),hd=lr(n,"x",Fr.x,t,i,s,r,o),fd=lr(n,"y",Fr.y,t,i,s,r,o),dd=lr(n,"z",Fr.z,t,i,s,r,o),hd||fd||dd}var xn=new xe,Ad,md,pd;function Sv(n,e,t,i,s,r,o){return e instanceof xe?xn.copy(e):Array.isArray(e)?xn.setRGB(e[0],e[1],e[2]):xn.set(e),Ad=wt(n,"r",xn.r,t,i,s,r,o),md=wt(n,"g",xn.g,t,i,s,r,o),pd=wt(n,"b",xn.b,t,i,s,r,o),Ad||md||pd}var Mi=new Be,us=new ft,gd=new ft,kr=new ft,yd,Ed,vd,xd;function dc(n,e,t,i,s,r,o){var a=n;Array.isArray(e)?Mi.set(e[0],e[1],e[2],e[3]):Mi.copy(e);var c=n.dot(Mi)>0?1:-1;return Mi.x*=c,Mi.y*=c,Mi.z*=c,Mi.w*=c,yd=wt(n,"x",Mi.x,t,i,s,r,o),Ed=wt(n,"y",Mi.y,t,i,s,r,o),vd=wt(n,"z",Mi.z,t,i,s,r,o),xd=wt(n,"w",Mi.w,t,i,s,r,o),us.set(n.x,n.y,n.z,n.w).normalize(),gd.set(a.__damp.velocity_x,a.__damp.velocity_y,a.__damp.velocity_z,a.__damp.velocity_w),kr.copy(us).multiplyScalar(gd.dot(us)/us.dot(us)),a.__damp.velocity_x-=kr.x,a.__damp.velocity_y-=kr.y,a.__damp.velocity_z-=kr.z,a.__damp.velocity_w-=kr.w,n.set(us.x,us.y,us.z,us.w),yd||Ed||vd||xd}var Or=new _c,Cd,Id,Sd;function wv(n,e,t,i,s,r,o){return Array.isArray(e)?Or.set(e[0],e[1],e[2]):Or.copy(e),Cd=wt(n,"radius",Or.radius,t,i,s,r,o),Id=lr(n,"phi",Or.phi,t,i,s,r,o),Sd=lr(n,"theta",Or.theta,t,i,s,r,o),Cd||Id||Sd}var $o=new ce,wd=new b,Td=new Be,Bd=new b,_d,bd,Rd;function Tv(n,e,t,i,s,r,o){var a=n;return a.__damp===void 0&&(a.__damp={position:new b,rotation:new Be,scale:new b},n.decompose(a.__damp.position,a.__damp.rotation,a.__damp.scale)),Array.isArray(e)?$o.set.apply($o,fc(e)):$o.copy(e),$o.decompose(wd,Td,Bd),_d=Xu(a.__damp.position,wd,t,i,s,r,o),bd=dc(a.__damp.rotation,Td,t,i,s,r,o),Rd=Xu(a.__damp.scale,Bd,t,i,s,r,o),n.compose(a.__damp.position,a.__damp.rotation,a.__damp.scale),_d||bd||Rd}var Ar=Object.freeze({__proto__:null,rsqw:uv,exp:Q1,linear:hv,sine:fv,cubic:dv,quint:Av,circ:mv,quart:pv,expo:gv,damp:wt,dampLookAt:vv,dampAngle:lr,damp2:xv,damp3:Xu,damp4:Cv,dampE:Iv,dampC:Sv,dampQ:dc,dampS:wv,dampM:Tv});const zh=A.createContext(null);function N1(){return A.useContext(zh)}function jB({eps:n=1e-5,enabled:e=!0,infinite:t,horizontal:i,pages:s=1,distance:r=1,damping:o=.25,maxSpeed:a=1/0,prepend:c=!1,style:l={},children:u}){const{get:h,setEvents:f,gl:d,size:p,invalidate:m,events:g}=Z(),[y]=A.useState(()=>document.createElement("div")),[v]=A.useState(()=>document.createElement("div")),[E]=A.useState(()=>document.createElement("div")),C=d.domElement.parentNode,x=A.useRef(0),I=A.useMemo(()=>({el:y,eps:n,fill:v,fixed:E,horizontal:i,damping:o,offset:0,delta:0,scroll:x,pages:s,range(B,T,R=0){const _=B-R,L=_+T+R*2;return this.offset<_?0:this.offset>L?1:(this.offset-_)/(L-_)},curve(B,T,R=0){return Math.sin(this.range(B,T,R)*Math.PI)},visible(B,T,R=0){const _=B-R,L=_+T+R*2;return this.offset>=_&&this.offset<=L}}),[n,o,i,s]);A.useEffect(()=>{y.style.position="absolute",y.style.width="100%",y.style.height="100%",y.style[i?"overflowX":"overflowY"]="auto",y.style[i?"overflowY":"overflowX"]="hidden",y.style.top="0px",y.style.left="0px";for(const T in l)y.style[T]=l[T];E.style.position="sticky",E.style.top="0px",E.style.left="0px",E.style.width="100%",E.style.height="100%",E.style.overflow="hidden",y.appendChild(E),v.style.height=i?"100%":`${s*r*100}%`,v.style.width=i?`${s*r*100}%`:"100%",v.style.pointerEvents="none",y.appendChild(v),c?C.prepend(y):C.appendChild(y),y[i?"scrollLeft":"scrollTop"]=1;const w=g.connected||d.domElement;requestAnimationFrame(()=>g.connect==null?void 0:g.connect(y));const B=h().events.compute;return f({compute(T,R){const{left:_,top:L}=C.getBoundingClientRect(),O=T.clientX-_,U=T.clientY-L;R.pointer.set(O/R.size.width*2-1,-(U/R.size.height)*2+1),R.raycaster.setFromCamera(R.pointer,R.camera)}}),()=>{C.removeChild(y),f({compute:B}),g.connect==null||g.connect(w)}},[s,r,i,y,v,E,C]),A.useEffect(()=>{if(g.connected===y){const w=p[i?"width":"height"],B=y[i?"scrollWidth":"scrollHeight"],T=B-w;let R=0,_=!0,L=!0;const O=()=>{if(!(!e||L)&&(m(),R=y[i?"scrollLeft":"scrollTop"],x.current=R/T,t)){if(!_){if(R>=T){const Q=1-I.offset;y[i?"scrollLeft":"scrollTop"]=1,x.current=I.offset=-Q,_=!0}else if(R<=0){const Q=1+I.offset;y[i?"scrollLeft":"scrollTop"]=B,x.current=I.offset=Q,_=!0}}_&&setTimeout(()=>_=!1,40)}};y.addEventListener("scroll",O,{passive:!0}),requestAnimationFrame(()=>L=!1);const U=Q=>y.scrollLeft+=Q.deltaY/2;return i&&y.addEventListener("wheel",U,{passive:!0}),()=>{y.removeEventListener("scroll",O),i&&y.removeEventListener("wheel",U)}}},[y,g,p,t,I,m,i,e]);let S=0;return Ee((w,B)=>{S=I.offset,Ar.damp(I,"offset",x.current,o,B,a,void 0,n),Ar.damp(I,"delta",Math.abs(S-I.offset),o,B,a,void 0,n),I.delta>n&&m()}),A.createElement(zh.Provider,{value:I},u)}const Bv=A.forwardRef(({children:n},e)=>{const t=A.useRef(null);A.useImperativeHandle(e,()=>t.current,[]);const i=N1(),{width:s,height:r}=Z(o=>o.viewport);return Ee(()=>{t.current.position.x=i.horizontal?-s*(i.pages-1)*i.offset:0,t.current.position.y=i.horizontal?0:r*(i.pages-1)*i.offset}),A.createElement("group",{ref:t},n)}),_v=A.forwardRef(({children:n,style:e,...t},i)=>{const s=N1(),r=A.useRef(null);A.useImperativeHandle(i,()=>r.current,[]);const{width:o,height:a}=Z(u=>u.size),c=A.useContext(Nu),l=A.useMemo(()=>jm(s.fixed),[s.fixed]);return Ee(()=>{s.delta>s.eps&&(r.current.style.transform=`translate3d(${s.horizontal?-o*(s.pages-1)*s.offset:0}px,${s.horizontal?0:a*(s.pages-1)*-s.offset}px,0)`)}),l.render(A.createElement("div",ie({ref:r,style:{...e,position:"absolute",top:0,left:0,willChange:"transform"}},t),A.createElement(zh.Provider,{value:s},A.createElement(Nu.Provider,{value:c},n)))),null}),JB=A.forwardRef(({html:n,...e},t)=>{const i=n?_v:Bv;return A.createElement(i,ie({ref:t},e))});function qB({enabled:n=!0,snap:e,global:t,domElement:i,cursor:s=!0,children:r,speed:o=1,rotation:a=[0,0,0],zoom:c=1,polar:l=[0,Math.PI/2],azimuth:u=[-1/0,1/0],config:h={mass:1,tension:170,friction:26}}){const f=Z(I=>I.events),d=Z(I=>I.gl),p=i||f.connected||d.domElement,{size:m}=Z(),g=A.useMemo(()=>[a[0]+l[0],a[0]+l[1]],[a[0],l[0],l[1]]),y=A.useMemo(()=>[a[1]+u[0],a[1]+u[1]],[a[1],u[0],u[1]]),v=A.useMemo(()=>[Ce.clamp(a[0],...g),Ce.clamp(a[1],...y),a[2]],[a[0],a[1],a[2],g,y]),[E,C]=q2(()=>({scale:1,rotation:v,config:h}));A.useEffect(()=>void C.start({scale:1,rotation:v,config:h}),[v]),A.useEffect(()=>{if(t&&s&&n)return p.style.cursor="grab",d.domElement.style.cursor="",()=>{p.style.cursor="default",d.domElement.style.cursor="default"}},[t,s,p,n]);const x=R1({onHover:({last:I})=>{s&&!t&&n&&(p.style.cursor=I?"auto":"grab")},onDrag:({down:I,delta:[S,w],memo:[B,T]=E.rotation.animation.to||v})=>{if(!n)return[w,S];s&&(p.style.cursor=I?"grabbing":"grab"),S=Ce.clamp(T+S/m.width*Math.PI*o,...y),w=Ce.clamp(B+w/m.height*Math.PI*o,...g);const R=e&&!I&&typeof e!="boolean"?e:h;return C.start({scale:I&&w>g[1]/2?c:1,rotation:e&&!I?v:[w,S,0],config:_=>_==="scale"?{...R,friction:R.friction*3}:R}),[w,S]}},{target:t?p:void 0});return A.createElement(X2.group,ie({},x==null?void 0:x(),E),r)}const bv=n=>(e,t,i)=>{const s=i.subscribe;return i.subscribe=(o,a,c)=>{let l=o;if(a){const u=(c==null?void 0:c.equalityFn)||Object.is;let h=o(i.getState());l=f=>{const d=o(f);if(!u(h,d)){const p=h;a(h=d,p)}},c!=null&&c.fireImmediately&&a(h,h)}return s(l)},n(e,t,i)},Rv=bv,G1=A.createContext(null);function XB({map:n,children:e,onChange:t,domElement:i}){const s=n.map(c=>c.name+c.keys).join("-"),r=A.useMemo(()=>E1(Rv(()=>n.reduce((c,l)=>({...c,[l.name]:!1}),{}))),[s]),o=A.useMemo(()=>[r.subscribe,r.getState,r],[s]),a=r.setState;return A.useEffect(()=>{const l=n.map(({name:d,keys:p,up:m})=>({keys:p,up:m,fn:g=>{a({[d]:g}),t&&t(d,g,o[1]())}})).reduce((d,{keys:p,fn:m,up:g=!0})=>(p.forEach(y=>d[y]={fn:m,pressed:!1,up:g}),d),{}),u=({key:d,code:p})=>{const m=l[d]||l[p];if(!m)return;const{fn:g,pressed:y,up:v}=m;m.pressed=!0,(v||!y)&&g(!0)},h=({key:d,code:p})=>{const m=l[d]||l[p];if(!m)return;const{fn:g,up:y}=m;m.pressed=!1,y&&g(!1)},f=i||window;return f.addEventListener("keydown",u,{passive:!0}),f.addEventListener("keyup",h,{passive:!0}),()=>{f.removeEventListener("keydown",u),f.removeEventListener("keyup",h)}},[i,s]),A.createElement(G1.Provider,{value:o,children:e})}function ZB(n){const[e,t,i]=A.useContext(G1);return n?i(n):[e,t]}const Hh=parseInt(xr.replace(/\D+/g,"")),Kh=Hh>=125?"uv1":"uv2";var Dv=Object.defineProperty,Mv=(n,e,t)=>e in n?Dv(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,Ur=(n,e,t)=>(Mv(n,typeof e!="symbol"?e+"":e,t),t);const er=4,ur=1024,Xi=4,Lv=(n=1)=>{const e=new Float32Array(ur*Xi*n*er),t=new ln(e,ur,Xi*n,jt,Jt);return t.wrapS=ui,t.wrapT=ui,t.magFilter=Xe,t.needsUpdate=!0,t},Pv=(n,e,t=0)=>{const i=Math.floor(ur*(Xi/4));e.arcLengthDivisions=i/2,e.updateArcLengths();const s=e.getSpacedPoints(i),r=e.computeFrenetFrames(i,!0);for(let o=0;o<i;o++){const a=Math.floor(o/ur),c=o%ur;let l=s[o];Wo(n,c,l.x,l.y,l.z,0+a+Xi*t),l=r.tangents[o],Wo(n,c,l.x,l.y,l.z,1+a+Xi*t),l=r.normals[o],Wo(n,c,l.x,l.y,l.z,2+a+Xi*t),l=r.binormals[o],Wo(n,c,l.x,l.y,l.z,3+a+Xi*t)}n.needsUpdate=!0},Wo=(n,e,t,i,s,r)=>{const o=n.image,{data:a}=o,c=er*ur*r;a[e*er+c+0]=t,a[e*er+c+1]=i,a[e*er+c+2]=s,a[e*er+c+3]=1},Fv=n=>({spineTexture:{value:n},pathOffset:{type:"f",value:0},pathSegment:{type:"f",value:1},spineOffset:{type:"f",value:161},spineLength:{type:"f",value:400},flow:{type:"i",value:1}});function kv(n,e,t=1){n.__ok||(n.__ok=!0,n.onBeforeCompile=i=>{if(i.__modified)return;i.__modified=!0,Object.assign(i.uniforms,e);const s=`
		uniform sampler2D spineTexture;
		uniform float pathOffset;
		uniform float pathSegment;
		uniform float spineOffset;
		uniform float spineLength;
		uniform int flow;

		float textureLayers = ${Xi*t}.;
		float textureStacks = ${Xi/4}.;

		${i.vertexShader}
		`.replace("#include <beginnormal_vertex>","").replace("#include <defaultnormal_vertex>","").replace("#include <begin_vertex>","").replace(/void\s*main\s*\(\)\s*\{/,`
        void main() {
        #include <beginnormal_vertex>

        vec4 worldPos = modelMatrix * vec4(position, 1.);

        bool bend = flow > 0;
        float xWeight = bend ? 0. : 1.;

        #ifdef USE_INSTANCING
        float pathOffsetFromInstanceMatrix = instanceMatrix[3][2];
        float spineLengthFromInstanceMatrix = instanceMatrix[3][0];
        float spinePortion = bend ? (worldPos.x + spineOffset) / spineLengthFromInstanceMatrix : 0.;
        float mt = (spinePortion * pathSegment + pathOffset + pathOffsetFromInstanceMatrix)*textureStacks;
        #else
        float spinePortion = bend ? (worldPos.x + spineOffset) / spineLength : 0.;
        float mt = (spinePortion * pathSegment + pathOffset)*textureStacks;
        #endif

        mt = mod(mt, textureStacks);
        float rowOffset = floor(mt);

        #ifdef USE_INSTANCING
        rowOffset += instanceMatrix[3][1] * ${Xi}.;
        #endif

        vec3 spinePos = texture2D(spineTexture, vec2(mt, (0. + rowOffset + 0.5) / textureLayers)).xyz;
        vec3 a =        texture2D(spineTexture, vec2(mt, (1. + rowOffset + 0.5) / textureLayers)).xyz;
        vec3 b =        texture2D(spineTexture, vec2(mt, (2. + rowOffset + 0.5) / textureLayers)).xyz;
        vec3 c =        texture2D(spineTexture, vec2(mt, (3. + rowOffset + 0.5) / textureLayers)).xyz;
        mat3 basis = mat3(a, b, c);

        vec3 transformed = basis
          * vec3(worldPos.x * xWeight, worldPos.y * 1., worldPos.z * 1.)
          + spinePos;

        vec3 transformedNormal = normalMatrix * (basis * objectNormal);
			`).replace("#include <project_vertex>",`vec4 mvPosition = modelViewMatrix * vec4( transformed, 1.0 );
				gl_Position = projectionMatrix * mvPosition;`);i.vertexShader=s})}class Ov{constructor(e,t=1){Ur(this,"curveArray"),Ur(this,"curveLengthArray"),Ur(this,"object3D"),Ur(this,"splineTexure"),Ur(this,"uniforms");const i=e.clone(),s=Lv(t),r=Fv(s);i.traverse(o=>{(o instanceof ye||o instanceof Rh)&&(o.material=o.material.clone(),kv(o.material,r,t))}),this.curveArray=new Array(t),this.curveLengthArray=new Array(t),this.object3D=i,this.splineTexure=s,this.uniforms=r}updateCurve(e,t){if(e>=this.curveArray.length)throw Error("Index out of range for Flow");const i=t.getLength();this.uniforms.spineLength.value=i,this.curveLengthArray[e]=i,this.curveArray[e]=t,Pv(this.splineTexure,t,e)}moveAlongCurve(e){this.uniforms.pathOffset.value+=e}}new ce;function Uv(n,e=1e-4){e=Math.max(e,Number.EPSILON);const t={},i=n.getIndex(),s=n.getAttribute("position"),r=i?i.count:s.count;let o=0;const a=Object.keys(n.attributes),c={},l={},u=[],h=["getX","getY","getZ","getW"];for(let m=0,g=a.length;m<g;m++){const y=a[m];c[y]=[];const v=n.morphAttributes[y];v&&(l[y]=new Array(v.length).fill(0).map(()=>[]))}const f=Math.log10(1/e),d=Math.pow(10,f);for(let m=0;m<r;m++){const g=i?i.getX(m):m;let y="";for(let v=0,E=a.length;v<E;v++){const C=a[v],x=n.getAttribute(C),I=x.itemSize;for(let S=0;S<I;S++)y+=`${~~(x[h[S]](g)*d)},`}if(y in t)u.push(t[y]);else{for(let v=0,E=a.length;v<E;v++){const C=a[v],x=n.getAttribute(C),I=n.morphAttributes[C],S=x.itemSize,w=c[C],B=l[C];for(let T=0;T<S;T++){const R=h[T];if(w.push(x[R](g)),I)for(let _=0,L=I.length;_<L;_++)B[_].push(I[_][R](g))}}t[y]=o,u.push(o),o++}}const p=n.clone();for(let m=0,g=a.length;m<g;m++){const y=a[m],v=n.getAttribute(y),E=new v.array.constructor(c[y]),C=new Ye(E,v.itemSize,v.normalized);if(p.setAttribute(y,C),y in l)for(let x=0;x<l[y].length;x++){const I=n.morphAttributes[y][x],S=new I.array.constructor(l[y][x]),w=new Ye(S,I.itemSize,I.normalized);p.morphAttributes[y][x]=w}}return p.setIndex(u),p}function Dd(n,e){if(e===Z2)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),n;if(e===Gu||e===Jm){let t=n.getIndex();if(t===null){const o=[],a=n.getAttribute("position");if(a!==void 0){for(let c=0;c<a.count;c++)o.push(c);n.setIndex(o),t=n.getIndex()}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),n}const i=t.count-2,s=[];if(t)if(e===Gu)for(let o=1;o<=i;o++)s.push(t.getX(0)),s.push(t.getX(o)),s.push(t.getX(o+1));else for(let o=0;o<i;o++)o%2===0?(s.push(t.getX(o)),s.push(t.getX(o+1)),s.push(t.getX(o+2))):(s.push(t.getX(o+2)),s.push(t.getX(o+1)),s.push(t.getX(o)));s.length/3!==i&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const r=n.clone();return r.setIndex(s),r.clearGroups(),r}else return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",e),n}function z1(n,e=Math.PI/3){const t=Math.cos(e),i=(1+1e-10)*100,s=[new b,new b,new b],r=new b,o=new b,a=new b,c=new b;function l(m){const g=~~(m.x*i),y=~~(m.y*i),v=~~(m.z*i);return`${g},${y},${v}`}const u=n.index?n.toNonIndexed():n,h=u.attributes.position,f={};for(let m=0,g=h.count/3;m<g;m++){const y=3*m,v=s[0].fromBufferAttribute(h,y+0),E=s[1].fromBufferAttribute(h,y+1),C=s[2].fromBufferAttribute(h,y+2);r.subVectors(C,E),o.subVectors(v,E);const x=new b().crossVectors(r,o).normalize();for(let I=0;I<3;I++){const S=s[I],w=l(S);w in f||(f[w]=[]),f[w].push(x)}}const d=new Float32Array(h.count*3),p=new Ye(d,3,!1);for(let m=0,g=h.count/3;m<g;m++){const y=3*m,v=s[0].fromBufferAttribute(h,y+0),E=s[1].fromBufferAttribute(h,y+1),C=s[2].fromBufferAttribute(h,y+2);r.subVectors(C,E),o.subVectors(v,E),a.crossVectors(r,o).normalize();for(let x=0;x<3;x++){const I=s[x],S=l(I),w=f[S];c.set(0,0,0);for(let B=0,T=w.length;B<T;B++){const R=w[B];a.dot(R)>t&&c.add(R)}c.normalize(),p.setXYZ(y+x,c.x,c.y,c.z)}}return u.setAttribute("normal",p),u}let Qv=class extends ye{constructor(e,t,i=!1,s=!1,r=1e4){const o=new St;super(o,t),this.isMarchingCubes=!0;const a=this,c=new Float32Array(12*3),l=new Float32Array(12*3),u=new Float32Array(12*3);this.enableUvs=i,this.enableColors=s,this.init=function(v){this.resolution=v,this.isolation=80,this.size=v,this.size2=this.size*this.size,this.size3=this.size2*this.size,this.halfsize=this.size/2,this.delta=2/this.size,this.yd=this.size,this.zd=this.size2,this.field=new Float32Array(this.size3),this.normal_cache=new Float32Array(this.size3*3),this.palette=new Float32Array(this.size3*3),this.count=0;const E=r*3;this.positionArray=new Float32Array(E*3);const C=new Ye(this.positionArray,3);C.setUsage(Gt),o.setAttribute("position",C),this.normalArray=new Float32Array(E*3);const x=new Ye(this.normalArray,3);if(x.setUsage(Gt),o.setAttribute("normal",x),this.enableUvs){this.uvArray=new Float32Array(E*2);const I=new Ye(this.uvArray,2);I.setUsage(Gt),o.setAttribute("uv",I)}if(this.enableColors){this.colorArray=new Float32Array(E*3);const I=new Ye(this.colorArray,3);I.setUsage(Gt),o.setAttribute("color",I)}o.boundingSphere=new si(new b,1)};function h(v,E,C){return v+(E-v)*C}function f(v,E,C,x,I,S,w,B,T,R){const _=(C-w)/(B-w),L=a.normal_cache;c[E+0]=x+_*a.delta,c[E+1]=I,c[E+2]=S,l[E+0]=h(L[v+0],L[v+3],_),l[E+1]=h(L[v+1],L[v+4],_),l[E+2]=h(L[v+2],L[v+5],_),u[E+0]=h(a.palette[T*3+0],a.palette[R*3+0],_),u[E+1]=h(a.palette[T*3+1],a.palette[R*3+1],_),u[E+2]=h(a.palette[T*3+2],a.palette[R*3+2],_)}function d(v,E,C,x,I,S,w,B,T,R){const _=(C-w)/(B-w),L=a.normal_cache;c[E+0]=x,c[E+1]=I+_*a.delta,c[E+2]=S;const O=v+a.yd*3;l[E+0]=h(L[v+0],L[O+0],_),l[E+1]=h(L[v+1],L[O+1],_),l[E+2]=h(L[v+2],L[O+2],_),u[E+0]=h(a.palette[T*3+0],a.palette[R*3+0],_),u[E+1]=h(a.palette[T*3+1],a.palette[R*3+1],_),u[E+2]=h(a.palette[T*3+2],a.palette[R*3+2],_)}function p(v,E,C,x,I,S,w,B,T,R){const _=(C-w)/(B-w),L=a.normal_cache;c[E+0]=x,c[E+1]=I,c[E+2]=S+_*a.delta;const O=v+a.zd*3;l[E+0]=h(L[v+0],L[O+0],_),l[E+1]=h(L[v+1],L[O+1],_),l[E+2]=h(L[v+2],L[O+2],_),u[E+0]=h(a.palette[T*3+0],a.palette[R*3+0],_),u[E+1]=h(a.palette[T*3+1],a.palette[R*3+1],_),u[E+2]=h(a.palette[T*3+2],a.palette[R*3+2],_)}function m(v){const E=v*3;a.normal_cache[E]===0&&(a.normal_cache[E+0]=a.field[v-1]-a.field[v+1],a.normal_cache[E+1]=a.field[v-a.yd]-a.field[v+a.yd],a.normal_cache[E+2]=a.field[v-a.zd]-a.field[v+a.zd])}function g(v,E,C,x,I){const S=x+1,w=x+a.yd,B=x+a.zd,T=S+a.yd,R=S+a.zd,_=x+a.yd+a.zd,L=S+a.yd+a.zd;let O=0;const U=a.field[x],Q=a.field[S],G=a.field[w],z=a.field[T],H=a.field[B],N=a.field[R],V=a.field[_],$=a.field[L];U<I&&(O|=1),Q<I&&(O|=2),G<I&&(O|=8),z<I&&(O|=4),H<I&&(O|=16),N<I&&(O|=32),V<I&&(O|=128),$<I&&(O|=64);const Y=Nv[O];if(Y===0)return 0;const M=a.delta,k=v+M,P=E+M,F=C+M;Y&1&&(m(x),m(S),f(x*3,0,I,v,E,C,U,Q,x,S)),Y&2&&(m(S),m(T),d(S*3,3,I,k,E,C,Q,z,S,T)),Y&4&&(m(w),m(T),f(w*3,6,I,v,P,C,G,z,w,T)),Y&8&&(m(x),m(w),d(x*3,9,I,v,E,C,U,G,x,w)),Y&16&&(m(B),m(R),f(B*3,12,I,v,E,F,H,N,B,R)),Y&32&&(m(R),m(L),d(R*3,15,I,k,E,F,N,$,R,L)),Y&64&&(m(_),m(L),f(_*3,18,I,v,P,F,V,$,_,L)),Y&128&&(m(B),m(_),d(B*3,21,I,v,E,F,H,V,B,_)),Y&256&&(m(x),m(B),p(x*3,24,I,v,E,C,U,H,x,B)),Y&512&&(m(S),m(R),p(S*3,27,I,k,E,C,Q,N,S,R)),Y&1024&&(m(T),m(L),p(T*3,30,I,k,P,C,z,$,T,L)),Y&2048&&(m(w),m(_),p(w*3,33,I,v,P,C,G,V,w,_)),O<<=4;let J,se,q,re=0,he=0;for(;jo[O+he]!=-1;)J=O+he,se=J+1,q=J+2,y(c,l,u,3*jo[J],3*jo[se],3*jo[q]),he+=3,re++;return re}function y(v,E,C,x,I,S){const w=a.count*3;if(a.positionArray[w+0]=v[x],a.positionArray[w+1]=v[x+1],a.positionArray[w+2]=v[x+2],a.positionArray[w+3]=v[I],a.positionArray[w+4]=v[I+1],a.positionArray[w+5]=v[I+2],a.positionArray[w+6]=v[S],a.positionArray[w+7]=v[S+1],a.positionArray[w+8]=v[S+2],a.material.flatShading===!0){const B=(E[x+0]+E[I+0]+E[S+0])/3,T=(E[x+1]+E[I+1]+E[S+1])/3,R=(E[x+2]+E[I+2]+E[S+2])/3;a.normalArray[w+0]=B,a.normalArray[w+1]=T,a.normalArray[w+2]=R,a.normalArray[w+3]=B,a.normalArray[w+4]=T,a.normalArray[w+5]=R,a.normalArray[w+6]=B,a.normalArray[w+7]=T,a.normalArray[w+8]=R}else a.normalArray[w+0]=E[x+0],a.normalArray[w+1]=E[x+1],a.normalArray[w+2]=E[x+2],a.normalArray[w+3]=E[I+0],a.normalArray[w+4]=E[I+1],a.normalArray[w+5]=E[I+2],a.normalArray[w+6]=E[S+0],a.normalArray[w+7]=E[S+1],a.normalArray[w+8]=E[S+2];if(a.enableUvs){const B=a.count*2;a.uvArray[B+0]=v[x+0],a.uvArray[B+1]=v[x+2],a.uvArray[B+2]=v[I+0],a.uvArray[B+3]=v[I+2],a.uvArray[B+4]=v[S+0],a.uvArray[B+5]=v[S+2]}a.enableColors&&(a.colorArray[w+0]=C[x+0],a.colorArray[w+1]=C[x+1],a.colorArray[w+2]=C[x+2],a.colorArray[w+3]=C[I+0],a.colorArray[w+4]=C[I+1],a.colorArray[w+5]=C[I+2],a.colorArray[w+6]=C[S+0],a.colorArray[w+7]=C[S+1],a.colorArray[w+8]=C[S+2]),a.count+=3}this.addBall=function(v,E,C,x,I,S){const w=Math.sign(x);x=Math.abs(x);const B=S!=null;let T=new xe(v,E,C);if(B)try{T=S instanceof xe?S:Array.isArray(S)?new xe(Math.min(Math.abs(S[0]),1),Math.min(Math.abs(S[1]),1),Math.min(Math.abs(S[2]),1)):new xe(S)}catch{T=new xe(v,E,C)}const R=this.size*Math.sqrt(x/I),_=C*this.size,L=E*this.size,O=v*this.size;let U=Math.floor(_-R);U<1&&(U=1);let Q=Math.floor(_+R);Q>this.size-1&&(Q=this.size-1);let G=Math.floor(L-R);G<1&&(G=1);let z=Math.floor(L+R);z>this.size-1&&(z=this.size-1);let H=Math.floor(O-R);H<1&&(H=1);let N=Math.floor(O+R);N>this.size-1&&(N=this.size-1);let V,$,Y,M,k,P,F,J,se,q,re;for(Y=U;Y<Q;Y++)for(k=this.size2*Y,J=Y/this.size-C,se=J*J,$=G;$<z;$++)for(M=k+this.size*$,F=$/this.size-E,q=F*F,V=H;V<N;V++)if(P=V/this.size-v,re=x/(1e-6+P*P+q+se)-I,re>0){this.field[M+V]+=re*w;const he=Math.sqrt((V-O)*(V-O)+($-L)*($-L)+(Y-_)*(Y-_))/R,fe=1-he*he*he*(he*(he*6-15)+10);this.palette[(M+V)*3+0]+=T.r*fe,this.palette[(M+V)*3+1]+=T.g*fe,this.palette[(M+V)*3+2]+=T.b*fe}},this.addPlaneX=function(v,E){const C=this.size,x=this.yd,I=this.zd,S=this.field;let w,B,T,R,_,L,O,U=C*Math.sqrt(v/E);for(U>C&&(U=C),w=0;w<U;w++)if(L=w/C,R=L*L,_=v/(1e-4+R)-E,_>0)for(B=0;B<C;B++)for(O=w+B*x,T=0;T<C;T++)S[I*T+O]+=_},this.addPlaneY=function(v,E){const C=this.size,x=this.yd,I=this.zd,S=this.field;let w,B,T,R,_,L,O,U,Q=C*Math.sqrt(v/E);for(Q>C&&(Q=C),B=0;B<Q;B++)if(L=B/C,R=L*L,_=v/(1e-4+R)-E,_>0)for(O=B*x,w=0;w<C;w++)for(U=O+w,T=0;T<C;T++)S[I*T+U]+=_},this.addPlaneZ=function(v,E){const C=this.size,x=this.yd,I=this.zd,S=this.field;let w,B,T,R,_,L,O,U,Q=C*Math.sqrt(v/E);for(Q>C&&(Q=C),T=0;T<Q;T++)if(L=T/C,R=L*L,_=v/(1e-4+R)-E,_>0)for(O=I*T,B=0;B<C;B++)for(U=O+B*x,w=0;w<C;w++)S[U+w]+=_},this.setCell=function(v,E,C,x){const I=this.size2*C+this.size*E+v;this.field[I]=x},this.getCell=function(v,E,C){const x=this.size2*C+this.size*E+v;return this.field[x]},this.blur=function(v=1){const E=this.field,C=E.slice(),x=this.size,I=this.size2;for(let S=0;S<x;S++)for(let w=0;w<x;w++)for(let B=0;B<x;B++){const T=I*B+x*w+S;let R=C[T],_=1;for(let L=-1;L<=1;L+=2){const O=L+S;if(!(O<0||O>=x))for(let U=-1;U<=1;U+=2){const Q=U+w;if(!(Q<0||Q>=x))for(let G=-1;G<=1;G+=2){const z=G+B;if(z<0||z>=x)continue;const H=I*z+x*Q+O,N=C[H];_++,R+=v*(N-R)/_}}}E[T]=R}},this.reset=function(){for(let v=0;v<this.size3;v++)this.normal_cache[v*3]=0,this.field[v]=0,this.palette[v*3]=this.palette[v*3+1]=this.palette[v*3+2]=0},this.update=function(){this.count=0;const v=this.size-2;for(let E=1;E<v;E++){const C=this.size2*E,x=(E-this.halfsize)/this.halfsize;for(let I=1;I<v;I++){const S=C+this.size*I,w=(I-this.halfsize)/this.halfsize;for(let B=1;B<v;B++){const T=(B-this.halfsize)/this.halfsize,R=S+B;g(T,w,x,R,this.isolation)}}}this.geometry.setDrawRange(0,this.count),o.getAttribute("position").needsUpdate=!0,o.getAttribute("normal").needsUpdate=!0,this.enableUvs&&(o.getAttribute("uv").needsUpdate=!0),this.enableColors&&(o.getAttribute("color").needsUpdate=!0),this.count/3>r&&console.warn("THREE.MarchingCubes: Geometry buffers too small for rendering. Please create an instance with a higher poly count.")},this.init(e)}};const Nv=new Int32Array([0,265,515,778,1030,1295,1541,1804,2060,2309,2575,2822,3082,3331,3593,3840,400,153,915,666,1430,1183,1941,1692,2460,2197,2975,2710,3482,3219,3993,3728,560,825,51,314,1590,1855,1077,1340,2620,2869,2111,2358,3642,3891,3129,3376,928,681,419,170,1958,1711,1445,1196,2988,2725,2479,2214,4010,3747,3497,3232,1120,1385,1635,1898,102,367,613,876,3180,3429,3695,3942,2154,2403,2665,2912,1520,1273,2035,1786,502,255,1013,764,3580,3317,4095,3830,2554,2291,3065,2800,1616,1881,1107,1370,598,863,85,348,3676,3925,3167,3414,2650,2899,2137,2384,1984,1737,1475,1226,966,719,453,204,4044,3781,3535,3270,3018,2755,2505,2240,2240,2505,2755,3018,3270,3535,3781,4044,204,453,719,966,1226,1475,1737,1984,2384,2137,2899,2650,3414,3167,3925,3676,348,85,863,598,1370,1107,1881,1616,2800,3065,2291,2554,3830,4095,3317,3580,764,1013,255,502,1786,2035,1273,1520,2912,2665,2403,2154,3942,3695,3429,3180,876,613,367,102,1898,1635,1385,1120,3232,3497,3747,4010,2214,2479,2725,2988,1196,1445,1711,1958,170,419,681,928,3376,3129,3891,3642,2358,2111,2869,2620,1340,1077,1855,1590,314,51,825,560,3728,3993,3219,3482,2710,2975,2197,2460,1692,1941,1183,1430,666,915,153,400,3840,3593,3331,3082,2822,2575,2309,2060,1804,1541,1295,1030,778,515,265,0]),jo=new Int32Array([-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,8,3,9,8,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,1,2,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,2,10,0,2,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,8,3,2,10,8,10,9,8,-1,-1,-1,-1,-1,-1,-1,3,11,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,11,2,8,11,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,9,0,2,3,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,11,2,1,9,11,9,8,11,-1,-1,-1,-1,-1,-1,-1,3,10,1,11,10,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,10,1,0,8,10,8,11,10,-1,-1,-1,-1,-1,-1,-1,3,9,0,3,11,9,11,10,9,-1,-1,-1,-1,-1,-1,-1,9,8,10,10,8,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,7,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,3,0,7,3,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,8,4,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,1,9,4,7,1,7,3,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,8,4,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,4,7,3,0,4,1,2,10,-1,-1,-1,-1,-1,-1,-1,9,2,10,9,0,2,8,4,7,-1,-1,-1,-1,-1,-1,-1,2,10,9,2,9,7,2,7,3,7,9,4,-1,-1,-1,-1,8,4,7,3,11,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,4,7,11,2,4,2,0,4,-1,-1,-1,-1,-1,-1,-1,9,0,1,8,4,7,2,3,11,-1,-1,-1,-1,-1,-1,-1,4,7,11,9,4,11,9,11,2,9,2,1,-1,-1,-1,-1,3,10,1,3,11,10,7,8,4,-1,-1,-1,-1,-1,-1,-1,1,11,10,1,4,11,1,0,4,7,11,4,-1,-1,-1,-1,4,7,8,9,0,11,9,11,10,11,0,3,-1,-1,-1,-1,4,7,11,4,11,9,9,11,10,-1,-1,-1,-1,-1,-1,-1,9,5,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,5,4,0,8,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,5,4,1,5,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,5,4,8,3,5,3,1,5,-1,-1,-1,-1,-1,-1,-1,1,2,10,9,5,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,8,1,2,10,4,9,5,-1,-1,-1,-1,-1,-1,-1,5,2,10,5,4,2,4,0,2,-1,-1,-1,-1,-1,-1,-1,2,10,5,3,2,5,3,5,4,3,4,8,-1,-1,-1,-1,9,5,4,2,3,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,11,2,0,8,11,4,9,5,-1,-1,-1,-1,-1,-1,-1,0,5,4,0,1,5,2,3,11,-1,-1,-1,-1,-1,-1,-1,2,1,5,2,5,8,2,8,11,4,8,5,-1,-1,-1,-1,10,3,11,10,1,3,9,5,4,-1,-1,-1,-1,-1,-1,-1,4,9,5,0,8,1,8,10,1,8,11,10,-1,-1,-1,-1,5,4,0,5,0,11,5,11,10,11,0,3,-1,-1,-1,-1,5,4,8,5,8,10,10,8,11,-1,-1,-1,-1,-1,-1,-1,9,7,8,5,7,9,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,3,0,9,5,3,5,7,3,-1,-1,-1,-1,-1,-1,-1,0,7,8,0,1,7,1,5,7,-1,-1,-1,-1,-1,-1,-1,1,5,3,3,5,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,7,8,9,5,7,10,1,2,-1,-1,-1,-1,-1,-1,-1,10,1,2,9,5,0,5,3,0,5,7,3,-1,-1,-1,-1,8,0,2,8,2,5,8,5,7,10,5,2,-1,-1,-1,-1,2,10,5,2,5,3,3,5,7,-1,-1,-1,-1,-1,-1,-1,7,9,5,7,8,9,3,11,2,-1,-1,-1,-1,-1,-1,-1,9,5,7,9,7,2,9,2,0,2,7,11,-1,-1,-1,-1,2,3,11,0,1,8,1,7,8,1,5,7,-1,-1,-1,-1,11,2,1,11,1,7,7,1,5,-1,-1,-1,-1,-1,-1,-1,9,5,8,8,5,7,10,1,3,10,3,11,-1,-1,-1,-1,5,7,0,5,0,9,7,11,0,1,0,10,11,10,0,-1,11,10,0,11,0,3,10,5,0,8,0,7,5,7,0,-1,11,10,5,7,11,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,10,6,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,5,10,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,0,1,5,10,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,8,3,1,9,8,5,10,6,-1,-1,-1,-1,-1,-1,-1,1,6,5,2,6,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,6,5,1,2,6,3,0,8,-1,-1,-1,-1,-1,-1,-1,9,6,5,9,0,6,0,2,6,-1,-1,-1,-1,-1,-1,-1,5,9,8,5,8,2,5,2,6,3,2,8,-1,-1,-1,-1,2,3,11,10,6,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,0,8,11,2,0,10,6,5,-1,-1,-1,-1,-1,-1,-1,0,1,9,2,3,11,5,10,6,-1,-1,-1,-1,-1,-1,-1,5,10,6,1,9,2,9,11,2,9,8,11,-1,-1,-1,-1,6,3,11,6,5,3,5,1,3,-1,-1,-1,-1,-1,-1,-1,0,8,11,0,11,5,0,5,1,5,11,6,-1,-1,-1,-1,3,11,6,0,3,6,0,6,5,0,5,9,-1,-1,-1,-1,6,5,9,6,9,11,11,9,8,-1,-1,-1,-1,-1,-1,-1,5,10,6,4,7,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,3,0,4,7,3,6,5,10,-1,-1,-1,-1,-1,-1,-1,1,9,0,5,10,6,8,4,7,-1,-1,-1,-1,-1,-1,-1,10,6,5,1,9,7,1,7,3,7,9,4,-1,-1,-1,-1,6,1,2,6,5,1,4,7,8,-1,-1,-1,-1,-1,-1,-1,1,2,5,5,2,6,3,0,4,3,4,7,-1,-1,-1,-1,8,4,7,9,0,5,0,6,5,0,2,6,-1,-1,-1,-1,7,3,9,7,9,4,3,2,9,5,9,6,2,6,9,-1,3,11,2,7,8,4,10,6,5,-1,-1,-1,-1,-1,-1,-1,5,10,6,4,7,2,4,2,0,2,7,11,-1,-1,-1,-1,0,1,9,4,7,8,2,3,11,5,10,6,-1,-1,-1,-1,9,2,1,9,11,2,9,4,11,7,11,4,5,10,6,-1,8,4,7,3,11,5,3,5,1,5,11,6,-1,-1,-1,-1,5,1,11,5,11,6,1,0,11,7,11,4,0,4,11,-1,0,5,9,0,6,5,0,3,6,11,6,3,8,4,7,-1,6,5,9,6,9,11,4,7,9,7,11,9,-1,-1,-1,-1,10,4,9,6,4,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,10,6,4,9,10,0,8,3,-1,-1,-1,-1,-1,-1,-1,10,0,1,10,6,0,6,4,0,-1,-1,-1,-1,-1,-1,-1,8,3,1,8,1,6,8,6,4,6,1,10,-1,-1,-1,-1,1,4,9,1,2,4,2,6,4,-1,-1,-1,-1,-1,-1,-1,3,0,8,1,2,9,2,4,9,2,6,4,-1,-1,-1,-1,0,2,4,4,2,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,3,2,8,2,4,4,2,6,-1,-1,-1,-1,-1,-1,-1,10,4,9,10,6,4,11,2,3,-1,-1,-1,-1,-1,-1,-1,0,8,2,2,8,11,4,9,10,4,10,6,-1,-1,-1,-1,3,11,2,0,1,6,0,6,4,6,1,10,-1,-1,-1,-1,6,4,1,6,1,10,4,8,1,2,1,11,8,11,1,-1,9,6,4,9,3,6,9,1,3,11,6,3,-1,-1,-1,-1,8,11,1,8,1,0,11,6,1,9,1,4,6,4,1,-1,3,11,6,3,6,0,0,6,4,-1,-1,-1,-1,-1,-1,-1,6,4,8,11,6,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,10,6,7,8,10,8,9,10,-1,-1,-1,-1,-1,-1,-1,0,7,3,0,10,7,0,9,10,6,7,10,-1,-1,-1,-1,10,6,7,1,10,7,1,7,8,1,8,0,-1,-1,-1,-1,10,6,7,10,7,1,1,7,3,-1,-1,-1,-1,-1,-1,-1,1,2,6,1,6,8,1,8,9,8,6,7,-1,-1,-1,-1,2,6,9,2,9,1,6,7,9,0,9,3,7,3,9,-1,7,8,0,7,0,6,6,0,2,-1,-1,-1,-1,-1,-1,-1,7,3,2,6,7,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,11,10,6,8,10,8,9,8,6,7,-1,-1,-1,-1,2,0,7,2,7,11,0,9,7,6,7,10,9,10,7,-1,1,8,0,1,7,8,1,10,7,6,7,10,2,3,11,-1,11,2,1,11,1,7,10,6,1,6,7,1,-1,-1,-1,-1,8,9,6,8,6,7,9,1,6,11,6,3,1,3,6,-1,0,9,1,11,6,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,8,0,7,0,6,3,11,0,11,6,0,-1,-1,-1,-1,7,11,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,6,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,8,11,7,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,1,9,11,7,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,1,9,8,3,1,11,7,6,-1,-1,-1,-1,-1,-1,-1,10,1,2,6,11,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,10,3,0,8,6,11,7,-1,-1,-1,-1,-1,-1,-1,2,9,0,2,10,9,6,11,7,-1,-1,-1,-1,-1,-1,-1,6,11,7,2,10,3,10,8,3,10,9,8,-1,-1,-1,-1,7,2,3,6,2,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,7,0,8,7,6,0,6,2,0,-1,-1,-1,-1,-1,-1,-1,2,7,6,2,3,7,0,1,9,-1,-1,-1,-1,-1,-1,-1,1,6,2,1,8,6,1,9,8,8,7,6,-1,-1,-1,-1,10,7,6,10,1,7,1,3,7,-1,-1,-1,-1,-1,-1,-1,10,7,6,1,7,10,1,8,7,1,0,8,-1,-1,-1,-1,0,3,7,0,7,10,0,10,9,6,10,7,-1,-1,-1,-1,7,6,10,7,10,8,8,10,9,-1,-1,-1,-1,-1,-1,-1,6,8,4,11,8,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,6,11,3,0,6,0,4,6,-1,-1,-1,-1,-1,-1,-1,8,6,11,8,4,6,9,0,1,-1,-1,-1,-1,-1,-1,-1,9,4,6,9,6,3,9,3,1,11,3,6,-1,-1,-1,-1,6,8,4,6,11,8,2,10,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,3,0,11,0,6,11,0,4,6,-1,-1,-1,-1,4,11,8,4,6,11,0,2,9,2,10,9,-1,-1,-1,-1,10,9,3,10,3,2,9,4,3,11,3,6,4,6,3,-1,8,2,3,8,4,2,4,6,2,-1,-1,-1,-1,-1,-1,-1,0,4,2,4,6,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,9,0,2,3,4,2,4,6,4,3,8,-1,-1,-1,-1,1,9,4,1,4,2,2,4,6,-1,-1,-1,-1,-1,-1,-1,8,1,3,8,6,1,8,4,6,6,10,1,-1,-1,-1,-1,10,1,0,10,0,6,6,0,4,-1,-1,-1,-1,-1,-1,-1,4,6,3,4,3,8,6,10,3,0,3,9,10,9,3,-1,10,9,4,6,10,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,9,5,7,6,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,3,4,9,5,11,7,6,-1,-1,-1,-1,-1,-1,-1,5,0,1,5,4,0,7,6,11,-1,-1,-1,-1,-1,-1,-1,11,7,6,8,3,4,3,5,4,3,1,5,-1,-1,-1,-1,9,5,4,10,1,2,7,6,11,-1,-1,-1,-1,-1,-1,-1,6,11,7,1,2,10,0,8,3,4,9,5,-1,-1,-1,-1,7,6,11,5,4,10,4,2,10,4,0,2,-1,-1,-1,-1,3,4,8,3,5,4,3,2,5,10,5,2,11,7,6,-1,7,2,3,7,6,2,5,4,9,-1,-1,-1,-1,-1,-1,-1,9,5,4,0,8,6,0,6,2,6,8,7,-1,-1,-1,-1,3,6,2,3,7,6,1,5,0,5,4,0,-1,-1,-1,-1,6,2,8,6,8,7,2,1,8,4,8,5,1,5,8,-1,9,5,4,10,1,6,1,7,6,1,3,7,-1,-1,-1,-1,1,6,10,1,7,6,1,0,7,8,7,0,9,5,4,-1,4,0,10,4,10,5,0,3,10,6,10,7,3,7,10,-1,7,6,10,7,10,8,5,4,10,4,8,10,-1,-1,-1,-1,6,9,5,6,11,9,11,8,9,-1,-1,-1,-1,-1,-1,-1,3,6,11,0,6,3,0,5,6,0,9,5,-1,-1,-1,-1,0,11,8,0,5,11,0,1,5,5,6,11,-1,-1,-1,-1,6,11,3,6,3,5,5,3,1,-1,-1,-1,-1,-1,-1,-1,1,2,10,9,5,11,9,11,8,11,5,6,-1,-1,-1,-1,0,11,3,0,6,11,0,9,6,5,6,9,1,2,10,-1,11,8,5,11,5,6,8,0,5,10,5,2,0,2,5,-1,6,11,3,6,3,5,2,10,3,10,5,3,-1,-1,-1,-1,5,8,9,5,2,8,5,6,2,3,8,2,-1,-1,-1,-1,9,5,6,9,6,0,0,6,2,-1,-1,-1,-1,-1,-1,-1,1,5,8,1,8,0,5,6,8,3,8,2,6,2,8,-1,1,5,6,2,1,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,3,6,1,6,10,3,8,6,5,6,9,8,9,6,-1,10,1,0,10,0,6,9,5,0,5,6,0,-1,-1,-1,-1,0,3,8,5,6,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,10,5,6,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,5,10,7,5,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,11,5,10,11,7,5,8,3,0,-1,-1,-1,-1,-1,-1,-1,5,11,7,5,10,11,1,9,0,-1,-1,-1,-1,-1,-1,-1,10,7,5,10,11,7,9,8,1,8,3,1,-1,-1,-1,-1,11,1,2,11,7,1,7,5,1,-1,-1,-1,-1,-1,-1,-1,0,8,3,1,2,7,1,7,5,7,2,11,-1,-1,-1,-1,9,7,5,9,2,7,9,0,2,2,11,7,-1,-1,-1,-1,7,5,2,7,2,11,5,9,2,3,2,8,9,8,2,-1,2,5,10,2,3,5,3,7,5,-1,-1,-1,-1,-1,-1,-1,8,2,0,8,5,2,8,7,5,10,2,5,-1,-1,-1,-1,9,0,1,5,10,3,5,3,7,3,10,2,-1,-1,-1,-1,9,8,2,9,2,1,8,7,2,10,2,5,7,5,2,-1,1,3,5,3,7,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,8,7,0,7,1,1,7,5,-1,-1,-1,-1,-1,-1,-1,9,0,3,9,3,5,5,3,7,-1,-1,-1,-1,-1,-1,-1,9,8,7,5,9,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,5,8,4,5,10,8,10,11,8,-1,-1,-1,-1,-1,-1,-1,5,0,4,5,11,0,5,10,11,11,3,0,-1,-1,-1,-1,0,1,9,8,4,10,8,10,11,10,4,5,-1,-1,-1,-1,10,11,4,10,4,5,11,3,4,9,4,1,3,1,4,-1,2,5,1,2,8,5,2,11,8,4,5,8,-1,-1,-1,-1,0,4,11,0,11,3,4,5,11,2,11,1,5,1,11,-1,0,2,5,0,5,9,2,11,5,4,5,8,11,8,5,-1,9,4,5,2,11,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,5,10,3,5,2,3,4,5,3,8,4,-1,-1,-1,-1,5,10,2,5,2,4,4,2,0,-1,-1,-1,-1,-1,-1,-1,3,10,2,3,5,10,3,8,5,4,5,8,0,1,9,-1,5,10,2,5,2,4,1,9,2,9,4,2,-1,-1,-1,-1,8,4,5,8,5,3,3,5,1,-1,-1,-1,-1,-1,-1,-1,0,4,5,1,0,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,4,5,8,5,3,9,0,5,0,3,5,-1,-1,-1,-1,9,4,5,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,11,7,4,9,11,9,10,11,-1,-1,-1,-1,-1,-1,-1,0,8,3,4,9,7,9,11,7,9,10,11,-1,-1,-1,-1,1,10,11,1,11,4,1,4,0,7,4,11,-1,-1,-1,-1,3,1,4,3,4,8,1,10,4,7,4,11,10,11,4,-1,4,11,7,9,11,4,9,2,11,9,1,2,-1,-1,-1,-1,9,7,4,9,11,7,9,1,11,2,11,1,0,8,3,-1,11,7,4,11,4,2,2,4,0,-1,-1,-1,-1,-1,-1,-1,11,7,4,11,4,2,8,3,4,3,2,4,-1,-1,-1,-1,2,9,10,2,7,9,2,3,7,7,4,9,-1,-1,-1,-1,9,10,7,9,7,4,10,2,7,8,7,0,2,0,7,-1,3,7,10,3,10,2,7,4,10,1,10,0,4,0,10,-1,1,10,2,8,7,4,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,9,1,4,1,7,7,1,3,-1,-1,-1,-1,-1,-1,-1,4,9,1,4,1,7,0,8,1,8,7,1,-1,-1,-1,-1,4,0,3,7,4,3,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,4,8,7,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,9,10,8,10,11,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,0,9,3,9,11,11,9,10,-1,-1,-1,-1,-1,-1,-1,0,1,10,0,10,8,8,10,11,-1,-1,-1,-1,-1,-1,-1,3,1,10,11,3,10,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,2,11,1,11,9,9,11,8,-1,-1,-1,-1,-1,-1,-1,3,0,9,3,9,11,1,2,9,2,11,9,-1,-1,-1,-1,0,2,11,8,0,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,3,2,11,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,8,2,8,10,10,8,9,-1,-1,-1,-1,-1,-1,-1,9,10,2,0,9,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,2,3,8,2,8,10,0,1,8,1,10,8,-1,-1,-1,-1,1,10,2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,1,3,8,9,1,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,9,1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,3,8,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1]);var Gv=Object.defineProperty,zv=(n,e,t)=>e in n?Gv(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,Li=(n,e,t)=>(zv(n,typeof e!="symbol"?e+"":e,t),t);class cl{constructor(e=Math){Li(this,"grad3",[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]]),Li(this,"grad4",[[0,1,1,1],[0,1,1,-1],[0,1,-1,1],[0,1,-1,-1],[0,-1,1,1],[0,-1,1,-1],[0,-1,-1,1],[0,-1,-1,-1],[1,0,1,1],[1,0,1,-1],[1,0,-1,1],[1,0,-1,-1],[-1,0,1,1],[-1,0,1,-1],[-1,0,-1,1],[-1,0,-1,-1],[1,1,0,1],[1,1,0,-1],[1,-1,0,1],[1,-1,0,-1],[-1,1,0,1],[-1,1,0,-1],[-1,-1,0,1],[-1,-1,0,-1],[1,1,1,0],[1,1,-1,0],[1,-1,1,0],[1,-1,-1,0],[-1,1,1,0],[-1,1,-1,0],[-1,-1,1,0],[-1,-1,-1,0]]),Li(this,"p",[]),Li(this,"perm",[]),Li(this,"simplex",[[0,1,2,3],[0,1,3,2],[0,0,0,0],[0,2,3,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,3,0],[0,2,1,3],[0,0,0,0],[0,3,1,2],[0,3,2,1],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,3,2,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,2,0,3],[0,0,0,0],[1,3,0,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,3,0,1],[2,3,1,0],[1,0,2,3],[1,0,3,2],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,3,1],[0,0,0,0],[2,1,3,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0],[2,0,1,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,0,1,2],[3,0,2,1],[0,0,0,0],[3,1,2,0],[2,1,0,3],[0,0,0,0],[0,0,0,0],[0,0,0,0],[3,1,0,2],[0,0,0,0],[3,2,0,1],[3,2,1,0]]),Li(this,"dot",(t,i,s)=>t[0]*i+t[1]*s),Li(this,"dot3",(t,i,s,r)=>t[0]*i+t[1]*s+t[2]*r),Li(this,"dot4",(t,i,s,r,o)=>t[0]*i+t[1]*s+t[2]*r+t[3]*o),Li(this,"noise",(t,i)=>{let s,r,o;const a=.5*(Math.sqrt(3)-1),c=(t+i)*a,l=Math.floor(t+c),u=Math.floor(i+c),h=(3-Math.sqrt(3))/6,f=(l+u)*h,d=l-f,p=u-f,m=t-d,g=i-p;let y=0,v=1;m>g&&(y=1,v=0);const E=m-y+h,C=g-v+h,x=m-1+2*h,I=g-1+2*h,S=l&255,w=u&255,B=this.perm[S+this.perm[w]]%12,T=this.perm[S+y+this.perm[w+v]]%12,R=this.perm[S+1+this.perm[w+1]]%12;let _=.5-m*m-g*g;_<0?s=0:(_*=_,s=_*_*this.dot(this.grad3[B],m,g));let L=.5-E*E-C*C;L<0?r=0:(L*=L,r=L*L*this.dot(this.grad3[T],E,C));let O=.5-x*x-I*I;return O<0?o=0:(O*=O,o=O*O*this.dot(this.grad3[R],x,I)),70*(s+r+o)}),Li(this,"noise3d",(t,i,s)=>{let r,o,a,c;const u=(t+i+s)*.3333333333333333,h=Math.floor(t+u),f=Math.floor(i+u),d=Math.floor(s+u),p=1/6,m=(h+f+d)*p,g=h-m,y=f-m,v=d-m,E=t-g,C=i-y,x=s-v;let I,S,w,B,T,R;E>=C?C>=x?(I=1,S=0,w=0,B=1,T=1,R=0):E>=x?(I=1,S=0,w=0,B=1,T=0,R=1):(I=0,S=0,w=1,B=1,T=0,R=1):C<x?(I=0,S=0,w=1,B=0,T=1,R=1):E<x?(I=0,S=1,w=0,B=0,T=1,R=1):(I=0,S=1,w=0,B=1,T=1,R=0);const _=E-I+p,L=C-S+p,O=x-w+p,U=E-B+2*p,Q=C-T+2*p,G=x-R+2*p,z=E-1+3*p,H=C-1+3*p,N=x-1+3*p,V=h&255,$=f&255,Y=d&255,M=this.perm[V+this.perm[$+this.perm[Y]]]%12,k=this.perm[V+I+this.perm[$+S+this.perm[Y+w]]]%12,P=this.perm[V+B+this.perm[$+T+this.perm[Y+R]]]%12,F=this.perm[V+1+this.perm[$+1+this.perm[Y+1]]]%12;let J=.6-E*E-C*C-x*x;J<0?r=0:(J*=J,r=J*J*this.dot3(this.grad3[M],E,C,x));let se=.6-_*_-L*L-O*O;se<0?o=0:(se*=se,o=se*se*this.dot3(this.grad3[k],_,L,O));let q=.6-U*U-Q*Q-G*G;q<0?a=0:(q*=q,a=q*q*this.dot3(this.grad3[P],U,Q,G));let re=.6-z*z-H*H-N*N;return re<0?c=0:(re*=re,c=re*re*this.dot3(this.grad3[F],z,H,N)),32*(r+o+a+c)}),Li(this,"noise4d",(t,i,s,r)=>{const o=this.grad4,a=this.simplex,c=this.perm,l=(Math.sqrt(5)-1)/4,u=(5-Math.sqrt(5))/20;let h,f,d,p,m;const g=(t+i+s+r)*l,y=Math.floor(t+g),v=Math.floor(i+g),E=Math.floor(s+g),C=Math.floor(r+g),x=(y+v+E+C)*u,I=y-x,S=v-x,w=E-x,B=C-x,T=t-I,R=i-S,_=s-w,L=r-B,O=T>R?32:0,U=T>_?16:0,Q=R>_?8:0,G=T>L?4:0,z=R>L?2:0,H=_>L?1:0,N=O+U+Q+G+z+H;let V,$,Y,M,k,P,F,J,se,q,re,he;V=a[N][0]>=3?1:0,$=a[N][1]>=3?1:0,Y=a[N][2]>=3?1:0,M=a[N][3]>=3?1:0,k=a[N][0]>=2?1:0,P=a[N][1]>=2?1:0,F=a[N][2]>=2?1:0,J=a[N][3]>=2?1:0,se=a[N][0]>=1?1:0,q=a[N][1]>=1?1:0,re=a[N][2]>=1?1:0,he=a[N][3]>=1?1:0;const fe=T-V+u,ae=R-$+u,ue=_-Y+u,ge=L-M+u,me=T-k+2*u,W=R-P+2*u,K=_-F+2*u,pe=L-J+2*u,Fe=T-se+3*u,Se=R-q+3*u,be=_-re+3*u,De=L-he+3*u,Ne=T-1+4*u,ot=R-1+4*u,Je=_-1+4*u,Ht=L-1+4*u,Kt=y&255,Qt=v&255,hi=E&255,ni=C&255,Ks=c[Kt+c[Qt+c[hi+c[ni]]]]%32,gn=c[Kt+V+c[Qt+$+c[hi+Y+c[ni+M]]]]%32,Jc=c[Kt+k+c[Qt+P+c[hi+F+c[ni+J]]]]%32,Go=c[Kt+se+c[Qt+q+c[hi+re+c[ni+he]]]]%32,zo=c[Kt+1+c[Qt+1+c[hi+1+c[ni+1]]]]%32;let Di=.6-T*T-R*R-_*_-L*L;Di<0?h=0:(Di*=Di,h=Di*Di*this.dot4(o[Ks],T,R,_,L));let Tr=.6-fe*fe-ae*ae-ue*ue-ge*ge;Tr<0?f=0:(Tr*=Tr,f=Tr*Tr*this.dot4(o[gn],fe,ae,ue,ge));let Br=.6-me*me-W*W-K*K-pe*pe;Br<0?d=0:(Br*=Br,d=Br*Br*this.dot4(o[Jc],me,W,K,pe));let _r=.6-Fe*Fe-Se*Se-be*be-De*De;_r<0?p=0:(_r*=_r,p=_r*_r*this.dot4(o[Go],Fe,Se,be,De));let br=.6-Ne*Ne-ot*ot-Je*Je-Ht*Ht;return br<0?m=0:(br*=br,m=br*br*this.dot4(o[zo],Ne,ot,Je,Ht)),27*(h+f+d+p+m)});for(let t=0;t<256;t++)this.p[t]=Math.floor(e.random()*256);for(let t=0;t<512;t++)this.perm[t]=this.p[t&255]}}var Hv=Object.defineProperty,Kv=(n,e,t)=>e in n?Hv(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,H1=(n,e,t)=>(Kv(n,typeof e!="symbol"?e+"":e,t),t);const Ja={uniforms:{turbidity:{value:2},rayleigh:{value:1},mieCoefficient:{value:.005},mieDirectionalG:{value:.8},sunPosition:{value:new b},up:{value:new b(0,1,0)}},vertexShader:`
      uniform vec3 sunPosition;
      uniform float rayleigh;
      uniform float turbidity;
      uniform float mieCoefficient;
      uniform vec3 up;

      varying vec3 vWorldPosition;
      varying vec3 vSunDirection;
      varying float vSunfade;
      varying vec3 vBetaR;
      varying vec3 vBetaM;
      varying float vSunE;

      // constants for atmospheric scattering
      const float e = 2.71828182845904523536028747135266249775724709369995957;
      const float pi = 3.141592653589793238462643383279502884197169;

      // wavelength of used primaries, according to preetham
      const vec3 lambda = vec3( 680E-9, 550E-9, 450E-9 );
      // this pre-calcuation replaces older TotalRayleigh(vec3 lambda) function:
      // (8.0 * pow(pi, 3.0) * pow(pow(n, 2.0) - 1.0, 2.0) * (6.0 + 3.0 * pn)) / (3.0 * N * pow(lambda, vec3(4.0)) * (6.0 - 7.0 * pn))
      const vec3 totalRayleigh = vec3( 5.804542996261093E-6, 1.3562911419845635E-5, 3.0265902468824876E-5 );

      // mie stuff
      // K coefficient for the primaries
      const float v = 4.0;
      const vec3 K = vec3( 0.686, 0.678, 0.666 );
      // MieConst = pi * pow( ( 2.0 * pi ) / lambda, vec3( v - 2.0 ) ) * K
      const vec3 MieConst = vec3( 1.8399918514433978E14, 2.7798023919660528E14, 4.0790479543861094E14 );

      // earth shadow hack
      // cutoffAngle = pi / 1.95;
      const float cutoffAngle = 1.6110731556870734;
      const float steepness = 1.5;
      const float EE = 1000.0;

      float sunIntensity( float zenithAngleCos ) {
        zenithAngleCos = clamp( zenithAngleCos, -1.0, 1.0 );
        return EE * max( 0.0, 1.0 - pow( e, -( ( cutoffAngle - acos( zenithAngleCos ) ) / steepness ) ) );
      }

      vec3 totalMie( float T ) {
        float c = ( 0.2 * T ) * 10E-18;
        return 0.434 * c * MieConst;
      }

      void main() {

        vec4 worldPosition = modelMatrix * vec4( position, 1.0 );
        vWorldPosition = worldPosition.xyz;

        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        gl_Position.z = gl_Position.w; // set z to camera.far

        vSunDirection = normalize( sunPosition );

        vSunE = sunIntensity( dot( vSunDirection, up ) );

        vSunfade = 1.0 - clamp( 1.0 - exp( ( sunPosition.y / 450000.0 ) ), 0.0, 1.0 );

        float rayleighCoefficient = rayleigh - ( 1.0 * ( 1.0 - vSunfade ) );

      // extinction (absorbtion + out scattering)
      // rayleigh coefficients
        vBetaR = totalRayleigh * rayleighCoefficient;

      // mie coefficients
        vBetaM = totalMie( turbidity ) * mieCoefficient;

      }
    `,fragmentShader:`
      varying vec3 vWorldPosition;
      varying vec3 vSunDirection;
      varying float vSunfade;
      varying vec3 vBetaR;
      varying vec3 vBetaM;
      varying float vSunE;

      uniform float mieDirectionalG;
      uniform vec3 up;

      const vec3 cameraPos = vec3( 0.0, 0.0, 0.0 );

      // constants for atmospheric scattering
      const float pi = 3.141592653589793238462643383279502884197169;

      const float n = 1.0003; // refractive index of air
      const float N = 2.545E25; // number of molecules per unit volume for air at 288.15K and 1013mb (sea level -45 celsius)

      // optical length at zenith for molecules
      const float rayleighZenithLength = 8.4E3;
      const float mieZenithLength = 1.25E3;
      // 66 arc seconds -> degrees, and the cosine of that
      const float sunAngularDiameterCos = 0.999956676946448443553574619906976478926848692873900859324;

      // 3.0 / ( 16.0 * pi )
      const float THREE_OVER_SIXTEENPI = 0.05968310365946075;
      // 1.0 / ( 4.0 * pi )
      const float ONE_OVER_FOURPI = 0.07957747154594767;

      float rayleighPhase( float cosTheta ) {
        return THREE_OVER_SIXTEENPI * ( 1.0 + pow( cosTheta, 2.0 ) );
      }

      float hgPhase( float cosTheta, float g ) {
        float g2 = pow( g, 2.0 );
        float inverse = 1.0 / pow( 1.0 - 2.0 * g * cosTheta + g2, 1.5 );
        return ONE_OVER_FOURPI * ( ( 1.0 - g2 ) * inverse );
      }

      void main() {

        vec3 direction = normalize( vWorldPosition - cameraPos );

      // optical length
      // cutoff angle at 90 to avoid singularity in next formula.
        float zenithAngle = acos( max( 0.0, dot( up, direction ) ) );
        float inverse = 1.0 / ( cos( zenithAngle ) + 0.15 * pow( 93.885 - ( ( zenithAngle * 180.0 ) / pi ), -1.253 ) );
        float sR = rayleighZenithLength * inverse;
        float sM = mieZenithLength * inverse;

      // combined extinction factor
        vec3 Fex = exp( -( vBetaR * sR + vBetaM * sM ) );

      // in scattering
        float cosTheta = dot( direction, vSunDirection );

        float rPhase = rayleighPhase( cosTheta * 0.5 + 0.5 );
        vec3 betaRTheta = vBetaR * rPhase;

        float mPhase = hgPhase( cosTheta, mieDirectionalG );
        vec3 betaMTheta = vBetaM * mPhase;

        vec3 Lin = pow( vSunE * ( ( betaRTheta + betaMTheta ) / ( vBetaR + vBetaM ) ) * ( 1.0 - Fex ), vec3( 1.5 ) );
        Lin *= mix( vec3( 1.0 ), pow( vSunE * ( ( betaRTheta + betaMTheta ) / ( vBetaR + vBetaM ) ) * Fex, vec3( 1.0 / 2.0 ) ), clamp( pow( 1.0 - dot( up, vSunDirection ), 5.0 ), 0.0, 1.0 ) );

      // nightsky
        float theta = acos( direction.y ); // elevation --> y-axis, [-pi/2, pi/2]
        float phi = atan( direction.z, direction.x ); // azimuth --> x-axis [-pi/2, pi/2]
        vec2 uv = vec2( phi, theta ) / vec2( 2.0 * pi, pi ) + vec2( 0.5, 0.0 );
        vec3 L0 = vec3( 0.1 ) * Fex;

      // composition + solar disc
        float sundisk = smoothstep( sunAngularDiameterCos, sunAngularDiameterCos + 0.00002, cosTheta );
        L0 += ( vSunE * 19000.0 * Fex ) * sundisk;

        vec3 texColor = ( Lin + L0 ) * 0.04 + vec3( 0.0, 0.0003, 0.00075 );

        vec3 retColor = pow( texColor, vec3( 1.0 / ( 1.2 + ( 1.2 * vSunfade ) ) ) );

        gl_FragColor = vec4( retColor, 1.0 );

      #include <tonemapping_fragment>
      #include <${Hh>=154?"colorspace_fragment":"encodings_fragment"}>

      }
    `},K1=new Dt({name:"SkyShader",fragmentShader:Ja.fragmentShader,vertexShader:Ja.vertexShader,uniforms:_o.clone(Ja.uniforms),side:Cr,depthWrite:!1});let Vh=class extends ye{constructor(){super(new Ls(1,1,1),K1)}};H1(Vh,"SkyShader",Ja);H1(Vh,"material",K1);function V1(n,e,t={}){const i=new b,s=new Be,r=new b,o=new ce,a=new ce,c=new ce;t.preserveMatrix=t.preserveMatrix!==void 0?t.preserveMatrix:!0,t.preservePosition=t.preservePosition!==void 0?t.preservePosition:!0,t.preserveHipPosition=t.preserveHipPosition!==void 0?t.preserveHipPosition:!1,t.useTargetMatrix=t.useTargetMatrix!==void 0?t.useTargetMatrix:!1,t.hip=t.hip!==void 0?t.hip:"hip",t.names=t.names||{};const l=e.isObject3D?e.skeleton.bones:Ac(e),u=n.isObject3D?n.skeleton.bones:Ac(n);let h,f,d,p,m;if(n.isObject3D?n.skeleton.pose():(t.useTargetMatrix=!0,t.preserveMatrix=!1),t.preservePosition){m=[];for(let g=0;g<u.length;g++)m.push(u[g].position.clone())}if(t.preserveMatrix){n.updateMatrixWorld(),n.matrixWorld.identity();for(let g=0;g<n.children.length;++g)n.children[g].updateMatrixWorld(!0)}if(t.offsets){h=[];for(let g=0;g<u.length;++g)f=u[g],d=t.names[f.name]||f.name,t.offsets[d]&&(f.matrix.multiply(t.offsets[d]),f.matrix.decompose(f.position,f.quaternion,f.scale),f.updateMatrixWorld()),h.push(f.matrixWorld.clone())}for(let g=0;g<u.length;++g){if(f=u[g],d=t.names[f.name]||f.name,p=Y1(d,l),c.copy(f.matrixWorld),p){if(p.updateMatrixWorld(),t.useTargetMatrix?a.copy(p.matrixWorld):(a.copy(n.matrixWorld).invert(),a.multiply(p.matrixWorld)),r.setFromMatrixScale(a),a.scale(r.set(1/r.x,1/r.y,1/r.z)),c.makeRotationFromQuaternion(s.setFromRotationMatrix(a)),n.isObject3D){const y=u.indexOf(f),v=h?h[y]:o.copy(n.skeleton.boneInverses[y]).invert();c.multiply(v)}c.copyPosition(a)}f.parent&&f.parent.isBone?(f.matrix.copy(f.parent.matrixWorld).invert(),f.matrix.multiply(c)):f.matrix.copy(c),t.preserveHipPosition&&d===t.hip&&f.matrix.setPosition(i.set(0,f.position.y,0)),f.matrix.decompose(f.position,f.quaternion,f.scale),f.updateMatrixWorld()}if(t.preservePosition)for(let g=0;g<u.length;++g)f=u[g],d=t.names[f.name]||f.name,d!==t.hip&&f.position.copy(m[g]);t.preserveMatrix&&n.updateMatrixWorld(!0)}function Vv(n,e,t,i={}){i.useFirstFramePosition=i.useFirstFramePosition!==void 0?i.useFirstFramePosition:!1,i.fps=i.fps!==void 0?i.fps:30,i.names=i.names||[],e.isObject3D||(e=$v(e));const s=Math.round(t.duration*(i.fps/1e3)*1e3),r=1/i.fps,o=[],a=new qm(e),c=Ac(n.skeleton),l=[];let u,h,f,d,p;a.clipAction(t).play(),a.update(0),e.updateMatrixWorld();for(let m=0;m<s;++m){const g=m*r;V1(n,e,i);for(let y=0;y<c.length;++y)p=i.names[c[y].name]||c[y].name,f=Y1(p,e.skeleton),f&&(h=c[y],d=l[y]=l[y]||{bone:h},i.hip===p&&(d.pos||(d.pos={times:new Float32Array(s),values:new Float32Array(s*3)}),i.useFirstFramePosition&&(m===0&&(u=h.position.clone()),h.position.sub(u)),d.pos.times[m]=g,h.position.toArray(d.pos.values,m*3)),d.quat||(d.quat={times:new Float32Array(s),values:new Float32Array(s*4)}),d.quat.times[m]=g,h.quaternion.toArray(d.quat.values,m*4));a.update(r),e.updateMatrixWorld()}for(let m=0;m<l.length;++m)d=l[m],d&&(d.pos&&o.push(new ac(".bones["+d.bone.name+"].position",d.pos.times,d.pos.values)),o.push(new cc(".bones["+d.bone.name+"].quaternion",d.quat.times,d.quat.values)));return a.uncacheAction(t),new Dh(t.name,-1,o)}function Yv(n){const e=new Map,t=new Map,i=n.clone();return $1(n,i,function(s,r){e.set(r,s),t.set(s,r)}),i.traverse(function(s){if(!s.isSkinnedMesh)return;const r=s,o=e.get(s),a=o.skeleton.bones;r.skeleton=o.skeleton.clone(),r.bindMatrix.copy(o.bindMatrix),r.skeleton.bones=a.map(function(c){return t.get(c)}),r.bind(r.skeleton,r.bindMatrix)}),i}function Y1(n,e){for(let t=0,i=Ac(e);t<i.length;t++)if(n===i[t].name)return i[t]}function Ac(n){return Array.isArray(n)?n:n.bones}function $v(n){const e=new ey(n.bones[0]);return e.skeleton=n,e}function $1(n,e,t){t(n,e);for(let i=0;i<n.children.length;i++)$1(n.children[i],e.children[i],t)}const Wv={retarget:V1,retargetClip:Vv,clone:Yv},Lt=new ir,Jo=new b;class jv{constructor(e){let t=e.geometry;t.index&&(console.warn("THREE.MeshSurfaceSampler: Converting geometry to non-indexed BufferGeometry."),t=t.toNonIndexed()),this.geometry=t,this.randomFunction=Math.random,this.positionAttribute=this.geometry.getAttribute("position"),this.colorAttribute=this.geometry.getAttribute("color"),this.weightAttribute=null,this.distribution=null}setWeightAttribute(e){return this.weightAttribute=e?this.geometry.getAttribute(e):null,this}build(){const e=this.positionAttribute,t=this.weightAttribute,i=new Float32Array(e.count/3);for(let r=0;r<e.count;r+=3){let o=1;t&&(o=t.getX(r)+t.getX(r+1)+t.getX(r+2)),Lt.a.fromBufferAttribute(e,r),Lt.b.fromBufferAttribute(e,r+1),Lt.c.fromBufferAttribute(e,r+2),o*=Lt.getArea(),i[r/3]=o}this.distribution=new Float32Array(e.count/3);let s=0;for(let r=0;r<i.length;r++)s+=i[r],this.distribution[r]=s;return this}setRandomGenerator(e){return this.randomFunction=e,this}sample(e,t,i){const s=this.sampleFaceIndex();return this.sampleFace(s,e,t,i)}sampleFaceIndex(){const e=this.distribution[this.distribution.length-1];return this.binarySearch(this.randomFunction()*e)}binarySearch(e){const t=this.distribution;let i=0,s=t.length-1,r=-1;for(;i<=s;){const o=Math.ceil((i+s)/2);if(o===0||t[o-1]<=e&&t[o]>e){r=o;break}else e<t[o]?s=o-1:i=o+1}return r}sampleFace(e,t,i,s){let r=this.randomFunction(),o=this.randomFunction();return r+o>1&&(r=1-r,o=1-o),Lt.a.fromBufferAttribute(this.positionAttribute,e*3),Lt.b.fromBufferAttribute(this.positionAttribute,e*3+1),Lt.c.fromBufferAttribute(this.positionAttribute,e*3+2),t.set(0,0,0).addScaledVector(Lt.a,r).addScaledVector(Lt.b,o).addScaledVector(Lt.c,1-(r+o)),i!==void 0&&Lt.getNormal(i),s!==void 0&&this.colorAttribute!==void 0&&(Lt.a.fromBufferAttribute(this.colorAttribute,e*3),Lt.b.fromBufferAttribute(this.colorAttribute,e*3+1),Lt.c.fromBufferAttribute(this.colorAttribute,e*3+2),Jo.set(0,0,0).addScaledVector(Lt.a,r).addScaledVector(Lt.b,o).addScaledVector(Lt.c,1-(r+o)),s.r=Jo.x,s.g=Jo.y,s.b=Jo.z),this}}var Jv=Object.defineProperty,qv=(n,e,t)=>e in n?Jv(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,Me=(n,e,t)=>(qv(n,typeof e!="symbol"?e+"":e,t),t);const Md=new b;let Xv=class extends hn{constructor(e,t){super(),Me(this,"object"),Me(this,"domElement"),Me(this,"enabled",!0),Me(this,"movementSpeed",1),Me(this,"lookSpeed",.005),Me(this,"lookVertical",!0),Me(this,"autoForward",!1),Me(this,"activeLook",!0),Me(this,"heightSpeed",!1),Me(this,"heightCoef",1),Me(this,"heightMin",0),Me(this,"heightMax",1),Me(this,"constrainVertical",!1),Me(this,"verticalMin",0),Me(this,"verticalMax",Math.PI),Me(this,"mouseDragOn",!1),Me(this,"autoSpeedFactor",0),Me(this,"mouseX",0),Me(this,"mouseY",0),Me(this,"moveForward",!1),Me(this,"moveBackward",!1),Me(this,"moveLeft",!1),Me(this,"moveRight",!1),Me(this,"moveUp",!1),Me(this,"moveDown",!1),Me(this,"viewHalfX",0),Me(this,"viewHalfY",0),Me(this,"lat",0),Me(this,"lon",0),Me(this,"lookDirection",new b),Me(this,"spherical",new _c),Me(this,"target",new b),Me(this,"connect",i=>{i.setAttribute("tabindex","-1"),i.style.touchAction="none",i.addEventListener("contextmenu",this.contextmenu),i.addEventListener("mousemove",this.onMouseMove),i.addEventListener("mousedown",this.onMouseDown),i.addEventListener("mouseup",this.onMouseUp),this.domElement=i,window.addEventListener("keydown",this.onKeyDown),window.addEventListener("keyup",this.onKeyUp),this.handleResize()}),Me(this,"dispose",()=>{var i,s,r,o;(i=this.domElement)==null||i.removeEventListener("contextmenu",this.contextmenu),(s=this.domElement)==null||s.removeEventListener("mousedown",this.onMouseDown),(r=this.domElement)==null||r.removeEventListener("mousemove",this.onMouseMove),(o=this.domElement)==null||o.removeEventListener("mouseup",this.onMouseUp),window.removeEventListener("keydown",this.onKeyDown),window.removeEventListener("keyup",this.onKeyUp)}),Me(this,"handleResize",()=>{this.domElement&&(this.viewHalfX=this.domElement.offsetWidth/2,this.viewHalfY=this.domElement.offsetHeight/2)}),Me(this,"onMouseDown",i=>{var s;if((s=this.domElement)==null||s.focus(),this.activeLook)switch(i.button){case 0:this.moveForward=!0;break;case 2:this.moveBackward=!0;break}this.mouseDragOn=!0}),Me(this,"onMouseUp",i=>{if(this.activeLook)switch(i.button){case 0:this.moveForward=!1;break;case 2:this.moveBackward=!1;break}this.mouseDragOn=!1}),Me(this,"onMouseMove",i=>{this.domElement&&(this.mouseX=i.pageX-this.domElement.offsetLeft-this.viewHalfX,this.mouseY=i.pageY-this.domElement.offsetTop-this.viewHalfY)}),Me(this,"onKeyDown",i=>{switch(i.code){case"ArrowUp":case"KeyW":this.moveForward=!0;break;case"ArrowLeft":case"KeyA":this.moveLeft=!0;break;case"ArrowDown":case"KeyS":this.moveBackward=!0;break;case"ArrowRight":case"KeyD":this.moveRight=!0;break;case"KeyR":this.moveUp=!0;break;case"KeyF":this.moveDown=!0;break}}),Me(this,"onKeyUp",i=>{switch(i.code){case"ArrowUp":case"KeyW":this.moveForward=!1;break;case"ArrowLeft":case"KeyA":this.moveLeft=!1;break;case"ArrowDown":case"KeyS":this.moveBackward=!1;break;case"ArrowRight":case"KeyD":this.moveRight=!1;break;case"KeyR":this.moveUp=!1;break;case"KeyF":this.moveDown=!1;break}}),Me(this,"lookAt",(i,s,r)=>(i instanceof b?this.target.copy(i):s&&r&&this.target.set(i,s,r),this.object.lookAt(this.target),this.setOrientation(),this)),Me(this,"update",i=>{if(!this.enabled)return;if(this.heightSpeed){const h=Ce.clamp(this.object.position.y,this.heightMin,this.heightMax)-this.heightMin;this.autoSpeedFactor=i*(h*this.heightCoef)}else this.autoSpeedFactor=0;const s=i*this.movementSpeed;(this.moveForward||this.autoForward&&!this.moveBackward)&&this.object.translateZ(-(s+this.autoSpeedFactor)),this.moveBackward&&this.object.translateZ(s),this.moveLeft&&this.object.translateX(-s),this.moveRight&&this.object.translateX(s),this.moveUp&&this.object.translateY(s),this.moveDown&&this.object.translateY(-s);let r=i*this.lookSpeed;this.activeLook||(r=0);let o=1;this.constrainVertical&&(o=Math.PI/(this.verticalMax-this.verticalMin)),this.lon-=this.mouseX*r,this.lookVertical&&(this.lat-=this.mouseY*r*o),this.lat=Math.max(-85,Math.min(85,this.lat));let a=Ce.degToRad(90-this.lat);const c=Ce.degToRad(this.lon);this.constrainVertical&&(a=Ce.mapLinear(a,0,Math.PI,this.verticalMin,this.verticalMax));const l=this.object.position;Md.setFromSphericalCoords(1,a,c).add(l),this.object.lookAt(Md)}),Me(this,"contextmenu",i=>i.preventDefault()),Me(this,"setOrientation",()=>{this.lookDirection.set(0,0,-1).applyQuaternion(this.object.quaternion),this.spherical.setFromVector3(this.lookDirection),this.lat=90-Ce.radToDeg(this.spherical.phi),this.lon=Ce.radToDeg(this.spherical.theta)}),this.object=e,this.domElement=t,this.setOrientation(),t&&this.connect(t)}};var Zv=Object.defineProperty,ex=(n,e,t)=>e in n?Zv(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,ne=(n,e,t)=>(ex(n,typeof e!="symbol"?e+"":e,t),t);let tx=class extends lt{constructor(e,t){super(),ne(this,"isTransformControls",!0),ne(this,"visible",!1),ne(this,"domElement"),ne(this,"raycaster",new bc),ne(this,"gizmo"),ne(this,"plane"),ne(this,"tempVector",new b),ne(this,"tempVector2",new b),ne(this,"tempQuaternion",new Be),ne(this,"unit",{X:new b(1,0,0),Y:new b(0,1,0),Z:new b(0,0,1)}),ne(this,"pointStart",new b),ne(this,"pointEnd",new b),ne(this,"offset",new b),ne(this,"rotationAxis",new b),ne(this,"startNorm",new b),ne(this,"endNorm",new b),ne(this,"rotationAngle",0),ne(this,"cameraPosition",new b),ne(this,"cameraQuaternion",new Be),ne(this,"cameraScale",new b),ne(this,"parentPosition",new b),ne(this,"parentQuaternion",new Be),ne(this,"parentQuaternionInv",new Be),ne(this,"parentScale",new b),ne(this,"worldPositionStart",new b),ne(this,"worldQuaternionStart",new Be),ne(this,"worldScaleStart",new b),ne(this,"worldPosition",new b),ne(this,"worldQuaternion",new Be),ne(this,"worldQuaternionInv",new Be),ne(this,"worldScale",new b),ne(this,"eye",new b),ne(this,"positionStart",new b),ne(this,"quaternionStart",new Be),ne(this,"scaleStart",new b),ne(this,"camera"),ne(this,"object"),ne(this,"enabled",!0),ne(this,"axis",null),ne(this,"mode","translate"),ne(this,"translationSnap",null),ne(this,"rotationSnap",null),ne(this,"scaleSnap",null),ne(this,"space","world"),ne(this,"size",1),ne(this,"dragging",!1),ne(this,"showX",!0),ne(this,"showY",!0),ne(this,"showZ",!0),ne(this,"changeEvent",{type:"change"}),ne(this,"mouseDownEvent",{type:"mouseDown",mode:this.mode}),ne(this,"mouseUpEvent",{type:"mouseUp",mode:this.mode}),ne(this,"objectChangeEvent",{type:"objectChange"}),ne(this,"intersectObjectWithRay",(s,r,o)=>{const a=r.intersectObject(s,!0);for(let c=0;c<a.length;c++)if(a[c].object.visible||o)return a[c];return!1}),ne(this,"attach",s=>(this.object=s,this.visible=!0,this)),ne(this,"detach",()=>(this.object=void 0,this.visible=!1,this.axis=null,this)),ne(this,"reset",()=>this.enabled?(this.dragging&&this.object!==void 0&&(this.object.position.copy(this.positionStart),this.object.quaternion.copy(this.quaternionStart),this.object.scale.copy(this.scaleStart),this.dispatchEvent(this.changeEvent),this.dispatchEvent(this.objectChangeEvent),this.pointStart.copy(this.pointEnd)),this):this),ne(this,"updateMatrixWorld",()=>{this.object!==void 0&&(this.object.updateMatrixWorld(),this.object.parent===null?console.error("TransformControls: The attached 3D object must be a part of the scene graph."):this.object.parent.matrixWorld.decompose(this.parentPosition,this.parentQuaternion,this.parentScale),this.object.matrixWorld.decompose(this.worldPosition,this.worldQuaternion,this.worldScale),this.parentQuaternionInv.copy(this.parentQuaternion).invert(),this.worldQuaternionInv.copy(this.worldQuaternion).invert()),this.camera.updateMatrixWorld(),this.camera.matrixWorld.decompose(this.cameraPosition,this.cameraQuaternion,this.cameraScale),this.eye.copy(this.cameraPosition).sub(this.worldPosition).normalize(),super.updateMatrixWorld()}),ne(this,"pointerHover",s=>{if(this.object===void 0||this.dragging===!0)return;this.raycaster.setFromCamera(s,this.camera);const r=this.intersectObjectWithRay(this.gizmo.picker[this.mode],this.raycaster);r?this.axis=r.object.name:this.axis=null}),ne(this,"pointerDown",s=>{if(!(this.object===void 0||this.dragging===!0||s.button!==0)&&this.axis!==null){this.raycaster.setFromCamera(s,this.camera);const r=this.intersectObjectWithRay(this.plane,this.raycaster,!0);if(r){let o=this.space;if(this.mode==="scale"?o="local":(this.axis==="E"||this.axis==="XYZE"||this.axis==="XYZ")&&(o="world"),o==="local"&&this.mode==="rotate"){const a=this.rotationSnap;this.axis==="X"&&a&&(this.object.rotation.x=Math.round(this.object.rotation.x/a)*a),this.axis==="Y"&&a&&(this.object.rotation.y=Math.round(this.object.rotation.y/a)*a),this.axis==="Z"&&a&&(this.object.rotation.z=Math.round(this.object.rotation.z/a)*a)}this.object.updateMatrixWorld(),this.object.parent&&this.object.parent.updateMatrixWorld(),this.positionStart.copy(this.object.position),this.quaternionStart.copy(this.object.quaternion),this.scaleStart.copy(this.object.scale),this.object.matrixWorld.decompose(this.worldPositionStart,this.worldQuaternionStart,this.worldScaleStart),this.pointStart.copy(r.point).sub(this.worldPositionStart)}this.dragging=!0,this.mouseDownEvent.mode=this.mode,this.dispatchEvent(this.mouseDownEvent)}}),ne(this,"pointerMove",s=>{const r=this.axis,o=this.mode,a=this.object;let c=this.space;if(o==="scale"?c="local":(r==="E"||r==="XYZE"||r==="XYZ")&&(c="world"),a===void 0||r===null||this.dragging===!1||s.button!==-1)return;this.raycaster.setFromCamera(s,this.camera);const l=this.intersectObjectWithRay(this.plane,this.raycaster,!0);if(l){if(this.pointEnd.copy(l.point).sub(this.worldPositionStart),o==="translate")this.offset.copy(this.pointEnd).sub(this.pointStart),c==="local"&&r!=="XYZ"&&this.offset.applyQuaternion(this.worldQuaternionInv),r.indexOf("X")===-1&&(this.offset.x=0),r.indexOf("Y")===-1&&(this.offset.y=0),r.indexOf("Z")===-1&&(this.offset.z=0),c==="local"&&r!=="XYZ"?this.offset.applyQuaternion(this.quaternionStart).divide(this.parentScale):this.offset.applyQuaternion(this.parentQuaternionInv).divide(this.parentScale),a.position.copy(this.offset).add(this.positionStart),this.translationSnap&&(c==="local"&&(a.position.applyQuaternion(this.tempQuaternion.copy(this.quaternionStart).invert()),r.search("X")!==-1&&(a.position.x=Math.round(a.position.x/this.translationSnap)*this.translationSnap),r.search("Y")!==-1&&(a.position.y=Math.round(a.position.y/this.translationSnap)*this.translationSnap),r.search("Z")!==-1&&(a.position.z=Math.round(a.position.z/this.translationSnap)*this.translationSnap),a.position.applyQuaternion(this.quaternionStart)),c==="world"&&(a.parent&&a.position.add(this.tempVector.setFromMatrixPosition(a.parent.matrixWorld)),r.search("X")!==-1&&(a.position.x=Math.round(a.position.x/this.translationSnap)*this.translationSnap),r.search("Y")!==-1&&(a.position.y=Math.round(a.position.y/this.translationSnap)*this.translationSnap),r.search("Z")!==-1&&(a.position.z=Math.round(a.position.z/this.translationSnap)*this.translationSnap),a.parent&&a.position.sub(this.tempVector.setFromMatrixPosition(a.parent.matrixWorld))));else if(o==="scale"){if(r.search("XYZ")!==-1){let u=this.pointEnd.length()/this.pointStart.length();this.pointEnd.dot(this.pointStart)<0&&(u*=-1),this.tempVector2.set(u,u,u)}else this.tempVector.copy(this.pointStart),this.tempVector2.copy(this.pointEnd),this.tempVector.applyQuaternion(this.worldQuaternionInv),this.tempVector2.applyQuaternion(this.worldQuaternionInv),this.tempVector2.divide(this.tempVector),r.search("X")===-1&&(this.tempVector2.x=1),r.search("Y")===-1&&(this.tempVector2.y=1),r.search("Z")===-1&&(this.tempVector2.z=1);a.scale.copy(this.scaleStart).multiply(this.tempVector2),this.scaleSnap&&this.object&&(r.search("X")!==-1&&(this.object.scale.x=Math.round(a.scale.x/this.scaleSnap)*this.scaleSnap||this.scaleSnap),r.search("Y")!==-1&&(a.scale.y=Math.round(a.scale.y/this.scaleSnap)*this.scaleSnap||this.scaleSnap),r.search("Z")!==-1&&(a.scale.z=Math.round(a.scale.z/this.scaleSnap)*this.scaleSnap||this.scaleSnap))}else if(o==="rotate"){this.offset.copy(this.pointEnd).sub(this.pointStart);const u=20/this.worldPosition.distanceTo(this.tempVector.setFromMatrixPosition(this.camera.matrixWorld));r==="E"?(this.rotationAxis.copy(this.eye),this.rotationAngle=this.pointEnd.angleTo(this.pointStart),this.startNorm.copy(this.pointStart).normalize(),this.endNorm.copy(this.pointEnd).normalize(),this.rotationAngle*=this.endNorm.cross(this.startNorm).dot(this.eye)<0?1:-1):r==="XYZE"?(this.rotationAxis.copy(this.offset).cross(this.eye).normalize(),this.rotationAngle=this.offset.dot(this.tempVector.copy(this.rotationAxis).cross(this.eye))*u):(r==="X"||r==="Y"||r==="Z")&&(this.rotationAxis.copy(this.unit[r]),this.tempVector.copy(this.unit[r]),c==="local"&&this.tempVector.applyQuaternion(this.worldQuaternion),this.rotationAngle=this.offset.dot(this.tempVector.cross(this.eye).normalize())*u),this.rotationSnap&&(this.rotationAngle=Math.round(this.rotationAngle/this.rotationSnap)*this.rotationSnap),c==="local"&&r!=="E"&&r!=="XYZE"?(a.quaternion.copy(this.quaternionStart),a.quaternion.multiply(this.tempQuaternion.setFromAxisAngle(this.rotationAxis,this.rotationAngle)).normalize()):(this.rotationAxis.applyQuaternion(this.parentQuaternionInv),a.quaternion.copy(this.tempQuaternion.setFromAxisAngle(this.rotationAxis,this.rotationAngle)),a.quaternion.multiply(this.quaternionStart).normalize())}this.dispatchEvent(this.changeEvent),this.dispatchEvent(this.objectChangeEvent)}}),ne(this,"pointerUp",s=>{s.button===0&&(this.dragging&&this.axis!==null&&(this.mouseUpEvent.mode=this.mode,this.dispatchEvent(this.mouseUpEvent)),this.dragging=!1,this.axis=null)}),ne(this,"getPointer",s=>{var r;if(this.domElement&&((r=this.domElement.ownerDocument)!=null&&r.pointerLockElement))return{x:0,y:0,button:s.button};{const o=s.changedTouches?s.changedTouches[0]:s,a=this.domElement.getBoundingClientRect();return{x:(o.clientX-a.left)/a.width*2-1,y:-(o.clientY-a.top)/a.height*2+1,button:s.button}}}),ne(this,"onPointerHover",s=>{if(this.enabled)switch(s.pointerType){case"mouse":case"pen":this.pointerHover(this.getPointer(s));break}}),ne(this,"onPointerDown",s=>{!this.enabled||!this.domElement||(this.domElement.style.touchAction="none",this.domElement.ownerDocument.addEventListener("pointermove",this.onPointerMove),this.pointerHover(this.getPointer(s)),this.pointerDown(this.getPointer(s)))}),ne(this,"onPointerMove",s=>{this.enabled&&this.pointerMove(this.getPointer(s))}),ne(this,"onPointerUp",s=>{!this.enabled||!this.domElement||(this.domElement.style.touchAction="",this.domElement.ownerDocument.removeEventListener("pointermove",this.onPointerMove),this.pointerUp(this.getPointer(s)))}),ne(this,"getMode",()=>this.mode),ne(this,"setMode",s=>{this.mode=s}),ne(this,"setTranslationSnap",s=>{this.translationSnap=s}),ne(this,"setRotationSnap",s=>{this.rotationSnap=s}),ne(this,"setScaleSnap",s=>{this.scaleSnap=s}),ne(this,"setSize",s=>{this.size=s}),ne(this,"setSpace",s=>{this.space=s}),ne(this,"update",()=>{console.warn("THREE.TransformControls: update function has no more functionality and therefore has been deprecated.")}),ne(this,"connect",s=>{s===document&&console.error('THREE.OrbitControls: "document" should not be used as the target "domElement". Please use "renderer.domElement" instead.'),this.domElement=s,this.domElement.addEventListener("pointerdown",this.onPointerDown),this.domElement.addEventListener("pointermove",this.onPointerHover),this.domElement.ownerDocument.addEventListener("pointerup",this.onPointerUp)}),ne(this,"dispose",()=>{var s,r,o,a,c,l;(s=this.domElement)==null||s.removeEventListener("pointerdown",this.onPointerDown),(r=this.domElement)==null||r.removeEventListener("pointermove",this.onPointerHover),(a=(o=this.domElement)==null?void 0:o.ownerDocument)==null||a.removeEventListener("pointermove",this.onPointerMove),(l=(c=this.domElement)==null?void 0:c.ownerDocument)==null||l.removeEventListener("pointerup",this.onPointerUp),this.traverse(u=>{const h=u;h.geometry&&h.geometry.dispose(),h.material&&h.material.dispose()})}),this.domElement=t,this.camera=e,this.gizmo=new ix,this.add(this.gizmo),this.plane=new sx,this.add(this.plane);const i=(s,r)=>{let o=r;Object.defineProperty(this,s,{get:function(){return o!==void 0?o:r},set:function(a){o!==a&&(o=a,this.plane[s]=a,this.gizmo[s]=a,this.dispatchEvent({type:s+"-changed",value:a}),this.dispatchEvent(this.changeEvent))}}),this[s]=r,this.plane[s]=r,this.gizmo[s]=r};i("camera",this.camera),i("object",this.object),i("enabled",this.enabled),i("axis",this.axis),i("mode",this.mode),i("translationSnap",this.translationSnap),i("rotationSnap",this.rotationSnap),i("scaleSnap",this.scaleSnap),i("space",this.space),i("size",this.size),i("dragging",this.dragging),i("showX",this.showX),i("showY",this.showY),i("showZ",this.showZ),i("worldPosition",this.worldPosition),i("worldPositionStart",this.worldPositionStart),i("worldQuaternion",this.worldQuaternion),i("worldQuaternionStart",this.worldQuaternionStart),i("cameraPosition",this.cameraPosition),i("cameraQuaternion",this.cameraQuaternion),i("pointStart",this.pointStart),i("pointEnd",this.pointEnd),i("rotationAxis",this.rotationAxis),i("rotationAngle",this.rotationAngle),i("eye",this.eye),t!==void 0&&this.connect(t)}};class ix extends lt{constructor(){super(),ne(this,"isTransformControlsGizmo",!0),ne(this,"type","TransformControlsGizmo"),ne(this,"tempVector",new b(0,0,0)),ne(this,"tempEuler",new ai),ne(this,"alignVector",new b(0,1,0)),ne(this,"zeroVector",new b(0,0,0)),ne(this,"lookAtMatrix",new ce),ne(this,"tempQuaternion",new Be),ne(this,"tempQuaternion2",new Be),ne(this,"identityQuaternion",new Be),ne(this,"unitX",new b(1,0,0)),ne(this,"unitY",new b(0,1,0)),ne(this,"unitZ",new b(0,0,1)),ne(this,"gizmo"),ne(this,"picker"),ne(this,"helper"),ne(this,"rotationAxis",new b),ne(this,"cameraPosition",new b),ne(this,"worldPositionStart",new b),ne(this,"worldQuaternionStart",new Be),ne(this,"worldPosition",new b),ne(this,"worldQuaternion",new Be),ne(this,"eye",new b),ne(this,"camera",null),ne(this,"enabled",!0),ne(this,"axis",null),ne(this,"mode","translate"),ne(this,"space","world"),ne(this,"size",1),ne(this,"dragging",!1),ne(this,"showX",!0),ne(this,"showY",!0),ne(this,"showZ",!0),ne(this,"updateMatrixWorld",()=>{let N=this.space;this.mode==="scale"&&(N="local");const V=N==="local"?this.worldQuaternion:this.identityQuaternion;this.gizmo.translate.visible=this.mode==="translate",this.gizmo.rotate.visible=this.mode==="rotate",this.gizmo.scale.visible=this.mode==="scale",this.helper.translate.visible=this.mode==="translate",this.helper.rotate.visible=this.mode==="rotate",this.helper.scale.visible=this.mode==="scale";let $=[];$=$.concat(this.picker[this.mode].children),$=$.concat(this.gizmo[this.mode].children),$=$.concat(this.helper[this.mode].children);for(let Y=0;Y<$.length;Y++){const M=$[Y];M.visible=!0,M.rotation.set(0,0,0),M.position.copy(this.worldPosition);let k;if(this.camera.isOrthographicCamera?k=(this.camera.top-this.camera.bottom)/this.camera.zoom:k=this.worldPosition.distanceTo(this.cameraPosition)*Math.min(1.9*Math.tan(Math.PI*this.camera.fov/360)/this.camera.zoom,7),M.scale.set(1,1,1).multiplyScalar(k*this.size/7),M.tag==="helper"){M.visible=!1,M.name==="AXIS"?(M.position.copy(this.worldPositionStart),M.visible=!!this.axis,this.axis==="X"&&(this.tempQuaternion.setFromEuler(this.tempEuler.set(0,0,0)),M.quaternion.copy(V).multiply(this.tempQuaternion),Math.abs(this.alignVector.copy(this.unitX).applyQuaternion(V).dot(this.eye))>.9&&(M.visible=!1)),this.axis==="Y"&&(this.tempQuaternion.setFromEuler(this.tempEuler.set(0,0,Math.PI/2)),M.quaternion.copy(V).multiply(this.tempQuaternion),Math.abs(this.alignVector.copy(this.unitY).applyQuaternion(V).dot(this.eye))>.9&&(M.visible=!1)),this.axis==="Z"&&(this.tempQuaternion.setFromEuler(this.tempEuler.set(0,Math.PI/2,0)),M.quaternion.copy(V).multiply(this.tempQuaternion),Math.abs(this.alignVector.copy(this.unitZ).applyQuaternion(V).dot(this.eye))>.9&&(M.visible=!1)),this.axis==="XYZE"&&(this.tempQuaternion.setFromEuler(this.tempEuler.set(0,Math.PI/2,0)),this.alignVector.copy(this.rotationAxis),M.quaternion.setFromRotationMatrix(this.lookAtMatrix.lookAt(this.zeroVector,this.alignVector,this.unitY)),M.quaternion.multiply(this.tempQuaternion),M.visible=this.dragging),this.axis==="E"&&(M.visible=!1)):M.name==="START"?(M.position.copy(this.worldPositionStart),M.visible=this.dragging):M.name==="END"?(M.position.copy(this.worldPosition),M.visible=this.dragging):M.name==="DELTA"?(M.position.copy(this.worldPositionStart),M.quaternion.copy(this.worldQuaternionStart),this.tempVector.set(1e-10,1e-10,1e-10).add(this.worldPositionStart).sub(this.worldPosition).multiplyScalar(-1),this.tempVector.applyQuaternion(this.worldQuaternionStart.clone().invert()),M.scale.copy(this.tempVector),M.visible=this.dragging):(M.quaternion.copy(V),this.dragging?M.position.copy(this.worldPositionStart):M.position.copy(this.worldPosition),this.axis&&(M.visible=this.axis.search(M.name)!==-1));continue}M.quaternion.copy(V),this.mode==="translate"||this.mode==="scale"?((M.name==="X"||M.name==="XYZX")&&Math.abs(this.alignVector.copy(this.unitX).applyQuaternion(V).dot(this.eye))>.99&&(M.scale.set(1e-10,1e-10,1e-10),M.visible=!1),(M.name==="Y"||M.name==="XYZY")&&Math.abs(this.alignVector.copy(this.unitY).applyQuaternion(V).dot(this.eye))>.99&&(M.scale.set(1e-10,1e-10,1e-10),M.visible=!1),(M.name==="Z"||M.name==="XYZZ")&&Math.abs(this.alignVector.copy(this.unitZ).applyQuaternion(V).dot(this.eye))>.99&&(M.scale.set(1e-10,1e-10,1e-10),M.visible=!1),M.name==="XY"&&Math.abs(this.alignVector.copy(this.unitZ).applyQuaternion(V).dot(this.eye))<.2&&(M.scale.set(1e-10,1e-10,1e-10),M.visible=!1),M.name==="YZ"&&Math.abs(this.alignVector.copy(this.unitX).applyQuaternion(V).dot(this.eye))<.2&&(M.scale.set(1e-10,1e-10,1e-10),M.visible=!1),M.name==="XZ"&&Math.abs(this.alignVector.copy(this.unitY).applyQuaternion(V).dot(this.eye))<.2&&(M.scale.set(1e-10,1e-10,1e-10),M.visible=!1),M.name.search("X")!==-1&&(this.alignVector.copy(this.unitX).applyQuaternion(V).dot(this.eye)<0?M.tag==="fwd"?M.visible=!1:M.scale.x*=-1:M.tag==="bwd"&&(M.visible=!1)),M.name.search("Y")!==-1&&(this.alignVector.copy(this.unitY).applyQuaternion(V).dot(this.eye)<0?M.tag==="fwd"?M.visible=!1:M.scale.y*=-1:M.tag==="bwd"&&(M.visible=!1)),M.name.search("Z")!==-1&&(this.alignVector.copy(this.unitZ).applyQuaternion(V).dot(this.eye)<0?M.tag==="fwd"?M.visible=!1:M.scale.z*=-1:M.tag==="bwd"&&(M.visible=!1))):this.mode==="rotate"&&(this.tempQuaternion2.copy(V),this.alignVector.copy(this.eye).applyQuaternion(this.tempQuaternion.copy(V).invert()),M.name.search("E")!==-1&&M.quaternion.setFromRotationMatrix(this.lookAtMatrix.lookAt(this.eye,this.zeroVector,this.unitY)),M.name==="X"&&(this.tempQuaternion.setFromAxisAngle(this.unitX,Math.atan2(-this.alignVector.y,this.alignVector.z)),this.tempQuaternion.multiplyQuaternions(this.tempQuaternion2,this.tempQuaternion),M.quaternion.copy(this.tempQuaternion)),M.name==="Y"&&(this.tempQuaternion.setFromAxisAngle(this.unitY,Math.atan2(this.alignVector.x,this.alignVector.z)),this.tempQuaternion.multiplyQuaternions(this.tempQuaternion2,this.tempQuaternion),M.quaternion.copy(this.tempQuaternion)),M.name==="Z"&&(this.tempQuaternion.setFromAxisAngle(this.unitZ,Math.atan2(this.alignVector.y,this.alignVector.x)),this.tempQuaternion.multiplyQuaternions(this.tempQuaternion2,this.tempQuaternion),M.quaternion.copy(this.tempQuaternion))),M.visible=M.visible&&(M.name.indexOf("X")===-1||this.showX),M.visible=M.visible&&(M.name.indexOf("Y")===-1||this.showY),M.visible=M.visible&&(M.name.indexOf("Z")===-1||this.showZ),M.visible=M.visible&&(M.name.indexOf("E")===-1||this.showX&&this.showY&&this.showZ),M.material.tempOpacity=M.material.tempOpacity||M.material.opacity,M.material.tempColor=M.material.tempColor||M.material.color.clone(),M.material.color.copy(M.material.tempColor),M.material.opacity=M.material.tempOpacity,this.enabled?this.axis&&(M.name===this.axis?(M.material.opacity=1,M.material.color.lerp(new xe(1,1,1),.5)):this.axis.split("").some(function(P){return M.name===P})?(M.material.opacity=1,M.material.color.lerp(new xe(1,1,1),.5)):(M.material.opacity*=.25,M.material.color.lerp(new xe(1,1,1),.5))):(M.material.opacity*=.5,M.material.color.lerp(new xe(1,1,1),.5))}super.updateMatrixWorld()});const e=new Cs({depthTest:!1,depthWrite:!1,transparent:!0,side:Tt,fog:!1,toneMapped:!1}),t=new or({depthTest:!1,depthWrite:!1,transparent:!0,linewidth:1,fog:!1,toneMapped:!1}),i=e.clone();i.opacity=.15;const s=e.clone();s.opacity=.33;const r=e.clone();r.color.set(16711680);const o=e.clone();o.color.set(65280);const a=e.clone();a.color.set(255);const c=e.clone();c.opacity=.25;const l=c.clone();l.color.set(16776960);const u=c.clone();u.color.set(65535);const h=c.clone();h.color.set(16711935),e.clone().color.set(16776960);const d=t.clone();d.color.set(16711680);const p=t.clone();p.color.set(65280);const m=t.clone();m.color.set(255);const g=t.clone();g.color.set(65535);const y=t.clone();y.color.set(16711935);const v=t.clone();v.color.set(16776960);const E=t.clone();E.color.set(7895160);const C=v.clone();C.opacity=.25;const x=new gi(0,.05,.2,12,1,!1),I=new Ls(.125,.125,.125),S=new St;S.setAttribute("position",new Rt([0,0,0,1,0,0],3));const w=(N,V)=>{const $=new St,Y=[];for(let M=0;M<=64*V;++M)Y.push(0,Math.cos(M/32*Math.PI)*N,Math.sin(M/32*Math.PI)*N);return $.setAttribute("position",new Rt(Y,3)),$},B=()=>{const N=new St;return N.setAttribute("position",new Rt([0,0,0,1,1,1],3)),N},T={X:[[new ye(x,r),[1,0,0],[0,0,-Math.PI/2],null,"fwd"],[new ye(x,r),[1,0,0],[0,0,Math.PI/2],null,"bwd"],[new Qe(S,d)]],Y:[[new ye(x,o),[0,1,0],null,null,"fwd"],[new ye(x,o),[0,1,0],[Math.PI,0,0],null,"bwd"],[new Qe(S,p),null,[0,0,Math.PI/2]]],Z:[[new ye(x,a),[0,0,1],[Math.PI/2,0,0],null,"fwd"],[new ye(x,a),[0,0,1],[-Math.PI/2,0,0],null,"bwd"],[new Qe(S,m),null,[0,-Math.PI/2,0]]],XYZ:[[new ye(new Vs(.1,0),c.clone()),[0,0,0],[0,0,0]]],XY:[[new ye(new Ji(.295,.295),l.clone()),[.15,.15,0]],[new Qe(S,v),[.18,.3,0],null,[.125,1,1]],[new Qe(S,v),[.3,.18,0],[0,0,Math.PI/2],[.125,1,1]]],YZ:[[new ye(new Ji(.295,.295),u.clone()),[0,.15,.15],[0,Math.PI/2,0]],[new Qe(S,g),[0,.18,.3],[0,0,Math.PI/2],[.125,1,1]],[new Qe(S,g),[0,.3,.18],[0,-Math.PI/2,0],[.125,1,1]]],XZ:[[new ye(new Ji(.295,.295),h.clone()),[.15,0,.15],[-Math.PI/2,0,0]],[new Qe(S,y),[.18,0,.3],null,[.125,1,1]],[new Qe(S,y),[.3,0,.18],[0,-Math.PI/2,0],[.125,1,1]]]},R={X:[[new ye(new gi(.2,0,1,4,1,!1),i),[.6,0,0],[0,0,-Math.PI/2]]],Y:[[new ye(new gi(.2,0,1,4,1,!1),i),[0,.6,0]]],Z:[[new ye(new gi(.2,0,1,4,1,!1),i),[0,0,.6],[Math.PI/2,0,0]]],XYZ:[[new ye(new Vs(.2,0),i)]],XY:[[new ye(new Ji(.4,.4),i),[.2,.2,0]]],YZ:[[new ye(new Ji(.4,.4),i),[0,.2,.2],[0,Math.PI/2,0]]],XZ:[[new ye(new Ji(.4,.4),i),[.2,0,.2],[-Math.PI/2,0,0]]]},_={START:[[new ye(new Vs(.01,2),s),null,null,null,"helper"]],END:[[new ye(new Vs(.01,2),s),null,null,null,"helper"]],DELTA:[[new Qe(B(),s),null,null,null,"helper"]],X:[[new Qe(S,s.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new Qe(S,s.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new Qe(S,s.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},L={X:[[new Qe(w(1,.5),d)],[new ye(new Vs(.04,0),r),[0,0,.99],null,[1,3,1]]],Y:[[new Qe(w(1,.5),p),null,[0,0,-Math.PI/2]],[new ye(new Vs(.04,0),o),[0,0,.99],null,[3,1,1]]],Z:[[new Qe(w(1,.5),m),null,[0,Math.PI/2,0]],[new ye(new Vs(.04,0),a),[.99,0,0],null,[1,3,1]]],E:[[new Qe(w(1.25,1),C),null,[0,Math.PI/2,0]],[new ye(new gi(.03,0,.15,4,1,!1),C),[1.17,0,0],[0,0,-Math.PI/2],[1,1,.001]],[new ye(new gi(.03,0,.15,4,1,!1),C),[-1.17,0,0],[0,0,Math.PI/2],[1,1,.001]],[new ye(new gi(.03,0,.15,4,1,!1),C),[0,-1.17,0],[Math.PI,0,0],[1,1,.001]],[new ye(new gi(.03,0,.15,4,1,!1),C),[0,1.17,0],[0,0,0],[1,1,.001]]],XYZE:[[new Qe(w(1,1),E),null,[0,Math.PI/2,0]]]},O={AXIS:[[new Qe(S,s.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]]},U={X:[[new ye(new Ko(1,.1,4,24),i),[0,0,0],[0,-Math.PI/2,-Math.PI/2]]],Y:[[new ye(new Ko(1,.1,4,24),i),[0,0,0],[Math.PI/2,0,0]]],Z:[[new ye(new Ko(1,.1,4,24),i),[0,0,0],[0,0,-Math.PI/2]]],E:[[new ye(new Ko(1.25,.1,2,24),i)]],XYZE:[[new ye(new Xm(.7,10,8),i)]]},Q={X:[[new ye(I,r),[.8,0,0],[0,0,-Math.PI/2]],[new Qe(S,d),null,null,[.8,1,1]]],Y:[[new ye(I,o),[0,.8,0]],[new Qe(S,p),null,[0,0,Math.PI/2],[.8,1,1]]],Z:[[new ye(I,a),[0,0,.8],[Math.PI/2,0,0]],[new Qe(S,m),null,[0,-Math.PI/2,0],[.8,1,1]]],XY:[[new ye(I,l),[.85,.85,0],null,[2,2,.2]],[new Qe(S,v),[.855,.98,0],null,[.125,1,1]],[new Qe(S,v),[.98,.855,0],[0,0,Math.PI/2],[.125,1,1]]],YZ:[[new ye(I,u),[0,.85,.85],null,[.2,2,2]],[new Qe(S,g),[0,.855,.98],[0,0,Math.PI/2],[.125,1,1]],[new Qe(S,g),[0,.98,.855],[0,-Math.PI/2,0],[.125,1,1]]],XZ:[[new ye(I,h),[.85,0,.85],null,[2,.2,2]],[new Qe(S,y),[.855,0,.98],null,[.125,1,1]],[new Qe(S,y),[.98,0,.855],[0,-Math.PI/2,0],[.125,1,1]]],XYZX:[[new ye(new Ls(.125,.125,.125),c.clone()),[1.1,0,0]]],XYZY:[[new ye(new Ls(.125,.125,.125),c.clone()),[0,1.1,0]]],XYZZ:[[new ye(new Ls(.125,.125,.125),c.clone()),[0,0,1.1]]]},G={X:[[new ye(new gi(.2,0,.8,4,1,!1),i),[.5,0,0],[0,0,-Math.PI/2]]],Y:[[new ye(new gi(.2,0,.8,4,1,!1),i),[0,.5,0]]],Z:[[new ye(new gi(.2,0,.8,4,1,!1),i),[0,0,.5],[Math.PI/2,0,0]]],XY:[[new ye(I,i),[.85,.85,0],null,[3,3,.2]]],YZ:[[new ye(I,i),[0,.85,.85],null,[.2,3,3]]],XZ:[[new ye(I,i),[.85,0,.85],null,[3,.2,3]]],XYZX:[[new ye(new Ls(.2,.2,.2),i),[1.1,0,0]]],XYZY:[[new ye(new Ls(.2,.2,.2),i),[0,1.1,0]]],XYZZ:[[new ye(new Ls(.2,.2,.2),i),[0,0,1.1]]]},z={X:[[new Qe(S,s.clone()),[-1e3,0,0],null,[1e6,1,1],"helper"]],Y:[[new Qe(S,s.clone()),[0,-1e3,0],[0,0,Math.PI/2],[1e6,1,1],"helper"]],Z:[[new Qe(S,s.clone()),[0,0,-1e3],[0,-Math.PI/2,0],[1e6,1,1],"helper"]]},H=N=>{const V=new lt;for(let $ in N)for(let Y=N[$].length;Y--;){const M=N[$][Y][0].clone(),k=N[$][Y][1],P=N[$][Y][2],F=N[$][Y][3],J=N[$][Y][4];M.name=$,M.tag=J,k&&M.position.set(k[0],k[1],k[2]),P&&M.rotation.set(P[0],P[1],P[2]),F&&M.scale.set(F[0],F[1],F[2]),M.updateMatrix();const se=M.geometry.clone();se.applyMatrix4(M.matrix),M.geometry=se,M.renderOrder=1/0,M.position.set(0,0,0),M.rotation.set(0,0,0),M.scale.set(1,1,1),V.add(M)}return V};this.gizmo={},this.picker={},this.helper={},this.add(this.gizmo.translate=H(T)),this.add(this.gizmo.rotate=H(L)),this.add(this.gizmo.scale=H(Q)),this.add(this.picker.translate=H(R)),this.add(this.picker.rotate=H(U)),this.add(this.picker.scale=H(G)),this.add(this.helper.translate=H(_)),this.add(this.helper.rotate=H(O)),this.add(this.helper.scale=H(z)),this.picker.translate.visible=!1,this.picker.rotate.visible=!1,this.picker.scale.visible=!1}}class sx extends ye{constructor(){super(new Ji(1e5,1e5,2,2),new Cs({visible:!1,wireframe:!0,side:Tt,transparent:!0,opacity:.1,toneMapped:!1})),ne(this,"isTransformControlsPlane",!0),ne(this,"type","TransformControlsPlane"),ne(this,"unitX",new b(1,0,0)),ne(this,"unitY",new b(0,1,0)),ne(this,"unitZ",new b(0,0,1)),ne(this,"tempVector",new b),ne(this,"dirVector",new b),ne(this,"alignVector",new b),ne(this,"tempMatrix",new ce),ne(this,"identityQuaternion",new Be),ne(this,"cameraQuaternion",new Be),ne(this,"worldPosition",new b),ne(this,"worldQuaternion",new Be),ne(this,"eye",new b),ne(this,"axis",null),ne(this,"mode","translate"),ne(this,"space","world"),ne(this,"updateMatrixWorld",()=>{let e=this.space;switch(this.position.copy(this.worldPosition),this.mode==="scale"&&(e="local"),this.unitX.set(1,0,0).applyQuaternion(e==="local"?this.worldQuaternion:this.identityQuaternion),this.unitY.set(0,1,0).applyQuaternion(e==="local"?this.worldQuaternion:this.identityQuaternion),this.unitZ.set(0,0,1).applyQuaternion(e==="local"?this.worldQuaternion:this.identityQuaternion),this.alignVector.copy(this.unitY),this.mode){case"translate":case"scale":switch(this.axis){case"X":this.alignVector.copy(this.eye).cross(this.unitX),this.dirVector.copy(this.unitX).cross(this.alignVector);break;case"Y":this.alignVector.copy(this.eye).cross(this.unitY),this.dirVector.copy(this.unitY).cross(this.alignVector);break;case"Z":this.alignVector.copy(this.eye).cross(this.unitZ),this.dirVector.copy(this.unitZ).cross(this.alignVector);break;case"XY":this.dirVector.copy(this.unitZ);break;case"YZ":this.dirVector.copy(this.unitX);break;case"XZ":this.alignVector.copy(this.unitZ),this.dirVector.copy(this.unitY);break;case"XYZ":case"E":this.dirVector.set(0,0,0);break}break;case"rotate":default:this.dirVector.set(0,0,0)}this.dirVector.length()===0?this.quaternion.copy(this.cameraQuaternion):(this.tempMatrix.lookAt(this.tempVector.set(0,0,0),this.dirVector,this.alignVector),this.quaternion.setFromRotationMatrix(this.tempMatrix)),super.updateMatrixWorld()})}}var nx=Object.defineProperty,rx=(n,e,t)=>e in n?nx(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,yt=(n,e,t)=>(rx(n,typeof e!="symbol"?e+"":e,t),t);const Cn=new ai(0,0,0,"YXZ"),In=new b,ox={type:"change"},ax={type:"lock"},cx={type:"unlock"},Ld=Math.PI/2;let lx=class extends hn{constructor(e,t){super(),yt(this,"camera"),yt(this,"domElement"),yt(this,"isLocked"),yt(this,"minPolarAngle"),yt(this,"maxPolarAngle"),yt(this,"pointerSpeed"),yt(this,"onMouseMove",i=>{if(!this.domElement||this.isLocked===!1)return;const s=i.movementX||i.mozMovementX||i.webkitMovementX||0,r=i.movementY||i.mozMovementY||i.webkitMovementY||0;Cn.setFromQuaternion(this.camera.quaternion),Cn.y-=s*.002*this.pointerSpeed,Cn.x-=r*.002*this.pointerSpeed,Cn.x=Math.max(Ld-this.maxPolarAngle,Math.min(Ld-this.minPolarAngle,Cn.x)),this.camera.quaternion.setFromEuler(Cn),this.dispatchEvent(ox)}),yt(this,"onPointerlockChange",()=>{this.domElement&&(this.domElement.ownerDocument.pointerLockElement===this.domElement?(this.dispatchEvent(ax),this.isLocked=!0):(this.dispatchEvent(cx),this.isLocked=!1))}),yt(this,"onPointerlockError",()=>{console.error("THREE.PointerLockControls: Unable to use Pointer Lock API")}),yt(this,"connect",i=>{this.domElement=i||this.domElement,this.domElement&&(this.domElement.ownerDocument.addEventListener("mousemove",this.onMouseMove),this.domElement.ownerDocument.addEventListener("pointerlockchange",this.onPointerlockChange),this.domElement.ownerDocument.addEventListener("pointerlockerror",this.onPointerlockError))}),yt(this,"disconnect",()=>{this.domElement&&(this.domElement.ownerDocument.removeEventListener("mousemove",this.onMouseMove),this.domElement.ownerDocument.removeEventListener("pointerlockchange",this.onPointerlockChange),this.domElement.ownerDocument.removeEventListener("pointerlockerror",this.onPointerlockError))}),yt(this,"dispose",()=>{this.disconnect()}),yt(this,"getObject",()=>this.camera),yt(this,"direction",new b(0,0,-1)),yt(this,"getDirection",i=>i.copy(this.direction).applyQuaternion(this.camera.quaternion)),yt(this,"moveForward",i=>{In.setFromMatrixColumn(this.camera.matrix,0),In.crossVectors(this.camera.up,In),this.camera.position.addScaledVector(In,i)}),yt(this,"moveRight",i=>{In.setFromMatrixColumn(this.camera.matrix,0),this.camera.position.addScaledVector(In,i)}),yt(this,"lock",()=>{this.domElement&&this.domElement.requestPointerLock()}),yt(this,"unlock",()=>{this.domElement&&this.domElement.ownerDocument.exitPointerLock()}),this.camera=e,this.domElement=t,this.isLocked=!1,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.pointerSpeed=1,t&&this.connect(t)}};var ux=Object.defineProperty,hx=(n,e,t)=>e in n?ux(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,Et=(n,e,t)=>(hx(n,typeof e!="symbol"?e+"":e,t),t);let fx=class extends hn{constructor(e){super(),Et(this,"object"),Et(this,"changeEvent",{type:"change"}),Et(this,"EPS",1e-6),Et(this,"enabled",!0),Et(this,"deviceOrientation",{alpha:0,beta:0,gamma:0}),Et(this,"screenOrientation",0),Et(this,"alphaOffset",0),Et(this,"onDeviceOrientationChangeEvent",t=>{this.deviceOrientation=t}),Et(this,"onScreenOrientationChangeEvent",()=>{this.screenOrientation=window.orientation||0}),Et(this,"zee",new b(0,0,1)),Et(this,"euler",new ai),Et(this,"q0",new Be),Et(this,"q1",new Be(-Math.sqrt(.5),0,0,Math.sqrt(.5))),Et(this,"setObjectQuaternion",(t,i,s,r,o)=>{this.euler.set(s,i,-r,"YXZ"),t.setFromEuler(this.euler),t.multiply(this.q1),t.multiply(this.q0.setFromAxisAngle(this.zee,-o))}),Et(this,"connect",()=>{this.onScreenOrientationChangeEvent(),window.DeviceOrientationEvent!==void 0&&typeof window.DeviceOrientationEvent.requestPermission=="function"?window.DeviceOrientationEvent.requestPermission().then(t=>{t=="granted"&&(window.addEventListener("orientationchange",this.onScreenOrientationChangeEvent),window.addEventListener("deviceorientation",this.onDeviceOrientationChangeEvent))}).catch(t=>{console.error("THREE.DeviceOrientationControls: Unable to use DeviceOrientation API:",t)}):(window.addEventListener("orientationchange",this.onScreenOrientationChangeEvent),window.addEventListener("deviceorientation",this.onDeviceOrientationChangeEvent)),this.enabled=!0}),Et(this,"disconnect",()=>{window.removeEventListener("orientationchange",this.onScreenOrientationChangeEvent),window.removeEventListener("deviceorientation",this.onDeviceOrientationChangeEvent),this.enabled=!1}),Et(this,"lastQuaternion",new Be),Et(this,"update",()=>{if(this.enabled===!1)return;const t=this.deviceOrientation;if(t){const i=t.alpha?Ce.degToRad(t.alpha)+this.alphaOffset:0,s=t.beta?Ce.degToRad(t.beta):0,r=t.gamma?Ce.degToRad(t.gamma):0,o=this.screenOrientation?Ce.degToRad(this.screenOrientation):0;this.setObjectQuaternion(this.object.quaternion,i,s,r,o),8*(1-this.lastQuaternion.dot(this.object.quaternion))>this.EPS&&(this.lastQuaternion.copy(this.object.quaternion),this.dispatchEvent(this.changeEvent))}}),Et(this,"dispose",()=>this.disconnect()),this.object=e,this.object.rotation.reorder("YXZ"),this.connect()}};var dx=Object.defineProperty,Ax=(n,e,t)=>e in n?dx(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,Ae=(n,e,t)=>(Ax(n,typeof e!="symbol"?e+"":e,t),t);let mx=class extends hn{constructor(e,t){super(),Ae(this,"enabled",!0),Ae(this,"screen",{left:0,top:0,width:0,height:0}),Ae(this,"rotateSpeed",1),Ae(this,"zoomSpeed",1.2),Ae(this,"panSpeed",.3),Ae(this,"noRotate",!1),Ae(this,"noZoom",!1),Ae(this,"noPan",!1),Ae(this,"staticMoving",!1),Ae(this,"dynamicDampingFactor",.2),Ae(this,"minDistance",0),Ae(this,"maxDistance",1/0),Ae(this,"keys",["KeyA","KeyS","KeyD"]),Ae(this,"mouseButtons",{LEFT:qc.ROTATE,MIDDLE:qc.DOLLY,RIGHT:qc.PAN}),Ae(this,"object"),Ae(this,"domElement"),Ae(this,"cursorZoom",!1),Ae(this,"target",new b),Ae(this,"mousePosition",new de),Ae(this,"STATE",{NONE:-1,ROTATE:0,ZOOM:1,PAN:2,TOUCH_ROTATE:3,TOUCH_ZOOM_PAN:4}),Ae(this,"EPS",1e-6),Ae(this,"lastZoom",1),Ae(this,"lastPosition",new b),Ae(this,"cursorVector",new b),Ae(this,"targetVector",new b),Ae(this,"_state",this.STATE.NONE),Ae(this,"_keyState",this.STATE.NONE),Ae(this,"_eye",new b),Ae(this,"_movePrev",new de),Ae(this,"_moveCurr",new de),Ae(this,"_lastAxis",new b),Ae(this,"_lastAngle",0),Ae(this,"_zoomStart",new de),Ae(this,"_zoomEnd",new de),Ae(this,"_touchZoomDistanceStart",0),Ae(this,"_touchZoomDistanceEnd",0),Ae(this,"_panStart",new de),Ae(this,"_panEnd",new de),Ae(this,"target0"),Ae(this,"position0"),Ae(this,"up0"),Ae(this,"zoom0"),Ae(this,"changeEvent",{type:"change"}),Ae(this,"startEvent",{type:"start"}),Ae(this,"endEvent",{type:"end"}),Ae(this,"onScreenVector",new de),Ae(this,"getMouseOnScreen",(i,s)=>(this.onScreenVector.set((i-this.screen.left)/this.screen.width,(s-this.screen.top)/this.screen.height),this.onScreenVector)),Ae(this,"onCircleVector",new de),Ae(this,"getMouseOnCircle",(i,s)=>(this.onCircleVector.set((i-this.screen.width*.5-this.screen.left)/(this.screen.width*.5),(this.screen.height+2*(this.screen.top-s))/this.screen.width),this.onCircleVector)),Ae(this,"axis",new b),Ae(this,"quaternion",new Be),Ae(this,"eyeDirection",new b),Ae(this,"objectUpDirection",new b),Ae(this,"objectSidewaysDirection",new b),Ae(this,"moveDirection",new b),Ae(this,"angle",0),Ae(this,"rotateCamera",()=>{this.moveDirection.set(this._moveCurr.x-this._movePrev.x,this._moveCurr.y-this._movePrev.y,0),this.angle=this.moveDirection.length(),this.angle?(this._eye.copy(this.object.position).sub(this.target),this.eyeDirection.copy(this._eye).normalize(),this.objectUpDirection.copy(this.object.up).normalize(),this.objectSidewaysDirection.crossVectors(this.objectUpDirection,this.eyeDirection).normalize(),this.objectUpDirection.setLength(this._moveCurr.y-this._movePrev.y),this.objectSidewaysDirection.setLength(this._moveCurr.x-this._movePrev.x),this.moveDirection.copy(this.objectUpDirection.add(this.objectSidewaysDirection)),this.axis.crossVectors(this.moveDirection,this._eye).normalize(),this.angle*=this.rotateSpeed,this.quaternion.setFromAxisAngle(this.axis,this.angle),this._eye.applyQuaternion(this.quaternion),this.object.up.applyQuaternion(this.quaternion),this._lastAxis.copy(this.axis),this._lastAngle=this.angle):!this.staticMoving&&this._lastAngle&&(this._lastAngle*=Math.sqrt(1-this.dynamicDampingFactor),this._eye.copy(this.object.position).sub(this.target),this.quaternion.setFromAxisAngle(this._lastAxis,this._lastAngle),this._eye.applyQuaternion(this.quaternion),this.object.up.applyQuaternion(this.quaternion)),this._movePrev.copy(this._moveCurr)}),Ae(this,"zoomCamera",()=>{let i;if(this._state===this.STATE.TOUCH_ZOOM_PAN)i=this._touchZoomDistanceStart/this._touchZoomDistanceEnd,this._touchZoomDistanceStart=this._touchZoomDistanceEnd,this.object.isPerspectiveCamera?this._eye.multiplyScalar(i):this.object.isOrthographicCamera?(this.object.zoom/=i,this.object.updateProjectionMatrix()):console.warn("THREE.TrackballControls: Unsupported camera type");else{if(i=1+(this._zoomEnd.y-this._zoomStart.y)*this.zoomSpeed,Math.abs(i-1)>this.EPS&&i>0&&(this.object.isPerspectiveCamera?(i>1&&this._eye.length()>=this.maxDistance-this.EPS&&(i=1),this._eye.multiplyScalar(i)):this.object.isOrthographicCamera?(i>1&&this.object.zoom<this.maxDistance*this.maxDistance&&(i=1),this.object.zoom/=i):console.warn("THREE.TrackballControls: Unsupported camera type")),this.staticMoving?this._zoomStart.copy(this._zoomEnd):this._zoomStart.y+=(this._zoomEnd.y-this._zoomStart.y)*this.dynamicDampingFactor,this.cursorZoom){this.targetVector.copy(this.target).project(this.object);let s=this.cursorVector.set(this.mousePosition.x,this.mousePosition.y,this.targetVector.z).unproject(this.object);this.target.lerpVectors(s,this.target,i)}this.object.isOrthographicCamera&&this.object.updateProjectionMatrix()}}),Ae(this,"mouseChange",new de),Ae(this,"objectUp",new b),Ae(this,"pan",new b),Ae(this,"panCamera",()=>{if(this.domElement&&(this.mouseChange.copy(this._panEnd).sub(this._panStart),this.mouseChange.lengthSq()>this.EPS)){if(this.object.isOrthographicCamera){const i=this.object,s=(i.right-i.left)/this.object.zoom,r=(i.top-i.bottom)/this.object.zoom;this.mouseChange.x*=s,this.mouseChange.y*=r}else this.mouseChange.multiplyScalar(this._eye.length()*this.panSpeed);this.pan.copy(this._eye).cross(this.object.up).setLength(this.mouseChange.x),this.pan.add(this.objectUp.copy(this.object.up).setLength(this.mouseChange.y)),this.object.position.add(this.pan),this.target.add(this.pan),this.staticMoving?this._panStart.copy(this._panEnd):this._panStart.add(this.mouseChange.subVectors(this._panEnd,this._panStart).multiplyScalar(this.dynamicDampingFactor))}}),Ae(this,"checkDistances",()=>{(!this.noZoom||!this.noPan)&&(this._eye.lengthSq()>this.maxDistance*this.maxDistance&&(this.object.position.addVectors(this.target,this._eye.setLength(this.maxDistance)),this._zoomStart.copy(this._zoomEnd)),this._eye.lengthSq()<this.minDistance*this.minDistance&&(this.object.position.addVectors(this.target,this._eye.setLength(this.minDistance)),this._zoomStart.copy(this._zoomEnd)))}),Ae(this,"handleResize",()=>{if(!this.domElement)return;const i=this.domElement.getBoundingClientRect(),s=this.domElement.ownerDocument.documentElement;this.screen.left=i.left+window.pageXOffset-s.clientLeft,this.screen.top=i.top+window.pageYOffset-s.clientTop,this.screen.width=i.width,this.screen.height=i.height}),Ae(this,"update",()=>{this._eye.subVectors(this.object.position,this.target),this.noRotate||this.rotateCamera(),this.noZoom||this.zoomCamera(),this.noPan||this.panCamera(),this.object.position.addVectors(this.target,this._eye),this.object.isPerspectiveCamera?(this.checkDistances(),this.object.lookAt(this.target),this.lastPosition.distanceToSquared(this.object.position)>this.EPS&&(this.dispatchEvent(this.changeEvent),this.lastPosition.copy(this.object.position))):this.object.isOrthographicCamera?(this.object.lookAt(this.target),(this.lastPosition.distanceToSquared(this.object.position)>this.EPS||this.lastZoom!==this.object.zoom)&&(this.dispatchEvent(this.changeEvent),this.lastPosition.copy(this.object.position),this.lastZoom=this.object.zoom)):console.warn("THREE.TrackballControls: Unsupported camera type")}),Ae(this,"reset",()=>{this._state=this.STATE.NONE,this._keyState=this.STATE.NONE,this.target.copy(this.target0),this.object.position.copy(this.position0),this.object.up.copy(this.up0),this.object.zoom=this.zoom0,this.object.updateProjectionMatrix(),this._eye.subVectors(this.object.position,this.target),this.object.lookAt(this.target),this.dispatchEvent(this.changeEvent),this.lastPosition.copy(this.object.position),this.lastZoom=this.object.zoom}),Ae(this,"keydown",i=>{this.enabled!==!1&&(window.removeEventListener("keydown",this.keydown),this._keyState===this.STATE.NONE&&(i.code===this.keys[this.STATE.ROTATE]&&!this.noRotate?this._keyState=this.STATE.ROTATE:i.code===this.keys[this.STATE.ZOOM]&&!this.noZoom?this._keyState=this.STATE.ZOOM:i.code===this.keys[this.STATE.PAN]&&!this.noPan&&(this._keyState=this.STATE.PAN)))}),Ae(this,"onPointerDown",i=>{if(this.enabled!==!1)switch(i.pointerType){case"mouse":case"pen":this.onMouseDown(i);break}}),Ae(this,"onPointerMove",i=>{if(this.enabled!==!1)switch(i.pointerType){case"mouse":case"pen":this.onMouseMove(i);break}}),Ae(this,"onPointerUp",i=>{if(this.enabled!==!1)switch(i.pointerType){case"mouse":case"pen":this.onMouseUp();break}}),Ae(this,"keyup",()=>{this.enabled!==!1&&(this._keyState=this.STATE.NONE,window.addEventListener("keydown",this.keydown))}),Ae(this,"onMouseDown",i=>{if(!this.domElement)return;if(this._state===this.STATE.NONE)switch(i.button){case this.mouseButtons.LEFT:this._state=this.STATE.ROTATE;break;case this.mouseButtons.MIDDLE:this._state=this.STATE.ZOOM;break;case this.mouseButtons.RIGHT:this._state=this.STATE.PAN;break}const s=this._keyState!==this.STATE.NONE?this._keyState:this._state;s===this.STATE.ROTATE&&!this.noRotate?(this._moveCurr.copy(this.getMouseOnCircle(i.pageX,i.pageY)),this._movePrev.copy(this._moveCurr)):s===this.STATE.ZOOM&&!this.noZoom?(this._zoomStart.copy(this.getMouseOnScreen(i.pageX,i.pageY)),this._zoomEnd.copy(this._zoomStart)):s===this.STATE.PAN&&!this.noPan&&(this._panStart.copy(this.getMouseOnScreen(i.pageX,i.pageY)),this._panEnd.copy(this._panStart)),this.domElement.ownerDocument.addEventListener("pointermove",this.onPointerMove),this.domElement.ownerDocument.addEventListener("pointerup",this.onPointerUp),this.dispatchEvent(this.startEvent)}),Ae(this,"onMouseMove",i=>{if(this.enabled===!1)return;const s=this._keyState!==this.STATE.NONE?this._keyState:this._state;s===this.STATE.ROTATE&&!this.noRotate?(this._movePrev.copy(this._moveCurr),this._moveCurr.copy(this.getMouseOnCircle(i.pageX,i.pageY))):s===this.STATE.ZOOM&&!this.noZoom?this._zoomEnd.copy(this.getMouseOnScreen(i.pageX,i.pageY)):s===this.STATE.PAN&&!this.noPan&&this._panEnd.copy(this.getMouseOnScreen(i.pageX,i.pageY))}),Ae(this,"onMouseUp",()=>{this.domElement&&this.enabled!==!1&&(this._state=this.STATE.NONE,this.domElement.ownerDocument.removeEventListener("pointermove",this.onPointerMove),this.domElement.ownerDocument.removeEventListener("pointerup",this.onPointerUp),this.dispatchEvent(this.endEvent))}),Ae(this,"mousewheel",i=>{if(this.enabled!==!1&&this.noZoom!==!0){switch(i.preventDefault(),i.deltaMode){case 2:this._zoomStart.y-=i.deltaY*.025;break;case 1:this._zoomStart.y-=i.deltaY*.01;break;default:this._zoomStart.y-=i.deltaY*25e-5;break}this.mousePosition.x=i.offsetX/this.screen.width*2-1,this.mousePosition.y=-(i.offsetY/this.screen.height)*2+1,this.dispatchEvent(this.startEvent),this.dispatchEvent(this.endEvent)}}),Ae(this,"touchstart",i=>{if(this.enabled!==!1){switch(i.preventDefault(),i.touches.length){case 1:this._state=this.STATE.TOUCH_ROTATE,this._moveCurr.copy(this.getMouseOnCircle(i.touches[0].pageX,i.touches[0].pageY)),this._movePrev.copy(this._moveCurr);break;default:this._state=this.STATE.TOUCH_ZOOM_PAN;const s=i.touches[0].pageX-i.touches[1].pageX,r=i.touches[0].pageY-i.touches[1].pageY;this._touchZoomDistanceEnd=this._touchZoomDistanceStart=Math.sqrt(s*s+r*r);const o=(i.touches[0].pageX+i.touches[1].pageX)/2,a=(i.touches[0].pageY+i.touches[1].pageY)/2;this._panStart.copy(this.getMouseOnScreen(o,a)),this._panEnd.copy(this._panStart);break}this.dispatchEvent(this.startEvent)}}),Ae(this,"touchmove",i=>{if(this.enabled!==!1)switch(i.preventDefault(),i.touches.length){case 1:this._movePrev.copy(this._moveCurr),this._moveCurr.copy(this.getMouseOnCircle(i.touches[0].pageX,i.touches[0].pageY));break;default:const s=i.touches[0].pageX-i.touches[1].pageX,r=i.touches[0].pageY-i.touches[1].pageY;this._touchZoomDistanceEnd=Math.sqrt(s*s+r*r);const o=(i.touches[0].pageX+i.touches[1].pageX)/2,a=(i.touches[0].pageY+i.touches[1].pageY)/2;this._panEnd.copy(this.getMouseOnScreen(o,a));break}}),Ae(this,"touchend",i=>{if(this.enabled!==!1){switch(i.touches.length){case 0:this._state=this.STATE.NONE;break;case 1:this._state=this.STATE.TOUCH_ROTATE,this._moveCurr.copy(this.getMouseOnCircle(i.touches[0].pageX,i.touches[0].pageY)),this._movePrev.copy(this._moveCurr);break}this.dispatchEvent(this.endEvent)}}),Ae(this,"contextmenu",i=>{this.enabled!==!1&&i.preventDefault()}),Ae(this,"connect",i=>{i===document&&console.error('THREE.OrbitControls: "document" should not be used as the target "domElement". Please use "renderer.domElement" instead.'),this.domElement=i,this.domElement.addEventListener("contextmenu",this.contextmenu),this.domElement.addEventListener("pointerdown",this.onPointerDown),this.domElement.addEventListener("wheel",this.mousewheel),this.domElement.addEventListener("touchstart",this.touchstart),this.domElement.addEventListener("touchend",this.touchend),this.domElement.addEventListener("touchmove",this.touchmove),this.domElement.ownerDocument.addEventListener("pointermove",this.onPointerMove),this.domElement.ownerDocument.addEventListener("pointerup",this.onPointerUp),window.addEventListener("keydown",this.keydown),window.addEventListener("keyup",this.keyup),this.handleResize()}),Ae(this,"dispose",()=>{this.domElement&&(this.domElement.removeEventListener("contextmenu",this.contextmenu),this.domElement.removeEventListener("pointerdown",this.onPointerDown),this.domElement.removeEventListener("wheel",this.mousewheel),this.domElement.removeEventListener("touchstart",this.touchstart),this.domElement.removeEventListener("touchend",this.touchend),this.domElement.removeEventListener("touchmove",this.touchmove),this.domElement.ownerDocument.removeEventListener("pointermove",this.onPointerMove),this.domElement.ownerDocument.removeEventListener("pointerup",this.onPointerUp),window.removeEventListener("keydown",this.keydown),window.removeEventListener("keyup",this.keyup))}),this.object=e,this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.up0=this.object.up.clone(),this.zoom0=this.object.zoom,t!==void 0&&this.connect(t),this.update()}};var px=Object.defineProperty,gx=(n,e,t)=>e in n?px(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,ee=(n,e,t)=>(gx(n,typeof e!="symbol"?e+"":e,t),t);const Ie={IDLE:Symbol(),ROTATE:Symbol(),PAN:Symbol(),SCALE:Symbol(),FOV:Symbol(),FOCUS:Symbol(),ZROTATE:Symbol(),TOUCH_MULTI:Symbol(),ANIMATION_FOCUS:Symbol(),ANIMATION_ROTATE:Symbol()},Ve={NONE:Symbol(),ONE_FINGER:Symbol(),ONE_FINGER_SWITCHED:Symbol(),TWO_FINGER:Symbol(),MULT_FINGER:Symbol(),CURSOR:Symbol()},Pe={x:0,y:0},oi={camera:new ce,gizmos:new ce},et={type:"change"},Pi={type:"start"},di={type:"end"};let yx=class extends hn{constructor(e,t=null,i=null){super(),ee(this,"camera"),ee(this,"domElement"),ee(this,"scene"),ee(this,"mouseActions"),ee(this,"_mouseOp"),ee(this,"_v2_1"),ee(this,"_v3_1"),ee(this,"_v3_2"),ee(this,"_m4_1"),ee(this,"_m4_2"),ee(this,"_quat"),ee(this,"_translationMatrix"),ee(this,"_rotationMatrix"),ee(this,"_scaleMatrix"),ee(this,"_rotationAxis"),ee(this,"_cameraMatrixState"),ee(this,"_cameraProjectionState"),ee(this,"_fovState"),ee(this,"_upState"),ee(this,"_zoomState"),ee(this,"_nearPos"),ee(this,"_farPos"),ee(this,"_gizmoMatrixState"),ee(this,"_up0"),ee(this,"_zoom0"),ee(this,"_fov0"),ee(this,"_initialNear"),ee(this,"_nearPos0"),ee(this,"_initialFar"),ee(this,"_farPos0"),ee(this,"_cameraMatrixState0"),ee(this,"_gizmoMatrixState0"),ee(this,"_button"),ee(this,"_touchStart"),ee(this,"_touchCurrent"),ee(this,"_input"),ee(this,"_switchSensibility"),ee(this,"_startFingerDistance"),ee(this,"_currentFingerDistance"),ee(this,"_startFingerRotation"),ee(this,"_currentFingerRotation"),ee(this,"_devPxRatio"),ee(this,"_downValid"),ee(this,"_nclicks"),ee(this,"_downEvents"),ee(this,"_clickStart"),ee(this,"_maxDownTime"),ee(this,"_maxInterval"),ee(this,"_posThreshold"),ee(this,"_movementThreshold"),ee(this,"_currentCursorPosition"),ee(this,"_startCursorPosition"),ee(this,"_grid"),ee(this,"_gridPosition"),ee(this,"_gizmos"),ee(this,"_curvePts"),ee(this,"_timeStart"),ee(this,"_animationId"),ee(this,"focusAnimationTime"),ee(this,"_timePrev"),ee(this,"_timeCurrent"),ee(this,"_anglePrev"),ee(this,"_angleCurrent"),ee(this,"_cursorPosPrev"),ee(this,"_cursorPosCurr"),ee(this,"_wPrev"),ee(this,"_wCurr"),ee(this,"adjustNearFar"),ee(this,"scaleFactor"),ee(this,"dampingFactor"),ee(this,"wMax"),ee(this,"enableAnimations"),ee(this,"enableGrid"),ee(this,"cursorZoom"),ee(this,"minFov"),ee(this,"maxFov"),ee(this,"enabled"),ee(this,"enablePan"),ee(this,"enableRotate"),ee(this,"enableZoom"),ee(this,"minDistance"),ee(this,"maxDistance"),ee(this,"minZoom"),ee(this,"maxZoom"),ee(this,"target"),ee(this,"_currentTarget"),ee(this,"_tbRadius"),ee(this,"_state"),ee(this,"onWindowResize",()=>{const s=(this._gizmos.scale.x+this._gizmos.scale.y+this._gizmos.scale.z)/3;if(this.camera){const l=this.calculateTbRadius(this.camera);l!==void 0&&(this._tbRadius=l)}const r=this._tbRadius/s,a=new Xc(0,0,r,r).getPoints(this._curvePts),c=new St().setFromPoints(a);for(const l in this._gizmos.children){const u=this._gizmos.children[l];u.geometry=c}this.dispatchEvent(et)}),ee(this,"onContextMenu",s=>{if(this.enabled){for(let r=0;r<this.mouseActions.length;r++)if(this.mouseActions[r].mouse==2){s.preventDefault();break}}}),ee(this,"onPointerCancel",()=>{this._touchStart.splice(0,this._touchStart.length),this._touchCurrent.splice(0,this._touchCurrent.length),this._input=Ve.NONE}),ee(this,"onPointerDown",s=>{if(s.button==0&&s.isPrimary?(this._downValid=!0,this._downEvents.push(s)):this._downValid=!1,s.pointerType=="touch"&&this._input!=Ve.CURSOR)switch(this._touchStart.push(s),this._touchCurrent.push(s),this._input){case Ve.NONE:this._input=Ve.ONE_FINGER,this.onSinglePanStart(s,"ROTATE"),window.addEventListener("pointermove",this.onPointerMove),window.addEventListener("pointerup",this.onPointerUp);break;case Ve.ONE_FINGER:case Ve.ONE_FINGER_SWITCHED:this._input=Ve.TWO_FINGER,this.onRotateStart(),this.onPinchStart(),this.onDoublePanStart();break;case Ve.TWO_FINGER:this._input=Ve.MULT_FINGER,this.onTriplePanStart();break}else if(s.pointerType!="touch"&&this._input==Ve.NONE){let r=null;s.ctrlKey||s.metaKey?r="CTRL":s.shiftKey&&(r="SHIFT"),this._mouseOp=this.getOpFromAction(s.button,r),this._mouseOp&&(window.addEventListener("pointermove",this.onPointerMove),window.addEventListener("pointerup",this.onPointerUp),this._input=Ve.CURSOR,this._button=s.button,this.onSinglePanStart(s,this._mouseOp))}}),ee(this,"onPointerMove",s=>{if(s.pointerType=="touch"&&this._input!=Ve.CURSOR)switch(this._input){case Ve.ONE_FINGER:this.updateTouchEvent(s),this.onSinglePanMove(s,Ie.ROTATE);break;case Ve.ONE_FINGER_SWITCHED:if(this.calculatePointersDistance(this._touchCurrent[0],s)*this._devPxRatio>=this._switchSensibility){this._input=Ve.ONE_FINGER,this.updateTouchEvent(s),this.onSinglePanStart(s,"ROTATE");break}break;case Ve.TWO_FINGER:this.updateTouchEvent(s),this.onRotateMove(),this.onPinchMove(),this.onDoublePanMove();break;case Ve.MULT_FINGER:this.updateTouchEvent(s),this.onTriplePanMove();break}else if(s.pointerType!="touch"&&this._input==Ve.CURSOR){let r=null;s.ctrlKey||s.metaKey?r="CTRL":s.shiftKey&&(r="SHIFT");const o=this.getOpStateFromAction(this._button,r);o&&this.onSinglePanMove(s,o)}this._downValid&&this.calculatePointersDistance(this._downEvents[this._downEvents.length-1],s)*this._devPxRatio>this._movementThreshold&&(this._downValid=!1)}),ee(this,"onPointerUp",s=>{if(s.pointerType=="touch"&&this._input!=Ve.CURSOR){const r=this._touchCurrent.length;for(let o=0;o<r;o++)if(this._touchCurrent[o].pointerId==s.pointerId){this._touchCurrent.splice(o,1),this._touchStart.splice(o,1);break}switch(this._input){case Ve.ONE_FINGER:case Ve.ONE_FINGER_SWITCHED:window.removeEventListener("pointermove",this.onPointerMove),window.removeEventListener("pointerup",this.onPointerUp),this._input=Ve.NONE,this.onSinglePanEnd();break;case Ve.TWO_FINGER:this.onDoublePanEnd(),this.onPinchEnd(),this.onRotateEnd(),this._input=Ve.ONE_FINGER_SWITCHED;break;case Ve.MULT_FINGER:this._touchCurrent.length==0&&(window.removeEventListener("pointermove",this.onPointerMove),window.removeEventListener("pointerup",this.onPointerUp),this._input=Ve.NONE,this.onTriplePanEnd());break}}else s.pointerType!="touch"&&this._input==Ve.CURSOR&&(window.removeEventListener("pointermove",this.onPointerMove),window.removeEventListener("pointerup",this.onPointerUp),this._input=Ve.NONE,this.onSinglePanEnd(),this._button=-1);if(s.isPrimary)if(this._downValid)if(s.timeStamp-this._downEvents[this._downEvents.length-1].timeStamp<=this._maxDownTime)if(this._nclicks==0)this._nclicks=1,this._clickStart=performance.now();else{const o=s.timeStamp-this._clickStart,a=this.calculatePointersDistance(this._downEvents[1],this._downEvents[0])*this._devPxRatio;o<=this._maxInterval&&a<=this._posThreshold?(this._nclicks=0,this._downEvents.splice(0,this._downEvents.length),this.onDoubleTap(s)):(this._nclicks=1,this._downEvents.shift(),this._clickStart=performance.now())}else this._downValid=!1,this._nclicks=0,this._downEvents.splice(0,this._downEvents.length);else this._nclicks=0,this._downEvents.splice(0,this._downEvents.length)}),ee(this,"onWheel",s=>{var r,o;if(this.enabled&&this.enableZoom&&this.domElement){let a=null;s.ctrlKey||s.metaKey?a="CTRL":s.shiftKey&&(a="SHIFT");const c=this.getOpFromAction("WHEEL",a);if(c){s.preventDefault(),this.dispatchEvent(Pi);const l=125;let u=s.deltaY/l,h=1;switch(u>0?h=1/this.scaleFactor:u<0&&(h=this.scaleFactor),c){case"ZOOM":if(this.updateTbState(Ie.SCALE,!0),u>0?h=1/Math.pow(this.scaleFactor,u):u<0&&(h=Math.pow(this.scaleFactor,-u)),this.cursorZoom&&this.enablePan){let f;this.camera instanceof vt&&(f=(r=this.unprojectOnTbPlane(this.camera,s.clientX,s.clientY,this.domElement))==null?void 0:r.applyQuaternion(this.camera.quaternion).multiplyScalar(1/this.camera.zoom).add(this._gizmos.position)),this.camera instanceof nt&&(f=(o=this.unprojectOnTbPlane(this.camera,s.clientX,s.clientY,this.domElement))==null?void 0:o.applyQuaternion(this.camera.quaternion).add(this._gizmos.position)),f!==void 0&&this.applyTransformMatrix(this.applyScale(h,f))}else this.applyTransformMatrix(this.applyScale(h,this._gizmos.position));this._grid&&(this.disposeGrid(),this.drawGrid()),this.updateTbState(Ie.IDLE,!1),this.dispatchEvent(et),this.dispatchEvent(di);break;case"FOV":if(this.camera instanceof nt){this.updateTbState(Ie.FOV,!0),s.deltaX!=0&&(u=s.deltaX/l,h=1,u>0?h=1/Math.pow(this.scaleFactor,u):u<0&&(h=Math.pow(this.scaleFactor,-u))),this._v3_1.setFromMatrixPosition(this._cameraMatrixState);const f=this._v3_1.distanceTo(this._gizmos.position);let d=f/h;d=Ce.clamp(d,this.minDistance,this.maxDistance);const p=f*Math.tan(Ce.DEG2RAD*this.camera.fov*.5);let m=Ce.RAD2DEG*(Math.atan(p/d)*2);m>this.maxFov?m=this.maxFov:m<this.minFov&&(m=this.minFov);const g=p/Math.tan(Ce.DEG2RAD*(m/2));h=f/g,this.setFov(m),this.applyTransformMatrix(this.applyScale(h,this._gizmos.position,!1))}this._grid&&(this.disposeGrid(),this.drawGrid()),this.updateTbState(Ie.IDLE,!1),this.dispatchEvent(et),this.dispatchEvent(di);break}}}}),ee(this,"onSinglePanStart",(s,r)=>{if(this.enabled&&this.domElement)switch(this.dispatchEvent(Pi),this.setCenter(s.clientX,s.clientY),r){case"PAN":if(!this.enablePan)return;if(this._animationId!=-1&&(cancelAnimationFrame(this._animationId),this._animationId=-1,this._timeStart=-1,this.activateGizmos(!1),this.dispatchEvent(et)),this.camera){this.updateTbState(Ie.PAN,!0);const o=this.unprojectOnTbPlane(this.camera,Pe.x,Pe.y,this.domElement);o!==void 0&&this._startCursorPosition.copy(o),this.enableGrid&&(this.drawGrid(),this.dispatchEvent(et))}break;case"ROTATE":if(!this.enableRotate)return;if(this._animationId!=-1&&(cancelAnimationFrame(this._animationId),this._animationId=-1,this._timeStart=-1),this.camera){this.updateTbState(Ie.ROTATE,!0);const o=this.unprojectOnTbSurface(this.camera,Pe.x,Pe.y,this.domElement,this._tbRadius);o!==void 0&&this._startCursorPosition.copy(o),this.activateGizmos(!0),this.enableAnimations&&(this._timePrev=this._timeCurrent=performance.now(),this._angleCurrent=this._anglePrev=0,this._cursorPosPrev.copy(this._startCursorPosition),this._cursorPosCurr.copy(this._cursorPosPrev),this._wCurr=0,this._wPrev=this._wCurr)}this.dispatchEvent(et);break;case"FOV":if(!this.enableZoom)return;this.camera instanceof nt&&(this._animationId!=-1&&(cancelAnimationFrame(this._animationId),this._animationId=-1,this._timeStart=-1,this.activateGizmos(!1),this.dispatchEvent(et)),this.updateTbState(Ie.FOV,!0),this._startCursorPosition.setY(this.getCursorNDC(Pe.x,Pe.y,this.domElement).y*.5),this._currentCursorPosition.copy(this._startCursorPosition));break;case"ZOOM":if(!this.enableZoom)return;this._animationId!=-1&&(cancelAnimationFrame(this._animationId),this._animationId=-1,this._timeStart=-1,this.activateGizmos(!1),this.dispatchEvent(et)),this.updateTbState(Ie.SCALE,!0),this._startCursorPosition.setY(this.getCursorNDC(Pe.x,Pe.y,this.domElement).y*.5),this._currentCursorPosition.copy(this._startCursorPosition);break}}),ee(this,"onSinglePanMove",(s,r)=>{if(this.enabled&&this.domElement){const o=r!=this._state;switch(this.setCenter(s.clientX,s.clientY),r){case Ie.PAN:if(this.enablePan&&this.camera)if(o){this.dispatchEvent(di),this.dispatchEvent(Pi),this.updateTbState(r,!0);const a=this.unprojectOnTbPlane(this.camera,Pe.x,Pe.y,this.domElement);a!==void 0&&this._startCursorPosition.copy(a),this.enableGrid&&this.drawGrid(),this.activateGizmos(!1)}else{const a=this.unprojectOnTbPlane(this.camera,Pe.x,Pe.y,this.domElement);a!==void 0&&this._currentCursorPosition.copy(a),this.applyTransformMatrix(this.pan(this._startCursorPosition,this._currentCursorPosition))}break;case Ie.ROTATE:if(this.enableRotate&&this.camera)if(o){this.dispatchEvent(di),this.dispatchEvent(Pi),this.updateTbState(r,!0);const a=this.unprojectOnTbSurface(this.camera,Pe.x,Pe.y,this.domElement,this._tbRadius);a!==void 0&&this._startCursorPosition.copy(a),this.enableGrid&&this.disposeGrid(),this.activateGizmos(!0)}else{const a=this.unprojectOnTbSurface(this.camera,Pe.x,Pe.y,this.domElement,this._tbRadius);a!==void 0&&this._currentCursorPosition.copy(a);const c=this._startCursorPosition.distanceTo(this._currentCursorPosition),l=this._startCursorPosition.angleTo(this._currentCursorPosition),u=Math.max(c/this._tbRadius,l);this.applyTransformMatrix(this.rotate(this.calculateRotationAxis(this._startCursorPosition,this._currentCursorPosition),u)),this.enableAnimations&&(this._timePrev=this._timeCurrent,this._timeCurrent=performance.now(),this._anglePrev=this._angleCurrent,this._angleCurrent=u,this._cursorPosPrev.copy(this._cursorPosCurr),this._cursorPosCurr.copy(this._currentCursorPosition),this._wPrev=this._wCurr,this._wCurr=this.calculateAngularSpeed(this._anglePrev,this._angleCurrent,this._timePrev,this._timeCurrent))}break;case Ie.SCALE:if(this.enableZoom)if(o)this.dispatchEvent(di),this.dispatchEvent(Pi),this.updateTbState(r,!0),this._startCursorPosition.setY(this.getCursorNDC(Pe.x,Pe.y,this.domElement).y*.5),this._currentCursorPosition.copy(this._startCursorPosition),this.enableGrid&&this.disposeGrid(),this.activateGizmos(!1);else{this._currentCursorPosition.setY(this.getCursorNDC(Pe.x,Pe.y,this.domElement).y*.5);const c=this._currentCursorPosition.y-this._startCursorPosition.y;let l=1;c<0?l=1/Math.pow(this.scaleFactor,-c*8):c>0&&(l=Math.pow(this.scaleFactor,c*8)),this.applyTransformMatrix(this.applyScale(l,this._gizmos.position))}break;case Ie.FOV:if(this.enableZoom&&this.camera instanceof nt)if(o)this.dispatchEvent(di),this.dispatchEvent(Pi),this.updateTbState(r,!0),this._startCursorPosition.setY(this.getCursorNDC(Pe.x,Pe.y,this.domElement).y*.5),this._currentCursorPosition.copy(this._startCursorPosition),this.enableGrid&&this.disposeGrid(),this.activateGizmos(!1);else{this._currentCursorPosition.setY(this.getCursorNDC(Pe.x,Pe.y,this.domElement).y*.5);const c=this._currentCursorPosition.y-this._startCursorPosition.y;let l=1;c<0?l=1/Math.pow(this.scaleFactor,-c*8):c>0&&(l=Math.pow(this.scaleFactor,c*8)),this._v3_1.setFromMatrixPosition(this._cameraMatrixState);const u=this._v3_1.distanceTo(this._gizmos.position);let h=u/l;h=Ce.clamp(h,this.minDistance,this.maxDistance);const f=u*Math.tan(Ce.DEG2RAD*this._fovState*.5);let d=Ce.RAD2DEG*(Math.atan(f/h)*2);d=Ce.clamp(d,this.minFov,this.maxFov);const p=f/Math.tan(Ce.DEG2RAD*(d/2));l=u/p,this._v3_2.setFromMatrixPosition(this._gizmoMatrixState),this.setFov(d),this.applyTransformMatrix(this.applyScale(l,this._v3_2,!1));const m=this._gizmos.position.clone().sub(this.camera.position).normalize().multiplyScalar(p/u);this._m4_1.makeTranslation(m.x,m.y,m.z)}break}this.dispatchEvent(et)}}),ee(this,"onSinglePanEnd",()=>{if(this._state==Ie.ROTATE){if(!this.enableRotate)return;if(this.enableAnimations)if(performance.now()-this._timeCurrent<120){const r=Math.abs((this._wPrev+this._wCurr)/2),o=this;this._animationId=window.requestAnimationFrame(function(a){o.updateTbState(Ie.ANIMATION_ROTATE,!0);const c=o.calculateRotationAxis(o._cursorPosPrev,o._cursorPosCurr);o.onRotationAnim(a,c,Math.min(r,o.wMax))})}else this.updateTbState(Ie.IDLE,!1),this.activateGizmos(!1),this.dispatchEvent(et);else this.updateTbState(Ie.IDLE,!1),this.activateGizmos(!1),this.dispatchEvent(et)}else(this._state==Ie.PAN||this._state==Ie.IDLE)&&(this.updateTbState(Ie.IDLE,!1),this.enableGrid&&this.disposeGrid(),this.activateGizmos(!1),this.dispatchEvent(et));this.dispatchEvent(di)}),ee(this,"onDoubleTap",s=>{if(this.enabled&&this.enablePan&&this.scene&&this.camera&&this.domElement){this.dispatchEvent(Pi),this.setCenter(s.clientX,s.clientY);const r=this.unprojectOnObj(this.getCursorNDC(Pe.x,Pe.y,this.domElement),this.camera);if(r&&this.enableAnimations){const o=this;this._animationId!=-1&&window.cancelAnimationFrame(this._animationId),this._timeStart=-1,this._animationId=window.requestAnimationFrame(function(a){o.updateTbState(Ie.ANIMATION_FOCUS,!0),o.onFocusAnim(a,r,o._cameraMatrixState,o._gizmoMatrixState)})}else r&&!this.enableAnimations&&(this.updateTbState(Ie.FOCUS,!0),this.focus(r,this.scaleFactor),this.updateTbState(Ie.IDLE,!1),this.dispatchEvent(et))}this.dispatchEvent(di)}),ee(this,"onDoublePanStart",()=>{if(this.enabled&&this.enablePan&&this.camera&&this.domElement){this.dispatchEvent(Pi),this.updateTbState(Ie.PAN,!0),this.setCenter((this._touchCurrent[0].clientX+this._touchCurrent[1].clientX)/2,(this._touchCurrent[0].clientY+this._touchCurrent[1].clientY)/2);const s=this.unprojectOnTbPlane(this.camera,Pe.x,Pe.y,this.domElement,!0);s!==void 0&&this._startCursorPosition.copy(s),this._currentCursorPosition.copy(this._startCursorPosition),this.activateGizmos(!1)}}),ee(this,"onDoublePanMove",()=>{if(this.enabled&&this.enablePan&&this.camera&&this.domElement){this.setCenter((this._touchCurrent[0].clientX+this._touchCurrent[1].clientX)/2,(this._touchCurrent[0].clientY+this._touchCurrent[1].clientY)/2),this._state!=Ie.PAN&&(this.updateTbState(Ie.PAN,!0),this._startCursorPosition.copy(this._currentCursorPosition));const s=this.unprojectOnTbPlane(this.camera,Pe.x,Pe.y,this.domElement,!0);s!==void 0&&this._currentCursorPosition.copy(s),this.applyTransformMatrix(this.pan(this._startCursorPosition,this._currentCursorPosition,!0)),this.dispatchEvent(et)}}),ee(this,"onDoublePanEnd",()=>{this.updateTbState(Ie.IDLE,!1),this.dispatchEvent(di)}),ee(this,"onRotateStart",()=>{var s;this.enabled&&this.enableRotate&&(this.dispatchEvent(Pi),this.updateTbState(Ie.ZROTATE,!0),this._startFingerRotation=this.getAngle(this._touchCurrent[1],this._touchCurrent[0])+this.getAngle(this._touchStart[1],this._touchStart[0]),this._currentFingerRotation=this._startFingerRotation,(s=this.camera)==null||s.getWorldDirection(this._rotationAxis),!this.enablePan&&!this.enableZoom&&this.activateGizmos(!0))}),ee(this,"onRotateMove",()=>{var s;if(this.enabled&&this.enableRotate&&this.camera&&this.domElement){this.setCenter((this._touchCurrent[0].clientX+this._touchCurrent[1].clientX)/2,(this._touchCurrent[0].clientY+this._touchCurrent[1].clientY)/2);let r;this._state!=Ie.ZROTATE&&(this.updateTbState(Ie.ZROTATE,!0),this._startFingerRotation=this._currentFingerRotation),this._currentFingerRotation=this.getAngle(this._touchCurrent[1],this._touchCurrent[0])+this.getAngle(this._touchStart[1],this._touchStart[0]),this.enablePan?this.camera&&(this._v3_2.setFromMatrixPosition(this._gizmoMatrixState),r=(s=this.unprojectOnTbPlane(this.camera,Pe.x,Pe.y,this.domElement))==null?void 0:s.applyQuaternion(this.camera.quaternion).multiplyScalar(1/this.camera.zoom).add(this._v3_2)):r=new b().setFromMatrixPosition(this._gizmoMatrixState);const o=Ce.DEG2RAD*(this._startFingerRotation-this._currentFingerRotation);r!==void 0&&this.applyTransformMatrix(this.zRotate(r,o)),this.dispatchEvent(et)}}),ee(this,"onRotateEnd",()=>{this.updateTbState(Ie.IDLE,!1),this.activateGizmos(!1),this.dispatchEvent(di)}),ee(this,"onPinchStart",()=>{this.enabled&&this.enableZoom&&(this.dispatchEvent(Pi),this.updateTbState(Ie.SCALE,!0),this._startFingerDistance=this.calculatePointersDistance(this._touchCurrent[0],this._touchCurrent[1]),this._currentFingerDistance=this._startFingerDistance,this.activateGizmos(!1))}),ee(this,"onPinchMove",()=>{var s,r;if(this.enabled&&this.enableZoom&&this.domElement){this.setCenter((this._touchCurrent[0].clientX+this._touchCurrent[1].clientX)/2,(this._touchCurrent[0].clientY+this._touchCurrent[1].clientY)/2);const o=12;this._state!=Ie.SCALE&&(this._startFingerDistance=this._currentFingerDistance,this.updateTbState(Ie.SCALE,!0)),this._currentFingerDistance=Math.max(this.calculatePointersDistance(this._touchCurrent[0],this._touchCurrent[1]),o*this._devPxRatio);const a=this._currentFingerDistance/this._startFingerDistance;let c;this.enablePan?this.camera instanceof vt?c=(s=this.unprojectOnTbPlane(this.camera,Pe.x,Pe.y,this.domElement))==null?void 0:s.applyQuaternion(this.camera.quaternion).multiplyScalar(1/this.camera.zoom).add(this._gizmos.position):this.camera instanceof nt&&(c=(r=this.unprojectOnTbPlane(this.camera,Pe.x,Pe.y,this.domElement))==null?void 0:r.applyQuaternion(this.camera.quaternion).add(this._gizmos.position)):c=this._gizmos.position,c!==void 0&&this.applyTransformMatrix(this.applyScale(a,c)),this.dispatchEvent(et)}}),ee(this,"onPinchEnd",()=>{this.updateTbState(Ie.IDLE,!1),this.dispatchEvent(di)}),ee(this,"onTriplePanStart",()=>{if(this.enabled&&this.enableZoom&&this.domElement){this.dispatchEvent(Pi),this.updateTbState(Ie.SCALE,!0);let s=0,r=0;const o=this._touchCurrent.length;for(let a=0;a<o;a++)s+=this._touchCurrent[a].clientX,r+=this._touchCurrent[a].clientY;this.setCenter(s/o,r/o),this._startCursorPosition.setY(this.getCursorNDC(Pe.x,Pe.y,this.domElement).y*.5),this._currentCursorPosition.copy(this._startCursorPosition)}}),ee(this,"onTriplePanMove",()=>{if(this.enabled&&this.enableZoom&&this.camera&&this.domElement){let s=0,r=0;const o=this._touchCurrent.length;for(let g=0;g<o;g++)s+=this._touchCurrent[g].clientX,r+=this._touchCurrent[g].clientY;this.setCenter(s/o,r/o);const a=8;this._currentCursorPosition.setY(this.getCursorNDC(Pe.x,Pe.y,this.domElement).y*.5);const c=this._currentCursorPosition.y-this._startCursorPosition.y;let l=1;c<0?l=1/Math.pow(this.scaleFactor,-c*a):c>0&&(l=Math.pow(this.scaleFactor,c*a)),this._v3_1.setFromMatrixPosition(this._cameraMatrixState);const u=this._v3_1.distanceTo(this._gizmos.position);let h=u/l;h=Ce.clamp(h,this.minDistance,this.maxDistance);const f=u*Math.tan(Ce.DEG2RAD*this._fovState*.5);let d=Ce.RAD2DEG*(Math.atan(f/h)*2);d=Ce.clamp(d,this.minFov,this.maxFov);const p=f/Math.tan(Ce.DEG2RAD*(d/2));l=u/p,this._v3_2.setFromMatrixPosition(this._gizmoMatrixState),this.setFov(d),this.applyTransformMatrix(this.applyScale(l,this._v3_2,!1));const m=this._gizmos.position.clone().sub(this.camera.position).normalize().multiplyScalar(p/u);this._m4_1.makeTranslation(m.x,m.y,m.z),this.dispatchEvent(et)}}),ee(this,"onTriplePanEnd",()=>{this.updateTbState(Ie.IDLE,!1),this.dispatchEvent(di)}),ee(this,"setCenter",(s,r)=>{Pe.x=s,Pe.y=r}),ee(this,"initializeMouseActions",()=>{this.setMouseAction("PAN",0,"CTRL"),this.setMouseAction("PAN",2),this.setMouseAction("ROTATE",0),this.setMouseAction("ZOOM","WHEEL"),this.setMouseAction("ZOOM",1),this.setMouseAction("FOV","WHEEL","SHIFT"),this.setMouseAction("FOV",1,"SHIFT")}),ee(this,"setMouseAction",(s,r,o=null)=>{const a=["PAN","ROTATE","ZOOM","FOV"],c=[0,1,2,"WHEEL"],l=["CTRL","SHIFT",null];let u;if(!a.includes(s)||!c.includes(r)||!l.includes(o)||r=="WHEEL"&&s!="ZOOM"&&s!="FOV")return!1;switch(s){case"PAN":u=Ie.PAN;break;case"ROTATE":u=Ie.ROTATE;break;case"ZOOM":u=Ie.SCALE;break;case"FOV":u=Ie.FOV;break}const h={operation:s,mouse:r,key:o,state:u};for(let f=0;f<this.mouseActions.length;f++)if(this.mouseActions[f].mouse==h.mouse&&this.mouseActions[f].key==h.key)return this.mouseActions.splice(f,1,h),!0;return this.mouseActions.push(h),!0}),ee(this,"getOpFromAction",(s,r)=>{let o;for(let a=0;a<this.mouseActions.length;a++)if(o=this.mouseActions[a],o.mouse==s&&o.key==r)return o.operation;if(r){for(let a=0;a<this.mouseActions.length;a++)if(o=this.mouseActions[a],o.mouse==s&&o.key==null)return o.operation}return null}),ee(this,"getOpStateFromAction",(s,r)=>{let o;for(let a=0;a<this.mouseActions.length;a++)if(o=this.mouseActions[a],o.mouse==s&&o.key==r)return o.state;if(r){for(let a=0;a<this.mouseActions.length;a++)if(o=this.mouseActions[a],o.mouse==s&&o.key==null)return o.state}return null}),ee(this,"getAngle",(s,r)=>Math.atan2(r.clientY-s.clientY,r.clientX-s.clientX)*180/Math.PI),ee(this,"updateTouchEvent",s=>{for(let r=0;r<this._touchCurrent.length;r++)if(this._touchCurrent[r].pointerId==s.pointerId){this._touchCurrent.splice(r,1,s);break}}),ee(this,"calculateAngularSpeed",(s,r,o,a)=>{const c=r-s,l=(a-o)/1e3;return l==0?0:c/l}),ee(this,"calculatePointersDistance",(s,r)=>Math.sqrt(Math.pow(r.clientX-s.clientX,2)+Math.pow(r.clientY-s.clientY,2))),ee(this,"calculateRotationAxis",(s,r)=>(this._rotationMatrix.extractRotation(this._cameraMatrixState),this._quat.setFromRotationMatrix(this._rotationMatrix),this._rotationAxis.crossVectors(s,r).applyQuaternion(this._quat),this._rotationAxis.normalize().clone())),ee(this,"calculateTbRadius",s=>{const o=s.position.distanceTo(this._gizmos.position);if(s instanceof nt){const a=Ce.DEG2RAD*s.fov*.5,c=Math.atan(s.aspect*Math.tan(a));return Math.tan(Math.min(a,c))*o*.67}else if(s instanceof vt)return Math.min(s.top,s.right)*.67}),ee(this,"focus",(s,r,o=1)=>{if(this.camera){const a=s.clone();a.sub(this._gizmos.position).multiplyScalar(o),this._translationMatrix.makeTranslation(a.x,a.y,a.z);const c=this._gizmoMatrixState.clone();this._gizmoMatrixState.premultiply(this._translationMatrix),this._gizmoMatrixState.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale);const l=this._cameraMatrixState.clone();this._cameraMatrixState.premultiply(this._translationMatrix),this._cameraMatrixState.decompose(this.camera.position,this.camera.quaternion,this.camera.scale),this.enableZoom&&this.applyTransformMatrix(this.applyScale(r,this._gizmos.position)),this._gizmoMatrixState.copy(c),this._cameraMatrixState.copy(l)}}),ee(this,"drawGrid",()=>{if(this.scene){let o,a,c,l;if(this.camera instanceof vt){const u=this.camera.right-this.camera.left,h=this.camera.bottom-this.camera.top;c=Math.max(u,h),l=c/20,o=c/this.camera.zoom*3,a=o/l*this.camera.zoom}else if(this.camera instanceof nt){const u=this.camera.position.distanceTo(this._gizmos.position),h=Ce.DEG2RAD*this.camera.fov*.5,f=Math.atan(this.camera.aspect*Math.tan(h));c=Math.tan(Math.max(h,f))*u*2,l=c/20,o=c*3,a=o/l}this._grid==null&&this.camera&&(this._grid=new ty(o,a,8947848,8947848),this._grid.position.copy(this._gizmos.position),this._gridPosition.copy(this._grid.position),this._grid.quaternion.copy(this.camera.quaternion),this._grid.rotateX(Math.PI*.5),this.scene.add(this._grid))}}),ee(this,"connect",s=>{s===document&&console.error('THREE.ArcballControls: "document" should not be used as the target "domElement". Please use "renderer.domElement" instead.'),this.domElement=s,this.domElement.style.touchAction="none",this.domElement.addEventListener("contextmenu",this.onContextMenu),this.domElement.addEventListener("pointerdown",this.onPointerDown),this.domElement.addEventListener("pointercancel",this.onPointerCancel),this.domElement.addEventListener("wheel",this.onWheel)}),ee(this,"dispose",()=>{var s,r,o,a,c;this._animationId!=-1&&window.cancelAnimationFrame(this._animationId),(s=this.domElement)==null||s.removeEventListener("pointerdown",this.onPointerDown),(r=this.domElement)==null||r.removeEventListener("pointercancel",this.onPointerCancel),(o=this.domElement)==null||o.removeEventListener("wheel",this.onWheel),(a=this.domElement)==null||a.removeEventListener("contextmenu",this.onContextMenu),window.removeEventListener("pointermove",this.onPointerMove),window.removeEventListener("pointerup",this.onPointerUp),window.removeEventListener("resize",this.onWindowResize),(c=this.scene)==null||c.remove(this._gizmos),this.disposeGrid()}),ee(this,"disposeGrid",()=>{this._grid&&this.scene&&(this.scene.remove(this._grid),this._grid=null)}),ee(this,"easeOutCubic",s=>1-Math.pow(1-s,3)),ee(this,"activateGizmos",s=>{for(const r of this._gizmos.children)r.material.setValues({opacity:s?1:.6})}),ee(this,"getCursorNDC",(s,r,o)=>{const a=o.getBoundingClientRect();return this._v2_1.setX((s-a.left)/a.width*2-1),this._v2_1.setY((a.bottom-r)/a.height*2-1),this._v2_1.clone()}),ee(this,"getCursorPosition",(s,r,o)=>(this._v2_1.copy(this.getCursorNDC(s,r,o)),this.camera instanceof vt&&(this._v2_1.x*=(this.camera.right-this.camera.left)*.5,this._v2_1.y*=(this.camera.top-this.camera.bottom)*.5),this._v2_1.clone())),ee(this,"setCamera",s=>{if(s){s.lookAt(this.target),s.updateMatrix(),s instanceof nt&&(this._fov0=s.fov,this._fovState=s.fov),this._cameraMatrixState0.copy(s.matrix),this._cameraMatrixState.copy(this._cameraMatrixState0),this._cameraProjectionState.copy(s.projectionMatrix),this._zoom0=s.zoom,this._zoomState=this._zoom0,this._initialNear=s.near,this._nearPos0=s.position.distanceTo(this.target)-s.near,this._nearPos=this._initialNear,this._initialFar=s.far,this._farPos0=s.position.distanceTo(this.target)-s.far,this._farPos=this._initialFar,this._up0.copy(s.up),this._upState.copy(s.up),this.camera=s,this.camera.updateProjectionMatrix();const r=this.calculateTbRadius(s);r!==void 0&&(this._tbRadius=r),this.makeGizmos(this.target,this._tbRadius)}}),ee(this,"makeGizmos",(s,r)=>{const a=new Xc(0,0,r,r).getPoints(this._curvePts),c=new St().setFromPoints(a),l=new or({color:16744576,fog:!1,transparent:!0,opacity:.6}),u=new or({color:8454016,fog:!1,transparent:!0,opacity:.6}),h=new or({color:8421631,fog:!1,transparent:!0,opacity:.6}),f=new Qe(c,l),d=new Qe(c,u),p=new Qe(c,h),m=Math.PI*.5;if(f.rotation.x=m,d.rotation.y=m,this._gizmoMatrixState0.identity().setPosition(s),this._gizmoMatrixState.copy(this._gizmoMatrixState0),this.camera&&this.camera.zoom!=1){const g=1/this.camera.zoom;this._scaleMatrix.makeScale(g,g,g),this._translationMatrix.makeTranslation(-s.x,-s.y,-s.z),this._gizmoMatrixState.premultiply(this._translationMatrix).premultiply(this._scaleMatrix),this._translationMatrix.makeTranslation(s.x,s.y,s.z),this._gizmoMatrixState.premultiply(this._translationMatrix)}this._gizmoMatrixState.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this._gizmos.clear(),this._gizmos.add(f),this._gizmos.add(d),this._gizmos.add(p)}),ee(this,"onFocusAnim",(s,r,o,a)=>{if(this._timeStart==-1&&(this._timeStart=s),this._state==Ie.ANIMATION_FOCUS){const l=(s-this._timeStart)/this.focusAnimationTime;if(this._gizmoMatrixState.copy(a),l>=1)this._gizmoMatrixState.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this.focus(r,this.scaleFactor),this._timeStart=-1,this.updateTbState(Ie.IDLE,!1),this.activateGizmos(!1),this.dispatchEvent(et);else{const u=this.easeOutCubic(l),h=1-u+this.scaleFactor*u;this._gizmoMatrixState.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this.focus(r,h,u),this.dispatchEvent(et);const f=this;this._animationId=window.requestAnimationFrame(function(d){f.onFocusAnim(d,r,o,a.clone())})}}else this._animationId=-1,this._timeStart=-1}),ee(this,"onRotationAnim",(s,r,o)=>{if(this._timeStart==-1&&(this._anglePrev=0,this._angleCurrent=0,this._timeStart=s),this._state==Ie.ANIMATION_ROTATE){const a=(s-this._timeStart)/1e3;if(o+-this.dampingFactor*a>0){this._angleCurrent=.5*-this.dampingFactor*Math.pow(a,2)+o*a+0,this.applyTransformMatrix(this.rotate(r,this._angleCurrent)),this.dispatchEvent(et);const l=this;this._animationId=window.requestAnimationFrame(function(u){l.onRotationAnim(u,r,o)})}else this._animationId=-1,this._timeStart=-1,this.updateTbState(Ie.IDLE,!1),this.activateGizmos(!1),this.dispatchEvent(et)}else this._animationId=-1,this._timeStart=-1,this._state!=Ie.ROTATE&&(this.activateGizmos(!1),this.dispatchEvent(et))}),ee(this,"pan",(s,r,o=!1)=>{if(this.camera){const a=s.clone().sub(r);if(this.camera instanceof vt&&a.multiplyScalar(1/this.camera.zoom),this.camera instanceof nt&&o){this._v3_1.setFromMatrixPosition(this._cameraMatrixState0),this._v3_2.setFromMatrixPosition(this._gizmoMatrixState0);const c=this._v3_1.distanceTo(this._v3_2)/this.camera.position.distanceTo(this._gizmos.position);a.multiplyScalar(1/c)}this._v3_1.set(a.x,a.y,0).applyQuaternion(this.camera.quaternion),this._m4_1.makeTranslation(this._v3_1.x,this._v3_1.y,this._v3_1.z),this.setTransformationMatrices(this._m4_1,this._m4_1)}return oi}),ee(this,"reset",()=>{if(this.camera){this.camera.zoom=this._zoom0,this.camera instanceof nt&&(this.camera.fov=this._fov0),this.camera.near=this._nearPos,this.camera.far=this._farPos,this._cameraMatrixState.copy(this._cameraMatrixState0),this._cameraMatrixState.decompose(this.camera.position,this.camera.quaternion,this.camera.scale),this.camera.up.copy(this._up0),this.camera.updateMatrix(),this.camera.updateProjectionMatrix(),this._gizmoMatrixState.copy(this._gizmoMatrixState0),this._gizmoMatrixState0.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this._gizmos.updateMatrix();const s=this.calculateTbRadius(this.camera);s!==void 0&&(this._tbRadius=s),this.makeGizmos(this._gizmos.position,this._tbRadius),this.camera.lookAt(this._gizmos.position),this.updateTbState(Ie.IDLE,!1),this.dispatchEvent(et)}}),ee(this,"rotate",(s,r)=>{const o=this._gizmos.position;return this._translationMatrix.makeTranslation(-o.x,-o.y,-o.z),this._rotationMatrix.makeRotationAxis(s,-r),this._m4_1.makeTranslation(o.x,o.y,o.z),this._m4_1.multiply(this._rotationMatrix),this._m4_1.multiply(this._translationMatrix),this.setTransformationMatrices(this._m4_1),oi}),ee(this,"copyState",()=>{if(this.camera){const s=JSON.stringify(this.camera instanceof vt?{arcballState:{cameraFar:this.camera.far,cameraMatrix:this.camera.matrix,cameraNear:this.camera.near,cameraUp:this.camera.up,cameraZoom:this.camera.zoom,gizmoMatrix:this._gizmos.matrix}}:{arcballState:{cameraFar:this.camera.far,cameraFov:this.camera.fov,cameraMatrix:this.camera.matrix,cameraNear:this.camera.near,cameraUp:this.camera.up,cameraZoom:this.camera.zoom,gizmoMatrix:this._gizmos.matrix}});navigator.clipboard.writeText(s)}}),ee(this,"pasteState",()=>{const s=this;navigator.clipboard.readText().then(function(o){s.setStateFromJSON(o)})}),ee(this,"saveState",()=>{this.camera&&(this._cameraMatrixState0.copy(this.camera.matrix),this._gizmoMatrixState0.copy(this._gizmos.matrix),this._nearPos=this.camera.near,this._farPos=this.camera.far,this._zoom0=this.camera.zoom,this._up0.copy(this.camera.up),this.camera instanceof nt&&(this._fov0=this.camera.fov))}),ee(this,"applyScale",(s,r,o=!0)=>{if(!this.camera)return;const a=r.clone();let c=1/s;if(this.camera instanceof vt){this.camera.zoom=this._zoomState,this.camera.zoom*=s,this.camera.zoom>this.maxZoom?(this.camera.zoom=this.maxZoom,c=this._zoomState/this.maxZoom):this.camera.zoom<this.minZoom&&(this.camera.zoom=this.minZoom,c=this._zoomState/this.minZoom),this.camera.updateProjectionMatrix(),this._v3_1.setFromMatrixPosition(this._gizmoMatrixState),this._scaleMatrix.makeScale(c,c,c),this._translationMatrix.makeTranslation(-this._v3_1.x,-this._v3_1.y,-this._v3_1.z),this._m4_2.makeTranslation(this._v3_1.x,this._v3_1.y,this._v3_1.z).multiply(this._scaleMatrix),this._m4_2.multiply(this._translationMatrix),a.sub(this._v3_1);const l=a.clone().multiplyScalar(c);return a.sub(l),this._m4_1.makeTranslation(a.x,a.y,a.z),this._m4_2.premultiply(this._m4_1),this.setTransformationMatrices(this._m4_1,this._m4_2),oi}if(this.camera instanceof nt){this._v3_1.setFromMatrixPosition(this._cameraMatrixState),this._v3_2.setFromMatrixPosition(this._gizmoMatrixState);let l=this._v3_1.distanceTo(a),u=l-l*c;const h=l-u;h<this.minDistance?(c=this.minDistance/l,u=l-l*c):h>this.maxDistance&&(c=this.maxDistance/l,u=l-l*c);let f=a.clone().sub(this._v3_1).normalize().multiplyScalar(u);if(this._m4_1.makeTranslation(f.x,f.y,f.z),o){const d=this._v3_2;l=d.distanceTo(a),u=l-l*c,f=a.clone().sub(this._v3_2).normalize().multiplyScalar(u),this._translationMatrix.makeTranslation(d.x,d.y,d.z),this._scaleMatrix.makeScale(c,c,c),this._m4_2.makeTranslation(f.x,f.y,f.z).multiply(this._translationMatrix),this._m4_2.multiply(this._scaleMatrix),this._translationMatrix.makeTranslation(-d.x,-d.y,-d.z),this._m4_2.multiply(this._translationMatrix),this.setTransformationMatrices(this._m4_1,this._m4_2)}else this.setTransformationMatrices(this._m4_1);return oi}}),ee(this,"setFov",s=>{this.camera instanceof nt&&(this.camera.fov=Ce.clamp(s,this.minFov,this.maxFov),this.camera.updateProjectionMatrix())}),ee(this,"setTarget",(s,r,o)=>{if(this.camera){this.target.set(s,r,o),this._gizmos.position.set(s,r,o);const a=this.calculateTbRadius(this.camera);a!==void 0&&(this._tbRadius=a),this.makeGizmos(this.target,this._tbRadius),this.camera.lookAt(this.target)}}),ee(this,"zRotate",(s,r)=>(this._rotationMatrix.makeRotationAxis(this._rotationAxis,r),this._translationMatrix.makeTranslation(-s.x,-s.y,-s.z),this._m4_1.makeTranslation(s.x,s.y,s.z),this._m4_1.multiply(this._rotationMatrix),this._m4_1.multiply(this._translationMatrix),this._v3_1.setFromMatrixPosition(this._gizmoMatrixState).sub(s),this._v3_2.copy(this._v3_1).applyAxisAngle(this._rotationAxis,r),this._v3_2.sub(this._v3_1),this._m4_2.makeTranslation(this._v3_2.x,this._v3_2.y,this._v3_2.z),this.setTransformationMatrices(this._m4_1,this._m4_2),oi)),ee(this,"unprojectOnObj",(s,r)=>{if(!this.scene)return null;const o=new bc;o.near=r.near,o.far=r.far,o.setFromCamera(s,r);const a=o.intersectObjects(this.scene.children,!0);for(let c=0;c<a.length;c++)if(a[c].object.uuid!=this._gizmos.uuid&&a[c].face)return a[c].point.clone();return null}),ee(this,"unprojectOnTbSurface",(s,r,o,a,c)=>{if(s instanceof vt){this._v2_1.copy(this.getCursorPosition(r,o,a)),this._v3_1.set(this._v2_1.x,this._v2_1.y,0);const l=Math.pow(this._v2_1.x,2),u=Math.pow(this._v2_1.y,2),h=Math.pow(this._tbRadius,2);return l+u<=h*.5?this._v3_1.setZ(Math.sqrt(h-(l+u))):this._v3_1.setZ(h*.5/Math.sqrt(l+u)),this._v3_1}if(s instanceof nt){this._v2_1.copy(this.getCursorNDC(r,o,a)),this._v3_1.set(this._v2_1.x,this._v2_1.y,-1),this._v3_1.applyMatrix4(s.projectionMatrixInverse);const l=this._v3_1.clone().normalize(),u=s.position.distanceTo(this._gizmos.position),h=Math.pow(c,2),f=this._v3_1.z,d=Math.sqrt(Math.pow(this._v3_1.x,2)+Math.pow(this._v3_1.y,2));if(d==0)return l.set(this._v3_1.x,this._v3_1.y,c),l;const p=f/d,m=u;let g=Math.pow(p,2)+1,y=2*p*m,v=Math.pow(m,2)-h,E=Math.pow(y,2)-4*g*v;if(E>=0&&(this._v2_1.setX((-y-Math.sqrt(E))/(2*g)),this._v2_1.setY(p*this._v2_1.x+m),Ce.RAD2DEG*this._v2_1.angle()>=45)){const I=Math.sqrt(Math.pow(this._v2_1.x,2)+Math.pow(u-this._v2_1.y,2));return l.multiplyScalar(I),l.z+=u,l}g=p,y=m,v=-h*.5,E=Math.pow(y,2)-4*g*v,this._v2_1.setX((-y-Math.sqrt(E))/(2*g)),this._v2_1.setY(p*this._v2_1.x+m);const C=Math.sqrt(Math.pow(this._v2_1.x,2)+Math.pow(u-this._v2_1.y,2));return l.multiplyScalar(C),l.z+=u,l}}),ee(this,"unprojectOnTbPlane",(s,r,o,a,c=!1)=>{if(s instanceof vt)return this._v2_1.copy(this.getCursorPosition(r,o,a)),this._v3_1.set(this._v2_1.x,this._v2_1.y,0),this._v3_1.clone();if(s instanceof nt){this._v2_1.copy(this.getCursorNDC(r,o,a)),this._v3_1.set(this._v2_1.x,this._v2_1.y,-1),this._v3_1.applyMatrix4(s.projectionMatrixInverse);const l=this._v3_1.clone().normalize(),u=this._v3_1.z,h=Math.sqrt(Math.pow(this._v3_1.x,2)+Math.pow(this._v3_1.y,2));let f;if(c?f=this._v3_1.setFromMatrixPosition(this._cameraMatrixState0).distanceTo(this._v3_2.setFromMatrixPosition(this._gizmoMatrixState0)):f=s.position.distanceTo(this._gizmos.position),h==0)return l.set(0,0,0),l;const d=u/h,p=f,m=-p/d,g=Math.sqrt(Math.pow(p,2)+Math.pow(m,2));return l.multiplyScalar(g),l.z=0,l}}),ee(this,"updateMatrixState",()=>{this.camera&&(this._cameraMatrixState.copy(this.camera.matrix),this._gizmoMatrixState.copy(this._gizmos.matrix),this.camera instanceof vt&&(this._cameraProjectionState.copy(this.camera.projectionMatrix),this.camera.updateProjectionMatrix(),this._zoomState=this.camera.zoom),this.camera instanceof nt&&(this._fovState=this.camera.fov))}),ee(this,"updateTbState",(s,r)=>{this._state=s,r&&this.updateMatrixState()}),ee(this,"update",()=>{if(!this.target.equals(this._currentTarget)&&this.camera){this._gizmos.position.set(this.target.x,this.target.y,this.target.z);const r=this.calculateTbRadius(this.camera);r!==void 0&&(this._tbRadius=r),this.makeGizmos(this.target,this._tbRadius),this._currentTarget.copy(this.target)}if(this.camera){if(this.camera instanceof vt&&(this.camera.zoom>this.maxZoom||this.camera.zoom<this.minZoom)){const r=Ce.clamp(this.camera.zoom,this.minZoom,this.maxZoom);this.applyTransformMatrix(this.applyScale(r/this.camera.zoom,this._gizmos.position,!0))}if(this.camera instanceof nt){const r=this.camera.position.distanceTo(this._gizmos.position);if(r>this.maxDistance+1e-6||r<this.minDistance-1e-6){const c=Ce.clamp(r,this.minDistance,this.maxDistance);this.applyTransformMatrix(this.applyScale(c/r,this._gizmos.position)),this.updateMatrixState()}(this.camera.fov<this.minFov||this.camera.fov>this.maxFov)&&(this.camera.fov=Ce.clamp(this.camera.fov,this.minFov,this.maxFov),this.camera.updateProjectionMatrix());const o=this._tbRadius,a=this.calculateTbRadius(this.camera);if(a!==void 0&&(this._tbRadius=a),o<this._tbRadius-1e-6||o>this._tbRadius+1e-6){const c=(this._gizmos.scale.x+this._gizmos.scale.y+this._gizmos.scale.z)/3,l=this._tbRadius/c,h=new Xc(0,0,l,l).getPoints(this._curvePts),f=new St().setFromPoints(h);for(const d in this._gizmos.children){const p=this._gizmos.children[d];p.geometry=f}}}this.camera.lookAt(this._gizmos.position)}}),ee(this,"setStateFromJSON",s=>{const r=JSON.parse(s);if(r.arcballState&&this.camera){this._cameraMatrixState.fromArray(r.arcballState.cameraMatrix.elements),this._cameraMatrixState.decompose(this.camera.position,this.camera.quaternion,this.camera.scale),this.camera.up.copy(r.arcballState.cameraUp),this.camera.near=r.arcballState.cameraNear,this.camera.far=r.arcballState.cameraFar,this.camera.zoom=r.arcballState.cameraZoom,this.camera instanceof nt&&(this.camera.fov=r.arcballState.cameraFov),this._gizmoMatrixState.fromArray(r.arcballState.gizmoMatrix.elements),this._gizmoMatrixState.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this.camera.updateMatrix(),this.camera.updateProjectionMatrix(),this._gizmos.updateMatrix();const o=this.calculateTbRadius(this.camera);o!==void 0&&(this._tbRadius=o);const a=new ce().copy(this._gizmoMatrixState0);this.makeGizmos(this._gizmos.position,this._tbRadius),this._gizmoMatrixState0.copy(a),this.camera.lookAt(this._gizmos.position),this.updateTbState(Ie.IDLE,!1),this.dispatchEvent(et)}}),this.camera=null,this.domElement=t,this.scene=i,this.mouseActions=[],this._mouseOp=null,this._v2_1=new de,this._v3_1=new b,this._v3_2=new b,this._m4_1=new ce,this._m4_2=new ce,this._quat=new Be,this._translationMatrix=new ce,this._rotationMatrix=new ce,this._scaleMatrix=new ce,this._rotationAxis=new b,this._cameraMatrixState=new ce,this._cameraProjectionState=new ce,this._fovState=1,this._upState=new b,this._zoomState=1,this._nearPos=0,this._farPos=0,this._gizmoMatrixState=new ce,this._up0=new b,this._zoom0=1,this._fov0=0,this._initialNear=0,this._nearPos0=0,this._initialFar=0,this._farPos0=0,this._cameraMatrixState0=new ce,this._gizmoMatrixState0=new ce,this._button=-1,this._touchStart=[],this._touchCurrent=[],this._input=Ve.NONE,this._switchSensibility=32,this._startFingerDistance=0,this._currentFingerDistance=0,this._startFingerRotation=0,this._currentFingerRotation=0,this._devPxRatio=0,this._downValid=!0,this._nclicks=0,this._downEvents=[],this._clickStart=0,this._maxDownTime=250,this._maxInterval=300,this._posThreshold=24,this._movementThreshold=24,this._currentCursorPosition=new b,this._startCursorPosition=new b,this._grid=null,this._gridPosition=new b,this._gizmos=new ws,this._curvePts=128,this._timeStart=-1,this._animationId=-1,this.focusAnimationTime=500,this._timePrev=0,this._timeCurrent=0,this._anglePrev=0,this._angleCurrent=0,this._cursorPosPrev=new b,this._cursorPosCurr=new b,this._wPrev=0,this._wCurr=0,this.adjustNearFar=!1,this.scaleFactor=1.1,this.dampingFactor=25,this.wMax=20,this.enableAnimations=!0,this.enableGrid=!1,this.cursorZoom=!1,this.minFov=5,this.maxFov=90,this.enabled=!0,this.enablePan=!0,this.enableRotate=!0,this.enableZoom=!0,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.target=new b(0,0,0),this._currentTarget=new b(0,0,0),this._tbRadius=1,this._state=Ie.IDLE,this.setCamera(e),this.scene&&this.scene.add(this._gizmos),this._devPxRatio=window.devicePixelRatio,this.initializeMouseActions(),this.domElement&&this.connect(this.domElement),window.addEventListener("resize",this.onWindowResize)}applyTransformMatrix(e){if(e!=null&&e.camera&&this.camera&&(this._m4_1.copy(this._cameraMatrixState).premultiply(e.camera),this._m4_1.decompose(this.camera.position,this.camera.quaternion,this.camera.scale),this.camera.updateMatrix(),(this._state==Ie.ROTATE||this._state==Ie.ZROTATE||this._state==Ie.ANIMATION_ROTATE)&&this.camera.up.copy(this._upState).applyQuaternion(this.camera.quaternion)),e!=null&&e.gizmos&&(this._m4_1.copy(this._gizmoMatrixState).premultiply(e.gizmos),this._m4_1.decompose(this._gizmos.position,this._gizmos.quaternion,this._gizmos.scale),this._gizmos.updateMatrix()),(this._state==Ie.SCALE||this._state==Ie.FOCUS||this._state==Ie.ANIMATION_FOCUS)&&this.camera){const t=this.calculateTbRadius(this.camera);if(t!==void 0&&(this._tbRadius=t),this.adjustNearFar){const i=this.camera.position.distanceTo(this._gizmos.position),s=new st;s.setFromObject(this._gizmos);const r=new si;s.getBoundingSphere(r);const o=Math.max(this._nearPos0,r.radius+r.center.length()),a=i-this._initialNear,c=Math.min(o,a);this.camera.near=i-c;const l=Math.min(this._farPos0,-r.radius+r.center.length()),u=i-this._initialFar,h=Math.min(l,u);this.camera.far=i-h,this.camera.updateProjectionMatrix()}else{let i=!1;this.camera.near!=this._initialNear&&(this.camera.near=this._initialNear,i=!0),this.camera.far!=this._initialFar&&(this.camera.far=this._initialFar,i=!0),i&&this.camera.updateProjectionMatrix()}}}setGizmosVisible(e){this._gizmos.visible=e,this.dispatchEvent(et)}setTransformationMatrices(e=null,t=null){e?oi.camera?oi.camera.copy(e):oi.camera=e.clone():oi.camera=null,t?oi.gizmos?oi.gizmos.copy(t):oi.gizmos=t.clone():oi.gizmos=null}};var Ex=Object.defineProperty,vx=(n,e,t)=>e in n?Ex(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,We=(n,e,t)=>(vx(n,typeof e!="symbol"?e+"":e,t),t);function Pd(n){n.preventDefault()}let xx=class extends hn{constructor(e,t){super(),We(this,"object"),We(this,"domElement",null),We(this,"movementSpeed",1),We(this,"rollSpeed",.005),We(this,"dragToLook",!1),We(this,"autoForward",!1),We(this,"changeEvent",{type:"change"}),We(this,"EPS",1e-6),We(this,"tmpQuaternion",new Be),We(this,"mouseStatus",0),We(this,"movementSpeedMultiplier",1),We(this,"moveState",{up:0,down:0,left:0,right:0,forward:0,back:0,pitchUp:0,pitchDown:0,yawLeft:0,yawRight:0,rollLeft:0,rollRight:0}),We(this,"moveVector",new b(0,0,0)),We(this,"rotationVector",new b(0,0,0)),We(this,"keydown",i=>{if(!i.altKey){switch(i.code){case"ShiftLeft":case"ShiftRight":this.movementSpeedMultiplier=.1;break;case"KeyW":this.moveState.forward=1;break;case"KeyS":this.moveState.back=1;break;case"KeyA":this.moveState.left=1;break;case"KeyD":this.moveState.right=1;break;case"KeyR":this.moveState.up=1;break;case"KeyF":this.moveState.down=1;break;case"ArrowUp":this.moveState.pitchUp=1;break;case"ArrowDown":this.moveState.pitchDown=1;break;case"ArrowLeft":this.moveState.yawLeft=1;break;case"ArrowRight":this.moveState.yawRight=1;break;case"KeyQ":this.moveState.rollLeft=1;break;case"KeyE":this.moveState.rollRight=1;break}this.updateMovementVector(),this.updateRotationVector()}}),We(this,"keyup",i=>{switch(i.code){case"ShiftLeft":case"ShiftRight":this.movementSpeedMultiplier=1;break;case"KeyW":this.moveState.forward=0;break;case"KeyS":this.moveState.back=0;break;case"KeyA":this.moveState.left=0;break;case"KeyD":this.moveState.right=0;break;case"KeyR":this.moveState.up=0;break;case"KeyF":this.moveState.down=0;break;case"ArrowUp":this.moveState.pitchUp=0;break;case"ArrowDown":this.moveState.pitchDown=0;break;case"ArrowLeft":this.moveState.yawLeft=0;break;case"ArrowRight":this.moveState.yawRight=0;break;case"KeyQ":this.moveState.rollLeft=0;break;case"KeyE":this.moveState.rollRight=0;break}this.updateMovementVector(),this.updateRotationVector()}),We(this,"pointerdown",i=>{if(this.dragToLook)this.mouseStatus++;else{switch(i.button){case 0:this.moveState.forward=1;break;case 2:this.moveState.back=1;break}this.updateMovementVector()}}),We(this,"pointermove",i=>{if(!this.dragToLook||this.mouseStatus>0){const s=this.getContainerDimensions(),r=s.size[0]/2,o=s.size[1]/2;this.moveState.yawLeft=-(i.pageX-s.offset[0]-r)/r,this.moveState.pitchDown=(i.pageY-s.offset[1]-o)/o,this.updateRotationVector()}}),We(this,"pointerup",i=>{if(this.dragToLook)this.mouseStatus--,this.moveState.yawLeft=this.moveState.pitchDown=0;else{switch(i.button){case 0:this.moveState.forward=0;break;case 2:this.moveState.back=0;break}this.updateMovementVector()}this.updateRotationVector()}),We(this,"lastQuaternion",new Be),We(this,"lastPosition",new b),We(this,"update",i=>{const s=i*this.movementSpeed,r=i*this.rollSpeed;this.object.translateX(this.moveVector.x*s),this.object.translateY(this.moveVector.y*s),this.object.translateZ(this.moveVector.z*s),this.tmpQuaternion.set(this.rotationVector.x*r,this.rotationVector.y*r,this.rotationVector.z*r,1).normalize(),this.object.quaternion.multiply(this.tmpQuaternion),(this.lastPosition.distanceToSquared(this.object.position)>this.EPS||8*(1-this.lastQuaternion.dot(this.object.quaternion))>this.EPS)&&(this.dispatchEvent(this.changeEvent),this.lastQuaternion.copy(this.object.quaternion),this.lastPosition.copy(this.object.position))}),We(this,"updateMovementVector",()=>{const i=this.moveState.forward||this.autoForward&&!this.moveState.back?1:0;this.moveVector.x=-this.moveState.left+this.moveState.right,this.moveVector.y=-this.moveState.down+this.moveState.up,this.moveVector.z=-i+this.moveState.back}),We(this,"updateRotationVector",()=>{this.rotationVector.x=-this.moveState.pitchDown+this.moveState.pitchUp,this.rotationVector.y=-this.moveState.yawRight+this.moveState.yawLeft,this.rotationVector.z=-this.moveState.rollRight+this.moveState.rollLeft}),We(this,"getContainerDimensions",()=>this.domElement!=document&&!(this.domElement instanceof Document)?{size:[this.domElement.offsetWidth,this.domElement.offsetHeight],offset:[this.domElement.offsetLeft,this.domElement.offsetTop]}:{size:[window.innerWidth,window.innerHeight],offset:[0,0]}),We(this,"connect",i=>{this.domElement=i,i instanceof Document||i.setAttribute("tabindex",-1),this.domElement.addEventListener("contextmenu",Pd),this.domElement.addEventListener("pointermove",this.pointermove),this.domElement.addEventListener("pointerdown",this.pointerdown),this.domElement.addEventListener("pointerup",this.pointerup),window.addEventListener("keydown",this.keydown),window.addEventListener("keyup",this.keyup)}),We(this,"dispose",()=>{this.domElement.removeEventListener("contextmenu",Pd),this.domElement.removeEventListener("pointermove",this.pointermove),this.domElement.removeEventListener("pointerdown",this.pointerdown),this.domElement.removeEventListener("pointerup",this.pointerup),window.removeEventListener("keydown",this.keydown),window.removeEventListener("keyup",this.keyup)}),this.object=e,t!==void 0&&this.connect(t),this.updateMovementVector(),this.updateRotationVector()}};var Cx=Object.defineProperty,Ix=(n,e,t)=>e in n?Cx(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,sn=(n,e,t)=>(Ix(n,typeof e!="symbol"?e+"":e,t),t);class Fc{constructor(){sn(this,"enabled",!0),sn(this,"needsSwap",!0),sn(this,"clear",!1),sn(this,"renderToScreen",!1)}setSize(e,t){}render(e,t,i,s,r){console.error("THREE.Pass: .render() must be implemented in derived pass.")}dispose(){}}class xs{constructor(e){sn(this,"camera",new vt(-1,1,1,-1,0,1)),sn(this,"geometry",new Ji(2,2)),sn(this,"mesh"),this.mesh=new ye(this.geometry,e)}get material(){return this.mesh.material}set material(e){this.mesh.material=e}dispose(){this.mesh.geometry.dispose()}render(e){e.render(this.mesh,this.camera)}}var Sx=Object.defineProperty,wx=(n,e,t)=>e in n?Sx(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,qo=(n,e,t)=>(wx(n,typeof e!="symbol"?e+"":e,t),t);class Zu extends Fc{constructor(e,t="tDiffuse"){super(),qo(this,"textureID"),qo(this,"uniforms"),qo(this,"material"),qo(this,"fsQuad"),this.textureID=t,e instanceof Dt?(this.uniforms=e.uniforms,this.material=e):(this.uniforms=_o.clone(e.uniforms),this.material=new Dt({defines:Object.assign({},e.defines),uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader})),this.fsQuad=new xs(this.material)}render(e,t,i){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=i.texture),this.fsQuad.material=this.material,this.renderToScreen?(e.setRenderTarget(null),this.fsQuad.render(e)):(e.setRenderTarget(t),this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),this.fsQuad.render(e))}dispose(){this.fsQuad.dispose(),this.material.dispose()}}const Fd={uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:["varying vec2 vUv;","void main() {","	vUv = uv;","	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join(`
`),fragmentShader:["uniform float opacity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","	vec4 texel = texture2D( tDiffuse, vUv );","	gl_FragColor = opacity * texel;","}"].join(`
`)};var Tx=Object.defineProperty,Bx=(n,e,t)=>e in n?Tx(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,ll=(n,e,t)=>(Bx(n,typeof e!="symbol"?e+"":e,t),t);class kd extends Fc{constructor(e,t){super(),ll(this,"scene"),ll(this,"camera"),ll(this,"inverse"),this.scene=e,this.camera=t,this.clear=!0,this.needsSwap=!1,this.inverse=!1}render(e,t,i){const s=e.getContext(),r=e.state;r.buffers.color.setMask(!1),r.buffers.depth.setMask(!1),r.buffers.color.setLocked(!0),r.buffers.depth.setLocked(!0);let o,a;this.inverse?(o=0,a=1):(o=1,a=0),r.buffers.stencil.setTest(!0),r.buffers.stencil.setOp(s.REPLACE,s.REPLACE,s.REPLACE),r.buffers.stencil.setFunc(s.ALWAYS,o,4294967295),r.buffers.stencil.setClear(a),r.buffers.stencil.setLocked(!0),e.setRenderTarget(i),this.clear&&e.clear(),e.render(this.scene,this.camera),e.setRenderTarget(t),this.clear&&e.clear(),e.render(this.scene,this.camera),r.buffers.color.setLocked(!1),r.buffers.depth.setLocked(!1),r.buffers.stencil.setLocked(!1),r.buffers.stencil.setFunc(s.EQUAL,1,4294967295),r.buffers.stencil.setOp(s.KEEP,s.KEEP,s.KEEP),r.buffers.stencil.setLocked(!0)}}class _x extends Fc{constructor(){super(),this.needsSwap=!1}render(e){e.state.buffers.stencil.setLocked(!1),e.state.buffers.stencil.setTest(!1)}}var bx=Object.defineProperty,Rx=(n,e,t)=>e in n?bx(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,Ai=(n,e,t)=>(Rx(n,typeof e!="symbol"?e+"":e,t),t);class Dx{constructor(e,t){if(Ai(this,"renderer"),Ai(this,"_pixelRatio"),Ai(this,"_width"),Ai(this,"_height"),Ai(this,"renderTarget1"),Ai(this,"renderTarget2"),Ai(this,"writeBuffer"),Ai(this,"readBuffer"),Ai(this,"renderToScreen"),Ai(this,"passes",[]),Ai(this,"copyPass"),Ai(this,"clock"),this.renderer=e,t===void 0){const i={minFilter:zt,magFilter:zt,format:jt},s=e.getSize(new de);this._pixelRatio=e.getPixelRatio(),this._width=s.width,this._height=s.height,t=new It(this._width*this._pixelRatio,this._height*this._pixelRatio,i),t.texture.name="EffectComposer.rt1"}else this._pixelRatio=1,this._width=t.width,this._height=t.height;this.renderTarget1=t,this.renderTarget2=t.clone(),this.renderTarget2.texture.name="EffectComposer.rt2",this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.renderToScreen=!0,Fd===void 0&&console.error("THREE.EffectComposer relies on CopyShader"),Zu===void 0&&console.error("THREE.EffectComposer relies on ShaderPass"),this.copyPass=new Zu(Fd),this.copyPass.material.blending=Zm,this.clock=new iy}swapBuffers(){const e=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=e}addPass(e){this.passes.push(e),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}insertPass(e,t){this.passes.splice(t,0,e),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}removePass(e){const t=this.passes.indexOf(e);t!==-1&&this.passes.splice(t,1)}isLastEnabledPass(e){for(let t=e+1;t<this.passes.length;t++)if(this.passes[t].enabled)return!1;return!0}render(e){e===void 0&&(e=this.clock.getDelta());const t=this.renderer.getRenderTarget();let i=!1;const s=this.passes.length;for(let r=0;r<s;r++){const o=this.passes[r];if(o.enabled!==!1){if(o.renderToScreen=this.renderToScreen&&this.isLastEnabledPass(r),o.render(this.renderer,this.writeBuffer,this.readBuffer,e,i),o.needsSwap){if(i){const a=this.renderer.getContext(),c=this.renderer.state.buffers.stencil;c.setFunc(a.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,e),c.setFunc(a.EQUAL,1,4294967295)}this.swapBuffers()}kd!==void 0&&(o instanceof kd?i=!0:o instanceof _x&&(i=!1))}}this.renderer.setRenderTarget(t)}reset(e){if(e===void 0){const t=this.renderer.getSize(new de);this._pixelRatio=this.renderer.getPixelRatio(),this._width=t.width,this._height=t.height,e=this.renderTarget1.clone(),e.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.renderTarget1=e,this.renderTarget2=e.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2}setSize(e,t){this._width=e,this._height=t;const i=this._width*this._pixelRatio,s=this._height*this._pixelRatio;this.renderTarget1.setSize(i,s),this.renderTarget2.setSize(i,s);for(let r=0;r<this.passes.length;r++)this.passes[r].setSize(i,s)}setPixelRatio(e){this._pixelRatio=e,this.setSize(this._width,this._height)}dispose(){this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.copyPass.dispose()}}var Mx=Object.defineProperty,Lx=(n,e,t)=>e in n?Mx(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,Ws=(n,e,t)=>(Lx(n,typeof e!="symbol"?e+"":e,t),t);class Px extends Fc{constructor(e,t,i,s,r=0){super(),Ws(this,"scene"),Ws(this,"camera"),Ws(this,"overrideMaterial"),Ws(this,"clearColor"),Ws(this,"clearAlpha"),Ws(this,"clearDepth",!1),Ws(this,"_oldClearColor",new xe),this.scene=e,this.camera=t,this.overrideMaterial=i,this.clearColor=s,this.clearAlpha=r,this.clear=!0,this.needsSwap=!1}render(e,t,i){let s=e.autoClear;e.autoClear=!1;let r,o=null;this.overrideMaterial!==void 0&&(o=this.scene.overrideMaterial,this.scene.overrideMaterial=this.overrideMaterial),this.clearColor&&(e.getClearColor(this._oldClearColor),r=e.getClearAlpha(),e.setClearColor(this.clearColor,this.clearAlpha)),this.clearDepth&&e.clearDepth(),e.setRenderTarget(this.renderToScreen?null:i),this.clear&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),e.render(this.scene,this.camera),this.clearColor&&e.setClearColor(this._oldClearColor,r),this.overrideMaterial!==void 0&&(this.scene.overrideMaterial=o),e.autoClear=s}}function mr(n){if(typeof TextDecoder<"u")return new TextDecoder().decode(n);let e="";for(let t=0,i=n.length;t<i;t++)e+=String.fromCharCode(n[t]);try{return decodeURIComponent(escape(e))}catch{return e}}const nn="srgb",Ts="srgb-linear",Od=3001,Fx=3e3;class Yh extends fn{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register(function(t){return new Nx(t)}),this.register(function(t){return new Gx(t)}),this.register(function(t){return new Jx(t)}),this.register(function(t){return new qx(t)}),this.register(function(t){return new Xx(t)}),this.register(function(t){return new Hx(t)}),this.register(function(t){return new Kx(t)}),this.register(function(t){return new Vx(t)}),this.register(function(t){return new Yx(t)}),this.register(function(t){return new Qx(t)}),this.register(function(t){return new $x(t)}),this.register(function(t){return new zx(t)}),this.register(function(t){return new jx(t)}),this.register(function(t){return new Wx(t)}),this.register(function(t){return new Ox(t)}),this.register(function(t){return new Zx(t)}),this.register(function(t){return new e4(t)})}load(e,t,i,s){const r=this;let o;if(this.resourcePath!=="")o=this.resourcePath;else if(this.path!==""){const l=ar.extractUrlBase(e);o=ar.resolveURL(l,this.path)}else o=ar.extractUrlBase(e);this.manager.itemStart(e);const a=function(l){s?s(l):console.error(l),r.manager.itemError(e),r.manager.itemEnd(e)},c=new ss(this.manager);c.setPath(this.path),c.setResponseType("arraybuffer"),c.setRequestHeader(this.requestHeader),c.setWithCredentials(this.withCredentials),c.load(e,function(l){try{r.parse(l,o,function(u){t(u),r.manager.itemEnd(e)},a)}catch(u){a(u)}},i,a)}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return this.pluginCallbacks.indexOf(e)===-1&&this.pluginCallbacks.push(e),this}unregister(e){return this.pluginCallbacks.indexOf(e)!==-1&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,i,s){let r;const o={},a={};if(typeof e=="string")r=JSON.parse(e);else if(e instanceof ArrayBuffer)if(mr(new Uint8Array(e.slice(0,4)))===W1){try{o[Ue.KHR_BINARY_GLTF]=new t4(e)}catch(u){s&&s(u);return}r=JSON.parse(o[Ue.KHR_BINARY_GLTF].content)}else r=JSON.parse(mr(new Uint8Array(e)));else r=e;if(r.asset===void 0||r.asset.version[0]<2){s&&s(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));return}const c=new A4(r,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});c.fileLoader.setRequestHeader(this.requestHeader);for(let l=0;l<this.pluginCallbacks.length;l++){const u=this.pluginCallbacks[l](c);u.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),a[u.name]=u,o[u.name]=!0}if(r.extensionsUsed)for(let l=0;l<r.extensionsUsed.length;++l){const u=r.extensionsUsed[l],h=r.extensionsRequired||[];switch(u){case Ue.KHR_MATERIALS_UNLIT:o[u]=new Ux;break;case Ue.KHR_DRACO_MESH_COMPRESSION:o[u]=new i4(r,this.dracoLoader);break;case Ue.KHR_TEXTURE_TRANSFORM:o[u]=new s4;break;case Ue.KHR_MESH_QUANTIZATION:o[u]=new n4;break;default:h.indexOf(u)>=0&&a[u]===void 0&&console.warn('THREE.GLTFLoader: Unknown extension "'+u+'".')}}c.setExtensions(o),c.setPlugins(a),c.parse(i,s)}parseAsync(e,t){const i=this;return new Promise(function(s,r){i.parse(e,t,s,r)})}}function kx(){let n={};return{get:function(e){return n[e]},add:function(e,t){n[e]=t},remove:function(e){delete n[e]},removeAll:function(){n={}}}}const Ue={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class Ox{constructor(e){this.parser=e,this.name=Ue.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let i=0,s=t.length;i<s;i++){const r=t[i];r.extensions&&r.extensions[this.name]&&r.extensions[this.name].light!==void 0&&e._addNodeRef(this.cache,r.extensions[this.name].light)}}_loadLight(e){const t=this.parser,i="light:"+e;let s=t.cache.get(i);if(s)return s;const r=t.json,c=((r.extensions&&r.extensions[this.name]||{}).lights||[])[e];let l;const u=new xe(16777215);c.color!==void 0&&u.setRGB(c.color[0],c.color[1],c.color[2],Ts);const h=c.range!==void 0?c.range:0;switch(c.type){case"directional":l=new t1(u),l.target.position.set(0,0,-1),l.add(l.target);break;case"point":l=new zu(u),l.distance=h;break;case"spot":l=new e1(u),l.distance=h,c.spot=c.spot||{},c.spot.innerConeAngle=c.spot.innerConeAngle!==void 0?c.spot.innerConeAngle:0,c.spot.outerConeAngle=c.spot.outerConeAngle!==void 0?c.spot.outerConeAngle:Math.PI/4,l.angle=c.spot.outerConeAngle,l.penumbra=1-c.spot.innerConeAngle/c.spot.outerConeAngle,l.target.position.set(0,0,-1),l.add(l.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+c.type)}return l.position.set(0,0,0),l.decay=2,ys(l,c),c.intensity!==void 0&&(l.intensity=c.intensity),l.name=t.createUniqueName(c.name||"light_"+e),s=Promise.resolve(l),t.cache.add(i,s),s}getDependency(e,t){if(e==="light")return this._loadLight(t)}createNodeAttachment(e){const t=this,i=this.parser,r=i.json.nodes[e],a=(r.extensions&&r.extensions[this.name]||{}).light;return a===void 0?null:this._loadLight(a).then(function(c){return i._getNodeRef(t.cache,a,c)})}}class Ux{constructor(){this.name=Ue.KHR_MATERIALS_UNLIT}getMaterialType(){return Cs}extendParams(e,t,i){const s=[];e.color=new xe(1,1,1),e.opacity=1;const r=t.pbrMetallicRoughness;if(r){if(Array.isArray(r.baseColorFactor)){const o=r.baseColorFactor;e.color.setRGB(o[0],o[1],o[2],Ts),e.opacity=o[3]}r.baseColorTexture!==void 0&&s.push(i.assignTexture(e,"map",r.baseColorTexture,nn))}return Promise.all(s)}}class Qx{constructor(e){this.parser=e,this.name=Ue.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const r=s.extensions[this.name].emissiveStrength;return r!==void 0&&(t.emissiveIntensity=r),Promise.resolve()}}class Nx{constructor(e){this.parser=e,this.name=Ue.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:bi}extendMaterialParams(e,t){const i=this.parser,s=i.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const r=[],o=s.extensions[this.name];if(o.clearcoatFactor!==void 0&&(t.clearcoat=o.clearcoatFactor),o.clearcoatTexture!==void 0&&r.push(i.assignTexture(t,"clearcoatMap",o.clearcoatTexture)),o.clearcoatRoughnessFactor!==void 0&&(t.clearcoatRoughness=o.clearcoatRoughnessFactor),o.clearcoatRoughnessTexture!==void 0&&r.push(i.assignTexture(t,"clearcoatRoughnessMap",o.clearcoatRoughnessTexture)),o.clearcoatNormalTexture!==void 0&&(r.push(i.assignTexture(t,"clearcoatNormalMap",o.clearcoatNormalTexture)),o.clearcoatNormalTexture.scale!==void 0)){const a=o.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new de(a,a)}return Promise.all(r)}}class Gx{constructor(e){this.parser=e,this.name=Ue.KHR_MATERIALS_DISPERSION}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:bi}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const r=s.extensions[this.name];return t.dispersion=r.dispersion!==void 0?r.dispersion:0,Promise.resolve()}}class zx{constructor(e){this.parser=e,this.name=Ue.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:bi}extendMaterialParams(e,t){const i=this.parser,s=i.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const r=[],o=s.extensions[this.name];return o.iridescenceFactor!==void 0&&(t.iridescence=o.iridescenceFactor),o.iridescenceTexture!==void 0&&r.push(i.assignTexture(t,"iridescenceMap",o.iridescenceTexture)),o.iridescenceIor!==void 0&&(t.iridescenceIOR=o.iridescenceIor),t.iridescenceThicknessRange===void 0&&(t.iridescenceThicknessRange=[100,400]),o.iridescenceThicknessMinimum!==void 0&&(t.iridescenceThicknessRange[0]=o.iridescenceThicknessMinimum),o.iridescenceThicknessMaximum!==void 0&&(t.iridescenceThicknessRange[1]=o.iridescenceThicknessMaximum),o.iridescenceThicknessTexture!==void 0&&r.push(i.assignTexture(t,"iridescenceThicknessMap",o.iridescenceThicknessTexture)),Promise.all(r)}}class Hx{constructor(e){this.parser=e,this.name=Ue.KHR_MATERIALS_SHEEN}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:bi}extendMaterialParams(e,t){const i=this.parser,s=i.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const r=[];t.sheenColor=new xe(0,0,0),t.sheenRoughness=0,t.sheen=1;const o=s.extensions[this.name];if(o.sheenColorFactor!==void 0){const a=o.sheenColorFactor;t.sheenColor.setRGB(a[0],a[1],a[2],Ts)}return o.sheenRoughnessFactor!==void 0&&(t.sheenRoughness=o.sheenRoughnessFactor),o.sheenColorTexture!==void 0&&r.push(i.assignTexture(t,"sheenColorMap",o.sheenColorTexture,nn)),o.sheenRoughnessTexture!==void 0&&r.push(i.assignTexture(t,"sheenRoughnessMap",o.sheenRoughnessTexture)),Promise.all(r)}}class Kx{constructor(e){this.parser=e,this.name=Ue.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:bi}extendMaterialParams(e,t){const i=this.parser,s=i.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const r=[],o=s.extensions[this.name];return o.transmissionFactor!==void 0&&(t.transmission=o.transmissionFactor),o.transmissionTexture!==void 0&&r.push(i.assignTexture(t,"transmissionMap",o.transmissionTexture)),Promise.all(r)}}class Vx{constructor(e){this.parser=e,this.name=Ue.KHR_MATERIALS_VOLUME}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:bi}extendMaterialParams(e,t){const i=this.parser,s=i.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const r=[],o=s.extensions[this.name];t.thickness=o.thicknessFactor!==void 0?o.thicknessFactor:0,o.thicknessTexture!==void 0&&r.push(i.assignTexture(t,"thicknessMap",o.thicknessTexture)),t.attenuationDistance=o.attenuationDistance||1/0;const a=o.attenuationColor||[1,1,1];return t.attenuationColor=new xe().setRGB(a[0],a[1],a[2],Ts),Promise.all(r)}}class Yx{constructor(e){this.parser=e,this.name=Ue.KHR_MATERIALS_IOR}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:bi}extendMaterialParams(e,t){const s=this.parser.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const r=s.extensions[this.name];return t.ior=r.ior!==void 0?r.ior:1.5,Promise.resolve()}}class $x{constructor(e){this.parser=e,this.name=Ue.KHR_MATERIALS_SPECULAR}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:bi}extendMaterialParams(e,t){const i=this.parser,s=i.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const r=[],o=s.extensions[this.name];t.specularIntensity=o.specularFactor!==void 0?o.specularFactor:1,o.specularTexture!==void 0&&r.push(i.assignTexture(t,"specularIntensityMap",o.specularTexture));const a=o.specularColorFactor||[1,1,1];return t.specularColor=new xe().setRGB(a[0],a[1],a[2],Ts),o.specularColorTexture!==void 0&&r.push(i.assignTexture(t,"specularColorMap",o.specularColorTexture,nn)),Promise.all(r)}}class Wx{constructor(e){this.parser=e,this.name=Ue.EXT_MATERIALS_BUMP}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:bi}extendMaterialParams(e,t){const i=this.parser,s=i.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const r=[],o=s.extensions[this.name];return t.bumpScale=o.bumpFactor!==void 0?o.bumpFactor:1,o.bumpTexture!==void 0&&r.push(i.assignTexture(t,"bumpMap",o.bumpTexture)),Promise.all(r)}}class jx{constructor(e){this.parser=e,this.name=Ue.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const i=this.parser.json.materials[e];return!i.extensions||!i.extensions[this.name]?null:bi}extendMaterialParams(e,t){const i=this.parser,s=i.json.materials[e];if(!s.extensions||!s.extensions[this.name])return Promise.resolve();const r=[],o=s.extensions[this.name];return o.anisotropyStrength!==void 0&&(t.anisotropy=o.anisotropyStrength),o.anisotropyRotation!==void 0&&(t.anisotropyRotation=o.anisotropyRotation),o.anisotropyTexture!==void 0&&r.push(i.assignTexture(t,"anisotropyMap",o.anisotropyTexture)),Promise.all(r)}}class Jx{constructor(e){this.parser=e,this.name=Ue.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,i=t.json,s=i.textures[e];if(!s.extensions||!s.extensions[this.name])return null;const r=s.extensions[this.name],o=t.options.ktx2Loader;if(!o){if(i.extensionsRequired&&i.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,r.source,o)}}class qx{constructor(e){this.parser=e,this.name=Ue.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,i=this.parser,s=i.json,r=s.textures[e];if(!r.extensions||!r.extensions[t])return null;const o=r.extensions[t],a=s.images[o.source];let c=i.textureLoader;if(a.uri){const l=i.options.manager.getHandler(a.uri);l!==null&&(c=l)}return this.detectSupport().then(function(l){if(l)return i.loadTextureImage(e,o.source,c);if(s.extensionsRequired&&s.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return i.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(t.height===1)}})),this.isSupported}}class Xx{constructor(e){this.parser=e,this.name=Ue.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(e){const t=this.name,i=this.parser,s=i.json,r=s.textures[e];if(!r.extensions||!r.extensions[t])return null;const o=r.extensions[t],a=s.images[o.source];let c=i.textureLoader;if(a.uri){const l=i.options.manager.getHandler(a.uri);l!==null&&(c=l)}return this.detectSupport().then(function(l){if(l)return i.loadTextureImage(e,o.source,c);if(s.extensionsRequired&&s.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return i.loadTexture(e)})}detectSupport(){return this.isSupported||(this.isSupported=new Promise(function(e){const t=new Image;t.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",t.onload=t.onerror=function(){e(t.height===1)}})),this.isSupported}}class Zx{constructor(e){this.name=Ue.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,i=t.bufferViews[e];if(i.extensions&&i.extensions[this.name]){const s=i.extensions[this.name],r=this.parser.getDependency("buffer",s.buffer),o=this.parser.options.meshoptDecoder;if(!o||!o.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return r.then(function(a){const c=s.byteOffset||0,l=s.byteLength||0,u=s.count,h=s.byteStride,f=new Uint8Array(a,c,l);return o.decodeGltfBufferAsync?o.decodeGltfBufferAsync(u,h,f,s.mode,s.filter).then(function(d){return d.buffer}):o.ready.then(function(){const d=new ArrayBuffer(u*h);return o.decodeGltfBuffer(new Uint8Array(d),u,h,f,s.mode,s.filter),d})})}else return null}}class e4{constructor(e){this.name=Ue.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,i=t.nodes[e];if(!i.extensions||!i.extensions[this.name]||i.mesh===void 0)return null;const s=t.meshes[i.mesh];for(const l of s.primitives)if(l.mode!==vi.TRIANGLES&&l.mode!==vi.TRIANGLE_STRIP&&l.mode!==vi.TRIANGLE_FAN&&l.mode!==void 0)return null;const o=i.extensions[this.name].attributes,a=[],c={};for(const l in o)a.push(this.parser.getDependency("accessor",o[l]).then(u=>(c[l]=u,c[l])));return a.length<1?null:(a.push(this.parser.createNodeMesh(e)),Promise.all(a).then(l=>{const u=l.pop(),h=u.isGroup?u.children:[u],f=l[0].count,d=[];for(const p of h){const m=new ce,g=new b,y=new Be,v=new b(1,1,1),E=new Rh(p.geometry,p.material,f);for(let C=0;C<f;C++)c.TRANSLATION&&g.fromBufferAttribute(c.TRANSLATION,C),c.ROTATION&&y.fromBufferAttribute(c.ROTATION,C),c.SCALE&&v.fromBufferAttribute(c.SCALE,C),E.setMatrixAt(C,m.compose(g,y,v));for(const C in c)if(C==="_COLOR_0"){const x=c[C];E.instanceColor=new lc(x.array,x.itemSize,x.normalized)}else C!=="TRANSLATION"&&C!=="ROTATION"&&C!=="SCALE"&&p.geometry.setAttribute(C,c[C]);lt.prototype.copy.call(E,p),this.parser.assignFinalMaterial(E),d.push(E)}return u.isGroup?(u.clear(),u.add(...d),u):d[0]}))}}const W1="glTF",Qr=12,Ud={JSON:1313821514,BIN:5130562};class t4{constructor(e){this.name=Ue.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,Qr);if(this.header={magic:mr(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==W1)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const i=this.header.length-Qr,s=new DataView(e,Qr);let r=0;for(;r<i;){const o=s.getUint32(r,!0);r+=4;const a=s.getUint32(r,!0);if(r+=4,a===Ud.JSON){const c=new Uint8Array(e,Qr+r,o);this.content=mr(c)}else if(a===Ud.BIN){const c=Qr+r;this.body=e.slice(c,c+o)}r+=o}if(this.content===null)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class i4{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=Ue.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const i=this.json,s=this.dracoLoader,r=e.extensions[this.name].bufferView,o=e.extensions[this.name].attributes,a={},c={},l={};for(const u in o){const h=eh[u]||u.toLowerCase();a[h]=o[u]}for(const u in e.attributes){const h=eh[u]||u.toLowerCase();if(o[u]!==void 0){const f=i.accessors[e.attributes[u]],d=hr[f.componentType];l[h]=d.name,c[h]=f.normalized===!0}}return t.getDependency("bufferView",r).then(function(u){return new Promise(function(h,f){s.decodeDracoFile(u,function(d){for(const p in d.attributes){const m=d.attributes[p],g=c[p];g!==void 0&&(m.normalized=g)}h(d)},a,l,Ts,f)})})}}class s4{constructor(){this.name=Ue.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return(t.texCoord===void 0||t.texCoord===e.channel)&&t.offset===void 0&&t.rotation===void 0&&t.scale===void 0||(e=e.clone(),t.texCoord!==void 0&&(e.channel=t.texCoord),t.offset!==void 0&&e.offset.fromArray(t.offset),t.rotation!==void 0&&(e.rotation=t.rotation),t.scale!==void 0&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class n4{constructor(){this.name=Ue.KHR_MESH_QUANTIZATION}}class j1 extends dy{constructor(e,t,i,s){super(e,t,i,s)}copySampleValue_(e){const t=this.resultBuffer,i=this.sampleValues,s=this.valueSize,r=e*s*3+s;for(let o=0;o!==s;o++)t[o]=i[r+o];return t}interpolate_(e,t,i,s){const r=this.resultBuffer,o=this.sampleValues,a=this.valueSize,c=a*2,l=a*3,u=s-t,h=(i-t)/u,f=h*h,d=f*h,p=e*l,m=p-l,g=-2*d+3*f,y=d-f,v=1-g,E=y-f+h;for(let C=0;C!==a;C++){const x=o[m+C+a],I=o[m+C+c]*u,S=o[p+C+a],w=o[p+C]*u;r[C]=v*x+E*I+g*S+y*w}return r}}const r4=new Be;class o4 extends j1{interpolate_(e,t,i,s){const r=super.interpolate_(e,t,i,s);return r4.fromArray(r).normalize().toArray(r),r}}const vi={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},hr={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},Qd={9728:Xe,9729:zt,9984:cy,9985:ly,9986:uy,9987:Po},Nd={33071:Ro,33648:hy,10497:ui},ul={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},eh={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",...Hh>=152?{TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3"}:{TEXCOORD_0:"uv",TEXCOORD_1:"uv2"},COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},Rs={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},a4={CUBICSPLINE:void 0,LINEAR:n1,STEP:fy},hl={OPAQUE:"OPAQUE",MASK:"MASK",BLEND:"BLEND"};function c4(n){return n.DefaultMaterial===void 0&&(n.DefaultMaterial=new Rc({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:Do})),n.DefaultMaterial}function js(n,e,t){for(const i in t.extensions)n[i]===void 0&&(e.userData.gltfExtensions=e.userData.gltfExtensions||{},e.userData.gltfExtensions[i]=t.extensions[i])}function ys(n,e){e.extras!==void 0&&(typeof e.extras=="object"?Object.assign(n.userData,e.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+e.extras))}function l4(n,e,t){let i=!1,s=!1,r=!1;for(let l=0,u=e.length;l<u;l++){const h=e[l];if(h.POSITION!==void 0&&(i=!0),h.NORMAL!==void 0&&(s=!0),h.COLOR_0!==void 0&&(r=!0),i&&s&&r)break}if(!i&&!s&&!r)return Promise.resolve(n);const o=[],a=[],c=[];for(let l=0,u=e.length;l<u;l++){const h=e[l];if(i){const f=h.POSITION!==void 0?t.getDependency("accessor",h.POSITION):n.attributes.position;o.push(f)}if(s){const f=h.NORMAL!==void 0?t.getDependency("accessor",h.NORMAL):n.attributes.normal;a.push(f)}if(r){const f=h.COLOR_0!==void 0?t.getDependency("accessor",h.COLOR_0):n.attributes.color;c.push(f)}}return Promise.all([Promise.all(o),Promise.all(a),Promise.all(c)]).then(function(l){const u=l[0],h=l[1],f=l[2];return i&&(n.morphAttributes.position=u),s&&(n.morphAttributes.normal=h),r&&(n.morphAttributes.color=f),n.morphTargetsRelative=!0,n})}function u4(n,e){if(n.updateMorphTargets(),e.weights!==void 0)for(let t=0,i=e.weights.length;t<i;t++)n.morphTargetInfluences[t]=e.weights[t];if(e.extras&&Array.isArray(e.extras.targetNames)){const t=e.extras.targetNames;if(n.morphTargetInfluences.length===t.length){n.morphTargetDictionary={};for(let i=0,s=t.length;i<s;i++)n.morphTargetDictionary[t[i]]=i}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function h4(n){let e;const t=n.extensions&&n.extensions[Ue.KHR_DRACO_MESH_COMPRESSION];if(t?e="draco:"+t.bufferView+":"+t.indices+":"+fl(t.attributes):e=n.indices+":"+fl(n.attributes)+":"+n.mode,n.targets!==void 0)for(let i=0,s=n.targets.length;i<s;i++)e+=":"+fl(n.targets[i]);return e}function fl(n){let e="";const t=Object.keys(n).sort();for(let i=0,s=t.length;i<s;i++)e+=t[i]+":"+n[t[i]]+";";return e}function th(n){switch(n){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}function f4(n){return n.search(/\.jpe?g($|\?)/i)>0||n.search(/^data\:image\/jpeg/)===0?"image/jpeg":n.search(/\.webp($|\?)/i)>0||n.search(/^data\:image\/webp/)===0?"image/webp":"image/png"}const d4=new ce;class A4{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new kx,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let i=!1,s=!1,r=-1;typeof navigator<"u"&&typeof navigator.userAgent<"u"&&(i=/^((?!chrome|android).)*safari/i.test(navigator.userAgent)===!0,s=navigator.userAgent.indexOf("Firefox")>-1,r=s?navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]:-1),typeof createImageBitmap>"u"||i||s&&r<98?this.textureLoader=new Bs(this.options.manager):this.textureLoader=new sy(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new ss(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),this.options.crossOrigin==="use-credentials"&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const i=this,s=this.json,r=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll(function(o){return o._markDefs&&o._markDefs()}),Promise.all(this._invokeAll(function(o){return o.beforeRoot&&o.beforeRoot()})).then(function(){return Promise.all([i.getDependencies("scene"),i.getDependencies("animation"),i.getDependencies("camera")])}).then(function(o){const a={scene:o[0][s.scene||0],scenes:o[0],animations:o[1],cameras:o[2],asset:s.asset,parser:i,userData:{}};return js(r,a,s),ys(a,s),Promise.all(i._invokeAll(function(c){return c.afterRoot&&c.afterRoot(a)})).then(function(){for(const c of a.scenes)c.updateMatrixWorld();e(a)})}).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],i=this.json.meshes||[];for(let s=0,r=t.length;s<r;s++){const o=t[s].joints;for(let a=0,c=o.length;a<c;a++)e[o[a]].isBone=!0}for(let s=0,r=e.length;s<r;s++){const o=e[s];o.mesh!==void 0&&(this._addNodeRef(this.meshCache,o.mesh),o.skin!==void 0&&(i[o.mesh].isSkinnedMesh=!0)),o.camera!==void 0&&this._addNodeRef(this.cameraCache,o.camera)}}_addNodeRef(e,t){t!==void 0&&(e.refs[t]===void 0&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,i){if(e.refs[t]<=1)return i;const s=i.clone(),r=(o,a)=>{const c=this.associations.get(o);c!=null&&this.associations.set(a,c);for(const[l,u]of o.children.entries())r(u,a.children[l])};return r(i,s),s.name+="_instance_"+e.uses[t]++,s}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let i=0;i<t.length;i++){const s=e(t[i]);if(s)return s}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const i=[];for(let s=0;s<t.length;s++){const r=e(t[s]);r&&i.push(r)}return i}getDependency(e,t){const i=e+":"+t;let s=this.cache.get(i);if(!s){switch(e){case"scene":s=this.loadScene(t);break;case"node":s=this._invokeOne(function(r){return r.loadNode&&r.loadNode(t)});break;case"mesh":s=this._invokeOne(function(r){return r.loadMesh&&r.loadMesh(t)});break;case"accessor":s=this.loadAccessor(t);break;case"bufferView":s=this._invokeOne(function(r){return r.loadBufferView&&r.loadBufferView(t)});break;case"buffer":s=this.loadBuffer(t);break;case"material":s=this._invokeOne(function(r){return r.loadMaterial&&r.loadMaterial(t)});break;case"texture":s=this._invokeOne(function(r){return r.loadTexture&&r.loadTexture(t)});break;case"skin":s=this.loadSkin(t);break;case"animation":s=this._invokeOne(function(r){return r.loadAnimation&&r.loadAnimation(t)});break;case"camera":s=this.loadCamera(t);break;default:if(s=this._invokeOne(function(r){return r!=this&&r.getDependency&&r.getDependency(e,t)}),!s)throw new Error("Unknown type: "+e);break}this.cache.add(i,s)}return s}getDependencies(e){let t=this.cache.get(e);if(!t){const i=this,s=this.json[e+(e==="mesh"?"es":"s")]||[];t=Promise.all(s.map(function(r,o){return i.getDependency(e,o)})),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],i=this.fileLoader;if(t.type&&t.type!=="arraybuffer")throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(t.uri===void 0&&e===0)return Promise.resolve(this.extensions[Ue.KHR_BINARY_GLTF].body);const s=this.options;return new Promise(function(r,o){i.load(ar.resolveURL(t.uri,s.path),r,void 0,function(){o(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))})})}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then(function(i){const s=t.byteLength||0,r=t.byteOffset||0;return i.slice(r,r+s)})}loadAccessor(e){const t=this,i=this.json,s=this.json.accessors[e];if(s.bufferView===void 0&&s.sparse===void 0){const o=ul[s.type],a=hr[s.componentType],c=s.normalized===!0,l=new a(s.count*o);return Promise.resolve(new Ye(l,o,c))}const r=[];return s.bufferView!==void 0?r.push(this.getDependency("bufferView",s.bufferView)):r.push(null),s.sparse!==void 0&&(r.push(this.getDependency("bufferView",s.sparse.indices.bufferView)),r.push(this.getDependency("bufferView",s.sparse.values.bufferView))),Promise.all(r).then(function(o){const a=o[0],c=ul[s.type],l=hr[s.componentType],u=l.BYTES_PER_ELEMENT,h=u*c,f=s.byteOffset||0,d=s.bufferView!==void 0?i.bufferViews[s.bufferView].byteStride:void 0,p=s.normalized===!0;let m,g;if(d&&d!==h){const y=Math.floor(f/d),v="InterleavedBuffer:"+s.bufferView+":"+s.componentType+":"+y+":"+s.count;let E=t.cache.get(v);E||(m=new l(a,y*d,s.count*d/u),E=new ny(m,d/u),t.cache.add(v,E)),g=new tn(E,c,f%d/u,p)}else a===null?m=new l(s.count*c):m=new l(a,f,s.count*c),g=new Ye(m,c,p);if(s.sparse!==void 0){const y=ul.SCALAR,v=hr[s.sparse.indices.componentType],E=s.sparse.indices.byteOffset||0,C=s.sparse.values.byteOffset||0,x=new v(o[1],E,s.sparse.count*y),I=new l(o[2],C,s.sparse.count*c);a!==null&&(g=new Ye(g.array.slice(),g.itemSize,g.normalized));for(let S=0,w=x.length;S<w;S++){const B=x[S];if(g.setX(B,I[S*c]),c>=2&&g.setY(B,I[S*c+1]),c>=3&&g.setZ(B,I[S*c+2]),c>=4&&g.setW(B,I[S*c+3]),c>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return g})}loadTexture(e){const t=this.json,i=this.options,r=t.textures[e].source,o=t.images[r];let a=this.textureLoader;if(o.uri){const c=i.manager.getHandler(o.uri);c!==null&&(a=c)}return this.loadTextureImage(e,r,a)}loadTextureImage(e,t,i){const s=this,r=this.json,o=r.textures[e],a=r.images[t],c=(a.uri||a.bufferView)+":"+o.sampler;if(this.textureCache[c])return this.textureCache[c];const l=this.loadImageSource(t,i).then(function(u){u.flipY=!1,u.name=o.name||a.name||"",u.name===""&&typeof a.uri=="string"&&a.uri.startsWith("data:image/")===!1&&(u.name=a.uri);const f=(r.samplers||{})[o.sampler]||{};return u.magFilter=Qd[f.magFilter]||zt,u.minFilter=Qd[f.minFilter]||Po,u.wrapS=Nd[f.wrapS]||ui,u.wrapT=Nd[f.wrapT]||ui,s.associations.set(u,{textures:e}),u}).catch(function(){return null});return this.textureCache[c]=l,l}loadImageSource(e,t){const i=this,s=this.json,r=this.options;if(this.sourceCache[e]!==void 0)return this.sourceCache[e].then(h=>h.clone());const o=s.images[e],a=self.URL||self.webkitURL;let c=o.uri||"",l=!1;if(o.bufferView!==void 0)c=i.getDependency("bufferView",o.bufferView).then(function(h){l=!0;const f=new Blob([h],{type:o.mimeType});return c=a.createObjectURL(f),c});else if(o.uri===void 0)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const u=Promise.resolve(c).then(function(h){return new Promise(function(f,d){let p=f;t.isImageBitmapLoader===!0&&(p=function(m){const g=new as(m);g.needsUpdate=!0,f(g)}),t.load(ar.resolveURL(h,r.path),p,void 0,d)})}).then(function(h){return l===!0&&a.revokeObjectURL(c),ys(h,o),h.userData.mimeType=o.mimeType||f4(o.uri),h}).catch(function(h){throw console.error("THREE.GLTFLoader: Couldn't load texture",c),h});return this.sourceCache[e]=u,u}assignTexture(e,t,i,s){const r=this;return this.getDependency("texture",i.index).then(function(o){if(!o)return null;if(i.texCoord!==void 0&&i.texCoord>0&&(o=o.clone(),o.channel=i.texCoord),r.extensions[Ue.KHR_TEXTURE_TRANSFORM]){const a=i.extensions!==void 0?i.extensions[Ue.KHR_TEXTURE_TRANSFORM]:void 0;if(a){const c=r.associations.get(o);o=r.extensions[Ue.KHR_TEXTURE_TRANSFORM].extendTexture(o,a),r.associations.set(o,c)}}return s!==void 0&&(typeof s=="number"&&(s=s===Od?nn:Ts),"colorSpace"in o?o.colorSpace=s:o.encoding=s===nn?Od:Fx),e[t]=o,o})}assignFinalMaterial(e){const t=e.geometry;let i=e.material;const s=t.attributes.tangent===void 0,r=t.attributes.color!==void 0,o=t.attributes.normal===void 0;if(e.isPoints){const a="PointsMaterial:"+i.uuid;let c=this.cache.get(a);c||(c=new i1,$a.prototype.copy.call(c,i),c.color.copy(i.color),c.map=i.map,c.sizeAttenuation=!1,this.cache.add(a,c)),i=c}else if(e.isLine){const a="LineBasicMaterial:"+i.uuid;let c=this.cache.get(a);c||(c=new or,$a.prototype.copy.call(c,i),c.color.copy(i.color),c.map=i.map,this.cache.add(a,c)),i=c}if(s||r||o){let a="ClonedMaterial:"+i.uuid+":";s&&(a+="derivative-tangents:"),r&&(a+="vertex-colors:"),o&&(a+="flat-shading:");let c=this.cache.get(a);c||(c=i.clone(),r&&(c.vertexColors=!0),o&&(c.flatShading=!0),s&&(c.normalScale&&(c.normalScale.y*=-1),c.clearcoatNormalScale&&(c.clearcoatNormalScale.y*=-1)),this.cache.add(a,c),this.associations.set(c,this.associations.get(i))),i=c}e.material=i}getMaterialType(){return Rc}loadMaterial(e){const t=this,i=this.json,s=this.extensions,r=i.materials[e];let o;const a={},c=r.extensions||{},l=[];if(c[Ue.KHR_MATERIALS_UNLIT]){const h=s[Ue.KHR_MATERIALS_UNLIT];o=h.getMaterialType(),l.push(h.extendParams(a,r,t))}else{const h=r.pbrMetallicRoughness||{};if(a.color=new xe(1,1,1),a.opacity=1,Array.isArray(h.baseColorFactor)){const f=h.baseColorFactor;a.color.setRGB(f[0],f[1],f[2],Ts),a.opacity=f[3]}h.baseColorTexture!==void 0&&l.push(t.assignTexture(a,"map",h.baseColorTexture,nn)),a.metalness=h.metallicFactor!==void 0?h.metallicFactor:1,a.roughness=h.roughnessFactor!==void 0?h.roughnessFactor:1,h.metallicRoughnessTexture!==void 0&&(l.push(t.assignTexture(a,"metalnessMap",h.metallicRoughnessTexture)),l.push(t.assignTexture(a,"roughnessMap",h.metallicRoughnessTexture))),o=this._invokeOne(function(f){return f.getMaterialType&&f.getMaterialType(e)}),l.push(Promise.all(this._invokeAll(function(f){return f.extendMaterialParams&&f.extendMaterialParams(e,a)})))}r.doubleSided===!0&&(a.side=Tt);const u=r.alphaMode||hl.OPAQUE;if(u===hl.BLEND?(a.transparent=!0,a.depthWrite=!1):(a.transparent=!1,u===hl.MASK&&(a.alphaTest=r.alphaCutoff!==void 0?r.alphaCutoff:.5)),r.normalTexture!==void 0&&o!==Cs&&(l.push(t.assignTexture(a,"normalMap",r.normalTexture)),a.normalScale=new de(1,1),r.normalTexture.scale!==void 0)){const h=r.normalTexture.scale;a.normalScale.set(h,h)}if(r.occlusionTexture!==void 0&&o!==Cs&&(l.push(t.assignTexture(a,"aoMap",r.occlusionTexture)),r.occlusionTexture.strength!==void 0&&(a.aoMapIntensity=r.occlusionTexture.strength)),r.emissiveFactor!==void 0&&o!==Cs){const h=r.emissiveFactor;a.emissive=new xe().setRGB(h[0],h[1],h[2],Ts)}return r.emissiveTexture!==void 0&&o!==Cs&&l.push(t.assignTexture(a,"emissiveMap",r.emissiveTexture,nn)),Promise.all(l).then(function(){const h=new o(a);return r.name&&(h.name=r.name),ys(h,r),t.associations.set(h,{materials:e}),r.extensions&&js(s,h,r),h})}createUniqueName(e){const t=bo.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,i=this.extensions,s=this.primitiveCache;function r(a){return i[Ue.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(a,t).then(function(c){return Gd(c,a,t)})}const o=[];for(let a=0,c=e.length;a<c;a++){const l=e[a],u=h4(l),h=s[u];if(h)o.push(h.promise);else{let f;l.extensions&&l.extensions[Ue.KHR_DRACO_MESH_COMPRESSION]?f=r(l):f=Gd(new St,l,t),s[u]={primitive:l,promise:f},o.push(f)}}return Promise.all(o)}loadMesh(e){const t=this,i=this.json,s=this.extensions,r=i.meshes[e],o=r.primitives,a=[];for(let c=0,l=o.length;c<l;c++){const u=o[c].material===void 0?c4(this.cache):this.getDependency("material",o[c].material);a.push(u)}return a.push(t.loadGeometries(o)),Promise.all(a).then(function(c){const l=c.slice(0,c.length-1),u=c[c.length-1],h=[];for(let d=0,p=u.length;d<p;d++){const m=u[d],g=o[d];let y;const v=l[d];if(g.mode===vi.TRIANGLES||g.mode===vi.TRIANGLE_STRIP||g.mode===vi.TRIANGLE_FAN||g.mode===void 0)y=r.isSkinnedMesh===!0?new Mh(m,v):new ye(m,v),y.isSkinnedMesh===!0&&y.normalizeSkinWeights(),g.mode===vi.TRIANGLE_STRIP?y.geometry=Dd(y.geometry,Jm):g.mode===vi.TRIANGLE_FAN&&(y.geometry=Dd(y.geometry,Gu));else if(g.mode===vi.LINES)y=new ry(m,v);else if(g.mode===vi.LINE_STRIP)y=new Qe(m,v);else if(g.mode===vi.LINE_LOOP)y=new oy(m,v);else if(g.mode===vi.POINTS)y=new ay(m,v);else throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+g.mode);Object.keys(y.geometry.morphAttributes).length>0&&u4(y,r),y.name=t.createUniqueName(r.name||"mesh_"+e),ys(y,r),g.extensions&&js(s,y,g),t.assignFinalMaterial(y),h.push(y)}for(let d=0,p=h.length;d<p;d++)t.associations.set(h[d],{meshes:e,primitives:d});if(h.length===1)return r.extensions&&js(s,h[0],r),h[0];const f=new ws;r.extensions&&js(s,f,r),t.associations.set(f,{meshes:e});for(let d=0,p=h.length;d<p;d++)f.add(h[d]);return f})}loadCamera(e){let t;const i=this.json.cameras[e],s=i[i.type];if(!s){console.warn("THREE.GLTFLoader: Missing camera parameters.");return}return i.type==="perspective"?t=new nt(Ce.radToDeg(s.yfov),s.aspectRatio||1,s.znear||1,s.zfar||2e6):i.type==="orthographic"&&(t=new vt(-s.xmag,s.xmag,s.ymag,-s.ymag,s.znear,s.zfar)),i.name&&(t.name=this.createUniqueName(i.name)),ys(t,i),Promise.resolve(t)}loadSkin(e){const t=this.json.skins[e],i=[];for(let s=0,r=t.joints.length;s<r;s++)i.push(this._loadNodeShallow(t.joints[s]));return t.inverseBindMatrices!==void 0?i.push(this.getDependency("accessor",t.inverseBindMatrices)):i.push(null),Promise.all(i).then(function(s){const r=s.pop(),o=s,a=[],c=[];for(let l=0,u=o.length;l<u;l++){const h=o[l];if(h){a.push(h);const f=new ce;r!==null&&f.fromArray(r.array,l*16),c.push(f)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[l])}return new s1(a,c)})}loadAnimation(e){const t=this.json,i=this,s=t.animations[e],r=s.name?s.name:"animation_"+e,o=[],a=[],c=[],l=[],u=[];for(let h=0,f=s.channels.length;h<f;h++){const d=s.channels[h],p=s.samplers[d.sampler],m=d.target,g=m.node,y=s.parameters!==void 0?s.parameters[p.input]:p.input,v=s.parameters!==void 0?s.parameters[p.output]:p.output;m.node!==void 0&&(o.push(this.getDependency("node",g)),a.push(this.getDependency("accessor",y)),c.push(this.getDependency("accessor",v)),l.push(p),u.push(m))}return Promise.all([Promise.all(o),Promise.all(a),Promise.all(c),Promise.all(l),Promise.all(u)]).then(function(h){const f=h[0],d=h[1],p=h[2],m=h[3],g=h[4],y=[];for(let v=0,E=f.length;v<E;v++){const C=f[v],x=d[v],I=p[v],S=m[v],w=g[v];if(C===void 0)continue;C.updateMatrix&&C.updateMatrix();const B=i._createAnimationTracks(C,x,I,S,w);if(B)for(let T=0;T<B.length;T++)y.push(B[T])}return new Dh(r,void 0,y)})}createNodeMesh(e){const t=this.json,i=this,s=t.nodes[e];return s.mesh===void 0?null:i.getDependency("mesh",s.mesh).then(function(r){const o=i._getNodeRef(i.meshCache,s.mesh,r);return s.weights!==void 0&&o.traverse(function(a){if(a.isMesh)for(let c=0,l=s.weights.length;c<l;c++)a.morphTargetInfluences[c]=s.weights[c]}),o})}loadNode(e){const t=this.json,i=this,s=t.nodes[e],r=i._loadNodeShallow(e),o=[],a=s.children||[];for(let l=0,u=a.length;l<u;l++)o.push(i.getDependency("node",a[l]));const c=s.skin===void 0?Promise.resolve(null):i.getDependency("skin",s.skin);return Promise.all([r,Promise.all(o),c]).then(function(l){const u=l[0],h=l[1],f=l[2];f!==null&&u.traverse(function(d){d.isSkinnedMesh&&d.bind(f,d4)});for(let d=0,p=h.length;d<p;d++)u.add(h[d]);return u})}_loadNodeShallow(e){const t=this.json,i=this.extensions,s=this;if(this.nodeCache[e]!==void 0)return this.nodeCache[e];const r=t.nodes[e],o=r.name?s.createUniqueName(r.name):"",a=[],c=s._invokeOne(function(l){return l.createNodeMesh&&l.createNodeMesh(e)});return c&&a.push(c),r.camera!==void 0&&a.push(s.getDependency("camera",r.camera).then(function(l){return s._getNodeRef(s.cameraCache,r.camera,l)})),s._invokeAll(function(l){return l.createNodeAttachment&&l.createNodeAttachment(e)}).forEach(function(l){a.push(l)}),this.nodeCache[e]=Promise.all(a).then(function(l){let u;if(r.isBone===!0?u=new Hu:l.length>1?u=new ws:l.length===1?u=l[0]:u=new lt,u!==l[0])for(let h=0,f=l.length;h<f;h++)u.add(l[h]);if(r.name&&(u.userData.name=r.name,u.name=o),ys(u,r),r.extensions&&js(i,u,r),r.matrix!==void 0){const h=new ce;h.fromArray(r.matrix),u.applyMatrix4(h)}else r.translation!==void 0&&u.position.fromArray(r.translation),r.rotation!==void 0&&u.quaternion.fromArray(r.rotation),r.scale!==void 0&&u.scale.fromArray(r.scale);return s.associations.has(u)||s.associations.set(u,{}),s.associations.get(u).nodes=e,u}),this.nodeCache[e]}loadScene(e){const t=this.extensions,i=this.json.scenes[e],s=this,r=new ws;i.name&&(r.name=s.createUniqueName(i.name)),ys(r,i),i.extensions&&js(t,r,i);const o=i.nodes||[],a=[];for(let c=0,l=o.length;c<l;c++)a.push(s.getDependency("node",o[c]));return Promise.all(a).then(function(c){for(let u=0,h=c.length;u<h;u++)r.add(c[u]);const l=u=>{const h=new Map;for(const[f,d]of s.associations)(f instanceof $a||f instanceof as)&&h.set(f,d);return u.traverse(f=>{const d=s.associations.get(f);d!=null&&h.set(f,d)}),h};return s.associations=l(r),r})}_createAnimationTracks(e,t,i,s,r){const o=[],a=e.name?e.name:e.uuid,c=[];Rs[r.path]===Rs.weights?e.traverse(function(f){f.morphTargetInfluences&&c.push(f.name?f.name:f.uuid)}):c.push(a);let l;switch(Rs[r.path]){case Rs.weights:l=Ku;break;case Rs.rotation:l=cc;break;case Rs.position:case Rs.scale:l=ac;break;default:switch(i.itemSize){case 1:l=Ku;break;case 2:case 3:default:l=ac;break}break}const u=s.interpolation!==void 0?a4[s.interpolation]:n1,h=this._getArrayFromAccessor(i);for(let f=0,d=c.length;f<d;f++){const p=new l(c[f]+"."+Rs[r.path],t.array,h,u);s.interpolation==="CUBICSPLINE"&&this._createCubicSplineTrackInterpolant(p),o.push(p)}return o}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const i=th(t.constructor),s=new Float32Array(t.length);for(let r=0,o=t.length;r<o;r++)s[r]=t[r]*i;t=s}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(i){const s=this instanceof cc?o4:j1;return new s(this.times,this.values,this.getValueSize()/3,i)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function m4(n,e,t){const i=e.attributes,s=new st;if(i.POSITION!==void 0){const a=t.json.accessors[i.POSITION],c=a.min,l=a.max;if(c!==void 0&&l!==void 0){if(s.set(new b(c[0],c[1],c[2]),new b(l[0],l[1],l[2])),a.normalized){const u=th(hr[a.componentType]);s.min.multiplyScalar(u),s.max.multiplyScalar(u)}}else{console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");return}}else return;const r=e.targets;if(r!==void 0){const a=new b,c=new b;for(let l=0,u=r.length;l<u;l++){const h=r[l];if(h.POSITION!==void 0){const f=t.json.accessors[h.POSITION],d=f.min,p=f.max;if(d!==void 0&&p!==void 0){if(c.setX(Math.max(Math.abs(d[0]),Math.abs(p[0]))),c.setY(Math.max(Math.abs(d[1]),Math.abs(p[1]))),c.setZ(Math.max(Math.abs(d[2]),Math.abs(p[2]))),f.normalized){const m=th(hr[f.componentType]);c.multiplyScalar(m)}a.max(c)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}s.expandByVector(a)}n.boundingBox=s;const o=new si;s.getCenter(o.center),o.radius=s.min.distanceTo(s.max)/2,n.boundingSphere=o}function Gd(n,e,t){const i=e.attributes,s=[];function r(o,a){return t.getDependency("accessor",o).then(function(c){n.setAttribute(a,c)})}for(const o in i){const a=eh[o]||o.toLowerCase();a in n.attributes||s.push(r(i[o],a))}if(e.indices!==void 0&&!n.index){const o=t.getDependency("accessor",e.indices).then(function(a){n.setIndex(a)});s.push(o)}return ys(n,e),m4(n,e,t),Promise.all(s).then(function(){return e.targets!==void 0?l4(n,e.targets,t):n})}class p4 extends St{constructor(e,t,i,s){super();const r=[],o=[],a=[],c=new b,l=new ce;l.makeRotationFromEuler(i),l.setPosition(t);const u=new ce;u.copy(l).invert(),h(),this.setAttribute("position",new Rt(r,3)),this.setAttribute("normal",new Rt(o,3)),this.setAttribute("uv",new Rt(a,2));function h(){let m,g=[];const y=new b,v=new b;if(e.geometry.isGeometry===!0){console.error("THREE.DecalGeometry no longer supports THREE.Geometry. Use BufferGeometry instead.");return}const E=e.geometry,C=E.attributes.position,x=E.attributes.normal;if(E.index!==null){const I=E.index;for(m=0;m<I.count;m++)y.fromBufferAttribute(C,I.getX(m)),v.fromBufferAttribute(x,I.getX(m)),f(g,y,v)}else for(m=0;m<C.count;m++)y.fromBufferAttribute(C,m),v.fromBufferAttribute(x,m),f(g,y,v);for(g=d(g,c.set(1,0,0)),g=d(g,c.set(-1,0,0)),g=d(g,c.set(0,1,0)),g=d(g,c.set(0,-1,0)),g=d(g,c.set(0,0,1)),g=d(g,c.set(0,0,-1)),m=0;m<g.length;m++){const I=g[m];a.push(.5+I.position.x/s.x,.5+I.position.y/s.y),I.position.applyMatrix4(l),r.push(I.position.x,I.position.y,I.position.z),o.push(I.normal.x,I.normal.y,I.normal.z)}}function f(m,g,y){g.applyMatrix4(e.matrixWorld),g.applyMatrix4(u),y.transformDirection(e.matrixWorld),m.push(new zd(g.clone(),y.clone()))}function d(m,g){const y=[],v=.5*Math.abs(s.dot(g));for(let E=0;E<m.length;E+=3){let C,x,I,S=0,w,B,T,R;const _=m[E+0].position.dot(g)-v,L=m[E+1].position.dot(g)-v,O=m[E+2].position.dot(g)-v;switch(C=_>0,x=L>0,I=O>0,S=(C?1:0)+(x?1:0)+(I?1:0),S){case 0:{y.push(m[E]),y.push(m[E+1]),y.push(m[E+2]);break}case 1:{if(C&&(w=m[E+1],B=m[E+2],T=p(m[E],w,g,v),R=p(m[E],B,g,v)),x){w=m[E],B=m[E+2],T=p(m[E+1],w,g,v),R=p(m[E+1],B,g,v),y.push(T),y.push(B.clone()),y.push(w.clone()),y.push(B.clone()),y.push(T.clone()),y.push(R);break}I&&(w=m[E],B=m[E+1],T=p(m[E+2],w,g,v),R=p(m[E+2],B,g,v)),y.push(w.clone()),y.push(B.clone()),y.push(T),y.push(R),y.push(T.clone()),y.push(B.clone());break}case 2:{C||(w=m[E].clone(),B=p(w,m[E+1],g,v),T=p(w,m[E+2],g,v),y.push(w),y.push(B),y.push(T)),x||(w=m[E+1].clone(),B=p(w,m[E+2],g,v),T=p(w,m[E],g,v),y.push(w),y.push(B),y.push(T)),I||(w=m[E+2].clone(),B=p(w,m[E],g,v),T=p(w,m[E+1],g,v),y.push(w),y.push(B),y.push(T));break}}}return y}function p(m,g,y,v){const E=m.position.dot(y)-v,C=g.position.dot(y)-v,x=E/(E-C);return new zd(new b(m.position.x+x*(g.position.x-m.position.x),m.position.y+x*(g.position.y-m.position.y),m.position.z+x*(g.position.z-m.position.z)),new b(m.normal.x+x*(g.normal.x-m.normal.x),m.normal.y+x*(g.normal.y-m.normal.y),m.normal.z+x*(g.normal.z-m.normal.z)))}}}class zd{constructor(e,t){this.position=e,this.normal=t}clone(){return new this.constructor(this.position.clone(),this.normal.clone())}}class g4 extends Ay{constructor(e,t={}){const{bevelEnabled:i=!1,bevelSize:s=8,bevelThickness:r=10,font:o,height:a=50,size:c=100,lineHeight:l=1,letterSpacing:u=0,...h}=t;if(o===void 0)super();else{const f=o.generateShapes(e,c,{lineHeight:l,letterSpacing:u});super(f,{...h,bevelEnabled:i,bevelSize:s,bevelThickness:r,depth:a})}this.type="TextGeometry"}}const y4={uniforms:{tDiffuse:{value:null}},vertexShader:["varying vec2 vUv;","void main() {","	vUv = uv;","	gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join(`
`),fragmentShader:["uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","	vec4 tex = texture2D( tDiffuse, vUv );","	#ifdef LinearTosRGB","		gl_FragColor = LinearTosRGB( tex );","	#else","		gl_FragColor = sRGBTransferOETF( tex );","	#endif","}"].join(`
`)},E4={uniforms:{tDiffuse:{value:null},h:{value:1/512}},vertexShader:`
      varying vec2 vUv;

      void main() {

        vUv = uv;
        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

      }
  `,fragmentShader:`
    uniform sampler2D tDiffuse;
    uniform float h;

    varying vec2 vUv;

    void main() {

    	vec4 sum = vec4( 0.0 );

    	sum += texture2D( tDiffuse, vec2( vUv.x - 4.0 * h, vUv.y ) ) * 0.051;
    	sum += texture2D( tDiffuse, vec2( vUv.x - 3.0 * h, vUv.y ) ) * 0.0918;
    	sum += texture2D( tDiffuse, vec2( vUv.x - 2.0 * h, vUv.y ) ) * 0.12245;
    	sum += texture2D( tDiffuse, vec2( vUv.x - 1.0 * h, vUv.y ) ) * 0.1531;
    	sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y ) ) * 0.1633;
    	sum += texture2D( tDiffuse, vec2( vUv.x + 1.0 * h, vUv.y ) ) * 0.1531;
    	sum += texture2D( tDiffuse, vec2( vUv.x + 2.0 * h, vUv.y ) ) * 0.12245;
    	sum += texture2D( tDiffuse, vec2( vUv.x + 3.0 * h, vUv.y ) ) * 0.0918;
    	sum += texture2D( tDiffuse, vec2( vUv.x + 4.0 * h, vUv.y ) ) * 0.051;

    	gl_FragColor = sum;

    }
  `},v4={uniforms:{tDiffuse:{value:null},v:{value:1/512}},vertexShader:`
    varying vec2 vUv;

    void main() {

      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );

    }
  `,fragmentShader:`

  uniform sampler2D tDiffuse;
  uniform float v;

  varying vec2 vUv;

  void main() {

    vec4 sum = vec4( 0.0 );

    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 4.0 * v ) ) * 0.051;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 3.0 * v ) ) * 0.0918;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 2.0 * v ) ) * 0.12245;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y - 1.0 * v ) ) * 0.1531;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y ) ) * 0.1633;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 1.0 * v ) ) * 0.1531;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 2.0 * v ) ) * 0.12245;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 3.0 * v ) ) * 0.0918;
    sum += texture2D( tDiffuse, vec2( vUv.x, vUv.y + 4.0 * v ) ) * 0.051;

    gl_FragColor = sum;

  }
  `},dl=new r1,Al=new b,Sn=new b,Fi=new b,hs=new b,Gi=new b,fs=new b,ds=new b,Nr=new b,Gr=new b,zr=new b,Xo=new b,Hr=new b,Kr=new b,Vr=new b;class x4{constructor(e,t,i){this.camera=e,this.scene=t,this.startPoint=new b,this.endPoint=new b,this.collection=[],this.deep=i||Number.MAX_VALUE}select(e,t){return this.startPoint=e||this.startPoint,this.endPoint=t||this.endPoint,this.collection=[],this.updateFrustum(this.startPoint,this.endPoint),this.searchChildInFrustum(dl,this.scene),this.collection}updateFrustum(e,t){if(e=e||this.startPoint,t=t||this.endPoint,e.x===t.x&&(t.x+=Number.EPSILON),e.y===t.y&&(t.y+=Number.EPSILON),this.camera.updateProjectionMatrix(),this.camera.updateMatrixWorld(),this.camera.isPerspectiveCamera){Sn.copy(e),Sn.x=Math.min(e.x,t.x),Sn.y=Math.max(e.y,t.y),t.x=Math.max(e.x,t.x),t.y=Math.min(e.y,t.y),Fi.setFromMatrixPosition(this.camera.matrixWorld),hs.copy(Sn),Gi.set(t.x,Sn.y,0),fs.copy(t),ds.set(Sn.x,t.y,0),hs.unproject(this.camera),Gi.unproject(this.camera),fs.unproject(this.camera),ds.unproject(this.camera),Hr.copy(hs).sub(Fi),Kr.copy(Gi).sub(Fi),Vr.copy(fs).sub(Fi),Hr.normalize(),Kr.normalize(),Vr.normalize(),Hr.multiplyScalar(this.deep),Kr.multiplyScalar(this.deep),Vr.multiplyScalar(this.deep),Hr.add(Fi),Kr.add(Fi),Vr.add(Fi);var i=dl.planes;i[0].setFromCoplanarPoints(Fi,hs,Gi),i[1].setFromCoplanarPoints(Fi,Gi,fs),i[2].setFromCoplanarPoints(fs,ds,Fi),i[3].setFromCoplanarPoints(ds,hs,Fi),i[4].setFromCoplanarPoints(Gi,fs,ds),i[5].setFromCoplanarPoints(Vr,Kr,Hr),i[5].normal.multiplyScalar(-1)}else if(this.camera.isOrthographicCamera){const s=Math.min(e.x,t.x),r=Math.max(e.y,t.y),o=Math.max(e.x,t.x),a=Math.min(e.y,t.y);hs.set(s,r,-1),Gi.set(o,r,-1),fs.set(o,a,-1),ds.set(s,a,-1),Nr.set(s,r,1),Gr.set(o,r,1),zr.set(o,a,1),Xo.set(s,a,1),hs.unproject(this.camera),Gi.unproject(this.camera),fs.unproject(this.camera),ds.unproject(this.camera),Nr.unproject(this.camera),Gr.unproject(this.camera),zr.unproject(this.camera),Xo.unproject(this.camera);var i=dl.planes;i[0].setFromCoplanarPoints(hs,Nr,Gr),i[1].setFromCoplanarPoints(Gi,Gr,zr),i[2].setFromCoplanarPoints(zr,Xo,ds),i[3].setFromCoplanarPoints(Xo,Nr,hs),i[4].setFromCoplanarPoints(Gi,fs,ds),i[5].setFromCoplanarPoints(zr,Gr,Nr),i[5].normal.multiplyScalar(-1)}else console.error("THREE.SelectionBox: Unsupported camera type.")}searchChildInFrustum(e,t){if((t.isMesh||t.isLine||t.isPoints)&&t.material!==void 0&&(t.geometry.boundingSphere===null&&t.geometry.computeBoundingSphere(),Al.copy(t.geometry.boundingSphere.center),Al.applyMatrix4(t.matrixWorld),e.containsPoint(Al)&&this.collection.push(t)),t.children.length>0)for(let i=0;i<t.children.length;i++)this.searchChildInFrustum(e,t.children[i])}}class C4{constructor(e,t=" .:-=+*#%@",i={}){const s=i.resolution||.15,r=i.scale||1,o=i.color||!1,a=i.alpha||!1,c=i.block||!1,l=i.invert||!1,u=i.strResolution||"low";let h,f;const d=document.createElement("div");d.style.cursor="default";const p=document.createElement("table");d.appendChild(p);let m,g,y;this.setSize=function(O,U){h=O,f=U,e.setSize(O,U),v()},this.render=function(O,U){e.render(O,U),L(p)},this.domElement=d;function v(){m=Math.floor(h*s),g=Math.floor(f*s),S.width=m,S.height=g,y=e.domElement,y.style.backgroundColor&&(p.rows[0].cells[0].style.backgroundColor=y.style.backgroundColor,p.rows[0].cells[0].style.color=y.style.color),p.cellSpacing=0,p.cellPadding=0;const O=p.style;O.whiteSpace="pre",O.margin="0px",O.padding="0px",O.letterSpacing=_+"px",O.fontFamily=x,O.fontSize=T+"px",O.lineHeight=R+"px",O.textAlign="left",O.textDecoration="none"}const E=" .,:;i1tfLCG08@".split(""),C=" CGO08@".split(""),x="courier new, monospace",I=e.domElement,S=document.createElement("canvas");if(!S.getContext)return;const w=S.getContext("2d");if(!w.getImageData)return;let B=o?C:E;t&&(B=t);const T=2/s*r,R=2/s*r;let _=0;if(u=="low")switch(r){case 1:_=-1;break;case 2:case 3:_=-2.1;break;case 4:_=-3.1;break;case 5:_=-4.15;break}if(u=="medium")switch(r){case 1:_=0;break;case 2:_=-1;break;case 3:_=-1.04;break;case 4:case 5:_=-2.1;break}if(u=="high")switch(r){case 1:case 2:_=0;break;case 3:case 4:case 5:_=-1;break}function L(O){w.clearRect(0,0,m,g),w.drawImage(I,0,0,m,g);const U=w.getImageData(0,0,m,g).data;let Q="";for(let G=0;G<g;G+=2){for(let z=0;z<m;z++){const H=(G*m+z)*4,N=U[H],V=U[H+1],$=U[H+2],Y=U[H+3];let M,k;k=(.3*N+.59*V+.11*$)/255,Y==0&&(k=1),M=Math.floor((1-k)*(B.length-1)),l&&(M=B.length-M-1);let P=B[M];(P===void 0||P==" ")&&(P="&nbsp;"),o?Q+="<span style='color:rgb("+N+","+V+","+$+");"+(c?"background-color:rgb("+N+","+V+","+$+");":"")+(a?"opacity:"+Y/255+";":"")+"'>"+P+"</span>":Q+=P}Q+="<br/>"}O.innerHTML=`<tr><td style="display:block;width:${h}px;height:${f}px;overflow:hidden">${Q}</td></tr>`}}}function J1(n,e,t){const i=t.length-n-1;if(e>=t[i])return i-1;if(e<=t[n])return n;let s=n,r=i,o=Math.floor((s+r)/2);for(;e<t[o]||e>=t[o+1];)e<t[o]?r=o:s=o,o=Math.floor((s+r)/2);return o}function I4(n,e,t,i){const s=[],r=[],o=[];s[0]=1;for(let a=1;a<=t;++a){r[a]=e-i[n+1-a],o[a]=i[n+a]-e;let c=0;for(let l=0;l<a;++l){const u=o[l+1],h=r[a-l],f=s[l]/(u+h);s[l]=c+u*f,c=h*f}s[a]=c}return s}function S4(n,e,t,i){const s=J1(n,i,e),r=I4(s,i,n,e),o=new ft(0,0,0,0);for(let a=0;a<=n;++a){const c=t[s-n+a],l=r[a],u=c.w*l;o.x+=c.x*u,o.y+=c.y*u,o.z+=c.z*u,o.w+=c.w*l}return o}function w4(n,e,t,i,s){const r=[];for(let h=0;h<=t;++h)r[h]=0;const o=[];for(let h=0;h<=i;++h)o[h]=r.slice(0);const a=[];for(let h=0;h<=t;++h)a[h]=r.slice(0);a[0][0]=1;const c=r.slice(0),l=r.slice(0);for(let h=1;h<=t;++h){c[h]=e-s[n+1-h],l[h]=s[n+h]-e;let f=0;for(let d=0;d<h;++d){const p=l[d+1],m=c[h-d];a[h][d]=p+m;const g=a[d][h-1]/a[h][d];a[d][h]=f+p*g,f=m*g}a[h][h]=f}for(let h=0;h<=t;++h)o[0][h]=a[h][t];for(let h=0;h<=t;++h){let f=0,d=1;const p=[];for(let m=0;m<=t;++m)p[m]=r.slice(0);p[0][0]=1;for(let m=1;m<=i;++m){let g=0;const y=h-m,v=t-m;h>=m&&(p[d][0]=p[f][0]/a[v+1][y],g=p[d][0]*a[y][v]);const E=y>=-1?1:-y,C=h-1<=v?m-1:t-h;for(let I=E;I<=C;++I)p[d][I]=(p[f][I]-p[f][I-1])/a[v+1][y+I],g+=p[d][I]*a[y+I][v];h<=v&&(p[d][m]=-p[f][m-1]/a[v+1][h],g+=p[d][m]*a[h][v]),o[m][h]=g;const x=f;f=d,d=x}}let u=t;for(let h=1;h<=i;++h){for(let f=0;f<=t;++f)o[h][f]*=u;u*=t-h}return o}function T4(n,e,t,i,s){const r=s<n?s:n,o=[],a=J1(n,i,e),c=w4(a,i,n,r,e),l=[];for(let u=0;u<t.length;++u){const h=t[u].clone(),f=h.w;h.x*=f,h.y*=f,h.z*=f,l[u]=h}for(let u=0;u<=r;++u){const h=l[a-n].clone().multiplyScalar(c[u][0]);for(let f=1;f<=n;++f)h.add(l[a-n+f].clone().multiplyScalar(c[u][f]));o[u]=h}for(let u=r+1;u<=s+1;++u)o[u]=new ft(0,0,0);return o}function B4(n,e){let t=1;for(let s=2;s<=n;++s)t*=s;let i=1;for(let s=2;s<=e;++s)i*=s;for(let s=2;s<=n-e;++s)i*=s;return t/i}function _4(n){const e=n.length,t=[],i=[];for(let r=0;r<e;++r){const o=n[r];t[r]=new b(o.x,o.y,o.z),i[r]=o.w}const s=[];for(let r=0;r<e;++r){const o=t[r].clone();for(let a=1;a<=r;++a)o.sub(s[r-a].clone().multiplyScalar(B4(r,a)*i[a]));s[r]=o.divideScalar(i[0])}return s}function b4(n,e,t,i,s){const r=T4(n,e,t,i,s);return _4(r)}class Hd extends my{constructor(e,t,i,s,r){super(),this.degree=e,this.knots=t,this.controlPoints=[],this.startKnot=s||0,this.endKnot=r||this.knots.length-1;for(let o=0;o<i.length;++o){const a=i[o];this.controlPoints[o]=new ft(a.x,a.y,a.z,a.w)}}getPoint(e,t){const i=t||new b,s=this.knots[this.startKnot]+e*(this.knots[this.endKnot]-this.knots[this.startKnot]),r=S4(this.degree,this.knots,this.controlPoints,s);return r.w!=1&&r.divideScalar(r.w),i.set(r.x,r.y,r.z)}getTangent(e,t){const i=t||new b,s=this.knots[0]+e*(this.knots[this.knots.length-1]-this.knots[0]),r=b4(this.degree,this.knots,this.controlPoints,s,1);return i.copy(r[1]).normalize(),i}}let Oe,ht,ti;class $h extends fn{constructor(e){super(e)}load(e,t,i,s){const r=this,o=r.path===""?ar.extractUrlBase(e):r.path,a=new ss(this.manager);a.setPath(r.path),a.setResponseType("arraybuffer"),a.setRequestHeader(r.requestHeader),a.setWithCredentials(r.withCredentials),a.load(e,function(c){try{t(r.parse(c,o))}catch(l){s?s(l):console.error(l),r.manager.itemError(e)}},i,s)}parse(e,t){if(F4(e))Oe=new P4().parse(e);else{const s=ep(e);if(!k4(s))throw new Error("THREE.FBXLoader: Unknown format.");if(Vd(s)<7e3)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+Vd(s));Oe=new L4().parse(s)}const i=new Bs(this.manager).setPath(this.resourcePath||t).setCrossOrigin(this.crossOrigin);return new R4(i,this.manager).parse(Oe)}}class R4{constructor(e,t){this.textureLoader=e,this.manager=t}parse(){ht=this.parseConnections();const e=this.parseImages(),t=this.parseTextures(e),i=this.parseMaterials(t),s=this.parseDeformers(),r=new D4().parse(s);return this.parseScene(s,r,i),ti}parseConnections(){const e=new Map;return"Connections"in Oe&&Oe.Connections.connections.forEach(function(i){const s=i[0],r=i[1],o=i[2];e.has(s)||e.set(s,{parents:[],children:[]});const a={ID:r,relationship:o};e.get(s).parents.push(a),e.has(r)||e.set(r,{parents:[],children:[]});const c={ID:s,relationship:o};e.get(r).children.push(c)}),e}parseImages(){const e={},t={};if("Video"in Oe.Objects){const i=Oe.Objects.Video;for(const s in i){const r=i[s],o=parseInt(s);if(e[o]=r.RelativeFilename||r.Filename,"Content"in r){const a=r.Content instanceof ArrayBuffer&&r.Content.byteLength>0,c=typeof r.Content=="string"&&r.Content!=="";if(a||c){const l=this.parseImage(i[s]);t[r.RelativeFilename||r.Filename]=l}}}}for(const i in e){const s=e[i];t[s]!==void 0?e[i]=t[s]:e[i]=e[i].split("\\").pop()}return e}parseImage(e){const t=e.Content,i=e.RelativeFilename||e.Filename,s=i.slice(i.lastIndexOf(".")+1).toLowerCase();let r;switch(s){case"bmp":r="image/bmp";break;case"jpg":case"jpeg":r="image/jpeg";break;case"png":r="image/png";break;case"tif":r="image/tiff";break;case"tga":this.manager.getHandler(".tga")===null&&console.warn("FBXLoader: TGA loader not found, skipping ",i),r="image/tga";break;default:console.warn('FBXLoader: Image type "'+s+'" is not supported.');return}if(typeof t=="string")return"data:"+r+";base64,"+t;{const o=new Uint8Array(t);return window.URL.createObjectURL(new Blob([o],{type:r}))}}parseTextures(e){const t=new Map;if("Texture"in Oe.Objects){const i=Oe.Objects.Texture;for(const s in i){const r=this.parseTexture(i[s],e);t.set(parseInt(s),r)}}return t}parseTexture(e,t){const i=this.loadTexture(e,t);i.ID=e.id,i.name=e.attrName;const s=e.WrapModeU,r=e.WrapModeV,o=s!==void 0?s.value:0,a=r!==void 0?r.value:0;if(i.wrapS=o===0?ui:Ro,i.wrapT=a===0?ui:Ro,"Scaling"in e){const c=e.Scaling.value;i.repeat.x=c[0],i.repeat.y=c[1]}return i}loadTexture(e,t){let i;const s=this.textureLoader.path,r=ht.get(e.id).children;r!==void 0&&r.length>0&&t[r[0].ID]!==void 0&&(i=t[r[0].ID],(i.indexOf("blob:")===0||i.indexOf("data:")===0)&&this.textureLoader.setPath(void 0));let o;const a=e.FileName.slice(-3).toLowerCase();if(a==="tga"){const c=this.manager.getHandler(".tga");c===null?(console.warn("FBXLoader: TGA loader not found, creating placeholder texture for",e.RelativeFilename),o=new as):(c.setPath(this.textureLoader.path),o=c.load(i))}else a==="psd"?(console.warn("FBXLoader: PSD textures are not supported, creating placeholder texture for",e.RelativeFilename),o=new as):o=this.textureLoader.load(i);return this.textureLoader.setPath(s),o}parseMaterials(e){const t=new Map;if("Material"in Oe.Objects){const i=Oe.Objects.Material;for(const s in i){const r=this.parseMaterial(i[s],e);r!==null&&t.set(parseInt(s),r)}}return t}parseMaterial(e,t){const i=e.id,s=e.attrName;let r=e.ShadingModel;if(typeof r=="object"&&(r=r.value),!ht.has(i))return null;const o=this.parseParameters(e,t,i);let a;switch(r.toLowerCase()){case"phong":a=new Zc;break;case"lambert":a=new Lh;break;default:console.warn('THREE.FBXLoader: unknown material type "%s". Defaulting to MeshPhongMaterial.',r),a=new Zc;break}return a.setValues(o),a.name=s,a}parseParameters(e,t,i){const s={};e.BumpFactor&&(s.bumpScale=e.BumpFactor.value),e.Diffuse?s.color=new xe().fromArray(e.Diffuse.value):e.DiffuseColor&&(e.DiffuseColor.type==="Color"||e.DiffuseColor.type==="ColorRGB")&&(s.color=new xe().fromArray(e.DiffuseColor.value)),e.DisplacementFactor&&(s.displacementScale=e.DisplacementFactor.value),e.Emissive?s.emissive=new xe().fromArray(e.Emissive.value):e.EmissiveColor&&(e.EmissiveColor.type==="Color"||e.EmissiveColor.type==="ColorRGB")&&(s.emissive=new xe().fromArray(e.EmissiveColor.value)),e.EmissiveFactor&&(s.emissiveIntensity=parseFloat(e.EmissiveFactor.value)),e.Opacity&&(s.opacity=parseFloat(e.Opacity.value)),s.opacity<1&&(s.transparent=!0),e.ReflectionFactor&&(s.reflectivity=e.ReflectionFactor.value),e.Shininess&&(s.shininess=e.Shininess.value),e.Specular?s.specular=new xe().fromArray(e.Specular.value):e.SpecularColor&&e.SpecularColor.type==="Color"&&(s.specular=new xe().fromArray(e.SpecularColor.value));const r=this;return ht.get(i).children.forEach(function(o){const a=o.relationship;switch(a){case"Bump":s.bumpMap=r.getTexture(t,o.ID);break;case"Maya|TEX_ao_map":s.aoMap=r.getTexture(t,o.ID);break;case"DiffuseColor":case"Maya|TEX_color_map":s.map=r.getTexture(t,o.ID),s.map!==void 0&&("colorSpace"in s.map?s.map.colorSpace="srgb":s.map.encoding=3001);break;case"DisplacementColor":s.displacementMap=r.getTexture(t,o.ID);break;case"EmissiveColor":s.emissiveMap=r.getTexture(t,o.ID),s.emissiveMap!==void 0&&("colorSpace"in s.emissiveMap?s.emissiveMap.colorSpace="srgb":s.emissiveMap.encoding=3001);break;case"NormalMap":case"Maya|TEX_normal_map":s.normalMap=r.getTexture(t,o.ID);break;case"ReflectionColor":s.envMap=r.getTexture(t,o.ID),s.envMap!==void 0&&(s.envMap.mapping=py,"colorSpace"in s.envMap?s.envMap.colorSpace="srgb":s.envMap.encoding=3001);break;case"SpecularColor":s.specularMap=r.getTexture(t,o.ID),s.specularMap!==void 0&&("colorSpace"in s.specularMap?s.specularMap.colorSpace="srgb":s.specularMap.encoding=3001);break;case"TransparentColor":case"TransparencyFactor":s.alphaMap=r.getTexture(t,o.ID),s.transparent=!0;break;case"AmbientColor":case"ShininessExponent":case"SpecularFactor":case"VectorDisplacementColor":default:console.warn("THREE.FBXLoader: %s map is not supported in three.js, skipping texture.",a);break}}),s}getTexture(e,t){return"LayeredTexture"in Oe.Objects&&t in Oe.Objects.LayeredTexture&&(console.warn("THREE.FBXLoader: layered textures are not supported in three.js. Discarding all but first layer."),t=ht.get(t).children[0].ID),e.get(t)}parseDeformers(){const e={},t={};if("Deformer"in Oe.Objects){const i=Oe.Objects.Deformer;for(const s in i){const r=i[s],o=ht.get(parseInt(s));if(r.attrType==="Skin"){const a=this.parseSkeleton(o,i);a.ID=s,o.parents.length>1&&console.warn("THREE.FBXLoader: skeleton attached to more than one geometry is not supported."),a.geometryID=o.parents[0].ID,e[s]=a}else if(r.attrType==="BlendShape"){const a={id:s};a.rawTargets=this.parseMorphTargets(o,i),a.id=s,o.parents.length>1&&console.warn("THREE.FBXLoader: morph target attached to more than one geometry is not supported."),t[s]=a}}}return{skeletons:e,morphTargets:t}}parseSkeleton(e,t){const i=[];return e.children.forEach(function(s){const r=t[s.ID];if(r.attrType!=="Cluster")return;const o={ID:s.ID,indices:[],weights:[],transformLink:new ce().fromArray(r.TransformLink.a)};"Indexes"in r&&(o.indices=r.Indexes.a,o.weights=r.Weights.a),i.push(o)}),{rawBones:i,bones:[]}}parseMorphTargets(e,t){const i=[];for(let s=0;s<e.children.length;s++){const r=e.children[s],o=t[r.ID],a={name:o.attrName,initialWeight:o.DeformPercent,id:o.id,fullWeights:o.FullWeights.a};if(o.attrType!=="BlendShapeChannel")return;a.geoID=ht.get(parseInt(r.ID)).children.filter(function(c){return c.relationship===void 0})[0].ID,i.push(a)}return i}parseScene(e,t,i){ti=new ws;const s=this.parseModels(e.skeletons,t,i),r=Oe.Objects.Model,o=this;s.forEach(function(c){const l=r[c.ID];o.setLookAtProperties(c,l),ht.get(c.ID).parents.forEach(function(h){const f=s.get(h.ID);f!==void 0&&f.add(c)}),c.parent===null&&ti.add(c)}),this.bindSkeleton(e.skeletons,t,s),this.createAmbientLight(),ti.traverse(function(c){if(c.userData.transformData){c.parent&&(c.userData.transformData.parentMatrix=c.parent.matrix,c.userData.transformData.parentMatrixWorld=c.parent.matrixWorld);const l=X1(c.userData.transformData);c.applyMatrix4(l),c.updateWorldMatrix()}});const a=new M4().parse();ti.children.length===1&&ti.children[0].isGroup&&(ti.children[0].animations=a,ti=ti.children[0]),ti.animations=a}parseModels(e,t,i){const s=new Map,r=Oe.Objects.Model;for(const o in r){const a=parseInt(o),c=r[o],l=ht.get(a);let u=this.buildSkeleton(l,e,a,c.attrName);if(!u){switch(c.attrType){case"Camera":u=this.createCamera(l);break;case"Light":u=this.createLight(l);break;case"Mesh":u=this.createMesh(l,t,i);break;case"NurbsCurve":u=this.createCurve(l,t);break;case"LimbNode":case"Root":u=new Hu;break;case"Null":default:u=new ws;break}u.name=c.attrName?bo.sanitizeNodeName(c.attrName):"",u.ID=a}this.getTransformData(u,c),s.set(a,u)}return s}buildSkeleton(e,t,i,s){let r=null;return e.parents.forEach(function(o){for(const a in t){const c=t[a];c.rawBones.forEach(function(l,u){if(l.ID===o.ID){const h=r;r=new Hu,r.matrixWorld.copy(l.transformLink),r.name=s?bo.sanitizeNodeName(s):"",r.ID=i,c.bones[u]=r,h!==null&&r.add(h)}})}}),r}createCamera(e){let t,i;if(e.children.forEach(function(s){const r=Oe.Objects.NodeAttribute[s.ID];r!==void 0&&(i=r)}),i===void 0)t=new lt;else{let s=0;i.CameraProjectionType!==void 0&&i.CameraProjectionType.value===1&&(s=1);let r=1;i.NearPlane!==void 0&&(r=i.NearPlane.value/1e3);let o=1e3;i.FarPlane!==void 0&&(o=i.FarPlane.value/1e3);let a=window.innerWidth,c=window.innerHeight;i.AspectWidth!==void 0&&i.AspectHeight!==void 0&&(a=i.AspectWidth.value,c=i.AspectHeight.value);const l=a/c;let u=45;i.FieldOfView!==void 0&&(u=i.FieldOfView.value);const h=i.FocalLength?i.FocalLength.value:null;switch(s){case 0:t=new nt(u,l,r,o),h!==null&&t.setFocalLength(h);break;case 1:t=new vt(-a/2,a/2,c/2,-c/2,r,o);break;default:console.warn("THREE.FBXLoader: Unknown camera type "+s+"."),t=new lt;break}}return t}createLight(e){let t,i;if(e.children.forEach(function(s){const r=Oe.Objects.NodeAttribute[s.ID];r!==void 0&&(i=r)}),i===void 0)t=new lt;else{let s;i.LightType===void 0?s=0:s=i.LightType.value;let r=16777215;i.Color!==void 0&&(r=new xe().fromArray(i.Color.value));let o=i.Intensity===void 0?1:i.Intensity.value/100;i.CastLightOnObject!==void 0&&i.CastLightOnObject.value===0&&(o=0);let a=0;i.FarAttenuationEnd!==void 0&&(i.EnableFarAttenuation!==void 0&&i.EnableFarAttenuation.value===0?a=0:a=i.FarAttenuationEnd.value);const c=1;switch(s){case 0:t=new zu(r,o,a,c);break;case 1:t=new t1(r,o);break;case 2:let l=Math.PI/3;i.InnerAngle!==void 0&&(l=Ce.degToRad(i.InnerAngle.value));let u=0;i.OuterAngle!==void 0&&(u=Ce.degToRad(i.OuterAngle.value),u=Math.max(u,1)),t=new e1(r,o,a,l,u,c);break;default:console.warn("THREE.FBXLoader: Unknown light type "+i.LightType.value+", defaulting to a PointLight."),t=new zu(r,o);break}i.CastShadows!==void 0&&i.CastShadows.value===1&&(t.castShadow=!0)}return t}createMesh(e,t,i){let s,r=null,o=null;const a=[];return e.children.forEach(function(c){t.has(c.ID)&&(r=t.get(c.ID)),i.has(c.ID)&&a.push(i.get(c.ID))}),a.length>1?o=a:a.length>0?o=a[0]:(o=new Zc({color:13421772}),a.push(o)),"color"in r.attributes&&a.forEach(function(c){c.vertexColors=!0}),r.FBX_Deformer?(s=new Mh(r,o),s.normalizeSkinWeights()):s=new ye(r,o),s}createCurve(e,t){const i=e.children.reduce(function(r,o){return t.has(o.ID)&&(r=t.get(o.ID)),r},null),s=new or({color:3342591,linewidth:1});return new Qe(i,s)}getTransformData(e,t){const i={};"InheritType"in t&&(i.inheritType=parseInt(t.InheritType.value)),"RotationOrder"in t?i.eulerOrder=Z1(t.RotationOrder.value):i.eulerOrder="ZYX","Lcl_Translation"in t&&(i.translation=t.Lcl_Translation.value),"PreRotation"in t&&(i.preRotation=t.PreRotation.value),"Lcl_Rotation"in t&&(i.rotation=t.Lcl_Rotation.value),"PostRotation"in t&&(i.postRotation=t.PostRotation.value),"Lcl_Scaling"in t&&(i.scale=t.Lcl_Scaling.value),"ScalingOffset"in t&&(i.scalingOffset=t.ScalingOffset.value),"ScalingPivot"in t&&(i.scalingPivot=t.ScalingPivot.value),"RotationOffset"in t&&(i.rotationOffset=t.RotationOffset.value),"RotationPivot"in t&&(i.rotationPivot=t.RotationPivot.value),e.userData.transformData=i}setLookAtProperties(e,t){"LookAtProperty"in t&&ht.get(e.ID).children.forEach(function(s){if(s.relationship==="LookAtProperty"){const r=Oe.Objects.Model[s.ID];if("Lcl_Translation"in r){const o=r.Lcl_Translation.value;e.target!==void 0?(e.target.position.fromArray(o),ti.add(e.target)):e.lookAt(new b().fromArray(o))}}})}bindSkeleton(e,t,i){const s=this.parsePoseNodes();for(const r in e){const o=e[r];ht.get(parseInt(o.ID)).parents.forEach(function(c){if(t.has(c.ID)){const l=c.ID;ht.get(l).parents.forEach(function(h){i.has(h.ID)&&i.get(h.ID).bind(new s1(o.bones),s[h.ID])})}})}}parsePoseNodes(){const e={};if("Pose"in Oe.Objects){const t=Oe.Objects.Pose;for(const i in t)if(t[i].attrType==="BindPose"&&t[i].NbPoseNodes>0){const s=t[i].PoseNode;Array.isArray(s)?s.forEach(function(r){e[r.Node]=new ce().fromArray(r.Matrix.a)}):e[s.Node]=new ce().fromArray(s.Matrix.a)}}return e}createAmbientLight(){if("GlobalSettings"in Oe&&"AmbientColor"in Oe.GlobalSettings){const e=Oe.GlobalSettings.AmbientColor.value,t=e[0],i=e[1],s=e[2];if(t!==0||i!==0||s!==0){const r=new xe(t,i,s);ti.add(new gy(r,1))}}}}class D4{parse(e){const t=new Map;if("Geometry"in Oe.Objects){const i=Oe.Objects.Geometry;for(const s in i){const r=ht.get(parseInt(s)),o=this.parseGeometry(r,i[s],e);t.set(parseInt(s),o)}}return t}parseGeometry(e,t,i){switch(t.attrType){case"Mesh":return this.parseMeshGeometry(e,t,i);case"NurbsCurve":return this.parseNurbsGeometry(t)}}parseMeshGeometry(e,t,i){const s=i.skeletons,r=[],o=e.parents.map(function(h){return Oe.Objects.Model[h.ID]});if(o.length===0)return;const a=e.children.reduce(function(h,f){return s[f.ID]!==void 0&&(h=s[f.ID]),h},null);e.children.forEach(function(h){i.morphTargets[h.ID]!==void 0&&r.push(i.morphTargets[h.ID])});const c=o[0],l={};"RotationOrder"in c&&(l.eulerOrder=Z1(c.RotationOrder.value)),"InheritType"in c&&(l.inheritType=parseInt(c.InheritType.value)),"GeometricTranslation"in c&&(l.translation=c.GeometricTranslation.value),"GeometricRotation"in c&&(l.rotation=c.GeometricRotation.value),"GeometricScaling"in c&&(l.scale=c.GeometricScaling.value);const u=X1(l);return this.genGeometry(t,a,r,u)}genGeometry(e,t,i,s){const r=new St;e.attrName&&(r.name=e.attrName);const o=this.parseGeoNode(e,t),a=this.genBuffers(o),c=new Rt(a.vertex,3);if(c.applyMatrix4(s),r.setAttribute("position",c),a.colors.length>0&&r.setAttribute("color",new Rt(a.colors,3)),t&&(r.setAttribute("skinIndex",new yy(a.weightsIndices,4)),r.setAttribute("skinWeight",new Rt(a.vertexWeights,4)),r.FBX_Deformer=t),a.normal.length>0){const l=new Ci().getNormalMatrix(s),u=new Rt(a.normal,3);u.applyNormalMatrix(l),r.setAttribute("normal",u)}if(a.uvs.forEach(function(l,u){Kh==="uv2"&&u++;const h=u===0?"uv":`uv${u}`;r.setAttribute(h,new Rt(a.uvs[u],2))}),o.material&&o.material.mappingType!=="AllSame"){let l=a.materialIndex[0],u=0;if(a.materialIndex.forEach(function(h,f){h!==l&&(r.addGroup(u,f-u,l),l=h,u=f)}),r.groups.length>0){const h=r.groups[r.groups.length-1],f=h.start+h.count;f!==a.materialIndex.length&&r.addGroup(f,a.materialIndex.length-f,l)}r.groups.length===0&&r.addGroup(0,a.materialIndex.length,a.materialIndex[0])}return this.addMorphTargets(r,e,i,s),r}parseGeoNode(e,t){const i={};if(i.vertexPositions=e.Vertices!==void 0?e.Vertices.a:[],i.vertexIndices=e.PolygonVertexIndex!==void 0?e.PolygonVertexIndex.a:[],e.LayerElementColor&&(i.color=this.parseVertexColors(e.LayerElementColor[0])),e.LayerElementMaterial&&(i.material=this.parseMaterialIndices(e.LayerElementMaterial[0])),e.LayerElementNormal&&(i.normal=this.parseNormals(e.LayerElementNormal[0])),e.LayerElementUV){i.uv=[];let s=0;for(;e.LayerElementUV[s];)e.LayerElementUV[s].UV&&i.uv.push(this.parseUVs(e.LayerElementUV[s])),s++}return i.weightTable={},t!==null&&(i.skeleton=t,t.rawBones.forEach(function(s,r){s.indices.forEach(function(o,a){i.weightTable[o]===void 0&&(i.weightTable[o]=[]),i.weightTable[o].push({id:r,weight:s.weights[a]})})})),i}genBuffers(e){const t={vertex:[],normal:[],colors:[],uvs:[],materialIndex:[],vertexWeights:[],weightsIndices:[]};let i=0,s=0,r=!1,o=[],a=[],c=[],l=[],u=[],h=[];const f=this;return e.vertexIndices.forEach(function(d,p){let m,g=!1;d<0&&(d=d^-1,g=!0);let y=[],v=[];if(o.push(d*3,d*3+1,d*3+2),e.color){const E=Zo(p,i,d,e.color);c.push(E[0],E[1],E[2])}if(e.skeleton){if(e.weightTable[d]!==void 0&&e.weightTable[d].forEach(function(E){v.push(E.weight),y.push(E.id)}),v.length>4){r||(console.warn("THREE.FBXLoader: Vertex has more than 4 skinning weights assigned to vertex. Deleting additional weights."),r=!0);const E=[0,0,0,0],C=[0,0,0,0];v.forEach(function(x,I){let S=x,w=y[I];C.forEach(function(B,T,R){if(S>B){R[T]=S,S=B;const _=E[T];E[T]=w,w=_}})}),y=E,v=C}for(;v.length<4;)v.push(0),y.push(0);for(let E=0;E<4;++E)u.push(v[E]),h.push(y[E])}if(e.normal){const E=Zo(p,i,d,e.normal);a.push(E[0],E[1],E[2])}e.material&&e.material.mappingType!=="AllSame"&&(m=Zo(p,i,d,e.material)[0]),e.uv&&e.uv.forEach(function(E,C){const x=Zo(p,i,d,E);l[C]===void 0&&(l[C]=[]),l[C].push(x[0]),l[C].push(x[1])}),s++,g&&(f.genFace(t,e,o,m,a,c,l,u,h,s),i++,s=0,o=[],a=[],c=[],l=[],u=[],h=[])}),t}genFace(e,t,i,s,r,o,a,c,l,u){for(let h=2;h<u;h++)e.vertex.push(t.vertexPositions[i[0]]),e.vertex.push(t.vertexPositions[i[1]]),e.vertex.push(t.vertexPositions[i[2]]),e.vertex.push(t.vertexPositions[i[(h-1)*3]]),e.vertex.push(t.vertexPositions[i[(h-1)*3+1]]),e.vertex.push(t.vertexPositions[i[(h-1)*3+2]]),e.vertex.push(t.vertexPositions[i[h*3]]),e.vertex.push(t.vertexPositions[i[h*3+1]]),e.vertex.push(t.vertexPositions[i[h*3+2]]),t.skeleton&&(e.vertexWeights.push(c[0]),e.vertexWeights.push(c[1]),e.vertexWeights.push(c[2]),e.vertexWeights.push(c[3]),e.vertexWeights.push(c[(h-1)*4]),e.vertexWeights.push(c[(h-1)*4+1]),e.vertexWeights.push(c[(h-1)*4+2]),e.vertexWeights.push(c[(h-1)*4+3]),e.vertexWeights.push(c[h*4]),e.vertexWeights.push(c[h*4+1]),e.vertexWeights.push(c[h*4+2]),e.vertexWeights.push(c[h*4+3]),e.weightsIndices.push(l[0]),e.weightsIndices.push(l[1]),e.weightsIndices.push(l[2]),e.weightsIndices.push(l[3]),e.weightsIndices.push(l[(h-1)*4]),e.weightsIndices.push(l[(h-1)*4+1]),e.weightsIndices.push(l[(h-1)*4+2]),e.weightsIndices.push(l[(h-1)*4+3]),e.weightsIndices.push(l[h*4]),e.weightsIndices.push(l[h*4+1]),e.weightsIndices.push(l[h*4+2]),e.weightsIndices.push(l[h*4+3])),t.color&&(e.colors.push(o[0]),e.colors.push(o[1]),e.colors.push(o[2]),e.colors.push(o[(h-1)*3]),e.colors.push(o[(h-1)*3+1]),e.colors.push(o[(h-1)*3+2]),e.colors.push(o[h*3]),e.colors.push(o[h*3+1]),e.colors.push(o[h*3+2])),t.material&&t.material.mappingType!=="AllSame"&&(e.materialIndex.push(s),e.materialIndex.push(s),e.materialIndex.push(s)),t.normal&&(e.normal.push(r[0]),e.normal.push(r[1]),e.normal.push(r[2]),e.normal.push(r[(h-1)*3]),e.normal.push(r[(h-1)*3+1]),e.normal.push(r[(h-1)*3+2]),e.normal.push(r[h*3]),e.normal.push(r[h*3+1]),e.normal.push(r[h*3+2])),t.uv&&t.uv.forEach(function(f,d){e.uvs[d]===void 0&&(e.uvs[d]=[]),e.uvs[d].push(a[d][0]),e.uvs[d].push(a[d][1]),e.uvs[d].push(a[d][(h-1)*2]),e.uvs[d].push(a[d][(h-1)*2+1]),e.uvs[d].push(a[d][h*2]),e.uvs[d].push(a[d][h*2+1])})}addMorphTargets(e,t,i,s){if(i.length===0)return;e.morphTargetsRelative=!0,e.morphAttributes.position=[];const r=this;i.forEach(function(o){o.rawTargets.forEach(function(a){const c=Oe.Objects.Geometry[a.geoID];c!==void 0&&r.genMorphGeometry(e,t,c,s,a.name)})})}genMorphGeometry(e,t,i,s,r){const o=t.PolygonVertexIndex!==void 0?t.PolygonVertexIndex.a:[],a=i.Vertices!==void 0?i.Vertices.a:[],c=i.Indexes!==void 0?i.Indexes.a:[],l=e.attributes.position.count*3,u=new Float32Array(l);for(let p=0;p<c.length;p++){const m=c[p]*3;u[m]=a[p*3],u[m+1]=a[p*3+1],u[m+2]=a[p*3+2]}const h={vertexIndices:o,vertexPositions:u},f=this.genBuffers(h),d=new Rt(f.vertex,3);d.name=r||i.attrName,d.applyMatrix4(s),e.morphAttributes.position.push(d)}parseNormals(e){const t=e.MappingInformationType,i=e.ReferenceInformationType,s=e.Normals.a;let r=[];return i==="IndexToDirect"&&("NormalIndex"in e?r=e.NormalIndex.a:"NormalsIndex"in e&&(r=e.NormalsIndex.a)),{dataSize:3,buffer:s,indices:r,mappingType:t,referenceType:i}}parseUVs(e){const t=e.MappingInformationType,i=e.ReferenceInformationType,s=e.UV.a;let r=[];return i==="IndexToDirect"&&(r=e.UVIndex.a),{dataSize:2,buffer:s,indices:r,mappingType:t,referenceType:i}}parseVertexColors(e){const t=e.MappingInformationType,i=e.ReferenceInformationType,s=e.Colors.a;let r=[];return i==="IndexToDirect"&&(r=e.ColorIndex.a),{dataSize:4,buffer:s,indices:r,mappingType:t,referenceType:i}}parseMaterialIndices(e){const t=e.MappingInformationType,i=e.ReferenceInformationType;if(t==="NoMappingInformation")return{dataSize:1,buffer:[0],indices:[0],mappingType:"AllSame",referenceType:i};const s=e.Materials.a,r=[];for(let o=0;o<s.length;++o)r.push(o);return{dataSize:1,buffer:s,indices:r,mappingType:t,referenceType:i}}parseNurbsGeometry(e){if(Hd===void 0)return console.error("THREE.FBXLoader: The loader relies on NURBSCurve for any nurbs present in the model. Nurbs will show up as empty geometry."),new St;const t=parseInt(e.Order);if(isNaN(t))return console.error("THREE.FBXLoader: Invalid Order %s given for geometry ID: %s",e.Order,e.id),new St;const i=t-1,s=e.KnotVector.a,r=[],o=e.Points.a;for(let h=0,f=o.length;h<f;h+=4)r.push(new ft().fromArray(o,h));let a,c;if(e.Form==="Closed")r.push(r[0]);else if(e.Form==="Periodic"){a=i,c=s.length-1-a;for(let h=0;h<i;++h)r.push(r[h])}const u=new Hd(i,s,r,a,c).getPoints(r.length*12);return new St().setFromPoints(u)}}class M4{parse(){const e=[],t=this.parseClips();if(t!==void 0)for(const i in t){const s=t[i],r=this.addClip(s);e.push(r)}return e}parseClips(){if(Oe.Objects.AnimationCurve===void 0)return;const e=this.parseAnimationCurveNodes();this.parseAnimationCurves(e);const t=this.parseAnimationLayers(e);return this.parseAnimStacks(t)}parseAnimationCurveNodes(){const e=Oe.Objects.AnimationCurveNode,t=new Map;for(const i in e){const s=e[i];if(s.attrName.match(/S|R|T|DeformPercent/)!==null){const r={id:s.id,attr:s.attrName,curves:{}};t.set(r.id,r)}}return t}parseAnimationCurves(e){const t=Oe.Objects.AnimationCurve;for(const i in t){const s={id:t[i].id,times:t[i].KeyTime.a.map(O4),values:t[i].KeyValueFloat.a},r=ht.get(s.id);if(r!==void 0){const o=r.parents[0].ID,a=r.parents[0].relationship;a.match(/X/)?e.get(o).curves.x=s:a.match(/Y/)?e.get(o).curves.y=s:a.match(/Z/)?e.get(o).curves.z=s:a.match(/d|DeformPercent/)&&e.has(o)&&(e.get(o).curves.morph=s)}}}parseAnimationLayers(e){const t=Oe.Objects.AnimationLayer,i=new Map;for(const s in t){const r=[],o=ht.get(parseInt(s));o!==void 0&&(o.children.forEach(function(c,l){if(e.has(c.ID)){const u=e.get(c.ID);if(u.curves.x!==void 0||u.curves.y!==void 0||u.curves.z!==void 0){if(r[l]===void 0){const h=ht.get(c.ID).parents.filter(function(f){return f.relationship!==void 0})[0].ID;if(h!==void 0){const f=Oe.Objects.Model[h.toString()];if(f===void 0){console.warn("THREE.FBXLoader: Encountered a unused curve.",c);return}const d={modelName:f.attrName?bo.sanitizeNodeName(f.attrName):"",ID:f.id,initialPosition:[0,0,0],initialRotation:[0,0,0],initialScale:[1,1,1]};ti.traverse(function(p){p.ID===f.id&&(d.transform=p.matrix,p.userData.transformData&&(d.eulerOrder=p.userData.transformData.eulerOrder))}),d.transform||(d.transform=new ce),"PreRotation"in f&&(d.preRotation=f.PreRotation.value),"PostRotation"in f&&(d.postRotation=f.PostRotation.value),r[l]=d}}r[l]&&(r[l][u.attr]=u)}else if(u.curves.morph!==void 0){if(r[l]===void 0){const h=ht.get(c.ID).parents.filter(function(y){return y.relationship!==void 0})[0].ID,f=ht.get(h).parents[0].ID,d=ht.get(f).parents[0].ID,p=ht.get(d).parents[0].ID,m=Oe.Objects.Model[p],g={modelName:m.attrName?bo.sanitizeNodeName(m.attrName):"",morphName:Oe.Objects.Deformer[h].attrName};r[l]=g}r[l][u.attr]=u}}}),i.set(parseInt(s),r))}return i}parseAnimStacks(e){const t=Oe.Objects.AnimationStack,i={};for(const s in t){const r=ht.get(parseInt(s)).children;r.length>1&&console.warn("THREE.FBXLoader: Encountered an animation stack with multiple layers, this is currently not supported. Ignoring subsequent layers.");const o=e.get(r[0].ID);i[s]={name:t[s].attrName,layer:o}}return i}addClip(e){let t=[];const i=this;return e.layer.forEach(function(s){t=t.concat(i.generateTracks(s))}),new Dh(e.name,-1,t)}generateTracks(e){const t=[];let i=new b,s=new Be,r=new b;if(e.transform&&e.transform.decompose(i,s,r),i=i.toArray(),s=new ai().setFromQuaternion(s,e.eulerOrder).toArray(),r=r.toArray(),e.T!==void 0&&Object.keys(e.T.curves).length>0){const o=this.generateVectorTrack(e.modelName,e.T.curves,i,"position");o!==void 0&&t.push(o)}if(e.R!==void 0&&Object.keys(e.R.curves).length>0){const o=this.generateRotationTrack(e.modelName,e.R.curves,s,e.preRotation,e.postRotation,e.eulerOrder);o!==void 0&&t.push(o)}if(e.S!==void 0&&Object.keys(e.S.curves).length>0){const o=this.generateVectorTrack(e.modelName,e.S.curves,r,"scale");o!==void 0&&t.push(o)}if(e.DeformPercent!==void 0){const o=this.generateMorphTrack(e);o!==void 0&&t.push(o)}return t}generateVectorTrack(e,t,i,s){const r=this.getTimesForAllAxes(t),o=this.getKeyframeTrackValues(r,t,i);return new ac(e+"."+s,r,o)}generateRotationTrack(e,t,i,s,r,o){t.x!==void 0&&(this.interpolateRotations(t.x),t.x.values=t.x.values.map(Ce.degToRad)),t.y!==void 0&&(this.interpolateRotations(t.y),t.y.values=t.y.values.map(Ce.degToRad)),t.z!==void 0&&(this.interpolateRotations(t.z),t.z.values=t.z.values.map(Ce.degToRad));const a=this.getTimesForAllAxes(t),c=this.getKeyframeTrackValues(a,t,i);s!==void 0&&(s=s.map(Ce.degToRad),s.push(o),s=new ai().fromArray(s),s=new Be().setFromEuler(s)),r!==void 0&&(r=r.map(Ce.degToRad),r.push(o),r=new ai().fromArray(r),r=new Be().setFromEuler(r).invert());const l=new Be,u=new ai,h=[];for(let f=0;f<c.length;f+=3)u.set(c[f],c[f+1],c[f+2],o),l.setFromEuler(u),s!==void 0&&l.premultiply(s),r!==void 0&&l.multiply(r),l.toArray(h,f/3*4);return new cc(e+".quaternion",a,h)}generateMorphTrack(e){const t=e.DeformPercent.curves.morph,i=t.values.map(function(r){return r/100}),s=ti.getObjectByName(e.modelName).morphTargetDictionary[e.morphName];return new Ku(e.modelName+".morphTargetInfluences["+s+"]",t.times,i)}getTimesForAllAxes(e){let t=[];if(e.x!==void 0&&(t=t.concat(e.x.times)),e.y!==void 0&&(t=t.concat(e.y.times)),e.z!==void 0&&(t=t.concat(e.z.times)),t=t.sort(function(i,s){return i-s}),t.length>1){let i=1,s=t[0];for(let r=1;r<t.length;r++){const o=t[r];o!==s&&(t[i]=o,s=o,i++)}t=t.slice(0,i)}return t}getKeyframeTrackValues(e,t,i){const s=i,r=[];let o=-1,a=-1,c=-1;return e.forEach(function(l){if(t.x&&(o=t.x.times.indexOf(l)),t.y&&(a=t.y.times.indexOf(l)),t.z&&(c=t.z.times.indexOf(l)),o!==-1){const u=t.x.values[o];r.push(u),s[0]=u}else r.push(s[0]);if(a!==-1){const u=t.y.values[a];r.push(u),s[1]=u}else r.push(s[1]);if(c!==-1){const u=t.z.values[c];r.push(u),s[2]=u}else r.push(s[2])}),r}interpolateRotations(e){for(let t=1;t<e.values.length;t++){const i=e.values[t-1],s=e.values[t]-i,r=Math.abs(s);if(r>=180){const o=r/180,a=s/o;let c=i+a;const l=e.times[t-1],h=(e.times[t]-l)/o;let f=l+h;const d=[],p=[];for(;f<e.times[t];)d.push(f),f+=h,p.push(c),c+=a;e.times=Yd(e.times,t,d),e.values=Yd(e.values,t,p)}}}}class L4{getPrevNode(){return this.nodeStack[this.currentIndent-2]}getCurrentNode(){return this.nodeStack[this.currentIndent-1]}getCurrentProp(){return this.currentProp}pushStack(e){this.nodeStack.push(e),this.currentIndent+=1}popStack(){this.nodeStack.pop(),this.currentIndent-=1}setCurrentProp(e,t){this.currentProp=e,this.currentPropName=t}parse(e){this.currentIndent=0,this.allNodes=new q1,this.nodeStack=[],this.currentProp=[],this.currentPropName="";const t=this,i=e.split(/[\r\n]+/);return i.forEach(function(s,r){const o=s.match(/^[\s\t]*;/),a=s.match(/^[\s\t]*$/);if(o||a)return;const c=s.match("^\\t{"+t.currentIndent+"}(\\w+):(.*){",""),l=s.match("^\\t{"+t.currentIndent+"}(\\w+):[\\s\\t\\r\\n](.*)"),u=s.match("^\\t{"+(t.currentIndent-1)+"}}");c?t.parseNodeBegin(s,c):l?t.parseNodeProperty(s,l,i[++r]):u?t.popStack():s.match(/^[^\s\t}]/)&&t.parseNodePropertyContinued(s)}),this.allNodes}parseNodeBegin(e,t){const i=t[1].trim().replace(/^"/,"").replace(/"$/,""),s=t[2].split(",").map(function(c){return c.trim().replace(/^"/,"").replace(/"$/,"")}),r={name:i},o=this.parseNodeAttr(s),a=this.getCurrentNode();this.currentIndent===0?this.allNodes.add(i,r):i in a?(i==="PoseNode"?a.PoseNode.push(r):a[i].id!==void 0&&(a[i]={},a[i][a[i].id]=a[i]),o.id!==""&&(a[i][o.id]=r)):typeof o.id=="number"?(a[i]={},a[i][o.id]=r):i!=="Properties70"&&(i==="PoseNode"?a[i]=[r]:a[i]=r),typeof o.id=="number"&&(r.id=o.id),o.name!==""&&(r.attrName=o.name),o.type!==""&&(r.attrType=o.type),this.pushStack(r)}parseNodeAttr(e){let t=e[0];e[0]!==""&&(t=parseInt(e[0]),isNaN(t)&&(t=e[0]));let i="",s="";return e.length>1&&(i=e[1].replace(/^(\w+)::/,""),s=e[2]),{id:t,name:i,type:s}}parseNodeProperty(e,t,i){let s=t[1].replace(/^"/,"").replace(/"$/,"").trim(),r=t[2].replace(/^"/,"").replace(/"$/,"").trim();s==="Content"&&r===","&&(r=i.replace(/"/g,"").replace(/,$/,"").trim());const o=this.getCurrentNode();if(o.name==="Properties70"){this.parseNodeSpecialProperty(e,s,r);return}if(s==="C"){const c=r.split(",").slice(1),l=parseInt(c[0]),u=parseInt(c[1]);let h=r.split(",").slice(3);h=h.map(function(f){return f.trim().replace(/^"/,"")}),s="connections",r=[l,u],Q4(r,h),o[s]===void 0&&(o[s]=[])}s==="Node"&&(o.id=r),s in o&&Array.isArray(o[s])?o[s].push(r):s!=="a"?o[s]=r:o.a=r,this.setCurrentProp(o,s),s==="a"&&r.slice(-1)!==","&&(o.a=pl(r))}parseNodePropertyContinued(e){const t=this.getCurrentNode();t.a+=e,e.slice(-1)!==","&&(t.a=pl(t.a))}parseNodeSpecialProperty(e,t,i){const s=i.split('",').map(function(u){return u.trim().replace(/^\"/,"").replace(/\s/,"_")}),r=s[0],o=s[1],a=s[2],c=s[3];let l=s[4];switch(o){case"int":case"enum":case"bool":case"ULongLong":case"double":case"Number":case"FieldOfView":l=parseFloat(l);break;case"Color":case"ColorRGB":case"Vector3D":case"Lcl_Translation":case"Lcl_Rotation":case"Lcl_Scaling":l=pl(l);break}this.getPrevNode()[r]={type:o,type2:a,flag:c,value:l},this.setCurrentProp(this.getPrevNode(),r)}}class P4{parse(e){const t=new Kd(e);t.skip(23);const i=t.getUint32();if(i<6400)throw new Error("THREE.FBXLoader: FBX version not supported, FileVersion: "+i);const s=new q1;for(;!this.endOfContent(t);){const r=this.parseNode(t,i);r!==null&&s.add(r.name,r)}return s}endOfContent(e){return e.size()%16===0?(e.getOffset()+160+16&-16)>=e.size():e.getOffset()+160+16>=e.size()}parseNode(e,t){const i={},s=t>=7500?e.getUint64():e.getUint32(),r=t>=7500?e.getUint64():e.getUint32();t>=7500?e.getUint64():e.getUint32();const o=e.getUint8(),a=e.getString(o);if(s===0)return null;const c=[];for(let f=0;f<r;f++)c.push(this.parseProperty(e));const l=c.length>0?c[0]:"",u=c.length>1?c[1]:"",h=c.length>2?c[2]:"";for(i.singleProperty=r===1&&e.getOffset()===s;s>e.getOffset();){const f=this.parseNode(e,t);f!==null&&this.parseSubNode(a,i,f)}return i.propertyList=c,typeof l=="number"&&(i.id=l),u!==""&&(i.attrName=u),h!==""&&(i.attrType=h),a!==""&&(i.name=a),i}parseSubNode(e,t,i){if(i.singleProperty===!0){const s=i.propertyList[0];Array.isArray(s)?(t[i.name]=i,i.a=s):t[i.name]=s}else if(e==="Connections"&&i.name==="C"){const s=[];i.propertyList.forEach(function(r,o){o!==0&&s.push(r)}),t.connections===void 0&&(t.connections=[]),t.connections.push(s)}else if(i.name==="Properties70")Object.keys(i).forEach(function(r){t[r]=i[r]});else if(e==="Properties70"&&i.name==="P"){let s=i.propertyList[0],r=i.propertyList[1];const o=i.propertyList[2],a=i.propertyList[3];let c;s.indexOf("Lcl ")===0&&(s=s.replace("Lcl ","Lcl_")),r.indexOf("Lcl ")===0&&(r=r.replace("Lcl ","Lcl_")),r==="Color"||r==="ColorRGB"||r==="Vector"||r==="Vector3D"||r.indexOf("Lcl_")===0?c=[i.propertyList[4],i.propertyList[5],i.propertyList[6]]:c=i.propertyList[4],t[s]={type:r,type2:o,flag:a,value:c}}else t[i.name]===void 0?typeof i.id=="number"?(t[i.name]={},t[i.name][i.id]=i):t[i.name]=i:i.name==="PoseNode"?(Array.isArray(t[i.name])||(t[i.name]=[t[i.name]]),t[i.name].push(i)):t[i.name][i.id]===void 0&&(t[i.name][i.id]=i)}parseProperty(e){const t=e.getString(1);let i;switch(t){case"C":return e.getBoolean();case"D":return e.getFloat64();case"F":return e.getFloat32();case"I":return e.getInt32();case"L":return e.getInt64();case"R":return i=e.getUint32(),e.getArrayBuffer(i);case"S":return i=e.getUint32(),e.getString(i);case"Y":return e.getInt16();case"b":case"c":case"d":case"f":case"i":case"l":const s=e.getUint32(),r=e.getUint32(),o=e.getUint32();if(r===0)switch(t){case"b":case"c":return e.getBooleanArray(s);case"d":return e.getFloat64Array(s);case"f":return e.getFloat32Array(s);case"i":return e.getInt32Array(s);case"l":return e.getInt64Array(s)}const a=Ey(new Uint8Array(e.getArrayBuffer(o))),c=new Kd(a.buffer);switch(t){case"b":case"c":return c.getBooleanArray(s);case"d":return c.getFloat64Array(s);case"f":return c.getFloat32Array(s);case"i":return c.getInt32Array(s);case"l":return c.getInt64Array(s)}default:throw new Error("THREE.FBXLoader: Unknown property type "+t)}}}class Kd{constructor(e,t){this.dv=new DataView(e),this.offset=0,this.littleEndian=t!==void 0?t:!0}getOffset(){return this.offset}size(){return this.dv.buffer.byteLength}skip(e){this.offset+=e}getBoolean(){return(this.getUint8()&1)===1}getBooleanArray(e){const t=[];for(let i=0;i<e;i++)t.push(this.getBoolean());return t}getUint8(){const e=this.dv.getUint8(this.offset);return this.offset+=1,e}getInt16(){const e=this.dv.getInt16(this.offset,this.littleEndian);return this.offset+=2,e}getInt32(){const e=this.dv.getInt32(this.offset,this.littleEndian);return this.offset+=4,e}getInt32Array(e){const t=[];for(let i=0;i<e;i++)t.push(this.getInt32());return t}getUint32(){const e=this.dv.getUint32(this.offset,this.littleEndian);return this.offset+=4,e}getInt64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),t&2147483648?(t=~t&4294967295,e=~e&4294967295,e===4294967295&&(t=t+1&4294967295),e=e+1&4294967295,-(t*4294967296+e)):t*4294967296+e}getInt64Array(e){const t=[];for(let i=0;i<e;i++)t.push(this.getInt64());return t}getUint64(){let e,t;return this.littleEndian?(e=this.getUint32(),t=this.getUint32()):(t=this.getUint32(),e=this.getUint32()),t*4294967296+e}getFloat32(){const e=this.dv.getFloat32(this.offset,this.littleEndian);return this.offset+=4,e}getFloat32Array(e){const t=[];for(let i=0;i<e;i++)t.push(this.getFloat32());return t}getFloat64(){const e=this.dv.getFloat64(this.offset,this.littleEndian);return this.offset+=8,e}getFloat64Array(e){const t=[];for(let i=0;i<e;i++)t.push(this.getFloat64());return t}getArrayBuffer(e){const t=this.dv.buffer.slice(this.offset,this.offset+e);return this.offset+=e,t}getString(e){let t=[];for(let s=0;s<e;s++)t[s]=this.getUint8();const i=t.indexOf(0);return i>=0&&(t=t.slice(0,i)),mr(new Uint8Array(t))}}class q1{add(e,t){this[e]=t}}function F4(n){const e="Kaydara FBX Binary  \0";return n.byteLength>=e.length&&e===ep(n,0,e.length)}function k4(n){const e=["K","a","y","d","a","r","a","\\","F","B","X","\\","B","i","n","a","r","y","\\","\\"];let t=0;function i(s){const r=n[s-1];return n=n.slice(t+s),t++,r}for(let s=0;s<e.length;++s)if(i(1)===e[s])return!1;return!0}function Vd(n){const e=/FBXVersion: (\d+)/,t=n.match(e);if(t)return parseInt(t[1]);throw new Error("THREE.FBXLoader: Cannot find the version number for the file given.")}function O4(n){return n/46186158e3}const U4=[];function Zo(n,e,t,i){let s;switch(i.mappingType){case"ByPolygonVertex":s=n;break;case"ByPolygon":s=e;break;case"ByVertice":s=t;break;case"AllSame":s=i.indices[0];break;default:console.warn("THREE.FBXLoader: unknown attribute mapping type "+i.mappingType)}i.referenceType==="IndexToDirect"&&(s=i.indices[s]);const r=s*i.dataSize,o=r+i.dataSize;return N4(U4,i.buffer,r,o)}const ml=new ai,wn=new b;function X1(n){const e=new ce,t=new ce,i=new ce,s=new ce,r=new ce,o=new ce,a=new ce,c=new ce,l=new ce,u=new ce,h=new ce,f=new ce,d=n.inheritType?n.inheritType:0;if(n.translation&&e.setPosition(wn.fromArray(n.translation)),n.preRotation){const T=n.preRotation.map(Ce.degToRad);T.push(n.eulerOrder),t.makeRotationFromEuler(ml.fromArray(T))}if(n.rotation){const T=n.rotation.map(Ce.degToRad);T.push(n.eulerOrder),i.makeRotationFromEuler(ml.fromArray(T))}if(n.postRotation){const T=n.postRotation.map(Ce.degToRad);T.push(n.eulerOrder),s.makeRotationFromEuler(ml.fromArray(T)),s.invert()}n.scale&&r.scale(wn.fromArray(n.scale)),n.scalingOffset&&a.setPosition(wn.fromArray(n.scalingOffset)),n.scalingPivot&&o.setPosition(wn.fromArray(n.scalingPivot)),n.rotationOffset&&c.setPosition(wn.fromArray(n.rotationOffset)),n.rotationPivot&&l.setPosition(wn.fromArray(n.rotationPivot)),n.parentMatrixWorld&&(h.copy(n.parentMatrix),u.copy(n.parentMatrixWorld));const p=t.clone().multiply(i).multiply(s),m=new ce;m.extractRotation(u);const g=new ce;g.copyPosition(u);const y=g.clone().invert().multiply(u),v=m.clone().invert().multiply(y),E=r,C=new ce;if(d===0)C.copy(m).multiply(p).multiply(v).multiply(E);else if(d===1)C.copy(m).multiply(v).multiply(p).multiply(E);else{const R=new ce().scale(new b().setFromMatrixScale(h)).clone().invert(),_=v.clone().multiply(R);C.copy(m).multiply(p).multiply(_).multiply(E)}const x=l.clone().invert(),I=o.clone().invert();let S=e.clone().multiply(c).multiply(l).multiply(t).multiply(i).multiply(s).multiply(x).multiply(a).multiply(o).multiply(r).multiply(I);const w=new ce().copyPosition(S),B=u.clone().multiply(w);return f.copyPosition(B),S=f.clone().multiply(C),S.premultiply(u.invert()),S}function Z1(n){n=n||0;const e=["ZYX","YZX","XZY","ZXY","YXZ","XYZ"];return n===6?(console.warn("THREE.FBXLoader: unsupported Euler Order: Spherical XYZ. Animations and rotations may be incorrect."),e[0]):e[n]}function pl(n){return n.split(",").map(function(t){return parseFloat(t)})}function ep(n,e,t){return e===void 0&&(e=0),t===void 0&&(t=n.byteLength),mr(new Uint8Array(n,e,t))}function Q4(n,e){for(let t=0,i=n.length,s=e.length;t<s;t++,i++)n[i]=e[t]}function N4(n,e,t,i){for(let s=t,r=0;s<i;s++,r++)n[r]=e[s];return n}function Yd(n,e,t){return n.slice(0,e).concat(t).concat(n.slice(e))}var G4=Object.defineProperty,z4=(n,e,t)=>e in n?G4(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,Wh=(n,e,t)=>(z4(n,typeof e!="symbol"?e+"":e,t),t);class H4 extends fn{constructor(e){super(e)}load(e,t,i,s){const r=new ss(this.manager);r.setPath(this.path),r.setRequestHeader(this.requestHeader),r.setWithCredentials(this.withCredentials),r.load(e,o=>{if(typeof o!="string")throw new Error("unsupported data type");const a=JSON.parse(o),c=this.parse(a);t&&t(c)},i,s)}loadAsync(e,t){return super.loadAsync(e,t)}parse(e){return new jh(e)}}class jh{constructor(e){Wh(this,"data"),this.data=e}generateShapes(e,t=100,i){const s=[],r={letterSpacing:0,lineHeight:1,...i},o=K4(e,t,this.data,r);for(let a=0,c=o.length;a<c;a++)Array.prototype.push.apply(s,o[a].toShapes(!1));return s}}Wh(jh,"isFont");Wh(jh,"type");function K4(n,e,t,i){const s=Array.from(n),r=e/t.resolution,o=(t.boundingBox.yMax-t.boundingBox.yMin+t.underlineThickness)*r,a=[];let c=0,l=0;for(let u=0;u<s.length;u++){const h=s[u];if(h===`
`)c=0,l-=o*i.lineHeight;else{const f=V4(h,r,c,l,t);f&&(c+=f.offsetX+i.letterSpacing,a.push(f.path))}}return a}function V4(n,e,t,i,s){const r=s.glyphs[n]||s.glyphs["?"];if(!r){console.error('THREE.Font: character "'+n+'" does not exists in font family '+s.familyName+".");return}const o=new Ps;let a,c,l,u,h,f,d,p;if(r.o){const m=r._cachedOutline||(r._cachedOutline=r.o.split(" "));for(let g=0,y=m.length;g<y;)switch(m[g++]){case"m":a=parseInt(m[g++])*e+t,c=parseInt(m[g++])*e+i,o.moveTo(a,c);break;case"l":a=parseInt(m[g++])*e+t,c=parseInt(m[g++])*e+i,o.lineTo(a,c);break;case"q":l=parseInt(m[g++])*e+t,u=parseInt(m[g++])*e+i,h=parseInt(m[g++])*e+t,f=parseInt(m[g++])*e+i,o.quadraticCurveTo(h,f,l,u);break;case"b":l=parseInt(m[g++])*e+t,u=parseInt(m[g++])*e+i,h=parseInt(m[g++])*e+t,f=parseInt(m[g++])*e+i,d=parseInt(m[g++])*e+t,p=parseInt(m[g++])*e+i,o.bezierCurveTo(h,f,d,p,l,u);break}}return{offsetX:r.ha*e,path:o}}class Y4 extends as{constructor(e=null,t=1,i=1,s=1){super(null),this.isData3DTexture=!0,this.image={data:e,width:t,height:i,depth:s},this.magFilter=Xe,this.minFilter=Xe,this.wrapR=Ro,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}}class $4{constructor(e=4){this.pool=e,this.queue=[],this.workers=[],this.workersResolve=[],this.workerStatus=0}_initWorker(e){if(!this.workers[e]){const t=this.workerCreator();t.addEventListener("message",this._onMessage.bind(this,e)),this.workers[e]=t}}_getIdleWorker(){for(let e=0;e<this.pool;e++)if(!(this.workerStatus&1<<e))return e;return-1}_onMessage(e,t){const i=this.workersResolve[e];if(i&&i(t),this.queue.length){const{resolve:s,msg:r,transfer:o}=this.queue.shift();this.workersResolve[e]=s,this.workers[e].postMessage(r,o)}else this.workerStatus^=1<<e}setWorkerCreator(e){this.workerCreator=e}setWorkerLimit(e){this.pool=e}postMessage(e,t){return new Promise(i=>{const s=this._getIdleWorker();s!==-1?(this._initWorker(s),this.workerStatus|=1<<s,this.workersResolve[s]=i,this.workers[s].postMessage(e,t)):this.queue.push({resolve:i,msg:e,transfer:t})})}dispose(){this.workers.forEach(e=>e.terminate()),this.workersResolve.length=0,this.workers.length=0,this.queue.length=0,this.workerStatus=0}}const tp=0,$d=2,W4=0,j4=0,J4=2,q4=0,X4=0,Z4=1,ih=2,eC=0,ip=1,tC=10,iC=64,sp=0,np=9,rp=15,op=16,ap=22,cp=37,lp=43,up=76,hp=83,fp=97,dp=100,Ap=103,mp=109,pp=165,gp=166;class sC{constructor(){this.vkFormat=sp,this.typeSize=1,this.pixelWidth=0,this.pixelHeight=0,this.pixelDepth=0,this.layerCount=0,this.faceCount=1,this.supercompressionScheme=tp,this.levels=[],this.dataFormatDescriptor=[{vendorId:j4,descriptorType:W4,descriptorBlockSize:0,versionNumber:J4,colorModel:q4,colorPrimaries:ip,transferFunction:ih,flags:X4,texelBlockDimension:[0,0,0,0],bytesPlane:[0,0,0,0,0,0,0,0],samples:[]}],this.keyValue={},this.globalData=null}}class Yr{constructor(e,t,i,s){this._dataView=void 0,this._littleEndian=void 0,this._offset=void 0,this._dataView=new DataView(e.buffer,e.byteOffset+t,i),this._littleEndian=s,this._offset=0}_nextUint8(){const e=this._dataView.getUint8(this._offset);return this._offset+=1,e}_nextUint16(){const e=this._dataView.getUint16(this._offset,this._littleEndian);return this._offset+=2,e}_nextUint32(){const e=this._dataView.getUint32(this._offset,this._littleEndian);return this._offset+=4,e}_nextUint64(){const e=this._dataView.getUint32(this._offset,this._littleEndian),t=this._dataView.getUint32(this._offset+4,this._littleEndian),i=e+2**32*t;return this._offset+=8,i}_nextInt32(){const e=this._dataView.getInt32(this._offset,this._littleEndian);return this._offset+=4,e}_nextUint8Array(e){const t=new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+this._offset,e);return this._offset+=e,t}_skip(e){return this._offset+=e,this}_scan(e,t){t===void 0&&(t=0);const i=this._offset;let s=0;for(;this._dataView.getUint8(this._offset)!==t&&s<e;)s++,this._offset++;return s<e&&this._offset++,new Uint8Array(this._dataView.buffer,this._dataView.byteOffset+i,s)}}const Vt=[171,75,84,88,32,50,48,187,13,10,26,10];function Wd(n){return typeof TextDecoder<"u"?new TextDecoder().decode(n):Buffer.from(n).toString("utf8")}function nC(n){const e=new Uint8Array(n.buffer,n.byteOffset,Vt.length);if(e[0]!==Vt[0]||e[1]!==Vt[1]||e[2]!==Vt[2]||e[3]!==Vt[3]||e[4]!==Vt[4]||e[5]!==Vt[5]||e[6]!==Vt[6]||e[7]!==Vt[7]||e[8]!==Vt[8]||e[9]!==Vt[9]||e[10]!==Vt[10]||e[11]!==Vt[11])throw new Error("Missing KTX 2.0 identifier.");const t=new sC,i=17*Uint32Array.BYTES_PER_ELEMENT,s=new Yr(n,Vt.length,i,!0);t.vkFormat=s._nextUint32(),t.typeSize=s._nextUint32(),t.pixelWidth=s._nextUint32(),t.pixelHeight=s._nextUint32(),t.pixelDepth=s._nextUint32(),t.layerCount=s._nextUint32(),t.faceCount=s._nextUint32();const r=s._nextUint32();t.supercompressionScheme=s._nextUint32();const o=s._nextUint32(),a=s._nextUint32(),c=s._nextUint32(),l=s._nextUint32(),u=s._nextUint64(),h=s._nextUint64(),f=r*3*8,d=new Yr(n,Vt.length+i,f,!0);for(let N=0;N<r;N++)t.levels.push({levelData:new Uint8Array(n.buffer,n.byteOffset+d._nextUint64(),d._nextUint64()),uncompressedByteLength:d._nextUint64()});const p=new Yr(n,o,a,!0),m={vendorId:p._skip(4)._nextUint16(),descriptorType:p._nextUint16(),versionNumber:p._nextUint16(),descriptorBlockSize:p._nextUint16(),colorModel:p._nextUint8(),colorPrimaries:p._nextUint8(),transferFunction:p._nextUint8(),flags:p._nextUint8(),texelBlockDimension:[p._nextUint8(),p._nextUint8(),p._nextUint8(),p._nextUint8()],bytesPlane:[p._nextUint8(),p._nextUint8(),p._nextUint8(),p._nextUint8(),p._nextUint8(),p._nextUint8(),p._nextUint8(),p._nextUint8()],samples:[]},v=(m.descriptorBlockSize/4-6)/4;for(let N=0;N<v;N++){const V={bitOffset:p._nextUint16(),bitLength:p._nextUint8(),channelType:p._nextUint8(),samplePosition:[p._nextUint8(),p._nextUint8(),p._nextUint8(),p._nextUint8()],sampleLower:-1/0,sampleUpper:1/0};V.channelType&iC?(V.sampleLower=p._nextInt32(),V.sampleUpper=p._nextInt32()):(V.sampleLower=p._nextUint32(),V.sampleUpper=p._nextUint32()),m.samples[N]=V}t.dataFormatDescriptor.length=0,t.dataFormatDescriptor.push(m);const E=new Yr(n,c,l,!0);for(;E._offset<l;){const N=E._nextUint32(),V=E._scan(N),$=Wd(V);if(t.keyValue[$]=E._nextUint8Array(N-V.byteLength-1),$.match(/^ktx/i)){const M=Wd(t.keyValue[$]);t.keyValue[$]=M.substring(0,M.lastIndexOf("\0"))}const Y=N%4?4-N%4:0;E._skip(Y)}if(h<=0)return t;const C=new Yr(n,u,h,!0),x=C._nextUint16(),I=C._nextUint16(),S=C._nextUint32(),w=C._nextUint32(),B=C._nextUint32(),T=C._nextUint32(),R=[];for(let N=0;N<r;N++)R.push({imageFlags:C._nextUint32(),rgbSliceByteOffset:C._nextUint32(),rgbSliceByteLength:C._nextUint32(),alphaSliceByteOffset:C._nextUint32(),alphaSliceByteLength:C._nextUint32()});const _=u+C._offset,L=_+S,O=L+w,U=O+B,Q=new Uint8Array(n.buffer,n.byteOffset+_,S),G=new Uint8Array(n.buffer,n.byteOffset+L,w),z=new Uint8Array(n.buffer,n.byteOffset+O,B),H=new Uint8Array(n.buffer,n.byteOffset+U,T);return t.globalData={endpointCount:x,selectorCount:I,imageDescs:R,endpointsData:Q,selectorsData:G,tablesData:z,extendedData:H},t}let $r,ps,sh;const gl={env:{emscripten_notify_memory_growth:function(n){sh=new Uint8Array(ps.exports.memory.buffer)}}};class rC{init(){return $r||(typeof fetch<"u"?$r=fetch("data:application/wasm;base64,"+jd).then(e=>e.arrayBuffer()).then(e=>WebAssembly.instantiate(e,gl)).then(this._init):$r=WebAssembly.instantiate(Buffer.from(jd,"base64"),gl).then(this._init),$r)}_init(e){ps=e.instance,gl.env.emscripten_notify_memory_growth(0)}decode(e,t=0){if(!ps)throw new Error("ZSTDDecoder: Await .init() before decoding.");const i=e.byteLength,s=ps.exports.malloc(i);sh.set(e,s),t=t||Number(ps.exports.ZSTD_findDecompressedSize(s,i));const r=ps.exports.malloc(t),o=ps.exports.ZSTD_decompress(r,t,s,i),a=sh.slice(r,r+o);return ps.exports.free(s),ps.exports.free(r),a}}const jd="AGFzbQEAAAABpQEVYAF/AX9gAn9/AGADf39/AX9gBX9/f39/AX9gAX8AYAJ/fwF/YAR/f39/AX9gA39/fwBgBn9/f39/fwF/YAd/f39/f39/AX9gAn9/AX5gAn5+AX5gAABgBX9/f39/AGAGf39/f39/AGAIf39/f39/f38AYAl/f39/f39/f38AYAABf2AIf39/f39/f38Bf2ANf39/f39/f39/f39/fwF/YAF/AX4CJwEDZW52H2Vtc2NyaXB0ZW5fbm90aWZ5X21lbW9yeV9ncm93dGgABANpaAEFAAAFAgEFCwACAQABAgIFBQcAAwABDgsBAQcAEhMHAAUBDAQEAAANBwQCAgYCBAgDAwMDBgEACQkHBgICAAYGAgQUBwYGAwIGAAMCAQgBBwUGCgoEEQAEBAEIAwgDBQgDEA8IAAcABAUBcAECAgUEAQCAAgYJAX8BQaCgwAILB2AHBm1lbW9yeQIABm1hbGxvYwAoBGZyZWUAJgxaU1REX2lzRXJyb3IAaBlaU1REX2ZpbmREZWNvbXByZXNzZWRTaXplAFQPWlNURF9kZWNvbXByZXNzAEoGX3N0YXJ0ACQJBwEAQQELASQKussBaA8AIAAgACgCBCABajYCBAsZACAAKAIAIAAoAgRBH3F0QQAgAWtBH3F2CwgAIABBiH9LC34BBH9BAyEBIAAoAgQiA0EgTQRAIAAoAggiASAAKAIQTwRAIAAQDQ8LIAAoAgwiAiABRgRAQQFBAiADQSBJGw8LIAAgASABIAJrIANBA3YiBCABIARrIAJJIgEbIgJrIgQ2AgggACADIAJBA3RrNgIEIAAgBCgAADYCAAsgAQsUAQF/IAAgARACIQIgACABEAEgAgv3AQECfyACRQRAIABCADcCACAAQQA2AhAgAEIANwIIQbh/DwsgACABNgIMIAAgAUEEajYCECACQQRPBEAgACABIAJqIgFBfGoiAzYCCCAAIAMoAAA2AgAgAUF/ai0AACIBBEAgAEEIIAEQFGs2AgQgAg8LIABBADYCBEF/DwsgACABNgIIIAAgAS0AACIDNgIAIAJBfmoiBEEBTQRAIARBAWtFBEAgACABLQACQRB0IANyIgM2AgALIAAgAS0AAUEIdCADajYCAAsgASACakF/ai0AACIBRQRAIABBADYCBEFsDwsgAEEoIAEQFCACQQN0ams2AgQgAgsWACAAIAEpAAA3AAAgACABKQAINwAICy8BAX8gAUECdEGgHWooAgAgACgCAEEgIAEgACgCBGprQR9xdnEhAiAAIAEQASACCyEAIAFCz9bTvtLHq9lCfiAAfEIfiUKHla+vmLbem55/fgsdAQF/IAAoAgggACgCDEYEfyAAKAIEQSBGBUEACwuCBAEDfyACQYDAAE8EQCAAIAEgAhBnIAAPCyAAIAJqIQMCQCAAIAFzQQNxRQRAAkAgAkEBSARAIAAhAgwBCyAAQQNxRQRAIAAhAgwBCyAAIQIDQCACIAEtAAA6AAAgAUEBaiEBIAJBAWoiAiADTw0BIAJBA3ENAAsLAkAgA0F8cSIEQcAASQ0AIAIgBEFAaiIFSw0AA0AgAiABKAIANgIAIAIgASgCBDYCBCACIAEoAgg2AgggAiABKAIMNgIMIAIgASgCEDYCECACIAEoAhQ2AhQgAiABKAIYNgIYIAIgASgCHDYCHCACIAEoAiA2AiAgAiABKAIkNgIkIAIgASgCKDYCKCACIAEoAiw2AiwgAiABKAIwNgIwIAIgASgCNDYCNCACIAEoAjg2AjggAiABKAI8NgI8IAFBQGshASACQUBrIgIgBU0NAAsLIAIgBE8NAQNAIAIgASgCADYCACABQQRqIQEgAkEEaiICIARJDQALDAELIANBBEkEQCAAIQIMAQsgA0F8aiIEIABJBEAgACECDAELIAAhAgNAIAIgAS0AADoAACACIAEtAAE6AAEgAiABLQACOgACIAIgAS0AAzoAAyABQQRqIQEgAkEEaiICIARNDQALCyACIANJBEADQCACIAEtAAA6AAAgAUEBaiEBIAJBAWoiAiADRw0ACwsgAAsMACAAIAEpAAA3AAALQQECfyAAKAIIIgEgACgCEEkEQEEDDwsgACAAKAIEIgJBB3E2AgQgACABIAJBA3ZrIgE2AgggACABKAAANgIAQQALDAAgACABKAIANgAAC/cCAQJ/AkAgACABRg0AAkAgASACaiAASwRAIAAgAmoiBCABSw0BCyAAIAEgAhALDwsgACABc0EDcSEDAkACQCAAIAFJBEAgAwRAIAAhAwwDCyAAQQNxRQRAIAAhAwwCCyAAIQMDQCACRQ0EIAMgAS0AADoAACABQQFqIQEgAkF/aiECIANBAWoiA0EDcQ0ACwwBCwJAIAMNACAEQQNxBEADQCACRQ0FIAAgAkF/aiICaiIDIAEgAmotAAA6AAAgA0EDcQ0ACwsgAkEDTQ0AA0AgACACQXxqIgJqIAEgAmooAgA2AgAgAkEDSw0ACwsgAkUNAgNAIAAgAkF/aiICaiABIAJqLQAAOgAAIAINAAsMAgsgAkEDTQ0AIAIhBANAIAMgASgCADYCACABQQRqIQEgA0EEaiEDIARBfGoiBEEDSw0ACyACQQNxIQILIAJFDQADQCADIAEtAAA6AAAgA0EBaiEDIAFBAWohASACQX9qIgINAAsLIAAL8wICAn8BfgJAIAJFDQAgACACaiIDQX9qIAE6AAAgACABOgAAIAJBA0kNACADQX5qIAE6AAAgACABOgABIANBfWogAToAACAAIAE6AAIgAkEHSQ0AIANBfGogAToAACAAIAE6AAMgAkEJSQ0AIABBACAAa0EDcSIEaiIDIAFB/wFxQYGChAhsIgE2AgAgAyACIARrQXxxIgRqIgJBfGogATYCACAEQQlJDQAgAyABNgIIIAMgATYCBCACQXhqIAE2AgAgAkF0aiABNgIAIARBGUkNACADIAE2AhggAyABNgIUIAMgATYCECADIAE2AgwgAkFwaiABNgIAIAJBbGogATYCACACQWhqIAE2AgAgAkFkaiABNgIAIAQgA0EEcUEYciIEayICQSBJDQAgAa0iBUIghiAFhCEFIAMgBGohAQNAIAEgBTcDGCABIAU3AxAgASAFNwMIIAEgBTcDACABQSBqIQEgAkFgaiICQR9LDQALCyAACy8BAn8gACgCBCAAKAIAQQJ0aiICLQACIQMgACACLwEAIAEgAi0AAxAIajYCACADCy8BAn8gACgCBCAAKAIAQQJ0aiICLQACIQMgACACLwEAIAEgAi0AAxAFajYCACADCx8AIAAgASACKAIEEAg2AgAgARAEGiAAIAJBCGo2AgQLCAAgAGdBH3MLugUBDX8jAEEQayIKJAACfyAEQQNNBEAgCkEANgIMIApBDGogAyAEEAsaIAAgASACIApBDGpBBBAVIgBBbCAAEAMbIAAgACAESxsMAQsgAEEAIAEoAgBBAXRBAmoQECENQVQgAygAACIGQQ9xIgBBCksNABogAiAAQQVqNgIAIAMgBGoiAkF8aiEMIAJBeWohDiACQXtqIRAgAEEGaiELQQQhBSAGQQR2IQRBICAAdCIAQQFyIQkgASgCACEPQQAhAiADIQYCQANAIAlBAkggAiAPS3JFBEAgAiEHAkAgCARAA0AgBEH//wNxQf//A0YEQCAHQRhqIQcgBiAQSQR/IAZBAmoiBigAACAFdgUgBUEQaiEFIARBEHYLIQQMAQsLA0AgBEEDcSIIQQNGBEAgBUECaiEFIARBAnYhBCAHQQNqIQcMAQsLIAcgCGoiByAPSw0EIAVBAmohBQNAIAIgB0kEQCANIAJBAXRqQQA7AQAgAkEBaiECDAELCyAGIA5LQQAgBiAFQQN1aiIHIAxLG0UEQCAHKAAAIAVBB3EiBXYhBAwCCyAEQQJ2IQQLIAYhBwsCfyALQX9qIAQgAEF/anEiBiAAQQF0QX9qIgggCWsiEUkNABogBCAIcSIEQQAgESAEIABIG2shBiALCyEIIA0gAkEBdGogBkF/aiIEOwEAIAlBASAGayAEIAZBAUgbayEJA0AgCSAASARAIABBAXUhACALQX9qIQsMAQsLAn8gByAOS0EAIAcgBSAIaiIFQQN1aiIGIAxLG0UEQCAFQQdxDAELIAUgDCIGIAdrQQN0awshBSACQQFqIQIgBEUhCCAGKAAAIAVBH3F2IQQMAQsLQWwgCUEBRyAFQSBKcg0BGiABIAJBf2o2AgAgBiAFQQdqQQN1aiADawwBC0FQCyEAIApBEGokACAACwkAQQFBBSAAGwsMACAAIAEoAAA2AAALqgMBCn8jAEHwAGsiCiQAIAJBAWohDiAAQQhqIQtBgIAEIAVBf2p0QRB1IQxBACECQQEhBkEBIAV0IglBf2oiDyEIA0AgAiAORkUEQAJAIAEgAkEBdCINai8BACIHQf//A0YEQCALIAhBA3RqIAI2AgQgCEF/aiEIQQEhBwwBCyAGQQAgDCAHQRB0QRB1ShshBgsgCiANaiAHOwEAIAJBAWohAgwBCwsgACAFNgIEIAAgBjYCACAJQQN2IAlBAXZqQQNqIQxBACEAQQAhBkEAIQIDQCAGIA5GBEADQAJAIAAgCUYNACAKIAsgAEEDdGoiASgCBCIGQQF0aiICIAIvAQAiAkEBajsBACABIAUgAhAUayIIOgADIAEgAiAIQf8BcXQgCWs7AQAgASAEIAZBAnQiAmooAgA6AAIgASACIANqKAIANgIEIABBAWohAAwBCwsFIAEgBkEBdGouAQAhDUEAIQcDQCAHIA1ORQRAIAsgAkEDdGogBjYCBANAIAIgDGogD3EiAiAISw0ACyAHQQFqIQcMAQsLIAZBAWohBgwBCwsgCkHwAGokAAsjAEIAIAEQCSAAhUKHla+vmLbem55/fkLj3MqV/M7y9YV/fAsQACAAQn43AwggACABNgIACyQBAX8gAARAIAEoAgQiAgRAIAEoAgggACACEQEADwsgABAmCwsfACAAIAEgAi8BABAINgIAIAEQBBogACACQQRqNgIEC0oBAX9BoCAoAgAiASAAaiIAQX9MBEBBiCBBMDYCAEF/DwsCQCAAPwBBEHRNDQAgABBmDQBBiCBBMDYCAEF/DwtBoCAgADYCACABC9cBAQh/Qbp/IQoCQCACKAIEIgggAigCACIJaiIOIAEgAGtLDQBBbCEKIAkgBCADKAIAIgtrSw0AIAAgCWoiBCACKAIIIgxrIQ0gACABQWBqIg8gCyAJQQAQKSADIAkgC2o2AgACQAJAIAwgBCAFa00EQCANIQUMAQsgDCAEIAZrSw0CIAcgDSAFayIAaiIBIAhqIAdNBEAgBCABIAgQDxoMAgsgBCABQQAgAGsQDyEBIAIgACAIaiIINgIEIAEgAGshBAsgBCAPIAUgCEEBECkLIA4hCgsgCgubAgEBfyMAQYABayINJAAgDSADNgJ8AkAgAkEDSwRAQX8hCQwBCwJAAkACQAJAIAJBAWsOAwADAgELIAZFBEBBuH8hCQwEC0FsIQkgBS0AACICIANLDQMgACAHIAJBAnQiAmooAgAgAiAIaigCABA7IAEgADYCAEEBIQkMAwsgASAJNgIAQQAhCQwCCyAKRQRAQWwhCQwCC0EAIQkgC0UgDEEZSHINAUEIIAR0QQhqIQBBACECA0AgAiAATw0CIAJBQGshAgwAAAsAC0FsIQkgDSANQfwAaiANQfgAaiAFIAYQFSICEAMNACANKAJ4IgMgBEsNACAAIA0gDSgCfCAHIAggAxAYIAEgADYCACACIQkLIA1BgAFqJAAgCQsLACAAIAEgAhALGgsQACAALwAAIAAtAAJBEHRyCy8AAn9BuH8gAUEISQ0AGkFyIAAoAAQiAEF3Sw0AGkG4fyAAQQhqIgAgACABSxsLCwkAIAAgATsAAAsDAAELigYBBX8gACAAKAIAIgVBfnE2AgBBACAAIAVBAXZqQYQgKAIAIgQgAEYbIQECQAJAIAAoAgQiAkUNACACKAIAIgNBAXENACACQQhqIgUgA0EBdkF4aiIDQQggA0EISxtnQR9zQQJ0QYAfaiIDKAIARgRAIAMgAigCDDYCAAsgAigCCCIDBEAgAyACKAIMNgIECyACKAIMIgMEQCADIAIoAgg2AgALIAIgAigCACAAKAIAQX5xajYCAEGEICEAAkACQCABRQ0AIAEgAjYCBCABKAIAIgNBAXENASADQQF2QXhqIgNBCCADQQhLG2dBH3NBAnRBgB9qIgMoAgAgAUEIakYEQCADIAEoAgw2AgALIAEoAggiAwRAIAMgASgCDDYCBAsgASgCDCIDBEAgAyABKAIINgIAQYQgKAIAIQQLIAIgAigCACABKAIAQX5xajYCACABIARGDQAgASABKAIAQQF2akEEaiEACyAAIAI2AgALIAIoAgBBAXZBeGoiAEEIIABBCEsbZ0Efc0ECdEGAH2oiASgCACEAIAEgBTYCACACIAA2AgwgAkEANgIIIABFDQEgACAFNgIADwsCQCABRQ0AIAEoAgAiAkEBcQ0AIAJBAXZBeGoiAkEIIAJBCEsbZ0Efc0ECdEGAH2oiAigCACABQQhqRgRAIAIgASgCDDYCAAsgASgCCCICBEAgAiABKAIMNgIECyABKAIMIgIEQCACIAEoAgg2AgBBhCAoAgAhBAsgACAAKAIAIAEoAgBBfnFqIgI2AgACQCABIARHBEAgASABKAIAQQF2aiAANgIEIAAoAgAhAgwBC0GEICAANgIACyACQQF2QXhqIgFBCCABQQhLG2dBH3NBAnRBgB9qIgIoAgAhASACIABBCGoiAjYCACAAIAE2AgwgAEEANgIIIAFFDQEgASACNgIADwsgBUEBdkF4aiIBQQggAUEISxtnQR9zQQJ0QYAfaiICKAIAIQEgAiAAQQhqIgI2AgAgACABNgIMIABBADYCCCABRQ0AIAEgAjYCAAsLDgAgAARAIABBeGoQJQsLgAIBA38CQCAAQQ9qQXhxQYQgKAIAKAIAQQF2ayICEB1Bf0YNAAJAQYQgKAIAIgAoAgAiAUEBcQ0AIAFBAXZBeGoiAUEIIAFBCEsbZ0Efc0ECdEGAH2oiASgCACAAQQhqRgRAIAEgACgCDDYCAAsgACgCCCIBBEAgASAAKAIMNgIECyAAKAIMIgFFDQAgASAAKAIINgIAC0EBIQEgACAAKAIAIAJBAXRqIgI2AgAgAkEBcQ0AIAJBAXZBeGoiAkEIIAJBCEsbZ0Efc0ECdEGAH2oiAygCACECIAMgAEEIaiIDNgIAIAAgAjYCDCAAQQA2AgggAkUNACACIAM2AgALIAELtwIBA38CQAJAIABBASAAGyICEDgiAA0AAkACQEGEICgCACIARQ0AIAAoAgAiA0EBcQ0AIAAgA0EBcjYCACADQQF2QXhqIgFBCCABQQhLG2dBH3NBAnRBgB9qIgEoAgAgAEEIakYEQCABIAAoAgw2AgALIAAoAggiAQRAIAEgACgCDDYCBAsgACgCDCIBBEAgASAAKAIINgIACyACECchAkEAIQFBhCAoAgAhACACDQEgACAAKAIAQX5xNgIAQQAPCyACQQ9qQXhxIgMQHSICQX9GDQIgAkEHakF4cSIAIAJHBEAgACACaxAdQX9GDQMLAkBBhCAoAgAiAUUEQEGAICAANgIADAELIAAgATYCBAtBhCAgADYCACAAIANBAXRBAXI2AgAMAQsgAEUNAQsgAEEIaiEBCyABC7kDAQJ/IAAgA2ohBQJAIANBB0wEQANAIAAgBU8NAiAAIAItAAA6AAAgAEEBaiEAIAJBAWohAgwAAAsACyAEQQFGBEACQCAAIAJrIgZBB00EQCAAIAItAAA6AAAgACACLQABOgABIAAgAi0AAjoAAiAAIAItAAM6AAMgAEEEaiACIAZBAnQiBkHAHmooAgBqIgIQFyACIAZB4B5qKAIAayECDAELIAAgAhAMCyACQQhqIQIgAEEIaiEACwJAAkACQAJAIAUgAU0EQCAAIANqIQEgBEEBRyAAIAJrQQ9Kcg0BA0AgACACEAwgAkEIaiECIABBCGoiACABSQ0ACwwFCyAAIAFLBEAgACEBDAQLIARBAUcgACACa0EPSnINASAAIQMgAiEEA0AgAyAEEAwgBEEIaiEEIANBCGoiAyABSQ0ACwwCCwNAIAAgAhAHIAJBEGohAiAAQRBqIgAgAUkNAAsMAwsgACEDIAIhBANAIAMgBBAHIARBEGohBCADQRBqIgMgAUkNAAsLIAIgASAAa2ohAgsDQCABIAVPDQEgASACLQAAOgAAIAFBAWohASACQQFqIQIMAAALAAsLQQECfyAAIAAoArjgASIDNgLE4AEgACgCvOABIQQgACABNgK84AEgACABIAJqNgK44AEgACABIAQgA2tqNgLA4AELpgEBAX8gACAAKALs4QEQFjYCyOABIABCADcD+OABIABCADcDuOABIABBwOABakIANwMAIABBqNAAaiIBQYyAgOAANgIAIABBADYCmOIBIABCADcDiOEBIABCAzcDgOEBIABBrNABakHgEikCADcCACAAQbTQAWpB6BIoAgA2AgAgACABNgIMIAAgAEGYIGo2AgggACAAQaAwajYCBCAAIABBEGo2AgALYQEBf0G4fyEDAkAgAUEDSQ0AIAIgABAhIgFBA3YiADYCCCACIAFBAXE2AgQgAiABQQF2QQNxIgM2AgACQCADQX9qIgFBAksNAAJAIAFBAWsOAgEAAgtBbA8LIAAhAwsgAwsMACAAIAEgAkEAEC4LiAQCA38CfiADEBYhBCAAQQBBKBAQIQAgBCACSwRAIAQPCyABRQRAQX8PCwJAAkAgA0EBRg0AIAEoAAAiBkGo6r5pRg0AQXYhAyAGQXBxQdDUtMIBRw0BQQghAyACQQhJDQEgAEEAQSgQECEAIAEoAAQhASAAQQE2AhQgACABrTcDAEEADwsgASACIAMQLyIDIAJLDQAgACADNgIYQXIhAyABIARqIgVBf2otAAAiAkEIcQ0AIAJBIHEiBkUEQEFwIQMgBS0AACIFQacBSw0BIAVBB3GtQgEgBUEDdkEKaq2GIgdCA4h+IAd8IQggBEEBaiEECyACQQZ2IQMgAkECdiEFAkAgAkEDcUF/aiICQQJLBEBBACECDAELAkACQAJAIAJBAWsOAgECAAsgASAEai0AACECIARBAWohBAwCCyABIARqLwAAIQIgBEECaiEEDAELIAEgBGooAAAhAiAEQQRqIQQLIAVBAXEhBQJ+AkACQAJAIANBf2oiA0ECTQRAIANBAWsOAgIDAQtCfyAGRQ0DGiABIARqMQAADAMLIAEgBGovAACtQoACfAwCCyABIARqKAAArQwBCyABIARqKQAACyEHIAAgBTYCICAAIAI2AhwgACAHNwMAQQAhAyAAQQA2AhQgACAHIAggBhsiBzcDCCAAIAdCgIAIIAdCgIAIVBs+AhALIAMLWwEBf0G4fyEDIAIQFiICIAFNBH8gACACakF/ai0AACIAQQNxQQJ0QaAeaigCACACaiAAQQZ2IgFBAnRBsB5qKAIAaiAAQSBxIgBFaiABRSAAQQV2cWoFQbh/CwsdACAAKAKQ4gEQWiAAQQA2AqDiASAAQgA3A5DiAQu1AwEFfyMAQZACayIKJABBuH8hBgJAIAVFDQAgBCwAACIIQf8BcSEHAkAgCEF/TARAIAdBgn9qQQF2IgggBU8NAkFsIQYgB0GBf2oiBUGAAk8NAiAEQQFqIQdBACEGA0AgBiAFTwRAIAUhBiAIIQcMAwUgACAGaiAHIAZBAXZqIgQtAABBBHY6AAAgACAGQQFyaiAELQAAQQ9xOgAAIAZBAmohBgwBCwAACwALIAcgBU8NASAAIARBAWogByAKEFMiBhADDQELIAYhBEEAIQYgAUEAQTQQECEJQQAhBQNAIAQgBkcEQCAAIAZqIggtAAAiAUELSwRAQWwhBgwDBSAJIAFBAnRqIgEgASgCAEEBajYCACAGQQFqIQZBASAILQAAdEEBdSAFaiEFDAILAAsLQWwhBiAFRQ0AIAUQFEEBaiIBQQxLDQAgAyABNgIAQQFBASABdCAFayIDEBQiAXQgA0cNACAAIARqIAFBAWoiADoAACAJIABBAnRqIgAgACgCAEEBajYCACAJKAIEIgBBAkkgAEEBcXINACACIARBAWo2AgAgB0EBaiEGCyAKQZACaiQAIAYLxhEBDH8jAEHwAGsiBSQAQWwhCwJAIANBCkkNACACLwAAIQogAi8AAiEJIAIvAAQhByAFQQhqIAQQDgJAIAMgByAJIApqakEGaiIMSQ0AIAUtAAohCCAFQdgAaiACQQZqIgIgChAGIgsQAw0BIAVBQGsgAiAKaiICIAkQBiILEAMNASAFQShqIAIgCWoiAiAHEAYiCxADDQEgBUEQaiACIAdqIAMgDGsQBiILEAMNASAAIAFqIg9BfWohECAEQQRqIQZBASELIAAgAUEDakECdiIDaiIMIANqIgIgA2oiDiEDIAIhBCAMIQcDQCALIAMgEElxBEAgACAGIAVB2ABqIAgQAkECdGoiCS8BADsAACAFQdgAaiAJLQACEAEgCS0AAyELIAcgBiAFQUBrIAgQAkECdGoiCS8BADsAACAFQUBrIAktAAIQASAJLQADIQogBCAGIAVBKGogCBACQQJ0aiIJLwEAOwAAIAVBKGogCS0AAhABIAktAAMhCSADIAYgBUEQaiAIEAJBAnRqIg0vAQA7AAAgBUEQaiANLQACEAEgDS0AAyENIAAgC2oiCyAGIAVB2ABqIAgQAkECdGoiAC8BADsAACAFQdgAaiAALQACEAEgAC0AAyEAIAcgCmoiCiAGIAVBQGsgCBACQQJ0aiIHLwEAOwAAIAVBQGsgBy0AAhABIActAAMhByAEIAlqIgkgBiAFQShqIAgQAkECdGoiBC8BADsAACAFQShqIAQtAAIQASAELQADIQQgAyANaiIDIAYgBUEQaiAIEAJBAnRqIg0vAQA7AAAgBUEQaiANLQACEAEgACALaiEAIAcgCmohByAEIAlqIQQgAyANLQADaiEDIAVB2ABqEA0gBUFAaxANciAFQShqEA1yIAVBEGoQDXJFIQsMAQsLIAQgDksgByACS3INAEFsIQsgACAMSw0BIAxBfWohCQNAQQAgACAJSSAFQdgAahAEGwRAIAAgBiAFQdgAaiAIEAJBAnRqIgovAQA7AAAgBUHYAGogCi0AAhABIAAgCi0AA2oiACAGIAVB2ABqIAgQAkECdGoiCi8BADsAACAFQdgAaiAKLQACEAEgACAKLQADaiEADAEFIAxBfmohCgNAIAVB2ABqEAQgACAKS3JFBEAgACAGIAVB2ABqIAgQAkECdGoiCS8BADsAACAFQdgAaiAJLQACEAEgACAJLQADaiEADAELCwNAIAAgCk0EQCAAIAYgBUHYAGogCBACQQJ0aiIJLwEAOwAAIAVB2ABqIAktAAIQASAAIAktAANqIQAMAQsLAkAgACAMTw0AIAAgBiAFQdgAaiAIEAIiAEECdGoiDC0AADoAACAMLQADQQFGBEAgBUHYAGogDC0AAhABDAELIAUoAlxBH0sNACAFQdgAaiAGIABBAnRqLQACEAEgBSgCXEEhSQ0AIAVBIDYCXAsgAkF9aiEMA0BBACAHIAxJIAVBQGsQBBsEQCAHIAYgBUFAayAIEAJBAnRqIgAvAQA7AAAgBUFAayAALQACEAEgByAALQADaiIAIAYgBUFAayAIEAJBAnRqIgcvAQA7AAAgBUFAayAHLQACEAEgACAHLQADaiEHDAEFIAJBfmohDANAIAVBQGsQBCAHIAxLckUEQCAHIAYgBUFAayAIEAJBAnRqIgAvAQA7AAAgBUFAayAALQACEAEgByAALQADaiEHDAELCwNAIAcgDE0EQCAHIAYgBUFAayAIEAJBAnRqIgAvAQA7AAAgBUFAayAALQACEAEgByAALQADaiEHDAELCwJAIAcgAk8NACAHIAYgBUFAayAIEAIiAEECdGoiAi0AADoAACACLQADQQFGBEAgBUFAayACLQACEAEMAQsgBSgCREEfSw0AIAVBQGsgBiAAQQJ0ai0AAhABIAUoAkRBIUkNACAFQSA2AkQLIA5BfWohAgNAQQAgBCACSSAFQShqEAQbBEAgBCAGIAVBKGogCBACQQJ0aiIALwEAOwAAIAVBKGogAC0AAhABIAQgAC0AA2oiACAGIAVBKGogCBACQQJ0aiIELwEAOwAAIAVBKGogBC0AAhABIAAgBC0AA2ohBAwBBSAOQX5qIQIDQCAFQShqEAQgBCACS3JFBEAgBCAGIAVBKGogCBACQQJ0aiIALwEAOwAAIAVBKGogAC0AAhABIAQgAC0AA2ohBAwBCwsDQCAEIAJNBEAgBCAGIAVBKGogCBACQQJ0aiIALwEAOwAAIAVBKGogAC0AAhABIAQgAC0AA2ohBAwBCwsCQCAEIA5PDQAgBCAGIAVBKGogCBACIgBBAnRqIgItAAA6AAAgAi0AA0EBRgRAIAVBKGogAi0AAhABDAELIAUoAixBH0sNACAFQShqIAYgAEECdGotAAIQASAFKAIsQSFJDQAgBUEgNgIsCwNAQQAgAyAQSSAFQRBqEAQbBEAgAyAGIAVBEGogCBACQQJ0aiIALwEAOwAAIAVBEGogAC0AAhABIAMgAC0AA2oiACAGIAVBEGogCBACQQJ0aiICLwEAOwAAIAVBEGogAi0AAhABIAAgAi0AA2ohAwwBBSAPQX5qIQIDQCAFQRBqEAQgAyACS3JFBEAgAyAGIAVBEGogCBACQQJ0aiIALwEAOwAAIAVBEGogAC0AAhABIAMgAC0AA2ohAwwBCwsDQCADIAJNBEAgAyAGIAVBEGogCBACQQJ0aiIALwEAOwAAIAVBEGogAC0AAhABIAMgAC0AA2ohAwwBCwsCQCADIA9PDQAgAyAGIAVBEGogCBACIgBBAnRqIgItAAA6AAAgAi0AA0EBRgRAIAVBEGogAi0AAhABDAELIAUoAhRBH0sNACAFQRBqIAYgAEECdGotAAIQASAFKAIUQSFJDQAgBUEgNgIUCyABQWwgBUHYAGoQCiAFQUBrEApxIAVBKGoQCnEgBUEQahAKcRshCwwJCwAACwALAAALAAsAAAsACwAACwALQWwhCwsgBUHwAGokACALC7UEAQ5/IwBBEGsiBiQAIAZBBGogABAOQVQhBQJAIARB3AtJDQAgBi0ABCEHIANB8ARqQQBB7AAQECEIIAdBDEsNACADQdwJaiIJIAggBkEIaiAGQQxqIAEgAhAxIhAQA0UEQCAGKAIMIgQgB0sNASADQdwFaiEPIANBpAVqIREgAEEEaiESIANBqAVqIQEgBCEFA0AgBSICQX9qIQUgCCACQQJ0aigCAEUNAAsgAkEBaiEOQQEhBQNAIAUgDk9FBEAgCCAFQQJ0IgtqKAIAIQwgASALaiAKNgIAIAVBAWohBSAKIAxqIQoMAQsLIAEgCjYCAEEAIQUgBigCCCELA0AgBSALRkUEQCABIAUgCWotAAAiDEECdGoiDSANKAIAIg1BAWo2AgAgDyANQQF0aiINIAw6AAEgDSAFOgAAIAVBAWohBQwBCwtBACEBIANBADYCqAUgBEF/cyAHaiEJQQEhBQNAIAUgDk9FBEAgCCAFQQJ0IgtqKAIAIQwgAyALaiABNgIAIAwgBSAJanQgAWohASAFQQFqIQUMAQsLIAcgBEEBaiIBIAJrIgRrQQFqIQgDQEEBIQUgBCAIT0UEQANAIAUgDk9FBEAgBUECdCIJIAMgBEE0bGpqIAMgCWooAgAgBHY2AgAgBUEBaiEFDAELCyAEQQFqIQQMAQsLIBIgByAPIAogESADIAIgARBkIAZBAToABSAGIAc6AAYgACAGKAIENgIACyAQIQULIAZBEGokACAFC8ENAQt/IwBB8ABrIgUkAEFsIQkCQCADQQpJDQAgAi8AACEKIAIvAAIhDCACLwAEIQYgBUEIaiAEEA4CQCADIAYgCiAMampBBmoiDUkNACAFLQAKIQcgBUHYAGogAkEGaiICIAoQBiIJEAMNASAFQUBrIAIgCmoiAiAMEAYiCRADDQEgBUEoaiACIAxqIgIgBhAGIgkQAw0BIAVBEGogAiAGaiADIA1rEAYiCRADDQEgACABaiIOQX1qIQ8gBEEEaiEGQQEhCSAAIAFBA2pBAnYiAmoiCiACaiIMIAJqIg0hAyAMIQQgCiECA0AgCSADIA9JcQRAIAYgBUHYAGogBxACQQF0aiIILQAAIQsgBUHYAGogCC0AARABIAAgCzoAACAGIAVBQGsgBxACQQF0aiIILQAAIQsgBUFAayAILQABEAEgAiALOgAAIAYgBUEoaiAHEAJBAXRqIggtAAAhCyAFQShqIAgtAAEQASAEIAs6AAAgBiAFQRBqIAcQAkEBdGoiCC0AACELIAVBEGogCC0AARABIAMgCzoAACAGIAVB2ABqIAcQAkEBdGoiCC0AACELIAVB2ABqIAgtAAEQASAAIAs6AAEgBiAFQUBrIAcQAkEBdGoiCC0AACELIAVBQGsgCC0AARABIAIgCzoAASAGIAVBKGogBxACQQF0aiIILQAAIQsgBUEoaiAILQABEAEgBCALOgABIAYgBUEQaiAHEAJBAXRqIggtAAAhCyAFQRBqIAgtAAEQASADIAs6AAEgA0ECaiEDIARBAmohBCACQQJqIQIgAEECaiEAIAkgBUHYAGoQDUVxIAVBQGsQDUVxIAVBKGoQDUVxIAVBEGoQDUVxIQkMAQsLIAQgDUsgAiAMS3INAEFsIQkgACAKSw0BIApBfWohCQNAIAVB2ABqEAQgACAJT3JFBEAgBiAFQdgAaiAHEAJBAXRqIggtAAAhCyAFQdgAaiAILQABEAEgACALOgAAIAYgBUHYAGogBxACQQF0aiIILQAAIQsgBUHYAGogCC0AARABIAAgCzoAASAAQQJqIQAMAQsLA0AgBUHYAGoQBCAAIApPckUEQCAGIAVB2ABqIAcQAkEBdGoiCS0AACEIIAVB2ABqIAktAAEQASAAIAg6AAAgAEEBaiEADAELCwNAIAAgCkkEQCAGIAVB2ABqIAcQAkEBdGoiCS0AACEIIAVB2ABqIAktAAEQASAAIAg6AAAgAEEBaiEADAELCyAMQX1qIQADQCAFQUBrEAQgAiAAT3JFBEAgBiAFQUBrIAcQAkEBdGoiCi0AACEJIAVBQGsgCi0AARABIAIgCToAACAGIAVBQGsgBxACQQF0aiIKLQAAIQkgBUFAayAKLQABEAEgAiAJOgABIAJBAmohAgwBCwsDQCAFQUBrEAQgAiAMT3JFBEAgBiAFQUBrIAcQAkEBdGoiAC0AACEKIAVBQGsgAC0AARABIAIgCjoAACACQQFqIQIMAQsLA0AgAiAMSQRAIAYgBUFAayAHEAJBAXRqIgAtAAAhCiAFQUBrIAAtAAEQASACIAo6AAAgAkEBaiECDAELCyANQX1qIQADQCAFQShqEAQgBCAAT3JFBEAgBiAFQShqIAcQAkEBdGoiAi0AACEKIAVBKGogAi0AARABIAQgCjoAACAGIAVBKGogBxACQQF0aiICLQAAIQogBUEoaiACLQABEAEgBCAKOgABIARBAmohBAwBCwsDQCAFQShqEAQgBCANT3JFBEAgBiAFQShqIAcQAkEBdGoiAC0AACECIAVBKGogAC0AARABIAQgAjoAACAEQQFqIQQMAQsLA0AgBCANSQRAIAYgBUEoaiAHEAJBAXRqIgAtAAAhAiAFQShqIAAtAAEQASAEIAI6AAAgBEEBaiEEDAELCwNAIAVBEGoQBCADIA9PckUEQCAGIAVBEGogBxACQQF0aiIALQAAIQIgBUEQaiAALQABEAEgAyACOgAAIAYgBUEQaiAHEAJBAXRqIgAtAAAhAiAFQRBqIAAtAAEQASADIAI6AAEgA0ECaiEDDAELCwNAIAVBEGoQBCADIA5PckUEQCAGIAVBEGogBxACQQF0aiIALQAAIQIgBUEQaiAALQABEAEgAyACOgAAIANBAWohAwwBCwsDQCADIA5JBEAgBiAFQRBqIAcQAkEBdGoiAC0AACECIAVBEGogAC0AARABIAMgAjoAACADQQFqIQMMAQsLIAFBbCAFQdgAahAKIAVBQGsQCnEgBUEoahAKcSAFQRBqEApxGyEJDAELQWwhCQsgBUHwAGokACAJC8oCAQR/IwBBIGsiBSQAIAUgBBAOIAUtAAIhByAFQQhqIAIgAxAGIgIQA0UEQCAEQQRqIQIgACABaiIDQX1qIQQDQCAFQQhqEAQgACAET3JFBEAgAiAFQQhqIAcQAkEBdGoiBi0AACEIIAVBCGogBi0AARABIAAgCDoAACACIAVBCGogBxACQQF0aiIGLQAAIQggBUEIaiAGLQABEAEgACAIOgABIABBAmohAAwBCwsDQCAFQQhqEAQgACADT3JFBEAgAiAFQQhqIAcQAkEBdGoiBC0AACEGIAVBCGogBC0AARABIAAgBjoAACAAQQFqIQAMAQsLA0AgACADT0UEQCACIAVBCGogBxACQQF0aiIELQAAIQYgBUEIaiAELQABEAEgACAGOgAAIABBAWohAAwBCwsgAUFsIAVBCGoQChshAgsgBUEgaiQAIAILtgMBCX8jAEEQayIGJAAgBkEANgIMIAZBADYCCEFUIQQCQAJAIANBQGsiDCADIAZBCGogBkEMaiABIAIQMSICEAMNACAGQQRqIAAQDiAGKAIMIgcgBi0ABEEBaksNASAAQQRqIQogBkEAOgAFIAYgBzoABiAAIAYoAgQ2AgAgB0EBaiEJQQEhBANAIAQgCUkEQCADIARBAnRqIgEoAgAhACABIAU2AgAgACAEQX9qdCAFaiEFIARBAWohBAwBCwsgB0EBaiEHQQAhBSAGKAIIIQkDQCAFIAlGDQEgAyAFIAxqLQAAIgRBAnRqIgBBASAEdEEBdSILIAAoAgAiAWoiADYCACAHIARrIQhBACEEAkAgC0EDTQRAA0AgBCALRg0CIAogASAEakEBdGoiACAIOgABIAAgBToAACAEQQFqIQQMAAALAAsDQCABIABPDQEgCiABQQF0aiIEIAg6AAEgBCAFOgAAIAQgCDoAAyAEIAU6AAIgBCAIOgAFIAQgBToABCAEIAg6AAcgBCAFOgAGIAFBBGohAQwAAAsACyAFQQFqIQUMAAALAAsgAiEECyAGQRBqJAAgBAutAQECfwJAQYQgKAIAIABHIAAoAgBBAXYiAyABa0F4aiICQXhxQQhHcgR/IAIFIAMQJ0UNASACQQhqC0EQSQ0AIAAgACgCACICQQFxIAAgAWpBD2pBeHEiASAAa0EBdHI2AgAgASAANgIEIAEgASgCAEEBcSAAIAJBAXZqIAFrIgJBAXRyNgIAQYQgIAEgAkH/////B3FqQQRqQYQgKAIAIABGGyABNgIAIAEQJQsLygIBBX8CQAJAAkAgAEEIIABBCEsbZ0EfcyAAaUEBR2oiAUEESSAAIAF2cg0AIAFBAnRB/B5qKAIAIgJFDQADQCACQXhqIgMoAgBBAXZBeGoiBSAATwRAIAIgBUEIIAVBCEsbZ0Efc0ECdEGAH2oiASgCAEYEQCABIAIoAgQ2AgALDAMLIARBHksNASAEQQFqIQQgAigCBCICDQALC0EAIQMgAUEgTw0BA0AgAUECdEGAH2ooAgAiAkUEQCABQR5LIQIgAUEBaiEBIAJFDQEMAwsLIAIgAkF4aiIDKAIAQQF2QXhqIgFBCCABQQhLG2dBH3NBAnRBgB9qIgEoAgBGBEAgASACKAIENgIACwsgAigCACIBBEAgASACKAIENgIECyACKAIEIgEEQCABIAIoAgA2AgALIAMgAygCAEEBcjYCACADIAAQNwsgAwvhCwINfwV+IwBB8ABrIgckACAHIAAoAvDhASIINgJcIAEgAmohDSAIIAAoAoDiAWohDwJAAkAgBUUEQCABIQQMAQsgACgCxOABIRAgACgCwOABIREgACgCvOABIQ4gAEEBNgKM4QFBACEIA0AgCEEDRwRAIAcgCEECdCICaiAAIAJqQazQAWooAgA2AkQgCEEBaiEIDAELC0FsIQwgB0EYaiADIAQQBhADDQEgB0EsaiAHQRhqIAAoAgAQEyAHQTRqIAdBGGogACgCCBATIAdBPGogB0EYaiAAKAIEEBMgDUFgaiESIAEhBEEAIQwDQCAHKAIwIAcoAixBA3RqKQIAIhRCEIinQf8BcSEIIAcoAkAgBygCPEEDdGopAgAiFUIQiKdB/wFxIQsgBygCOCAHKAI0QQN0aikCACIWQiCIpyEJIBVCIIghFyAUQiCIpyECAkAgFkIQiKdB/wFxIgNBAk8EQAJAIAZFIANBGUlyRQRAIAkgB0EYaiADQSAgBygCHGsiCiAKIANLGyIKEAUgAyAKayIDdGohCSAHQRhqEAQaIANFDQEgB0EYaiADEAUgCWohCQwBCyAHQRhqIAMQBSAJaiEJIAdBGGoQBBoLIAcpAkQhGCAHIAk2AkQgByAYNwNIDAELAkAgA0UEQCACBEAgBygCRCEJDAMLIAcoAkghCQwBCwJAAkAgB0EYakEBEAUgCSACRWpqIgNBA0YEQCAHKAJEQX9qIgMgA0VqIQkMAQsgA0ECdCAHaigCRCIJIAlFaiEJIANBAUYNAQsgByAHKAJINgJMCwsgByAHKAJENgJIIAcgCTYCRAsgF6chAyALBEAgB0EYaiALEAUgA2ohAwsgCCALakEUTwRAIAdBGGoQBBoLIAgEQCAHQRhqIAgQBSACaiECCyAHQRhqEAQaIAcgB0EYaiAUQhiIp0H/AXEQCCAUp0H//wNxajYCLCAHIAdBGGogFUIYiKdB/wFxEAggFadB//8DcWo2AjwgB0EYahAEGiAHIAdBGGogFkIYiKdB/wFxEAggFqdB//8DcWo2AjQgByACNgJgIAcoAlwhCiAHIAk2AmggByADNgJkAkACQAJAIAQgAiADaiILaiASSw0AIAIgCmoiEyAPSw0AIA0gBGsgC0Egak8NAQsgByAHKQNoNwMQIAcgBykDYDcDCCAEIA0gB0EIaiAHQdwAaiAPIA4gESAQEB4hCwwBCyACIARqIQggBCAKEAcgAkERTwRAIARBEGohAgNAIAIgCkEQaiIKEAcgAkEQaiICIAhJDQALCyAIIAlrIQIgByATNgJcIAkgCCAOa0sEQCAJIAggEWtLBEBBbCELDAILIBAgAiAOayICaiIKIANqIBBNBEAgCCAKIAMQDxoMAgsgCCAKQQAgAmsQDyEIIAcgAiADaiIDNgJkIAggAmshCCAOIQILIAlBEE8EQCADIAhqIQMDQCAIIAIQByACQRBqIQIgCEEQaiIIIANJDQALDAELAkAgCUEHTQRAIAggAi0AADoAACAIIAItAAE6AAEgCCACLQACOgACIAggAi0AAzoAAyAIQQRqIAIgCUECdCIDQcAeaigCAGoiAhAXIAIgA0HgHmooAgBrIQIgBygCZCEDDAELIAggAhAMCyADQQlJDQAgAyAIaiEDIAhBCGoiCCACQQhqIgJrQQ9MBEADQCAIIAIQDCACQQhqIQIgCEEIaiIIIANJDQAMAgALAAsDQCAIIAIQByACQRBqIQIgCEEQaiIIIANJDQALCyAHQRhqEAQaIAsgDCALEAMiAhshDCAEIAQgC2ogAhshBCAFQX9qIgUNAAsgDBADDQFBbCEMIAdBGGoQBEECSQ0BQQAhCANAIAhBA0cEQCAAIAhBAnQiAmpBrNABaiACIAdqKAJENgIAIAhBAWohCAwBCwsgBygCXCEIC0G6fyEMIA8gCGsiACANIARrSw0AIAQEfyAEIAggABALIABqBUEACyABayEMCyAHQfAAaiQAIAwLkRcCFn8FfiMAQdABayIHJAAgByAAKALw4QEiCDYCvAEgASACaiESIAggACgCgOIBaiETAkACQCAFRQRAIAEhAwwBCyAAKALE4AEhESAAKALA4AEhFSAAKAK84AEhDyAAQQE2AozhAUEAIQgDQCAIQQNHBEAgByAIQQJ0IgJqIAAgAmpBrNABaigCADYCVCAIQQFqIQgMAQsLIAcgETYCZCAHIA82AmAgByABIA9rNgJoQWwhECAHQShqIAMgBBAGEAMNASAFQQQgBUEESBshFyAHQTxqIAdBKGogACgCABATIAdBxABqIAdBKGogACgCCBATIAdBzABqIAdBKGogACgCBBATQQAhBCAHQeAAaiEMIAdB5ABqIQoDQCAHQShqEARBAksgBCAXTnJFBEAgBygCQCAHKAI8QQN0aikCACIdQhCIp0H/AXEhCyAHKAJQIAcoAkxBA3RqKQIAIh5CEIinQf8BcSEJIAcoAkggBygCREEDdGopAgAiH0IgiKchCCAeQiCIISAgHUIgiKchAgJAIB9CEIinQf8BcSIDQQJPBEACQCAGRSADQRlJckUEQCAIIAdBKGogA0EgIAcoAixrIg0gDSADSxsiDRAFIAMgDWsiA3RqIQggB0EoahAEGiADRQ0BIAdBKGogAxAFIAhqIQgMAQsgB0EoaiADEAUgCGohCCAHQShqEAQaCyAHKQJUISEgByAINgJUIAcgITcDWAwBCwJAIANFBEAgAgRAIAcoAlQhCAwDCyAHKAJYIQgMAQsCQAJAIAdBKGpBARAFIAggAkVqaiIDQQNGBEAgBygCVEF/aiIDIANFaiEIDAELIANBAnQgB2ooAlQiCCAIRWohCCADQQFGDQELIAcgBygCWDYCXAsLIAcgBygCVDYCWCAHIAg2AlQLICCnIQMgCQRAIAdBKGogCRAFIANqIQMLIAkgC2pBFE8EQCAHQShqEAQaCyALBEAgB0EoaiALEAUgAmohAgsgB0EoahAEGiAHIAcoAmggAmoiCSADajYCaCAKIAwgCCAJSxsoAgAhDSAHIAdBKGogHUIYiKdB/wFxEAggHadB//8DcWo2AjwgByAHQShqIB5CGIinQf8BcRAIIB6nQf//A3FqNgJMIAdBKGoQBBogB0EoaiAfQhiIp0H/AXEQCCEOIAdB8ABqIARBBHRqIgsgCSANaiAIazYCDCALIAg2AgggCyADNgIEIAsgAjYCACAHIA4gH6dB//8DcWo2AkQgBEEBaiEEDAELCyAEIBdIDQEgEkFgaiEYIAdB4ABqIRogB0HkAGohGyABIQMDQCAHQShqEARBAksgBCAFTnJFBEAgBygCQCAHKAI8QQN0aikCACIdQhCIp0H/AXEhCyAHKAJQIAcoAkxBA3RqKQIAIh5CEIinQf8BcSEIIAcoAkggBygCREEDdGopAgAiH0IgiKchCSAeQiCIISAgHUIgiKchDAJAIB9CEIinQf8BcSICQQJPBEACQCAGRSACQRlJckUEQCAJIAdBKGogAkEgIAcoAixrIgogCiACSxsiChAFIAIgCmsiAnRqIQkgB0EoahAEGiACRQ0BIAdBKGogAhAFIAlqIQkMAQsgB0EoaiACEAUgCWohCSAHQShqEAQaCyAHKQJUISEgByAJNgJUIAcgITcDWAwBCwJAIAJFBEAgDARAIAcoAlQhCQwDCyAHKAJYIQkMAQsCQAJAIAdBKGpBARAFIAkgDEVqaiICQQNGBEAgBygCVEF/aiICIAJFaiEJDAELIAJBAnQgB2ooAlQiCSAJRWohCSACQQFGDQELIAcgBygCWDYCXAsLIAcgBygCVDYCWCAHIAk2AlQLICCnIRQgCARAIAdBKGogCBAFIBRqIRQLIAggC2pBFE8EQCAHQShqEAQaCyALBEAgB0EoaiALEAUgDGohDAsgB0EoahAEGiAHIAcoAmggDGoiGSAUajYCaCAbIBogCSAZSxsoAgAhHCAHIAdBKGogHUIYiKdB/wFxEAggHadB//8DcWo2AjwgByAHQShqIB5CGIinQf8BcRAIIB6nQf//A3FqNgJMIAdBKGoQBBogByAHQShqIB9CGIinQf8BcRAIIB+nQf//A3FqNgJEIAcgB0HwAGogBEEDcUEEdGoiDSkDCCIdNwPIASAHIA0pAwAiHjcDwAECQAJAAkAgBygCvAEiDiAepyICaiIWIBNLDQAgAyAHKALEASIKIAJqIgtqIBhLDQAgEiADayALQSBqTw0BCyAHIAcpA8gBNwMQIAcgBykDwAE3AwggAyASIAdBCGogB0G8AWogEyAPIBUgERAeIQsMAQsgAiADaiEIIAMgDhAHIAJBEU8EQCADQRBqIQIDQCACIA5BEGoiDhAHIAJBEGoiAiAISQ0ACwsgCCAdpyIOayECIAcgFjYCvAEgDiAIIA9rSwRAIA4gCCAVa0sEQEFsIQsMAgsgESACIA9rIgJqIhYgCmogEU0EQCAIIBYgChAPGgwCCyAIIBZBACACaxAPIQggByACIApqIgo2AsQBIAggAmshCCAPIQILIA5BEE8EQCAIIApqIQoDQCAIIAIQByACQRBqIQIgCEEQaiIIIApJDQALDAELAkAgDkEHTQRAIAggAi0AADoAACAIIAItAAE6AAEgCCACLQACOgACIAggAi0AAzoAAyAIQQRqIAIgDkECdCIKQcAeaigCAGoiAhAXIAIgCkHgHmooAgBrIQIgBygCxAEhCgwBCyAIIAIQDAsgCkEJSQ0AIAggCmohCiAIQQhqIgggAkEIaiICa0EPTARAA0AgCCACEAwgAkEIaiECIAhBCGoiCCAKSQ0ADAIACwALA0AgCCACEAcgAkEQaiECIAhBEGoiCCAKSQ0ACwsgCxADBEAgCyEQDAQFIA0gDDYCACANIBkgHGogCWs2AgwgDSAJNgIIIA0gFDYCBCAEQQFqIQQgAyALaiEDDAILAAsLIAQgBUgNASAEIBdrIQtBACEEA0AgCyAFSARAIAcgB0HwAGogC0EDcUEEdGoiAikDCCIdNwPIASAHIAIpAwAiHjcDwAECQAJAAkAgBygCvAEiDCAepyICaiIKIBNLDQAgAyAHKALEASIJIAJqIhBqIBhLDQAgEiADayAQQSBqTw0BCyAHIAcpA8gBNwMgIAcgBykDwAE3AxggAyASIAdBGGogB0G8AWogEyAPIBUgERAeIRAMAQsgAiADaiEIIAMgDBAHIAJBEU8EQCADQRBqIQIDQCACIAxBEGoiDBAHIAJBEGoiAiAISQ0ACwsgCCAdpyIGayECIAcgCjYCvAEgBiAIIA9rSwRAIAYgCCAVa0sEQEFsIRAMAgsgESACIA9rIgJqIgwgCWogEU0EQCAIIAwgCRAPGgwCCyAIIAxBACACaxAPIQggByACIAlqIgk2AsQBIAggAmshCCAPIQILIAZBEE8EQCAIIAlqIQYDQCAIIAIQByACQRBqIQIgCEEQaiIIIAZJDQALDAELAkAgBkEHTQRAIAggAi0AADoAACAIIAItAAE6AAEgCCACLQACOgACIAggAi0AAzoAAyAIQQRqIAIgBkECdCIGQcAeaigCAGoiAhAXIAIgBkHgHmooAgBrIQIgBygCxAEhCQwBCyAIIAIQDAsgCUEJSQ0AIAggCWohBiAIQQhqIgggAkEIaiICa0EPTARAA0AgCCACEAwgAkEIaiECIAhBCGoiCCAGSQ0ADAIACwALA0AgCCACEAcgAkEQaiECIAhBEGoiCCAGSQ0ACwsgEBADDQMgC0EBaiELIAMgEGohAwwBCwsDQCAEQQNHBEAgACAEQQJ0IgJqQazQAWogAiAHaigCVDYCACAEQQFqIQQMAQsLIAcoArwBIQgLQbp/IRAgEyAIayIAIBIgA2tLDQAgAwR/IAMgCCAAEAsgAGoFQQALIAFrIRALIAdB0AFqJAAgEAslACAAQgA3AgAgAEEAOwEIIABBADoACyAAIAE2AgwgACACOgAKC7QFAQN/IwBBMGsiBCQAIABB/wFqIgVBfWohBgJAIAMvAQIEQCAEQRhqIAEgAhAGIgIQAw0BIARBEGogBEEYaiADEBwgBEEIaiAEQRhqIAMQHCAAIQMDQAJAIARBGGoQBCADIAZPckUEQCADIARBEGogBEEYahASOgAAIAMgBEEIaiAEQRhqEBI6AAEgBEEYahAERQ0BIANBAmohAwsgBUF+aiEFAn8DQEG6fyECIAMiASAFSw0FIAEgBEEQaiAEQRhqEBI6AAAgAUEBaiEDIARBGGoQBEEDRgRAQQIhAiAEQQhqDAILIAMgBUsNBSABIARBCGogBEEYahASOgABIAFBAmohA0EDIQIgBEEYahAEQQNHDQALIARBEGoLIQUgAyAFIARBGGoQEjoAACABIAJqIABrIQIMAwsgAyAEQRBqIARBGGoQEjoAAiADIARBCGogBEEYahASOgADIANBBGohAwwAAAsACyAEQRhqIAEgAhAGIgIQAw0AIARBEGogBEEYaiADEBwgBEEIaiAEQRhqIAMQHCAAIQMDQAJAIARBGGoQBCADIAZPckUEQCADIARBEGogBEEYahAROgAAIAMgBEEIaiAEQRhqEBE6AAEgBEEYahAERQ0BIANBAmohAwsgBUF+aiEFAn8DQEG6fyECIAMiASAFSw0EIAEgBEEQaiAEQRhqEBE6AAAgAUEBaiEDIARBGGoQBEEDRgRAQQIhAiAEQQhqDAILIAMgBUsNBCABIARBCGogBEEYahAROgABIAFBAmohA0EDIQIgBEEYahAEQQNHDQALIARBEGoLIQUgAyAFIARBGGoQEToAACABIAJqIABrIQIMAgsgAyAEQRBqIARBGGoQEToAAiADIARBCGogBEEYahAROgADIANBBGohAwwAAAsACyAEQTBqJAAgAgtpAQF/An8CQAJAIAJBB00NACABKAAAQbfIwuF+Rw0AIAAgASgABDYCmOIBQWIgAEEQaiABIAIQPiIDEAMNAhogAEKBgICAEDcDiOEBIAAgASADaiACIANrECoMAQsgACABIAIQKgtBAAsLrQMBBn8jAEGAAWsiAyQAQWIhCAJAIAJBCUkNACAAQZjQAGogAUEIaiIEIAJBeGogAEGY0AAQMyIFEAMiBg0AIANBHzYCfCADIANB/ABqIANB+ABqIAQgBCAFaiAGGyIEIAEgAmoiAiAEaxAVIgUQAw0AIAMoAnwiBkEfSw0AIAMoAngiB0EJTw0AIABBiCBqIAMgBkGAC0GADCAHEBggA0E0NgJ8IAMgA0H8AGogA0H4AGogBCAFaiIEIAIgBGsQFSIFEAMNACADKAJ8IgZBNEsNACADKAJ4IgdBCk8NACAAQZAwaiADIAZBgA1B4A4gBxAYIANBIzYCfCADIANB/ABqIANB+ABqIAQgBWoiBCACIARrEBUiBRADDQAgAygCfCIGQSNLDQAgAygCeCIHQQpPDQAgACADIAZBwBBB0BEgBxAYIAQgBWoiBEEMaiIFIAJLDQAgAiAFayEFQQAhAgNAIAJBA0cEQCAEKAAAIgZBf2ogBU8NAiAAIAJBAnRqQZzQAWogBjYCACACQQFqIQIgBEEEaiEEDAELCyAEIAFrIQgLIANBgAFqJAAgCAtGAQN/IABBCGohAyAAKAIEIQJBACEAA0AgACACdkUEQCABIAMgAEEDdGotAAJBFktqIQEgAEEBaiEADAELCyABQQggAmt0C4YDAQV/Qbh/IQcCQCADRQ0AIAItAAAiBEUEQCABQQA2AgBBAUG4fyADQQFGGw8LAn8gAkEBaiIFIARBGHRBGHUiBkF/Sg0AGiAGQX9GBEAgA0EDSA0CIAUvAABBgP4BaiEEIAJBA2oMAQsgA0ECSA0BIAItAAEgBEEIdHJBgIB+aiEEIAJBAmoLIQUgASAENgIAIAVBAWoiASACIANqIgNLDQBBbCEHIABBEGogACAFLQAAIgVBBnZBI0EJIAEgAyABa0HAEEHQEUHwEiAAKAKM4QEgACgCnOIBIAQQHyIGEAMiCA0AIABBmCBqIABBCGogBUEEdkEDcUEfQQggASABIAZqIAgbIgEgAyABa0GAC0GADEGAFyAAKAKM4QEgACgCnOIBIAQQHyIGEAMiCA0AIABBoDBqIABBBGogBUECdkEDcUE0QQkgASABIAZqIAgbIgEgAyABa0GADUHgDkGQGSAAKAKM4QEgACgCnOIBIAQQHyIAEAMNACAAIAFqIAJrIQcLIAcLrQMBCn8jAEGABGsiCCQAAn9BUiACQf8BSw0AGkFUIANBDEsNABogAkEBaiELIABBBGohCUGAgAQgA0F/anRBEHUhCkEAIQJBASEEQQEgA3QiB0F/aiIMIQUDQCACIAtGRQRAAkAgASACQQF0Ig1qLwEAIgZB//8DRgRAIAkgBUECdGogAjoAAiAFQX9qIQVBASEGDAELIARBACAKIAZBEHRBEHVKGyEECyAIIA1qIAY7AQAgAkEBaiECDAELCyAAIAQ7AQIgACADOwEAIAdBA3YgB0EBdmpBA2ohBkEAIQRBACECA0AgBCALRkUEQCABIARBAXRqLgEAIQpBACEAA0AgACAKTkUEQCAJIAJBAnRqIAQ6AAIDQCACIAZqIAxxIgIgBUsNAAsgAEEBaiEADAELCyAEQQFqIQQMAQsLQX8gAg0AGkEAIQIDfyACIAdGBH9BAAUgCCAJIAJBAnRqIgAtAAJBAXRqIgEgAS8BACIBQQFqOwEAIAAgAyABEBRrIgU6AAMgACABIAVB/wFxdCAHazsBACACQQFqIQIMAQsLCyEFIAhBgARqJAAgBQvjBgEIf0FsIQcCQCACQQNJDQACQAJAAkACQCABLQAAIgNBA3EiCUEBaw4DAwEAAgsgACgCiOEBDQBBYg8LIAJBBUkNAkEDIQYgASgAACEFAn8CQAJAIANBAnZBA3EiCEF+aiIEQQFNBEAgBEEBaw0BDAILIAVBDnZB/wdxIQQgBUEEdkH/B3EhAyAIRQwCCyAFQRJ2IQRBBCEGIAVBBHZB//8AcSEDQQAMAQsgBUEEdkH//w9xIgNBgIAISw0DIAEtAARBCnQgBUEWdnIhBEEFIQZBAAshBSAEIAZqIgogAksNAgJAIANBgQZJDQAgACgCnOIBRQ0AQQAhAgNAIAJBg4ABSw0BIAJBQGshAgwAAAsACwJ/IAlBA0YEQCABIAZqIQEgAEHw4gFqIQIgACgCDCEGIAUEQCACIAMgASAEIAYQXwwCCyACIAMgASAEIAYQXQwBCyAAQbjQAWohAiABIAZqIQEgAEHw4gFqIQYgAEGo0ABqIQggBQRAIAggBiADIAEgBCACEF4MAQsgCCAGIAMgASAEIAIQXAsQAw0CIAAgAzYCgOIBIABBATYCiOEBIAAgAEHw4gFqNgLw4QEgCUECRgRAIAAgAEGo0ABqNgIMCyAAIANqIgBBiOMBakIANwAAIABBgOMBakIANwAAIABB+OIBakIANwAAIABB8OIBakIANwAAIAoPCwJ/AkACQAJAIANBAnZBA3FBf2oiBEECSw0AIARBAWsOAgACAQtBASEEIANBA3YMAgtBAiEEIAEvAABBBHYMAQtBAyEEIAEQIUEEdgsiAyAEaiIFQSBqIAJLBEAgBSACSw0CIABB8OIBaiABIARqIAMQCyEBIAAgAzYCgOIBIAAgATYC8OEBIAEgA2oiAEIANwAYIABCADcAECAAQgA3AAggAEIANwAAIAUPCyAAIAM2AoDiASAAIAEgBGo2AvDhASAFDwsCfwJAAkACQCADQQJ2QQNxQX9qIgRBAksNACAEQQFrDgIAAgELQQEhByADQQN2DAILQQIhByABLwAAQQR2DAELIAJBBEkgARAhIgJBj4CAAUtyDQFBAyEHIAJBBHYLIQIgAEHw4gFqIAEgB2otAAAgAkEgahAQIQEgACACNgKA4gEgACABNgLw4QEgB0EBaiEHCyAHC0sAIABC+erQ0OfJoeThADcDICAAQgA3AxggAELP1tO+0ser2UI3AxAgAELW64Lu6v2J9eAANwMIIABCADcDACAAQShqQQBBKBAQGgviAgICfwV+IABBKGoiASAAKAJIaiECAn4gACkDACIDQiBaBEAgACkDECIEQgeJIAApAwgiBUIBiXwgACkDGCIGQgyJfCAAKQMgIgdCEol8IAUQGSAEEBkgBhAZIAcQGQwBCyAAKQMYQsXP2bLx5brqJ3wLIAN8IQMDQCABQQhqIgAgAk0EQEIAIAEpAAAQCSADhUIbiUKHla+vmLbem55/fkLj3MqV/M7y9YV/fCEDIAAhAQwBCwsCQCABQQRqIgAgAksEQCABIQAMAQsgASgAAK1Ch5Wvr5i23puef34gA4VCF4lCz9bTvtLHq9lCfkL5893xmfaZqxZ8IQMLA0AgACACSQRAIAAxAABCxc/ZsvHluuonfiADhUILiUKHla+vmLbem55/fiEDIABBAWohAAwBCwsgA0IhiCADhULP1tO+0ser2UJ+IgNCHYggA4VC+fPd8Zn2masWfiIDQiCIIAOFC+8CAgJ/BH4gACAAKQMAIAKtfDcDAAJAAkAgACgCSCIDIAJqIgRBH00EQCABRQ0BIAAgA2pBKGogASACECAgACgCSCACaiEEDAELIAEgAmohAgJ/IAMEQCAAQShqIgQgA2ogAUEgIANrECAgACAAKQMIIAQpAAAQCTcDCCAAIAApAxAgACkAMBAJNwMQIAAgACkDGCAAKQA4EAk3AxggACAAKQMgIABBQGspAAAQCTcDICAAKAJIIQMgAEEANgJIIAEgA2tBIGohAQsgAUEgaiACTQsEQCACQWBqIQMgACkDICEFIAApAxghBiAAKQMQIQcgACkDCCEIA0AgCCABKQAAEAkhCCAHIAEpAAgQCSEHIAYgASkAEBAJIQYgBSABKQAYEAkhBSABQSBqIgEgA00NAAsgACAFNwMgIAAgBjcDGCAAIAc3AxAgACAINwMICyABIAJPDQEgAEEoaiABIAIgAWsiBBAgCyAAIAQ2AkgLCy8BAX8gAEUEQEG2f0EAIAMbDwtBun8hBCADIAFNBH8gACACIAMQEBogAwVBun8LCy8BAX8gAEUEQEG2f0EAIAMbDwtBun8hBCADIAFNBH8gACACIAMQCxogAwVBun8LC6gCAQZ/IwBBEGsiByQAIABB2OABaikDAEKAgIAQViEIQbh/IQUCQCAEQf//B0sNACAAIAMgBBBCIgUQAyIGDQAgACgCnOIBIQkgACAHQQxqIAMgAyAFaiAGGyIKIARBACAFIAYbayIGEEAiAxADBEAgAyEFDAELIAcoAgwhBCABRQRAQbp/IQUgBEEASg0BCyAGIANrIQUgAyAKaiEDAkAgCQRAIABBADYCnOIBDAELAkACQAJAIARBBUgNACAAQdjgAWopAwBCgICACFgNAAwBCyAAQQA2ApziAQwBCyAAKAIIED8hBiAAQQA2ApziASAGQRRPDQELIAAgASACIAMgBSAEIAgQOSEFDAELIAAgASACIAMgBSAEIAgQOiEFCyAHQRBqJAAgBQtnACAAQdDgAWogASACIAAoAuzhARAuIgEQAwRAIAEPC0G4fyECAkAgAQ0AIABB7OABaigCACIBBEBBYCECIAAoApjiASABRw0BC0EAIQIgAEHw4AFqKAIARQ0AIABBkOEBahBDCyACCycBAX8QVyIERQRAQUAPCyAEIAAgASACIAMgBBBLEE8hACAEEFYgAAs/AQF/AkACQAJAIAAoAqDiAUEBaiIBQQJLDQAgAUEBaw4CAAECCyAAEDBBAA8LIABBADYCoOIBCyAAKAKU4gELvAMCB38BfiMAQRBrIgkkAEG4fyEGAkAgBCgCACIIQQVBCSAAKALs4QEiBRtJDQAgAygCACIHQQFBBSAFGyAFEC8iBRADBEAgBSEGDAELIAggBUEDakkNACAAIAcgBRBJIgYQAw0AIAEgAmohCiAAQZDhAWohCyAIIAVrIQIgBSAHaiEHIAEhBQNAIAcgAiAJECwiBhADDQEgAkF9aiICIAZJBEBBuH8hBgwCCyAJKAIAIghBAksEQEFsIQYMAgsgB0EDaiEHAn8CQAJAAkAgCEEBaw4CAgABCyAAIAUgCiAFayAHIAYQSAwCCyAFIAogBWsgByAGEEcMAQsgBSAKIAVrIActAAAgCSgCCBBGCyIIEAMEQCAIIQYMAgsgACgC8OABBEAgCyAFIAgQRQsgAiAGayECIAYgB2ohByAFIAhqIQUgCSgCBEUNAAsgACkD0OABIgxCf1IEQEFsIQYgDCAFIAFrrFINAQsgACgC8OABBEBBaiEGIAJBBEkNASALEEQhDCAHKAAAIAynRw0BIAdBBGohByACQXxqIQILIAMgBzYCACAEIAI2AgAgBSABayEGCyAJQRBqJAAgBgsuACAAECsCf0EAQQAQAw0AGiABRSACRXJFBEBBYiAAIAEgAhA9EAMNARoLQQALCzcAIAEEQCAAIAAoAsTgASABKAIEIAEoAghqRzYCnOIBCyAAECtBABADIAFFckUEQCAAIAEQWwsL0QIBB38jAEEQayIGJAAgBiAENgIIIAYgAzYCDCAFBEAgBSgCBCEKIAUoAgghCQsgASEIAkACQANAIAAoAuzhARAWIQsCQANAIAQgC0kNASADKAAAQXBxQdDUtMIBRgRAIAMgBBAiIgcQAw0EIAQgB2shBCADIAdqIQMMAQsLIAYgAzYCDCAGIAQ2AggCQCAFBEAgACAFEE5BACEHQQAQA0UNAQwFCyAAIAogCRBNIgcQAw0ECyAAIAgQUCAMQQFHQQAgACAIIAIgBkEMaiAGQQhqEEwiByIDa0EAIAMQAxtBCkdyRQRAQbh/IQcMBAsgBxADDQMgAiAHayECIAcgCGohCEEBIQwgBigCDCEDIAYoAgghBAwBCwsgBiADNgIMIAYgBDYCCEG4fyEHIAQNASAIIAFrIQcMAQsgBiADNgIMIAYgBDYCCAsgBkEQaiQAIAcLRgECfyABIAAoArjgASICRwRAIAAgAjYCxOABIAAgATYCuOABIAAoArzgASEDIAAgATYCvOABIAAgASADIAJrajYCwOABCwutAgIEfwF+IwBBQGoiBCQAAkACQCACQQhJDQAgASgAAEFwcUHQ1LTCAUcNACABIAIQIiEBIABCADcDCCAAQQA2AgQgACABNgIADAELIARBGGogASACEC0iAxADBEAgACADEBoMAQsgAwRAIABBuH8QGgwBCyACIAQoAjAiA2shAiABIANqIQMDQAJAIAAgAyACIARBCGoQLCIFEAMEfyAFBSACIAVBA2oiBU8NAUG4fwsQGgwCCyAGQQFqIQYgAiAFayECIAMgBWohAyAEKAIMRQ0ACyAEKAI4BEAgAkEDTQRAIABBuH8QGgwCCyADQQRqIQMLIAQoAighAiAEKQMYIQcgAEEANgIEIAAgAyABazYCACAAIAIgBmytIAcgB0J/URs3AwgLIARBQGskAAslAQF/IwBBEGsiAiQAIAIgACABEFEgAigCACEAIAJBEGokACAAC30BBH8jAEGQBGsiBCQAIARB/wE2AggCQCAEQRBqIARBCGogBEEMaiABIAIQFSIGEAMEQCAGIQUMAQtBVCEFIAQoAgwiB0EGSw0AIAMgBEEQaiAEKAIIIAcQQSIFEAMNACAAIAEgBmogAiAGayADEDwhBQsgBEGQBGokACAFC4cBAgJ/An5BABAWIQMCQANAIAEgA08EQAJAIAAoAABBcHFB0NS0wgFGBEAgACABECIiAhADRQ0BQn4PCyAAIAEQVSIEQn1WDQMgBCAFfCIFIARUIQJCfiEEIAINAyAAIAEQUiICEAMNAwsgASACayEBIAAgAmohAAwBCwtCfiAFIAEbIQQLIAQLPwIBfwF+IwBBMGsiAiQAAn5CfiACQQhqIAAgARAtDQAaQgAgAigCHEEBRg0AGiACKQMICyEDIAJBMGokACADC40BAQJ/IwBBMGsiASQAAkAgAEUNACAAKAKI4gENACABIABB/OEBaigCADYCKCABIAApAvThATcDICAAEDAgACgCqOIBIQIgASABKAIoNgIYIAEgASkDIDcDECACIAFBEGoQGyAAQQA2AqjiASABIAEoAig2AgggASABKQMgNwMAIAAgARAbCyABQTBqJAALKgECfyMAQRBrIgAkACAAQQA2AgggAEIANwMAIAAQWCEBIABBEGokACABC4cBAQN/IwBBEGsiAiQAAkAgACgCAEUgACgCBEVzDQAgAiAAKAIINgIIIAIgACkCADcDAAJ/IAIoAgAiAQRAIAIoAghBqOMJIAERBQAMAQtBqOMJECgLIgFFDQAgASAAKQIANwL04QEgAUH84QFqIAAoAgg2AgAgARBZIAEhAwsgAkEQaiQAIAMLywEBAn8jAEEgayIBJAAgAEGBgIDAADYCtOIBIABBADYCiOIBIABBADYC7OEBIABCADcDkOIBIABBADYCpOMJIABBADYC3OIBIABCADcCzOIBIABBADYCvOIBIABBADYCxOABIABCADcCnOIBIABBpOIBakIANwIAIABBrOIBakEANgIAIAFCADcCECABQgA3AhggASABKQMYNwMIIAEgASkDEDcDACABKAIIQQh2QQFxIQIgAEEANgLg4gEgACACNgKM4gEgAUEgaiQAC3YBA38jAEEwayIBJAAgAARAIAEgAEHE0AFqIgIoAgA2AiggASAAKQK80AE3AyAgACgCACEDIAEgAigCADYCGCABIAApArzQATcDECADIAFBEGoQGyABIAEoAig2AgggASABKQMgNwMAIAAgARAbCyABQTBqJAALzAEBAX8gACABKAK00AE2ApjiASAAIAEoAgQiAjYCwOABIAAgAjYCvOABIAAgAiABKAIIaiICNgK44AEgACACNgLE4AEgASgCuNABBEAgAEKBgICAEDcDiOEBIAAgAUGk0ABqNgIMIAAgAUGUIGo2AgggACABQZwwajYCBCAAIAFBDGo2AgAgAEGs0AFqIAFBqNABaigCADYCACAAQbDQAWogAUGs0AFqKAIANgIAIABBtNABaiABQbDQAWooAgA2AgAPCyAAQgA3A4jhAQs7ACACRQRAQbp/DwsgBEUEQEFsDwsgAiAEEGAEQCAAIAEgAiADIAQgBRBhDwsgACABIAIgAyAEIAUQZQtGAQF/IwBBEGsiBSQAIAVBCGogBBAOAn8gBS0ACQRAIAAgASACIAMgBBAyDAELIAAgASACIAMgBBA0CyEAIAVBEGokACAACzQAIAAgAyAEIAUQNiIFEAMEQCAFDwsgBSAESQR/IAEgAiADIAVqIAQgBWsgABA1BUG4fwsLRgEBfyMAQRBrIgUkACAFQQhqIAQQDgJ/IAUtAAkEQCAAIAEgAiADIAQQYgwBCyAAIAEgAiADIAQQNQshACAFQRBqJAAgAAtZAQF/QQ8hAiABIABJBEAgAUEEdCAAbiECCyAAQQh2IgEgAkEYbCIAQYwIaigCAGwgAEGICGooAgBqIgJBA3YgAmogAEGACGooAgAgAEGECGooAgAgAWxqSQs3ACAAIAMgBCAFQYAQEDMiBRADBEAgBQ8LIAUgBEkEfyABIAIgAyAFaiAEIAVrIAAQMgVBuH8LC78DAQN/IwBBIGsiBSQAIAVBCGogAiADEAYiAhADRQRAIAAgAWoiB0F9aiEGIAUgBBAOIARBBGohAiAFLQACIQMDQEEAIAAgBkkgBUEIahAEGwRAIAAgAiAFQQhqIAMQAkECdGoiBC8BADsAACAFQQhqIAQtAAIQASAAIAQtAANqIgQgAiAFQQhqIAMQAkECdGoiAC8BADsAACAFQQhqIAAtAAIQASAEIAAtAANqIQAMAQUgB0F+aiEEA0AgBUEIahAEIAAgBEtyRQRAIAAgAiAFQQhqIAMQAkECdGoiBi8BADsAACAFQQhqIAYtAAIQASAAIAYtAANqIQAMAQsLA0AgACAES0UEQCAAIAIgBUEIaiADEAJBAnRqIgYvAQA7AAAgBUEIaiAGLQACEAEgACAGLQADaiEADAELCwJAIAAgB08NACAAIAIgBUEIaiADEAIiA0ECdGoiAC0AADoAACAALQADQQFGBEAgBUEIaiAALQACEAEMAQsgBSgCDEEfSw0AIAVBCGogAiADQQJ0ai0AAhABIAUoAgxBIUkNACAFQSA2AgwLIAFBbCAFQQhqEAobIQILCwsgBUEgaiQAIAILkgIBBH8jAEFAaiIJJAAgCSADQTQQCyEDAkAgBEECSA0AIAMgBEECdGooAgAhCSADQTxqIAgQIyADQQE6AD8gAyACOgA+QQAhBCADKAI8IQoDQCAEIAlGDQEgACAEQQJ0aiAKNgEAIARBAWohBAwAAAsAC0EAIQkDQCAGIAlGRQRAIAMgBSAJQQF0aiIKLQABIgtBAnRqIgwoAgAhBCADQTxqIAotAABBCHQgCGpB//8DcRAjIANBAjoAPyADIAcgC2siCiACajoAPiAEQQEgASAKa3RqIQogAygCPCELA0AgACAEQQJ0aiALNgEAIARBAWoiBCAKSQ0ACyAMIAo2AgAgCUEBaiEJDAELCyADQUBrJAALowIBCX8jAEHQAGsiCSQAIAlBEGogBUE0EAsaIAcgBmshDyAHIAFrIRADQAJAIAMgCkcEQEEBIAEgByACIApBAXRqIgYtAAEiDGsiCGsiC3QhDSAGLQAAIQ4gCUEQaiAMQQJ0aiIMKAIAIQYgCyAPTwRAIAAgBkECdGogCyAIIAUgCEE0bGogCCAQaiIIQQEgCEEBShsiCCACIAQgCEECdGooAgAiCEEBdGogAyAIayAHIA4QYyAGIA1qIQgMAgsgCUEMaiAOECMgCUEBOgAPIAkgCDoADiAGIA1qIQggCSgCDCELA0AgBiAITw0CIAAgBkECdGogCzYBACAGQQFqIQYMAAALAAsgCUHQAGokAA8LIAwgCDYCACAKQQFqIQoMAAALAAs0ACAAIAMgBCAFEDYiBRADBEAgBQ8LIAUgBEkEfyABIAIgAyAFaiAEIAVrIAAQNAVBuH8LCyMAIAA/AEEQdGtB//8DakEQdkAAQX9GBEBBAA8LQQAQAEEBCzsBAX8gAgRAA0AgACABIAJBgCAgAkGAIEkbIgMQCyEAIAFBgCBqIQEgAEGAIGohACACIANrIgINAAsLCwYAIAAQAwsLqBUJAEGICAsNAQAAAAEAAAACAAAAAgBBoAgLswYBAAAAAQAAAAIAAAACAAAAJgAAAIIAAAAhBQAASgAAAGcIAAAmAAAAwAEAAIAAAABJBQAASgAAAL4IAAApAAAALAIAAIAAAABJBQAASgAAAL4IAAAvAAAAygIAAIAAAACKBQAASgAAAIQJAAA1AAAAcwMAAIAAAACdBQAASgAAAKAJAAA9AAAAgQMAAIAAAADrBQAASwAAAD4KAABEAAAAngMAAIAAAABNBgAASwAAAKoKAABLAAAAswMAAIAAAADBBgAATQAAAB8NAABNAAAAUwQAAIAAAAAjCAAAUQAAAKYPAABUAAAAmQQAAIAAAABLCQAAVwAAALESAABYAAAA2gQAAIAAAABvCQAAXQAAACMUAABUAAAARQUAAIAAAABUCgAAagAAAIwUAABqAAAArwUAAIAAAAB2CQAAfAAAAE4QAAB8AAAA0gIAAIAAAABjBwAAkQAAAJAHAACSAAAAAAAAAAEAAAABAAAABQAAAA0AAAAdAAAAPQAAAH0AAAD9AAAA/QEAAP0DAAD9BwAA/Q8AAP0fAAD9PwAA/X8AAP3/AAD9/wEA/f8DAP3/BwD9/w8A/f8fAP3/PwD9/38A/f//AP3//wH9//8D/f//B/3//w/9//8f/f//P/3//38AAAAAAQAAAAIAAAADAAAABAAAAAUAAAAGAAAABwAAAAgAAAAJAAAACgAAAAsAAAAMAAAADQAAAA4AAAAPAAAAEAAAABEAAAASAAAAEwAAABQAAAAVAAAAFgAAABcAAAAYAAAAGQAAABoAAAAbAAAAHAAAAB0AAAAeAAAAHwAAAAMAAAAEAAAABQAAAAYAAAAHAAAACAAAAAkAAAAKAAAACwAAAAwAAAANAAAADgAAAA8AAAAQAAAAEQAAABIAAAATAAAAFAAAABUAAAAWAAAAFwAAABgAAAAZAAAAGgAAABsAAAAcAAAAHQAAAB4AAAAfAAAAIAAAACEAAAAiAAAAIwAAACUAAAAnAAAAKQAAACsAAAAvAAAAMwAAADsAAABDAAAAUwAAAGMAAACDAAAAAwEAAAMCAAADBAAAAwgAAAMQAAADIAAAA0AAAAOAAAADAAEAQeAPC1EBAAAAAQAAAAEAAAABAAAAAgAAAAIAAAADAAAAAwAAAAQAAAAEAAAABQAAAAcAAAAIAAAACQAAAAoAAAALAAAADAAAAA0AAAAOAAAADwAAABAAQcQQC4sBAQAAAAIAAAADAAAABAAAAAUAAAAGAAAABwAAAAgAAAAJAAAACgAAAAsAAAAMAAAADQAAAA4AAAAPAAAAEAAAABIAAAAUAAAAFgAAABgAAAAcAAAAIAAAACgAAAAwAAAAQAAAAIAAAAAAAQAAAAIAAAAEAAAACAAAABAAAAAgAAAAQAAAAIAAAAAAAQBBkBIL5gQBAAAAAQAAAAEAAAABAAAAAgAAAAIAAAADAAAAAwAAAAQAAAAGAAAABwAAAAgAAAAJAAAACgAAAAsAAAAMAAAADQAAAA4AAAAPAAAAEAAAAAEAAAAEAAAACAAAAAAAAAABAAEBBgAAAAAAAAQAAAAAEAAABAAAAAAgAAAFAQAAAAAAAAUDAAAAAAAABQQAAAAAAAAFBgAAAAAAAAUHAAAAAAAABQkAAAAAAAAFCgAAAAAAAAUMAAAAAAAABg4AAAAAAAEFEAAAAAAAAQUUAAAAAAABBRYAAAAAAAIFHAAAAAAAAwUgAAAAAAAEBTAAAAAgAAYFQAAAAAAABwWAAAAAAAAIBgABAAAAAAoGAAQAAAAADAYAEAAAIAAABAAAAAAAAAAEAQAAAAAAAAUCAAAAIAAABQQAAAAAAAAFBQAAACAAAAUHAAAAAAAABQgAAAAgAAAFCgAAAAAAAAULAAAAAAAABg0AAAAgAAEFEAAAAAAAAQUSAAAAIAABBRYAAAAAAAIFGAAAACAAAwUgAAAAAAADBSgAAAAAAAYEQAAAABAABgRAAAAAIAAHBYAAAAAAAAkGAAIAAAAACwYACAAAMAAABAAAAAAQAAAEAQAAACAAAAUCAAAAIAAABQMAAAAgAAAFBQAAACAAAAUGAAAAIAAABQgAAAAgAAAFCQAAACAAAAULAAAAIAAABQwAAAAAAAAGDwAAACAAAQUSAAAAIAABBRQAAAAgAAIFGAAAACAAAgUcAAAAIAADBSgAAAAgAAQFMAAAAAAAEAYAAAEAAAAPBgCAAAAAAA4GAEAAAAAADQYAIABBgBcLhwIBAAEBBQAAAAAAAAUAAAAAAAAGBD0AAAAAAAkF/QEAAAAADwX9fwAAAAAVBf3/HwAAAAMFBQAAAAAABwR9AAAAAAAMBf0PAAAAABIF/f8DAAAAFwX9/38AAAAFBR0AAAAAAAgE/QAAAAAADgX9PwAAAAAUBf3/DwAAAAIFAQAAABAABwR9AAAAAAALBf0HAAAAABEF/f8BAAAAFgX9/z8AAAAEBQ0AAAAQAAgE/QAAAAAADQX9HwAAAAATBf3/BwAAAAEFAQAAABAABgQ9AAAAAAAKBf0DAAAAABAF/f8AAAAAHAX9//8PAAAbBf3//wcAABoF/f//AwAAGQX9//8BAAAYBf3//wBBkBkLhgQBAAEBBgAAAAAAAAYDAAAAAAAABAQAAAAgAAAFBQAAAAAAAAUGAAAAAAAABQgAAAAAAAAFCQAAAAAAAAULAAAAAAAABg0AAAAAAAAGEAAAAAAAAAYTAAAAAAAABhYAAAAAAAAGGQAAAAAAAAYcAAAAAAAABh8AAAAAAAAGIgAAAAAAAQYlAAAAAAABBikAAAAAAAIGLwAAAAAAAwY7AAAAAAAEBlMAAAAAAAcGgwAAAAAACQYDAgAAEAAABAQAAAAAAAAEBQAAACAAAAUGAAAAAAAABQcAAAAgAAAFCQAAAAAAAAUKAAAAAAAABgwAAAAAAAAGDwAAAAAAAAYSAAAAAAAABhUAAAAAAAAGGAAAAAAAAAYbAAAAAAAABh4AAAAAAAAGIQAAAAAAAQYjAAAAAAABBicAAAAAAAIGKwAAAAAAAwYzAAAAAAAEBkMAAAAAAAUGYwAAAAAACAYDAQAAIAAABAQAAAAwAAAEBAAAABAAAAQFAAAAIAAABQcAAAAgAAAFCAAAACAAAAUKAAAAIAAABQsAAAAAAAAGDgAAAAAAAAYRAAAAAAAABhQAAAAAAAAGFwAAAAAAAAYaAAAAAAAABh0AAAAAAAAGIAAAAAAAEAYDAAEAAAAPBgOAAAAAAA4GA0AAAAAADQYDIAAAAAAMBgMQAAAAAAsGAwgAAAAACgYDBABBpB0L2QEBAAAAAwAAAAcAAAAPAAAAHwAAAD8AAAB/AAAA/wAAAP8BAAD/AwAA/wcAAP8PAAD/HwAA/z8AAP9/AAD//wAA//8BAP//AwD//wcA//8PAP//HwD//z8A//9/AP///wD///8B////A////wf///8P////H////z////9/AAAAAAEAAAACAAAABAAAAAAAAAACAAAABAAAAAgAAAAAAAAAAQAAAAIAAAABAAAABAAAAAQAAAAEAAAABAAAAAgAAAAIAAAACAAAAAcAAAAIAAAACQAAAAoAAAALAEGgIAsDwBBQ";class oC extends Dc{constructor(e,t,i){super(void 0,e[0].width,e[0].height,t,i,vy),this.isCompressedCubeTexture=!0,this.isCubeTexture=!0,this.image=e}}class aC extends Dc{constructor(e,t,i,s,r,o){super(e,t,i,r,o),this.isCompressedArrayTexture=!0,this.image.depth=s,this.wrapR=Ro}}var cC=Object.defineProperty,lC=(n,e,t)=>e in n?cC(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,kc=(n,e,t)=>(lC(n,typeof e!="symbol"?e+"":e,t),t);const yp=3e3,Ep=3001,Jd="",uC="display-p3",hC="display-p3-linear",fC="srgb-linear",Jh="srgb",yl=new WeakMap;let El=0,vl;const po=class extends fn{constructor(n){super(n),this.transcoderPath="",this.transcoderBinary=null,this.transcoderPending=null,this.workerPool=new $4,this.workerSourceURL="",this.workerConfig=null,typeof MSC_TRANSCODER<"u"&&console.warn('THREE.KTX2Loader: Please update to latest "basis_transcoder". "msc_basis_transcoder" is no longer supported in three.js r125+.')}setTranscoderPath(n){return this.transcoderPath=n,this}setWorkerLimit(n){return this.workerPool.setWorkerLimit(n),this}detectSupport(n){return this.workerConfig={astcSupported:n.extensions.has("WEBGL_compressed_texture_astc"),etc1Supported:n.extensions.has("WEBGL_compressed_texture_etc1"),etc2Supported:n.extensions.has("WEBGL_compressed_texture_etc"),dxtSupported:n.extensions.has("WEBGL_compressed_texture_s3tc"),bptcSupported:n.extensions.has("EXT_texture_compression_bptc"),pvrtcSupported:n.extensions.has("WEBGL_compressed_texture_pvrtc")||n.extensions.has("WEBKIT_WEBGL_compressed_texture_pvrtc")},n.capabilities.isWebGL2&&(this.workerConfig.etc1Supported=!1),this}init(){if(!this.transcoderPending){const n=new ss(this.manager);n.setPath(this.transcoderPath),n.setWithCredentials(this.withCredentials);const e=n.loadAsync("basis_transcoder.js"),t=new ss(this.manager);t.setPath(this.transcoderPath),t.setResponseType("arraybuffer"),t.setWithCredentials(this.withCredentials);const i=t.loadAsync("basis_transcoder.wasm");this.transcoderPending=Promise.all([e,i]).then(([s,r])=>{const o=po.BasisWorker.toString(),a=["/* constants */","let _EngineFormat = "+JSON.stringify(po.EngineFormat),"let _TranscoderFormat = "+JSON.stringify(po.TranscoderFormat),"let _BasisFormat = "+JSON.stringify(po.BasisFormat),"/* basis_transcoder.js */",s,"/* worker */",o.substring(o.indexOf("{")+1,o.lastIndexOf("}"))].join(`
`);this.workerSourceURL=URL.createObjectURL(new Blob([a])),this.transcoderBinary=r,this.workerPool.setWorkerCreator(()=>{const c=new Worker(this.workerSourceURL),l=this.transcoderBinary.slice(0);return c.postMessage({type:"init",config:this.workerConfig,transcoderBinary:l},[l]),c})}),El>0&&console.warn("THREE.KTX2Loader: Multiple active KTX2 loaders may cause performance issues. Use a single KTX2Loader instance, or call .dispose() on old instances."),El++}return this.transcoderPending}load(n,e,t,i){if(this.workerConfig===null)throw new Error("THREE.KTX2Loader: Missing initialization with `.detectSupport( renderer )`.");const s=new ss(this.manager);s.setResponseType("arraybuffer"),s.setWithCredentials(this.withCredentials),s.load(n,r=>{if(yl.has(r))return yl.get(r).promise.then(e).catch(i);this._createTexture(r).then(o=>e?e(o):null).catch(i)},t,i)}_createTextureFrom(n,e){const{faces:t,width:i,height:s,format:r,type:o,error:a,dfdFlags:c}=n;if(o==="error")return Promise.reject(a);let l;if(e.faceCount===6)l=new oC(t,r,Yt);else{const h=t[0].mipmaps;l=e.layerCount>1?new aC(h,i,s,e.layerCount,r,Yt):new Dc(h,i,s,r,Yt)}l.minFilter=t[0].mipmaps.length===1?zt:Po,l.magFilter=zt,l.generateMipmaps=!1,l.needsUpdate=!0;const u=vp(e);return"colorSpace"in l?l.colorSpace=u:l.encoding=u===Jh?Ep:yp,l.premultiplyAlpha=!!(c&Z4),l}async _createTexture(n,e={}){const t=nC(new Uint8Array(n));if(t.vkFormat!==sp)return AC(t);const i=e,s=this.init().then(()=>this.workerPool.postMessage({type:"transcode",buffer:n,taskConfig:i},[n])).then(r=>this._createTextureFrom(r.data,t));return yl.set(n,{promise:s}),s}dispose(){return this.workerPool.dispose(),this.workerSourceURL&&URL.revokeObjectURL(this.workerSourceURL),El--,this}};let mn=po;kc(mn,"BasisFormat",{ETC1S:0,UASTC_4x4:1});kc(mn,"TranscoderFormat",{ETC1:0,ETC2:1,BC1:2,BC3:3,BC4:4,BC5:5,BC7_M6_OPAQUE_ONLY:6,BC7_M5:7,PVRTC1_4_RGB:8,PVRTC1_4_RGBA:9,ASTC_4x4:10,ATC_RGB:11,ATC_RGBA_INTERPOLATED_ALPHA:12,RGBA32:13,RGB565:14,BGR565:15,RGBA4444:16});kc(mn,"EngineFormat",{RGBAFormat:jt,RGBA_ASTC_4x4_Format:xy,RGBA_BPTC_Format:Cy,RGBA_ETC2_EAC_Format:Iy,RGBA_PVRTC_4BPPV1_Format:Sy,RGBA_S3TC_DXT5_Format:wy,RGB_ETC1_Format:Ty,RGB_ETC2_Format:By,RGB_PVRTC_4BPPV1_Format:_y,RGB_S3TC_DXT1_Format:by});kc(mn,"BasisWorker",function(){let n,e,t;const i=_EngineFormat,s=_TranscoderFormat,r=_BasisFormat;self.addEventListener("message",function(p){const m=p.data;switch(m.type){case"init":n=m.config,o(m.transcoderBinary);break;case"transcode":e.then(()=>{try{const{faces:g,buffers:y,width:v,height:E,hasAlpha:C,format:x,dfdFlags:I}=a(m.buffer);self.postMessage({type:"transcode",id:m.id,faces:g,width:v,height:E,hasAlpha:C,format:x,dfdFlags:I},y)}catch(g){console.error(g),self.postMessage({type:"error",id:m.id,error:g.message})}});break}});function o(p){e=new Promise(m=>{t={wasmBinary:p,onRuntimeInitialized:m},BASIS(t)}).then(()=>{t.initializeBasis(),t.KTX2File===void 0&&console.warn("THREE.KTX2Loader: Please update Basis Universal transcoder.")})}function a(p){const m=new t.KTX2File(new Uint8Array(p));function g(){m.close(),m.delete()}if(!m.isValid())throw g(),new Error("THREE.KTX2Loader:	Invalid or unsupported .ktx2 file");const y=m.isUASTC()?r.UASTC_4x4:r.ETC1S,v=m.getWidth(),E=m.getHeight(),C=m.getLayers()||1,x=m.getLevels(),I=m.getFaces(),S=m.getHasAlpha(),w=m.getDFDFlags(),{transcoderFormat:B,engineFormat:T}=h(y,v,E,S);if(!v||!E||!x)throw g(),new Error("THREE.KTX2Loader:	Invalid texture");if(!m.startTranscoding())throw g(),new Error("THREE.KTX2Loader: .startTranscoding failed");const R=[],_=[];for(let L=0;L<I;L++){const O=[];for(let U=0;U<x;U++){const Q=[];let G,z;for(let N=0;N<C;N++){const V=m.getImageLevelInfo(U,N,L);L===0&&U===0&&N===0&&(V.origWidth%4!==0||V.origHeight%4!==0)&&console.warn("THREE.KTX2Loader: ETC1S and UASTC textures should use multiple-of-four dimensions."),x>1?(G=V.origWidth,z=V.origHeight):(G=V.width,z=V.height);const $=new Uint8Array(m.getImageTranscodedSizeInBytes(U,N,0,B));if(!m.transcodeImage($,U,N,L,B,0,-1,-1))throw g(),new Error("THREE.KTX2Loader: .transcodeImage failed.");Q.push($)}const H=d(Q);O.push({data:H,width:G,height:z}),_.push(H.buffer)}R.push({mipmaps:O,width:v,height:E,format:T})}return g(),{faces:R,buffers:_,width:v,height:E,hasAlpha:S,format:T,dfdFlags:w}}const c=[{if:"astcSupported",basisFormat:[r.UASTC_4x4],transcoderFormat:[s.ASTC_4x4,s.ASTC_4x4],engineFormat:[i.RGBA_ASTC_4x4_Format,i.RGBA_ASTC_4x4_Format],priorityETC1S:1/0,priorityUASTC:1,needsPowerOfTwo:!1},{if:"bptcSupported",basisFormat:[r.ETC1S,r.UASTC_4x4],transcoderFormat:[s.BC7_M5,s.BC7_M5],engineFormat:[i.RGBA_BPTC_Format,i.RGBA_BPTC_Format],priorityETC1S:3,priorityUASTC:2,needsPowerOfTwo:!1},{if:"dxtSupported",basisFormat:[r.ETC1S,r.UASTC_4x4],transcoderFormat:[s.BC1,s.BC3],engineFormat:[i.RGB_S3TC_DXT1_Format,i.RGBA_S3TC_DXT5_Format],priorityETC1S:4,priorityUASTC:5,needsPowerOfTwo:!1},{if:"etc2Supported",basisFormat:[r.ETC1S,r.UASTC_4x4],transcoderFormat:[s.ETC1,s.ETC2],engineFormat:[i.RGB_ETC2_Format,i.RGBA_ETC2_EAC_Format],priorityETC1S:1,priorityUASTC:3,needsPowerOfTwo:!1},{if:"etc1Supported",basisFormat:[r.ETC1S,r.UASTC_4x4],transcoderFormat:[s.ETC1],engineFormat:[i.RGB_ETC1_Format],priorityETC1S:2,priorityUASTC:4,needsPowerOfTwo:!1},{if:"pvrtcSupported",basisFormat:[r.ETC1S,r.UASTC_4x4],transcoderFormat:[s.PVRTC1_4_RGB,s.PVRTC1_4_RGBA],engineFormat:[i.RGB_PVRTC_4BPPV1_Format,i.RGBA_PVRTC_4BPPV1_Format],priorityETC1S:5,priorityUASTC:6,needsPowerOfTwo:!0}],l=c.sort(function(p,m){return p.priorityETC1S-m.priorityETC1S}),u=c.sort(function(p,m){return p.priorityUASTC-m.priorityUASTC});function h(p,m,g,y){let v,E;const C=p===r.ETC1S?l:u;for(let x=0;x<C.length;x++){const I=C[x];if(n[I.if]&&I.basisFormat.includes(p)&&!(y&&I.transcoderFormat.length<2)&&!(I.needsPowerOfTwo&&!(f(m)&&f(g))))return v=I.transcoderFormat[y?1:0],E=I.engineFormat[y?1:0],{transcoderFormat:v,engineFormat:E}}return console.warn("THREE.KTX2Loader: No suitable compressed texture format found. Decoding to RGBA32."),v=s.RGBA32,E=i.RGBAFormat,{transcoderFormat:v,engineFormat:E}}function f(p){return p<=2?!0:(p&p-1)===0&&p!==0}function d(p){if(p.length===1)return p[0];let m=0;for(let v=0;v<p.length;v++){const E=p[v];m+=E.byteLength}const g=new Uint8Array(m);let y=0;for(let v=0;v<p.length;v++){const E=p[v];g.set(E,y),y+=E.byteLength}return g}});const dC=new Set([jt,sr,Is]),xl={[mp]:jt,[fp]:jt,[cp]:jt,[lp]:jt,[Ap]:sr,[hp]:sr,[op]:sr,[ap]:sr,[dp]:Is,[up]:Is,[rp]:Is,[np]:Is,[gp]:bf,[pp]:bf},Cl={[mp]:Jt,[fp]:Qi,[cp]:Yt,[lp]:Yt,[Ap]:Jt,[hp]:Qi,[op]:Yt,[ap]:Yt,[dp]:Jt,[up]:Qi,[rp]:Yt,[np]:Yt,[gp]:Yt,[pp]:Yt};async function AC(n){const{vkFormat:e}=n;if(xl[e]===void 0)throw new Error("THREE.KTX2Loader: Unsupported vkFormat.");let t;n.supercompressionScheme===$d&&(vl||(vl=new Promise(async o=>{const a=new rC;await a.init(),o(a)})),t=await vl);const i=[];for(let o=0;o<n.levels.length;o++){const a=Math.max(1,n.pixelWidth>>o),c=Math.max(1,n.pixelHeight>>o),l=n.pixelDepth?Math.max(1,n.pixelDepth>>o):0,u=n.levels[o];let h;if(n.supercompressionScheme===tp)h=u.levelData;else if(n.supercompressionScheme===$d)h=t.decode(u.levelData,u.uncompressedByteLength);else throw new Error("THREE.KTX2Loader: Unsupported supercompressionScheme.");let f;Cl[e]===Jt?f=new Float32Array(h.buffer,h.byteOffset,h.byteLength/Float32Array.BYTES_PER_ELEMENT):Cl[e]===Qi?f=new Uint16Array(h.buffer,h.byteOffset,h.byteLength/Uint16Array.BYTES_PER_ELEMENT):f=h,i.push({data:f,width:a,height:c,depth:l})}let s;if(dC.has(xl[e]))s=n.pixelDepth===0?new ln(i[0].data,n.pixelWidth,n.pixelHeight):new Y4(i[0].data,n.pixelWidth,n.pixelHeight,n.pixelDepth);else{if(n.pixelDepth>0)throw new Error("THREE.KTX2Loader: Unsupported pixelDepth.");s=new Dc(i,n.pixelWidth,n.pixelHeight)}s.mipmaps=i,s.type=Cl[e],s.format=xl[e],s.needsUpdate=!0;const r=vp(n);return"colorSpace"in s?s.colorSpace=r:s.encoding=r===Jh?Ep:yp,Promise.resolve(s)}function vp(n){const e=n.dataFormatDescriptor[0];return e.colorPrimaries===ip?e.transferFunction===ih?Jh:fC:e.colorPrimaries===tC?e.transferFunction===ih?uC:hC:(e.colorPrimaries===eC||console.warn(`THREE.KTX2Loader: Unsupported color primaries, "${e.colorPrimaries}"`),Jd)}const mC="srgb";class Io extends fn{constructor(e){super(e),this.defaultDPI=90,this.defaultUnit="px"}load(e,t,i,s){const r=this,o=new ss(r.manager);o.setPath(r.path),o.setRequestHeader(r.requestHeader),o.setWithCredentials(r.withCredentials),o.load(e,function(a){try{t(r.parse(a))}catch(c){s?s(c):console.error(c),r.manager.itemError(e)}},i,s)}parse(e){const t=this;function i(M,k){if(M.nodeType!==1)return;const P=C(M);let F=!1,J=null;switch(M.nodeName){case"svg":k=p(M,k);break;case"style":r(M);break;case"g":k=p(M,k);break;case"path":k=p(M,k),M.hasAttribute("d")&&(J=s(M));break;case"rect":k=p(M,k),J=c(M);break;case"polygon":k=p(M,k),J=l(M);break;case"polyline":k=p(M,k),J=u(M);break;case"circle":k=p(M,k),J=h(M);break;case"ellipse":k=p(M,k),J=f(M);break;case"line":k=p(M,k),J=d(M);break;case"defs":F=!0;break;case"use":k=p(M,k);const re=(M.getAttributeNS("http://www.w3.org/1999/xlink","href")||"").substring(1),he=M.viewportElement.getElementById(re);he?i(he,k):console.warn("SVGLoader: 'use node' references non-existent node id: "+re);break}J&&(k.fill!==void 0&&k.fill!=="none"&&J.color.setStyle(k.fill,mC),I(J,V),_.push(J),J.userData={node:M,style:k});const se=M.childNodes;for(let q=0;q<se.length;q++){const re=se[q];F&&re.nodeName!=="style"&&re.nodeName!=="defs"||i(re,k)}P&&(O.pop(),O.length>0?V.copy(O[O.length-1]):V.identity())}function s(M){const k=new Ps,P=new de,F=new de,J=new de;let se=!0,q=!1;const re=M.getAttribute("d");if(re===""||re==="none")return null;const he=re.match(/[a-df-z][^a-df-z]*/gi);for(let fe=0,ae=he.length;fe<ae;fe++){const ue=he[fe],ge=ue.charAt(0),me=ue.slice(1).trim();se===!0&&(q=!0,se=!1);let W;switch(ge){case"M":W=g(me);for(let K=0,pe=W.length;K<pe;K+=2)P.x=W[K+0],P.y=W[K+1],F.x=P.x,F.y=P.y,K===0?k.moveTo(P.x,P.y):k.lineTo(P.x,P.y),K===0&&J.copy(P);break;case"H":W=g(me);for(let K=0,pe=W.length;K<pe;K++)P.x=W[K],F.x=P.x,F.y=P.y,k.lineTo(P.x,P.y),K===0&&q===!0&&J.copy(P);break;case"V":W=g(me);for(let K=0,pe=W.length;K<pe;K++)P.y=W[K],F.x=P.x,F.y=P.y,k.lineTo(P.x,P.y),K===0&&q===!0&&J.copy(P);break;case"L":W=g(me);for(let K=0,pe=W.length;K<pe;K+=2)P.x=W[K+0],P.y=W[K+1],F.x=P.x,F.y=P.y,k.lineTo(P.x,P.y),K===0&&q===!0&&J.copy(P);break;case"C":W=g(me);for(let K=0,pe=W.length;K<pe;K+=6)k.bezierCurveTo(W[K+0],W[K+1],W[K+2],W[K+3],W[K+4],W[K+5]),F.x=W[K+2],F.y=W[K+3],P.x=W[K+4],P.y=W[K+5],K===0&&q===!0&&J.copy(P);break;case"S":W=g(me);for(let K=0,pe=W.length;K<pe;K+=4)k.bezierCurveTo(m(P.x,F.x),m(P.y,F.y),W[K+0],W[K+1],W[K+2],W[K+3]),F.x=W[K+0],F.y=W[K+1],P.x=W[K+2],P.y=W[K+3],K===0&&q===!0&&J.copy(P);break;case"Q":W=g(me);for(let K=0,pe=W.length;K<pe;K+=4)k.quadraticCurveTo(W[K+0],W[K+1],W[K+2],W[K+3]),F.x=W[K+0],F.y=W[K+1],P.x=W[K+2],P.y=W[K+3],K===0&&q===!0&&J.copy(P);break;case"T":W=g(me);for(let K=0,pe=W.length;K<pe;K+=2){const Fe=m(P.x,F.x),Se=m(P.y,F.y);k.quadraticCurveTo(Fe,Se,W[K+0],W[K+1]),F.x=Fe,F.y=Se,P.x=W[K+0],P.y=W[K+1],K===0&&q===!0&&J.copy(P)}break;case"A":W=g(me,[3,4],7);for(let K=0,pe=W.length;K<pe;K+=7){if(W[K+5]==P.x&&W[K+6]==P.y)continue;const Fe=P.clone();P.x=W[K+5],P.y=W[K+6],F.x=P.x,F.y=P.y,o(k,W[K],W[K+1],W[K+2],W[K+3],W[K+4],Fe,P),K===0&&q===!0&&J.copy(P)}break;case"m":W=g(me);for(let K=0,pe=W.length;K<pe;K+=2)P.x+=W[K+0],P.y+=W[K+1],F.x=P.x,F.y=P.y,K===0?k.moveTo(P.x,P.y):k.lineTo(P.x,P.y),K===0&&J.copy(P);break;case"h":W=g(me);for(let K=0,pe=W.length;K<pe;K++)P.x+=W[K],F.x=P.x,F.y=P.y,k.lineTo(P.x,P.y),K===0&&q===!0&&J.copy(P);break;case"v":W=g(me);for(let K=0,pe=W.length;K<pe;K++)P.y+=W[K],F.x=P.x,F.y=P.y,k.lineTo(P.x,P.y),K===0&&q===!0&&J.copy(P);break;case"l":W=g(me);for(let K=0,pe=W.length;K<pe;K+=2)P.x+=W[K+0],P.y+=W[K+1],F.x=P.x,F.y=P.y,k.lineTo(P.x,P.y),K===0&&q===!0&&J.copy(P);break;case"c":W=g(me);for(let K=0,pe=W.length;K<pe;K+=6)k.bezierCurveTo(P.x+W[K+0],P.y+W[K+1],P.x+W[K+2],P.y+W[K+3],P.x+W[K+4],P.y+W[K+5]),F.x=P.x+W[K+2],F.y=P.y+W[K+3],P.x+=W[K+4],P.y+=W[K+5],K===0&&q===!0&&J.copy(P);break;case"s":W=g(me);for(let K=0,pe=W.length;K<pe;K+=4)k.bezierCurveTo(m(P.x,F.x),m(P.y,F.y),P.x+W[K+0],P.y+W[K+1],P.x+W[K+2],P.y+W[K+3]),F.x=P.x+W[K+0],F.y=P.y+W[K+1],P.x+=W[K+2],P.y+=W[K+3],K===0&&q===!0&&J.copy(P);break;case"q":W=g(me);for(let K=0,pe=W.length;K<pe;K+=4)k.quadraticCurveTo(P.x+W[K+0],P.y+W[K+1],P.x+W[K+2],P.y+W[K+3]),F.x=P.x+W[K+0],F.y=P.y+W[K+1],P.x+=W[K+2],P.y+=W[K+3],K===0&&q===!0&&J.copy(P);break;case"t":W=g(me);for(let K=0,pe=W.length;K<pe;K+=2){const Fe=m(P.x,F.x),Se=m(P.y,F.y);k.quadraticCurveTo(Fe,Se,P.x+W[K+0],P.y+W[K+1]),F.x=Fe,F.y=Se,P.x=P.x+W[K+0],P.y=P.y+W[K+1],K===0&&q===!0&&J.copy(P)}break;case"a":W=g(me,[3,4],7);for(let K=0,pe=W.length;K<pe;K+=7){if(W[K+5]==0&&W[K+6]==0)continue;const Fe=P.clone();P.x+=W[K+5],P.y+=W[K+6],F.x=P.x,F.y=P.y,o(k,W[K],W[K+1],W[K+2],W[K+3],W[K+4],Fe,P),K===0&&q===!0&&J.copy(P)}break;case"Z":case"z":k.currentPath.autoClose=!0,k.currentPath.curves.length>0&&(P.copy(J),k.currentPath.currentPoint.copy(P),se=!0);break;default:console.warn(ue)}q=!1}return k}function r(M){if(!(!M.sheet||!M.sheet.cssRules||!M.sheet.cssRules.length))for(let k=0;k<M.sheet.cssRules.length;k++){const P=M.sheet.cssRules[k];if(P.type!==1)continue;const F=P.selectorText.split(/,/gm).filter(Boolean).map(J=>J.trim());for(let J=0;J<F.length;J++){const se=Object.fromEntries(Object.entries(P.style).filter(([,q])=>q!==""));L[F[J]]=Object.assign(L[F[J]]||{},se)}}}function o(M,k,P,F,J,se,q,re){if(k==0||P==0){M.lineTo(re.x,re.y);return}F=F*Math.PI/180,k=Math.abs(k),P=Math.abs(P);const he=(q.x-re.x)/2,fe=(q.y-re.y)/2,ae=Math.cos(F)*he+Math.sin(F)*fe,ue=-Math.sin(F)*he+Math.cos(F)*fe;let ge=k*k,me=P*P;const W=ae*ae,K=ue*ue,pe=W/ge+K/me;if(pe>1){const Qt=Math.sqrt(pe);k=Qt*k,P=Qt*P,ge=k*k,me=P*P}const Fe=ge*K+me*W,Se=(ge*me-Fe)/Fe;let be=Math.sqrt(Math.max(0,Se));J===se&&(be=-be);const De=be*k*ue/P,Ne=-be*P*ae/k,ot=Math.cos(F)*De-Math.sin(F)*Ne+(q.x+re.x)/2,Je=Math.sin(F)*De+Math.cos(F)*Ne+(q.y+re.y)/2,Ht=a(1,0,(ae-De)/k,(ue-Ne)/P),Kt=a((ae-De)/k,(ue-Ne)/P,(-ae-De)/k,(-ue-Ne)/P)%(Math.PI*2);M.currentPath.absellipse(ot,Je,k,P,Ht,Ht+Kt,se===0,F)}function a(M,k,P,F){const J=M*P+k*F,se=Math.sqrt(M*M+k*k)*Math.sqrt(P*P+F*F);let q=Math.acos(Math.max(-1,Math.min(1,J/se)));return M*F-k*P<0&&(q=-q),q}function c(M){const k=E(M.getAttribute("x")||0),P=E(M.getAttribute("y")||0),F=E(M.getAttribute("rx")||M.getAttribute("ry")||0),J=E(M.getAttribute("ry")||M.getAttribute("rx")||0),se=E(M.getAttribute("width")),q=E(M.getAttribute("height")),re=1-.551915024494,he=new Ps;return he.moveTo(k+F,P),he.lineTo(k+se-F,P),(F!==0||J!==0)&&he.bezierCurveTo(k+se-F*re,P,k+se,P+J*re,k+se,P+J),he.lineTo(k+se,P+q-J),(F!==0||J!==0)&&he.bezierCurveTo(k+se,P+q-J*re,k+se-F*re,P+q,k+se-F,P+q),he.lineTo(k+F,P+q),(F!==0||J!==0)&&he.bezierCurveTo(k+F*re,P+q,k,P+q-J*re,k,P+q-J),he.lineTo(k,P+J),(F!==0||J!==0)&&he.bezierCurveTo(k,P+J*re,k+F*re,P,k+F,P),he}function l(M){function k(se,q,re){const he=E(q),fe=E(re);J===0?F.moveTo(he,fe):F.lineTo(he,fe),J++}const P=/([+-]?\d*\.?\d+(?:e[+-]?\d+)?)(?:,|\s)([+-]?\d*\.?\d+(?:e[+-]?\d+)?)/g,F=new Ps;let J=0;return M.getAttribute("points").replace(P,k),F.currentPath.autoClose=!0,F}function u(M){function k(se,q,re){const he=E(q),fe=E(re);J===0?F.moveTo(he,fe):F.lineTo(he,fe),J++}const P=/([+-]?\d*\.?\d+(?:e[+-]?\d+)?)(?:,|\s)([+-]?\d*\.?\d+(?:e[+-]?\d+)?)/g,F=new Ps;let J=0;return M.getAttribute("points").replace(P,k),F.currentPath.autoClose=!1,F}function h(M){const k=E(M.getAttribute("cx")||0),P=E(M.getAttribute("cy")||0),F=E(M.getAttribute("r")||0),J=new el;J.absarc(k,P,F,0,Math.PI*2);const se=new Ps;return se.subPaths.push(J),se}function f(M){const k=E(M.getAttribute("cx")||0),P=E(M.getAttribute("cy")||0),F=E(M.getAttribute("rx")||0),J=E(M.getAttribute("ry")||0),se=new el;se.absellipse(k,P,F,J,0,Math.PI*2);const q=new Ps;return q.subPaths.push(se),q}function d(M){const k=E(M.getAttribute("x1")||0),P=E(M.getAttribute("y1")||0),F=E(M.getAttribute("x2")||0),J=E(M.getAttribute("y2")||0),se=new Ps;return se.moveTo(k,P),se.lineTo(F,J),se.currentPath.autoClose=!1,se}function p(M,k){k=Object.assign({},k);let P={};if(M.hasAttribute("class")){const q=M.getAttribute("class").split(/\s/).filter(Boolean).map(re=>re.trim());for(let re=0;re<q.length;re++)P=Object.assign(P,L["."+q[re]])}M.hasAttribute("id")&&(P=Object.assign(P,L["#"+M.getAttribute("id")]));function F(q,re,he){he===void 0&&(he=function(ae){return ae.startsWith("url")&&console.warn("SVGLoader: url access in attributes is not implemented."),ae}),M.hasAttribute(q)&&(k[re]=he(M.getAttribute(q))),P[q]&&(k[re]=he(P[q])),M.style&&M.style[q]!==""&&(k[re]=he(M.style[q]))}function J(q){return Math.max(0,Math.min(1,E(q)))}function se(q){return Math.max(0,E(q))}return F("fill","fill"),F("fill-opacity","fillOpacity",J),F("fill-rule","fillRule"),F("opacity","opacity",J),F("stroke","stroke"),F("stroke-opacity","strokeOpacity",J),F("stroke-width","strokeWidth",se),F("stroke-linejoin","strokeLineJoin"),F("stroke-linecap","strokeLineCap"),F("stroke-miterlimit","strokeMiterLimit",se),F("visibility","visibility"),k}function m(M,k){return M-(k-M)}function g(M,k,P){if(typeof M!="string")throw new TypeError("Invalid input: "+typeof M);const F={SEPARATOR:/[ \t\r\n\,.\-+]/,WHITESPACE:/[ \t\r\n]/,DIGIT:/[\d]/,SIGN:/[-+]/,POINT:/\./,COMMA:/,/,EXP:/e/i,FLAGS:/[01]/},J=0,se=1,q=2,re=3;let he=J,fe=!0,ae="",ue="";const ge=[];function me(Fe,Se,be){const De=new SyntaxError('Unexpected character "'+Fe+'" at index '+Se+".");throw De.partial=be,De}function W(){ae!==""&&(ue===""?ge.push(Number(ae)):ge.push(Number(ae)*Math.pow(10,Number(ue)))),ae="",ue=""}let K;const pe=M.length;for(let Fe=0;Fe<pe;Fe++){if(K=M[Fe],Array.isArray(k)&&k.includes(ge.length%P)&&F.FLAGS.test(K)){he=se,ae=K,W();continue}if(he===J){if(F.WHITESPACE.test(K))continue;if(F.DIGIT.test(K)||F.SIGN.test(K)){he=se,ae=K;continue}if(F.POINT.test(K)){he=q,ae=K;continue}F.COMMA.test(K)&&(fe&&me(K,Fe,ge),fe=!0)}if(he===se){if(F.DIGIT.test(K)){ae+=K;continue}if(F.POINT.test(K)){ae+=K,he=q;continue}if(F.EXP.test(K)){he=re;continue}F.SIGN.test(K)&&ae.length===1&&F.SIGN.test(ae[0])&&me(K,Fe,ge)}if(he===q){if(F.DIGIT.test(K)){ae+=K;continue}if(F.EXP.test(K)){he=re;continue}F.POINT.test(K)&&ae[ae.length-1]==="."&&me(K,Fe,ge)}if(he===re){if(F.DIGIT.test(K)){ue+=K;continue}if(F.SIGN.test(K)){if(ue===""){ue+=K;continue}ue.length===1&&F.SIGN.test(ue)&&me(K,Fe,ge)}}F.WHITESPACE.test(K)?(W(),he=J,fe=!1):F.COMMA.test(K)?(W(),he=J,fe=!0):F.SIGN.test(K)?(W(),he=se,ae=K):F.POINT.test(K)?(W(),he=q,ae=K):me(K,Fe,ge)}return W(),ge}const y=["mm","cm","in","pt","pc","px"],v={mm:{mm:1,cm:.1,in:1/25.4,pt:72/25.4,pc:6/25.4,px:-1},cm:{mm:10,cm:1,in:1/2.54,pt:72/2.54,pc:6/2.54,px:-1},in:{mm:25.4,cm:2.54,in:1,pt:72,pc:6,px:-1},pt:{mm:25.4/72,cm:2.54/72,in:1/72,pt:1,pc:6/72,px:-1},pc:{mm:25.4/6,cm:2.54/6,in:1/6,pt:72/6,pc:1,px:-1},px:{px:1}};function E(M){let k="px";if(typeof M=="string"||M instanceof String)for(let F=0,J=y.length;F<J;F++){const se=y[F];if(M.endsWith(se)){k=se,M=M.substring(0,M.length-se.length);break}}let P;return k==="px"&&t.defaultUnit!=="px"?P=v.in[t.defaultUnit]/t.defaultDPI:(P=v[k][t.defaultUnit],P<0&&(P=v[k].in*t.defaultDPI)),P*parseFloat(M)}function C(M){if(!(M.hasAttribute("transform")||M.nodeName==="use"&&(M.hasAttribute("x")||M.hasAttribute("y"))))return null;const k=x(M);return O.length>0&&k.premultiply(O[O.length-1]),V.copy(k),O.push(k),k}function x(M){const k=new Ci,P=U;if(M.nodeName==="use"&&(M.hasAttribute("x")||M.hasAttribute("y"))){const F=E(M.getAttribute("x")),J=E(M.getAttribute("y"));k.translate(F,J)}if(M.hasAttribute("transform")){const F=M.getAttribute("transform").split(")");for(let J=F.length-1;J>=0;J--){const se=F[J].trim();if(se==="")continue;const q=se.indexOf("("),re=se.length;if(q>0&&q<re){const he=se.slice(0,q),fe=g(se.slice(q+1));switch(P.identity(),he){case"translate":if(fe.length>=1){const ae=fe[0];let ue=0;fe.length>=2&&(ue=fe[1]),P.translate(ae,ue)}break;case"rotate":if(fe.length>=1){let ae=0,ue=0,ge=0;ae=fe[0]*Math.PI/180,fe.length>=3&&(ue=fe[1],ge=fe[2]),Q.makeTranslation(-ue,-ge),G.makeRotation(ae),z.multiplyMatrices(G,Q),Q.makeTranslation(ue,ge),P.multiplyMatrices(Q,z)}break;case"scale":if(fe.length>=1){const ae=fe[0];let ue=ae;fe.length>=2&&(ue=fe[1]),P.scale(ae,ue)}break;case"skewX":fe.length===1&&P.set(1,Math.tan(fe[0]*Math.PI/180),0,0,1,0,0,0,1);break;case"skewY":fe.length===1&&P.set(1,0,0,Math.tan(fe[0]*Math.PI/180),1,0,0,0,1);break;case"matrix":fe.length===6&&P.set(fe[0],fe[2],fe[4],fe[1],fe[3],fe[5],0,0,1);break}}k.premultiply(P)}}return k}function I(M,k){function P(q){N.set(q.x,q.y,1).applyMatrix3(k),q.set(N.x,N.y)}function F(q){const re=q.xRadius,he=q.yRadius,fe=Math.cos(q.aRotation),ae=Math.sin(q.aRotation),ue=new b(re*fe,re*ae,0),ge=new b(-he*ae,he*fe,0),me=ue.applyMatrix3(k),W=ge.applyMatrix3(k),K=U.set(me.x,W.x,0,me.y,W.y,0,0,0,1),pe=Q.copy(K).invert(),be=G.copy(pe).transpose().multiply(pe).elements,De=R(be[0],be[1],be[4]),Ne=Math.sqrt(De.rt1),ot=Math.sqrt(De.rt2);if(q.xRadius=1/Ne,q.yRadius=1/ot,q.aRotation=Math.atan2(De.sn,De.cs),!((q.aEndAngle-q.aStartAngle)%(2*Math.PI)<Number.EPSILON)){const Ht=Q.set(Ne,0,0,0,ot,0,0,0,1),Kt=G.set(De.cs,De.sn,0,-De.sn,De.cs,0,0,0,1),Qt=Ht.multiply(Kt).multiply(K),hi=ni=>{const{x:Ks,y:gn}=new b(Math.cos(ni),Math.sin(ni),0).applyMatrix3(Qt);return Math.atan2(gn,Ks)};q.aStartAngle=hi(q.aStartAngle),q.aEndAngle=hi(q.aEndAngle),S(k)&&(q.aClockwise=!q.aClockwise)}}function J(q){const re=B(k),he=T(k);q.xRadius*=re,q.yRadius*=he;const fe=re>Number.EPSILON?Math.atan2(k.elements[1],k.elements[0]):Math.atan2(-k.elements[3],k.elements[4]);q.aRotation+=fe,S(k)&&(q.aStartAngle*=-1,q.aEndAngle*=-1,q.aClockwise=!q.aClockwise)}const se=M.subPaths;for(let q=0,re=se.length;q<re;q++){const fe=se[q].curves;for(let ae=0;ae<fe.length;ae++){const ue=fe[ae];ue.isLineCurve?(P(ue.v1),P(ue.v2)):ue.isCubicBezierCurve?(P(ue.v0),P(ue.v1),P(ue.v2),P(ue.v3)):ue.isQuadraticBezierCurve?(P(ue.v0),P(ue.v1),P(ue.v2)):ue.isEllipseCurve&&(H.set(ue.aX,ue.aY),P(H),ue.aX=H.x,ue.aY=H.y,w(k)?F(ue):J(ue))}}}function S(M){const k=M.elements;return k[0]*k[4]-k[1]*k[3]<0}function w(M){const k=M.elements,P=k[0]*k[3]+k[1]*k[4];if(P===0)return!1;const F=B(M),J=T(M);return Math.abs(P/(F*J))>Number.EPSILON}function B(M){const k=M.elements;return Math.sqrt(k[0]*k[0]+k[1]*k[1])}function T(M){const k=M.elements;return Math.sqrt(k[3]*k[3]+k[4]*k[4])}function R(M,k,P){let F,J,se,q,re;const he=M+P,fe=M-P,ae=Math.sqrt(fe*fe+4*k*k);return he>0?(F=.5*(he+ae),re=1/F,J=M*re*P-k*re*k):he<0?J=.5*(he-ae):(F=.5*ae,J=-.5*ae),fe>0?se=fe+ae:se=fe-ae,Math.abs(se)>2*Math.abs(k)?(re=-2*k/se,q=1/Math.sqrt(1+re*re),se=re*q):Math.abs(k)===0?(se=1,q=0):(re=-.5*se/k,se=1/Math.sqrt(1+re*re),q=re*se),fe>0&&(re=se,se=-q,q=re),{rt1:F,rt2:J,cs:se,sn:q}}const _=[],L={},O=[],U=new Ci,Q=new Ci,G=new Ci,z=new Ci,H=new de,N=new b,V=new Ci,$=new DOMParser().parseFromString(e,"image/svg+xml");return i($.documentElement,{fill:"#000",fillOpacity:1,strokeOpacity:1,strokeWidth:1,strokeLineJoin:"miter",strokeLineCap:"butt",strokeMiterLimit:4}),{paths:_,xml:$.documentElement}}static createShapes(e){const i={ORIGIN:0,DESTINATION:1,BETWEEN:2,LEFT:3,RIGHT:4,BEHIND:5,BEYOND:6},s={loc:i.ORIGIN,t:0};function r(m,g,y,v){const E=m.x,C=g.x,x=y.x,I=v.x,S=m.y,w=g.y,B=y.y,T=v.y,R=(I-x)*(S-B)-(T-B)*(E-x),_=(C-E)*(S-B)-(w-S)*(E-x),L=(T-B)*(C-E)-(I-x)*(w-S),O=R/L,U=_/L;if(L===0&&R!==0||O<=0||O>=1||U<0||U>1)return null;if(R===0&&L===0){for(let Q=0;Q<2;Q++)if(o(Q===0?y:v,m,g),s.loc==i.ORIGIN){const G=Q===0?y:v;return{x:G.x,y:G.y,t:s.t}}else if(s.loc==i.BETWEEN){const G=+(E+s.t*(C-E)).toPrecision(10),z=+(S+s.t*(w-S)).toPrecision(10);return{x:G,y:z,t:s.t}}return null}else{for(let z=0;z<2;z++)if(o(z===0?y:v,m,g),s.loc==i.ORIGIN){const H=z===0?y:v;return{x:H.x,y:H.y,t:s.t}}const Q=+(E+O*(C-E)).toPrecision(10),G=+(S+O*(w-S)).toPrecision(10);return{x:Q,y:G,t:O}}}function o(m,g,y){const v=y.x-g.x,E=y.y-g.y,C=m.x-g.x,x=m.y-g.y,I=v*x-C*E;if(m.x===g.x&&m.y===g.y){s.loc=i.ORIGIN,s.t=0;return}if(m.x===y.x&&m.y===y.y){s.loc=i.DESTINATION,s.t=1;return}if(I<-Number.EPSILON){s.loc=i.LEFT;return}if(I>Number.EPSILON){s.loc=i.RIGHT;return}if(v*C<0||E*x<0){s.loc=i.BEHIND;return}if(Math.sqrt(v*v+E*E)<Math.sqrt(C*C+x*x)){s.loc=i.BEYOND;return}let S;v!==0?S=C/v:S=x/E,s.loc=i.BETWEEN,s.t=S}function a(m,g){const y=[],v=[];for(let E=1;E<m.length;E++){const C=m[E-1],x=m[E];for(let I=1;I<g.length;I++){const S=g[I-1],w=g[I],B=r(C,x,S,w);B!==null&&y.find(T=>T.t<=B.t+Number.EPSILON&&T.t>=B.t-Number.EPSILON)===void 0&&(y.push(B),v.push(new de(B.x,B.y)))}}return v}function c(m,g,y){const v=new de;g.getCenter(v);const E=[];return y.forEach(C=>{C.boundingBox.containsPoint(v)&&a(m,C.points).forEach(I=>{E.push({identifier:C.identifier,isCW:C.isCW,point:I})})}),E.sort((C,x)=>C.point.x-x.point.x),E}function l(m,g,y,v,E){(E==null||E==="")&&(E="nonzero");const C=new de;m.boundingBox.getCenter(C);const x=[new de(y,C.y),new de(v,C.y)],I=c(x,m.boundingBox,g);I.sort((_,L)=>_.point.x-L.point.x);const S=[],w=[];I.forEach(_=>{_.identifier===m.identifier?S.push(_):w.push(_)});const B=S[0].point.x,T=[];let R=0;for(;R<w.length&&w[R].point.x<B;)T.length>0&&T[T.length-1]===w[R].identifier?T.pop():T.push(w[R].identifier),R++;if(T.push(m.identifier),E==="evenodd"){const _=T.length%2===0,L=T[T.length-2];return{identifier:m.identifier,isHole:_,for:L}}else if(E==="nonzero"){let _=!0,L=null,O=null;for(let U=0;U<T.length;U++){const Q=T[U];_?(O=g[Q].isCW,_=!1,L=Q):O!==g[Q].isCW&&(O=g[Q].isCW,_=!0)}return{identifier:m.identifier,isHole:_,for:L}}else console.warn('fill-rule: "'+E+'" is currently not implemented.')}let u=999999999,h=-999999999,f=e.subPaths.map(m=>{const g=m.getPoints();let y=-999999999,v=999999999,E=-999999999,C=999999999;for(let x=0;x<g.length;x++){const I=g[x];I.y>y&&(y=I.y),I.y<v&&(v=I.y),I.x>E&&(E=I.x),I.x<C&&(C=I.x)}return h<=E&&(h=E+1),u>=C&&(u=C-1),{curves:m.curves,points:g,isCW:Ry.isClockWise(g),identifier:-1,boundingBox:new Dy(new de(C,v),new de(E,y))}});f=f.filter(m=>m.points.length>1);for(let m=0;m<f.length;m++)f[m].identifier=m;const d=f.map(m=>l(m,f,u,h,e.userData?e.userData.style.fillRule:void 0)),p=[];return f.forEach(m=>{if(!d[m.identifier].isHole){const y=new o1;y.curves=m.curves,d.filter(E=>E.isHole&&E.for===m.identifier).forEach(E=>{const C=f[E.identifier],x=new el;x.curves=C.curves,y.holes.push(x)}),p.push(y)}}),p}static getStrokeStyle(e,t,i,s,r){return e=e!==void 0?e:1,t=t!==void 0?t:"#000",i=i!==void 0?i:"miter",s=s!==void 0?s:"butt",r=r!==void 0?r:4,{strokeColor:t,strokeWidth:e,strokeLineJoin:i,strokeLineCap:s,strokeMiterLimit:r}}static pointsToStroke(e,t,i,s){const r=[],o=[],a=[];if(Io.pointsToStrokeWithBuffers(e,t,i,s,r,o,a)===0)return null;const c=new St;return c.setAttribute("position",new Rt(r,3)),c.setAttribute("normal",new Rt(o,3)),c.setAttribute("uv",new Rt(a,2)),c}static pointsToStrokeWithBuffers(e,t,i,s,r,o,a,c){const l=new de,u=new de,h=new de,f=new de,d=new de,p=new de,m=new de,g=new de,y=new de,v=new de,E=new de,C=new de,x=new de,I=new de,S=new de,w=new de,B=new de;i=i!==void 0?i:12,s=s!==void 0?s:.001,c=c!==void 0?c:0,e=fe(e);const T=e.length;if(T<2)return 0;const R=e[0].equals(e[T-1]);let _,L=e[0],O;const U=t.strokeWidth/2,Q=1/(T-1);let G=0,z,H,N,V,$=!1,Y=0,M=c*3,k=c*2;P(e[0],e[1],l).multiplyScalar(U),g.copy(e[0]).sub(l),y.copy(e[0]).add(l),v.copy(g),E.copy(y);for(let ae=1;ae<T;ae++){_=e[ae],ae===T-1?R?O=e[1]:O=void 0:O=e[ae+1];const ue=l;if(P(L,_,ue),h.copy(ue).multiplyScalar(U),C.copy(_).sub(h),x.copy(_).add(h),z=G+Q,H=!1,O!==void 0){P(_,O,u),h.copy(u).multiplyScalar(U),I.copy(_).sub(h),S.copy(_).add(h),N=!0,h.subVectors(O,L),ue.dot(h)<0&&(N=!1),ae===1&&($=N),h.subVectors(O,_),h.normalize();const ge=Math.abs(ue.dot(h));if(ge>Number.EPSILON){const me=U/ge;h.multiplyScalar(-me),f.subVectors(_,L),d.copy(f).setLength(me).add(h),w.copy(d).negate();const W=d.length(),K=f.length();f.divideScalar(K),p.subVectors(O,_);const pe=p.length();switch(p.divideScalar(pe),f.dot(w)<K&&p.dot(w)<pe&&(H=!0),B.copy(d).add(_),w.add(_),V=!1,H?N?(S.copy(w),x.copy(w)):(I.copy(w),C.copy(w)):se(),t.strokeLineJoin){case"bevel":q(N,H,z);break;case"round":re(N,H),N?J(_,C,I,z,0):J(_,S,x,z,1);break;case"miter":case"miter-clip":default:const Fe=U*t.strokeMiterLimit/W;if(Fe<1)if(t.strokeLineJoin!=="miter-clip"){q(N,H,z);break}else re(N,H),N?(p.subVectors(B,C).multiplyScalar(Fe).add(C),m.subVectors(B,I).multiplyScalar(Fe).add(I),F(C,z,0),F(p,z,0),F(_,z,.5),F(_,z,.5),F(p,z,0),F(m,z,0),F(_,z,.5),F(m,z,0),F(I,z,0)):(p.subVectors(B,x).multiplyScalar(Fe).add(x),m.subVectors(B,S).multiplyScalar(Fe).add(S),F(x,z,1),F(p,z,1),F(_,z,.5),F(_,z,.5),F(p,z,1),F(m,z,1),F(_,z,.5),F(m,z,1),F(S,z,1));else H?(N?(F(y,G,1),F(g,G,0),F(B,z,0),F(y,G,1),F(B,z,0),F(w,z,1)):(F(y,G,1),F(g,G,0),F(B,z,1),F(g,G,0),F(w,z,0),F(B,z,1)),N?I.copy(B):S.copy(B)):N?(F(C,z,0),F(B,z,0),F(_,z,.5),F(_,z,.5),F(B,z,0),F(I,z,0)):(F(x,z,1),F(B,z,1),F(_,z,.5),F(_,z,.5),F(B,z,1),F(S,z,1)),V=!0;break}}else se()}else se();!R&&ae===T-1&&he(e[0],v,E,N,!0,G),G=z,L=_,g.copy(I),y.copy(S)}if(!R)he(_,C,x,N,!1,z);else if(H&&r){let ae=B,ue=w;$!==N&&(ae=w,ue=B),N?(V||$)&&(ue.toArray(r,0*3),ue.toArray(r,3*3),V&&ae.toArray(r,1*3)):(V||!$)&&(ue.toArray(r,1*3),ue.toArray(r,3*3),V&&ae.toArray(r,0*3))}return Y;function P(ae,ue,ge){return ge.subVectors(ue,ae),ge.set(-ge.y,ge.x).normalize()}function F(ae,ue,ge){r&&(r[M]=ae.x,r[M+1]=ae.y,r[M+2]=0,o&&(o[M]=0,o[M+1]=0,o[M+2]=1),M+=3,a&&(a[k]=ue,a[k+1]=ge,k+=2)),Y+=3}function J(ae,ue,ge,me,W){l.copy(ue).sub(ae).normalize(),u.copy(ge).sub(ae).normalize();let K=Math.PI;const pe=l.dot(u);Math.abs(pe)<1&&(K=Math.abs(Math.acos(pe))),K/=i,h.copy(ue);for(let Fe=0,Se=i-1;Fe<Se;Fe++)f.copy(h).rotateAround(ae,K),F(h,me,W),F(f,me,W),F(ae,me,.5),h.copy(f);F(f,me,W),F(ge,me,W),F(ae,me,.5)}function se(){F(y,G,1),F(g,G,0),F(C,z,0),F(y,G,1),F(C,z,0),F(x,z,1)}function q(ae,ue,ge){ue?ae?(F(y,G,1),F(g,G,0),F(C,z,0),F(y,G,1),F(C,z,0),F(w,z,1),F(C,ge,0),F(I,ge,0),F(w,ge,.5)):(F(y,G,1),F(g,G,0),F(x,z,1),F(g,G,0),F(w,z,0),F(x,z,1),F(x,ge,1),F(w,ge,0),F(S,ge,1)):ae?(F(C,ge,0),F(I,ge,0),F(_,ge,.5)):(F(x,ge,1),F(S,ge,0),F(_,ge,.5))}function re(ae,ue){ue&&(ae?(F(y,G,1),F(g,G,0),F(C,z,0),F(y,G,1),F(C,z,0),F(w,z,1),F(C,G,0),F(_,z,.5),F(w,z,1),F(_,z,.5),F(I,G,0),F(w,z,1)):(F(y,G,1),F(g,G,0),F(x,z,1),F(g,G,0),F(w,z,0),F(x,z,1),F(x,G,1),F(w,z,0),F(_,z,.5),F(_,z,.5),F(w,z,0),F(S,G,1)))}function he(ae,ue,ge,me,W,K){switch(t.strokeLineCap){case"round":W?J(ae,ge,ue,K,.5):J(ae,ue,ge,K,.5);break;case"square":if(W)l.subVectors(ue,ae),u.set(l.y,-l.x),h.addVectors(l,u).add(ae),f.subVectors(u,l).add(ae),me?(h.toArray(r,1*3),f.toArray(r,0*3),f.toArray(r,3*3)):(h.toArray(r,1*3),a[3*2+1]===1?f.toArray(r,3*3):h.toArray(r,3*3),f.toArray(r,0*3));else{l.subVectors(ge,ae),u.set(l.y,-l.x),h.addVectors(l,u).add(ae),f.subVectors(u,l).add(ae);const pe=r.length;me?(h.toArray(r,pe-1*3),f.toArray(r,pe-2*3),f.toArray(r,pe-4*3)):(f.toArray(r,pe-2*3),h.toArray(r,pe-1*3),f.toArray(r,pe-4*3))}break}}function fe(ae){let ue=!1;for(let me=1,W=ae.length-1;me<W;me++)if(ae[me].distanceTo(ae[me+1])<s){ue=!0;break}if(!ue)return ae;const ge=[];ge.push(ae[0]);for(let me=1,W=ae.length-1;me<W;me++)ae[me].distanceTo(ae[me+1])>=s&&ge.push(ae[me]);return ge.push(ae[ae.length-1]),ge}}}const Il=new WeakMap;class pC extends fn{constructor(e){super(e),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(e){return this.decoderPath=e,this}setDecoderConfig(e){return this.decoderConfig=e,this}setWorkerLimit(e){return this.workerLimit=e,this}load(e,t,i,s){const r=new ss(this.manager);r.setPath(this.path),r.setResponseType("arraybuffer"),r.setRequestHeader(this.requestHeader),r.setWithCredentials(this.withCredentials),r.load(e,o=>{const a={attributeIDs:this.defaultAttributeIDs,attributeTypes:this.defaultAttributeTypes,useUniqueIDs:!1};this.decodeGeometry(o,a).then(t).catch(s)},i,s)}decodeDracoFile(e,t,i,s){const r={attributeIDs:i||this.defaultAttributeIDs,attributeTypes:s||this.defaultAttributeTypes,useUniqueIDs:!!i};this.decodeGeometry(e,r).then(t)}decodeGeometry(e,t){for(const c in t.attributeTypes){const l=t.attributeTypes[c];l.BYTES_PER_ELEMENT!==void 0&&(t.attributeTypes[c]=l.name)}const i=JSON.stringify(t);if(Il.has(e)){const c=Il.get(e);if(c.key===i)return c.promise;if(e.byteLength===0)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let s;const r=this.workerNextTaskID++,o=e.byteLength,a=this._getWorker(r,o).then(c=>(s=c,new Promise((l,u)=>{s._callbacks[r]={resolve:l,reject:u},s.postMessage({type:"decode",id:r,taskConfig:t,buffer:e},[e])}))).then(c=>this._createGeometry(c.geometry));return a.catch(()=>!0).then(()=>{s&&r&&this._releaseTask(s,r)}),Il.set(e,{key:i,promise:a}),a}_createGeometry(e){const t=new St;e.index&&t.setIndex(new Ye(e.index.array,1));for(let i=0;i<e.attributes.length;i++){const s=e.attributes[i],r=s.name,o=s.array,a=s.itemSize;t.setAttribute(r,new Ye(o,a))}return t}_loadLibrary(e,t){const i=new ss(this.manager);return i.setPath(this.decoderPath),i.setResponseType(t),i.setWithCredentials(this.withCredentials),new Promise((s,r)=>{i.load(e,s,void 0,r)})}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const e=typeof WebAssembly!="object"||this.decoderConfig.type==="js",t=[];return e?t.push(this._loadLibrary("draco_decoder.js","text")):(t.push(this._loadLibrary("draco_wasm_wrapper.js","text")),t.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(t).then(i=>{const s=i[0];e||(this.decoderConfig.wasmBinary=i[1]);const r=gC.toString(),o=["/* draco decoder */",s,"","/* worker */",r.substring(r.indexOf("{")+1,r.lastIndexOf("}"))].join(`
`);this.workerSourceURL=URL.createObjectURL(new Blob([o]))}),this.decoderPending}_getWorker(e,t){return this._initDecoder().then(()=>{if(this.workerPool.length<this.workerLimit){const s=new Worker(this.workerSourceURL);s._callbacks={},s._taskCosts={},s._taskLoad=0,s.postMessage({type:"init",decoderConfig:this.decoderConfig}),s.onmessage=function(r){const o=r.data;switch(o.type){case"decode":s._callbacks[o.id].resolve(o);break;case"error":s._callbacks[o.id].reject(o);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+o.type+'"')}},this.workerPool.push(s)}else this.workerPool.sort(function(s,r){return s._taskLoad>r._taskLoad?-1:1});const i=this.workerPool[this.workerPool.length-1];return i._taskCosts[e]=t,i._taskLoad+=t,i})}_releaseTask(e,t){e._taskLoad-=e._taskCosts[t],delete e._callbacks[t],delete e._taskCosts[t]}debug(){console.log("Task load: ",this.workerPool.map(e=>e._taskLoad))}dispose(){for(let e=0;e<this.workerPool.length;++e)this.workerPool[e].terminate();return this.workerPool.length=0,this}}function gC(){let n,e;onmessage=function(o){const a=o.data;switch(a.type){case"init":n=a.decoderConfig,e=new Promise(function(u){n.onModuleLoaded=function(h){u({draco:h})},DracoDecoderModule(n)});break;case"decode":const c=a.buffer,l=a.taskConfig;e.then(u=>{const h=u.draco,f=new h.Decoder,d=new h.DecoderBuffer;d.Init(new Int8Array(c),c.byteLength);try{const p=t(h,f,d,l),m=p.attributes.map(g=>g.array.buffer);p.index&&m.push(p.index.array.buffer),self.postMessage({type:"decode",id:a.id,geometry:p},m)}catch(p){console.error(p),self.postMessage({type:"error",id:a.id,error:p.message})}finally{h.destroy(d),h.destroy(f)}});break}};function t(o,a,c,l){const u=l.attributeIDs,h=l.attributeTypes;let f,d;const p=a.GetEncodedGeometryType(c);if(p===o.TRIANGULAR_MESH)f=new o.Mesh,d=a.DecodeBufferToMesh(c,f);else if(p===o.POINT_CLOUD)f=new o.PointCloud,d=a.DecodeBufferToPointCloud(c,f);else throw new Error("THREE.DRACOLoader: Unexpected geometry type.");if(!d.ok()||f.ptr===0)throw new Error("THREE.DRACOLoader: Decoding failed: "+d.error_msg());const m={index:null,attributes:[]};for(const g in u){const y=self[h[g]];let v,E;if(l.useUniqueIDs)E=u[g],v=a.GetAttributeByUniqueId(f,E);else{if(E=a.GetAttributeId(f,o[u[g]]),E===-1)continue;v=a.GetAttribute(f,E)}m.attributes.push(s(o,a,f,g,y,v))}return p===o.TRIANGULAR_MESH&&(m.index=i(o,a,f)),o.destroy(f),m}function i(o,a,c){const u=c.num_faces()*3,h=u*4,f=o._malloc(h);a.GetTrianglesUInt32Array(c,h,f);const d=new Uint32Array(o.HEAPF32.buffer,f,u).slice();return o._free(f),{array:d,itemSize:1}}function s(o,a,c,l,u,h){const f=h.num_components(),p=c.num_points()*f,m=p*u.BYTES_PER_ELEMENT,g=r(o,u),y=o._malloc(m);a.GetAttributeDataArrayForAllPoints(c,h,g,m,y);const v=new u(o.HEAPF32.buffer,y,p).slice();return o._free(y),{name:l,array:v,itemSize:f}}function r(o,a){switch(a){case Float32Array:return o.DT_FLOAT32;case Int8Array:return o.DT_INT8;case Int16Array:return o.DT_INT16;case Int32Array:return o.DT_INT32;case Uint8Array:return o.DT_UINT8;case Uint16Array:return o.DT_UINT16;case Uint32Array:return o.DT_UINT32}}}const qd=new st,ea=new b;class Oc extends a1{constructor(){super(),this.isLineSegmentsGeometry=!0,this.type="LineSegmentsGeometry";const e=[-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],t=[-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],i=[0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5];this.setIndex(i),this.setAttribute("position",new Rt(e,3)),this.setAttribute("uv",new Rt(t,2))}applyMatrix4(e){const t=this.attributes.instanceStart,i=this.attributes.instanceEnd;return t!==void 0&&(t.applyMatrix4(e),i.applyMatrix4(e),t.needsUpdate=!0),this.boundingBox!==null&&this.computeBoundingBox(),this.boundingSphere!==null&&this.computeBoundingSphere(),this}setPositions(e){let t;e instanceof Float32Array?t=e:Array.isArray(e)&&(t=new Float32Array(e));const i=new Vu(t,6,1);return this.setAttribute("instanceStart",new tn(i,3,0)),this.setAttribute("instanceEnd",new tn(i,3,3)),this.computeBoundingBox(),this.computeBoundingSphere(),this}setColors(e,t=3){let i;e instanceof Float32Array?i=e:Array.isArray(e)&&(i=new Float32Array(e));const s=new Vu(i,t*2,1);return this.setAttribute("instanceColorStart",new tn(s,t,0)),this.setAttribute("instanceColorEnd",new tn(s,t,t)),this}fromWireframeGeometry(e){return this.setPositions(e.attributes.position.array),this}fromEdgesGeometry(e){return this.setPositions(e.attributes.position.array),this}fromMesh(e){return this.fromWireframeGeometry(new My(e.geometry)),this}fromLineSegments(e){const t=e.geometry;return this.setPositions(t.attributes.position.array),this}computeBoundingBox(){this.boundingBox===null&&(this.boundingBox=new st);const e=this.attributes.instanceStart,t=this.attributes.instanceEnd;e!==void 0&&t!==void 0&&(this.boundingBox.setFromBufferAttribute(e),qd.setFromBufferAttribute(t),this.boundingBox.union(qd))}computeBoundingSphere(){this.boundingSphere===null&&(this.boundingSphere=new si),this.boundingBox===null&&this.computeBoundingBox();const e=this.attributes.instanceStart,t=this.attributes.instanceEnd;if(e!==void 0&&t!==void 0){const i=this.boundingSphere.center;this.boundingBox.getCenter(i);let s=0;for(let r=0,o=e.count;r<o;r++)ea.fromBufferAttribute(e,r),s=Math.max(s,i.distanceToSquared(ea)),ea.fromBufferAttribute(t,r),s=Math.max(s,i.distanceToSquared(ea));this.boundingSphere.radius=Math.sqrt(s),isNaN(this.boundingSphere.radius)&&console.error("THREE.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}toJSON(){}applyMatrix(e){return console.warn("THREE.LineSegmentsGeometry: applyMatrix() has been renamed to applyMatrix4()."),this.applyMatrix4(e)}}class xp extends Oc{constructor(){super(),this.isLineGeometry=!0,this.type="LineGeometry"}setPositions(e){const t=e.length-3,i=new Float32Array(2*t);for(let s=0;s<t;s+=3)i[2*s]=e[s],i[2*s+1]=e[s+1],i[2*s+2]=e[s+2],i[2*s+3]=e[s+3],i[2*s+4]=e[s+4],i[2*s+5]=e[s+5];return super.setPositions(i),this}setColors(e,t=3){const i=e.length-t,s=new Float32Array(2*i);if(t===3)for(let r=0;r<i;r+=t)s[2*r]=e[r],s[2*r+1]=e[r+1],s[2*r+2]=e[r+2],s[2*r+3]=e[r+3],s[2*r+4]=e[r+4],s[2*r+5]=e[r+5];else for(let r=0;r<i;r+=t)s[2*r]=e[r],s[2*r+1]=e[r+1],s[2*r+2]=e[r+2],s[2*r+3]=e[r+3],s[2*r+4]=e[r+4],s[2*r+5]=e[r+5],s[2*r+6]=e[r+6],s[2*r+7]=e[r+7];return super.setColors(s,t),this}fromLine(e){const t=e.geometry;return this.setPositions(t.attributes.position.array),this}}class Uc extends Dt{constructor(e){super({type:"LineMaterial",uniforms:_o.clone(_o.merge([Yu.common,Yu.fog,{worldUnits:{value:1},linewidth:{value:1},resolution:{value:new de(1,1)},dashOffset:{value:0},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}}])),vertexShader:`
				#include <common>
				#include <fog_pars_vertex>
				#include <logdepthbuf_pars_vertex>
				#include <clipping_planes_pars_vertex>

				uniform float linewidth;
				uniform vec2 resolution;

				attribute vec3 instanceStart;
				attribute vec3 instanceEnd;

				#ifdef USE_COLOR
					#ifdef USE_LINE_COLOR_ALPHA
						varying vec4 vLineColor;
						attribute vec4 instanceColorStart;
						attribute vec4 instanceColorEnd;
					#else
						varying vec3 vLineColor;
						attribute vec3 instanceColorStart;
						attribute vec3 instanceColorEnd;
					#endif
				#endif

				#ifdef WORLD_UNITS

					varying vec4 worldPos;
					varying vec3 worldStart;
					varying vec3 worldEnd;

					#ifdef USE_DASH

						varying vec2 vUv;

					#endif

				#else

					varying vec2 vUv;

				#endif

				#ifdef USE_DASH

					uniform float dashScale;
					attribute float instanceDistanceStart;
					attribute float instanceDistanceEnd;
					varying float vLineDistance;

				#endif

				void trimSegment( const in vec4 start, inout vec4 end ) {

					// trim end segment so it terminates between the camera plane and the near plane

					// conservative estimate of the near plane
					float a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column
					float b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column
					float nearEstimate = - 0.5 * b / a;

					float alpha = ( nearEstimate - start.z ) / ( end.z - start.z );

					end.xyz = mix( start.xyz, end.xyz, alpha );

				}

				void main() {

					#ifdef USE_COLOR

						vLineColor = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;

					#endif

					#ifdef USE_DASH

						vLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;
						vUv = uv;

					#endif

					float aspect = resolution.x / resolution.y;

					// camera space
					vec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );
					vec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );

					#ifdef WORLD_UNITS

						worldStart = start.xyz;
						worldEnd = end.xyz;

					#else

						vUv = uv;

					#endif

					// special case for perspective projection, and segments that terminate either in, or behind, the camera plane
					// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space
					// but we need to perform ndc-space calculations in the shader, so we must address this issue directly
					// perhaps there is a more elegant solution -- WestLangley

					bool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column

					if ( perspective ) {

						if ( start.z < 0.0 && end.z >= 0.0 ) {

							trimSegment( start, end );

						} else if ( end.z < 0.0 && start.z >= 0.0 ) {

							trimSegment( end, start );

						}

					}

					// clip space
					vec4 clipStart = projectionMatrix * start;
					vec4 clipEnd = projectionMatrix * end;

					// ndc space
					vec3 ndcStart = clipStart.xyz / clipStart.w;
					vec3 ndcEnd = clipEnd.xyz / clipEnd.w;

					// direction
					vec2 dir = ndcEnd.xy - ndcStart.xy;

					// account for clip-space aspect ratio
					dir.x *= aspect;
					dir = normalize( dir );

					#ifdef WORLD_UNITS

						// get the offset direction as perpendicular to the view vector
						vec3 worldDir = normalize( end.xyz - start.xyz );
						vec3 offset;
						if ( position.y < 0.5 ) {

							offset = normalize( cross( start.xyz, worldDir ) );

						} else {

							offset = normalize( cross( end.xyz, worldDir ) );

						}

						// sign flip
						if ( position.x < 0.0 ) offset *= - 1.0;

						float forwardOffset = dot( worldDir, vec3( 0.0, 0.0, 1.0 ) );

						// don't extend the line if we're rendering dashes because we
						// won't be rendering the endcaps
						#ifndef USE_DASH

							// extend the line bounds to encompass  endcaps
							start.xyz += - worldDir * linewidth * 0.5;
							end.xyz += worldDir * linewidth * 0.5;

							// shift the position of the quad so it hugs the forward edge of the line
							offset.xy -= dir * forwardOffset;
							offset.z += 0.5;

						#endif

						// endcaps
						if ( position.y > 1.0 || position.y < 0.0 ) {

							offset.xy += dir * 2.0 * forwardOffset;

						}

						// adjust for linewidth
						offset *= linewidth * 0.5;

						// set the world position
						worldPos = ( position.y < 0.5 ) ? start : end;
						worldPos.xyz += offset;

						// project the worldpos
						vec4 clip = projectionMatrix * worldPos;

						// shift the depth of the projected points so the line
						// segments overlap neatly
						vec3 clipPose = ( position.y < 0.5 ) ? ndcStart : ndcEnd;
						clip.z = clipPose.z * clip.w;

					#else

						vec2 offset = vec2( dir.y, - dir.x );
						// undo aspect ratio adjustment
						dir.x /= aspect;
						offset.x /= aspect;

						// sign flip
						if ( position.x < 0.0 ) offset *= - 1.0;

						// endcaps
						if ( position.y < 0.0 ) {

							offset += - dir;

						} else if ( position.y > 1.0 ) {

							offset += dir;

						}

						// adjust for linewidth
						offset *= linewidth;

						// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...
						offset /= resolution.y;

						// select end
						vec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;

						// back to clip space
						offset *= clip.w;

						clip.xy += offset;

					#endif

					gl_Position = clip;

					vec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation

					#include <logdepthbuf_vertex>
					#include <clipping_planes_vertex>
					#include <fog_vertex>

				}
			`,fragmentShader:`
				uniform vec3 diffuse;
				uniform float opacity;
				uniform float linewidth;

				#ifdef USE_DASH

					uniform float dashOffset;
					uniform float dashSize;
					uniform float gapSize;

				#endif

				varying float vLineDistance;

				#ifdef WORLD_UNITS

					varying vec4 worldPos;
					varying vec3 worldStart;
					varying vec3 worldEnd;

					#ifdef USE_DASH

						varying vec2 vUv;

					#endif

				#else

					varying vec2 vUv;

				#endif

				#include <common>
				#include <fog_pars_fragment>
				#include <logdepthbuf_pars_fragment>
				#include <clipping_planes_pars_fragment>

				#ifdef USE_COLOR
					#ifdef USE_LINE_COLOR_ALPHA
						varying vec4 vLineColor;
					#else
						varying vec3 vLineColor;
					#endif
				#endif

				vec2 closestLineToLine(vec3 p1, vec3 p2, vec3 p3, vec3 p4) {

					float mua;
					float mub;

					vec3 p13 = p1 - p3;
					vec3 p43 = p4 - p3;

					vec3 p21 = p2 - p1;

					float d1343 = dot( p13, p43 );
					float d4321 = dot( p43, p21 );
					float d1321 = dot( p13, p21 );
					float d4343 = dot( p43, p43 );
					float d2121 = dot( p21, p21 );

					float denom = d2121 * d4343 - d4321 * d4321;

					float numer = d1343 * d4321 - d1321 * d4343;

					mua = numer / denom;
					mua = clamp( mua, 0.0, 1.0 );
					mub = ( d1343 + d4321 * ( mua ) ) / d4343;
					mub = clamp( mub, 0.0, 1.0 );

					return vec2( mua, mub );

				}

				void main() {

					#include <clipping_planes_fragment>

					#ifdef USE_DASH

						if ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps

						if ( mod( vLineDistance + dashOffset, dashSize + gapSize ) > dashSize ) discard; // todo - FIX

					#endif

					float alpha = opacity;

					#ifdef WORLD_UNITS

						// Find the closest points on the view ray and the line segment
						vec3 rayEnd = normalize( worldPos.xyz ) * 1e5;
						vec3 lineDir = worldEnd - worldStart;
						vec2 params = closestLineToLine( worldStart, worldEnd, vec3( 0.0, 0.0, 0.0 ), rayEnd );

						vec3 p1 = worldStart + lineDir * params.x;
						vec3 p2 = rayEnd * params.y;
						vec3 delta = p1 - p2;
						float len = length( delta );
						float norm = len / linewidth;

						#ifndef USE_DASH

							#ifdef USE_ALPHA_TO_COVERAGE

								float dnorm = fwidth( norm );
								alpha = 1.0 - smoothstep( 0.5 - dnorm, 0.5 + dnorm, norm );

							#else

								if ( norm > 0.5 ) {

									discard;

								}

							#endif

						#endif

					#else

						#ifdef USE_ALPHA_TO_COVERAGE

							// artifacts appear on some hardware if a derivative is taken within a conditional
							float a = vUv.x;
							float b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;
							float len2 = a * a + b * b;
							float dlen = fwidth( len2 );

							if ( abs( vUv.y ) > 1.0 ) {

								alpha = 1.0 - smoothstep( 1.0 - dlen, 1.0 + dlen, len2 );

							}

						#else

							if ( abs( vUv.y ) > 1.0 ) {

								float a = vUv.x;
								float b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;
								float len2 = a * a + b * b;

								if ( len2 > 1.0 ) discard;

							}

						#endif

					#endif

					vec4 diffuseColor = vec4( diffuse, alpha );
					#ifdef USE_COLOR
						#ifdef USE_LINE_COLOR_ALPHA
							diffuseColor *= vLineColor;
						#else
							diffuseColor.rgb *= vLineColor;
						#endif
					#endif

					#include <logdepthbuf_fragment>

					gl_FragColor = diffuseColor;

					#include <tonemapping_fragment>
					#include <${parseInt(xr.replace(/\D+/g,""))>=154?"colorspace_fragment":"encodings_fragment"}>
					#include <fog_fragment>
					#include <premultiplied_alpha_fragment>

				}
			`,clipping:!0}),this.isLineMaterial=!0,this.onBeforeCompile=function(){this.transparent?this.defines.USE_LINE_COLOR_ALPHA="1":delete this.defines.USE_LINE_COLOR_ALPHA},Object.defineProperties(this,{color:{enumerable:!0,get:function(){return this.uniforms.diffuse.value},set:function(t){this.uniforms.diffuse.value=t}},worldUnits:{enumerable:!0,get:function(){return"WORLD_UNITS"in this.defines},set:function(t){t===!0?this.defines.WORLD_UNITS="":delete this.defines.WORLD_UNITS}},linewidth:{enumerable:!0,get:function(){return this.uniforms.linewidth.value},set:function(t){this.uniforms.linewidth.value=t}},dashed:{enumerable:!0,get:function(){return"USE_DASH"in this.defines},set(t){!!t!="USE_DASH"in this.defines&&(this.needsUpdate=!0),t===!0?this.defines.USE_DASH="":delete this.defines.USE_DASH}},dashScale:{enumerable:!0,get:function(){return this.uniforms.dashScale.value},set:function(t){this.uniforms.dashScale.value=t}},dashSize:{enumerable:!0,get:function(){return this.uniforms.dashSize.value},set:function(t){this.uniforms.dashSize.value=t}},dashOffset:{enumerable:!0,get:function(){return this.uniforms.dashOffset.value},set:function(t){this.uniforms.dashOffset.value=t}},gapSize:{enumerable:!0,get:function(){return this.uniforms.gapSize.value},set:function(t){this.uniforms.gapSize.value=t}},opacity:{enumerable:!0,get:function(){return this.uniforms.opacity.value},set:function(t){this.uniforms.opacity.value=t}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(t){this.uniforms.resolution.value.copy(t)}},alphaToCoverage:{enumerable:!0,get:function(){return"USE_ALPHA_TO_COVERAGE"in this.defines},set:function(t){!!t!="USE_ALPHA_TO_COVERAGE"in this.defines&&(this.needsUpdate=!0),t===!0?(this.defines.USE_ALPHA_TO_COVERAGE="",this.extensions.derivatives=!0):(delete this.defines.USE_ALPHA_TO_COVERAGE,this.extensions.derivatives=!1)}}}),this.setValues(e)}}const Sl=new ft,Xd=new b,Zd=new b,Pt=new ft,Ft=new ft,zi=new ft,wl=new b,Tl=new ce,Ut=new ns,e0=new b,ta=new st,ia=new si,Hi=new ft;let Zi,on;function t0(n,e,t){return Hi.set(0,0,-e,1).applyMatrix4(n.projectionMatrix),Hi.multiplyScalar(1/Hi.w),Hi.x=on/t.width,Hi.y=on/t.height,Hi.applyMatrix4(n.projectionMatrixInverse),Hi.multiplyScalar(1/Hi.w),Math.abs(Math.max(Hi.x,Hi.y))}function yC(n,e){const t=n.matrixWorld,i=n.geometry,s=i.attributes.instanceStart,r=i.attributes.instanceEnd,o=Math.min(i.instanceCount,s.count);for(let a=0,c=o;a<c;a++){Ut.start.fromBufferAttribute(s,a),Ut.end.fromBufferAttribute(r,a),Ut.applyMatrix4(t);const l=new b,u=new b;Zi.distanceSqToSegment(Ut.start,Ut.end,u,l),u.distanceTo(l)<on*.5&&e.push({point:u,pointOnLine:l,distance:Zi.origin.distanceTo(u),object:n,face:null,faceIndex:a,uv:null,[Kh]:null})}}function EC(n,e,t){const i=e.projectionMatrix,r=n.material.resolution,o=n.matrixWorld,a=n.geometry,c=a.attributes.instanceStart,l=a.attributes.instanceEnd,u=Math.min(a.instanceCount,c.count),h=-e.near;Zi.at(1,zi),zi.w=1,zi.applyMatrix4(e.matrixWorldInverse),zi.applyMatrix4(i),zi.multiplyScalar(1/zi.w),zi.x*=r.x/2,zi.y*=r.y/2,zi.z=0,wl.copy(zi),Tl.multiplyMatrices(e.matrixWorldInverse,o);for(let f=0,d=u;f<d;f++){if(Pt.fromBufferAttribute(c,f),Ft.fromBufferAttribute(l,f),Pt.w=1,Ft.w=1,Pt.applyMatrix4(Tl),Ft.applyMatrix4(Tl),Pt.z>h&&Ft.z>h)continue;if(Pt.z>h){const E=Pt.z-Ft.z,C=(Pt.z-h)/E;Pt.lerp(Ft,C)}else if(Ft.z>h){const E=Ft.z-Pt.z,C=(Ft.z-h)/E;Ft.lerp(Pt,C)}Pt.applyMatrix4(i),Ft.applyMatrix4(i),Pt.multiplyScalar(1/Pt.w),Ft.multiplyScalar(1/Ft.w),Pt.x*=r.x/2,Pt.y*=r.y/2,Ft.x*=r.x/2,Ft.y*=r.y/2,Ut.start.copy(Pt),Ut.start.z=0,Ut.end.copy(Ft),Ut.end.z=0;const m=Ut.closestPointToPointParameter(wl,!0);Ut.at(m,e0);const g=Ce.lerp(Pt.z,Ft.z,m),y=g>=-1&&g<=1,v=wl.distanceTo(e0)<on*.5;if(y&&v){Ut.start.fromBufferAttribute(c,f),Ut.end.fromBufferAttribute(l,f),Ut.start.applyMatrix4(o),Ut.end.applyMatrix4(o);const E=new b,C=new b;Zi.distanceSqToSegment(Ut.start,Ut.end,C,E),t.push({point:C,pointOnLine:E,distance:Zi.origin.distanceTo(C),object:n,face:null,faceIndex:f,uv:null,[Kh]:null})}}}class Cp extends ye{constructor(e=new Oc,t=new Uc({color:Math.random()*16777215})){super(e,t),this.isLineSegments2=!0,this.type="LineSegments2"}computeLineDistances(){const e=this.geometry,t=e.attributes.instanceStart,i=e.attributes.instanceEnd,s=new Float32Array(2*t.count);for(let o=0,a=0,c=t.count;o<c;o++,a+=2)Xd.fromBufferAttribute(t,o),Zd.fromBufferAttribute(i,o),s[a]=a===0?0:s[a-1],s[a+1]=s[a]+Xd.distanceTo(Zd);const r=new Vu(s,2,1);return e.setAttribute("instanceDistanceStart",new tn(r,1,0)),e.setAttribute("instanceDistanceEnd",new tn(r,1,1)),this}raycast(e,t){const i=this.material.worldUnits,s=e.camera;s===null&&!i&&console.error('LineSegments2: "Raycaster.camera" needs to be set in order to raycast against LineSegments2 while worldUnits is set to false.');const r=e.params.Line2!==void 0&&e.params.Line2.threshold||0;Zi=e.ray;const o=this.matrixWorld,a=this.geometry,c=this.material;on=c.linewidth+r,a.boundingSphere===null&&a.computeBoundingSphere(),ia.copy(a.boundingSphere).applyMatrix4(o);let l;if(i)l=on*.5;else{const h=Math.max(s.near,ia.distanceToPoint(Zi.origin));l=t0(s,h,c.resolution)}if(ia.radius+=l,Zi.intersectsSphere(ia)===!1)return;a.boundingBox===null&&a.computeBoundingBox(),ta.copy(a.boundingBox).applyMatrix4(o);let u;if(i)u=on*.5;else{const h=Math.max(s.near,ta.distanceToPoint(Zi.origin));u=t0(s,h,c.resolution)}ta.expandByScalar(u),Zi.intersectsBox(ta)!==!1&&(i?yC(this,t):EC(this,s,t))}onBeforeRender(e){const t=this.material.uniforms;t&&t.resolution&&(e.getViewport(Sl),this.material.uniforms.resolution.value.set(Sl.z,Sl.w))}}class Ip extends Cp{constructor(e=new xp,t=new Uc({color:Math.random()*16777215})){super(e,t),this.isLine2=!0,this.type="Line2"}}let sa;const Bl=()=>{if(sa)return sa;const n="B9h9z9tFBBBF8fL9gBB9gLaaaaaFa9gEaaaB9gFaFa9gEaaaFaEMcBFFFGGGEIIILF9wFFFLEFBFKNFaFCx/IFMO/LFVK9tv9t9vq95GBt9f9f939h9z9t9f9j9h9s9s9f9jW9vq9zBBp9tv9z9o9v9wW9f9kv9j9v9kv9WvqWv94h919m9mvqBF8Z9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv94h919m9mvqBGy9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv949TvZ91v9u9jvBEn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9P9jWBIi9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9R919hWBLn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9F949wBKI9z9iqlBOc+x8ycGBM/qQFTa8jUUUUBCU/EBlHL8kUUUUBC9+RKGXAGCFJAI9LQBCaRKAE2BBC+gF9HQBALAEAIJHOAGlAGTkUUUBRNCUoBAG9uC/wgBZHKCUGAKCUG9JyRVAECFJRICBRcGXEXAcAF9PQFAVAFAclAcAVJAF9JyRMGXGXAG9FQBAMCbJHKC9wZRSAKCIrCEJCGrRQANCUGJRfCBRbAIRTEXGXAOATlAQ9PQBCBRISEMATAQJRIGXAS9FQBCBRtCBREEXGXAOAIlCi9PQBCBRISLMANCU/CBJAEJRKGXGXGXGXGXATAECKrJ2BBAtCKZrCEZfIBFGEBMAKhB83EBAKCNJhB83EBSEMAKAI2BIAI2BBHmCKrHYAYCE6HYy86BBAKCFJAICIJAYJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCGJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCEJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCIJAYAmJHY2BBAI2BFHmCKrHPAPCE6HPy86BBAKCLJAYAPJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCKJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCOJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCNJAYAmJHY2BBAI2BGHmCKrHPAPCE6HPy86BBAKCVJAYAPJHY2BBAmCIrCEZHPAPCE6HPy86BBAKCcJAYAPJHY2BBAmCGrCEZHPAPCE6HPy86BBAKCMJAYAPJHY2BBAmCEZHmAmCE6Hmy86BBAKCSJAYAmJHm2BBAI2BEHICKrHYAYCE6HYy86BBAKCQJAmAYJHm2BBAICIrCEZHYAYCE6HYy86BBAKCfJAmAYJHm2BBAICGrCEZHYAYCE6HYy86BBAKCbJAmAYJHK2BBAICEZHIAICE6HIy86BBAKAIJRISGMAKAI2BNAI2BBHmCIrHYAYCb6HYy86BBAKCFJAICNJAYJHY2BBAmCbZHmAmCb6Hmy86BBAKCGJAYAmJHm2BBAI2BFHYCIrHPAPCb6HPy86BBAKCEJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCIJAmAYJHm2BBAI2BGHYCIrHPAPCb6HPy86BBAKCLJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCKJAmAYJHm2BBAI2BEHYCIrHPAPCb6HPy86BBAKCOJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCNJAmAYJHm2BBAI2BIHYCIrHPAPCb6HPy86BBAKCVJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCcJAmAYJHm2BBAI2BLHYCIrHPAPCb6HPy86BBAKCMJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCSJAmAYJHm2BBAI2BKHYCIrHPAPCb6HPy86BBAKCQJAmAPJHm2BBAYCbZHYAYCb6HYy86BBAKCfJAmAYJHm2BBAI2BOHICIrHYAYCb6HYy86BBAKCbJAmAYJHK2BBAICbZHIAICb6HIy86BBAKAIJRISFMAKAI8pBB83BBAKCNJAICNJ8pBB83BBAICTJRIMAtCGJRtAECTJHEAS9JQBMMGXAIQBCBRISEMGXAM9FQBANAbJ2BBRtCBRKAfREEXAEANCU/CBJAKJ2BBHTCFrCBATCFZl9zAtJHt86BBAEAGJREAKCFJHKAM9HQBMMAfCFJRfAIRTAbCFJHbAG9HQBMMABAcAG9sJANCUGJAMAG9sTkUUUBpANANCUGJAMCaJAG9sJAGTkUUUBpMAMCBAIyAcJRcAIQBMC9+RKSFMCBC99AOAIlAGCAAGCA9Ly6yRKMALCU/EBJ8kUUUUBAKM+OmFTa8jUUUUBCoFlHL8kUUUUBC9+RKGXAFCE9uHOCtJAI9LQBCaRKAE2BBHNC/wFZC/gF9HQBANCbZHVCF9LQBALCoBJCgFCUFT+JUUUBpALC84Jha83EBALC8wJha83EBALC8oJha83EBALCAJha83EBALCiJha83EBALCTJha83EBALha83ENALha83EBAEAIJC9wJRcAECFJHNAOJRMGXAF9FQBCQCbAVCF6yRSABRECBRVCBRQCBRfCBRICBRKEXGXAMAcuQBC9+RKSEMGXGXAN2BBHOC/vF9LQBALCoBJAOCIrCa9zAKJCbZCEWJHb8oGIRTAb8oGBRtGXAOCbZHbAS9PQBALAOCa9zAIJCbZCGWJ8oGBAVAbyROAb9FRbGXGXAGCG9HQBABAt87FBABCIJAO87FBABCGJAT87FBSFMAEAtjGBAECNJAOjGBAECIJATjGBMAVAbJRVALCoBJAKCEWJHmAOjGBAmATjGIALAICGWJAOjGBALCoBJAKCFJCbZHKCEWJHTAtjGBATAOjGIAIAbJRIAKCFJRKSGMGXGXAbCb6QBAQAbJAbC989zJCFJRQSFMAM1BBHbCgFZROGXGXAbCa9MQBAMCFJRMSFMAM1BFHbCgBZCOWAOCgBZqROGXAbCa9MQBAMCGJRMSFMAM1BGHbCgBZCfWAOqROGXAbCa9MQBAMCEJRMSFMAM1BEHbCgBZCdWAOqROGXAbCa9MQBAMCIJRMSFMAM2BIC8cWAOqROAMCLJRMMAOCFrCBAOCFZl9zAQJRQMGXGXAGCG9HQBABAt87FBABCIJAQ87FBABCGJAT87FBSFMAEAtjGBAECNJAQjGBAECIJATjGBMALCoBJAKCEWJHOAQjGBAOATjGIALAICGWJAQjGBALCoBJAKCFJCbZHKCEWJHOAtjGBAOAQjGIAICFJRIAKCFJRKSFMGXAOCDF9LQBALAIAcAOCbZJ2BBHbCIrHTlCbZCGWJ8oGBAVCFJHtATyROALAIAblCbZCGWJ8oGBAtAT9FHmJHtAbCbZHTyRbAT9FRTGXGXAGCG9HQBABAV87FBABCIJAb87FBABCGJAO87FBSFMAEAVjGBAECNJAbjGBAECIJAOjGBMALAICGWJAVjGBALCoBJAKCEWJHYAOjGBAYAVjGIALAICFJHICbZCGWJAOjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAIAmJCbZHICGWJAbjGBALCoBJAKCGJCbZHKCEWJHOAVjGBAOAbjGIAKCFJRKAIATJRIAtATJRVSFMAVCBAM2BBHYyHTAOC/+F6HPJROAYCbZRtGXGXAYCIrHmQBAOCFJRbSFMAORbALAIAmlCbZCGWJ8oGBROMGXGXAtQBAbCFJRVSFMAbRVALAIAYlCbZCGWJ8oGBRbMGXGXAP9FQBAMCFJRYSFMAM1BFHYCgFZRTGXGXAYCa9MQBAMCGJRYSFMAM1BGHYCgBZCOWATCgBZqRTGXAYCa9MQBAMCEJRYSFMAM1BEHYCgBZCfWATqRTGXAYCa9MQBAMCIJRYSFMAM1BIHYCgBZCdWATqRTGXAYCa9MQBAMCLJRYSFMAMCKJRYAM2BLC8cWATqRTMATCFrCBATCFZl9zAQJHQRTMGXGXAmCb6QBAYRPSFMAY1BBHMCgFZROGXGXAMCa9MQBAYCFJRPSFMAY1BFHMCgBZCOWAOCgBZqROGXAMCa9MQBAYCGJRPSFMAY1BGHMCgBZCfWAOqROGXAMCa9MQBAYCEJRPSFMAY1BEHMCgBZCdWAOqROGXAMCa9MQBAYCIJRPSFMAYCLJRPAY2BIC8cWAOqROMAOCFrCBAOCFZl9zAQJHQROMGXGXAtCb6QBAPRMSFMAP1BBHMCgFZRbGXGXAMCa9MQBAPCFJRMSFMAP1BFHMCgBZCOWAbCgBZqRbGXAMCa9MQBAPCGJRMSFMAP1BGHMCgBZCfWAbqRbGXAMCa9MQBAPCEJRMSFMAP1BEHMCgBZCdWAbqRbGXAMCa9MQBAPCIJRMSFMAPCLJRMAP2BIC8cWAbqRbMAbCFrCBAbCFZl9zAQJHQRbMGXGXAGCG9HQBABAT87FBABCIJAb87FBABCGJAO87FBSFMAEATjGBAECNJAbjGBAECIJAOjGBMALCoBJAKCEWJHYAOjGBAYATjGIALAICGWJATjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAICFJHICbZCGWJAOjGBALCoBJAKCGJCbZCEWJHOATjGBAOAbjGIALAIAm9FAmCb6qJHICbZCGWJAbjGBAIAt9FAtCb6qJRIAKCEJRKMANCFJRNABCKJRBAECSJREAKCbZRKAICbZRIAfCEJHfAF9JQBMMCBC99AMAc6yRKMALCoFJ8kUUUUBAKM/tIFGa8jUUUUBCTlRLC9+RKGXAFCLJAI9LQBCaRKAE2BBC/+FZC/QF9HQBALhB83ENAECFJRKAEAIJC98JREGXAF9FQBGXAGCG6QBEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMALCNJAICFZCGWqHGAICGrCBAICFrCFZl9zAG8oGBJHIjGBABAIjGBABCIJRBAFCaJHFQBSGMMEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMABAICGrCBAICFrCFZl9zALCNJAICFZCGWqHI8oGBJHG87FBAIAGjGBABCGJRBAFCaJHFQBMMCBC99AKAE6yRKMAKM+lLKFaF99GaG99FaG99GXGXAGCI9HQBAF9FQFEXGXGX9DBBB8/9DBBB+/ABCGJHG1BB+yAB1BBHE+yHI+L+TABCFJHL1BBHK+yHO+L+THN9DBBBB9gHVyAN9DBB/+hANAN+U9DBBBBANAVyHcAc+MHMAECa3yAI+SHIAI+UAcAMAKCa3yAO+SHcAc+U+S+S+R+VHO+U+SHN+L9DBBB9P9d9FQBAN+oRESFMCUUUU94REMAGAE86BBGXGX9DBBB8/9DBBB+/Ac9DBBBB9gyAcAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMALAG86BBGXGX9DBBB8/9DBBB+/AI9DBBBB9gyAIAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMABAG86BBABCIJRBAFCaJHFQBSGMMAF9FQBEXGXGX9DBBB8/9DBBB+/ABCIJHG8uFB+yAB8uFBHE+yHI+L+TABCGJHL8uFBHK+yHO+L+THN9DBBBB9gHVyAN9DB/+g6ANAN+U9DBBBBANAVyHcAc+MHMAECa3yAI+SHIAI+UAcAMAKCa3yAO+SHcAc+U+S+S+R+VHO+U+SHN+L9DBBB9P9d9FQBAN+oRESFMCUUUU94REMAGAE87FBGXGX9DBBB8/9DBBB+/Ac9DBBBB9gyAcAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMALAG87FBGXGX9DBBB8/9DBBB+/AI9DBBBB9gyAIAO+U+SHN+L9DBBB9P9d9FQBAN+oRGSFMCUUUU94RGMABAG87FBABCNJRBAFCaJHFQBMMM/SEIEaE99EaF99GXAF9FQBCBREABRIEXGXGX9D/zI818/AICKJ8uFBHLCEq+y+VHKAI8uFB+y+UHO9DB/+g6+U9DBBB8/9DBBB+/AO9DBBBB9gy+SHN+L9DBBB9P9d9FQBAN+oRVSFMCUUUU94RVMAICIJ8uFBRcAICGJ8uFBRMABALCFJCEZAEqCFWJAV87FBGXGXAKAM+y+UHN9DB/+g6+U9DBBB8/9DBBB+/AN9DBBBB9gy+SHS+L9DBBB9P9d9FQBAS+oRMSFMCUUUU94RMMABALCGJCEZAEqCFWJAM87FBGXGXAKAc+y+UHK9DB/+g6+U9DBBB8/9DBBB+/AK9DBBBB9gy+SHS+L9DBBB9P9d9FQBAS+oRcSFMCUUUU94RcMABALCaJCEZAEqCFWJAc87FBGXGX9DBBU8/AOAO+U+TANAN+U+TAKAK+U+THO9DBBBBAO9DBBBB9gy+R9DB/+g6+U9DBBB8/+SHO+L9DBBB9P9d9FQBAO+oRcSFMCUUUU94RcMABALCEZAEqCFWJAc87FBAICNJRIAECIJREAFCaJHFQBMMM9JBGXAGCGrAF9sHF9FQBEXABAB8oGBHGCNWCN91+yAGCi91CnWCUUU/8EJ+++U84GBABCIJRBAFCaJHFQBMMM9TFEaCBCB8oGUkUUBHFABCEJC98ZJHBjGUkUUBGXGXAB8/BCTWHGuQBCaREABAGlCggEJCTrXBCa6QFMAFREMAEM/lFFFaGXGXAFABqCEZ9FQBABRESFMGXGXAGCT9PQBABRESFMABREEXAEAF8oGBjGBAECIJAFCIJ8oGBjGBAECNJAFCNJ8oGBjGBAECSJAFCSJ8oGBjGBAECTJREAFCTJRFAGC9wJHGCb9LQBMMAGCI9JQBEXAEAF8oGBjGBAFCIJRFAECIJREAGC98JHGCE9LQBMMGXAG9FQBEXAEAF2BB86BBAECFJREAFCFJRFAGCaJHGQBMMABMoFFGaGXGXABCEZ9FQBABRESFMAFCgFZC+BwsN9sRIGXGXAGCT9PQBABRESFMABREEXAEAIjGBAECSJAIjGBAECNJAIjGBAECIJAIjGBAECTJREAGC9wJHGCb9LQBMMAGCI9JQBEXAEAIjGBAECIJREAGC98JHGCE9LQBMMGXAG9FQBEXAEAF86BBAECFJREAGCaJHGQBMMABMMMFBCUNMIT9kBB",e="B9h9z9tFBBBFiI9gBB9gLaaaaaFa9gEaaaB9gFaFaEMcBBFBFFGGGEILF9wFFFLEFBFKNFaFCx/aFMO/LFVK9tv9t9vq95GBt9f9f939h9z9t9f9j9h9s9s9f9jW9vq9zBBp9tv9z9o9v9wW9f9kv9j9v9kv9WvqWv94h919m9mvqBG8Z9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv94h919m9mvqBIy9tv9z9o9v9wW9f9kv9j9v9kv9J9u9kv949TvZ91v9u9jvBLn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9P9jWBKi9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9R919hWBOn9tv9z9o9v9wW9f9kv9j9v9kv69p9sWvq9F949wBNI9z9iqlBVc+N9IcIBTEM9+FLa8jUUUUBCTlRBCBRFEXCBRGCBREEXABCNJAGJAECUaAFAGrCFZHIy86BBAEAIJREAGCFJHGCN9HQBMAFCx+YUUBJAE86BBAFCEWCxkUUBJAB8pEN83EBAFCFJHFCUG9HQBMMk8lLbaE97F9+FaL978jUUUUBCU/KBlHL8kUUUUBC9+RKGXAGCFJAI9LQBCaRKAE2BBC+gF9HQBALAEAIJHOAGlAG/8cBBCUoBAG9uC/wgBZHKCUGAKCUG9JyRNAECFJRKCBRVGXEXAVAF9PQFANAFAVlAVANJAF9JyRcGXGXAG9FQBAcCbJHIC9wZHMCE9sRSAMCFWRQAICIrCEJCGrRfCBRbEXAKRTCBRtGXEXGXAOATlAf9PQBCBRKSLMALCU/CBJAtAM9sJRmATAfJRKCBREGXAMCoB9JQBAOAKlC/gB9JQBCBRIEXAmAIJREGXGXGXGXGXATAICKrJ2BBHYCEZfIBFGEBMAECBDtDMIBSEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCIJAeDeBJAiCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCNJAeDeBJAiCx+YUUBJ2BBJRKSFMAEAKDBBBDMIBAKCTJRKMGXGXGXGXGXAYCGrCEZfIBFGEBMAECBDtDMITSEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMITAKCIJAeDeBJAiCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMITAKCNJAeDeBJAiCx+YUUBJ2BBJRKSFMAEAKDBBBDMITAKCTJRKMGXGXGXGXGXAYCIrCEZfIBFGEBMAECBDtDMIASEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIAAKCIJAeDeBJAiCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIAAKCNJAeDeBJAiCx+YUUBJ2BBJRKSFMAEAKDBBBDMIAAKCTJRKMGXGXGXGXGXAYCKrfIBFGEBMAECBDtDMI8wSEMAEAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHYCEWCxkUUBJDBEBAYCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHYCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMI8wAKCIJAeDeBJAYCx+YUUBJ2BBJRKSGMAEAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHYCEWCxkUUBJDBEBAYCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHYCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMI8wAKCNJAeDeBJAYCx+YUUBJ2BBJRKSFMAEAKDBBBDMI8wAKCTJRKMAICoBJREAICUFJAM9LQFAERIAOAKlC/fB9LQBMMGXAEAM9PQBAECErRIEXGXAOAKlCi9PQBCBRKSOMAmAEJRYGXGXGXGXGXATAECKrJ2BBAICKZrCEZfIBFGEBMAYCBDtDMIBSEMAYAKDBBIAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnHPCGD+MFAPDQBTFtGmEYIPLdKeOnC0+G+MiDtD9OHdCEDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCIJAeDeBJAiCx+YUUBJ2BBJRKSGMAYAKDBBNAKDBBBHPCID+MFAPDQBTFtGmEYIPLdKeOnC+P+e+8/4BDtD9OHdCbDbD8jHPAPDQBFGENVcMILKOSQfbHeD8dBh+BsxoxoUwN0AeD8dFhxoUwkwk+gUa0sHnhTkAnsHnhNkAnsHn7CgFZHiCEWCxkUUBJDBEBAiCx+YUUBJDBBBHeAeDQBBBBBBBBBBBBBBBBAnhAk7CgFZHiCEWCxkUUBJDBEBD9uDQBFGEILKOTtmYPdenDfAdAPD9SDMIBAKCNJAeDeBJAiCx+YUUBJ2BBJRKSFMAYAKDBBBDMIBAKCTJRKMAICGJRIAECTJHEAM9JQBMMGXAK9FQBAKRTAtCFJHtCI6QGSFMMCBRKSEMGXAM9FQBALCUGJAbJREALAbJDBGBReCBRYEXAEALCU/CBJAYJHIDBIBHdCFD9tAdCFDbHPD9OD9hD9RHdAIAMJDBIBH8ZCFD9tA8ZAPD9OD9hD9RH8ZDQBTFtGmEYIPLdKeOnHpAIAQJDBIBHyCFD9tAyAPD9OD9hD9RHyAIASJDBIBH8cCFD9tA8cAPD9OD9hD9RH8cDQBTFtGmEYIPLdKeOnH8dDQBFTtGEmYILPdKOenHPAPDQBFGEBFGEBFGEBFGEAeD9uHeDyBjGBAEAGJHIAeAPAPDQILKOILKOILKOILKOD9uHeDyBjGBAIAGJHIAeAPAPDQNVcMNVcMNVcMNVcMD9uHeDyBjGBAIAGJHIAeAPAPDQSQfbSQfbSQfbSQfbD9uHeDyBjGBAIAGJHIAeApA8dDQNVi8ZcMpySQ8c8dfb8e8fHPAPDQBFGEBFGEBFGEBFGED9uHeDyBjGBAIAGJHIAeAPAPDQILKOILKOILKOILKOD9uHeDyBjGBAIAGJHIAeAPAPDQNVcMNVcMNVcMNVcMD9uHeDyBjGBAIAGJHIAeAPAPDQSQfbSQfbSQfbSQfbD9uHeDyBjGBAIAGJHIAeAdA8ZDQNiV8ZcpMyS8cQ8df8eb8fHdAyA8cDQNiV8ZcpMyS8cQ8df8eb8fH8ZDQBFTtGEmYILPdKOenHPAPDQBFGEBFGEBFGEBFGED9uHeDyBjGBAIAGJHIAeAPAPDQILKOILKOILKOILKOD9uHeDyBjGBAIAGJHIAeAPAPDQNVcMNVcMNVcMNVcMD9uHeDyBjGBAIAGJHIAeAPAPDQSQfbSQfbSQfbSQfbD9uHeDyBjGBAIAGJHIAeAdA8ZDQNVi8ZcMpySQ8c8dfb8e8fHPAPDQBFGEBFGEBFGEBFGED9uHeDyBjGBAIAGJHIAeAPAPDQILKOILKOILKOILKOD9uHeDyBjGBAIAGJHIAeAPAPDQNVcMNVcMNVcMNVcMD9uHeDyBjGBAIAGJHIAeAPAPDQSQfbSQfbSQfbSQfbD9uHeDyBjGBAIAGJREAYCTJHYAM9JQBMMAbCIJHbAG9JQBMMABAVAG9sJALCUGJAcAG9s/8cBBALALCUGJAcCaJAG9sJAG/8cBBMAcCBAKyAVJRVAKQBMC9+RKSFMCBC99AOAKlAGCAAGCA9Ly6yRKMALCU/KBJ8kUUUUBAKMNBT+BUUUBM+KmFTa8jUUUUBCoFlHL8kUUUUBC9+RKGXAFCE9uHOCtJAI9LQBCaRKAE2BBHNC/wFZC/gF9HQBANCbZHVCF9LQBALCoBJCgFCUF/8MBALC84Jha83EBALC8wJha83EBALC8oJha83EBALCAJha83EBALCiJha83EBALCTJha83EBALha83ENALha83EBAEAIJC9wJRcAECFJHNAOJRMGXAF9FQBCQCbAVCF6yRSABRECBRVCBRQCBRfCBRICBRKEXGXAMAcuQBC9+RKSEMGXGXAN2BBHOC/vF9LQBALCoBJAOCIrCa9zAKJCbZCEWJHb8oGIRTAb8oGBRtGXAOCbZHbAS9PQBALAOCa9zAIJCbZCGWJ8oGBAVAbyROAb9FRbGXGXAGCG9HQBABAt87FBABCIJAO87FBABCGJAT87FBSFMAEAtjGBAECNJAOjGBAECIJATjGBMAVAbJRVALCoBJAKCEWJHmAOjGBAmATjGIALAICGWJAOjGBALCoBJAKCFJCbZHKCEWJHTAtjGBATAOjGIAIAbJRIAKCFJRKSGMGXGXAbCb6QBAQAbJAbC989zJCFJRQSFMAM1BBHbCgFZROGXGXAbCa9MQBAMCFJRMSFMAM1BFHbCgBZCOWAOCgBZqROGXAbCa9MQBAMCGJRMSFMAM1BGHbCgBZCfWAOqROGXAbCa9MQBAMCEJRMSFMAM1BEHbCgBZCdWAOqROGXAbCa9MQBAMCIJRMSFMAM2BIC8cWAOqROAMCLJRMMAOCFrCBAOCFZl9zAQJRQMGXGXAGCG9HQBABAt87FBABCIJAQ87FBABCGJAT87FBSFMAEAtjGBAECNJAQjGBAECIJATjGBMALCoBJAKCEWJHOAQjGBAOATjGIALAICGWJAQjGBALCoBJAKCFJCbZHKCEWJHOAtjGBAOAQjGIAICFJRIAKCFJRKSFMGXAOCDF9LQBALAIAcAOCbZJ2BBHbCIrHTlCbZCGWJ8oGBAVCFJHtATyROALAIAblCbZCGWJ8oGBAtAT9FHmJHtAbCbZHTyRbAT9FRTGXGXAGCG9HQBABAV87FBABCIJAb87FBABCGJAO87FBSFMAEAVjGBAECNJAbjGBAECIJAOjGBMALAICGWJAVjGBALCoBJAKCEWJHYAOjGBAYAVjGIALAICFJHICbZCGWJAOjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAIAmJCbZHICGWJAbjGBALCoBJAKCGJCbZHKCEWJHOAVjGBAOAbjGIAKCFJRKAIATJRIAtATJRVSFMAVCBAM2BBHYyHTAOC/+F6HPJROAYCbZRtGXGXAYCIrHmQBAOCFJRbSFMAORbALAIAmlCbZCGWJ8oGBROMGXGXAtQBAbCFJRVSFMAbRVALAIAYlCbZCGWJ8oGBRbMGXGXAP9FQBAMCFJRYSFMAM1BFHYCgFZRTGXGXAYCa9MQBAMCGJRYSFMAM1BGHYCgBZCOWATCgBZqRTGXAYCa9MQBAMCEJRYSFMAM1BEHYCgBZCfWATqRTGXAYCa9MQBAMCIJRYSFMAM1BIHYCgBZCdWATqRTGXAYCa9MQBAMCLJRYSFMAMCKJRYAM2BLC8cWATqRTMATCFrCBATCFZl9zAQJHQRTMGXGXAmCb6QBAYRPSFMAY1BBHMCgFZROGXGXAMCa9MQBAYCFJRPSFMAY1BFHMCgBZCOWAOCgBZqROGXAMCa9MQBAYCGJRPSFMAY1BGHMCgBZCfWAOqROGXAMCa9MQBAYCEJRPSFMAY1BEHMCgBZCdWAOqROGXAMCa9MQBAYCIJRPSFMAYCLJRPAY2BIC8cWAOqROMAOCFrCBAOCFZl9zAQJHQROMGXGXAtCb6QBAPRMSFMAP1BBHMCgFZRbGXGXAMCa9MQBAPCFJRMSFMAP1BFHMCgBZCOWAbCgBZqRbGXAMCa9MQBAPCGJRMSFMAP1BGHMCgBZCfWAbqRbGXAMCa9MQBAPCEJRMSFMAP1BEHMCgBZCdWAbqRbGXAMCa9MQBAPCIJRMSFMAPCLJRMAP2BIC8cWAbqRbMAbCFrCBAbCFZl9zAQJHQRbMGXGXAGCG9HQBABAT87FBABCIJAb87FBABCGJAO87FBSFMAEATjGBAECNJAbjGBAECIJAOjGBMALCoBJAKCEWJHYAOjGBAYATjGIALAICGWJATjGBALCoBJAKCFJCbZCEWJHYAbjGBAYAOjGIALAICFJHICbZCGWJAOjGBALCoBJAKCGJCbZCEWJHOATjGBAOAbjGIALAIAm9FAmCb6qJHICbZCGWJAbjGBAIAt9FAtCb6qJRIAKCEJRKMANCFJRNABCKJRBAECSJREAKCbZRKAICbZRIAfCEJHfAF9JQBMMCBC99AMAc6yRKMALCoFJ8kUUUUBAKM/tIFGa8jUUUUBCTlRLC9+RKGXAFCLJAI9LQBCaRKAE2BBC/+FZC/QF9HQBALhB83ENAECFJRKAEAIJC98JREGXAF9FQBGXAGCG6QBEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMALCNJAICFZCGWqHGAICGrCBAICFrCFZl9zAG8oGBJHIjGBABAIjGBABCIJRBAFCaJHFQBSGMMEXGXAKAE9JQBC9+bMAK1BBHGCgFZRIGXGXAGCa9MQBAKCFJRKSFMAK1BFHGCgBZCOWAICgBZqRIGXAGCa9MQBAKCGJRKSFMAK1BGHGCgBZCfWAIqRIGXAGCa9MQBAKCEJRKSFMAK1BEHGCgBZCdWAIqRIGXAGCa9MQBAKCIJRKSFMAK2BIC8cWAIqRIAKCLJRKMABAICGrCBAICFrCFZl9zALCNJAICFZCGWqHI8oGBJHG87FBAIAGjGBABCGJRBAFCaJHFQBMMCBC99AKAE6yRKMAKM/dLEK97FaF97GXGXAGCI9HQBAF9FQFCBRGEXABABDBBBHECiD+rFCiD+sFD/6FHIAECND+rFCiD+sFD/6FAID/gFAECTD+rFCiD+sFD/6FHLD/gFD/kFD/lFHKCBDtD+2FHOAICUUUU94DtHND9OD9RD/kFHI9DBB/+hDYAIAID/mFAKAKD/mFALAOALAND9OD9RD/kFHIAID/mFD/kFD/kFD/jFD/nFHLD/mF9DBBX9LDYHOD/kFCgFDtD9OAECUUU94DtD9OD9QAIALD/mFAOD/kFCND+rFCU/+EDtD9OD9QAKALD/mFAOD/kFCTD+rFCUU/8ODtD9OD9QDMBBABCTJRBAGCIJHGAF9JQBSGMMAF9FQBCBRGEXABCTJHVAVDBBBHECBDtHOCUU98D8cFCUU98D8cEHND9OABDBBBHKAEDQILKOSQfbPden8c8d8e8fCggFDtD9OD/6FAKAEDQBFGENVcMTtmYi8ZpyHECTD+sFD/6FHID/gFAECTD+rFCTD+sFD/6FHLD/gFD/kFD/lFHE9DB/+g6DYALAEAOD+2FHOALCUUUU94DtHcD9OD9RD/kFHLALD/mFAEAED/mFAIAOAIAcD9OD9RD/kFHEAED/mFD/kFD/kFD/jFD/nFHID/mF9DBBX9LDYHOD/kFCTD+rFALAID/mFAOD/kFCggEDtD9OD9QHLAEAID/mFAOD/kFCaDbCBDnGCBDnECBDnKCBDnOCBDncCBDnMCBDnfCBDnbD9OHEDQNVi8ZcMpySQ8c8dfb8e8fD9QDMBBABAKAND9OALAEDQBFTtGEmYILPdKOenD9QDMBBABCAJRBAGCIJHGAF9JQBMMM/hEIGaF97FaL978jUUUUBCTlREGXAF9FQBCBRIEXAEABDBBBHLABCTJHKDBBBHODQILKOSQfbPden8c8d8e8fHNCTD+sFHVCID+rFDMIBAB9DBBU8/DY9D/zI818/DYAVCEDtD9QD/6FD/nFHVALAODQBFGENVcMTtmYi8ZpyHLCTD+rFCTD+sFD/6FD/mFHOAOD/mFAVALCTD+sFD/6FD/mFHcAcD/mFAVANCTD+rFCTD+sFD/6FD/mFHNAND/mFD/kFD/kFD/lFCBDtD+4FD/jF9DB/+g6DYHVD/mF9DBBX9LDYHLD/kFCggEDtHMD9OAcAVD/mFALD/kFCTD+rFD9QHcANAVD/mFALD/kFCTD+rFAOAVD/mFALD/kFAMD9OD9QHVDQBFTtGEmYILPdKOenHLD8dBAEDBIBDyB+t+J83EBABCNJALD8dFAEDBIBDyF+t+J83EBAKAcAVDQNVi8ZcMpySQ8c8dfb8e8fHVD8dBAEDBIBDyG+t+J83EBABCiJAVD8dFAEDBIBDyE+t+J83EBABCAJRBAICIJHIAF9JQBMMM9jFF97GXAGCGrAF9sHG9FQBCBRFEXABABDBBBHECND+rFCND+sFD/6FAECiD+sFCnD+rFCUUU/8EDtD+uFD/mFDMBBABCTJRBAFCIJHFAG9JQBMMM9TFEaCBCB8oGUkUUBHFABCEJC98ZJHBjGUkUUBGXGXAB8/BCTWHGuQBCaREABAGlCggEJCTrXBCa6QFMAFREMAEMMMFBCUNMIT9tBB",t=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]),i=new Uint8Array([32,0,65,253,3,1,2,34,4,106,6,5,11,8,7,20,13,33,12,16,128,9,116,64,19,113,127,15,10,21,22,14,255,66,24,54,136,107,18,23,192,26,114,118,132,17,77,101,130,144,27,87,131,44,45,74,156,154,70,167]);if(typeof WebAssembly!="object")return{supported:!1};let s=n;WebAssembly.validate(t)&&(s=e);let r;const o=WebAssembly.instantiate(a(s),{}).then(h=>{r=h.instance,r.exports.__wasm_call_ctors()});function a(h){const f=new Uint8Array(h.length);for(let p=0;p<h.length;++p){const m=h.charCodeAt(p);f[p]=m>96?m-71:m>64?m-65:m>47?m+4:m>46?63:62}let d=0;for(let p=0;p<h.length;++p)f[d++]=f[p]<60?i[f[p]]:(f[p]-60)*64+f[++p];return f.buffer.slice(0,d)}function c(h,f,d,p,m,g){const y=r.exports.sbrk,v=d+3&-4,E=y(v*p),C=y(m.length),x=new Uint8Array(r.exports.memory.buffer);x.set(m,C);const I=h(E,d,p,C,m.length);if(I===0&&g&&g(E,v,p),f.set(x.subarray(E,E+d*p)),y(E-y(0)),I!==0)throw new Error(`Malformed buffer data: ${I}`)}const l={0:"",1:"meshopt_decodeFilterOct",2:"meshopt_decodeFilterQuat",3:"meshopt_decodeFilterExp",NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},u={0:"meshopt_decodeVertexBuffer",1:"meshopt_decodeIndexBuffer",2:"meshopt_decodeIndexSequence",ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};return sa={ready:o,supported:!0,decodeVertexBuffer(h,f,d,p,m){c(r.exports.meshopt_decodeVertexBuffer,h,f,d,p,r.exports[l[m]])},decodeIndexBuffer(h,f,d,p){c(r.exports.meshopt_decodeIndexBuffer,h,f,d,p)},decodeIndexSequence(h,f,d,p){c(r.exports.meshopt_decodeIndexSequence,h,f,d,p)},decodeGltfBuffer(h,f,d,p,m,g){c(r.exports[u[m]],h,f,d,p,r.exports[l[g]])}},sa},i0=n=>Symbol.iterator in n,s0=n=>"entries"in n,n0=(n,e)=>{const t=n instanceof Map?n:new Map(n.entries()),i=e instanceof Map?e:new Map(e.entries());if(t.size!==i.size)return!1;for(const[s,r]of t)if(!Object.is(r,i.get(s)))return!1;return!0},vC=(n,e)=>{const t=n[Symbol.iterator](),i=e[Symbol.iterator]();let s=t.next(),r=i.next();for(;!s.done&&!r.done;){if(!Object.is(s.value,r.value))return!1;s=t.next(),r=i.next()}return!!s.done&&!!r.done};function xC(n,e){return Object.is(n,e)?!0:typeof n!="object"||n===null||typeof e!="object"||e===null?!1:!i0(n)||!i0(e)?n0({entries:()=>Object.entries(n)},{entries:()=>Object.entries(e)}):s0(n)&&s0(e)?n0(n,e):vC(n,e)}const Sp=A.createContext([]);function l_({box:n,multiple:e,children:t,onChange:i,onChangePointerUp:s,border:r="1px solid #55aaff",backgroundColor:o="rgba(75, 160, 255, 0.1)",filter:a=l=>l,...c}){const[l,u]=A.useState(!1),{setEvents:h,camera:f,raycaster:d,gl:p,controls:m,size:g,get:y}=Z(),[v,E]=A.useState(!1),[C,x]=A.useReducer((B,{object:T,shift:R})=>T===void 0?[]:Array.isArray(T)?T:R?B.includes(T)?B.filter(_=>_!==T):[T,...B]:B[0]===T?[]:[T],[]);A.useEffect(()=>{l?i==null||i(C):s==null||s(C)},[C,l]);const I=A.useCallback(B=>{B.stopPropagation(),x({object:a([B.object])[0],shift:e&&B.shiftKey})},[]),S=A.useCallback(B=>!v&&x({}),[v]),w=A.useRef(null);return A.useEffect(()=>{if(!n||!e)return;const B=new x4(f,w.current),T=document.createElement("div");T.style.pointerEvents="none",T.style.border=r,T.style.backgroundColor=o,T.style.position="fixed";const R=new de,_=new de,L=new de,O=y().events.enabled,U=m==null?void 0:m.enabled;let Q=!1;function G(k,P){const{offsetX:F,offsetY:J}=k,{width:se,height:q}=g;P.set(F/se*2-1,-(J/q)*2+1)}function z(k){var P;m&&(m.enabled=!1),h({enabled:!1}),u(Q=!0),(P=p.domElement.parentElement)==null||P.appendChild(T),T.style.left=`${k.clientX}px`,T.style.top=`${k.clientY}px`,T.style.width="0px",T.style.height="0px",R.x=k.clientX,R.y=k.clientY}function H(k){L.x=Math.max(R.x,k.clientX),L.y=Math.max(R.y,k.clientY),_.x=Math.min(R.x,k.clientX),_.y=Math.min(R.y,k.clientY),T.style.left=`${_.x}px`,T.style.top=`${_.y}px`,T.style.width=`${L.x-_.x}px`,T.style.height=`${L.y-_.y}px`}function N(){if(Q){var k;m&&(m.enabled=U),h({enabled:O}),u(Q=!1),(k=T.parentElement)==null||k.removeChild(T)}}function V(k){k.shiftKey&&(z(k),G(k,B.startPoint))}let $=[];function Y(k){if(Q){H(k),G(k,B.endPoint);const P=B.select().sort(F=>F.uuid).filter(F=>F.isMesh);xC(P,$)||($=P,x({object:a(P)}))}}function M(k){Q&&N()}return document.addEventListener("pointerdown",V,{passive:!0}),document.addEventListener("pointermove",Y,{passive:!0,capture:!0}),document.addEventListener("pointerup",M,{passive:!0}),()=>{document.removeEventListener("pointerdown",V),document.removeEventListener("pointermove",Y,!0),document.removeEventListener("pointerup",M)}},[g.width,g.height,d,f,m,p]),A.createElement("group",ie({ref:w,onClick:I,onPointerOver:()=>E(!0),onPointerOut:()=>E(!1),onPointerMissed:S},c),A.createElement(Sp.Provider,{value:C},t))}function u_(){return A.useContext(Sp)}const CC=A.forwardRef(function({children:e,follow:t=!0,lockX:i=!1,lockY:s=!1,lockZ:r=!1,...o},a){const c=A.useRef(null),l=A.useRef(null),u=new Be;return Ee(({camera:h})=>{if(!t||!l.current)return;const f=l.current.rotation.clone();l.current.updateMatrix(),l.current.updateWorldMatrix(!1,!1),l.current.getWorldQuaternion(u),h.getWorldQuaternion(c.current.quaternion).premultiply(u.invert()),i&&(l.current.rotation.x=f.x),s&&(l.current.rotation.y=f.y),r&&(l.current.rotation.z=f.z)}),A.useImperativeHandle(a,()=>l.current,[]),A.createElement("group",ie({ref:l},o),A.createElement("group",{ref:c},e))}),h_=A.forwardRef(({children:n,depth:e=-1,...t},i)=>{const s=A.useRef(null);return A.useImperativeHandle(i,()=>s.current,[]),Ee(({camera:r})=>{s.current.quaternion.copy(r.quaternion),s.current.position.copy(r.position)}),A.createElement("group",ie({ref:s},t),A.createElement("group",{"position-z":-e},n))}),IC=new b,SC=new b,wC=new b,TC=(n,e,t)=>{const i=t.width/2,s=t.height/2;e.updateMatrixWorld(!1);const r=n.project(e);return r.x=r.x*i+i,r.y=-(r.y*s)+s,r},BC=(n,e,t,i=1)=>{const s=IC.set(n.x/t.width*2-1,-(n.y/t.height)*2+1,i);return s.unproject(e),s},qh=(n,e,t,i)=>{const s=TC(wC.copy(n),t,i);let r=0;for(let o=0;o<2;++o){const a=SC.copy(s).setComponent(o,s.getComponent(o)+e),c=BC(a,t,i,a.z);r=Math.max(r,n.distanceTo(c))}return r},_C=new b,f_=A.forwardRef(({scale:n=1,...e},t)=>{const i=A.useRef(null);return A.useImperativeHandle(t,()=>i.current,[]),Ee(s=>{const r=i.current;if(!r)return;const o=qh(r.getWorldPosition(_C),n,s.camera,s.size);r.scale.setScalar(o*n)}),A.createElement("object3D",ie({ref:i},e))}),cs=A.forwardRef(function({points:e,color:t=16777215,vertexColors:i,linewidth:s,lineWidth:r,segments:o,dashed:a,...c},l){var u,h;const f=Z(y=>y.size),d=A.useMemo(()=>o?new Cp:new Ip,[o]),[p]=A.useState(()=>new Uc),m=(i==null||(u=i[0])==null?void 0:u.length)===4?4:3,g=A.useMemo(()=>{const y=o?new Oc:new xp,v=e.map(E=>{const C=Array.isArray(E);return E instanceof b||E instanceof ft?[E.x,E.y,E.z]:E instanceof de?[E.x,E.y,0]:C&&E.length===3?[E[0],E[1],E[2]]:C&&E.length===2?[E[0],E[1],0]:E});if(y.setPositions(v.flat()),i){t=16777215;const E=i.map(C=>C instanceof xe?C.toArray():C);y.setColors(E.flat(),m)}return y},[e,o,i,m]);return A.useLayoutEffect(()=>{d.computeLineDistances()},[e,d]),A.useLayoutEffect(()=>{a?p.defines.USE_DASH="":delete p.defines.USE_DASH,p.needsUpdate=!0},[a,p]),A.useEffect(()=>()=>{g.dispose(),p.dispose()},[g]),A.createElement("primitive",ie({object:d,ref:l},c),A.createElement("primitive",{object:g,attach:"geometry"}),A.createElement("primitive",ie({object:p,attach:"material",color:t,vertexColors:!!i,resolution:[f.width,f.height],linewidth:(h=s??r)!==null&&h!==void 0?h:1,dashed:a,transparent:m===4},c)))}),bC=new b,d_=A.forwardRef(function({start:e=[0,0,0],end:t=[0,0,0],mid:i,segments:s=20,...r},o){const a=A.useRef(null);A.useImperativeHandle(o,()=>a.current);const[c]=A.useState(()=>new Ly(void 0,void 0,void 0)),l=A.useCallback((h,f,d,p=20)=>(h instanceof b?c.v0.copy(h):c.v0.set(...h),f instanceof b?c.v2.copy(f):c.v2.set(...f),d instanceof b?c.v1.copy(d):Array.isArray(d)?c.v1.set(...d):c.v1.copy(c.v0.clone().add(c.v2.clone().sub(c.v0)).add(bC.set(0,c.v0.y-c.v2.y,0))),c.getPoints(p)),[]);A.useLayoutEffect(()=>{a.current.setPoints=(h,f,d)=>{const p=l(h,f,d);a.current.geometry&&a.current.geometry.setPositions(p.map(m=>m.toArray()).flat())}},[]);const u=A.useMemo(()=>l(e,t,i,s),[e,t,i,s]);return A.createElement(cs,ie({ref:a,points:u},r))}),A_=A.forwardRef(function({start:e,end:t,midA:i,midB:s,segments:r=20,...o},a){const c=A.useMemo(()=>{const l=e instanceof b?e:new b(...e),u=t instanceof b?t:new b(...t),h=i instanceof b?i:new b(...i),f=s instanceof b?s:new b(...s);return new Py(l,h,f,u).getPoints(r)},[e,t,i,s,r]);return A.createElement(cs,ie({ref:a,points:c},o))}),m_=A.forwardRef(function({points:e,closed:t=!1,curveType:i="centripetal",tension:s=.5,segments:r=20,vertexColors:o,...a},c){const l=A.useMemo(()=>{const f=e.map(d=>d instanceof b?d:new b(...d));return new c1(f,t,i,s)},[e,t,i,s]),u=A.useMemo(()=>l.getPoints(r),[l,r]),h=A.useMemo(()=>{if(!o||o.length<2)return;if(o.length===r+1)return o;const f=o.map(m=>m instanceof xe?m:new xe(...m));t&&f.push(f[0].clone());const d=[f[0]],p=r/(f.length-1);for(let m=1;m<r;m++){const g=m%p/p,y=Math.floor(m/p);d.push(f[y].clone().lerp(f[y+1],g))}return d.push(f[f.length-1]),d},[o,r]);return A.createElement(cs,ie({ref:c,points:u,vertexColors:h},a))}),p_=A.forwardRef(({url:n,distance:e=1,loop:t=!0,autoplay:i,...s},r)=>{const o=A.useRef(null);A.useImperativeHandle(r,()=>o.current,[]);const a=Z(({camera:u})=>u),[c]=A.useState(()=>new Fy),l=gt(ky,n);return A.useEffect(()=>{const u=o.current;u&&(u.setBuffer(l),u.setRefDistance(e),u.setLoop(t),i&&!u.isPlaying&&u.play())},[l,a,e,t]),A.useEffect(()=>{const u=o.current;return a.add(c),()=>{a.remove(c),u&&(u.isPlaying&&u.stop(),u.source&&u.source._connected&&u.disconnect())}},[]),A.createElement("positionalAudio",ie({ref:o,args:[c]},s))});let _l=null;async function RC(n){return typeof n=="string"?await(await fetch(n)).json():n}function DC(n){return _l||(_l=new H4),_l.parse(n)}async function wp(n){const e=await RC(n);return DC(e)}function Xh(n){return dn(wp,[n])}Xh.preload=n=>Oy(wp,[n]);Xh.clear=n=>Ph([n]);const MC=["string","number"],LC=n=>{let e="";const t=[];return A.Children.forEach(n,i=>{MC.includes(typeof i)?e+=i+"":t.push(i)}),[e,...t]},PC=A.forwardRef(({font:n,letterSpacing:e=0,lineHeight:t=1,size:i=1,height:s=.2,bevelThickness:r=.1,bevelSize:o=.01,bevelEnabled:a=!1,bevelOffset:c=0,bevelSegments:l=4,curveSegments:u=8,smooth:h,children:f,...d},p)=>{A.useMemo(()=>dt({RenamedTextGeometry:g4}),[]);const m=A.useRef(null),g=Xh(n),y=A.useMemo(()=>({font:g,size:i,height:s,bevelThickness:r,bevelSize:o,bevelEnabled:a,bevelSegments:l,bevelOffset:c,curveSegments:u,letterSpacing:e,lineHeight:t}),[g,i,s,r,o,a,l,c,u,e,t]),[v,...E]=A.useMemo(()=>LC(f),[f]),C=A.useMemo(()=>[v,y],[v,y]);return A.useLayoutEffect(()=>{h&&(m.current.geometry=Uv(m.current.geometry,h),m.current.geometry.computeVertexNormals())},[C,h]),A.useImperativeHandle(p,()=>m.current,[]),A.createElement("mesh",ie({},d,{ref:m}),A.createElement("renamedTextGeometry",{args:C}),E)}),g_=()=>{try{var n=document.createElement("canvas");return!!(window.WebGL2RenderingContext&&n.getContext("webgl2"))}catch{return!1}},y_=A.forwardRef(({children:n,multisamping:e=8,renderIndex:t=1,disableRender:i,disableGamma:s,disableRenderPass:r,depthBuffer:o=!0,stencilBuffer:a=!1,anisotropy:c=1,encoding:l,type:u,...h},f)=>{A.useMemo(()=>dt({EffectComposer:Dx,RenderPass:Px,ShaderPass:Zu}),[]);const d=A.useRef(null);A.useImperativeHandle(f,()=>d.current,[]);const{scene:p,camera:m,gl:g,size:y,viewport:v}=Z(),[E]=A.useState(()=>{const x=new It(y.width,y.height,{type:u||Qi,format:jt,depthBuffer:o,stencilBuffer:a,anisotropy:c});return u===Yt&&l!=null&&("colorSpace"in x?x.texture.colorSpace=l:x.texture.encoding=l),x.samples=e,x});A.useEffect(()=>{var x,I;(x=d.current)==null||x.setSize(y.width,y.height),(I=d.current)==null||I.setPixelRatio(v.dpr)},[g,y,v.dpr]),Ee(()=>{var x;i||(x=d.current)==null||x.render()},t);const C=[];return r||C.push(A.createElement("renderPass",{key:"renderpass",attach:`passes-${C.length}`,args:[p,m]})),s||C.push(A.createElement("shaderPass",{attach:`passes-${C.length}`,key:"gammapass",args:[y4]})),A.Children.forEach(n,x=>{x&&C.push(A.cloneElement(x,{key:C.length,attach:`passes-${C.length}`}))}),A.createElement("effectComposer",ie({ref:d,args:[g,E]},h),C)});function Ri(n,e,t,i){const s=class extends Dt{constructor(o={}){const a=Object.entries(n);super({uniforms:a.reduce((c,[l,u])=>{const h=_o.clone({[l]:{value:u}});return{...c,...h}},{}),vertexShader:e,fragmentShader:t}),this.key="",a.forEach(([c])=>Object.defineProperty(this,c,{get:()=>this.uniforms[c].value,set:l=>this.uniforms[c].value=l})),Object.assign(this,o),i&&i(this)}};return s.key=Ce.generateUUID(),s}const So=n=>n===Object(n)&&!Array.isArray(n)&&typeof n!="function";function pn(n,e){const t=Z(r=>r.gl),i=gt(Bs,So(n)?Object.values(n):n);return A.useLayoutEffect(()=>{e==null||e(i)},[e]),A.useEffect(()=>{if("initTexture"in t){let r=[];Array.isArray(i)?r=i:i instanceof as?r=[i]:So(i)&&(r=Object.values(i)),r.forEach(o=>{o instanceof as&&t.initTexture(o)})}},[t,i]),A.useMemo(()=>{if(So(n)){const r={};let o=0;for(const a in n)r[a]=i[o++];return r}else return i},[n,i])}pn.preload=n=>gt.preload(Bs,n);pn.clear=n=>gt.clear(Bs,n);const v_=({children:n,input:e,onLoad:t})=>{const i=pn(e,t);return A.createElement(A.Fragment,null,n==null?void 0:n(i))},FC=()=>parseInt(xr.replace(/\D+/g,"")),qt=FC(),r0=Ri({color:new xe("white"),scale:new de(1,1),imageBounds:new de(1,1),resolution:1024,map:null,zoom:1,radius:0,grayscale:0,opacity:1},`
  varying vec2 vUv;
  varying vec2 vPos;
  void main() {
    gl_Position = projectionMatrix * viewMatrix * modelMatrix * vec4(position, 1.);
    vUv = uv;
    vPos = position.xy;
  }
`,`
  // mostly from https://gist.github.com/statico/df64c5d167362ecf7b34fca0b1459a44
  varying vec2 vUv;
  varying vec2 vPos;
  uniform vec2 scale;
  uniform vec2 imageBounds;
  uniform float resolution;
  uniform vec3 color;
  uniform sampler2D map;
  uniform float radius;
  uniform float zoom;
  uniform float grayscale;
  uniform float opacity;
  const vec3 luma = vec3(.299, 0.587, 0.114);
  vec4 toGrayscale(vec4 color, float intensity) {
    return vec4(mix(color.rgb, vec3(dot(color.rgb, luma)), intensity), color.a);
  }
  vec2 aspect(vec2 size) {
    return size / min(size.x, size.y);
  }
  
  const float PI = 3.14159265;
    
  // from https://iquilezles.org/articles/distfunctions
  float udRoundBox( vec2 p, vec2 b, float r ) {
    return length(max(abs(p)-b+r,0.0))-r;
  }

  void main() {
    vec2 s = aspect(scale);
    vec2 i = aspect(imageBounds);
    float rs = s.x / s.y;
    float ri = i.x / i.y;
    vec2 new = rs < ri ? vec2(i.x * s.y / i.y, s.y) : vec2(s.x, i.y * s.x / i.x);
    vec2 offset = (rs < ri ? vec2((new.x - s.x) / 2.0, 0.0) : vec2(0.0, (new.y - s.y) / 2.0)) / new;
    vec2 uv = vUv * s / new + offset;
    vec2 zUv = (uv - vec2(0.5, 0.5)) / zoom + vec2(0.5, 0.5);

    vec2 res = vec2(scale * resolution);
    vec2 halfRes = 0.5 * res;
    float b = udRoundBox(vUv.xy * res - halfRes, halfRes, resolution * radius);    
	  vec3 a = mix(vec3(1.0,0.0,0.0), vec3(0.0,0.0,0.0), smoothstep(0.0, 1.0, b));
    gl_FragColor = toGrayscale(texture2D(map, zUv) * vec4(color, opacity * a), grayscale);
    
    #include <tonemapping_fragment>
    #include <${qt>=154?"colorspace_fragment":"encodings_fragment"}>
  }
`),Tp=A.forwardRef(({children:n,color:e,segments:t=1,scale:i=1,zoom:s=1,grayscale:r=0,opacity:o=1,radius:a=0,texture:c,toneMapped:l,transparent:u,side:h,...f},d)=>{dt({ImageMaterial:r0});const p=A.useRef(null),m=Z(E=>E.size),g=Array.isArray(i)?[i[0],i[1]]:[i,i],y=[c.image.width,c.image.height],v=Math.max(m.width,m.height);return A.useImperativeHandle(d,()=>p.current,[]),A.useLayoutEffect(()=>{p.current.geometry.parameters&&p.current.material.scale.set(g[0]*p.current.geometry.parameters.width,g[1]*p.current.geometry.parameters.height)},[]),A.createElement("mesh",ie({ref:p,scale:Array.isArray(i)?[...i,1]:i},f),A.createElement("planeGeometry",{args:[1,1,t,t]}),A.createElement("imageMaterial",{color:e,map:c,zoom:s,grayscale:r,opacity:o,scale:g,imageBounds:y,resolution:v,radius:a,toneMapped:l,transparent:u,side:h,key:r0.key}),n)}),kC=A.forwardRef(({url:n,...e},t)=>{const i=pn(n);return A.createElement(Tp,ie({},e,{texture:i,ref:t}))}),OC=A.forwardRef(({url:n,...e},t)=>A.createElement(Tp,ie({},e,{ref:t}))),x_=A.forwardRef((n,e)=>{if(n.url)return A.createElement(kC,ie({},n,{ref:e}));if(n.texture)return A.createElement(OC,ie({},n,{ref:e}));throw new Error("<Image /> requires a url or texture")}),UC=A.forwardRef(({threshold:n=15,geometry:e,...t},i)=>{const s=A.useRef(null);A.useImperativeHandle(i,()=>s.current,[]);const r=A.useMemo(()=>[0,0,0,1,0,0],[]),o=A.useRef(),a=A.useRef();return A.useLayoutEffect(()=>{const c=s.current.parent,l=e??(c==null?void 0:c.geometry);if(!l||o.current===l&&a.current===n)return;o.current=l,a.current=n;const h=new Uy(l,n).attributes.position.array;s.current.geometry.setPositions(h),s.current.geometry.attributes.instanceStart.needsUpdate=!0,s.current.geometry.attributes.instanceEnd.needsUpdate=!0,s.current.computeLineDistances()}),A.createElement(cs,ie({segments:!0,points:r,ref:s,raycast:()=>null},t))}),o0=Ri({screenspace:!1,color:new xe("black"),opacity:1,thickness:.05,size:new de},`#include <common>
   #include <morphtarget_pars_vertex>
   #include <skinning_pars_vertex>
   uniform float thickness;
   uniform bool screenspace;
   uniform vec2 size;
   void main() {
     #if defined (USE_SKINNING)
	     #include <beginnormal_vertex>
       #include <morphnormal_vertex>
       #include <skinbase_vertex>
       #include <skinnormal_vertex>
       #include <defaultnormal_vertex>
     #endif
     #include <begin_vertex>
	   #include <morphtarget_vertex>
	   #include <skinning_vertex>
     #include <project_vertex>
     vec4 tNormal = vec4(normal, 0.0);
     vec4 tPosition = vec4(transformed, 1.0);
     #ifdef USE_INSTANCING
       tNormal = instanceMatrix * tNormal;
       tPosition = instanceMatrix * tPosition;
     #endif
     if (screenspace) {
       vec3 newPosition = tPosition.xyz + tNormal.xyz * thickness;
       gl_Position = projectionMatrix * modelViewMatrix * vec4(newPosition, 1.0); 
     } else {
       vec4 clipPosition = projectionMatrix * modelViewMatrix * tPosition;
       vec4 clipNormal = projectionMatrix * modelViewMatrix * tNormal;
       vec2 offset = normalize(clipNormal.xy) * thickness / size * clipPosition.w * 2.0;
       clipPosition.xy += offset;
       gl_Position = clipPosition;
     }
   }`,`uniform vec3 color;
   uniform float opacity;
   void main(){
     gl_FragColor = vec4(color, opacity);
     #include <tonemapping_fragment>
     #include <${qt>=154?"colorspace_fragment":"encodings_fragment"}>
   }`);function C_({color:n="black",opacity:e=1,transparent:t=!1,screenspace:i=!1,toneMapped:s=!0,polygonOffset:r=!1,polygonOffsetFactor:o=0,renderOrder:a=0,thickness:c=.05,angle:l=Math.PI,...u}){const h=A.useRef(),[f]=A.useState(()=>new o0({side:Cr})),{gl:d}=Z(),p=d.getDrawingBufferSize(new de);A.useMemo(()=>dt({OutlinesMaterial:o0}),[]);const m=A.useRef(0),g=A.useRef();return A.useLayoutEffect(()=>{const y=h.current;if(!y)return;const v=y.parent;if(v&&v.geometry&&(m.current!==l||g.current!==v.geometry)){var E;m.current=l,g.current=v.geometry;let C=(E=y.children)==null?void 0:E[0];C&&(l&&C.geometry.dispose(),y.remove(C)),v.skeleton?(C=new Mh,C.material=f,C.bind(v.skeleton,v.bindMatrix),y.add(C)):v.isInstancedMesh?(C=new Rh(v.geometry,f,v.count),C.instanceMatrix=v.instanceMatrix,y.add(C)):(C=new ye,C.material=f,y.add(C)),C.geometry=l?z1(v.geometry,l):v.geometry}}),A.useLayoutEffect(()=>{const y=h.current;if(!y)return;const v=y.children[0];v&&(v.renderOrder=a,Ss(v.material,{transparent:t,thickness:c,color:n,opacity:e,size:p,screenspace:i,toneMapped:s,polygonOffset:r,polygonOffsetFactor:o}))}),A.useEffect(()=>()=>{const y=h.current;if(!y)return;const v=y.children[0];v&&(l&&v.geometry.dispose(),y.remove(v))},[]),A.createElement("group",ie({ref:h},u))}var QC=Object.defineProperty,NC=(n,e,t)=>e in n?QC(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,He=(n,e,t)=>(NC(n,typeof e!="symbol"?e+"":e,t),t);function bl(n,e,t,i,s){let r;if(n=n.subarray||n.slice?n:n.buffer,t=t.subarray||t.slice?t:t.buffer,n=e?n.subarray?n.subarray(e,s&&e+s):n.slice(e,s&&e+s):n,t.set)t.set(n,i);else for(r=0;r<n.length;r++)t[r+i]=n[r];return t}function GC(n){return n instanceof Float32Array?n:n instanceof St?n.getAttribute("position").array:n.map(e=>{const t=Array.isArray(e);return e instanceof b?[e.x,e.y,e.z]:e instanceof de?[e.x,e.y,0]:t&&e.length===3?[e[0],e[1],e[2]]:t&&e.length===2?[e[0],e[1],0]:e}).flat()}class zC extends St{constructor(){super(),He(this,"type","MeshLine"),He(this,"isMeshLine",!0),He(this,"positions",[]),He(this,"previous",[]),He(this,"next",[]),He(this,"side",[]),He(this,"width",[]),He(this,"indices_array",[]),He(this,"uvs",[]),He(this,"counters",[]),He(this,"widthCallback",null),He(this,"_attributes"),He(this,"_points",[]),He(this,"points"),He(this,"matrixWorld",new ce),Object.defineProperties(this,{points:{enumerable:!0,get(){return this._points},set(e){this.setPoints(e,this.widthCallback)}}})}setMatrixWorld(e){this.matrixWorld=e}setPoints(e,t){if(e=GC(e),this._points=e,this.widthCallback=t??null,this.positions=[],this.counters=[],e.length&&e[0]instanceof b)for(let i=0;i<e.length;i++){const s=e[i],r=i/(e.length-1);this.positions.push(s.x,s.y,s.z),this.positions.push(s.x,s.y,s.z),this.counters.push(r),this.counters.push(r)}else for(let i=0;i<e.length;i+=3){const s=i/(e.length-1);this.positions.push(e[i],e[i+1],e[i+2]),this.positions.push(e[i],e[i+1],e[i+2]),this.counters.push(s),this.counters.push(s)}this.process()}compareV3(e,t){const i=e*6,s=t*6;return this.positions[i]===this.positions[s]&&this.positions[i+1]===this.positions[s+1]&&this.positions[i+2]===this.positions[s+2]}copyV3(e){const t=e*6;return[this.positions[t],this.positions[t+1],this.positions[t+2]]}process(){const e=this.positions.length/6;this.previous=[],this.next=[],this.side=[],this.width=[],this.indices_array=[],this.uvs=[];let t,i;this.compareV3(0,e-1)?i=this.copyV3(e-2):i=this.copyV3(0),this.previous.push(i[0],i[1],i[2]),this.previous.push(i[0],i[1],i[2]);for(let s=0;s<e;s++){if(this.side.push(1),this.side.push(-1),this.widthCallback?t=this.widthCallback(s/(e-1)):t=1,this.width.push(t),this.width.push(t),this.uvs.push(s/(e-1),0),this.uvs.push(s/(e-1),1),s<e-1){i=this.copyV3(s),this.previous.push(i[0],i[1],i[2]),this.previous.push(i[0],i[1],i[2]);const r=s*2;this.indices_array.push(r,r+1,r+2),this.indices_array.push(r+2,r+1,r+3)}s>0&&(i=this.copyV3(s),this.next.push(i[0],i[1],i[2]),this.next.push(i[0],i[1],i[2]))}this.compareV3(e-1,0)?i=this.copyV3(1):i=this.copyV3(e-1),this.next.push(i[0],i[1],i[2]),this.next.push(i[0],i[1],i[2]),!this._attributes||this._attributes.position.count!==this.counters.length?this._attributes={position:new Ye(new Float32Array(this.positions),3),previous:new Ye(new Float32Array(this.previous),3),next:new Ye(new Float32Array(this.next),3),side:new Ye(new Float32Array(this.side),1),width:new Ye(new Float32Array(this.width),1),uv:new Ye(new Float32Array(this.uvs),2),index:new Ye(new Uint16Array(this.indices_array),1),counters:new Ye(new Float32Array(this.counters),1)}:(this._attributes.position.copyArray(new Float32Array(this.positions)),this._attributes.position.needsUpdate=!0,this._attributes.previous.copyArray(new Float32Array(this.previous)),this._attributes.previous.needsUpdate=!0,this._attributes.next.copyArray(new Float32Array(this.next)),this._attributes.next.needsUpdate=!0,this._attributes.side.copyArray(new Float32Array(this.side)),this._attributes.side.needsUpdate=!0,this._attributes.width.copyArray(new Float32Array(this.width)),this._attributes.width.needsUpdate=!0,this._attributes.uv.copyArray(new Float32Array(this.uvs)),this._attributes.uv.needsUpdate=!0,this._attributes.index.copyArray(new Uint16Array(this.indices_array)),this._attributes.index.needsUpdate=!0),this.setAttribute("position",this._attributes.position),this.setAttribute("previous",this._attributes.previous),this.setAttribute("next",this._attributes.next),this.setAttribute("side",this._attributes.side),this.setAttribute("width",this._attributes.width),this.setAttribute("uv",this._attributes.uv),this.setAttribute("counters",this._attributes.counters),this.setAttribute("position",this._attributes.position),this.setAttribute("previous",this._attributes.previous),this.setAttribute("next",this._attributes.next),this.setAttribute("side",this._attributes.side),this.setAttribute("width",this._attributes.width),this.setAttribute("uv",this._attributes.uv),this.setAttribute("counters",this._attributes.counters),this.setIndex(this._attributes.index),this.computeBoundingSphere(),this.computeBoundingBox()}advance({x:e,y:t,z:i}){const s=this._attributes.position.array,r=this._attributes.previous.array,o=this._attributes.next.array,a=s.length;bl(s,0,r,0,a),bl(s,6,s,0,a-6),s[a-6]=e,s[a-5]=t,s[a-4]=i,s[a-3]=e,s[a-2]=t,s[a-1]=i,bl(s,6,o,0,a-6),o[a-6]=e,o[a-5]=t,o[a-4]=i,o[a-3]=e,o[a-2]=t,o[a-1]=i,this._attributes.position.needsUpdate=!0,this._attributes.previous.needsUpdate=!0,this._attributes.next.needsUpdate=!0}}const HC=`
  #include <common>
  #include <logdepthbuf_pars_vertex>
  #include <fog_pars_vertex>
  #include <clipping_planes_pars_vertex>

  attribute vec3 previous;
  attribute vec3 next;
  attribute float side;
  attribute float width;
  attribute float counters;
  
  uniform vec2 resolution;
  uniform float lineWidth;
  uniform vec3 color;
  uniform float opacity;
  uniform float sizeAttenuation;
  
  varying vec2 vUV;
  varying vec4 vColor;
  varying float vCounters;
  
  vec2 fix(vec4 i, float aspect) {
    vec2 res = i.xy / i.w;
    res.x *= aspect;
    return res;
  }
  
  void main() {
    float aspect = resolution.x / resolution.y;
    vColor = vec4(color, opacity);
    vUV = uv;
    vCounters = counters;
  
    mat4 m = projectionMatrix * modelViewMatrix;
    vec4 finalPosition = m * vec4(position, 1.0) * aspect;
    vec4 prevPos = m * vec4(previous, 1.0);
    vec4 nextPos = m * vec4(next, 1.0);
  
    vec2 currentP = fix(finalPosition, aspect);
    vec2 prevP = fix(prevPos, aspect);
    vec2 nextP = fix(nextPos, aspect);
  
    float w = lineWidth * width;
  
    vec2 dir;
    if (nextP == currentP) dir = normalize(currentP - prevP);
    else if (prevP == currentP) dir = normalize(nextP - currentP);
    else {
      vec2 dir1 = normalize(currentP - prevP);
      vec2 dir2 = normalize(nextP - currentP);
      dir = normalize(dir1 + dir2);
  
      vec2 perp = vec2(-dir1.y, dir1.x);
      vec2 miter = vec2(-dir.y, dir.x);
      //w = clamp(w / dot(miter, perp), 0., 4. * lineWidth * width);
    }
  
    //vec2 normal = (cross(vec3(dir, 0.), vec3(0., 0., 1.))).xy;
    vec4 normal = vec4(-dir.y, dir.x, 0., 1.);
    normal.xy *= .5 * w;
    //normal *= projectionMatrix;
    if (sizeAttenuation == 0.) {
      normal.xy *= finalPosition.w;
      normal.xy /= (vec4(resolution, 0., 1.) * projectionMatrix).xy * aspect;
    }
  
    finalPosition.xy += normal.xy * side;
    gl_Position = finalPosition;
    #include <logdepthbuf_vertex>
    #include <fog_vertex>
    vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
    #include <clipping_planes_vertex>
    #include <fog_vertex>
  }
`,KC=parseInt(xr.replace(/\D+/g,"")),VC=KC>=154?"colorspace_fragment":"encodings_fragment",YC=`
  #include <fog_pars_fragment>
  #include <logdepthbuf_pars_fragment>
  #include <clipping_planes_pars_fragment>
  
  uniform sampler2D map;
  uniform sampler2D alphaMap;
  uniform float useGradient;
  uniform float useMap;
  uniform float useAlphaMap;
  uniform float useDash;
  uniform float dashArray;
  uniform float dashOffset;
  uniform float dashRatio;
  uniform float visibility;
  uniform float alphaTest;
  uniform vec2 repeat;
  uniform vec3 gradient[2];
  
  varying vec2 vUV;
  varying vec4 vColor;
  varying float vCounters;
  
  void main() {
    #include <logdepthbuf_fragment>
    vec4 diffuseColor = vColor;
    if (useGradient == 1.) diffuseColor = vec4(mix(gradient[0], gradient[1], vCounters), 1.0);
    if (useMap == 1.) diffuseColor *= texture2D(map, vUV * repeat);
    if (useAlphaMap == 1.) diffuseColor.a *= texture2D(alphaMap, vUV * repeat).a;
    if (diffuseColor.a < alphaTest) discard;
    if (useDash == 1.) diffuseColor.a *= ceil(mod(vCounters + dashOffset, dashArray) - (dashArray * dashRatio));
    diffuseColor.a *= step(vCounters, visibility);
    #include <clipping_planes_fragment>
    gl_FragColor = diffuseColor;     
    #include <fog_fragment>
    #include <tonemapping_fragment>
    #include <${VC}>
  }
`;class $C extends Dt{constructor(e){super({uniforms:{...Yu.fog,lineWidth:{value:1},map:{value:null},useMap:{value:0},alphaMap:{value:null},useAlphaMap:{value:0},color:{value:new xe(16777215)},gradient:{value:[new xe(16711680),new xe(65280)]},opacity:{value:1},resolution:{value:new de(1,1)},sizeAttenuation:{value:1},dashArray:{value:0},dashOffset:{value:0},dashRatio:{value:.5},useDash:{value:0},useGradient:{value:0},visibility:{value:1},alphaTest:{value:0},repeat:{value:new de(1,1)}},vertexShader:HC,fragmentShader:YC}),He(this,"lineWidth"),He(this,"map"),He(this,"useMap"),He(this,"alphaMap"),He(this,"useAlphaMap"),He(this,"color"),He(this,"gradient"),He(this,"resolution"),He(this,"sizeAttenuation"),He(this,"dashArray"),He(this,"dashOffset"),He(this,"dashRatio"),He(this,"useDash"),He(this,"useGradient"),He(this,"visibility"),He(this,"repeat"),this.type="MeshLineMaterial",Object.defineProperties(this,{lineWidth:{enumerable:!0,get(){return this.uniforms.lineWidth.value},set(t){this.uniforms.lineWidth.value=t}},map:{enumerable:!0,get(){return this.uniforms.map.value},set(t){this.uniforms.map.value=t}},useMap:{enumerable:!0,get(){return this.uniforms.useMap.value},set(t){this.uniforms.useMap.value=t}},alphaMap:{enumerable:!0,get(){return this.uniforms.alphaMap.value},set(t){this.uniforms.alphaMap.value=t}},useAlphaMap:{enumerable:!0,get(){return this.uniforms.useAlphaMap.value},set(t){this.uniforms.useAlphaMap.value=t}},color:{enumerable:!0,get(){return this.uniforms.color.value},set(t){this.uniforms.color.value=t}},gradient:{enumerable:!0,get(){return this.uniforms.gradient.value},set(t){this.uniforms.gradient.value=t}},opacity:{enumerable:!0,get(){return this.uniforms.opacity.value},set(t){this.uniforms.opacity.value=t}},resolution:{enumerable:!0,get(){return this.uniforms.resolution.value},set(t){this.uniforms.resolution.value.copy(t)}},sizeAttenuation:{enumerable:!0,get(){return this.uniforms.sizeAttenuation.value},set(t){this.uniforms.sizeAttenuation.value=t}},dashArray:{enumerable:!0,get(){return this.uniforms.dashArray.value},set(t){this.uniforms.dashArray.value=t,this.useDash=t!==0?1:0}},dashOffset:{enumerable:!0,get(){return this.uniforms.dashOffset.value},set(t){this.uniforms.dashOffset.value=t}},dashRatio:{enumerable:!0,get(){return this.uniforms.dashRatio.value},set(t){this.uniforms.dashRatio.value=t}},useDash:{enumerable:!0,get(){return this.uniforms.useDash.value},set(t){this.uniforms.useDash.value=t}},useGradient:{enumerable:!0,get(){return this.uniforms.useGradient.value},set(t){this.uniforms.useGradient.value=t}},visibility:{enumerable:!0,get(){return this.uniforms.visibility.value},set(t){this.uniforms.visibility.value=t}},alphaTest:{enumerable:!0,get(){return this.uniforms.alphaTest.value},set(t){this.uniforms.alphaTest.value=t}},repeat:{enumerable:!0,get(){return this.uniforms.repeat.value},set(t){this.uniforms.repeat.value.copy(t)}}}),this.setValues(e)}copy(e){return super.copy(e),this.lineWidth=e.lineWidth,this.map=e.map,this.useMap=e.useMap,this.alphaMap=e.alphaMap,this.useAlphaMap=e.useAlphaMap,this.color.copy(e.color),this.gradient=e.gradient,this.opacity=e.opacity,this.resolution.copy(e.resolution),this.sizeAttenuation=e.sizeAttenuation,this.dashArray=e.dashArray,this.dashOffset=e.dashOffset,this.dashRatio=e.dashRatio,this.useDash=e.useDash,this.useGradient=e.useGradient,this.visibility=e.visibility,this.alphaTest=e.alphaTest,this.repeat.copy(e.repeat),this}}const Bp={width:.2,length:1,decay:1,local:!1,stride:0,interval:1},WC=(n,e=1)=>(n.set(n.subarray(e)),n.fill(-1/0,-e),n);function jC(n,e){const{length:t,local:i,decay:s,interval:r,stride:o}={...Bp,...e},a=A.useRef(),[c]=A.useState(()=>new b);A.useLayoutEffect(()=>{n&&(a.current=Float32Array.from({length:t*10*3},(h,f)=>n.position.getComponent(f%3)))},[t,n]);const l=A.useRef(new b),u=A.useRef(0);return Ee(()=>{if(n&&a.current){if(u.current===0){let h;i?h=n.position:(n.getWorldPosition(c),h=c);const f=1*s;for(let d=0;d<f;d++)h.distanceTo(l.current)<o||(WC(a.current,3),a.current.set(h.toArray(),a.current.length-3));l.current.copy(h)}u.current++,u.current=u.current%r}}),a}const I_=A.forwardRef((n,e)=>{const{children:t}=n,{width:i,length:s,decay:r,local:o,stride:a,interval:c}={...Bp,...n},{color:l="hotpink",attenuation:u,target:h}=n,f=Z(C=>C.size),d=Z(C=>C.scene),p=A.useRef(null),[m,g]=A.useState(null),y=jC(m,{length:s,decay:r,local:o,stride:a,interval:c});A.useEffect(()=>{const C=(h==null?void 0:h.current)||p.current.children.find(x=>x instanceof lt);C&&g(C)},[y,h]);const v=A.useMemo(()=>new zC,[]),E=A.useMemo(()=>{var C;const x=new $C({lineWidth:.1*i,color:l,sizeAttenuation:1,resolution:new de(f.width,f.height)});let I;if(t)if(Array.isArray(t))I=t.find(S=>{const w=S;return typeof w.type=="string"&&w.type==="meshLineMaterial"});else{const S=t;typeof S.type=="string"&&S.type==="meshLineMaterial"&&(I=S)}return typeof((C=I)==null?void 0:C.props)=="object"&&x.setValues(I.props),x},[i,l,f,t]);return A.useEffect(()=>{E.uniforms.resolution.value.set(f.width,f.height)},[f]),Ee(()=>{y.current&&v.setPoints(y.current,u)}),A.createElement("group",null,Ir(A.createElement("mesh",{ref:e,geometry:v,material:E}),d),A.createElement("group",{ref:p},t))});function JC(n,e=16,t,i,s){const[r,o]=A.useState(()=>{const a=Array.from({length:e},()=>[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]).flat();return new lc(Float32Array.from(a),16)});return A.useLayoutEffect(()=>{if(typeof n.current>"u")return;const a=new jv(n.current);i&&a.setWeightAttribute(i),a.build();const c=new b,l=new b,u=new xe,h=new lt;n.current.updateMatrixWorld(!0);for(let f=0;f<e;f++)a.sample(c,l,u),typeof t=="function"?t({dummy:h,sampledMesh:n.current,position:c,normal:l,color:u},f):h.position.copy(c),h.updateMatrix(),s!=null&&s.current&&s.current.setMatrixAt(f,h.matrix),h.matrix.toArray(r.array,f*16);s!=null&&s.current&&(s.current.instanceMatrix.needsUpdate=!0),r.needsUpdate=!0,o(new lc(r.array,r.itemSize).copy(r))},[n,s,i,e,t]),r}function S_({children:n,weight:e,transform:t,instances:i,mesh:s,count:r=16,...o}){const a=A.useRef(null),c=A.useRef(null),l=A.useRef(null);return A.useLayoutEffect(()=>{var u,h;c.current=(u=i==null?void 0:i.current)!==null&&u!==void 0?u:a.current.children.find(f=>f.hasOwnProperty("instanceMatrix")),l.current=(h=s==null?void 0:s.current)!==null&&h!==void 0?h:a.current.children.find(f=>f.type==="Mesh")},[n,s==null?void 0:s.current,i==null?void 0:i.current]),JC(l,r,t,e,c),A.createElement("group",ie({ref:a},o),n)}const w_=({compute:n,name:e,...t})=>{const[i]=A.useState(()=>new Ye(new Float32Array(0),1)),s=A.useRef(null);return A.useLayoutEffect(()=>{if(s.current){var r;const o=(r=s.current.parent)!==null&&r!==void 0?r:s.current.__r3f.parent,a=n(o);s.current.copy(a)}},[n]),A.createElement("primitive",ie({ref:s,object:i,attach:`attributes-${e}`},t))};function qC(n,{keys:e=["near","far","color","distance","decay","penumbra","angle","intensity","skeleton","visible","castShadow","receiveShadow","morphTargetDictionary","morphTargetInfluences","name","geometry","material","position","rotation","scale","up","userData","bindMode","bindMatrix","bindMatrixInverse","skeleton"],deep:t,inject:i,castShadow:s,receiveShadow:r}){let o={};for(const a of e)o[a]=n[a];return t&&(o.geometry&&t!=="materialsOnly"&&(o.geometry=o.geometry.clone()),o.material&&t!=="geometriesOnly"&&(o.material=o.material.clone())),i&&(typeof i=="function"?o={...o,children:i(n)}:A.isValidElement(i)?o={...o,children:i}:o={...o,...i}),n instanceof ye&&(s&&(o.castShadow=!0),r&&(o.receiveShadow=!0)),o}const mc=A.forwardRef(({isChild:n=!1,object:e,children:t,deep:i,castShadow:s,receiveShadow:r,inject:o,keys:a,...c},l)=>{const u={keys:a,deep:i,inject:o,castShadow:s,receiveShadow:r};if(e=A.useMemo(()=>{if(n===!1&&!Array.isArray(e)){let p=!1;if(e.traverse(m=>{m.isSkinnedMesh&&(p=!0)}),p)return Wv.clone(e)}return e},[e,n]),Array.isArray(e))return A.createElement("group",ie({},c,{ref:l}),e.map(p=>A.createElement(mc,ie({key:p.uuid,object:p},u))),t);const{children:h,...f}=qC(e,u),d=e.type[0].toLowerCase()+e.type.slice(1);return A.createElement(d,ie({},f,c,{ref:l}),e.children.map(p=>p.type==="Bone"?A.createElement("primitive",ie({key:p.uuid,object:p},u)):A.createElement(mc,ie({key:p.uuid,object:p},u,{isChild:!0}))),t,h)}),Zh=A.createContext(null),T_=A.forwardRef(({resolution:n=28,maxPolyCount:e=1e4,enableUvs:t=!1,enableColors:i=!1,children:s,...r},o)=>{const a=A.useRef(null);A.useImperativeHandle(o,()=>a.current,[]);const c=A.useMemo(()=>new Qv(n,null,t,i,e),[n,e,t,i]),l=A.useMemo(()=>({getParent:()=>a}),[]);return Ee(()=>{c.update(),c.reset()},-1),A.createElement(A.Fragment,null,A.createElement("primitive",ie({object:c,ref:a},r),A.createElement(Zh.Provider,{value:l},s)))}),B_=A.forwardRef(({strength:n=.5,subtract:e=12,color:t,...i},s)=>{const{getParent:r}=A.useContext(Zh),o=A.useMemo(()=>r(),[r]),a=A.useRef(null);A.useImperativeHandle(s,()=>a.current,[]);const c=new b;return Ee(l=>{!o.current||!a.current||(a.current.getWorldPosition(c),o.current.addBall(.5+c.x*.5,.5+c.y*.5,.5+c.z*.5,n,e,t))}),A.createElement("group",ie({ref:a},i))}),__=A.forwardRef(({planeType:n="x",strength:e=.5,subtract:t=12,...i},s)=>{const{getParent:r}=A.useContext(Zh),o=A.useMemo(()=>r(),[r]),a=A.useRef(null);A.useImperativeHandle(s,()=>a.current,[]);const c=A.useMemo(()=>n==="x"?"addPlaneX":n==="y"?"addPlaneY":"addPlaneZ",[n]);return Ee(()=>{!o.current||!a.current||o.current[c](e,t)}),A.createElement("group",ie({ref:a},i))});function XC(n){return Array.isArray(n)}function Rl(n=[0,0,0]){return XC(n)?n:n instanceof b||n instanceof ai?[n.x,n.y,n.z]:[n,n,n]}const b_=A.forwardRef(function({debug:e,depthTest:t=!1,polygonOffsetFactor:i=-10,map:s,mesh:r,children:o,position:a,rotation:c,scale:l,...u},h){const f=A.useRef(null);A.useImperativeHandle(h,()=>f.current);const d=A.useRef(null),p=A.useRef({position:new b,rotation:new ai,scale:new b(1,1,1)});return A.useLayoutEffect(()=>{const m=(r==null?void 0:r.current)||f.current.parent,g=f.current;if(!(m instanceof ye))throw new Error('Decal must have a Mesh as parent or specify its "mesh" prop');if(m){Ss(p.current,{position:a,scale:l});const y=m.matrixWorld.clone();if(m.matrixWorld.identity(),!c||typeof c=="number"){const v=new lt;v.position.copy(p.current.position);const E=m.geometry.attributes.position.array;m.geometry.attributes.normal===void 0&&m.geometry.computeVertexNormals();const C=m.geometry.attributes.normal.array;let x=1/0;new b;let I=new b;const S=v.position.x,w=v.position.y,B=v.position.z,T=E.length;let R=-1;for(let _=0;_<T;_+=3){const L=E[_],O=E[_+1],U=E[_+2],Q=L-S,G=O-w,z=U-B,H=Q*Q+G*G+z*z;H<x&&(x=H,R=_)}I.fromArray(C,R),v.lookAt(v.position.clone().add(I)),v.rotateZ(Math.PI),v.rotateY(Math.PI),typeof c=="number"&&v.rotateZ(c),Ss(p.current,{rotation:v.rotation})}else Ss(p.current,{rotation:c});return g.geometry=new p4(m,p.current.position,p.current.rotation,p.current.scale),m.matrixWorld=y,()=>{g.geometry.dispose()}}},[r,...Rl(a),...Rl(l),...Rl(c)]),A.useLayoutEffect(()=>{d.current&&(Ss(d.current,p.current),d.current.traverse(m=>m.raycast=()=>null))},[e]),A.createElement("mesh",ie({ref:f,"material-transparent":!0,"material-polygonOffset":!0,"material-polygonOffsetFactor":i,"material-depthTest":t,"material-map":s},u),o,e&&A.createElement("mesh",{ref:d},A.createElement("boxGeometry",null),A.createElement("meshNormalMaterial",{wireframe:!0}),A.createElement("axesHelper",null)))}),R_=A.forwardRef(function({src:e,skipFill:t,skipStrokes:i,fillMaterial:s,strokeMaterial:r,fillMeshProps:o,strokeMeshProps:a,...c},l){const u=gt(Io,e.startsWith("<svg")?`data:image/svg+xml;utf8,${e}`:e),h=A.useMemo(()=>i?[]:u.paths.map(d=>{var p;return((p=d.userData)==null?void 0:p.style.stroke)===void 0||d.userData.style.stroke==="none"?null:d.subPaths.map(m=>Io.pointsToStroke(m.getPoints(),d.userData.style))}),[u,i]);A.useEffect(()=>()=>h.forEach(d=>d&&d.map(p=>p.dispose())),[h]);let f=0;return A.createElement("object3D",ie({ref:l},c),A.createElement("object3D",{scale:[1,-1,1]},u.paths.map((d,p)=>{var m,g;return A.createElement(A.Fragment,{key:p},!t&&((m=d.userData)==null?void 0:m.style.fill)!==void 0&&d.userData.style.fill!=="none"&&Io.createShapes(d).map((y,v)=>A.createElement("mesh",ie({key:v},o,{renderOrder:f++}),A.createElement("shapeGeometry",{args:[y]}),A.createElement("meshBasicMaterial",ie({color:d.userData.style.fill,opacity:d.userData.style.fillOpacity,transparent:!0,side:Tt,depthWrite:!1},s)))),!i&&((g=d.userData)==null?void 0:g.style.stroke)!==void 0&&d.userData.style.stroke!=="none"&&d.subPaths.map((y,v)=>A.createElement("mesh",ie({key:v,geometry:h[p][v]},a,{renderOrder:f++}),A.createElement("meshBasicMaterial",ie({color:d.userData.style.stroke,opacity:d.userData.style.strokeOpacity,transparent:!0,side:Tt,depthWrite:!1},r)))))})))});let na=null,_p="https://www.gstatic.com/draco/versioned/decoders/1.5.5/";function bp(n=!0,e=!0,t){return i=>{t&&t(i),n&&(na||(na=new pC),na.setDecoderPath(typeof n=="string"?n:_p),i.setDRACOLoader(na)),e&&i.setMeshoptDecoder(typeof Bl=="function"?Bl():Bl)}}const Qc=(n,e,t,i)=>gt(Yh,n,bp(e,t,i));Qc.preload=(n,e,t,i)=>gt.preload(Yh,n,bp(e,t,i));Qc.clear=n=>gt.clear(Yh,n);Qc.setDecoderPath=n=>{_p=n};const D_=A.forwardRef(({src:n,useDraco:e,useMeshOpt:t,extendLoader:i,...s},r)=>{const{scene:o}=Qc(n,e,t,i);return A.createElement(mc,ie({ref:r},s,{object:o}))});function M_({renderIndex:n=1,bgColor:e="black",fgColor:t="white",characters:i=" .:-+*=%@#",invert:s=!0,color:r=!1,resolution:o=.15}){const{size:a,gl:c,scene:l,camera:u}=Z(),h=A.useMemo(()=>{const f=new C4(c,i,{invert:s,color:r,resolution:o});return f.domElement.style.position="absolute",f.domElement.style.top="0px",f.domElement.style.left="0px",f.domElement.style.pointerEvents="none",f},[i,s,r,o]);return A.useLayoutEffect(()=>{h.domElement.style.color=t,h.domElement.style.backgroundColor=e},[t,e]),A.useEffect(()=>(c.domElement.style.opacity="0",c.domElement.parentNode.appendChild(h.domElement),()=>{c.domElement.style.opacity="1",c.domElement.parentNode.removeChild(h.domElement)}),[h]),A.useEffect(()=>{h.setSize(a.width,a.height)},[h,a]),Ee(f=>{h.render(l,u)},n),A.createElement(A.Fragment,null)}const a0=Ri({alphaTest:0,viewport:new de(1980,1080),focal:1e3,centerAndScaleTexture:null,covAndColorTexture:null},`
    precision highp sampler2D;
    precision highp usampler2D;
    out vec4 vColor;
    out vec3 vPosition;
    uniform vec2 resolution;
    uniform vec2 viewport;
    uniform float focal;
    attribute uint splatIndex;
    uniform sampler2D centerAndScaleTexture;
    uniform usampler2D covAndColorTexture;    

    vec2 unpackInt16(in uint value) {
      int v = int(value);
      int v0 = v >> 16;
      int v1 = (v & 0xFFFF);
      if((v & 0x8000) != 0)
        v1 |= 0xFFFF0000;
      return vec2(float(v1), float(v0));
    }

    void main () {
      ivec2 texSize = textureSize(centerAndScaleTexture, 0);
      ivec2 texPos = ivec2(splatIndex%uint(texSize.x), splatIndex/uint(texSize.x));
      vec4 centerAndScaleData = texelFetch(centerAndScaleTexture, texPos, 0);
      vec4 center = vec4(centerAndScaleData.xyz, 1);
      vec4 camspace = modelViewMatrix * center;
      vec4 pos2d = projectionMatrix * camspace;

      float bounds = 1.2 * pos2d.w;
      if (pos2d.z < -pos2d.w || pos2d.x < -bounds || pos2d.x > bounds
        || pos2d.y < -bounds || pos2d.y > bounds) {
        gl_Position = vec4(0.0, 0.0, 2.0, 1.0);
        return;
      }

      uvec4 covAndColorData = texelFetch(covAndColorTexture, texPos, 0);
      vec2 cov3D_M11_M12 = unpackInt16(covAndColorData.x) * centerAndScaleData.w;
      vec2 cov3D_M13_M22 = unpackInt16(covAndColorData.y) * centerAndScaleData.w;
      vec2 cov3D_M23_M33 = unpackInt16(covAndColorData.z) * centerAndScaleData.w;
      mat3 Vrk = mat3(
        cov3D_M11_M12.x, cov3D_M11_M12.y, cov3D_M13_M22.x,
        cov3D_M11_M12.y, cov3D_M13_M22.y, cov3D_M23_M33.x,
        cov3D_M13_M22.x, cov3D_M23_M33.x, cov3D_M23_M33.y
      );

      mat3 J = mat3(
        focal / camspace.z, 0., -(focal * camspace.x) / (camspace.z * camspace.z),
        0., focal / camspace.z, -(focal * camspace.y) / (camspace.z * camspace.z),
        0., 0., 0.
      );

      mat3 W = transpose(mat3(modelViewMatrix));
      mat3 T = W * J;
      mat3 cov = transpose(T) * Vrk * T;
      vec2 vCenter = vec2(pos2d) / pos2d.w;
      float diagonal1 = cov[0][0] + 0.3;
      float offDiagonal = cov[0][1];
      float diagonal2 = cov[1][1] + 0.3;
      float mid = 0.5 * (diagonal1 + diagonal2);
      float radius = length(vec2((diagonal1 - diagonal2) / 2.0, offDiagonal));
      float lambda1 = mid + radius;
      float lambda2 = max(mid - radius, 0.1);
      vec2 diagonalVector = normalize(vec2(offDiagonal, lambda1 - diagonal1));
      vec2 v1 = min(sqrt(2.0 * lambda1), 1024.0) * diagonalVector;
      vec2 v2 = min(sqrt(2.0 * lambda2), 1024.0) * vec2(diagonalVector.y, -diagonalVector.x);
      uint colorUint = covAndColorData.w;
      vColor = vec4(
        float(colorUint & uint(0xFF)) / 255.0,
        float((colorUint >> uint(8)) & uint(0xFF)) / 255.0,
        float((colorUint >> uint(16)) & uint(0xFF)) / 255.0,
        float(colorUint >> uint(24)) / 255.0
      );
      vPosition = position;

      gl_Position = vec4(
        vCenter 
          + position.x * v2 / viewport * 2.0 
          + position.y * v1 / viewport * 2.0, pos2d.z / pos2d.w, 1.0);
    }
    `,`
    #include <alphatest_pars_fragment>
    #include <alphahash_pars_fragment>
    in vec4 vColor;
    in vec3 vPosition;
    void main () {
      float A = -dot(vPosition.xy, vPosition.xy);
      if (A < -4.0) discard;
      float B = exp(A) * vColor.a;
      vec4 diffuseColor = vec4(vColor.rgb, B);
      #include <alphatest_fragment>
      #include <alphahash_fragment>
      gl_FragColor = diffuseColor;
      #include <tonemapping_fragment>
      #include <${parseInt(xr.replace(/\D+/g,""))>=154?"colorspace_fragment":"encodings_fragment"}>
    }
  `);function ZC(n){let e=null,t=0;function i(s,r=!1){const o=e.length/16,a=-1e-4;let c=-1/0,l=1/0;const u=new Float32Array(o),h=new Int32Array(u.buffer),f=new Int32Array(o);let d=0;for(let v=0;v<o;v++){const E=s[0]*e[v*16+12]+s[1]*e[v*16+13]+s[2]*e[v*16+14]+s[3];(r||E<0&&e[v*16+15]>a*E)&&(u[d]=E,f[d]=v,d++,E>c&&(c=E),E<l&&(l=E))}const p=(256*256-1)/(c-l),m=new Uint32Array(256*256);for(let v=0;v<d;v++)h[v]=(u[v]-l)*p|0,m[h[v]]++;const g=new Uint32Array(256*256);for(let v=1;v<256*256;v++)g[v]=g[v-1]+m[v-1];const y=new Uint32Array(d);for(let v=0;v<d;v++)y[g[h[v]]++]=f[v];return y}n.onmessage=s=>{if(s.data.method=="push"){t===0&&(e=new Float32Array(s.data.length));const r=new Float32Array(s.data.matrices);e.set(r,t),t+=r.length}else if(s.data.method=="sort"&&e!==null){const r=i(new Float32Array(s.data.view),s.data.hashed);n.postMessage({indices:r,key:s.data.key},[r.buffer])}}}class eI extends fn{constructor(...e){super(...e),this.gl=null,this.chunkSize=25e3}load(e,t,i,s){const r={gl:this.gl,url:this.manager.resolveURL(e),worker:new Worker(URL.createObjectURL(new Blob(["(",ZC.toString(),")(self)"],{type:"application/javascript"}))),manager:this.manager,update:(o,a,c)=>sI(a,r,o,c),connect:o=>nI(r,o),loading:!1,loaded:!1,loadedVertexCount:0,chunkSize:this.chunkSize,totalDownloadBytes:0,numVertices:0,rowLength:32,maxVertexes:0,bufferTextureWidth:0,bufferTextureHeight:0,stream:null,centerAndScaleData:null,covAndColorData:null,covAndColorTexture:null,centerAndScaleTexture:null,onProgress:i};tI(r).then(t).catch(o=>{s==null||s(o),r.manager.itemError(r.url)})}}async function tI(n){n.manager.itemStart(n.url);const e=await fetch(n.url);if(e.body===null)throw"Failed to fetch file";let t=e.headers.get("Content-Length");const i=t?parseInt(t):void 0;if(i==null)throw"Failed to get content length";n.stream=e.body.getReader(),n.totalDownloadBytes=i,n.numVertices=Math.floor(n.totalDownloadBytes/n.rowLength);const s=n.gl.getContext();let r=s.getParameter(s.MAX_TEXTURE_SIZE);return n.maxVertexes=r*r,n.numVertices>n.maxVertexes&&(n.numVertices=n.maxVertexes),n.bufferTextureWidth=r,n.bufferTextureHeight=Math.floor((n.numVertices-1)/r)+1,n.centerAndScaleData=new Float32Array(n.bufferTextureWidth*n.bufferTextureHeight*4),n.covAndColorData=new Uint32Array(n.bufferTextureWidth*n.bufferTextureHeight*4),n.centerAndScaleTexture=new ln(n.centerAndScaleData,n.bufferTextureWidth,n.bufferTextureHeight,jt,Jt),n.centerAndScaleTexture.needsUpdate=!0,n.covAndColorTexture=new ln(n.covAndColorData,n.bufferTextureWidth,n.bufferTextureHeight,uc,cr),n.covAndColorTexture.internalFormat="RGBA32UI",n.covAndColorTexture.needsUpdate=!0,n}async function iI(n){n.loading=!0;let e=0,t=0;const i=[];let s=0;const r=n.totalDownloadBytes!==0;for(;;)try{const{value:o,done:a}=await n.stream.read();if(a)break;if(e+=o.length,n.totalDownloadBytes!=null){const l=e/n.totalDownloadBytes*100;if(n.onProgress&&l-s>1){const u=new ProgressEvent("progress",{lengthComputable:r,loaded:e,total:n.totalDownloadBytes});n.onProgress(u),s=l}}i.push(o);const c=e-t;if(n.totalDownloadBytes!=null&&c>n.rowLength*n.chunkSize){let l=Math.floor(c/n.rowLength);const u=new Uint8Array(c);let h=0;for(const p of i)u.set(p,h),h+=p.length;if(i.length=0,c>l*n.rowLength){const p=new Uint8Array(c-l*n.rowLength);p.set(u.subarray(c-p.length,c),0),i.push(p)}const f=new Uint8Array(l*n.rowLength);f.set(u.subarray(0,f.byteLength),0);const d=c0(n,f.buffer,l);if(n.worker.postMessage({method:"push",src:n.url,length:n.numVertices*16,matrices:d.buffer},[d.buffer]),t+=l*n.rowLength,n.onProgress){const p=new ProgressEvent("progress",{lengthComputable:r,loaded:n.totalDownloadBytes,total:n.totalDownloadBytes});n.onProgress(p)}}}catch(o){console.error(o);break}if(e-t>0){let o=new Uint8Array(i.reduce((u,h)=>u+h.length,0)),a=0;for(const u of i)o.set(u,a),a+=u.length;let c=Math.floor(o.byteLength/n.rowLength);const l=c0(n,o.buffer,c);n.worker.postMessage({method:"push",src:n.url,length:c*16,matrices:l.buffer},[l.buffer])}n.loaded=!0,n.manager.itemEnd(n.url)}function sI(n,e,t,i){if(n.updateMatrixWorld(),e.gl.getCurrentViewport(t.viewport),t.material.viewport.x=t.viewport.z,t.material.viewport.y=t.viewport.w,t.material.focal=t.viewport.w/2*Math.abs(n.projectionMatrix.elements[5]),t.ready){if(i&&t.sorted)return;t.ready=!1;const s=new Float32Array([t.modelViewMatrix.elements[2],-t.modelViewMatrix.elements[6],t.modelViewMatrix.elements[10],t.modelViewMatrix.elements[14]]);e.worker.postMessage({method:"sort",src:e.url,key:t.uuid,view:s.buffer,hashed:i},[s.buffer]),i&&e.loaded&&(t.sorted=!0)}}function nI(n,e){n.loading||iI(n),e.ready=!1,e.pm=new ce,e.vm1=new ce,e.vm2=new ce,e.viewport=new ft;let t=new Uint32Array(n.bufferTextureWidth*n.bufferTextureHeight);const i=new lc(t,1,!1);i.setUsage(Gt);const s=e.geometry=new a1,r=new Float32Array(6*3),o=new Ye(r,3);s.setAttribute("position",o),o.setXYZ(2,-2,2,0),o.setXYZ(1,2,2,0),o.setXYZ(0,-2,-2,0),o.setXYZ(5,-2,-2,0),o.setXYZ(4,2,2,0),o.setXYZ(3,2,-2,0),o.needsUpdate=!0,s.setAttribute("splatIndex",i),s.instanceCount=1;function a(l){if(e&&l.data.key===e.uuid){let u=new Uint32Array(l.data.indices);s.attributes.splatIndex.set(u),s.attributes.splatIndex.needsUpdate=!0,s.instanceCount=u.length,e.ready=!0}}n.worker.addEventListener("message",a);async function c(){for(;;){const l=n.gl.properties.get(n.centerAndScaleTexture),u=n.gl.properties.get(n.covAndColorTexture);if(l!=null&&l.__webglTexture&&u!=null&&u.__webglTexture&&n.loadedVertexCount>0)break;await new Promise(h=>setTimeout(h,10))}e.ready=!0}return c(),()=>n.worker.removeEventListener("message",a)}function c0(n,e,t){const i=n.gl.getContext();if(n.loadedVertexCount+t>n.maxVertexes&&(t=n.maxVertexes-n.loadedVertexCount),t<=0)throw"Failed to parse file";const s=new Uint8Array(e),r=new Float32Array(e),o=new Float32Array(t*16),a=new Uint8Array(n.covAndColorData.buffer),c=new Int16Array(n.covAndColorData.buffer);for(let l=0;l<t;l++){const u=new Be(-(s[32*l+28+1]-128)/128,(s[32*l+28+2]-128)/128,(s[32*l+28+3]-128)/128,-(s[32*l+28+0]-128)/128);u.invert();const h=new b(r[8*l+0],r[8*l+1],-r[8*l+2]),f=new b(r[8*l+3+0],r[8*l+3+1],r[8*l+3+2]),d=new ce;d.makeRotationFromQuaternion(u),d.transpose(),d.scale(f);const p=d.clone();d.transpose(),d.premultiply(p),d.setPosition(h);const m=[0,1,2,5,6,10];let g=0;for(let E=0;E<m.length;E++)Math.abs(d.elements[m[E]])>g&&(g=Math.abs(d.elements[m[E]]));let y=n.loadedVertexCount*4+l*4;n.centerAndScaleData[y+0]=h.x,n.centerAndScaleData[y+1]=-h.y,n.centerAndScaleData[y+2]=h.z,n.centerAndScaleData[y+3]=g/32767,y=n.loadedVertexCount*8+l*4*2;for(let E=0;E<m.length;E++)c[y+E]=d.elements[m[E]]*32767/g;y=n.loadedVertexCount*16+(l*4+3)*4;const v=new xe(s[32*l+24+0]/255,s[32*l+24+1]/255,s[32*l+24+2]/255);v.convertSRGBToLinear(),a[y+0]=v.r*255,a[y+1]=v.g*255,a[y+2]=v.b*255,a[y+3]=s[32*l+24+3],d.elements[15]=Math.max(f.x,f.y,f.z)*s[32*l+24+3]/255;for(let E=0;E<16;E++)o[l*16+E]=d.elements[E]}for(;t>0;){let l=0,u=0;const h=n.loadedVertexCount%n.bufferTextureWidth,f=Math.floor(n.loadedVertexCount/n.bufferTextureWidth);n.loadedVertexCount%n.bufferTextureWidth!=0?(l=Math.min(n.bufferTextureWidth,h+t)-h,u=1):Math.floor(t/n.bufferTextureWidth)>0?(l=n.bufferTextureWidth,u=Math.floor(t/n.bufferTextureWidth)):(l=t%n.bufferTextureWidth,u=1);const d=n.gl.properties.get(n.centerAndScaleTexture);i.bindTexture(i.TEXTURE_2D,d.__webglTexture),i.texSubImage2D(i.TEXTURE_2D,0,h,f,l,u,i.RGBA,i.FLOAT,n.centerAndScaleData,n.loadedVertexCount*4);const p=n.gl.properties.get(n.covAndColorTexture);i.bindTexture(i.TEXTURE_2D,p.__webglTexture),i.texSubImage2D(i.TEXTURE_2D,0,h,f,l,u,i.RGBA_INTEGER,i.UNSIGNED_INT,n.covAndColorData,n.loadedVertexCount*4),n.gl.resetState(),n.loadedVertexCount+=l*u,t-=l*u}return o}function L_({src:n,toneMapped:e=!1,alphaTest:t=0,alphaHash:i=!1,chunkSize:s=25e3,...r}){dt({SplatMaterial:a0});const o=A.useRef(null),a=Z(u=>u.gl),c=Z(u=>u.camera),l=gt(eI,n,u=>{u.gl=a,u.chunkSize=s});return A.useLayoutEffect(()=>l.connect(o.current),[n]),Ee(()=>l.update(o.current,c,i)),A.createElement("mesh",ie({ref:o,frustumCulled:!1},r),A.createElement("splatMaterial",{key:`${n}/${t}/${i}${a0.key}`,transparent:!i,depthTest:!0,alphaTest:i?0:t,centerAndScaleTexture:l.centerAndScaleTexture,covAndColorTexture:l.covAndColorTexture,depthWrite:i?!0:t>0,blending:i?Qy:l1,blendSrcAlpha:u1,alphaHash:!!i,toneMapped:e}))}const rI=n=>typeof n=="function",oI=A.forwardRef(({envMap:n,resolution:e=256,frames:t=1/0,children:i,makeDefault:s,...r},o)=>{const a=Z(({set:g})=>g),c=Z(({camera:g})=>g),l=Z(({size:g})=>g),u=A.useRef(null);A.useImperativeHandle(o,()=>u.current,[]);const h=A.useRef(null),f=wi(e);A.useLayoutEffect(()=>{r.manual||u.current.updateProjectionMatrix()},[l,r]),A.useLayoutEffect(()=>{u.current.updateProjectionMatrix()}),A.useLayoutEffect(()=>{if(s){const g=c;return a(()=>({camera:u.current})),()=>a(()=>({camera:g}))}},[u,s,a]);let d=0,p=null;const m=rI(i);return Ee(g=>{m&&(t===1/0||d<t)&&(h.current.visible=!1,g.gl.setRenderTarget(f),p=g.scene.background,n&&(g.scene.background=n),g.gl.render(g.scene,u.current),g.scene.background=p,g.gl.setRenderTarget(null),h.current.visible=!0,d++)}),A.createElement(A.Fragment,null,A.createElement("orthographicCamera",ie({left:l.width/-2,right:l.width/2,top:l.height/2,bottom:l.height/-2,ref:u},r),!m&&i),A.createElement("group",{ref:h},m&&i(f.texture)))});function aI({resolution:n=256,near:e=.1,far:t=1e3,envMap:i,fog:s}={}){const r=Z(({gl:f})=>f),o=Z(({scene:f})=>f),a=A.useMemo(()=>{const f=new Fh(n);return f.texture.type=Qi,f},[n]);A.useEffect(()=>()=>{a.dispose()},[a]);const c=A.useMemo(()=>new h1(e,t,a),[e,t,a]);let l,u;const h=A.useCallback(()=>{l=o.fog,u=o.background,o.background=i||u,o.fog=s||l,c.update(r,o),o.fog=l,o.background=u},[r,o,c]);return{fbo:a,camera:c,update:h}}function P_({children:n,frames:e=1/0,resolution:t,near:i,far:s,envMap:r,fog:o,...a}){const c=A.useRef(null),{fbo:l,camera:u,update:h}=aI({resolution:t,near:i,far:s,envMap:r,fog:o});let f=0;return Ee(()=>{c.current&&(e===1/0||f<e)&&(c.current.visible=!1,h(),c.current.visible=!0,f++)}),A.createElement("group",a,A.createElement("primitive",{object:u}),A.createElement("group",{ref:c},n==null?void 0:n(l.texture)))}const F_=A.forwardRef((n,e)=>{const{camera:t,onChange:i,makeDefault:s,...r}=n,o=Z(f=>f.camera),a=Z(f=>f.invalidate),c=Z(f=>f.get),l=Z(f=>f.set),u=t||o,h=A.useMemo(()=>new fx(u),[u]);return A.useEffect(()=>{const f=d=>{a(),i&&i(d)};return h==null||h.addEventListener==null||h.addEventListener("change",f),()=>h==null||h.removeEventListener==null?void 0:h.removeEventListener("change",f)},[i,h,a]),Ee(()=>h==null?void 0:h.update(),-1),A.useEffect(()=>{const f=h;return f==null||f.connect(),()=>f==null?void 0:f.dispose()},[h]),A.useEffect(()=>{if(s){const f=c().controls;return l({controls:h}),()=>l({controls:f})}},[s,h]),h?A.createElement("primitive",ie({ref:e,object:h},r)):null}),k_=A.forwardRef(({domElement:n,...e},t)=>{const{onChange:i,makeDefault:s,...r}=e,o=Z(p=>p.invalidate),a=Z(p=>p.camera),c=Z(p=>p.gl),l=Z(p=>p.events),u=Z(p=>p.get),h=Z(p=>p.set),f=n||l.connected||c.domElement,d=A.useMemo(()=>new xx(a),[a]);return A.useEffect(()=>(d.connect(f),()=>void d.dispose()),[f,d,o]),A.useEffect(()=>{const p=m=>{o(),i&&i(m)};return d.addEventListener==null||d.addEventListener("change",p),()=>d.removeEventListener==null?void 0:d.removeEventListener("change",p)},[i,o]),A.useEffect(()=>{if(s){const p=u().controls;return h({controls:d}),()=>h({controls:p})}},[s,d]),Ee((p,m)=>d.update(m)),A.createElement("primitive",ie({ref:t,object:d,args:[a,f]},r))}),O_=A.forwardRef((n={enableDamping:!0},e)=>{const{domElement:t,camera:i,makeDefault:s,onChange:r,onStart:o,onEnd:a,...c}=n,l=Z(v=>v.invalidate),u=Z(v=>v.camera),h=Z(v=>v.gl),f=Z(v=>v.events),d=Z(v=>v.set),p=Z(v=>v.get),m=t||f.connected||h.domElement,g=i||u,y=A.useMemo(()=>new Ny(g),[g]);return A.useEffect(()=>{y.connect(m);const v=E=>{l(),r&&r(E)};return y.addEventListener("change",v),o&&y.addEventListener("start",o),a&&y.addEventListener("end",a),()=>{y.dispose(),y.removeEventListener("change",v),o&&y.removeEventListener("start",o),a&&y.removeEventListener("end",a)}},[r,o,a,y,l,m]),A.useEffect(()=>{if(s){const v=p().controls;return d({controls:y}),()=>d({controls:v})}},[s,y]),Ee(()=>y.update(),-1),A.createElement("primitive",ie({ref:e,object:y,enableDamping:!0},c))}),U_=A.forwardRef(({makeDefault:n,camera:e,domElement:t,regress:i,onChange:s,onStart:r,onEnd:o,...a},c)=>{const{invalidate:l,camera:u,gl:h,events:f,set:d,get:p,performance:m,viewport:g}=Z(),y=e||u,v=t||f.connected||h.domElement,E=A.useMemo(()=>new mx(y),[y]);return Ee(()=>{E.enabled&&E.update()},-1),A.useEffect(()=>(E.connect(v),()=>void E.dispose()),[v,i,E,l]),A.useEffect(()=>{const C=x=>{l(),i&&m.regress(),s&&s(x)};return E.addEventListener("change",C),r&&E.addEventListener("start",r),o&&E.addEventListener("end",o),()=>{r&&E.removeEventListener("start",r),o&&E.removeEventListener("end",o),E.removeEventListener("change",C)}},[s,r,o,E,l]),A.useEffect(()=>{E.handleResize()},[g]),A.useEffect(()=>{if(n){const C=p().controls;return d({controls:E}),()=>d({controls:C})}},[n,E]),A.createElement("primitive",ie({ref:c,object:E},a))}),Q_=A.forwardRef(({camera:n,makeDefault:e,regress:t,domElement:i,onChange:s,onStart:r,onEnd:o,...a},c)=>{const l=Z(E=>E.invalidate),u=Z(E=>E.camera),h=Z(E=>E.gl),f=Z(E=>E.events),d=Z(E=>E.set),p=Z(E=>E.get),m=Z(E=>E.performance),g=n||u,y=i||f.connected||h.domElement,v=A.useMemo(()=>new yx(g),[g]);return Ee(()=>{v.enabled&&v.update()},-1),A.useEffect(()=>(v.connect(y),()=>void v.dispose()),[y,t,v,l]),A.useEffect(()=>{const E=C=>{l(),t&&m.regress(),s&&s(C)};return v.addEventListener("change",E),r&&v.addEventListener("start",r),o&&v.addEventListener("end",o),()=>{v.removeEventListener("change",E),r&&v.removeEventListener("start",r),o&&v.removeEventListener("end",o)}},[s,r,o]),A.useEffect(()=>{if(e){const E=p().controls;return d({controls:v}),()=>d({controls:E})}},[e,v]),A.createElement("primitive",ie({ref:c,object:v},a))}),N_=A.forwardRef(({children:n,domElement:e,onChange:t,onMouseDown:i,onMouseUp:s,onObjectChange:r,object:o,makeDefault:a,camera:c,enabled:l,axis:u,mode:h,translationSnap:f,rotationSnap:d,scaleSnap:p,space:m,size:g,showX:y,showY:v,showZ:E,...C},x)=>{const I=Z(V=>V.controls),S=Z(V=>V.gl),w=Z(V=>V.events),B=Z(V=>V.camera),T=Z(V=>V.invalidate),R=Z(V=>V.get),_=Z(V=>V.set),L=c||B,O=e||w.connected||S.domElement,U=A.useMemo(()=>new tx(L,O),[L,O]),Q=A.useRef(null);A.useLayoutEffect(()=>(o?U.attach(o instanceof lt?o:o.current):Q.current instanceof lt&&U.attach(Q.current),()=>void U.detach()),[o,n,U]),A.useEffect(()=>{if(I){const V=$=>I.enabled=!$.value;return U.addEventListener("dragging-changed",V),()=>U.removeEventListener("dragging-changed",V)}},[U,I]);const G=A.useRef(),z=A.useRef(),H=A.useRef(),N=A.useRef();return A.useLayoutEffect(()=>void(G.current=t),[t]),A.useLayoutEffect(()=>void(z.current=i),[i]),A.useLayoutEffect(()=>void(H.current=s),[s]),A.useLayoutEffect(()=>void(N.current=r),[r]),A.useEffect(()=>{const V=k=>{T(),G.current==null||G.current(k)},$=k=>z.current==null?void 0:z.current(k),Y=k=>H.current==null?void 0:H.current(k),M=k=>N.current==null?void 0:N.current(k);return U.addEventListener("change",V),U.addEventListener("mouseDown",$),U.addEventListener("mouseUp",Y),U.addEventListener("objectChange",M),()=>{U.removeEventListener("change",V),U.removeEventListener("mouseDown",$),U.removeEventListener("mouseUp",Y),U.removeEventListener("objectChange",M)}},[T,U]),A.useEffect(()=>{if(a){const V=R().controls;return _({controls:U}),()=>_({controls:V})}},[a,U]),A.createElement(A.Fragment,null,A.createElement("primitive",{ref:x,object:U,enabled:l,axis:u,mode:h,translationSnap:f,rotationSnap:d,scaleSnap:p,space:m,size:g,showX:y,showY:v,showZ:E}),A.createElement("group",ie({ref:Q},C),n))}),G_=A.forwardRef(({domElement:n,selector:e,onChange:t,onLock:i,onUnlock:s,enabled:r=!0,makeDefault:o,...a},c)=>{const{camera:l,...u}=a,h=Z(x=>x.setEvents),f=Z(x=>x.gl),d=Z(x=>x.camera),p=Z(x=>x.invalidate),m=Z(x=>x.events),g=Z(x=>x.get),y=Z(x=>x.set),v=l||d,E=n||m.connected||f.domElement,C=A.useMemo(()=>new lx(v),[v]);return A.useEffect(()=>{if(r){C.connect(E);const x=g().events.compute;return h({compute(I,S){const w=S.size.width/2,B=S.size.height/2;S.pointer.set(w/S.size.width*2-1,-(B/S.size.height)*2+1),S.raycaster.setFromCamera(S.pointer,S.camera)}}),()=>{C.disconnect(),h({compute:x})}}},[r,C]),A.useEffect(()=>{const x=w=>{p(),t&&t(w)};C.addEventListener("change",x),i&&C.addEventListener("lock",i),s&&C.addEventListener("unlock",s);const I=()=>C.lock(),S=e?Array.from(document.querySelectorAll(e)):[document];return S.forEach(w=>w&&w.addEventListener("click",I)),()=>{C.removeEventListener("change",x),i&&C.removeEventListener("lock",i),s&&C.removeEventListener("unlock",s),S.forEach(w=>w?w.removeEventListener("click",I):void 0)}},[t,i,s,e,C,p]),A.useEffect(()=>{if(o){const x=g().controls;return y({controls:C}),()=>y({controls:x})}},[o,C]),A.createElement("primitive",ie({ref:c,object:C},u))}),z_=A.forwardRef(({domElement:n,makeDefault:e,...t},i)=>{const s=Z(h=>h.camera),r=Z(h=>h.gl),o=Z(h=>h.events),a=Z(h=>h.get),c=Z(h=>h.set),l=n||o.connected||r.domElement,[u]=A.useState(()=>new Xv(s,l));return A.useEffect(()=>{if(e){const h=a().controls;return c({controls:u}),()=>c({controls:h})}},[e,u]),Ee((h,f)=>{u.update(f)},-1),u?A.createElement("primitive",ie({ref:i,object:u},t)):null});/*!
 * camera-controls
 * https://github.com/yomotsu/camera-controls
 * (c) 2017 @yomotsu
 * Released under the MIT License.
 */const at={LEFT:1,RIGHT:2,MIDDLE:4},oe=Object.freeze({NONE:0,ROTATE:1,TRUCK:2,OFFSET:4,DOLLY:8,ZOOM:16,TOUCH_ROTATE:32,TOUCH_TRUCK:64,TOUCH_OFFSET:128,TOUCH_DOLLY:256,TOUCH_ZOOM:512,TOUCH_DOLLY_TRUCK:1024,TOUCH_DOLLY_OFFSET:2048,TOUCH_DOLLY_ROTATE:4096,TOUCH_ZOOM_TRUCK:8192,TOUCH_ZOOM_OFFSET:16384,TOUCH_ZOOM_ROTATE:32768}),Tn={NONE:0,IN:1,OUT:-1};function Js(n){return n.isPerspectiveCamera}function Fs(n){return n.isOrthographicCamera}const Bn=Math.PI*2,l0=Math.PI/2,Rp=1e-5,Wr=Math.PI/180;function ki(n,e,t){return Math.max(e,Math.min(t,n))}function qe(n,e=Rp){return Math.abs(n)<e}function Ke(n,e,t=Rp){return qe(n-e,t)}function u0(n,e){return Math.round(n/e)*e}function jr(n){return isFinite(n)?n:n<0?-Number.MAX_VALUE:Number.MAX_VALUE}function Jr(n){return Math.abs(n)<Number.MAX_VALUE?n:n*(1/0)}function ra(n,e,t,i,s=1/0,r){i=Math.max(1e-4,i);const o=2/i,a=o*r,c=1/(1+a+.48*a*a+.235*a*a*a);let l=n-e;const u=e,h=s*i;l=ki(l,-h,h),e=n-l;const f=(t.value+o*l)*r;t.value=(t.value-o*f)*c;let d=e+(l+f)*c;return u-n>0==d>u&&(d=u,t.value=(d-u)/r),d}function h0(n,e,t,i,s=1/0,r,o){i=Math.max(1e-4,i);const a=2/i,c=a*r,l=1/(1+c+.48*c*c+.235*c*c*c);let u=e.x,h=e.y,f=e.z,d=n.x-u,p=n.y-h,m=n.z-f;const g=u,y=h,v=f,E=s*i,C=E*E,x=d*d+p*p+m*m;if(x>C){const U=Math.sqrt(x);d=d/U*E,p=p/U*E,m=m/U*E}u=n.x-d,h=n.y-p,f=n.z-m;const I=(t.x+a*d)*r,S=(t.y+a*p)*r,w=(t.z+a*m)*r;t.x=(t.x-a*I)*l,t.y=(t.y-a*S)*l,t.z=(t.z-a*w)*l,o.x=u+(d+I)*l,o.y=h+(p+S)*l,o.z=f+(m+w)*l;const B=g-n.x,T=y-n.y,R=v-n.z,_=o.x-g,L=o.y-y,O=o.z-v;return B*_+T*L+R*O>0&&(o.x=g,o.y=y,o.z=v,t.x=(o.x-g)/r,t.y=(o.y-y)/r,t.z=(o.z-v)/r),o}function Dl(n,e){e.set(0,0),n.forEach(t=>{e.x+=t.clientX,e.y+=t.clientY}),e.x/=n.length,e.y/=n.length}function Ml(n,e){return Fs(n)?(console.warn(`${e} is not supported in OrthographicCamera`),!0):!1}class cI{constructor(){this._listeners={}}addEventListener(e,t){const i=this._listeners;i[e]===void 0&&(i[e]=[]),i[e].indexOf(t)===-1&&i[e].push(t)}hasEventListener(e,t){const i=this._listeners;return i[e]!==void 0&&i[e].indexOf(t)!==-1}removeEventListener(e,t){const s=this._listeners[e];if(s!==void 0){const r=s.indexOf(t);r!==-1&&s.splice(r,1)}}removeAllEventListeners(e){if(!e){this._listeners={};return}Array.isArray(this._listeners[e])&&(this._listeners[e].length=0)}dispatchEvent(e){const i=this._listeners[e.type];if(i!==void 0){e.target=this;const s=i.slice(0);for(let r=0,o=s.length;r<o;r++)s[r].call(this,e)}}}var Ll;const lI="2.9.0",oa=1/8,uI=/Mac/.test((Ll=globalThis==null?void 0:globalThis.navigator)===null||Ll===void 0?void 0:Ll.platform);let Re,f0,aa,Pl,Zt,ke,ze,_n,qr,Ki,Vi,qs,d0,A0,mi,Xr,bn,m0,Fl,p0,kl,Ol,ca,Ul=class nh extends cI{static install(e){Re=e.THREE,f0=Object.freeze(new Re.Vector3(0,0,0)),aa=Object.freeze(new Re.Vector3(0,1,0)),Pl=Object.freeze(new Re.Vector3(0,0,1)),Zt=new Re.Vector2,ke=new Re.Vector3,ze=new Re.Vector3,_n=new Re.Vector3,qr=new Re.Vector3,Ki=new Re.Vector3,Vi=new Re.Vector3,qs=new Re.Vector3,d0=new Re.Vector3,A0=new Re.Vector3,mi=new Re.Spherical,Xr=new Re.Spherical,bn=new Re.Box3,m0=new Re.Box3,Fl=new Re.Sphere,p0=new Re.Quaternion,kl=new Re.Quaternion,Ol=new Re.Matrix4,ca=new Re.Raycaster}static get ACTION(){return oe}constructor(e,t){super(),this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.minDistance=Number.EPSILON,this.maxDistance=1/0,this.infinityDolly=!1,this.minZoom=.01,this.maxZoom=1/0,this.smoothTime=.25,this.draggingSmoothTime=.125,this.maxSpeed=1/0,this.azimuthRotateSpeed=1,this.polarRotateSpeed=1,this.dollySpeed=1,this.dollyDragInverted=!1,this.truckSpeed=2,this.dollyToCursor=!1,this.dragToOffset=!1,this.verticalDragToForward=!1,this.boundaryFriction=0,this.restThreshold=.01,this.colliderMeshes=[],this.cancel=()=>{},this._enabled=!0,this._state=oe.NONE,this._viewport=null,this._changedDolly=0,this._changedZoom=0,this._hasRested=!0,this._boundaryEnclosesCamera=!1,this._needsUpdate=!0,this._updatedLastTime=!1,this._elementRect=new DOMRect,this._isDragging=!1,this._dragNeedsUpdate=!0,this._activePointers=[],this._lockedPointer=null,this._interactiveArea=new DOMRect(0,0,1,1),this._isUserControllingRotate=!1,this._isUserControllingDolly=!1,this._isUserControllingTruck=!1,this._isUserControllingOffset=!1,this._isUserControllingZoom=!1,this._lastDollyDirection=Tn.NONE,this._thetaVelocity={value:0},this._phiVelocity={value:0},this._radiusVelocity={value:0},this._targetVelocity=new Re.Vector3,this._focalOffsetVelocity=new Re.Vector3,this._zoomVelocity={value:0},this._truckInternal=(y,v,E)=>{let C,x;if(Js(this._camera)){const I=ke.copy(this._camera.position).sub(this._target),S=this._camera.getEffectiveFOV()*Wr,w=I.length()*Math.tan(S*.5);C=this.truckSpeed*y*w/this._elementRect.height,x=this.truckSpeed*v*w/this._elementRect.height}else if(Fs(this._camera)){const I=this._camera;C=y*(I.right-I.left)/I.zoom/this._elementRect.width,x=v*(I.top-I.bottom)/I.zoom/this._elementRect.height}else return;this.verticalDragToForward?(E?this.setFocalOffset(this._focalOffsetEnd.x+C,this._focalOffsetEnd.y,this._focalOffsetEnd.z,!0):this.truck(C,0,!0),this.forward(-x,!0)):E?this.setFocalOffset(this._focalOffsetEnd.x+C,this._focalOffsetEnd.y+x,this._focalOffsetEnd.z,!0):this.truck(C,x,!0)},this._rotateInternal=(y,v)=>{const E=Bn*this.azimuthRotateSpeed*y/this._elementRect.height,C=Bn*this.polarRotateSpeed*v/this._elementRect.height;this.rotate(E,C,!0)},this._dollyInternal=(y,v,E)=>{const C=Math.pow(.95,-y*this.dollySpeed),x=this._sphericalEnd.radius,I=this._sphericalEnd.radius*C,S=ki(I,this.minDistance,this.maxDistance),w=S-I;this.infinityDolly&&this.dollyToCursor?this._dollyToNoClamp(I,!0):this.infinityDolly&&!this.dollyToCursor?(this.dollyInFixed(w,!0),this._dollyToNoClamp(S,!0)):this._dollyToNoClamp(S,!0),this.dollyToCursor&&(this._changedDolly+=(this.infinityDolly?I:S)-x,this._dollyControlCoord.set(v,E)),this._lastDollyDirection=Math.sign(-y)},this._zoomInternal=(y,v,E)=>{const C=Math.pow(.95,y*this.dollySpeed),x=this._zoom,I=this._zoom*C;this.zoomTo(I,!0),this.dollyToCursor&&(this._changedZoom+=I-x,this._dollyControlCoord.set(v,E))},typeof Re>"u"&&console.error("camera-controls: `THREE` is undefined. You must first run `CameraControls.install( { THREE: THREE } )`. Check the docs for further information."),this._camera=e,this._yAxisUpSpace=new Re.Quaternion().setFromUnitVectors(this._camera.up,aa),this._yAxisUpSpaceInverse=this._yAxisUpSpace.clone().invert(),this._state=oe.NONE,this._target=new Re.Vector3,this._targetEnd=this._target.clone(),this._focalOffset=new Re.Vector3,this._focalOffsetEnd=this._focalOffset.clone(),this._spherical=new Re.Spherical().setFromVector3(ke.copy(this._camera.position).applyQuaternion(this._yAxisUpSpace)),this._sphericalEnd=this._spherical.clone(),this._lastDistance=this._spherical.radius,this._zoom=this._camera.zoom,this._zoomEnd=this._zoom,this._lastZoom=this._zoom,this._nearPlaneCorners=[new Re.Vector3,new Re.Vector3,new Re.Vector3,new Re.Vector3],this._updateNearPlaneCorners(),this._boundary=new Re.Box3(new Re.Vector3(-1/0,-1/0,-1/0),new Re.Vector3(1/0,1/0,1/0)),this._cameraUp0=this._camera.up.clone(),this._target0=this._target.clone(),this._position0=this._camera.position.clone(),this._zoom0=this._zoom,this._focalOffset0=this._focalOffset.clone(),this._dollyControlCoord=new Re.Vector2,this.mouseButtons={left:oe.ROTATE,middle:oe.DOLLY,right:oe.TRUCK,wheel:Js(this._camera)?oe.DOLLY:Fs(this._camera)?oe.ZOOM:oe.NONE},this.touches={one:oe.TOUCH_ROTATE,two:Js(this._camera)?oe.TOUCH_DOLLY_TRUCK:Fs(this._camera)?oe.TOUCH_ZOOM_TRUCK:oe.NONE,three:oe.TOUCH_TRUCK};const i=new Re.Vector2,s=new Re.Vector2,r=new Re.Vector2,o=y=>{if(!this._enabled||!this._domElement)return;if(this._interactiveArea.left!==0||this._interactiveArea.top!==0||this._interactiveArea.width!==1||this._interactiveArea.height!==1){const C=this._domElement.getBoundingClientRect(),x=y.clientX/C.width,I=y.clientY/C.height;if(x<this._interactiveArea.left||x>this._interactiveArea.right||I<this._interactiveArea.top||I>this._interactiveArea.bottom)return}const v=y.pointerType!=="mouse"?null:(y.buttons&at.LEFT)===at.LEFT?at.LEFT:(y.buttons&at.MIDDLE)===at.MIDDLE?at.MIDDLE:(y.buttons&at.RIGHT)===at.RIGHT?at.RIGHT:null;if(v!==null){const C=this._findPointerByMouseButton(v);C&&this._disposePointer(C)}if((y.buttons&at.LEFT)===at.LEFT&&this._lockedPointer)return;const E={pointerId:y.pointerId,clientX:y.clientX,clientY:y.clientY,deltaX:0,deltaY:0,mouseButton:v};this._activePointers.push(E),this._domElement.ownerDocument.removeEventListener("pointermove",a,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",c),this._domElement.ownerDocument.addEventListener("pointermove",a,{passive:!1}),this._domElement.ownerDocument.addEventListener("pointerup",c),this._isDragging=!0,f(y)},a=y=>{y.cancelable&&y.preventDefault();const v=y.pointerId,E=this._lockedPointer||this._findPointerById(v);if(E){if(E.clientX=y.clientX,E.clientY=y.clientY,E.deltaX=y.movementX,E.deltaY=y.movementY,this._state=0,y.pointerType==="touch")switch(this._activePointers.length){case 1:this._state=this.touches.one;break;case 2:this._state=this.touches.two;break;case 3:this._state=this.touches.three;break}else(!this._isDragging&&this._lockedPointer||this._isDragging&&(y.buttons&at.LEFT)===at.LEFT)&&(this._state=this._state|this.mouseButtons.left),this._isDragging&&(y.buttons&at.MIDDLE)===at.MIDDLE&&(this._state=this._state|this.mouseButtons.middle),this._isDragging&&(y.buttons&at.RIGHT)===at.RIGHT&&(this._state=this._state|this.mouseButtons.right);d()}},c=y=>{const v=this._findPointerById(y.pointerId);if(!(v&&v===this._lockedPointer)){if(v&&this._disposePointer(v),y.pointerType==="touch")switch(this._activePointers.length){case 0:this._state=oe.NONE;break;case 1:this._state=this.touches.one;break;case 2:this._state=this.touches.two;break;case 3:this._state=this.touches.three;break}else this._state=oe.NONE;p()}};let l=-1;const u=y=>{if(!this._domElement||!this._enabled||this.mouseButtons.wheel===oe.NONE)return;if(this._interactiveArea.left!==0||this._interactiveArea.top!==0||this._interactiveArea.width!==1||this._interactiveArea.height!==1){const I=this._domElement.getBoundingClientRect(),S=y.clientX/I.width,w=y.clientY/I.height;if(S<this._interactiveArea.left||S>this._interactiveArea.right||w<this._interactiveArea.top||w>this._interactiveArea.bottom)return}if(y.preventDefault(),this.dollyToCursor||this.mouseButtons.wheel===oe.ROTATE||this.mouseButtons.wheel===oe.TRUCK){const I=performance.now();l-I<1e3&&this._getClientRect(this._elementRect),l=I}const v=uI?-1:-3,E=y.deltaMode===1?y.deltaY/v:y.deltaY/(v*10),C=this.dollyToCursor?(y.clientX-this._elementRect.x)/this._elementRect.width*2-1:0,x=this.dollyToCursor?(y.clientY-this._elementRect.y)/this._elementRect.height*-2+1:0;switch(this.mouseButtons.wheel){case oe.ROTATE:{this._rotateInternal(y.deltaX,y.deltaY),this._isUserControllingRotate=!0;break}case oe.TRUCK:{this._truckInternal(y.deltaX,y.deltaY,!1),this._isUserControllingTruck=!0;break}case oe.OFFSET:{this._truckInternal(y.deltaX,y.deltaY,!0),this._isUserControllingOffset=!0;break}case oe.DOLLY:{this._dollyInternal(-E,C,x),this._isUserControllingDolly=!0;break}case oe.ZOOM:{this._zoomInternal(-E,C,x),this._isUserControllingZoom=!0;break}}this.dispatchEvent({type:"control"})},h=y=>{if(!(!this._domElement||!this._enabled)){if(this.mouseButtons.right===nh.ACTION.NONE){const v=y instanceof PointerEvent?y.pointerId:0,E=this._findPointerById(v);E&&this._disposePointer(E),this._domElement.ownerDocument.removeEventListener("pointermove",a,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",c);return}y.preventDefault()}},f=y=>{if(!this._enabled)return;if(Dl(this._activePointers,Zt),this._getClientRect(this._elementRect),i.copy(Zt),s.copy(Zt),this._activePointers.length>=2){const E=Zt.x-this._activePointers[1].clientX,C=Zt.y-this._activePointers[1].clientY,x=Math.sqrt(E*E+C*C);r.set(0,x);const I=(this._activePointers[0].clientX+this._activePointers[1].clientX)*.5,S=(this._activePointers[0].clientY+this._activePointers[1].clientY)*.5;s.set(I,S)}if(this._state=0,!y)this._lockedPointer&&(this._state=this._state|this.mouseButtons.left);else if("pointerType"in y&&y.pointerType==="touch")switch(this._activePointers.length){case 1:this._state=this.touches.one;break;case 2:this._state=this.touches.two;break;case 3:this._state=this.touches.three;break}else!this._lockedPointer&&(y.buttons&at.LEFT)===at.LEFT&&(this._state=this._state|this.mouseButtons.left),(y.buttons&at.MIDDLE)===at.MIDDLE&&(this._state=this._state|this.mouseButtons.middle),(y.buttons&at.RIGHT)===at.RIGHT&&(this._state=this._state|this.mouseButtons.right);((this._state&oe.ROTATE)===oe.ROTATE||(this._state&oe.TOUCH_ROTATE)===oe.TOUCH_ROTATE||(this._state&oe.TOUCH_DOLLY_ROTATE)===oe.TOUCH_DOLLY_ROTATE||(this._state&oe.TOUCH_ZOOM_ROTATE)===oe.TOUCH_ZOOM_ROTATE)&&(this._sphericalEnd.theta=this._spherical.theta,this._sphericalEnd.phi=this._spherical.phi,this._thetaVelocity.value=0,this._phiVelocity.value=0),((this._state&oe.TRUCK)===oe.TRUCK||(this._state&oe.TOUCH_TRUCK)===oe.TOUCH_TRUCK||(this._state&oe.TOUCH_DOLLY_TRUCK)===oe.TOUCH_DOLLY_TRUCK||(this._state&oe.TOUCH_ZOOM_TRUCK)===oe.TOUCH_ZOOM_TRUCK)&&(this._targetEnd.copy(this._target),this._targetVelocity.set(0,0,0)),((this._state&oe.DOLLY)===oe.DOLLY||(this._state&oe.TOUCH_DOLLY)===oe.TOUCH_DOLLY||(this._state&oe.TOUCH_DOLLY_TRUCK)===oe.TOUCH_DOLLY_TRUCK||(this._state&oe.TOUCH_DOLLY_OFFSET)===oe.TOUCH_DOLLY_OFFSET||(this._state&oe.TOUCH_DOLLY_ROTATE)===oe.TOUCH_DOLLY_ROTATE)&&(this._sphericalEnd.radius=this._spherical.radius,this._radiusVelocity.value=0),((this._state&oe.ZOOM)===oe.ZOOM||(this._state&oe.TOUCH_ZOOM)===oe.TOUCH_ZOOM||(this._state&oe.TOUCH_ZOOM_TRUCK)===oe.TOUCH_ZOOM_TRUCK||(this._state&oe.TOUCH_ZOOM_OFFSET)===oe.TOUCH_ZOOM_OFFSET||(this._state&oe.TOUCH_ZOOM_ROTATE)===oe.TOUCH_ZOOM_ROTATE)&&(this._zoomEnd=this._zoom,this._zoomVelocity.value=0),((this._state&oe.OFFSET)===oe.OFFSET||(this._state&oe.TOUCH_OFFSET)===oe.TOUCH_OFFSET||(this._state&oe.TOUCH_DOLLY_OFFSET)===oe.TOUCH_DOLLY_OFFSET||(this._state&oe.TOUCH_ZOOM_OFFSET)===oe.TOUCH_ZOOM_OFFSET)&&(this._focalOffsetEnd.copy(this._focalOffset),this._focalOffsetVelocity.set(0,0,0)),this.dispatchEvent({type:"controlstart"})},d=()=>{if(!this._enabled||!this._dragNeedsUpdate)return;this._dragNeedsUpdate=!1,Dl(this._activePointers,Zt);const v=this._domElement&&this._domElement.ownerDocument.pointerLockElement===this._domElement?this._lockedPointer||this._activePointers[0]:null,E=v?-v.deltaX:s.x-Zt.x,C=v?-v.deltaY:s.y-Zt.y;if(s.copy(Zt),((this._state&oe.ROTATE)===oe.ROTATE||(this._state&oe.TOUCH_ROTATE)===oe.TOUCH_ROTATE||(this._state&oe.TOUCH_DOLLY_ROTATE)===oe.TOUCH_DOLLY_ROTATE||(this._state&oe.TOUCH_ZOOM_ROTATE)===oe.TOUCH_ZOOM_ROTATE)&&(this._rotateInternal(E,C),this._isUserControllingRotate=!0),(this._state&oe.DOLLY)===oe.DOLLY||(this._state&oe.ZOOM)===oe.ZOOM){const x=this.dollyToCursor?(i.x-this._elementRect.x)/this._elementRect.width*2-1:0,I=this.dollyToCursor?(i.y-this._elementRect.y)/this._elementRect.height*-2+1:0,S=this.dollyDragInverted?-1:1;(this._state&oe.DOLLY)===oe.DOLLY?(this._dollyInternal(S*C*oa,x,I),this._isUserControllingDolly=!0):(this._zoomInternal(S*C*oa,x,I),this._isUserControllingZoom=!0)}if((this._state&oe.TOUCH_DOLLY)===oe.TOUCH_DOLLY||(this._state&oe.TOUCH_ZOOM)===oe.TOUCH_ZOOM||(this._state&oe.TOUCH_DOLLY_TRUCK)===oe.TOUCH_DOLLY_TRUCK||(this._state&oe.TOUCH_ZOOM_TRUCK)===oe.TOUCH_ZOOM_TRUCK||(this._state&oe.TOUCH_DOLLY_OFFSET)===oe.TOUCH_DOLLY_OFFSET||(this._state&oe.TOUCH_ZOOM_OFFSET)===oe.TOUCH_ZOOM_OFFSET||(this._state&oe.TOUCH_DOLLY_ROTATE)===oe.TOUCH_DOLLY_ROTATE||(this._state&oe.TOUCH_ZOOM_ROTATE)===oe.TOUCH_ZOOM_ROTATE){const x=Zt.x-this._activePointers[1].clientX,I=Zt.y-this._activePointers[1].clientY,S=Math.sqrt(x*x+I*I),w=r.y-S;r.set(0,S);const B=this.dollyToCursor?(s.x-this._elementRect.x)/this._elementRect.width*2-1:0,T=this.dollyToCursor?(s.y-this._elementRect.y)/this._elementRect.height*-2+1:0;(this._state&oe.TOUCH_DOLLY)===oe.TOUCH_DOLLY||(this._state&oe.TOUCH_DOLLY_ROTATE)===oe.TOUCH_DOLLY_ROTATE||(this._state&oe.TOUCH_DOLLY_TRUCK)===oe.TOUCH_DOLLY_TRUCK||(this._state&oe.TOUCH_DOLLY_OFFSET)===oe.TOUCH_DOLLY_OFFSET?(this._dollyInternal(w*oa,B,T),this._isUserControllingDolly=!0):(this._zoomInternal(w*oa,B,T),this._isUserControllingZoom=!0)}((this._state&oe.TRUCK)===oe.TRUCK||(this._state&oe.TOUCH_TRUCK)===oe.TOUCH_TRUCK||(this._state&oe.TOUCH_DOLLY_TRUCK)===oe.TOUCH_DOLLY_TRUCK||(this._state&oe.TOUCH_ZOOM_TRUCK)===oe.TOUCH_ZOOM_TRUCK)&&(this._truckInternal(E,C,!1),this._isUserControllingTruck=!0),((this._state&oe.OFFSET)===oe.OFFSET||(this._state&oe.TOUCH_OFFSET)===oe.TOUCH_OFFSET||(this._state&oe.TOUCH_DOLLY_OFFSET)===oe.TOUCH_DOLLY_OFFSET||(this._state&oe.TOUCH_ZOOM_OFFSET)===oe.TOUCH_ZOOM_OFFSET)&&(this._truckInternal(E,C,!0),this._isUserControllingOffset=!0),this.dispatchEvent({type:"control"})},p=()=>{Dl(this._activePointers,Zt),s.copy(Zt),this._dragNeedsUpdate=!1,(this._activePointers.length===0||this._activePointers.length===1&&this._activePointers[0]===this._lockedPointer)&&(this._isDragging=!1),this._activePointers.length===0&&this._domElement&&(this._domElement.ownerDocument.removeEventListener("pointermove",a,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",c),this.dispatchEvent({type:"controlend"}))};this.lockPointer=()=>{!this._enabled||!this._domElement||(this.cancel(),this._lockedPointer={pointerId:-1,clientX:0,clientY:0,deltaX:0,deltaY:0,mouseButton:null},this._activePointers.push(this._lockedPointer),this._domElement.ownerDocument.removeEventListener("pointermove",a,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",c),this._domElement.requestPointerLock(),this._domElement.ownerDocument.addEventListener("pointerlockchange",m),this._domElement.ownerDocument.addEventListener("pointerlockerror",g),this._domElement.ownerDocument.addEventListener("pointermove",a,{passive:!1}),this._domElement.ownerDocument.addEventListener("pointerup",c),f())},this.unlockPointer=()=>{var y,v,E;this._lockedPointer!==null&&(this._disposePointer(this._lockedPointer),this._lockedPointer=null),(y=this._domElement)===null||y===void 0||y.ownerDocument.exitPointerLock(),(v=this._domElement)===null||v===void 0||v.ownerDocument.removeEventListener("pointerlockchange",m),(E=this._domElement)===null||E===void 0||E.ownerDocument.removeEventListener("pointerlockerror",g),this.cancel()};const m=()=>{this._domElement&&this._domElement.ownerDocument.pointerLockElement===this._domElement||this.unlockPointer()},g=()=>{this.unlockPointer()};this._addAllEventListeners=y=>{this._domElement=y,this._domElement.style.touchAction="none",this._domElement.style.userSelect="none",this._domElement.style.webkitUserSelect="none",this._domElement.addEventListener("pointerdown",o),this._domElement.addEventListener("pointercancel",c),this._domElement.addEventListener("wheel",u,{passive:!1}),this._domElement.addEventListener("contextmenu",h)},this._removeAllEventListeners=()=>{this._domElement&&(this._domElement.style.touchAction="",this._domElement.style.userSelect="",this._domElement.style.webkitUserSelect="",this._domElement.removeEventListener("pointerdown",o),this._domElement.removeEventListener("pointercancel",c),this._domElement.removeEventListener("wheel",u,{passive:!1}),this._domElement.removeEventListener("contextmenu",h),this._domElement.ownerDocument.removeEventListener("pointermove",a,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",c),this._domElement.ownerDocument.removeEventListener("pointerlockchange",m),this._domElement.ownerDocument.removeEventListener("pointerlockerror",g))},this.cancel=()=>{this._state!==oe.NONE&&(this._state=oe.NONE,this._activePointers.length=0,p())},t&&this.connect(t),this.update(0)}get camera(){return this._camera}set camera(e){this._camera=e,this.updateCameraUp(),this._camera.updateProjectionMatrix(),this._updateNearPlaneCorners(),this._needsUpdate=!0}get enabled(){return this._enabled}set enabled(e){this._enabled=e,this._domElement&&(e?(this._domElement.style.touchAction="none",this._domElement.style.userSelect="none",this._domElement.style.webkitUserSelect="none"):(this.cancel(),this._domElement.style.touchAction="",this._domElement.style.userSelect="",this._domElement.style.webkitUserSelect=""))}get active(){return!this._hasRested}get currentAction(){return this._state}get distance(){return this._spherical.radius}set distance(e){this._spherical.radius===e&&this._sphericalEnd.radius===e||(this._spherical.radius=e,this._sphericalEnd.radius=e,this._needsUpdate=!0)}get azimuthAngle(){return this._spherical.theta}set azimuthAngle(e){this._spherical.theta===e&&this._sphericalEnd.theta===e||(this._spherical.theta=e,this._sphericalEnd.theta=e,this._needsUpdate=!0)}get polarAngle(){return this._spherical.phi}set polarAngle(e){this._spherical.phi===e&&this._sphericalEnd.phi===e||(this._spherical.phi=e,this._sphericalEnd.phi=e,this._needsUpdate=!0)}get boundaryEnclosesCamera(){return this._boundaryEnclosesCamera}set boundaryEnclosesCamera(e){this._boundaryEnclosesCamera=e,this._needsUpdate=!0}set interactiveArea(e){this._interactiveArea.width=ki(e.width,0,1),this._interactiveArea.height=ki(e.height,0,1),this._interactiveArea.x=ki(e.x,0,1-this._interactiveArea.width),this._interactiveArea.y=ki(e.y,0,1-this._interactiveArea.height)}addEventListener(e,t){super.addEventListener(e,t)}removeEventListener(e,t){super.removeEventListener(e,t)}rotate(e,t,i=!1){return this.rotateTo(this._sphericalEnd.theta+e,this._sphericalEnd.phi+t,i)}rotateAzimuthTo(e,t=!1){return this.rotateTo(e,this._sphericalEnd.phi,t)}rotatePolarTo(e,t=!1){return this.rotateTo(this._sphericalEnd.theta,e,t)}rotateTo(e,t,i=!1){this._isUserControllingRotate=!1;const s=ki(e,this.minAzimuthAngle,this.maxAzimuthAngle),r=ki(t,this.minPolarAngle,this.maxPolarAngle);this._sphericalEnd.theta=s,this._sphericalEnd.phi=r,this._sphericalEnd.makeSafe(),this._needsUpdate=!0,i||(this._spherical.theta=this._sphericalEnd.theta,this._spherical.phi=this._sphericalEnd.phi);const o=!i||Ke(this._spherical.theta,this._sphericalEnd.theta,this.restThreshold)&&Ke(this._spherical.phi,this._sphericalEnd.phi,this.restThreshold);return this._createOnRestPromise(o)}dolly(e,t=!1){return this.dollyTo(this._sphericalEnd.radius-e,t)}dollyTo(e,t=!1){return this._isUserControllingDolly=!1,this._lastDollyDirection=Tn.NONE,this._changedDolly=0,this._dollyToNoClamp(ki(e,this.minDistance,this.maxDistance),t)}_dollyToNoClamp(e,t=!1){const i=this._sphericalEnd.radius;if(this.colliderMeshes.length>=1){const o=this._collisionTest(),a=Ke(o,this._spherical.radius);if(!(i>e)&&a)return Promise.resolve();this._sphericalEnd.radius=Math.min(e,o)}else this._sphericalEnd.radius=e;this._needsUpdate=!0,t||(this._spherical.radius=this._sphericalEnd.radius);const r=!t||Ke(this._spherical.radius,this._sphericalEnd.radius,this.restThreshold);return this._createOnRestPromise(r)}dollyInFixed(e,t=!1){this._targetEnd.add(this._getCameraDirection(qr).multiplyScalar(e)),t||this._target.copy(this._targetEnd);const i=!t||Ke(this._target.x,this._targetEnd.x,this.restThreshold)&&Ke(this._target.y,this._targetEnd.y,this.restThreshold)&&Ke(this._target.z,this._targetEnd.z,this.restThreshold);return this._createOnRestPromise(i)}zoom(e,t=!1){return this.zoomTo(this._zoomEnd+e,t)}zoomTo(e,t=!1){this._isUserControllingZoom=!1,this._zoomEnd=ki(e,this.minZoom,this.maxZoom),this._needsUpdate=!0,t||(this._zoom=this._zoomEnd);const i=!t||Ke(this._zoom,this._zoomEnd,this.restThreshold);return this._changedZoom=0,this._createOnRestPromise(i)}pan(e,t,i=!1){return console.warn("`pan` has been renamed to `truck`"),this.truck(e,t,i)}truck(e,t,i=!1){this._camera.updateMatrix(),Ki.setFromMatrixColumn(this._camera.matrix,0),Vi.setFromMatrixColumn(this._camera.matrix,1),Ki.multiplyScalar(e),Vi.multiplyScalar(-t);const s=ke.copy(Ki).add(Vi),r=ze.copy(this._targetEnd).add(s);return this.moveTo(r.x,r.y,r.z,i)}forward(e,t=!1){ke.setFromMatrixColumn(this._camera.matrix,0),ke.crossVectors(this._camera.up,ke),ke.multiplyScalar(e);const i=ze.copy(this._targetEnd).add(ke);return this.moveTo(i.x,i.y,i.z,t)}elevate(e,t=!1){return ke.copy(this._camera.up).multiplyScalar(e),this.moveTo(this._targetEnd.x+ke.x,this._targetEnd.y+ke.y,this._targetEnd.z+ke.z,t)}moveTo(e,t,i,s=!1){this._isUserControllingTruck=!1;const r=ke.set(e,t,i).sub(this._targetEnd);this._encloseToBoundary(this._targetEnd,r,this.boundaryFriction),this._needsUpdate=!0,s||this._target.copy(this._targetEnd);const o=!s||Ke(this._target.x,this._targetEnd.x,this.restThreshold)&&Ke(this._target.y,this._targetEnd.y,this.restThreshold)&&Ke(this._target.z,this._targetEnd.z,this.restThreshold);return this._createOnRestPromise(o)}lookInDirectionOf(e,t,i,s=!1){const a=ke.set(e,t,i).sub(this._targetEnd).normalize().multiplyScalar(-this._sphericalEnd.radius).add(this._targetEnd);return this.setPosition(a.x,a.y,a.z,s)}fitToBox(e,t,{cover:i=!1,paddingLeft:s=0,paddingRight:r=0,paddingBottom:o=0,paddingTop:a=0}={}){const c=[],l=e.isBox3?bn.copy(e):bn.setFromObject(e);l.isEmpty()&&(console.warn("camera-controls: fitTo() cannot be used with an empty box. Aborting"),Promise.resolve());const u=u0(this._sphericalEnd.theta,l0),h=u0(this._sphericalEnd.phi,l0);c.push(this.rotateTo(u,h,t));const f=ke.setFromSpherical(this._sphericalEnd).normalize(),d=p0.setFromUnitVectors(f,Pl),p=Ke(Math.abs(f.y),1);p&&d.multiply(kl.setFromAxisAngle(aa,u)),d.multiply(this._yAxisUpSpaceInverse);const m=m0.makeEmpty();ze.copy(l.min).applyQuaternion(d),m.expandByPoint(ze),ze.copy(l.min).setX(l.max.x).applyQuaternion(d),m.expandByPoint(ze),ze.copy(l.min).setY(l.max.y).applyQuaternion(d),m.expandByPoint(ze),ze.copy(l.max).setZ(l.min.z).applyQuaternion(d),m.expandByPoint(ze),ze.copy(l.min).setZ(l.max.z).applyQuaternion(d),m.expandByPoint(ze),ze.copy(l.max).setY(l.min.y).applyQuaternion(d),m.expandByPoint(ze),ze.copy(l.max).setX(l.min.x).applyQuaternion(d),m.expandByPoint(ze),ze.copy(l.max).applyQuaternion(d),m.expandByPoint(ze),m.min.x-=s,m.min.y-=o,m.max.x+=r,m.max.y+=a,d.setFromUnitVectors(Pl,f),p&&d.premultiply(kl.invert()),d.premultiply(this._yAxisUpSpace);const g=m.getSize(ke),y=m.getCenter(ze).applyQuaternion(d);if(Js(this._camera)){const v=this.getDistanceToFitBox(g.x,g.y,g.z,i);c.push(this.moveTo(y.x,y.y,y.z,t)),c.push(this.dollyTo(v,t)),c.push(this.setFocalOffset(0,0,0,t))}else if(Fs(this._camera)){const v=this._camera,E=v.right-v.left,C=v.top-v.bottom,x=i?Math.max(E/g.x,C/g.y):Math.min(E/g.x,C/g.y);c.push(this.moveTo(y.x,y.y,y.z,t)),c.push(this.zoomTo(x,t)),c.push(this.setFocalOffset(0,0,0,t))}return Promise.all(c)}fitToSphere(e,t){const i=[],r="isObject3D"in e?nh.createBoundingSphere(e,Fl):Fl.copy(e);if(i.push(this.moveTo(r.center.x,r.center.y,r.center.z,t)),Js(this._camera)){const o=this.getDistanceToFitSphere(r.radius);i.push(this.dollyTo(o,t))}else if(Fs(this._camera)){const o=this._camera.right-this._camera.left,a=this._camera.top-this._camera.bottom,c=2*r.radius,l=Math.min(o/c,a/c);i.push(this.zoomTo(l,t))}return i.push(this.setFocalOffset(0,0,0,t)),Promise.all(i)}setLookAt(e,t,i,s,r,o,a=!1){this._isUserControllingRotate=!1,this._isUserControllingDolly=!1,this._isUserControllingTruck=!1,this._lastDollyDirection=Tn.NONE,this._changedDolly=0;const c=ze.set(s,r,o),l=ke.set(e,t,i);this._targetEnd.copy(c),this._sphericalEnd.setFromVector3(l.sub(c).applyQuaternion(this._yAxisUpSpace)),this.normalizeRotations(),this._needsUpdate=!0,a||(this._target.copy(this._targetEnd),this._spherical.copy(this._sphericalEnd));const u=!a||Ke(this._target.x,this._targetEnd.x,this.restThreshold)&&Ke(this._target.y,this._targetEnd.y,this.restThreshold)&&Ke(this._target.z,this._targetEnd.z,this.restThreshold)&&Ke(this._spherical.theta,this._sphericalEnd.theta,this.restThreshold)&&Ke(this._spherical.phi,this._sphericalEnd.phi,this.restThreshold)&&Ke(this._spherical.radius,this._sphericalEnd.radius,this.restThreshold);return this._createOnRestPromise(u)}lerpLookAt(e,t,i,s,r,o,a,c,l,u,h,f,d,p=!1){this._isUserControllingRotate=!1,this._isUserControllingDolly=!1,this._isUserControllingTruck=!1,this._lastDollyDirection=Tn.NONE,this._changedDolly=0;const m=ke.set(s,r,o),g=ze.set(e,t,i);mi.setFromVector3(g.sub(m).applyQuaternion(this._yAxisUpSpace));const y=_n.set(u,h,f),v=ze.set(a,c,l);Xr.setFromVector3(v.sub(y).applyQuaternion(this._yAxisUpSpace)),this._targetEnd.copy(m.lerp(y,d));const E=Xr.theta-mi.theta,C=Xr.phi-mi.phi,x=Xr.radius-mi.radius;this._sphericalEnd.set(mi.radius+x*d,mi.phi+C*d,mi.theta+E*d),this.normalizeRotations(),this._needsUpdate=!0,p||(this._target.copy(this._targetEnd),this._spherical.copy(this._sphericalEnd));const I=!p||Ke(this._target.x,this._targetEnd.x,this.restThreshold)&&Ke(this._target.y,this._targetEnd.y,this.restThreshold)&&Ke(this._target.z,this._targetEnd.z,this.restThreshold)&&Ke(this._spherical.theta,this._sphericalEnd.theta,this.restThreshold)&&Ke(this._spherical.phi,this._sphericalEnd.phi,this.restThreshold)&&Ke(this._spherical.radius,this._sphericalEnd.radius,this.restThreshold);return this._createOnRestPromise(I)}setPosition(e,t,i,s=!1){return this.setLookAt(e,t,i,this._targetEnd.x,this._targetEnd.y,this._targetEnd.z,s)}setTarget(e,t,i,s=!1){const r=this.getPosition(ke),o=this.setLookAt(r.x,r.y,r.z,e,t,i,s);return this._sphericalEnd.phi=ki(this._sphericalEnd.phi,this.minPolarAngle,this.maxPolarAngle),o}setFocalOffset(e,t,i,s=!1){this._isUserControllingOffset=!1,this._focalOffsetEnd.set(e,t,i),this._needsUpdate=!0,s||this._focalOffset.copy(this._focalOffsetEnd);const r=!s||Ke(this._focalOffset.x,this._focalOffsetEnd.x,this.restThreshold)&&Ke(this._focalOffset.y,this._focalOffsetEnd.y,this.restThreshold)&&Ke(this._focalOffset.z,this._focalOffsetEnd.z,this.restThreshold);return this._createOnRestPromise(r)}setOrbitPoint(e,t,i){this._camera.updateMatrixWorld(),Ki.setFromMatrixColumn(this._camera.matrixWorldInverse,0),Vi.setFromMatrixColumn(this._camera.matrixWorldInverse,1),qs.setFromMatrixColumn(this._camera.matrixWorldInverse,2);const s=ke.set(e,t,i),r=s.distanceTo(this._camera.position),o=s.sub(this._camera.position);Ki.multiplyScalar(o.x),Vi.multiplyScalar(o.y),qs.multiplyScalar(o.z),ke.copy(Ki).add(Vi).add(qs),ke.z=ke.z+r,this.dollyTo(r,!1),this.setFocalOffset(-ke.x,ke.y,-ke.z,!1),this.moveTo(e,t,i,!1)}setBoundary(e){if(!e){this._boundary.min.set(-1/0,-1/0,-1/0),this._boundary.max.set(1/0,1/0,1/0),this._needsUpdate=!0;return}this._boundary.copy(e),this._boundary.clampPoint(this._targetEnd,this._targetEnd),this._needsUpdate=!0}setViewport(e,t,i,s){if(e===null){this._viewport=null;return}this._viewport=this._viewport||new Re.Vector4,typeof e=="number"?this._viewport.set(e,t,i,s):this._viewport.copy(e)}getDistanceToFitBox(e,t,i,s=!1){if(Ml(this._camera,"getDistanceToFitBox"))return this._spherical.radius;const r=e/t,o=this._camera.getEffectiveFOV()*Wr,a=this._camera.aspect;return((s?r>a:r<a)?t:e/a)*.5/Math.tan(o*.5)+i*.5}getDistanceToFitSphere(e){if(Ml(this._camera,"getDistanceToFitSphere"))return this._spherical.radius;const t=this._camera.getEffectiveFOV()*Wr,i=Math.atan(Math.tan(t*.5)*this._camera.aspect)*2,s=1<this._camera.aspect?t:i;return e/Math.sin(s*.5)}getTarget(e,t=!0){return(e&&e.isVector3?e:new Re.Vector3).copy(t?this._targetEnd:this._target)}getPosition(e,t=!0){return(e&&e.isVector3?e:new Re.Vector3).setFromSpherical(t?this._sphericalEnd:this._spherical).applyQuaternion(this._yAxisUpSpaceInverse).add(t?this._targetEnd:this._target)}getSpherical(e,t=!0){return(e||new Re.Spherical).copy(t?this._sphericalEnd:this._spherical)}getFocalOffset(e,t=!0){return(e&&e.isVector3?e:new Re.Vector3).copy(t?this._focalOffsetEnd:this._focalOffset)}normalizeRotations(){this._sphericalEnd.theta=this._sphericalEnd.theta%Bn,this._sphericalEnd.theta<0&&(this._sphericalEnd.theta+=Bn),this._spherical.theta+=Bn*Math.round((this._sphericalEnd.theta-this._spherical.theta)/Bn)}stop(){this._focalOffset.copy(this._focalOffsetEnd),this._target.copy(this._targetEnd),this._spherical.copy(this._sphericalEnd),this._zoom=this._zoomEnd}reset(e=!1){if(!Ke(this._camera.up.x,this._cameraUp0.x)||!Ke(this._camera.up.y,this._cameraUp0.y)||!Ke(this._camera.up.z,this._cameraUp0.z)){this._camera.up.copy(this._cameraUp0);const i=this.getPosition(ke);this.updateCameraUp(),this.setPosition(i.x,i.y,i.z)}const t=[this.setLookAt(this._position0.x,this._position0.y,this._position0.z,this._target0.x,this._target0.y,this._target0.z,e),this.setFocalOffset(this._focalOffset0.x,this._focalOffset0.y,this._focalOffset0.z,e),this.zoomTo(this._zoom0,e)];return Promise.all(t)}saveState(){this._cameraUp0.copy(this._camera.up),this.getTarget(this._target0),this.getPosition(this._position0),this._zoom0=this._zoom,this._focalOffset0.copy(this._focalOffset)}updateCameraUp(){this._yAxisUpSpace.setFromUnitVectors(this._camera.up,aa),this._yAxisUpSpaceInverse.copy(this._yAxisUpSpace).invert()}applyCameraUp(){const e=ke.subVectors(this._target,this._camera.position).normalize(),t=ze.crossVectors(e,this._camera.up);this._camera.up.crossVectors(t,e).normalize(),this._camera.updateMatrixWorld();const i=this.getPosition(ke);this.updateCameraUp(),this.setPosition(i.x,i.y,i.z)}update(e){const t=this._sphericalEnd.theta-this._spherical.theta,i=this._sphericalEnd.phi-this._spherical.phi,s=this._sphericalEnd.radius-this._spherical.radius,r=d0.subVectors(this._targetEnd,this._target),o=A0.subVectors(this._focalOffsetEnd,this._focalOffset),a=this._zoomEnd-this._zoom;if(qe(t))this._thetaVelocity.value=0,this._spherical.theta=this._sphericalEnd.theta;else{const h=this._isUserControllingRotate?this.draggingSmoothTime:this.smoothTime;this._spherical.theta=ra(this._spherical.theta,this._sphericalEnd.theta,this._thetaVelocity,h,1/0,e),this._needsUpdate=!0}if(qe(i))this._phiVelocity.value=0,this._spherical.phi=this._sphericalEnd.phi;else{const h=this._isUserControllingRotate?this.draggingSmoothTime:this.smoothTime;this._spherical.phi=ra(this._spherical.phi,this._sphericalEnd.phi,this._phiVelocity,h,1/0,e),this._needsUpdate=!0}if(qe(s))this._radiusVelocity.value=0,this._spherical.radius=this._sphericalEnd.radius;else{const h=this._isUserControllingDolly?this.draggingSmoothTime:this.smoothTime;this._spherical.radius=ra(this._spherical.radius,this._sphericalEnd.radius,this._radiusVelocity,h,this.maxSpeed,e),this._needsUpdate=!0}if(qe(r.x)&&qe(r.y)&&qe(r.z))this._targetVelocity.set(0,0,0),this._target.copy(this._targetEnd);else{const h=this._isUserControllingTruck?this.draggingSmoothTime:this.smoothTime;h0(this._target,this._targetEnd,this._targetVelocity,h,this.maxSpeed,e,this._target),this._needsUpdate=!0}if(qe(o.x)&&qe(o.y)&&qe(o.z))this._focalOffsetVelocity.set(0,0,0),this._focalOffset.copy(this._focalOffsetEnd);else{const h=this._isUserControllingOffset?this.draggingSmoothTime:this.smoothTime;h0(this._focalOffset,this._focalOffsetEnd,this._focalOffsetVelocity,h,this.maxSpeed,e,this._focalOffset),this._needsUpdate=!0}if(qe(a))this._zoomVelocity.value=0,this._zoom=this._zoomEnd;else{const h=this._isUserControllingZoom?this.draggingSmoothTime:this.smoothTime;this._zoom=ra(this._zoom,this._zoomEnd,this._zoomVelocity,h,1/0,e)}if(this.dollyToCursor){if(Js(this._camera)&&this._changedDolly!==0){const h=this._spherical.radius-this._lastDistance,f=this._camera,d=this._getCameraDirection(qr),p=ke.copy(d).cross(f.up).normalize();p.lengthSq()===0&&(p.x=1);const m=ze.crossVectors(p,d),g=this._sphericalEnd.radius*Math.tan(f.getEffectiveFOV()*Wr*.5),v=(this._sphericalEnd.radius-h-this._sphericalEnd.radius)/this._sphericalEnd.radius,E=_n.copy(this._targetEnd).add(p.multiplyScalar(this._dollyControlCoord.x*g*f.aspect)).add(m.multiplyScalar(this._dollyControlCoord.y*g)),C=ke.copy(this._targetEnd).lerp(E,v),x=this._lastDollyDirection===Tn.IN&&this._spherical.radius<=this.minDistance,I=this._lastDollyDirection===Tn.OUT&&this.maxDistance<=this._spherical.radius;if(this.infinityDolly&&(x||I)){this._sphericalEnd.radius-=h,this._spherical.radius-=h;const w=ze.copy(d).multiplyScalar(-h);C.add(w)}this._boundary.clampPoint(C,C);const S=ze.subVectors(C,this._targetEnd);this._targetEnd.copy(C),this._target.add(S),this._changedDolly-=h,qe(this._changedDolly)&&(this._changedDolly=0)}else if(Fs(this._camera)&&this._changedZoom!==0){const h=this._zoom-this._lastZoom,f=this._camera,d=ke.set(this._dollyControlCoord.x,this._dollyControlCoord.y,(f.near+f.far)/(f.near-f.far)).unproject(f),p=ze.set(0,0,-1).applyQuaternion(f.quaternion),m=_n.copy(d).add(p.multiplyScalar(-d.dot(f.up))),y=-(this._zoom-h-this._zoom)/this._zoom,v=this._getCameraDirection(qr),E=this._targetEnd.dot(v),C=ke.copy(this._targetEnd).lerp(m,y),x=C.dot(v),I=v.multiplyScalar(x-E);C.sub(I),this._boundary.clampPoint(C,C);const S=ze.subVectors(C,this._targetEnd);this._targetEnd.copy(C),this._target.add(S),this._changedZoom-=h,qe(this._changedZoom)&&(this._changedZoom=0)}}this._camera.zoom!==this._zoom&&(this._camera.zoom=this._zoom,this._camera.updateProjectionMatrix(),this._updateNearPlaneCorners(),this._needsUpdate=!0),this._dragNeedsUpdate=!0;const c=this._collisionTest();this._spherical.radius=Math.min(this._spherical.radius,c),this._spherical.makeSafe(),this._camera.position.setFromSpherical(this._spherical).applyQuaternion(this._yAxisUpSpaceInverse).add(this._target),this._camera.lookAt(this._target),(!qe(this._focalOffset.x)||!qe(this._focalOffset.y)||!qe(this._focalOffset.z))&&(this._camera.updateMatrixWorld(),Ki.setFromMatrixColumn(this._camera.matrix,0),Vi.setFromMatrixColumn(this._camera.matrix,1),qs.setFromMatrixColumn(this._camera.matrix,2),Ki.multiplyScalar(this._focalOffset.x),Vi.multiplyScalar(-this._focalOffset.y),qs.multiplyScalar(this._focalOffset.z),ke.copy(Ki).add(Vi).add(qs),this._camera.position.add(ke)),this._boundaryEnclosesCamera&&this._encloseToBoundary(this._camera.position.copy(this._target),ke.setFromSpherical(this._spherical).applyQuaternion(this._yAxisUpSpaceInverse),1);const u=this._needsUpdate;return u&&!this._updatedLastTime?(this._hasRested=!1,this.dispatchEvent({type:"wake"}),this.dispatchEvent({type:"update"})):u?(this.dispatchEvent({type:"update"}),qe(t,this.restThreshold)&&qe(i,this.restThreshold)&&qe(s,this.restThreshold)&&qe(r.x,this.restThreshold)&&qe(r.y,this.restThreshold)&&qe(r.z,this.restThreshold)&&qe(o.x,this.restThreshold)&&qe(o.y,this.restThreshold)&&qe(o.z,this.restThreshold)&&qe(a,this.restThreshold)&&!this._hasRested&&(this._hasRested=!0,this.dispatchEvent({type:"rest"}))):!u&&this._updatedLastTime&&this.dispatchEvent({type:"sleep"}),this._lastDistance=this._spherical.radius,this._lastZoom=this._zoom,this._updatedLastTime=u,this._needsUpdate=!1,u}toJSON(){return JSON.stringify({enabled:this._enabled,minDistance:this.minDistance,maxDistance:jr(this.maxDistance),minZoom:this.minZoom,maxZoom:jr(this.maxZoom),minPolarAngle:this.minPolarAngle,maxPolarAngle:jr(this.maxPolarAngle),minAzimuthAngle:jr(this.minAzimuthAngle),maxAzimuthAngle:jr(this.maxAzimuthAngle),smoothTime:this.smoothTime,draggingSmoothTime:this.draggingSmoothTime,dollySpeed:this.dollySpeed,truckSpeed:this.truckSpeed,dollyToCursor:this.dollyToCursor,verticalDragToForward:this.verticalDragToForward,target:this._targetEnd.toArray(),position:ke.setFromSpherical(this._sphericalEnd).add(this._targetEnd).toArray(),zoom:this._zoomEnd,focalOffset:this._focalOffsetEnd.toArray(),target0:this._target0.toArray(),position0:this._position0.toArray(),zoom0:this._zoom0,focalOffset0:this._focalOffset0.toArray()})}fromJSON(e,t=!1){const i=JSON.parse(e);this.enabled=i.enabled,this.minDistance=i.minDistance,this.maxDistance=Jr(i.maxDistance),this.minZoom=i.minZoom,this.maxZoom=Jr(i.maxZoom),this.minPolarAngle=i.minPolarAngle,this.maxPolarAngle=Jr(i.maxPolarAngle),this.minAzimuthAngle=Jr(i.minAzimuthAngle),this.maxAzimuthAngle=Jr(i.maxAzimuthAngle),this.smoothTime=i.smoothTime,this.draggingSmoothTime=i.draggingSmoothTime,this.dollySpeed=i.dollySpeed,this.truckSpeed=i.truckSpeed,this.dollyToCursor=i.dollyToCursor,this.verticalDragToForward=i.verticalDragToForward,this._target0.fromArray(i.target0),this._position0.fromArray(i.position0),this._zoom0=i.zoom0,this._focalOffset0.fromArray(i.focalOffset0),this.moveTo(i.target[0],i.target[1],i.target[2],t),mi.setFromVector3(ke.fromArray(i.position).sub(this._targetEnd).applyQuaternion(this._yAxisUpSpace)),this.rotateTo(mi.theta,mi.phi,t),this.dollyTo(mi.radius,t),this.zoomTo(i.zoom,t),this.setFocalOffset(i.focalOffset[0],i.focalOffset[1],i.focalOffset[2],t),this._needsUpdate=!0}connect(e){if(this._domElement){console.warn("camera-controls is already connected.");return}e.setAttribute("data-camera-controls-version",lI),this._addAllEventListeners(e),this._getClientRect(this._elementRect)}disconnect(){this.cancel(),this._removeAllEventListeners(),this._domElement&&(this._domElement.removeAttribute("data-camera-controls-version"),this._domElement=void 0)}dispose(){this.removeAllEventListeners(),this.disconnect()}_getTargetDirection(e){return e.setFromSpherical(this._spherical).divideScalar(this._spherical.radius).applyQuaternion(this._yAxisUpSpaceInverse)}_getCameraDirection(e){return this._getTargetDirection(e).negate()}_findPointerById(e){return this._activePointers.find(t=>t.pointerId===e)}_findPointerByMouseButton(e){return this._activePointers.find(t=>t.mouseButton===e)}_disposePointer(e){this._activePointers.splice(this._activePointers.indexOf(e),1)}_encloseToBoundary(e,t,i){const s=t.lengthSq();if(s===0)return e;const r=ze.copy(t).add(e),a=this._boundary.clampPoint(r,_n).sub(r),c=a.lengthSq();if(c===0)return e.add(t);if(c===s)return e;if(i===0)return e.add(t).add(a);{const l=1+i*c/t.dot(a);return e.add(ze.copy(t).multiplyScalar(l)).add(a.multiplyScalar(1-i))}}_updateNearPlaneCorners(){if(Js(this._camera)){const e=this._camera,t=e.near,i=e.getEffectiveFOV()*Wr,s=Math.tan(i*.5)*t,r=s*e.aspect;this._nearPlaneCorners[0].set(-r,-s,0),this._nearPlaneCorners[1].set(r,-s,0),this._nearPlaneCorners[2].set(r,s,0),this._nearPlaneCorners[3].set(-r,s,0)}else if(Fs(this._camera)){const e=this._camera,t=1/e.zoom,i=e.left*t,s=e.right*t,r=e.top*t,o=e.bottom*t;this._nearPlaneCorners[0].set(i,r,0),this._nearPlaneCorners[1].set(s,r,0),this._nearPlaneCorners[2].set(s,o,0),this._nearPlaneCorners[3].set(i,o,0)}}_collisionTest(){let e=1/0;if(!(this.colliderMeshes.length>=1)||Ml(this._camera,"_collisionTest"))return e;const i=this._getTargetDirection(qr);Ol.lookAt(f0,i,this._camera.up);for(let s=0;s<4;s++){const r=ze.copy(this._nearPlaneCorners[s]);r.applyMatrix4(Ol);const o=_n.addVectors(this._target,r);ca.set(o,i),ca.far=this._spherical.radius+1;const a=ca.intersectObjects(this.colliderMeshes);a.length!==0&&a[0].distance<e&&(e=a[0].distance)}return e}_getClientRect(e){if(!this._domElement)return;const t=this._domElement.getBoundingClientRect();return e.x=t.left,e.y=t.top,this._viewport?(e.x+=this._viewport.x,e.y+=t.height-this._viewport.w-this._viewport.y,e.width=this._viewport.z,e.height=this._viewport.w):(e.width=t.width,e.height=t.height),e}_createOnRestPromise(e){return e?Promise.resolve():(this._hasRested=!1,this.dispatchEvent({type:"transitionstart"}),new Promise(t=>{const i=()=>{this.removeEventListener("rest",i),t()};this.addEventListener("rest",i)}))}_addAllEventListeners(e){}_removeAllEventListeners(){}get dampingFactor(){return console.warn(".dampingFactor has been deprecated. use smoothTime (in seconds) instead."),0}set dampingFactor(e){console.warn(".dampingFactor has been deprecated. use smoothTime (in seconds) instead.")}get draggingDampingFactor(){return console.warn(".draggingDampingFactor has been deprecated. use draggingSmoothTime (in seconds) instead."),0}set draggingDampingFactor(e){console.warn(".draggingDampingFactor has been deprecated. use draggingSmoothTime (in seconds) instead.")}static createBoundingSphere(e,t=new Re.Sphere){const i=t,s=i.center;bn.makeEmpty(),e.traverseVisible(o=>{o.isMesh&&bn.expandByObject(o)}),bn.getCenter(s);let r=0;return e.traverseVisible(o=>{if(!o.isMesh)return;const a=o,c=a.geometry.clone();c.applyMatrix4(a.matrixWorld);const u=c.attributes.position;for(let h=0,f=u.count;h<f;h++)ke.fromBufferAttribute(u,h),r=Math.max(r,s.distanceToSquared(ke))}),i.radius=Math.sqrt(r),i}};const H_=A.forwardRef((n,e)=>{A.useMemo(()=>{const x={Box3:st,MathUtils:{clamp:Ce.clamp},Matrix4:ce,Quaternion:Be,Raycaster:bc,Sphere:si,Spherical:_c,Vector2:de,Vector3:b,Vector4:ft};Ul.install({THREE:x}),dt({CameraControlsImpl:Ul})},[]);const{camera:t,domElement:i,makeDefault:s,onStart:r,onEnd:o,onChange:a,regress:c,...l}=n,u=Z(x=>x.camera),h=Z(x=>x.gl),f=Z(x=>x.invalidate),d=Z(x=>x.events),p=Z(x=>x.setEvents),m=Z(x=>x.set),g=Z(x=>x.get),y=Z(x=>x.performance),v=t||u,E=i||d.connected||h.domElement,C=A.useMemo(()=>new Ul(v),[v]);return Ee((x,I)=>{C.enabled&&C.update(I)},-1),A.useEffect(()=>(C.connect(E),()=>void C.disconnect()),[E,C]),A.useEffect(()=>{const x=w=>{f(),c&&y.regress(),a&&a(w)},I=w=>{r&&r(w)},S=w=>{o&&o(w)};return C.addEventListener("update",x),C.addEventListener("controlstart",I),C.addEventListener("controlend",S),C.addEventListener("control",x),C.addEventListener("transitionstart",x),C.addEventListener("wake",x),()=>{C.removeEventListener("update",x),C.removeEventListener("controlstart",I),C.removeEventListener("controlend",S),C.removeEventListener("control",x),C.removeEventListener("transitionstart",x),C.removeEventListener("wake",x)}},[C,r,o,f,p,c,a]),A.useEffect(()=>{if(s){const x=g().controls;return m({controls:C}),()=>m({controls:x})}},[s,C]),A.createElement("primitive",ie({ref:e,object:C},l))}),hI=n=>(n==null?void 0:n.current)instanceof lt,Dp=A.createContext(null);function fI(){return A.useContext(Dp)}function dI({points:n=50}){const{path:e}=fI(),[t,i]=A.useState([]),[s]=A.useState(()=>new Cs({color:"black"})),[r]=A.useState(()=>new Xm(.025,16,16)),o=A.useRef([]);return A.useEffect(()=>{e.curves!==o.current&&(i(e.getPoints(n)),o.current=e.curves)}),A.createElement(A.Fragment,null,t.map((a,c)=>A.createElement("mesh",{key:c,material:s,geometry:r,position:[a.x,a.y,a.z]})))}const K_=A.forwardRef(({children:n,curves:e=[],object:t,debug:i=!1,smooth:s=!1,focus:r,offset:o=void 0,eps:a=1e-5,damping:c=.1,focusDamping:l=.1,maxSpeed:u=1/0,...h},f)=>{const{camera:d}=Z(),p=A.useRef(),[m]=A.useState(()=>new Gy),g=A.useRef(o??0),y=A.useMemo(()=>({focus:r,object:(t==null?void 0:t.current)instanceof lt?t:{current:d},path:m,current:g.current,offset:g.current,point:new b,tangent:new b,next:new b}),[r,t]);A.useLayoutEffect(()=>{var C;m.curves=[];const x=e.length>0?e:(C=p.current)==null?void 0:C.__r3f.objects;for(var I=0;I<x.length;I++)m.add(x[I]);if(s){const S=m.getPoints(typeof s=="number"?s:1),w=new c1(S);m.curves=[w]}m.updateArcLengths()}),A.useImperativeHandle(f,()=>p.current,[]),A.useLayoutEffect(()=>{g.current=ol.repeat(g.current,1)},[o]);let v=0;const[E]=A.useState(()=>new b);return Ee((C,x)=>{if(v=y.offset,Ar.damp(g,"current",o!==void 0?o:y.current,c,x,u,void 0,a),y.offset=ol.repeat(g.current,1),m.getCurveLengths().length>0){m.getPointAt(y.offset,y.point),m.getTangentAt(y.offset,y.tangent).normalize(),m.getPointAt(ol.repeat(g.current-(v-y.offset),1),y.next);const I=(t==null?void 0:t.current)instanceof lt?t.current:d;I.position.copy(y.point),r&&Ar.dampLookAt(I,hI(r)?r.current.getWorldPosition(E):r,l,x,u,void 0,a)}}),A.createElement("group",ie({ref:p},h),A.createElement(Dp.Provider,{value:y},n,i&&A.createElement(dI,null)))});function AI({defaultScene:n,defaultCamera:e,renderPriority:t=1}){const{gl:i,scene:s,camera:r}=Z();let o;return Ee(()=>{o=i.autoClear,t===1&&(i.autoClear=!0,i.render(n,e)),i.autoClear=!1,i.clearDepth(),i.render(s,r),i.autoClear=o},t),A.createElement("group",{onPointerOver:()=>null})}function mI({children:n,renderPriority:e=1}){const{scene:t,camera:i}=Z(),[s]=A.useState(()=>new Sr);return A.createElement(A.Fragment,null,Ir(A.createElement(A.Fragment,null,n,A.createElement(AI,{defaultScene:t,defaultCamera:i,renderPriority:e})),s,{events:{priority:e+1}}))}const Mp=A.createContext({}),ef=()=>A.useContext(Mp),pI=2*Math.PI,g0=new lt,y0=new ce,[Rn,Ql]=[new Be,new Be],E0=new b,v0=new b,gI=n=>"minPolarAngle"in n,x0=n=>"getTarget"in n,V_=({alignment:n="bottom-right",margin:e=[80,80],renderPriority:t=1,onUpdate:i,onTarget:s,children:r})=>{const o=Z(I=>I.size),a=Z(I=>I.camera),c=Z(I=>I.controls),l=Z(I=>I.invalidate),u=A.useRef(null),h=A.useRef(null),f=A.useRef(!1),d=A.useRef(0),p=A.useRef(new b(0,0,0)),m=A.useRef(new b(0,0,0));A.useEffect(()=>{m.current.copy(a.up)},[a]);const g=A.useCallback(I=>{f.current=!0,(c||s)&&(p.current=(s==null?void 0:s())||(x0(c)?c.getTarget(p.current):c==null?void 0:c.target)),d.current=a.position.distanceTo(E0),Rn.copy(a.quaternion),v0.copy(I).multiplyScalar(d.current).add(E0),g0.lookAt(v0),Ql.copy(g0.quaternion),l()},[c,a,s,l]);Ee((I,S)=>{if(h.current&&u.current){var w;if(f.current)if(Rn.angleTo(Ql)<.01)f.current=!1,gI(c)&&a.up.copy(m.current);else{const B=S*pI;Rn.rotateTowards(Ql,B),a.position.set(0,0,1).applyQuaternion(Rn).multiplyScalar(d.current).add(p.current),a.up.set(0,1,0).applyQuaternion(Rn).normalize(),a.quaternion.copy(Rn),x0(c)&&c.setPosition(a.position.x,a.position.y,a.position.z),i?i():c&&c.update(S),l()}y0.copy(a.matrix).invert(),(w=u.current)==null||w.quaternion.setFromRotationMatrix(y0)}});const y=A.useMemo(()=>({tweenCamera:g}),[g]),[v,E]=e,C=n.endsWith("-center")?0:n.endsWith("-left")?-o.width/2+v:o.width/2-v,x=n.startsWith("center-")?0:n.startsWith("top-")?o.height/2-E:-o.height/2+E;return A.createElement(mI,{renderPriority:t},A.createElement(Mp.Provider,{value:y},A.createElement(oI,{makeDefault:!0,ref:h,position:[0,0,200]}),A.createElement("group",{ref:u,position:[C,x,0]},r)))},go={bg:"#f0f0f0",hover:"#999",text:"black",stroke:"black"},yI=["Right","Left","Top","Bottom","Front","Back"],Lp=n=>new b(...n).multiplyScalar(.38),EI=[[1,1,1],[1,1,-1],[1,-1,1],[1,-1,-1],[-1,1,1],[-1,1,-1],[-1,-1,1],[-1,-1,-1]].map(Lp),vI=[.25,.25,.25],Pp=[[1,1,0],[1,0,1],[1,0,-1],[1,-1,0],[0,1,1],[0,1,-1],[0,-1,1],[0,-1,-1],[-1,1,0],[-1,0,1],[-1,0,-1],[-1,-1,0]].map(Lp),xI=Pp.map(n=>n.toArray().map(e=>e==0?.5:.25)),CI=({hover:n,index:e,font:t="20px Inter var, Arial, sans-serif",faces:i=yI,color:s=go.bg,hoverColor:r=go.hover,textColor:o=go.text,strokeColor:a=go.stroke,opacity:c=1})=>{const l=Z(h=>h.gl),u=A.useMemo(()=>{const h=document.createElement("canvas");h.width=128,h.height=128;const f=h.getContext("2d");return f.fillStyle=s,f.fillRect(0,0,h.width,h.height),f.strokeStyle=a,f.strokeRect(0,0,h.width,h.height),f.font=t,f.textAlign="center",f.fillStyle=o,f.fillText(i[e].toUpperCase(),64,76),new f1(h)},[e,i,t,s,o,a]);return A.createElement("meshBasicMaterial",{map:u,"map-anisotropy":l.capabilities.getMaxAnisotropy()||1,attach:`material-${e}`,color:n?r:"white",transparent:!0,opacity:c})},II=n=>{const{tweenCamera:e}=ef(),[t,i]=A.useState(null),s=a=>{a.stopPropagation(),i(null)},r=a=>{a.stopPropagation(),e(a.face.normal)},o=a=>{a.stopPropagation(),i(Math.floor(a.faceIndex/2))};return A.createElement("mesh",{onPointerOut:s,onPointerMove:o,onClick:n.onClick||r},[...Array(6)].map((a,c)=>A.createElement(CI,ie({key:c,index:c,hover:t===c},n))),A.createElement("boxGeometry",null))},C0=({onClick:n,dimensions:e,position:t,hoverColor:i=go.hover})=>{const{tweenCamera:s}=ef(),[r,o]=A.useState(!1),a=u=>{u.stopPropagation(),o(!1)},c=u=>{u.stopPropagation(),o(!0)},l=u=>{u.stopPropagation(),s(t)};return A.createElement("mesh",{scale:1.01,position:t,onPointerOver:c,onPointerOut:a,onClick:n||l},A.createElement("meshBasicMaterial",{color:r?i:"white",transparent:!0,opacity:.6,visible:r}),A.createElement("boxGeometry",{args:e}))},Y_=n=>A.createElement("group",{scale:[60,60,60]},A.createElement(II,n),Pp.map((e,t)=>A.createElement(C0,ie({key:t,position:e,dimensions:xI[t]},n))),EI.map((e,t)=>A.createElement(C0,ie({key:t,position:e,dimensions:vI},n))));function Nl({scale:n=[.8,.05,.05],color:e,rotation:t}){return A.createElement("group",{rotation:t},A.createElement("mesh",{position:[.4,0,0]},A.createElement("boxGeometry",{args:n}),A.createElement("meshBasicMaterial",{color:e,toneMapped:!1})))}function Dn({onClick:n,font:e,disabled:t,arcStyle:i,label:s,labelColor:r,axisHeadScale:o=1,...a}){const c=Z(m=>m.gl),l=A.useMemo(()=>{const m=document.createElement("canvas");m.width=64,m.height=64;const g=m.getContext("2d");return g.beginPath(),g.arc(32,32,16,0,2*Math.PI),g.closePath(),g.fillStyle=i,g.fill(),s&&(g.font=e,g.textAlign="center",g.fillStyle=r,g.fillText(s,32,41)),new f1(m)},[i,s,r,e]),[u,h]=A.useState(!1),f=(s?1:.75)*(u?1.2:1)*o,d=m=>{m.stopPropagation(),h(!0)},p=m=>{m.stopPropagation(),h(!1)};return A.createElement("sprite",ie({scale:f,onPointerOver:t?void 0:d,onPointerOut:t?void 0:n||p},a),A.createElement("spriteMaterial",{map:l,"map-anisotropy":c.capabilities.getMaxAnisotropy()||1,alphaTest:.3,opacity:s?1:.75,toneMapped:!1}))}const $_=({hideNegativeAxes:n,hideAxisHeads:e,disabled:t,font:i="18px Inter var, Arial, sans-serif",axisColors:s=["#ff2060","#20df80","#2080ff"],axisHeadScale:r=1,axisScale:o,labels:a=["X","Y","Z"],labelColor:c="#000",onClick:l,...u})=>{const[h,f,d]=s,{tweenCamera:p}=ef(),m={font:i,disabled:t,labelColor:c,onClick:l,axisHeadScale:r,onPointerDown:t?void 0:g=>{p(g.object.position),g.stopPropagation()}};return A.createElement("group",ie({scale:40},u),A.createElement(Nl,{color:h,rotation:[0,0,0],scale:o}),A.createElement(Nl,{color:f,rotation:[0,0,Math.PI/2],scale:o}),A.createElement(Nl,{color:d,rotation:[0,-Math.PI/2,0],scale:o}),!e&&A.createElement(A.Fragment,null,A.createElement(Dn,ie({arcStyle:h,position:[1,0,0],label:a[0]},m)),A.createElement(Dn,ie({arcStyle:f,position:[0,1,0],label:a[1]},m)),A.createElement(Dn,ie({arcStyle:d,position:[0,0,1],label:a[2]},m)),!n&&A.createElement(A.Fragment,null,A.createElement(Dn,ie({arcStyle:h,position:[-1,0,0]},m)),A.createElement(Dn,ie({arcStyle:f,position:[0,-1,0]},m)),A.createElement(Dn,ie({arcStyle:d,position:[0,0,-1]},m)))))},SI=Ri({cellSize:.5,sectionSize:1,fadeDistance:100,fadeStrength:1,fadeFrom:1,cellThickness:.5,sectionThickness:1,cellColor:new xe,sectionColor:new xe,infiniteGrid:!1,followCamera:!1,worldCamProjPosition:new b,worldPlanePosition:new b},`
    varying vec3 localPosition;
    varying vec4 worldPosition;

    uniform vec3 worldCamProjPosition;
    uniform vec3 worldPlanePosition;
    uniform float fadeDistance;
    uniform bool infiniteGrid;
    uniform bool followCamera;

    void main() {
      localPosition = position.xzy;
      if (infiniteGrid) localPosition *= 1.0 + fadeDistance;
      
      worldPosition = modelMatrix * vec4(localPosition, 1.0);
      if (followCamera) {
        worldPosition.xyz += (worldCamProjPosition - worldPlanePosition);
        localPosition = (inverse(modelMatrix) * worldPosition).xyz;
      }

      gl_Position = projectionMatrix * viewMatrix * worldPosition;
    }
  `,`
    varying vec3 localPosition;
    varying vec4 worldPosition;

    uniform vec3 worldCamProjPosition;
    uniform float cellSize;
    uniform float sectionSize;
    uniform vec3 cellColor;
    uniform vec3 sectionColor;
    uniform float fadeDistance;
    uniform float fadeStrength;
    uniform float fadeFrom;
    uniform float cellThickness;
    uniform float sectionThickness;

    float getGrid(float size, float thickness) {
      vec2 r = localPosition.xz / size;
      vec2 grid = abs(fract(r - 0.5) - 0.5) / fwidth(r);
      float line = min(grid.x, grid.y) + 1.0 - thickness;
      return 1.0 - min(line, 1.0);
    }

    void main() {
      float g1 = getGrid(cellSize, cellThickness);
      float g2 = getGrid(sectionSize, sectionThickness);

      vec3 from = worldCamProjPosition*vec3(fadeFrom);
      float dist = distance(from, worldPosition.xyz);
      float d = 1.0 - min(dist / fadeDistance, 1.0);
      vec3 color = mix(cellColor, sectionColor, min(1.0, sectionThickness * g2));

      gl_FragColor = vec4(color, (g1 + g2) * pow(d, fadeStrength));
      gl_FragColor.a = mix(0.75 * gl_FragColor.a, gl_FragColor.a, g2);
      if (gl_FragColor.a <= 0.0) discard;

      #include <tonemapping_fragment>
      #include <${qt>=154?"colorspace_fragment":"encodings_fragment"}>
    }
  `),W_=A.forwardRef(({args:n,cellColor:e="#000000",sectionColor:t="#2080ff",cellSize:i=.5,sectionSize:s=1,followCamera:r=!1,infiniteGrid:o=!1,fadeDistance:a=100,fadeStrength:c=1,fadeFrom:l=1,cellThickness:u=.5,sectionThickness:h=1,side:f=Cr,...d},p)=>{dt({GridMaterial:SI});const m=A.useRef(null);A.useImperativeHandle(p,()=>m.current,[]);const g=new bs,y=new b(0,1,0),v=new b(0,0,0);Ee(x=>{g.setFromNormalAndCoplanarPoint(y,v).applyMatrix4(m.current.matrixWorld);const I=m.current.material,S=I.uniforms.worldCamProjPosition,w=I.uniforms.worldPlanePosition;g.projectPoint(x.camera.position,S.value),w.value.set(0,0,0).applyMatrix4(m.current.matrixWorld)});const E={cellSize:i,sectionSize:s,cellColor:e,sectionColor:t,cellThickness:u,sectionThickness:h},C={fadeDistance:a,fadeStrength:c,fadeFrom:l,infiniteGrid:o,followCamera:r};return A.createElement("mesh",ie({ref:m,frustumCulled:!1},d),A.createElement("gridMaterial",ie({transparent:!0,"extensions-derivatives":!0,side:f},E,C)),A.createElement("planeGeometry",{args:n}))});function Fp(n,{path:e}){const[t]=gt(d1,[n],i=>i.setPath(e));return t}Fp.preload=(n,{path:e})=>gt.preload(d1,[n],t=>t.setPath(e));function j_({children:n,files:e,...t}){const i=Fp(e,{...t});return A.createElement(A.Fragment,null,n==null?void 0:n(i))}function tf(n){return gt($h,n)}tf.preload=n=>gt.preload($h,n);tf.clear=n=>gt.clear($h,n);function J_({path:n,...e}){const i=tf(n).children[0];return A.createElement(mc,ie({},e,{object:i}))}const kp="https://cdn.jsdelivr.net/gh/pmndrs/drei-assets@master";function sf(n,e=`${kp}/basis/`){const t=Z(s=>s.gl),i=gt(mn,So(n)?Object.values(n):n,s=>{s.detectSupport(t),s.setTranscoderPath(e)});if(A.useEffect(()=>{(Array.isArray(i)?i:[i]).forEach(t.initTexture)},[t,i]),So(n)){const s=Object.keys(n),r={};return s.forEach(o=>Object.assign(r,{[o]:i[s.indexOf(o)]})),r}else return i}sf.preload=(n,e=`${kp}/basis/`)=>gt.preload(mn,n,t=>{t.setTranscoderPath(e)});sf.clear=n=>gt.clear(mn,n);const q_=({children:n,input:e,basisPath:t})=>{const i=sf(e,t);return A.createElement(A.Fragment,null,n==null?void 0:n(i))};function wI(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}var Op={exports:{}};(function(n,e){(function(t){var i=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,s=/^(?=([^\/?#]*))\1([^]*)$/,r=/(?:\/|^)\.(?=\/)/g,o=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,a={buildAbsoluteURL:function(c,l,u){if(u=u||{},c=c.trim(),l=l.trim(),!l){if(!u.alwaysNormalize)return c;var h=a.parseURL(c);if(!h)throw new Error("Error trying to parse base URL.");return h.path=a.normalizePath(h.path),a.buildURLFromParts(h)}var f=a.parseURL(l);if(!f)throw new Error("Error trying to parse relative URL.");if(f.scheme)return u.alwaysNormalize?(f.path=a.normalizePath(f.path),a.buildURLFromParts(f)):l;var d=a.parseURL(c);if(!d)throw new Error("Error trying to parse base URL.");if(!d.netLoc&&d.path&&d.path[0]!=="/"){var p=s.exec(d.path);d.netLoc=p[1],d.path=p[2]}d.netLoc&&!d.path&&(d.path="/");var m={scheme:d.scheme,netLoc:f.netLoc,path:null,params:f.params,query:f.query,fragment:f.fragment};if(!f.netLoc&&(m.netLoc=d.netLoc,f.path[0]!=="/"))if(!f.path)m.path=d.path,f.params||(m.params=d.params,f.query||(m.query=d.query));else{var g=d.path,y=g.substring(0,g.lastIndexOf("/")+1)+f.path;m.path=a.normalizePath(y)}return m.path===null&&(m.path=u.alwaysNormalize?a.normalizePath(f.path):f.path),a.buildURLFromParts(m)},parseURL:function(c){var l=i.exec(c);return l?{scheme:l[1]||"",netLoc:l[2]||"",path:l[3]||"",params:l[4]||"",query:l[5]||"",fragment:l[6]||""}:null},normalizePath:function(c){for(c=c.split("").reverse().join("").replace(r,"");c.length!==(c=c.replace(o,"")).length;);return c.split("").reverse().join("")},buildURLFromParts:function(c){return c.scheme+c.netLoc+c.path+c.params+c.query+c.fragment}};n.exports=a})()})(Op);var nf=Op.exports;function I0(n,e){var t=Object.keys(n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(n);e&&(i=i.filter(function(s){return Object.getOwnPropertyDescriptor(n,s).enumerable})),t.push.apply(t,i)}return t}function Mt(n){for(var e=1;e<arguments.length;e++){var t=arguments[e]!=null?arguments[e]:{};e%2?I0(Object(t),!0).forEach(function(i){_I(n,i,t[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(t)):I0(Object(t)).forEach(function(i){Object.defineProperty(n,i,Object.getOwnPropertyDescriptor(t,i))})}return n}function TI(n,e){if(typeof n!="object"||!n)return n;var t=n[Symbol.toPrimitive];if(t!==void 0){var i=t.call(n,e||"default");if(typeof i!="object")return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(n)}function BI(n){var e=TI(n,"string");return typeof e=="symbol"?e:String(e)}function _I(n,e,t){return e=BI(e),e in n?Object.defineProperty(n,e,{value:t,enumerable:!0,configurable:!0,writable:!0}):n[e]=t,n}function pt(){return pt=Object.assign?Object.assign.bind():function(n){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(n[i]=t[i])}return n},pt.apply(this,arguments)}const ve=Number.isFinite||function(n){return typeof n=="number"&&isFinite(n)},bI=Number.isSafeInteger||function(n){return typeof n=="number"&&Math.abs(n)<=RI},RI=Number.MAX_SAFE_INTEGER||9007199254740991;let D=function(n){return n.MEDIA_ATTACHING="hlsMediaAttaching",n.MEDIA_ATTACHED="hlsMediaAttached",n.MEDIA_DETACHING="hlsMediaDetaching",n.MEDIA_DETACHED="hlsMediaDetached",n.BUFFER_RESET="hlsBufferReset",n.BUFFER_CODECS="hlsBufferCodecs",n.BUFFER_CREATED="hlsBufferCreated",n.BUFFER_APPENDING="hlsBufferAppending",n.BUFFER_APPENDED="hlsBufferAppended",n.BUFFER_EOS="hlsBufferEos",n.BUFFER_FLUSHING="hlsBufferFlushing",n.BUFFER_FLUSHED="hlsBufferFlushed",n.MANIFEST_LOADING="hlsManifestLoading",n.MANIFEST_LOADED="hlsManifestLoaded",n.MANIFEST_PARSED="hlsManifestParsed",n.LEVEL_SWITCHING="hlsLevelSwitching",n.LEVEL_SWITCHED="hlsLevelSwitched",n.LEVEL_LOADING="hlsLevelLoading",n.LEVEL_LOADED="hlsLevelLoaded",n.LEVEL_UPDATED="hlsLevelUpdated",n.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",n.LEVELS_UPDATED="hlsLevelsUpdated",n.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",n.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",n.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",n.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",n.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",n.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",n.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",n.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",n.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",n.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",n.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",n.CUES_PARSED="hlsCuesParsed",n.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",n.INIT_PTS_FOUND="hlsInitPtsFound",n.FRAG_LOADING="hlsFragLoading",n.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",n.FRAG_LOADED="hlsFragLoaded",n.FRAG_DECRYPTED="hlsFragDecrypted",n.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",n.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",n.FRAG_PARSING_METADATA="hlsFragParsingMetadata",n.FRAG_PARSED="hlsFragParsed",n.FRAG_BUFFERED="hlsFragBuffered",n.FRAG_CHANGED="hlsFragChanged",n.FPS_DROP="hlsFpsDrop",n.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",n.MAX_AUTO_LEVEL_UPDATED="hlsMaxAutoLevelUpdated",n.ERROR="hlsError",n.DESTROYING="hlsDestroying",n.KEY_LOADING="hlsKeyLoading",n.KEY_LOADED="hlsKeyLoaded",n.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",n.BACK_BUFFER_REACHED="hlsBackBufferReached",n.STEERING_MANIFEST_LOADED="hlsSteeringManifestLoaded",n}({}),_e=function(n){return n.NETWORK_ERROR="networkError",n.MEDIA_ERROR="mediaError",n.KEY_SYSTEM_ERROR="keySystemError",n.MUX_ERROR="muxError",n.OTHER_ERROR="otherError",n}({}),te=function(n){return n.KEY_SYSTEM_NO_KEYS="keySystemNoKeys",n.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",n.KEY_SYSTEM_NO_SESSION="keySystemNoSession",n.KEY_SYSTEM_NO_CONFIGURED_LICENSE="keySystemNoConfiguredLicense",n.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",n.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED="keySystemServerCertificateRequestFailed",n.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED="keySystemServerCertificateUpdateFailed",n.KEY_SYSTEM_SESSION_UPDATE_FAILED="keySystemSessionUpdateFailed",n.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED="keySystemStatusOutputRestricted",n.KEY_SYSTEM_STATUS_INTERNAL_ERROR="keySystemStatusInternalError",n.MANIFEST_LOAD_ERROR="manifestLoadError",n.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",n.MANIFEST_PARSING_ERROR="manifestParsingError",n.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",n.LEVEL_EMPTY_ERROR="levelEmptyError",n.LEVEL_LOAD_ERROR="levelLoadError",n.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",n.LEVEL_PARSING_ERROR="levelParsingError",n.LEVEL_SWITCH_ERROR="levelSwitchError",n.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",n.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",n.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",n.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",n.FRAG_LOAD_ERROR="fragLoadError",n.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",n.FRAG_DECRYPT_ERROR="fragDecryptError",n.FRAG_PARSING_ERROR="fragParsingError",n.FRAG_GAP="fragGap",n.REMUX_ALLOC_ERROR="remuxAllocError",n.KEY_LOAD_ERROR="keyLoadError",n.KEY_LOAD_TIMEOUT="keyLoadTimeOut",n.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",n.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",n.BUFFER_APPEND_ERROR="bufferAppendError",n.BUFFER_APPENDING_ERROR="bufferAppendingError",n.BUFFER_STALLED_ERROR="bufferStalledError",n.BUFFER_FULL_ERROR="bufferFullError",n.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",n.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",n.INTERNAL_EXCEPTION="internalException",n.INTERNAL_ABORTED="aborted",n.UNKNOWN="unknown",n}({});const en=function(){},rh={trace:en,debug:en,log:en,warn:en,info:en,error:en};let wo=rh;function DI(n){const e=self.console[n];return e?e.bind(self.console,`[${n}] >`):en}function MI(n,...e){e.forEach(function(t){wo[t]=n[t]?n[t].bind(n):DI(t)})}function LI(n,e){if(typeof console=="object"&&n===!0||typeof n=="object"){MI(n,"debug","log","info","warn","error");try{wo.log(`Debug logs enabled for "${e}" in hls.js version 1.5.17`)}catch{wo=rh}}else wo=rh}const j=wo,PI=/^(\d+)x(\d+)$/,S0=/(.+?)=(".*?"|.*?)(?:,|$)/g;class rt{constructor(e){typeof e=="string"&&(e=rt.parseAttrList(e)),pt(this,e)}get clientAttrs(){return Object.keys(this).filter(e=>e.substring(0,2)==="X-")}decimalInteger(e){const t=parseInt(this[e],10);return t>Number.MAX_SAFE_INTEGER?1/0:t}hexadecimalInteger(e){if(this[e]){let t=(this[e]||"0x").slice(2);t=(t.length&1?"0":"")+t;const i=new Uint8Array(t.length/2);for(let s=0;s<t.length/2;s++)i[s]=parseInt(t.slice(s*2,s*2+2),16);return i}else return null}hexadecimalIntegerAsNumber(e){const t=parseInt(this[e],16);return t>Number.MAX_SAFE_INTEGER?1/0:t}decimalFloatingPoint(e){return parseFloat(this[e])}optionalFloat(e,t){const i=this[e];return i?parseFloat(i):t}enumeratedString(e){return this[e]}bool(e){return this[e]==="YES"}decimalResolution(e){const t=PI.exec(this[e]);if(t!==null)return{width:parseInt(t[1],10),height:parseInt(t[2],10)}}static parseAttrList(e){let t;const i={},s='"';for(S0.lastIndex=0;(t=S0.exec(e))!==null;){let r=t[2];r.indexOf(s)===0&&r.lastIndexOf(s)===r.length-1&&(r=r.slice(1,-1));const o=t[1].trim();i[o]=r}return i}}function FI(n){return n!=="ID"&&n!=="CLASS"&&n!=="START-DATE"&&n!=="DURATION"&&n!=="END-DATE"&&n!=="END-ON-NEXT"}function kI(n){return n==="SCTE35-OUT"||n==="SCTE35-IN"}class rf{constructor(e,t){if(this.attr=void 0,this._startDate=void 0,this._endDate=void 0,this._badValueForSameId=void 0,t){const i=t.attr;for(const s in i)if(Object.prototype.hasOwnProperty.call(e,s)&&e[s]!==i[s]){j.warn(`DATERANGE tag attribute: "${s}" does not match for tags with ID: "${e.ID}"`),this._badValueForSameId=s;break}e=pt(new rt({}),i,e)}if(this.attr=e,this._startDate=new Date(e["START-DATE"]),"END-DATE"in this.attr){const i=new Date(this.attr["END-DATE"]);ve(i.getTime())&&(this._endDate=i)}}get id(){return this.attr.ID}get class(){return this.attr.CLASS}get startDate(){return this._startDate}get endDate(){if(this._endDate)return this._endDate;const e=this.duration;return e!==null?new Date(this._startDate.getTime()+e*1e3):null}get duration(){if("DURATION"in this.attr){const e=this.attr.decimalFloatingPoint("DURATION");if(ve(e))return e}else if(this._endDate)return(this._endDate.getTime()-this._startDate.getTime())/1e3;return null}get plannedDuration(){return"PLANNED-DURATION"in this.attr?this.attr.decimalFloatingPoint("PLANNED-DURATION"):null}get endOnNext(){return this.attr.bool("END-ON-NEXT")}get isValid(){return!!this.id&&!this._badValueForSameId&&ve(this.startDate.getTime())&&(this.duration===null||this.duration>=0)&&(!this.endOnNext||!!this.class)}}class Qo{constructor(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}}var $e={AUDIO:"audio",VIDEO:"video",AUDIOVIDEO:"audiovideo"};class of{constructor(e){this._byteRange=null,this._url=null,this.baseurl=void 0,this.relurl=void 0,this.elementaryStreams={[$e.AUDIO]:null,[$e.VIDEO]:null,[$e.AUDIOVIDEO]:null},this.baseurl=e}setByteRange(e,t){const i=e.split("@",2);let s;i.length===1?s=(t==null?void 0:t.byteRangeEndOffset)||0:s=parseInt(i[1]),this._byteRange=[s,parseInt(i[0])+s]}get byteRange(){return this._byteRange?this._byteRange:[]}get byteRangeStartOffset(){return this.byteRange[0]}get byteRangeEndOffset(){return this.byteRange[1]}get url(){return!this._url&&this.baseurl&&this.relurl&&(this._url=nf.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||""}set url(e){this._url=e}}class qa extends of{constructor(e,t){super(t),this._decryptdata=null,this.rawProgramDateTime=null,this.programDateTime=null,this.tagList=[],this.duration=0,this.sn=0,this.levelkeys=void 0,this.type=void 0,this.loader=null,this.keyLoader=null,this.level=-1,this.cc=0,this.startPTS=void 0,this.endPTS=void 0,this.startDTS=void 0,this.endDTS=void 0,this.start=0,this.deltaPTS=void 0,this.maxStartPTS=void 0,this.minEndPTS=void 0,this.stats=new Qo,this.data=void 0,this.bitrateTest=!1,this.title=null,this.initSegment=null,this.endList=void 0,this.gap=void 0,this.urlId=0,this.type=e}get decryptdata(){const{levelkeys:e}=this;if(!e&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkeys&&!this.levelkeys.NONE){const t=this.levelkeys.identity;if(t)this._decryptdata=t.getDecryptData(this.sn);else{const i=Object.keys(this.levelkeys);if(i.length===1)return this._decryptdata=this.levelkeys[i[0]].getDecryptData(this.sn)}}return this._decryptdata}get end(){return this.start+this.duration}get endProgramDateTime(){if(this.programDateTime===null||!ve(this.programDateTime))return null;const e=ve(this.duration)?this.duration:0;return this.programDateTime+e*1e3}get encrypted(){var e;if((e=this._decryptdata)!=null&&e.encrypted)return!0;if(this.levelkeys){const t=Object.keys(this.levelkeys),i=t.length;if(i>1||i===1&&this.levelkeys[t[0]].encrypted)return!0}return!1}setKeyFormat(e){if(this.levelkeys){const t=this.levelkeys[e];t&&!this._decryptdata&&(this._decryptdata=t.getDecryptData(this.sn))}}abortRequests(){var e,t;(e=this.loader)==null||e.abort(),(t=this.keyLoader)==null||t.abort()}setElementaryStreamInfo(e,t,i,s,r,o=!1){const{elementaryStreams:a}=this,c=a[e];if(!c){a[e]={startPTS:t,endPTS:i,startDTS:s,endDTS:r,partial:o};return}c.startPTS=Math.min(c.startPTS,t),c.endPTS=Math.max(c.endPTS,i),c.startDTS=Math.min(c.startDTS,s),c.endDTS=Math.max(c.endDTS,r)}clearElementaryStreamInfo(){const{elementaryStreams:e}=this;e[$e.AUDIO]=null,e[$e.VIDEO]=null,e[$e.AUDIOVIDEO]=null}}class Up extends of{constructor(e,t,i,s,r){super(i),this.fragOffset=0,this.duration=0,this.gap=!1,this.independent=!1,this.relurl=void 0,this.fragment=void 0,this.index=void 0,this.stats=new Qo,this.duration=e.decimalFloatingPoint("DURATION"),this.gap=e.bool("GAP"),this.independent=e.bool("INDEPENDENT"),this.relurl=e.enumeratedString("URI"),this.fragment=t,this.index=s;const o=e.enumeratedString("BYTERANGE");o&&this.setByteRange(o,r),r&&(this.fragOffset=r.fragOffset+r.duration)}get start(){return this.fragment.start+this.fragOffset}get end(){return this.start+this.duration}get loaded(){const{elementaryStreams:e}=this;return!!(e.audio||e.video||e.audiovideo)}}const OI=10;class Qp{constructor(e){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.dateRanges=void 0,this.live=!0,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.availabilityDelay=void 0,this.misses=0,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.encryptedFragments=void 0,this.playlistParsingError=null,this.variableList=null,this.hasVariableRefs=!1,this.fragments=[],this.encryptedFragments=[],this.dateRanges={},this.url=e}reloaded(e){if(!e){this.advanced=!0,this.updated=!0;return}const t=this.lastPartSn-e.lastPartSn,i=this.lastPartIndex-e.lastPartIndex;this.updated=this.endSN!==e.endSN||!!i||!!t||!this.live,this.advanced=this.endSN>e.endSN||t>0||t===0&&i>0,this.updated||this.advanced?this.misses=Math.floor(e.misses*.6):this.misses=e.misses+1,this.availabilityDelay=e.availabilityDelay}get hasProgramDateTime(){return this.fragments.length?ve(this.fragments[this.fragments.length-1].programDateTime):!1}get levelTargetDuration(){return this.averagetargetduration||this.targetduration||OI}get drift(){const e=this.driftEndTime-this.driftStartTime;return e>0?(this.driftEnd-this.driftStart)*1e3/e:1}get edge(){return this.partEnd||this.fragmentEnd}get partEnd(){var e;return(e=this.partList)!=null&&e.length?this.partList[this.partList.length-1].end:this.fragmentEnd}get fragmentEnd(){var e;return(e=this.fragments)!=null&&e.length?this.fragments[this.fragments.length-1].end:0}get age(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}get lastPartIndex(){var e;return(e=this.partList)!=null&&e.length?this.partList[this.partList.length-1].index:-1}get lastPartSn(){var e;return(e=this.partList)!=null&&e.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}}function af(n){return Uint8Array.from(atob(n),e=>e.charCodeAt(0))}function UI(n){const e=oh(n).subarray(0,16),t=new Uint8Array(16);return t.set(e,16-e.length),t}function QI(n){const e=function(i,s,r){const o=i[s];i[s]=i[r],i[r]=o};e(n,0,3),e(n,1,2),e(n,4,5),e(n,6,7)}function NI(n){const e=n.split(":");let t=null;if(e[0]==="data"&&e.length===2){const i=e[1].split(";"),s=i[i.length-1].split(",");if(s.length===2){const r=s[0]==="base64",o=s[1];r?(i.splice(-1,1),t=af(o)):t=UI(o)}}return t}function oh(n){return Uint8Array.from(unescape(encodeURIComponent(n)),e=>e.charCodeAt(0))}const pr=typeof self<"u"?self:void 0;var je={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.fps",PLAYREADY:"com.microsoft.playready",WIDEVINE:"com.widevine.alpha"},$t={CLEARKEY:"org.w3.clearkey",FAIRPLAY:"com.apple.streamingkeydelivery",PLAYREADY:"com.microsoft.playready",WIDEVINE:"urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed"};function w0(n){switch(n){case $t.FAIRPLAY:return je.FAIRPLAY;case $t.PLAYREADY:return je.PLAYREADY;case $t.WIDEVINE:return je.WIDEVINE;case $t.CLEARKEY:return je.CLEARKEY}}var yo={CENC:"1077efecc0b24d02ace33c1e52e2fb4b",CLEARKEY:"e2719d58a985b3c9781ab030af78d30e",FAIRPLAY:"94ce86fb07ff4f43adb893d2fa968ca2",PLAYREADY:"9a04f07998404286ab92e65be0885f95",WIDEVINE:"edef8ba979d64acea3c827dcd51d21ed"};function T0(n){if(n===yo.WIDEVINE)return je.WIDEVINE;if(n===yo.PLAYREADY)return je.PLAYREADY;if(n===yo.CENC||n===yo.CLEARKEY)return je.CLEARKEY}function B0(n){switch(n){case je.FAIRPLAY:return $t.FAIRPLAY;case je.PLAYREADY:return $t.PLAYREADY;case je.WIDEVINE:return $t.WIDEVINE;case je.CLEARKEY:return $t.CLEARKEY}}function Gl(n){const{drmSystems:e,widevineLicenseUrl:t}=n,i=e?[je.FAIRPLAY,je.WIDEVINE,je.PLAYREADY,je.CLEARKEY].filter(s=>!!e[s]):[];return!i[je.WIDEVINE]&&t&&i.push(je.WIDEVINE),i}const Np=function(n){return pr!=null&&(n=pr.navigator)!=null&&n.requestMediaKeySystemAccess?self.navigator.requestMediaKeySystemAccess.bind(self.navigator):null}();function GI(n,e,t,i){let s;switch(n){case je.FAIRPLAY:s=["cenc","sinf"];break;case je.WIDEVINE:case je.PLAYREADY:s=["cenc"];break;case je.CLEARKEY:s=["cenc","keyids"];break;default:throw new Error(`Unknown key-system: ${n}`)}return zI(s,e,t,i)}function zI(n,e,t,i){return[{initDataTypes:n,persistentState:i.persistentState||"optional",distinctiveIdentifier:i.distinctiveIdentifier||"optional",sessionTypes:i.sessionTypes||[i.sessionType||"temporary"],audioCapabilities:e.map(r=>({contentType:`audio/mp4; codecs="${r}"`,robustness:i.audioRobustness||"",encryptionScheme:i.audioEncryptionScheme||null})),videoCapabilities:t.map(r=>({contentType:`video/mp4; codecs="${r}"`,robustness:i.videoRobustness||"",encryptionScheme:i.videoEncryptionScheme||null}))}]}function an(n,e,t){return Uint8Array.prototype.slice?n.slice(e,t):new Uint8Array(Array.prototype.slice.call(n,e,t))}const cf=(n,e)=>e+10<=n.length&&n[e]===73&&n[e+1]===68&&n[e+2]===51&&n[e+3]<255&&n[e+4]<255&&n[e+6]<128&&n[e+7]<128&&n[e+8]<128&&n[e+9]<128,Gp=(n,e)=>e+10<=n.length&&n[e]===51&&n[e+1]===68&&n[e+2]===73&&n[e+3]<255&&n[e+4]<255&&n[e+6]<128&&n[e+7]<128&&n[e+8]<128&&n[e+9]<128,Mo=(n,e)=>{const t=e;let i=0;for(;cf(n,e);){i+=10;const s=Nc(n,e+6);i+=s,Gp(n,e+10)&&(i+=10),e+=i}if(i>0)return n.subarray(t,t+i)},Nc=(n,e)=>{let t=0;return t=(n[e]&127)<<21,t|=(n[e+1]&127)<<14,t|=(n[e+2]&127)<<7,t|=n[e+3]&127,t},HI=(n,e)=>cf(n,e)&&Nc(n,e+6)+10<=n.length-e,lf=n=>{const e=Hp(n);for(let t=0;t<e.length;t++){const i=e[t];if(zp(i))return jI(i)}},zp=n=>n&&n.key==="PRIV"&&n.info==="com.apple.streaming.transportStreamTimestamp",KI=n=>{const e=String.fromCharCode(n[0],n[1],n[2],n[3]),t=Nc(n,4),i=10;return{type:e,size:t,data:n.subarray(i,i+t)}},Hp=n=>{let e=0;const t=[];for(;cf(n,e);){const i=Nc(n,e+6);e+=10;const s=e+i;for(;e+8<s;){const r=KI(n.subarray(e)),o=VI(r);o&&t.push(o),e+=r.size+10}Gp(n,e)&&(e+=10)}return t},VI=n=>n.type==="PRIV"?YI(n):n.type[0]==="W"?WI(n):$I(n),YI=n=>{if(n.size<2)return;const e=os(n.data,!0),t=new Uint8Array(n.data.subarray(e.length+1));return{key:n.type,info:e,data:t.buffer}},$I=n=>{if(n.size<2)return;if(n.type==="TXXX"){let t=1;const i=os(n.data.subarray(t),!0);t+=i.length+1;const s=os(n.data.subarray(t));return{key:n.type,info:i,data:s}}const e=os(n.data.subarray(1));return{key:n.type,data:e}},WI=n=>{if(n.type==="WXXX"){if(n.size<2)return;let t=1;const i=os(n.data.subarray(t),!0);t+=i.length+1;const s=os(n.data.subarray(t));return{key:n.type,info:i,data:s}}const e=os(n.data);return{key:n.type,data:e}},jI=n=>{if(n.data.byteLength===8){const e=new Uint8Array(n.data),t=e[3]&1;let i=(e[4]<<23)+(e[5]<<15)+(e[6]<<7)+e[7];return i/=45,t&&(i+=4772185884e-2),Math.round(i)}},os=(n,e=!1)=>{const t=JI();if(t){const l=t.decode(n);if(e){const u=l.indexOf("\0");return u!==-1?l.substring(0,u):l}return l.replace(/\0/g,"")}const i=n.length;let s,r,o,a="",c=0;for(;c<i;){if(s=n[c++],s===0&&e)return a;if(s===0||s===3)continue;switch(s>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:a+=String.fromCharCode(s);break;case 12:case 13:r=n[c++],a+=String.fromCharCode((s&31)<<6|r&63);break;case 14:r=n[c++],o=n[c++],a+=String.fromCharCode((s&15)<<12|(r&63)<<6|(o&63)<<0);break}}return a};let zl;function JI(){if(!navigator.userAgent.includes("PlayStation 4"))return!zl&&typeof self.TextDecoder<"u"&&(zl=new self.TextDecoder("utf-8")),zl}const ji={hexDump:function(n){let e="";for(let t=0;t<n.length;t++){let i=n[t].toString(16);i.length<2&&(i="0"+i),e+=i}return e}},pc=Math.pow(2,32)-1,qI=[].push,Kp={video:1,audio:2,id3:3,text:4};function xt(n){return String.fromCharCode.apply(null,n)}function Vp(n,e){const t=n[e]<<8|n[e+1];return t<0?65536+t:t}function Te(n,e){const t=Yp(n,e);return t<0?4294967296+t:t}function _0(n,e){let t=Te(n,e);return t*=Math.pow(2,32),t+=Te(n,e+4),t}function Yp(n,e){return n[e]<<24|n[e+1]<<16|n[e+2]<<8|n[e+3]}function Hl(n,e,t){n[e]=t>>24,n[e+1]=t>>16&255,n[e+2]=t>>8&255,n[e+3]=t&255}function XI(n){const e=n.byteLength;for(let t=0;t<e;){const i=Te(n,t);if(i>8&&n[t+4]===109&&n[t+5]===111&&n[t+6]===111&&n[t+7]===102)return!0;t=i>1?t+i:e}return!1}function Le(n,e){const t=[];if(!e.length)return t;const i=n.byteLength;for(let s=0;s<i;){const r=Te(n,s),o=xt(n.subarray(s+4,s+8)),a=r>1?s+r:i;if(o===e[0])if(e.length===1)t.push(n.subarray(s+8,a));else{const c=Le(n.subarray(s+8,a),e.slice(1));c.length&&qI.apply(t,c)}s=a}return t}function ZI(n){const e=[],t=n[0];let i=8;const s=Te(n,i);i+=4;let r=0,o=0;t===0?(r=Te(n,i),o=Te(n,i+4),i+=8):(r=_0(n,i),o=_0(n,i+8),i+=16),i+=2;let a=n.length+o;const c=Vp(n,i);i+=2;for(let l=0;l<c;l++){let u=i;const h=Te(n,u);u+=4;const f=h&2147483647;if((h&2147483648)>>>31===1)return j.warn("SIDX has hierarchical references (not supported)"),null;const p=Te(n,u);u+=4,e.push({referenceSize:f,subsegmentDuration:p,info:{duration:p/s,start:a,end:a+f-1}}),a+=f,u+=4,i=u}return{earliestPresentationTime:r,timescale:s,version:t,referencesCount:c,references:e}}function $p(n){const e=[],t=Le(n,["moov","trak"]);for(let s=0;s<t.length;s++){const r=t[s],o=Le(r,["tkhd"])[0];if(o){let a=o[0];const c=Te(o,a===0?12:20),l=Le(r,["mdia","mdhd"])[0];if(l){a=l[0];const u=Te(l,a===0?12:20),h=Le(r,["mdia","hdlr"])[0];if(h){const f=xt(h.subarray(8,12)),d={soun:$e.AUDIO,vide:$e.VIDEO}[f];if(d){const p=Le(r,["mdia","minf","stbl","stsd"])[0],m=e5(p);e[c]={timescale:u,type:d},e[d]=Mt({timescale:u,id:c},m)}}}}}return Le(n,["moov","mvex","trex"]).forEach(s=>{const r=Te(s,4),o=e[r];o&&(o.default={duration:Te(s,12),flags:Te(s,20)})}),e}function e5(n){const e=n.subarray(8),t=e.subarray(86),i=xt(e.subarray(4,8));let s=i;const r=i==="enca"||i==="encv";if(r){const a=Le(e,[i])[0].subarray(i==="enca"?28:78);Le(a,["sinf"]).forEach(l=>{const u=Le(l,["schm"])[0];if(u){const h=xt(u.subarray(4,8));if(h==="cbcs"||h==="cenc"){const f=Le(l,["frma"])[0];f&&(s=xt(f))}}})}switch(s){case"avc1":case"avc2":case"avc3":case"avc4":{const o=Le(t,["avcC"])[0];s+="."+la(o[1])+la(o[2])+la(o[3]);break}case"mp4a":{const o=Le(e,[i])[0],a=Le(o.subarray(28),["esds"])[0];if(a&&a.length>12){let c=4;if(a[c++]!==3)break;c=Kl(a,c),c+=2;const l=a[c++];if(l&128&&(c+=2),l&64&&(c+=a[c++]),a[c++]!==4)break;c=Kl(a,c);const u=a[c++];if(u===64)s+="."+la(u);else break;if(c+=12,a[c++]!==5)break;c=Kl(a,c);const h=a[c++];let f=(h&248)>>3;f===31&&(f+=1+((h&7)<<3)+((a[c]&224)>>5)),s+="."+f}break}case"hvc1":case"hev1":{const o=Le(t,["hvcC"])[0],a=o[1],c=["","A","B","C"][a>>6],l=a&31,u=Te(o,2),h=(a&32)>>5?"H":"L",f=o[12],d=o.subarray(6,12);s+="."+c+l,s+="."+u.toString(16).toUpperCase(),s+="."+h+f;let p="";for(let m=d.length;m--;){const g=d[m];(g||p)&&(p="."+g.toString(16).toUpperCase()+p)}s+=p;break}case"dvh1":case"dvhe":{const o=Le(t,["dvcC"])[0],a=o[2]>>1&127,c=o[2]<<5&32|o[3]>>3&31;s+="."+Yi(a)+"."+Yi(c);break}case"vp09":{const o=Le(t,["vpcC"])[0],a=o[4],c=o[5],l=o[6]>>4&15;s+="."+Yi(a)+"."+Yi(c)+"."+Yi(l);break}case"av01":{const o=Le(t,["av1C"])[0],a=o[1]>>>5,c=o[1]&31,l=o[2]>>>7?"H":"M",u=(o[2]&64)>>6,h=(o[2]&32)>>5,f=a===2&&u?h?12:10:u?10:8,d=(o[2]&16)>>4,p=(o[2]&8)>>3,m=(o[2]&4)>>2,g=o[2]&3;s+="."+a+"."+Yi(c)+l+"."+Yi(f)+"."+d+"."+p+m+g+"."+Yi(1)+"."+Yi(1)+"."+Yi(1)+"."+0;break}}return{codec:s,encrypted:r}}function Kl(n,e){const t=e+5;for(;n[e++]&128&&e<t;);return e}function la(n){return("0"+n.toString(16).toUpperCase()).slice(-2)}function Yi(n){return(n<10?"0":"")+n}function t5(n,e){if(!n||!e)return n;const t=e.keyId;return t&&e.isCommonEncryption&&Le(n,["moov","trak"]).forEach(s=>{const o=Le(s,["mdia","minf","stbl","stsd"])[0].subarray(8);let a=Le(o,["enca"]);const c=a.length>0;c||(a=Le(o,["encv"])),a.forEach(l=>{const u=c?l.subarray(28):l.subarray(78);Le(u,["sinf"]).forEach(f=>{const d=Wp(f);if(d){const p=d.subarray(8,24);p.some(m=>m!==0)||(j.log(`[eme] Patching keyId in 'enc${c?"a":"v"}>sinf>>tenc' box: ${ji.hexDump(p)} -> ${ji.hexDump(t)}`),d.set(t,8))}})})}),n}function Wp(n){const e=Le(n,["schm"])[0];if(e){const t=xt(e.subarray(4,8));if(t==="cbcs"||t==="cenc")return Le(n,["schi","tenc"])[0]}return null}function i5(n,e){return Le(e,["moof","traf"]).reduce((t,i)=>{const s=Le(i,["tfdt"])[0],r=s[0],o=Le(i,["tfhd"]).reduce((a,c)=>{const l=Te(c,4),u=n[l];if(u){let h=Te(s,4);if(r===1){if(h===pc)return j.warn("[mp4-demuxer]: Ignoring assumed invalid signed 64-bit track fragment decode time"),a;h*=pc+1,h+=Te(s,8)}const f=u.timescale||9e4,d=h/f;if(ve(d)&&(a===null||d<a))return d}return a},null);return o!==null&&ve(o)&&(t===null||o<t)?o:t},null)}function s5(n,e){let t=0,i=0,s=0;const r=Le(n,["moof","traf"]);for(let o=0;o<r.length;o++){const a=r[o],c=Le(a,["tfhd"])[0],l=Te(c,4),u=e[l];if(!u)continue;const h=u.default,f=Te(c,0)|(h==null?void 0:h.flags);let d=h==null?void 0:h.duration;f&8&&(f&2?d=Te(c,12):d=Te(c,8));const p=u.timescale||9e4,m=Le(a,["trun"]);for(let g=0;g<m.length;g++){if(t=n5(m[g]),!t&&d){const y=Te(m[g],4);t=d*y}u.type===$e.VIDEO?i+=t/p:u.type===$e.AUDIO&&(s+=t/p)}}if(i===0&&s===0){let o=1/0,a=0,c=0;const l=Le(n,["sidx"]);for(let u=0;u<l.length;u++){const h=ZI(l[u]);if(h!=null&&h.references){o=Math.min(o,h.earliestPresentationTime/h.timescale);const f=h.references.reduce((d,p)=>d+p.info.duration||0,0);a=Math.max(a,f+h.earliestPresentationTime/h.timescale),c=a-o}}if(c&&ve(c))return c}return i||s}function n5(n){const e=Te(n,0);let t=8;e&1&&(t+=4),e&4&&(t+=4);let i=0;const s=Te(n,4);for(let r=0;r<s;r++){if(e&256){const o=Te(n,t);i+=o,t+=4}e&512&&(t+=4),e&1024&&(t+=4),e&2048&&(t+=4)}return i}function r5(n,e,t){Le(e,["moof","traf"]).forEach(i=>{Le(i,["tfhd"]).forEach(s=>{const r=Te(s,4),o=n[r];if(!o)return;const a=o.timescale||9e4;Le(i,["tfdt"]).forEach(c=>{const l=c[0],u=t*a;if(u){let h=Te(c,4);if(l===0)h-=u,h=Math.max(h,0),Hl(c,4,h);else{h*=Math.pow(2,32),h+=Te(c,8),h-=u,h=Math.max(h,0);const f=Math.floor(h/(pc+1)),d=Math.floor(h%(pc+1));Hl(c,4,f),Hl(c,8,d)}}})})})}function o5(n){const e={valid:null,remainder:null},t=Le(n,["moof"]);if(t.length<2)return e.remainder=n,e;const i=t[t.length-1];return e.valid=an(n,0,i.byteOffset-8),e.remainder=an(n,i.byteOffset-8),e}function _i(n,e){const t=new Uint8Array(n.length+e.length);return t.set(n),t.set(e,n.length),t}function b0(n,e){const t=[],i=e.samples,s=e.timescale,r=e.id;let o=!1;return Le(i,["moof"]).map(c=>{const l=c.byteOffset-8;Le(c,["traf"]).map(h=>{const f=Le(h,["tfdt"]).map(d=>{const p=d[0];let m=Te(d,4);return p===1&&(m*=Math.pow(2,32),m+=Te(d,8)),m/s})[0];return f!==void 0&&(n=f),Le(h,["tfhd"]).map(d=>{const p=Te(d,4),m=Te(d,0)&16777215,g=(m&1)!==0,y=(m&2)!==0,v=(m&8)!==0;let E=0;const C=(m&16)!==0;let x=0;const I=(m&32)!==0;let S=8;p===r&&(g&&(S+=8),y&&(S+=4),v&&(E=Te(d,S),S+=4),C&&(x=Te(d,S),S+=4),I&&(S+=4),e.type==="video"&&(o=a5(e.codec)),Le(h,["trun"]).map(w=>{const B=w[0],T=Te(w,0)&16777215,R=(T&1)!==0;let _=0;const L=(T&4)!==0,O=(T&256)!==0;let U=0;const Q=(T&512)!==0;let G=0;const z=(T&1024)!==0,H=(T&2048)!==0;let N=0;const V=Te(w,4);let $=8;R&&(_=Te(w,$),$+=4),L&&($+=4);let Y=_+l;for(let M=0;M<V;M++){if(O?(U=Te(w,$),$+=4):U=E,Q?(G=Te(w,$),$+=4):G=x,z&&($+=4),H&&(B===0?N=Te(w,$):N=Yp(w,$),$+=4),e.type===$e.VIDEO){let k=0;for(;k<G;){const P=Te(i,Y);if(Y+=4,c5(o,i[Y])){const F=i.subarray(Y,Y+P);jp(F,o?2:1,n+N/s,t)}Y+=P,k+=P+4}}n+=U/s}}))})})}),t}function a5(n){if(!n)return!1;const e=n.indexOf("."),t=e<0?n:n.substring(0,e);return t==="hvc1"||t==="hev1"||t==="dvh1"||t==="dvhe"}function c5(n,e){if(n){const t=e>>1&63;return t===39||t===40}else return(e&31)===6}function jp(n,e,t,i){const s=Jp(n);let r=0;r+=e;let o=0,a=0,c=0;for(;r<s.length;){o=0;do{if(r>=s.length)break;c=s[r++],o+=c}while(c===255);a=0;do{if(r>=s.length)break;c=s[r++],a+=c}while(c===255);const l=s.length-r;let u=r;if(a<l)r+=a;else if(a>l){j.error(`Malformed SEI payload. ${a} is too small, only ${l} bytes left to parse.`);break}if(o===4){if(s[u++]===181){const f=Vp(s,u);if(u+=2,f===49){const d=Te(s,u);if(u+=4,d===1195456820){const p=s[u++];if(p===3){const m=s[u++],g=31&m,y=64&m,v=y?2+g*3:0,E=new Uint8Array(v);if(y){E[0]=m;for(let C=1;C<v;C++)E[C]=s[u++]}i.push({type:p,payloadType:o,pts:t,bytes:E})}}}}}else if(o===5&&a>16){const h=[];for(let p=0;p<16;p++){const m=s[u++].toString(16);h.push(m.length==1?"0"+m:m),(p===3||p===5||p===7||p===9)&&h.push("-")}const f=a-16,d=new Uint8Array(f);for(let p=0;p<f;p++)d[p]=s[u++];i.push({payloadType:o,pts:t,uuid:h.join(""),userData:os(d),userDataBytes:d})}}}function Jp(n){const e=n.byteLength,t=[];let i=1;for(;i<e-2;)n[i]===0&&n[i+1]===0&&n[i+2]===3?(t.push(i+2),i+=2):i++;if(t.length===0)return n;const s=e-t.length,r=new Uint8Array(s);let o=0;for(i=0;i<s;o++,i++)o===t[0]&&(o++,t.shift()),r[i]=n[o];return r}function l5(n){const e=n[0];let t="",i="",s=0,r=0,o=0,a=0,c=0,l=0;if(e===0){for(;xt(n.subarray(l,l+1))!=="\0";)t+=xt(n.subarray(l,l+1)),l+=1;for(t+=xt(n.subarray(l,l+1)),l+=1;xt(n.subarray(l,l+1))!=="\0";)i+=xt(n.subarray(l,l+1)),l+=1;i+=xt(n.subarray(l,l+1)),l+=1,s=Te(n,12),r=Te(n,16),a=Te(n,20),c=Te(n,24),l=28}else if(e===1){l+=4,s=Te(n,l),l+=4;const h=Te(n,l);l+=4;const f=Te(n,l);for(l+=4,o=2**32*h+f,bI(o)||(o=Number.MAX_SAFE_INTEGER,j.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")),a=Te(n,l),l+=4,c=Te(n,l),l+=4;xt(n.subarray(l,l+1))!=="\0";)t+=xt(n.subarray(l,l+1)),l+=1;for(t+=xt(n.subarray(l,l+1)),l+=1;xt(n.subarray(l,l+1))!=="\0";)i+=xt(n.subarray(l,l+1)),l+=1;i+=xt(n.subarray(l,l+1)),l+=1}const u=n.subarray(l,n.byteLength);return{schemeIdUri:t,value:i,timeScale:s,presentationTime:o,presentationTimeDelta:r,eventDuration:a,id:c,payload:u}}function u5(n,...e){const t=e.length;let i=8,s=t;for(;s--;)i+=e[s].byteLength;const r=new Uint8Array(i);for(r[0]=i>>24&255,r[1]=i>>16&255,r[2]=i>>8&255,r[3]=i&255,r.set(n,4),s=0,i=8;s<t;s++)r.set(e[s],i),i+=e[s].byteLength;return r}function h5(n,e,t){if(n.byteLength!==16)throw new RangeError("Invalid system id");let i,s;i=0,s=new Uint8Array;let r;i>0?(r=new Uint8Array(4),e.length>0&&new DataView(r.buffer).setUint32(0,e.length,!1)):r=new Uint8Array;const o=new Uint8Array(4);return t&&t.byteLength>0&&new DataView(o.buffer).setUint32(0,t.byteLength,!1),u5([112,115,115,104],new Uint8Array([i,0,0,0]),n,r,s,o,t||new Uint8Array)}function f5(n){const e=[];if(n instanceof ArrayBuffer){const t=n.byteLength;let i=0;for(;i+32<t;){const s=new DataView(n,i),r=d5(s);e.push(r),i+=r.size}}return e}function d5(n){const e=n.getUint32(0),t=n.byteOffset,i=n.byteLength;if(i<e)return{offset:t,size:i};if(n.getUint32(4)!==1886614376)return{offset:t,size:e};const r=n.getUint32(8)>>>24;if(r!==0&&r!==1)return{offset:t,size:e};const o=n.buffer,a=ji.hexDump(new Uint8Array(o,t+12,16)),c=n.getUint32(28);let l=null,u=null;if(r===0){if(e-32<c||c<22)return{offset:t,size:e};u=new Uint8Array(o,t+32,c)}else if(r===1){if(!c||i<t+32+c*16+16)return{offset:t,size:e};l=[];for(let h=0;h<c;h++)l.push(new Uint8Array(o,t+32+h*16,16))}return{version:r,systemId:a,kids:l,data:u,offset:t,size:e}}let ua={};class gr{static clearKeyUriToKeyIdMap(){ua={}}constructor(e,t,i,s=[1],r=null){this.uri=void 0,this.method=void 0,this.keyFormat=void 0,this.keyFormatVersions=void 0,this.encrypted=void 0,this.isCommonEncryption=void 0,this.iv=null,this.key=null,this.keyId=null,this.pssh=null,this.method=e,this.uri=t,this.keyFormat=i,this.keyFormatVersions=s,this.iv=r,this.encrypted=e?e!=="NONE":!1,this.isCommonEncryption=this.encrypted&&e!=="AES-128"}isSupported(){if(this.method){if(this.method==="AES-128"||this.method==="NONE")return!0;if(this.keyFormat==="identity")return this.method==="SAMPLE-AES";switch(this.keyFormat){case $t.FAIRPLAY:case $t.WIDEVINE:case $t.PLAYREADY:case $t.CLEARKEY:return["ISO-23001-7","SAMPLE-AES","SAMPLE-AES-CENC","SAMPLE-AES-CTR"].indexOf(this.method)!==-1}}return!1}getDecryptData(e){if(!this.encrypted||!this.uri)return null;if(this.method==="AES-128"&&this.uri&&!this.iv){typeof e!="number"&&(this.method==="AES-128"&&!this.iv&&j.warn(`missing IV for initialization segment with method="${this.method}" - compliance issue`),e=0);const i=A5(e);return new gr(this.method,this.uri,"identity",this.keyFormatVersions,i)}const t=NI(this.uri);if(t)switch(this.keyFormat){case $t.WIDEVINE:this.pssh=t,t.length>=22&&(this.keyId=t.subarray(t.length-22,t.length-6));break;case $t.PLAYREADY:{const i=new Uint8Array([154,4,240,121,152,64,66,134,171,146,230,91,224,136,95,149]);this.pssh=h5(i,null,t);const s=new Uint16Array(t.buffer,t.byteOffset,t.byteLength/2),r=String.fromCharCode.apply(null,Array.from(s)),o=r.substring(r.indexOf("<"),r.length),l=new DOMParser().parseFromString(o,"text/xml").getElementsByTagName("KID")[0];if(l){const u=l.childNodes[0]?l.childNodes[0].nodeValue:l.getAttribute("VALUE");if(u){const h=af(u).subarray(0,16);QI(h),this.keyId=h}}break}default:{let i=t.subarray(0,16);if(i.length!==16){const s=new Uint8Array(16);s.set(i,16-i.length),i=s}this.keyId=i;break}}if(!this.keyId||this.keyId.byteLength!==16){let i=ua[this.uri];if(!i){const s=Object.keys(ua).length%Number.MAX_SAFE_INTEGER;i=new Uint8Array(16),new DataView(i.buffer,12,4).setUint32(0,s),ua[this.uri]=i}this.keyId=i}return this}}function A5(n){const e=new Uint8Array(16);for(let t=12;t<16;t++)e[t]=n>>8*(15-t)&255;return e}const qp=/\{\$([a-zA-Z0-9-_]+)\}/g;function R0(n){return qp.test(n)}function ei(n,e,t){if(n.variableList!==null||n.hasVariableRefs)for(let i=t.length;i--;){const s=t[i],r=e[s];r&&(e[s]=ah(n,r))}}function ah(n,e){if(n.variableList!==null||n.hasVariableRefs){const t=n.variableList;return e.replace(qp,i=>{const s=i.substring(2,i.length-1),r=t==null?void 0:t[s];return r===void 0?(n.playlistParsingError||(n.playlistParsingError=new Error(`Missing preceding EXT-X-DEFINE tag for Variable Reference: "${s}"`)),i):r})}return e}function D0(n,e,t){let i=n.variableList;i||(n.variableList=i={});let s,r;if("QUERYPARAM"in e){s=e.QUERYPARAM;try{const o=new self.URL(t).searchParams;if(o.has(s))r=o.get(s);else throw new Error(`"${s}" does not match any query parameter in URI: "${t}"`)}catch(o){n.playlistParsingError||(n.playlistParsingError=new Error(`EXT-X-DEFINE QUERYPARAM: ${o.message}`))}}else s=e.NAME,r=e.VALUE;s in i?n.playlistParsingError||(n.playlistParsingError=new Error(`EXT-X-DEFINE duplicate Variable Name declarations: "${s}"`)):i[s]=r||""}function m5(n,e,t){const i=e.IMPORT;if(t&&i in t){let s=n.variableList;s||(n.variableList=s={}),s[i]=t[i]}else n.playlistParsingError||(n.playlistParsingError=new Error(`EXT-X-DEFINE IMPORT attribute not found in Multivariant Playlist: "${i}"`))}function zs(n=!0){return typeof self>"u"?void 0:(n||!self.MediaSource)&&self.ManagedMediaSource||self.MediaSource||self.WebKitMediaSource}function p5(n){return typeof self<"u"&&n===self.ManagedMediaSource}const gc={audio:{a3ds:1,"ac-3":.95,"ac-4":1,alac:.9,alaw:1,dra1:1,"dts+":1,"dts-":1,dtsc:1,dtse:1,dtsh:1,"ec-3":.9,enca:1,fLaC:.9,flac:.9,FLAC:.9,g719:1,g726:1,m4ae:1,mha1:1,mha2:1,mhm1:1,mhm2:1,mlpa:1,mp4a:1,"raw ":1,Opus:1,opus:1,samr:1,sawb:1,sawp:1,sevc:1,sqcp:1,ssmv:1,twos:1,ulaw:1},video:{avc1:1,avc2:1,avc3:1,avc4:1,avcp:1,av01:.8,drac:1,dva1:1,dvav:1,dvh1:.7,dvhe:.7,encv:1,hev1:.75,hvc1:.75,mjp2:1,mp4v:1,mvc1:1,mvc2:1,mvc3:1,mvc4:1,resv:1,rv60:1,s263:1,svc1:1,svc2:1,"vc-1":1,vp08:1,vp09:.9},text:{stpp:1,wvtt:1}};function g5(n,e){const t=gc[e];return!!t&&!!t[n.slice(0,4)]}function Vl(n,e,t=!0){return!n.split(",").some(i=>!Xp(i,e,t))}function Xp(n,e,t=!0){var i;const s=zs(t);return(i=s==null?void 0:s.isTypeSupported(Lo(n,e)))!=null?i:!1}function Lo(n,e){return`${e}/mp4;codecs="${n}"`}function M0(n){if(n){const e=n.substring(0,4);return gc.video[e]}return 2}function yc(n){return n.split(",").reduce((e,t)=>{const i=gc.video[t];return i?(i*2+e)/(e?3:2):(gc.audio[t]+e)/(e?2:1)},0)}const Yl={};function y5(n,e=!0){if(Yl[n])return Yl[n];const t={flac:["flac","fLaC","FLAC"],opus:["opus","Opus"]}[n];for(let i=0;i<t.length;i++)if(Xp(t[i],"audio",e))return Yl[n]=t[i],t[i];return n}const E5=/flac|opus/i;function Ec(n,e=!0){return n.replace(E5,t=>y5(t.toLowerCase(),e))}function L0(n,e){return n&&n!=="mp4a"?n:e&&e.split(",")[0]}function v5(n){const e=n.split(",");for(let t=0;t<e.length;t++){const i=e[t].split(".");if(i.length>2){let s=i.shift()+".";s+=parseInt(i.shift()).toString(16),s+=("000"+parseInt(i.shift()).toString(16)).slice(-4),e[t]=s}}return e.join(",")}const P0=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-(SESSION-DATA|SESSION-KEY|DEFINE|CONTENT-STEERING|START):([^\r\n]*)[\r\n]+/g,F0=/#EXT-X-MEDIA:(.*)/g,x5=/^#EXT(?:INF|-X-TARGETDURATION):/m,k0=new RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[^\r\n]*)/.source,/#EXT-X-BYTERANGE:*(.+)/.source,/#EXT-X-PROGRAM-DATE-TIME:(.+)/.source,/#.*/.source].join("|"),"g"),C5=new RegExp([/#(EXTM3U)/.source,/#EXT-X-(DATERANGE|DEFINE|KEY|MAP|PART|PART-INF|PLAYLIST-TYPE|PRELOAD-HINT|RENDITION-REPORT|SERVER-CONTROL|SKIP|START):(.+)/.source,/#EXT-X-(BITRATE|DISCONTINUITY-SEQUENCE|MEDIA-SEQUENCE|TARGETDURATION|VERSION): *(\d+)/.source,/#EXT-X-(DISCONTINUITY|ENDLIST|GAP|INDEPENDENT-SEGMENTS)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|"));class es{static findGroup(e,t){for(let i=0;i<e.length;i++){const s=e[i];if(s.id===t)return s}}static resolve(e,t){return nf.buildAbsoluteURL(t,e,{alwaysNormalize:!0})}static isMediaPlaylist(e){return x5.test(e)}static parseMasterPlaylist(e,t){const i=R0(e),s={contentSteering:null,levels:[],playlistParsingError:null,sessionData:null,sessionKeys:null,startTimeOffset:null,variableList:null,hasVariableRefs:i},r=[];P0.lastIndex=0;let o;for(;(o=P0.exec(e))!=null;)if(o[1]){var a;const l=new rt(o[1]);ei(s,l,["CODECS","SUPPLEMENTAL-CODECS","ALLOWED-CPC","PATHWAY-ID","STABLE-VARIANT-ID","AUDIO","VIDEO","SUBTITLES","CLOSED-CAPTIONS","NAME"]);const u=ah(s,o[2]),h={attrs:l,bitrate:l.decimalInteger("BANDWIDTH")||l.decimalInteger("AVERAGE-BANDWIDTH"),name:l.NAME,url:es.resolve(u,t)},f=l.decimalResolution("RESOLUTION");f&&(h.width=f.width,h.height=f.height),I5(l.CODECS,h),(a=h.unknownCodecs)!=null&&a.length||r.push(h),s.levels.push(h)}else if(o[3]){const l=o[3],u=o[4];switch(l){case"SESSION-DATA":{const h=new rt(u);ei(s,h,["DATA-ID","LANGUAGE","VALUE","URI"]);const f=h["DATA-ID"];f&&(s.sessionData===null&&(s.sessionData={}),s.sessionData[f]=h);break}case"SESSION-KEY":{const h=O0(u,t,s);h.encrypted&&h.isSupported()?(s.sessionKeys===null&&(s.sessionKeys=[]),s.sessionKeys.push(h)):j.warn(`[Keys] Ignoring invalid EXT-X-SESSION-KEY tag: "${u}"`);break}case"DEFINE":{{const h=new rt(u);ei(s,h,["NAME","VALUE","QUERYPARAM"]),D0(s,h,t)}break}case"CONTENT-STEERING":{const h=new rt(u);ei(s,h,["SERVER-URI","PATHWAY-ID"]),s.contentSteering={uri:es.resolve(h["SERVER-URI"],t),pathwayId:h["PATHWAY-ID"]||"."};break}case"START":{s.startTimeOffset=U0(u);break}}}const c=r.length>0&&r.length<s.levels.length;return s.levels=c?r:s.levels,s.levels.length===0&&(s.playlistParsingError=new Error("no levels found in manifest")),s}static parseMasterPlaylistMedia(e,t,i){let s;const r={},o=i.levels,a={AUDIO:o.map(l=>({id:l.attrs.AUDIO,audioCodec:l.audioCodec})),SUBTITLES:o.map(l=>({id:l.attrs.SUBTITLES,textCodec:l.textCodec})),"CLOSED-CAPTIONS":[]};let c=0;for(F0.lastIndex=0;(s=F0.exec(e))!==null;){const l=new rt(s[1]),u=l.TYPE;if(u){const h=a[u],f=r[u]||[];r[u]=f,ei(i,l,["URI","GROUP-ID","LANGUAGE","ASSOC-LANGUAGE","STABLE-RENDITION-ID","NAME","INSTREAM-ID","CHARACTERISTICS","CHANNELS"]);const d=l.LANGUAGE,p=l["ASSOC-LANGUAGE"],m=l.CHANNELS,g=l.CHARACTERISTICS,y=l["INSTREAM-ID"],v={attrs:l,bitrate:0,id:c++,groupId:l["GROUP-ID"]||"",name:l.NAME||d||"",type:u,default:l.bool("DEFAULT"),autoselect:l.bool("AUTOSELECT"),forced:l.bool("FORCED"),lang:d,url:l.URI?es.resolve(l.URI,t):""};if(p&&(v.assocLang=p),m&&(v.channels=m),g&&(v.characteristics=g),y&&(v.instreamId=y),h!=null&&h.length){const E=es.findGroup(h,v.groupId)||h[0];Q0(v,E,"audioCodec"),Q0(v,E,"textCodec")}f.push(v)}}return r}static parseLevelPlaylist(e,t,i,s,r,o){const a=new Qp(t),c=a.fragments;let l=null,u=0,h=0,f=0,d=0,p=null,m=new qa(s,t),g,y,v,E=-1,C=!1,x=null;for(k0.lastIndex=0,a.m3u8=e,a.hasVariableRefs=R0(e);(g=k0.exec(e))!==null;){C&&(C=!1,m=new qa(s,t),m.start=f,m.sn=u,m.cc=d,m.level=i,l&&(m.initSegment=l,m.rawProgramDateTime=l.rawProgramDateTime,l.rawProgramDateTime=null,x&&(m.setByteRange(x),x=null)));const B=g[1];if(B){m.duration=parseFloat(B);const T=(" "+g[2]).slice(1);m.title=T||null,m.tagList.push(T?["INF",B,T]:["INF",B])}else if(g[3]){if(ve(m.duration)){m.start=f,v&&z0(m,v,a),m.sn=u,m.level=i,m.cc=d,c.push(m);const T=(" "+g[3]).slice(1);m.relurl=ah(a,T),N0(m,p),p=m,f+=m.duration,u++,h=0,C=!0}}else if(g[4]){const T=(" "+g[4]).slice(1);p?m.setByteRange(T,p):m.setByteRange(T)}else if(g[5])m.rawProgramDateTime=(" "+g[5]).slice(1),m.tagList.push(["PROGRAM-DATE-TIME",m.rawProgramDateTime]),E===-1&&(E=c.length);else{if(g=g[0].match(C5),!g){j.warn("No matches on slow regex match for level playlist!");continue}for(y=1;y<g.length&&!(typeof g[y]<"u");y++);const T=(" "+g[y]).slice(1),R=(" "+g[y+1]).slice(1),_=g[y+2]?(" "+g[y+2]).slice(1):"";switch(T){case"PLAYLIST-TYPE":a.type=R.toUpperCase();break;case"MEDIA-SEQUENCE":u=a.startSN=parseInt(R);break;case"SKIP":{const L=new rt(R);ei(a,L,["RECENTLY-REMOVED-DATERANGES"]);const O=L.decimalInteger("SKIPPED-SEGMENTS");if(ve(O)){a.skippedSegments=O;for(let Q=O;Q--;)c.unshift(null);u+=O}const U=L.enumeratedString("RECENTLY-REMOVED-DATERANGES");U&&(a.recentlyRemovedDateranges=U.split("	"));break}case"TARGETDURATION":a.targetduration=Math.max(parseInt(R),1);break;case"VERSION":a.version=parseInt(R);break;case"INDEPENDENT-SEGMENTS":case"EXTM3U":break;case"ENDLIST":a.live=!1;break;case"#":(R||_)&&m.tagList.push(_?[R,_]:[R]);break;case"DISCONTINUITY":d++,m.tagList.push(["DIS"]);break;case"GAP":m.gap=!0,m.tagList.push([T]);break;case"BITRATE":m.tagList.push([T,R]);break;case"DATERANGE":{const L=new rt(R);ei(a,L,["ID","CLASS","START-DATE","END-DATE","SCTE35-CMD","SCTE35-OUT","SCTE35-IN"]),ei(a,L,L.clientAttrs);const O=new rf(L,a.dateRanges[L.ID]);O.isValid||a.skippedSegments?a.dateRanges[O.id]=O:j.warn(`Ignoring invalid DATERANGE tag: "${R}"`),m.tagList.push(["EXT-X-DATERANGE",R]);break}case"DEFINE":{{const L=new rt(R);ei(a,L,["NAME","VALUE","IMPORT","QUERYPARAM"]),"IMPORT"in L?m5(a,L,o):D0(a,L,t)}break}case"DISCONTINUITY-SEQUENCE":d=parseInt(R);break;case"KEY":{const L=O0(R,t,a);if(L.isSupported()){if(L.method==="NONE"){v=void 0;break}v||(v={}),v[L.keyFormat]&&(v=pt({},v)),v[L.keyFormat]=L}else j.warn(`[Keys] Ignoring invalid EXT-X-KEY tag: "${R}"`);break}case"START":a.startTimeOffset=U0(R);break;case"MAP":{const L=new rt(R);if(ei(a,L,["BYTERANGE","URI"]),m.duration){const O=new qa(s,t);G0(O,L,i,v),l=O,m.initSegment=l,l.rawProgramDateTime&&!m.rawProgramDateTime&&(m.rawProgramDateTime=l.rawProgramDateTime)}else{const O=m.byteRangeEndOffset;if(O){const U=m.byteRangeStartOffset;x=`${O-U}@${U}`}else x=null;G0(m,L,i,v),l=m,C=!0}break}case"SERVER-CONTROL":{const L=new rt(R);a.canBlockReload=L.bool("CAN-BLOCK-RELOAD"),a.canSkipUntil=L.optionalFloat("CAN-SKIP-UNTIL",0),a.canSkipDateRanges=a.canSkipUntil>0&&L.bool("CAN-SKIP-DATERANGES"),a.partHoldBack=L.optionalFloat("PART-HOLD-BACK",0),a.holdBack=L.optionalFloat("HOLD-BACK",0);break}case"PART-INF":{const L=new rt(R);a.partTarget=L.decimalFloatingPoint("PART-TARGET");break}case"PART":{let L=a.partList;L||(L=a.partList=[]);const O=h>0?L[L.length-1]:void 0,U=h++,Q=new rt(R);ei(a,Q,["BYTERANGE","URI"]);const G=new Up(Q,m,t,U,O);L.push(G),m.duration+=G.duration;break}case"PRELOAD-HINT":{const L=new rt(R);ei(a,L,["URI"]),a.preloadHint=L;break}case"RENDITION-REPORT":{const L=new rt(R);ei(a,L,["URI"]),a.renditionReports=a.renditionReports||[],a.renditionReports.push(L);break}default:j.warn(`line parsed but not handled: ${g}`);break}}}p&&!p.relurl?(c.pop(),f-=p.duration,a.partList&&(a.fragmentHint=p)):a.partList&&(N0(m,p),m.cc=d,a.fragmentHint=m,v&&z0(m,v,a));const I=c.length,S=c[0],w=c[I-1];if(f+=a.skippedSegments*a.targetduration,f>0&&I&&w){a.averagetargetduration=f/I;const B=w.sn;a.endSN=B!=="initSegment"?B:0,a.live||(w.endList=!0),S&&(a.startCC=S.cc)}else a.endSN=0,a.startCC=0;return a.fragmentHint&&(f+=a.fragmentHint.duration),a.totalduration=f,a.endCC=d,E>0&&S5(c,E),a}}function O0(n,e,t){var i,s;const r=new rt(n);ei(t,r,["KEYFORMAT","KEYFORMATVERSIONS","URI","IV","URI"]);const o=(i=r.METHOD)!=null?i:"",a=r.URI,c=r.hexadecimalInteger("IV"),l=r.KEYFORMATVERSIONS,u=(s=r.KEYFORMAT)!=null?s:"identity";a&&r.IV&&!c&&j.error(`Invalid IV: ${r.IV}`);const h=a?es.resolve(a,e):"",f=(l||"1").split("/").map(Number).filter(Number.isFinite);return new gr(o,h,u,f,c)}function U0(n){const t=new rt(n).decimalFloatingPoint("TIME-OFFSET");return ve(t)?t:null}function I5(n,e){let t=(n||"").split(/[ ,]+/).filter(i=>i);["video","audio","text"].forEach(i=>{const s=t.filter(r=>g5(r,i));s.length&&(e[`${i}Codec`]=s.join(","),t=t.filter(r=>s.indexOf(r)===-1))}),e.unknownCodecs=t}function Q0(n,e,t){const i=e[t];i&&(n[t]=i)}function S5(n,e){let t=n[e];for(let i=e;i--;){const s=n[i];if(!s)return;s.programDateTime=t.programDateTime-s.duration*1e3,t=s}}function N0(n,e){n.rawProgramDateTime?n.programDateTime=Date.parse(n.rawProgramDateTime):e!=null&&e.programDateTime&&(n.programDateTime=e.endProgramDateTime),ve(n.programDateTime)||(n.programDateTime=null,n.rawProgramDateTime=null)}function G0(n,e,t,i){n.relurl=e.URI,e.BYTERANGE&&n.setByteRange(e.BYTERANGE),n.level=t,n.sn="initSegment",i&&(n.levelkeys=i),n.initSegment=null}function z0(n,e,t){n.levelkeys=e;const{encryptedFragments:i}=t;(!i.length||i[i.length-1].levelkeys!==e)&&Object.keys(e).some(s=>e[s].isCommonEncryption)&&i.push(n)}var Ge={MANIFEST:"manifest",LEVEL:"level",AUDIO_TRACK:"audioTrack",SUBTITLE_TRACK:"subtitleTrack"},we={MAIN:"main",AUDIO:"audio",SUBTITLE:"subtitle"};function H0(n){const{type:e}=n;switch(e){case Ge.AUDIO_TRACK:return we.AUDIO;case Ge.SUBTITLE_TRACK:return we.SUBTITLE;default:return we.MAIN}}function $l(n,e){let t=n.url;return(t===void 0||t.indexOf("data:")===0)&&(t=e.url),t}class w5{constructor(e){this.hls=void 0,this.loaders=Object.create(null),this.variableList=null,this.hls=e,this.registerListeners()}startLoad(e){}stopLoad(){this.destroyInternalLoaders()}registerListeners(){const{hls:e}=this;e.on(D.MANIFEST_LOADING,this.onManifestLoading,this),e.on(D.LEVEL_LOADING,this.onLevelLoading,this),e.on(D.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.on(D.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)}unregisterListeners(){const{hls:e}=this;e.off(D.MANIFEST_LOADING,this.onManifestLoading,this),e.off(D.LEVEL_LOADING,this.onLevelLoading,this),e.off(D.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),e.off(D.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)}createInternalLoader(e){const t=this.hls.config,i=t.pLoader,s=t.loader,r=i||s,o=new r(t);return this.loaders[e.type]=o,o}getInternalLoader(e){return this.loaders[e.type]}resetInternalLoader(e){this.loaders[e]&&delete this.loaders[e]}destroyInternalLoaders(){for(const e in this.loaders){const t=this.loaders[e];t&&t.destroy(),this.resetInternalLoader(e)}}destroy(){this.variableList=null,this.unregisterListeners(),this.destroyInternalLoaders()}onManifestLoading(e,t){const{url:i}=t;this.variableList=null,this.load({id:null,level:0,responseType:"text",type:Ge.MANIFEST,url:i,deliveryDirectives:null})}onLevelLoading(e,t){const{id:i,level:s,pathwayId:r,url:o,deliveryDirectives:a}=t;this.load({id:i,level:s,pathwayId:r,responseType:"text",type:Ge.LEVEL,url:o,deliveryDirectives:a})}onAudioTrackLoading(e,t){const{id:i,groupId:s,url:r,deliveryDirectives:o}=t;this.load({id:i,groupId:s,level:null,responseType:"text",type:Ge.AUDIO_TRACK,url:r,deliveryDirectives:o})}onSubtitleTrackLoading(e,t){const{id:i,groupId:s,url:r,deliveryDirectives:o}=t;this.load({id:i,groupId:s,level:null,responseType:"text",type:Ge.SUBTITLE_TRACK,url:r,deliveryDirectives:o})}load(e){var t;const i=this.hls.config;let s=this.getInternalLoader(e);if(s){const l=s.context;if(l&&l.url===e.url&&l.level===e.level){j.trace("[playlist-loader]: playlist request ongoing");return}j.log(`[playlist-loader]: aborting previous loader for type: ${e.type}`),s.abort()}let r;if(e.type===Ge.MANIFEST?r=i.manifestLoadPolicy.default:r=pt({},i.playlistLoadPolicy.default,{timeoutRetry:null,errorRetry:null}),s=this.createInternalLoader(e),ve((t=e.deliveryDirectives)==null?void 0:t.part)){let l;if(e.type===Ge.LEVEL&&e.level!==null?l=this.hls.levels[e.level].details:e.type===Ge.AUDIO_TRACK&&e.id!==null?l=this.hls.audioTracks[e.id].details:e.type===Ge.SUBTITLE_TRACK&&e.id!==null&&(l=this.hls.subtitleTracks[e.id].details),l){const u=l.partTarget,h=l.targetduration;if(u&&h){const f=Math.max(u*3,h*.8)*1e3;r=pt({},r,{maxTimeToFirstByteMs:Math.min(f,r.maxTimeToFirstByteMs),maxLoadTimeMs:Math.min(f,r.maxTimeToFirstByteMs)})}}}const o=r.errorRetry||r.timeoutRetry||{},a={loadPolicy:r,timeout:r.maxLoadTimeMs,maxRetry:o.maxNumRetry||0,retryDelay:o.retryDelayMs||0,maxRetryDelay:o.maxRetryDelayMs||0},c={onSuccess:(l,u,h,f)=>{const d=this.getInternalLoader(h);this.resetInternalLoader(h.type);const p=l.data;if(p.indexOf("#EXTM3U")!==0){this.handleManifestParsingError(l,h,new Error("no EXTM3U delimiter"),f||null,u);return}u.parsing.start=performance.now(),es.isMediaPlaylist(p)?this.handleTrackOrLevelPlaylist(l,u,h,f||null,d):this.handleMasterPlaylist(l,u,h,f)},onError:(l,u,h,f)=>{this.handleNetworkError(u,h,!1,l,f)},onTimeout:(l,u,h)=>{this.handleNetworkError(u,h,!0,void 0,l)}};s.load(e,a,c)}handleMasterPlaylist(e,t,i,s){const r=this.hls,o=e.data,a=$l(e,i),c=es.parseMasterPlaylist(o,a);if(c.playlistParsingError){this.handleManifestParsingError(e,i,c.playlistParsingError,s,t);return}const{contentSteering:l,levels:u,sessionData:h,sessionKeys:f,startTimeOffset:d,variableList:p}=c;this.variableList=p;const{AUDIO:m=[],SUBTITLES:g,"CLOSED-CAPTIONS":y}=es.parseMasterPlaylistMedia(o,a,c);m.length&&!m.some(E=>!E.url)&&u[0].audioCodec&&!u[0].attrs.AUDIO&&(j.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),m.unshift({type:"main",name:"main",groupId:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new rt({}),bitrate:0,url:""})),r.trigger(D.MANIFEST_LOADED,{levels:u,audioTracks:m,subtitles:g,captions:y,contentSteering:l,url:a,stats:t,networkDetails:s,sessionData:h,sessionKeys:f,startTimeOffset:d,variableList:p})}handleTrackOrLevelPlaylist(e,t,i,s,r){const o=this.hls,{id:a,level:c,type:l}=i,u=$l(e,i),h=0,f=ve(c)?c:ve(a)?a:0,d=H0(i),p=es.parseLevelPlaylist(e.data,u,f,d,h,this.variableList);if(l===Ge.MANIFEST){const m={attrs:new rt({}),bitrate:0,details:p,name:"",url:u};o.trigger(D.MANIFEST_LOADED,{levels:[m],audioTracks:[],url:u,stats:t,networkDetails:s,sessionData:null,sessionKeys:null,contentSteering:null,startTimeOffset:null,variableList:null})}t.parsing.end=performance.now(),i.levelDetails=p,this.handlePlaylistLoaded(p,e,t,i,s,r)}handleManifestParsingError(e,t,i,s,r){this.hls.trigger(D.ERROR,{type:_e.NETWORK_ERROR,details:te.MANIFEST_PARSING_ERROR,fatal:t.type===Ge.MANIFEST,url:e.url,err:i,error:i,reason:i.message,response:e,context:t,networkDetails:s,stats:r})}handleNetworkError(e,t,i=!1,s,r){let o=`A network ${i?"timeout":"error"+(s?" (status "+s.code+")":"")} occurred while loading ${e.type}`;e.type===Ge.LEVEL?o+=`: ${e.level} id: ${e.id}`:(e.type===Ge.AUDIO_TRACK||e.type===Ge.SUBTITLE_TRACK)&&(o+=` id: ${e.id} group-id: "${e.groupId}"`);const a=new Error(o);j.warn(`[playlist-loader]: ${o}`);let c=te.UNKNOWN,l=!1;const u=this.getInternalLoader(e);switch(e.type){case Ge.MANIFEST:c=i?te.MANIFEST_LOAD_TIMEOUT:te.MANIFEST_LOAD_ERROR,l=!0;break;case Ge.LEVEL:c=i?te.LEVEL_LOAD_TIMEOUT:te.LEVEL_LOAD_ERROR,l=!1;break;case Ge.AUDIO_TRACK:c=i?te.AUDIO_TRACK_LOAD_TIMEOUT:te.AUDIO_TRACK_LOAD_ERROR,l=!1;break;case Ge.SUBTITLE_TRACK:c=i?te.SUBTITLE_TRACK_LOAD_TIMEOUT:te.SUBTITLE_LOAD_ERROR,l=!1;break}u&&this.resetInternalLoader(e.type);const h={type:_e.NETWORK_ERROR,details:c,fatal:l,url:e.url,loader:u,context:e,error:a,networkDetails:t,stats:r};if(s){const f=(t==null?void 0:t.url)||e.url;h.response=Mt({url:f,data:void 0},s)}this.hls.trigger(D.ERROR,h)}handlePlaylistLoaded(e,t,i,s,r,o){const a=this.hls,{type:c,level:l,id:u,groupId:h,deliveryDirectives:f}=s,d=$l(t,s),p=H0(s),m=typeof s.level=="number"&&p===we.MAIN?l:void 0;if(!e.fragments.length){const y=new Error("No Segments found in Playlist");a.trigger(D.ERROR,{type:_e.NETWORK_ERROR,details:te.LEVEL_EMPTY_ERROR,fatal:!1,url:d,error:y,reason:y.message,response:t,context:s,level:m,parent:p,networkDetails:r,stats:i});return}e.targetduration||(e.playlistParsingError=new Error("Missing Target Duration"));const g=e.playlistParsingError;if(g){a.trigger(D.ERROR,{type:_e.NETWORK_ERROR,details:te.LEVEL_PARSING_ERROR,fatal:!1,url:d,error:g,reason:g.message,response:t,context:s,level:m,parent:p,networkDetails:r,stats:i});return}switch(e.live&&o&&(o.getCacheAge&&(e.ageHeader=o.getCacheAge()||0),(!o.getCacheAge||isNaN(e.ageHeader))&&(e.ageHeader=0)),c){case Ge.MANIFEST:case Ge.LEVEL:a.trigger(D.LEVEL_LOADED,{details:e,level:m||0,id:u||0,stats:i,networkDetails:r,deliveryDirectives:f});break;case Ge.AUDIO_TRACK:a.trigger(D.AUDIO_TRACK_LOADED,{details:e,id:u||0,groupId:h||"",stats:i,networkDetails:r,deliveryDirectives:f});break;case Ge.SUBTITLE_TRACK:a.trigger(D.SUBTITLE_TRACK_LOADED,{details:e,id:u||0,groupId:h||"",stats:i,networkDetails:r,deliveryDirectives:f});break}}}function Zp(n,e){let t;try{t=new Event("addtrack")}catch{t=document.createEvent("Event"),t.initEvent("addtrack",!1,!1)}t.track=n,e.dispatchEvent(t)}function eg(n,e){const t=n.mode;if(t==="disabled"&&(n.mode="hidden"),n.cues&&!n.cues.getCueById(e.id))try{if(n.addCue(e),!n.cues.getCueById(e.id))throw new Error(`addCue is failed for: ${e}`)}catch(i){j.debug(`[texttrack-utils]: ${i}`);try{const s=new self.TextTrackCue(e.startTime,e.endTime,e.text);s.id=e.id,n.addCue(s)}catch(s){j.debug(`[texttrack-utils]: Legacy TextTrackCue fallback failed: ${s}`)}}t==="disabled"&&(n.mode=t)}function nr(n){const e=n.mode;if(e==="disabled"&&(n.mode="hidden"),n.cues)for(let t=n.cues.length;t--;)n.removeCue(n.cues[t]);e==="disabled"&&(n.mode=e)}function ch(n,e,t,i){const s=n.mode;if(s==="disabled"&&(n.mode="hidden"),n.cues&&n.cues.length>0){const r=B5(n.cues,e,t);for(let o=0;o<r.length;o++)(!i||i(r[o]))&&n.removeCue(r[o])}s==="disabled"&&(n.mode=s)}function T5(n,e){if(e<n[0].startTime)return 0;const t=n.length-1;if(e>n[t].endTime)return-1;let i=0,s=t;for(;i<=s;){const r=Math.floor((s+i)/2);if(e<n[r].startTime)s=r-1;else if(e>n[r].startTime&&i<t)i=r+1;else return r}return n[i].startTime-e<e-n[s].startTime?i:s}function B5(n,e,t){const i=[],s=T5(n,e);if(s>-1)for(let r=s,o=n.length;r<o;r++){const a=n[r];if(a.startTime>=e&&a.endTime<=t)i.push(a);else if(a.startTime>t)return i}return i}function Xa(n){const e=[];for(let t=0;t<n.length;t++){const i=n[t];(i.kind==="subtitles"||i.kind==="captions")&&i.label&&e.push(n[t])}return e}var Si={audioId3:"org.id3",dateRange:"com.apple.quicktime.HLS",emsg:"https://aomedia.org/emsg/ID3"};const _5=.25;function lh(){if(!(typeof self>"u"))return self.VTTCue||self.TextTrackCue}function K0(n,e,t,i,s){let r=new n(e,t,"");try{r.value=i,s&&(r.type=s)}catch{r=new n(e,t,JSON.stringify(s?Mt({type:s},i):i))}return r}const ha=(()=>{const n=lh();try{n&&new n(0,Number.POSITIVE_INFINITY,"")}catch{return Number.MAX_VALUE}return Number.POSITIVE_INFINITY})();function Wl(n,e){return n.getTime()/1e3-e}function b5(n){return Uint8Array.from(n.replace(/^0x/,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")).buffer}class R5{constructor(e){this.hls=void 0,this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=e,this._registerListeners()}destroy(){this._unregisterListeners(),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=null}_registerListeners(){const{hls:e}=this;e.on(D.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(D.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(D.MANIFEST_LOADING,this.onManifestLoading,this),e.on(D.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.on(D.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(D.LEVEL_UPDATED,this.onLevelUpdated,this)}_unregisterListeners(){const{hls:e}=this;e.off(D.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(D.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(D.MANIFEST_LOADING,this.onManifestLoading,this),e.off(D.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),e.off(D.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(D.LEVEL_UPDATED,this.onLevelUpdated,this)}onMediaAttached(e,t){this.media=t.media}onMediaDetaching(){this.id3Track&&(nr(this.id3Track),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={})}onManifestLoading(){this.dateRangeCuesAppended={}}createTrack(e){const t=this.getID3Track(e.textTracks);return t.mode="hidden",t}getID3Track(e){if(this.media){for(let t=0;t<e.length;t++){const i=e[t];if(i.kind==="metadata"&&i.label==="id3")return Zp(i,this.media),i}return this.media.addTextTrack("metadata","id3")}}onFragParsingMetadata(e,t){if(!this.media)return;const{hls:{config:{enableEmsgMetadataCues:i,enableID3MetadataCues:s}}}=this;if(!i&&!s)return;const{samples:r}=t;this.id3Track||(this.id3Track=this.createTrack(this.media));const o=lh();if(o)for(let a=0;a<r.length;a++){const c=r[a].type;if(c===Si.emsg&&!i||!s)continue;const l=Hp(r[a].data);if(l){const u=r[a].pts;let h=u+r[a].duration;h>ha&&(h=ha),h-u<=0&&(h=u+_5);for(let d=0;d<l.length;d++){const p=l[d];if(!zp(p)){this.updateId3CueEnds(u,c);const m=K0(o,u,h,p,c);m&&this.id3Track.addCue(m)}}}}}updateId3CueEnds(e,t){var i;const s=(i=this.id3Track)==null?void 0:i.cues;if(s)for(let r=s.length;r--;){const o=s[r];o.type===t&&o.startTime<e&&o.endTime===ha&&(o.endTime=e)}}onBufferFlushing(e,{startOffset:t,endOffset:i,type:s}){const{id3Track:r,hls:o}=this;if(!o)return;const{config:{enableEmsgMetadataCues:a,enableID3MetadataCues:c}}=o;if(r&&(a||c)){let l;s==="audio"?l=u=>u.type===Si.audioId3&&c:s==="video"?l=u=>u.type===Si.emsg&&a:l=u=>u.type===Si.audioId3&&c||u.type===Si.emsg&&a,ch(r,t,i,l)}}onLevelUpdated(e,{details:t}){if(!this.media||!t.hasProgramDateTime||!this.hls.config.enableDateRangeMetadataCues)return;const{dateRangeCuesAppended:i,id3Track:s}=this,{dateRanges:r}=t,o=Object.keys(r);if(s){const u=Object.keys(i).filter(h=>!o.includes(h));for(let h=u.length;h--;){const f=u[h];Object.keys(i[f].cues).forEach(d=>{s.removeCue(i[f].cues[d])}),delete i[f]}}const a=t.fragments[t.fragments.length-1];if(o.length===0||!ve(a==null?void 0:a.programDateTime))return;this.id3Track||(this.id3Track=this.createTrack(this.media));const c=a.programDateTime/1e3-a.start,l=lh();for(let u=0;u<o.length;u++){const h=o[u],f=r[h],d=Wl(f.startDate,c),p=i[h],m=(p==null?void 0:p.cues)||{};let g=(p==null?void 0:p.durationKnown)||!1,y=ha;const v=f.endDate;if(v)y=Wl(v,c),g=!0;else if(f.endOnNext&&!g){const C=o.reduce((x,I)=>{if(I!==f.id){const S=r[I];if(S.class===f.class&&S.startDate>f.startDate&&(!x||f.startDate<x.startDate))return S}return x},null);C&&(y=Wl(C.startDate,c),g=!0)}const E=Object.keys(f.attr);for(let C=0;C<E.length;C++){const x=E[C];if(!FI(x))continue;const I=m[x];if(I)g&&!p.durationKnown&&(I.endTime=y);else if(l){let S=f.attr[x];kI(x)&&(S=b5(S));const w=K0(l,d,y,{key:x,data:S},Si.dateRange);w&&(w.id=h,this.id3Track.addCue(w),m[x]=w)}}i[h]={cues:m,dateRange:f,durationKnown:g}}}}class D5{constructor(e){this.hls=void 0,this.config=void 0,this.media=null,this.levelDetails=null,this.currentTime=0,this.stallCount=0,this._latency=null,this.timeupdateHandler=()=>this.timeupdate(),this.hls=e,this.config=e.config,this.registerListeners()}get latency(){return this._latency||0}get maxLatency(){const{config:e,levelDetails:t}=this;return e.liveMaxLatencyDuration!==void 0?e.liveMaxLatencyDuration:t?e.liveMaxLatencyDurationCount*t.targetduration:0}get targetLatency(){const{levelDetails:e}=this;if(e===null)return null;const{holdBack:t,partHoldBack:i,targetduration:s}=e,{liveSyncDuration:r,liveSyncDurationCount:o,lowLatencyMode:a}=this.config,c=this.hls.userConfig;let l=a&&i||t;(c.liveSyncDuration||c.liveSyncDurationCount||l===0)&&(l=r!==void 0?r:o*s);const u=s;return l+Math.min(this.stallCount*1,u)}get liveSyncPosition(){const e=this.estimateLiveEdge(),t=this.targetLatency,i=this.levelDetails;if(e===null||t===null||i===null)return null;const s=i.edge,r=e-t-this.edgeStalled,o=s-i.totalduration,a=s-(this.config.lowLatencyMode&&i.partTarget||i.targetduration);return Math.min(Math.max(o,r),a)}get drift(){const{levelDetails:e}=this;return e===null?1:e.drift}get edgeStalled(){const{levelDetails:e}=this;if(e===null)return 0;const t=(this.config.lowLatencyMode&&e.partTarget||e.targetduration)*3;return Math.max(e.age-t,0)}get forwardBufferLength(){const{media:e,levelDetails:t}=this;if(!e||!t)return 0;const i=e.buffered.length;return(i?e.buffered.end(i-1):t.edge)-this.currentTime}destroy(){this.unregisterListeners(),this.onMediaDetaching(),this.levelDetails=null,this.hls=this.timeupdateHandler=null}registerListeners(){this.hls.on(D.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(D.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.on(D.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(D.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.on(D.ERROR,this.onError,this)}unregisterListeners(){this.hls.off(D.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(D.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.off(D.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(D.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.off(D.ERROR,this.onError,this)}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener("timeupdate",this.timeupdateHandler)}onMediaDetaching(){this.media&&(this.media.removeEventListener("timeupdate",this.timeupdateHandler),this.media=null)}onManifestLoading(){this.levelDetails=null,this._latency=null,this.stallCount=0}onLevelUpdated(e,{details:t}){this.levelDetails=t,t.advanced&&this.timeupdate(),!t.live&&this.media&&this.media.removeEventListener("timeupdate",this.timeupdateHandler)}onError(e,t){var i;t.details===te.BUFFER_STALLED_ERROR&&(this.stallCount++,(i=this.levelDetails)!=null&&i.live&&j.warn("[playback-rate-controller]: Stall detected, adjusting target latency"))}timeupdate(){const{media:e,levelDetails:t}=this;if(!e||!t)return;this.currentTime=e.currentTime;const i=this.computeLatency();if(i===null)return;this._latency=i;const{lowLatencyMode:s,maxLiveSyncPlaybackRate:r}=this.config;if(!s||r===1||!t.live)return;const o=this.targetLatency;if(o===null)return;const a=i-o,c=Math.min(this.maxLatency,o+t.targetduration);if(a<c&&a>.05&&this.forwardBufferLength>1){const u=Math.min(2,Math.max(1,r)),h=Math.round(2/(1+Math.exp(-.75*a-this.edgeStalled))*20)/20;e.playbackRate=Math.min(u,Math.max(1,h))}else e.playbackRate!==1&&e.playbackRate!==0&&(e.playbackRate=1)}estimateLiveEdge(){const{levelDetails:e}=this;return e===null?null:e.edge+e.age}computeLatency(){const e=this.estimateLiveEdge();return e===null?null:e-this.currentTime}}const uh=["NONE","TYPE-0","TYPE-1",null];function M5(n){return uh.indexOf(n)>-1}const vc=["SDR","PQ","HLG"];function L5(n){return!!n&&vc.indexOf(n)>-1}var To={No:"",Yes:"YES",v2:"v2"};function V0(n){const{canSkipUntil:e,canSkipDateRanges:t,age:i}=n,s=i<e/2;return e&&s?t?To.v2:To.Yes:To.No}class hh{constructor(e,t,i){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=e,this.part=t,this.skip=i}addDirectives(e){const t=new self.URL(e);return this.msn!==void 0&&t.searchParams.set("_HLS_msn",this.msn.toString()),this.part!==void 0&&t.searchParams.set("_HLS_part",this.part.toString()),this.skip&&t.searchParams.set("_HLS_skip",this.skip),t.href}}class un{constructor(e){this._attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.url=void 0,this.frameRate=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.videoCodec=void 0,this.width=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.supportedPromise=void 0,this.supportedResult=void 0,this._avgBitrate=0,this._audioGroups=void 0,this._subtitleGroups=void 0,this._urlId=0,this.url=[e.url],this._attrs=[e.attrs],this.bitrate=e.bitrate,e.details&&(this.details=e.details),this.id=e.id||0,this.name=e.name,this.width=e.width||0,this.height=e.height||0,this.frameRate=e.attrs.optionalFloat("FRAME-RATE",0),this._avgBitrate=e.attrs.decimalInteger("AVERAGE-BANDWIDTH"),this.audioCodec=e.audioCodec,this.videoCodec=e.videoCodec,this.codecSet=[e.videoCodec,e.audioCodec].filter(t=>!!t).map(t=>t.substring(0,4)).join(","),this.addGroupId("audio",e.attrs.AUDIO),this.addGroupId("text",e.attrs.SUBTITLES)}get maxBitrate(){return Math.max(this.realBitrate,this.bitrate)}get averageBitrate(){return this._avgBitrate||this.realBitrate||this.bitrate}get attrs(){return this._attrs[0]}get codecs(){return this.attrs.CODECS||""}get pathwayId(){return this.attrs["PATHWAY-ID"]||"."}get videoRange(){return this.attrs["VIDEO-RANGE"]||"SDR"}get score(){return this.attrs.optionalFloat("SCORE",0)}get uri(){return this.url[0]||""}hasAudioGroup(e){return Y0(this._audioGroups,e)}hasSubtitleGroup(e){return Y0(this._subtitleGroups,e)}get audioGroups(){return this._audioGroups}get subtitleGroups(){return this._subtitleGroups}addGroupId(e,t){if(t){if(e==="audio"){let i=this._audioGroups;i||(i=this._audioGroups=[]),i.indexOf(t)===-1&&i.push(t)}else if(e==="text"){let i=this._subtitleGroups;i||(i=this._subtitleGroups=[]),i.indexOf(t)===-1&&i.push(t)}}}get urlId(){return 0}set urlId(e){}get audioGroupIds(){return this.audioGroups?[this.audioGroupId]:void 0}get textGroupIds(){return this.subtitleGroups?[this.textGroupId]:void 0}get audioGroupId(){var e;return(e=this.audioGroups)==null?void 0:e[0]}get textGroupId(){var e;return(e=this.subtitleGroups)==null?void 0:e[0]}addFallback(){}}function Y0(n,e){return!e||!n?!1:n.indexOf(e)!==-1}function jl(n,e){const t=e.startPTS;if(ve(t)){let i=0,s;e.sn>n.sn?(i=t-n.start,s=n):(i=n.start-t,s=e),s.duration!==i&&(s.duration=i)}else e.sn>n.sn?n.cc===e.cc&&n.minEndPTS?e.start=n.start+(n.minEndPTS-n.start):e.start=n.start+n.duration:e.start=Math.max(n.start-e.duration,0)}function tg(n,e,t,i,s,r){i-t<=0&&(j.warn("Fragment should have a positive duration",e),i=t+e.duration,r=s+e.duration);let a=t,c=i;const l=e.startPTS,u=e.endPTS;if(ve(l)){const g=Math.abs(l-t);ve(e.deltaPTS)?e.deltaPTS=Math.max(g,e.deltaPTS):e.deltaPTS=g,a=Math.max(t,l),t=Math.min(t,l),s=Math.min(s,e.startDTS),c=Math.min(i,u),i=Math.max(i,u),r=Math.max(r,e.endDTS)}const h=t-e.start;e.start!==0&&(e.start=t),e.duration=i-e.start,e.startPTS=t,e.maxStartPTS=a,e.startDTS=s,e.endPTS=i,e.minEndPTS=c,e.endDTS=r;const f=e.sn;if(!n||f<n.startSN||f>n.endSN)return 0;let d;const p=f-n.startSN,m=n.fragments;for(m[p]=e,d=p;d>0;d--)jl(m[d],m[d-1]);for(d=p;d<m.length-1;d++)jl(m[d],m[d+1]);return n.fragmentHint&&jl(m[m.length-1],n.fragmentHint),n.PTSKnown=n.alignedSliding=!0,h}function P5(n,e){let t=null;const i=n.fragments;for(let c=i.length-1;c>=0;c--){const l=i[c].initSegment;if(l){t=l;break}}n.fragmentHint&&delete n.fragmentHint.endPTS;let s=0,r;if(O5(n,e,(c,l)=>{c.relurl&&(s=c.cc-l.cc),ve(c.startPTS)&&ve(c.endPTS)&&(l.start=l.startPTS=c.startPTS,l.startDTS=c.startDTS,l.maxStartPTS=c.maxStartPTS,l.endPTS=c.endPTS,l.endDTS=c.endDTS,l.minEndPTS=c.minEndPTS,l.duration=c.endPTS-c.startPTS,l.duration&&(r=l),e.PTSKnown=e.alignedSliding=!0),l.elementaryStreams=c.elementaryStreams,l.loader=c.loader,l.stats=c.stats,c.initSegment&&(l.initSegment=c.initSegment,t=c.initSegment)}),t&&(e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments).forEach(l=>{var u;l&&(!l.initSegment||l.initSegment.relurl===((u=t)==null?void 0:u.relurl))&&(l.initSegment=t)}),e.skippedSegments)if(e.deltaUpdateFailed=e.fragments.some(c=>!c),e.deltaUpdateFailed){j.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(let c=e.skippedSegments;c--;)e.fragments.shift();e.startSN=e.fragments[0].sn,e.startCC=e.fragments[0].cc}else e.canSkipDateRanges&&(e.dateRanges=F5(n.dateRanges,e.dateRanges,e.recentlyRemovedDateranges));const o=e.fragments;if(s){j.warn("discontinuity sliding from playlist, take drift into account");for(let c=0;c<o.length;c++)o[c].cc+=s}e.skippedSegments&&(e.startCC=e.fragments[0].cc),k5(n.partList,e.partList,(c,l)=>{l.elementaryStreams=c.elementaryStreams,l.stats=c.stats}),r?tg(e,r,r.startPTS,r.endPTS,r.startDTS,r.endDTS):ig(n,e),o.length&&(e.totalduration=e.edge-o[0].start),e.driftStartTime=n.driftStartTime,e.driftStart=n.driftStart;const a=e.advancedDateTime;if(e.advanced&&a){const c=e.edge;e.driftStart||(e.driftStartTime=a,e.driftStart=c),e.driftEndTime=a,e.driftEnd=c}else e.driftEndTime=n.driftEndTime,e.driftEnd=n.driftEnd,e.advancedDateTime=n.advancedDateTime}function F5(n,e,t){const i=pt({},n);return t&&t.forEach(s=>{delete i[s]}),Object.keys(e).forEach(s=>{const r=new rf(e[s].attr,i[s]);r.isValid?i[s]=r:j.warn(`Ignoring invalid Playlist Delta Update DATERANGE tag: "${JSON.stringify(e[s].attr)}"`)}),i}function k5(n,e,t){if(n&&e){let i=0;for(let s=0,r=n.length;s<=r;s++){const o=n[s],a=e[s+i];o&&a&&o.index===a.index&&o.fragment.sn===a.fragment.sn?t(o,a):i--}}}function O5(n,e,t){const i=e.skippedSegments,s=Math.max(n.startSN,e.startSN)-e.startSN,r=(n.fragmentHint?1:0)+(i?e.endSN:Math.min(n.endSN,e.endSN))-e.startSN,o=e.startSN-n.startSN,a=e.fragmentHint?e.fragments.concat(e.fragmentHint):e.fragments,c=n.fragmentHint?n.fragments.concat(n.fragmentHint):n.fragments;for(let l=s;l<=r;l++){const u=c[o+l];let h=a[l];i&&!h&&l<i&&(h=e.fragments[l]=u),u&&h&&t(u,h)}}function ig(n,e){const t=e.startSN+e.skippedSegments-n.startSN,i=n.fragments;t<0||t>=i.length||fh(e,i[t].start)}function fh(n,e){if(e){const t=n.fragments;for(let i=n.skippedSegments;i<t.length;i++)t[i].start+=e;n.fragmentHint&&(n.fragmentHint.start+=e)}}function U5(n,e=1/0){let t=1e3*n.targetduration;if(n.updated){const i=n.fragments;if(i.length&&t*4>e){const r=i[i.length-1].duration*1e3;r<t&&(t=r)}}else t/=2;return Math.round(t)}function Q5(n,e,t){if(!(n!=null&&n.details))return null;const i=n.details;let s=i.fragments[e-i.startSN];return s||(s=i.fragmentHint,s&&s.sn===e)?s:e<i.startSN&&t&&t.sn===e?t:null}function $0(n,e,t){var i;return n!=null&&n.details?sg((i=n.details)==null?void 0:i.partList,e,t):null}function sg(n,e,t){if(n)for(let i=n.length;i--;){const s=n[i];if(s.index===t&&s.fragment.sn===e)return s}return null}function ng(n){n.forEach((e,t)=>{const{details:i}=e;i!=null&&i.fragments&&i.fragments.forEach(s=>{s.level=t})})}function xc(n){switch(n.details){case te.FRAG_LOAD_TIMEOUT:case te.KEY_LOAD_TIMEOUT:case te.LEVEL_LOAD_TIMEOUT:case te.MANIFEST_LOAD_TIMEOUT:return!0}return!1}function W0(n,e){const t=xc(e);return n.default[`${t?"timeout":"error"}Retry`]}function uf(n,e){const t=n.backoff==="linear"?1:Math.pow(2,e);return Math.min(t*n.retryDelayMs,n.maxRetryDelayMs)}function j0(n){return Mt(Mt({},n),{errorRetry:null,timeoutRetry:null})}function Cc(n,e,t,i){if(!n)return!1;const s=i==null?void 0:i.code,r=e<n.maxNumRetry&&(N5(s)||!!t);return n.shouldRetry?n.shouldRetry(n,e,t,i,r):r}function N5(n){return n===0&&navigator.onLine===!1||!!n&&(n<400||n>499)}const rg={search:function(n,e){let t=0,i=n.length-1,s=null,r=null;for(;t<=i;){s=(t+i)/2|0,r=n[s];const o=e(r);if(o>0)t=s+1;else if(o<0)i=s-1;else return r}return null}};function G5(n,e,t){if(e===null||!Array.isArray(n)||!n.length||!ve(e))return null;const i=n[0].programDateTime;if(e<(i||0))return null;const s=n[n.length-1].endProgramDateTime;if(e>=(s||0))return null;t=t||0;for(let r=0;r<n.length;++r){const o=n[r];if(H5(e,t,o))return o}return null}function Ic(n,e,t=0,i=0,s=.005){let r=null;if(n){r=e[n.sn-e[0].sn+1]||null;const a=n.endDTS-t;a>0&&a<15e-7&&(t+=15e-7)}else t===0&&e[0].start===0&&(r=e[0]);if(r&&((!n||n.level===r.level)&&dh(t,i,r)===0||z5(r,n,Math.min(s,i))))return r;const o=rg.search(e,dh.bind(null,t,i));return o&&(o!==n||!r)?o:r}function z5(n,e,t){if(e&&e.start===0&&e.level<n.level&&(e.endPTS||0)>0){const i=e.tagList.reduce((s,r)=>(r[0]==="INF"&&(s+=parseFloat(r[1])),s),t);return n.start<=i}return!1}function dh(n=0,e=0,t){if(t.start<=n&&t.start+t.duration>n)return 0;const i=Math.min(e,t.duration+(t.deltaPTS?t.deltaPTS:0));return t.start+t.duration-i<=n?1:t.start-i>n&&t.start?-1:0}function H5(n,e,t){const i=Math.min(e,t.duration+(t.deltaPTS?t.deltaPTS:0))*1e3;return(t.endProgramDateTime||0)-i>n}function K5(n,e){return rg.search(n,t=>t.cc<e?1:t.cc>e?-1:0)}var Ct={DoNothing:0,SendEndCallback:1,SendAlternateToPenaltyBox:2,RemoveAlternatePermanently:3,InsertDiscontinuity:4,RetryRequest:5},Ei={None:0,MoveAllAlternatesMatchingHost:1,MoveAllAlternatesMatchingHDCP:2,SwitchToSDR:4};class og{constructor(e){this.hls=void 0,this.playlistError=0,this.penalizedRenditions={},this.log=void 0,this.warn=void 0,this.error=void 0,this.hls=e,this.log=j.log.bind(j,"[info]:"),this.warn=j.warn.bind(j,"[warning]:"),this.error=j.error.bind(j,"[error]:"),this.registerListeners()}registerListeners(){const e=this.hls;e.on(D.ERROR,this.onError,this),e.on(D.MANIFEST_LOADING,this.onManifestLoading,this),e.on(D.LEVEL_UPDATED,this.onLevelUpdated,this)}unregisterListeners(){const e=this.hls;e&&(e.off(D.ERROR,this.onError,this),e.off(D.ERROR,this.onErrorOut,this),e.off(D.MANIFEST_LOADING,this.onManifestLoading,this),e.off(D.LEVEL_UPDATED,this.onLevelUpdated,this))}destroy(){this.unregisterListeners(),this.hls=null,this.penalizedRenditions={}}startLoad(e){}stopLoad(){this.playlistError=0}getVariantLevelIndex(e){return(e==null?void 0:e.type)===we.MAIN?e.level:this.hls.loadLevel}onManifestLoading(){this.playlistError=0,this.penalizedRenditions={}}onLevelUpdated(){this.playlistError=0}onError(e,t){var i,s;if(t.fatal)return;const r=this.hls,o=t.context;switch(t.details){case te.FRAG_LOAD_ERROR:case te.FRAG_LOAD_TIMEOUT:case te.KEY_LOAD_ERROR:case te.KEY_LOAD_TIMEOUT:t.errorAction=this.getFragRetryOrSwitchAction(t);return;case te.FRAG_PARSING_ERROR:if((i=t.frag)!=null&&i.gap){t.errorAction={action:Ct.DoNothing,flags:Ei.None};return}case te.FRAG_GAP:case te.FRAG_DECRYPT_ERROR:{t.errorAction=this.getFragRetryOrSwitchAction(t),t.errorAction.action=Ct.SendAlternateToPenaltyBox;return}case te.LEVEL_EMPTY_ERROR:case te.LEVEL_PARSING_ERROR:{var a,c;const l=t.parent===we.MAIN?t.level:r.loadLevel;t.details===te.LEVEL_EMPTY_ERROR&&((a=t.context)!=null&&(c=a.levelDetails)!=null&&c.live)?t.errorAction=this.getPlaylistRetryOrSwitchAction(t,l):(t.levelRetry=!1,t.errorAction=this.getLevelSwitchAction(t,l))}return;case te.LEVEL_LOAD_ERROR:case te.LEVEL_LOAD_TIMEOUT:typeof(o==null?void 0:o.level)=="number"&&(t.errorAction=this.getPlaylistRetryOrSwitchAction(t,o.level));return;case te.AUDIO_TRACK_LOAD_ERROR:case te.AUDIO_TRACK_LOAD_TIMEOUT:case te.SUBTITLE_LOAD_ERROR:case te.SUBTITLE_TRACK_LOAD_TIMEOUT:if(o){const l=r.levels[r.loadLevel];if(l&&(o.type===Ge.AUDIO_TRACK&&l.hasAudioGroup(o.groupId)||o.type===Ge.SUBTITLE_TRACK&&l.hasSubtitleGroup(o.groupId))){t.errorAction=this.getPlaylistRetryOrSwitchAction(t,r.loadLevel),t.errorAction.action=Ct.SendAlternateToPenaltyBox,t.errorAction.flags=Ei.MoveAllAlternatesMatchingHost;return}}return;case te.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:{const l=r.levels[r.loadLevel],u=l==null?void 0:l.attrs["HDCP-LEVEL"];u?t.errorAction={action:Ct.SendAlternateToPenaltyBox,flags:Ei.MoveAllAlternatesMatchingHDCP,hdcpLevel:u}:this.keySystemError(t)}return;case te.BUFFER_ADD_CODEC_ERROR:case te.REMUX_ALLOC_ERROR:case te.BUFFER_APPEND_ERROR:t.errorAction=this.getLevelSwitchAction(t,(s=t.level)!=null?s:r.loadLevel);return;case te.INTERNAL_EXCEPTION:case te.BUFFER_APPENDING_ERROR:case te.BUFFER_FULL_ERROR:case te.LEVEL_SWITCH_ERROR:case te.BUFFER_STALLED_ERROR:case te.BUFFER_SEEK_OVER_HOLE:case te.BUFFER_NUDGE_ON_STALL:t.errorAction={action:Ct.DoNothing,flags:Ei.None};return}t.type===_e.KEY_SYSTEM_ERROR&&this.keySystemError(t)}keySystemError(e){const t=this.getVariantLevelIndex(e.frag);e.levelRetry=!1,e.errorAction=this.getLevelSwitchAction(e,t)}getPlaylistRetryOrSwitchAction(e,t){const i=this.hls,s=W0(i.config.playlistLoadPolicy,e),r=this.playlistError++;if(Cc(s,r,xc(e),e.response))return{action:Ct.RetryRequest,flags:Ei.None,retryConfig:s,retryCount:r};const a=this.getLevelSwitchAction(e,t);return s&&(a.retryConfig=s,a.retryCount=r),a}getFragRetryOrSwitchAction(e){const t=this.hls,i=this.getVariantLevelIndex(e.frag),s=t.levels[i],{fragLoadPolicy:r,keyLoadPolicy:o}=t.config,a=W0(e.details.startsWith("key")?o:r,e),c=t.levels.reduce((u,h)=>u+h.fragmentError,0);if(s&&(e.details!==te.FRAG_GAP&&s.fragmentError++,Cc(a,c,xc(e),e.response)))return{action:Ct.RetryRequest,flags:Ei.None,retryConfig:a,retryCount:c};const l=this.getLevelSwitchAction(e,i);return a&&(l.retryConfig=a,l.retryCount=c),l}getLevelSwitchAction(e,t){const i=this.hls;t==null&&(t=i.loadLevel);const s=this.hls.levels[t];if(s){var r,o;const l=e.details;s.loadError++,l===te.BUFFER_APPEND_ERROR&&s.fragmentError++;let u=-1;const{levels:h,loadLevel:f,minAutoLevel:d,maxAutoLevel:p}=i;i.autoLevelEnabled||(i.loadLevel=-1);const m=(r=e.frag)==null?void 0:r.type,y=(m===we.AUDIO&&l===te.FRAG_PARSING_ERROR||e.sourceBufferName==="audio"&&(l===te.BUFFER_ADD_CODEC_ERROR||l===te.BUFFER_APPEND_ERROR))&&h.some(({audioCodec:I})=>s.audioCodec!==I),E=e.sourceBufferName==="video"&&(l===te.BUFFER_ADD_CODEC_ERROR||l===te.BUFFER_APPEND_ERROR)&&h.some(({codecSet:I,audioCodec:S})=>s.codecSet!==I&&s.audioCodec===S),{type:C,groupId:x}=(o=e.context)!=null?o:{};for(let I=h.length;I--;){const S=(I+f)%h.length;if(S!==f&&S>=d&&S<=p&&h[S].loadError===0){var a,c;const w=h[S];if(l===te.FRAG_GAP&&m===we.MAIN&&e.frag){const B=h[S].details;if(B){const T=Ic(e.frag,B.fragments,e.frag.start);if(T!=null&&T.gap)continue}}else{if(C===Ge.AUDIO_TRACK&&w.hasAudioGroup(x)||C===Ge.SUBTITLE_TRACK&&w.hasSubtitleGroup(x))continue;if(m===we.AUDIO&&(a=s.audioGroups)!=null&&a.some(B=>w.hasAudioGroup(B))||m===we.SUBTITLE&&(c=s.subtitleGroups)!=null&&c.some(B=>w.hasSubtitleGroup(B))||y&&s.audioCodec===w.audioCodec||!y&&s.audioCodec!==w.audioCodec||E&&s.codecSet===w.codecSet)continue}u=S;break}}if(u>-1&&i.loadLevel!==u)return e.levelRetry=!0,this.playlistError=0,{action:Ct.SendAlternateToPenaltyBox,flags:Ei.None,nextAutoLevel:u}}return{action:Ct.SendAlternateToPenaltyBox,flags:Ei.MoveAllAlternatesMatchingHost}}onErrorOut(e,t){var i;switch((i=t.errorAction)==null?void 0:i.action){case Ct.DoNothing:break;case Ct.SendAlternateToPenaltyBox:this.sendAlternateToPenaltyBox(t),!t.errorAction.resolved&&t.details!==te.FRAG_GAP?t.fatal=!0:/MediaSource readyState: ended/.test(t.error.message)&&(this.warn(`MediaSource ended after "${t.sourceBufferName}" sourceBuffer append error. Attempting to recover from media error.`),this.hls.recoverMediaError());break;case Ct.RetryRequest:break}if(t.fatal){this.hls.stopLoad();return}}sendAlternateToPenaltyBox(e){const t=this.hls,i=e.errorAction;if(!i)return;const{flags:s,hdcpLevel:r,nextAutoLevel:o}=i;switch(s){case Ei.None:this.switchLevel(e,o);break;case Ei.MoveAllAlternatesMatchingHDCP:r&&(t.maxHdcpLevel=uh[uh.indexOf(r)-1],i.resolved=!0),this.warn(`Restricting playback to HDCP-LEVEL of "${t.maxHdcpLevel}" or lower`);break}i.resolved||this.switchLevel(e,o)}switchLevel(e,t){t!==void 0&&e.errorAction&&(this.warn(`switching to level ${t} after ${e.details}`),this.hls.nextAutoLevel=t,e.errorAction.resolved=!0,this.hls.nextLoadLevel=this.hls.nextAutoLevel)}}class Gc{constructor(e,t){this.hls=void 0,this.timer=-1,this.requestScheduled=-1,this.canLoad=!1,this.log=void 0,this.warn=void 0,this.log=j.log.bind(j,`${t}:`),this.warn=j.warn.bind(j,`${t}:`),this.hls=e}destroy(){this.clearTimer(),this.hls=this.log=this.warn=null}clearTimer(){this.timer!==-1&&(self.clearTimeout(this.timer),this.timer=-1)}startLoad(){this.canLoad=!0,this.requestScheduled=-1,this.loadPlaylist()}stopLoad(){this.canLoad=!1,this.clearTimer()}switchParams(e,t,i){const s=t==null?void 0:t.renditionReports;if(s){let r=-1;for(let o=0;o<s.length;o++){const a=s[o];let c;try{c=new self.URL(a.URI,t.url).href}catch(l){j.warn(`Could not construct new URL for Rendition Report: ${l}`),c=a.URI||""}if(c===e){r=o;break}else c===e.substring(0,c.length)&&(r=o)}if(r!==-1){const o=s[r],a=parseInt(o["LAST-MSN"])||(t==null?void 0:t.lastPartSn);let c=parseInt(o["LAST-PART"])||(t==null?void 0:t.lastPartIndex);if(this.hls.config.lowLatencyMode){const u=Math.min(t.age-t.partTarget,t.targetduration);c>=0&&u>t.partTarget&&(c+=1)}const l=i&&V0(i);return new hh(a,c>=0?c:void 0,l)}}}loadPlaylist(e){this.requestScheduled===-1&&(this.requestScheduled=self.performance.now())}shouldLoadPlaylist(e){return this.canLoad&&!!e&&!!e.url&&(!e.details||e.details.live)}shouldReloadPlaylist(e){return this.timer===-1&&this.requestScheduled===-1&&this.shouldLoadPlaylist(e)}playlistLoaded(e,t,i){const{details:s,stats:r}=t,o=self.performance.now(),a=r.loading.first?Math.max(0,o-r.loading.first):0;if(s.advancedDateTime=Date.now()-a,s.live||i!=null&&i.live){if(s.reloaded(i),i&&this.log(`live playlist ${e} ${s.advanced?"REFRESHED "+s.lastPartSn+"-"+s.lastPartIndex:s.updated?"UPDATED":"MISSED"}`),i&&s.fragments.length>0&&P5(i,s),!this.canLoad||!s.live)return;let c,l,u;if(s.canBlockReload&&s.endSN&&s.advanced){const g=this.hls.config.lowLatencyMode,y=s.lastPartSn,v=s.endSN,E=s.lastPartIndex,C=E!==-1,x=y===v,I=g?0:E;C?(l=x?v+1:y,u=x?I:E+1):l=v+1;const S=s.age,w=S+s.ageHeader;let B=Math.min(w-s.partTarget,s.targetduration*1.5);if(B>0){if(i&&B>i.tuneInGoal)this.warn(`CDN Tune-in goal increased from: ${i.tuneInGoal} to: ${B} with playlist age: ${s.age}`),B=0;else{const T=Math.floor(B/s.targetduration);if(l+=T,u!==void 0){const R=Math.round(B%s.targetduration/s.partTarget);u+=R}this.log(`CDN Tune-in age: ${s.ageHeader}s last advanced ${S.toFixed(2)}s goal: ${B} skip sn ${T} to part ${u}`)}s.tuneInGoal=B}if(c=this.getDeliveryDirectives(s,t.deliveryDirectives,l,u),g||!x){this.loadPlaylist(c);return}}else(s.canBlockReload||s.canSkipUntil)&&(c=this.getDeliveryDirectives(s,t.deliveryDirectives,l,u));const h=this.hls.mainForwardBufferInfo,f=h?h.end-h.len:0,d=(s.edge-f)*1e3,p=U5(s,d);s.updated&&o>this.requestScheduled+p&&(this.requestScheduled=r.loading.start),l!==void 0&&s.canBlockReload?this.requestScheduled=r.loading.first+p-(s.partTarget*1e3||1e3):this.requestScheduled===-1||this.requestScheduled+p<o?this.requestScheduled=o:this.requestScheduled-o<=0&&(this.requestScheduled+=p);let m=this.requestScheduled-o;m=Math.max(0,m),this.log(`reload live playlist ${e} in ${Math.round(m)} ms`),this.timer=self.setTimeout(()=>this.loadPlaylist(c),m)}else this.clearTimer()}getDeliveryDirectives(e,t,i,s){let r=V0(e);return t!=null&&t.skip&&e.deltaUpdateFailed&&(i=t.msn,s=t.part,r=To.No),new hh(i,s,r)}checkRetry(e){const t=e.details,i=xc(e),s=e.errorAction,{action:r,retryCount:o=0,retryConfig:a}=s||{},c=!!s&&!!a&&(r===Ct.RetryRequest||!s.resolved&&r===Ct.SendAlternateToPenaltyBox);if(c){var l;if(this.requestScheduled=-1,o>=a.maxNumRetry)return!1;if(i&&(l=e.context)!=null&&l.deliveryDirectives)this.warn(`Retrying playlist loading ${o+1}/${a.maxNumRetry} after "${t}" without delivery-directives`),this.loadPlaylist();else{const u=uf(a,o);this.timer=self.setTimeout(()=>this.loadPlaylist(),u),this.warn(`Retrying playlist loading ${o+1}/${a.maxNumRetry} after "${t}" in ${u}ms`)}e.levelRetry=!0,s.resolved=!0}return c}}class Mn{constructor(e,t=0,i=0){this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=e,this.alpha_=e?Math.exp(Math.log(.5)/e):0,this.estimate_=t,this.totalWeight_=i}sample(e,t){const i=Math.pow(this.alpha_,e);this.estimate_=t*(1-i)+i*this.estimate_,this.totalWeight_+=e}getTotalWeight(){return this.totalWeight_}getEstimate(){if(this.alpha_){const e=1-Math.pow(this.alpha_,this.totalWeight_);if(e)return this.estimate_/e}return this.estimate_}}class V5{constructor(e,t,i,s=100){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultTTFB_=void 0,this.ttfb_=void 0,this.defaultEstimate_=i,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new Mn(e),this.fast_=new Mn(t),this.defaultTTFB_=s,this.ttfb_=new Mn(e)}update(e,t){const{slow_:i,fast_:s,ttfb_:r}=this;i.halfLife!==e&&(this.slow_=new Mn(e,i.getEstimate(),i.getTotalWeight())),s.halfLife!==t&&(this.fast_=new Mn(t,s.getEstimate(),s.getTotalWeight())),r.halfLife!==e&&(this.ttfb_=new Mn(e,r.getEstimate(),r.getTotalWeight()))}sample(e,t){e=Math.max(e,this.minDelayMs_);const i=8*t,s=e/1e3,r=i/s;this.fast_.sample(s,r),this.slow_.sample(s,r)}sampleTTFB(e){const t=e/1e3,i=Math.sqrt(2)*Math.exp(-Math.pow(t,2)/2);this.ttfb_.sample(i,Math.max(e,5))}canEstimate(){return this.fast_.getTotalWeight()>=this.minWeight_}getEstimate(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_}getEstimateTTFB(){return this.ttfb_.getTotalWeight()>=this.minWeight_?this.ttfb_.getEstimate():this.defaultTTFB_}destroy(){}}const ag={supported:!0,configurations:[],decodingInfoResults:[{supported:!0,powerEfficient:!0,smooth:!0}]},J0={};function Y5(n,e,t,i,s,r){const o=n.audioCodec?n.audioGroups:null,a=r==null?void 0:r.audioCodec,c=r==null?void 0:r.channels,l=c?parseInt(c):a?1/0:2;let u=null;if(o!=null&&o.length)try{o.length===1&&o[0]?u=e.groups[o[0]].channels:u=o.reduce((h,f)=>{if(f){const d=e.groups[f];if(!d)throw new Error(`Audio track group ${f} not found`);Object.keys(d.channels).forEach(p=>{h[p]=(h[p]||0)+d.channels[p]})}return h},{2:0})}catch{return!0}return n.videoCodec!==void 0&&(n.width>1920&&n.height>1088||n.height>1920&&n.width>1088||n.frameRate>Math.max(i,30)||n.videoRange!=="SDR"&&n.videoRange!==t||n.bitrate>Math.max(s,8e6))||!!u&&ve(l)&&Object.keys(u).some(h=>parseInt(h)>l)}function $5(n,e,t){const i=n.videoCodec,s=n.audioCodec;if(!i||!s||!t)return Promise.resolve(ag);const r={width:n.width,height:n.height,bitrate:Math.ceil(Math.max(n.bitrate*.9,n.averageBitrate)),framerate:n.frameRate||30},o=n.videoRange;o!=="SDR"&&(r.transferFunction=o.toLowerCase());const a=i.split(",").map(c=>({type:"media-source",video:Mt(Mt({},r),{},{contentType:Lo(c,"video")})}));return s&&n.audioGroups&&n.audioGroups.forEach(c=>{var l;c&&((l=e.groups[c])==null||l.tracks.forEach(u=>{if(u.groupId===c){const h=u.channels||"",f=parseFloat(h);ve(f)&&f>2&&a.push.apply(a,s.split(",").map(d=>({type:"media-source",audio:{contentType:Lo(d,"audio"),channels:""+f}})))}}))}),Promise.all(a.map(c=>{const l=W5(c);return J0[l]||(J0[l]=t.decodingInfo(c))})).then(c=>({supported:!c.some(l=>!l.supported),configurations:a,decodingInfoResults:c})).catch(c=>({supported:!1,configurations:a,decodingInfoResults:[],error:c}))}function W5(n){const{audio:e,video:t}=n,i=t||e;if(i){const s=i.contentType.split('"')[1];if(t)return`r${t.height}x${t.width}f${Math.ceil(t.framerate)}${t.transferFunction||"sd"}_${s}_${Math.ceil(t.bitrate/1e5)}`;if(e)return`c${e.channels}${e.spatialRendering?"s":"n"}_${s}`}return""}function j5(){if(typeof matchMedia=="function"){const n=matchMedia("(dynamic-range: high)"),e=matchMedia("bad query");if(n.media!==e.media)return n.matches===!0}return!1}function J5(n,e){let t=!1,i=[];return n&&(t=n!=="SDR",i=[n]),e&&(i=e.allowedVideoRanges||vc.slice(0),t=e.preferHDR!==void 0?e.preferHDR:j5(),t?i=i.filter(s=>s!=="SDR"):i=["SDR"]),{preferHDR:t,allowedVideoRanges:i}}function q5(n,e,t,i,s){const r=Object.keys(n),o=i==null?void 0:i.channels,a=i==null?void 0:i.audioCodec,c=o&&parseInt(o)===2;let l=!0,u=!1,h=1/0,f=1/0,d=1/0,p=0,m=[];const{preferHDR:g,allowedVideoRanges:y}=J5(e,s);for(let x=r.length;x--;){const I=n[r[x]];l=I.channels[2]>0,h=Math.min(h,I.minHeight),f=Math.min(f,I.minFramerate),d=Math.min(d,I.minBitrate);const S=y.filter(w=>I.videoRanges[w]>0);S.length>0&&(u=!0,m=S)}h=ve(h)?h:0,f=ve(f)?f:0;const v=Math.max(1080,h),E=Math.max(30,f);return d=ve(d)?d:t,t=Math.max(d,t),u||(e=void 0,m=[]),{codecSet:r.reduce((x,I)=>{const S=n[I];if(I===x)return x;if(S.minBitrate>t)return As(I,`min bitrate of ${S.minBitrate} > current estimate of ${t}`),x;if(!S.hasDefaultAudio)return As(I,"no renditions with default or auto-select sound found"),x;if(a&&I.indexOf(a.substring(0,4))%5!==0)return As(I,`audio codec preference "${a}" not found`),x;if(o&&!c){if(!S.channels[o])return As(I,`no renditions with ${o} channel sound found (channels options: ${Object.keys(S.channels)})`),x}else if((!a||c)&&l&&S.channels[2]===0)return As(I,"no renditions with stereo sound found"),x;return S.minHeight>v?(As(I,`min resolution of ${S.minHeight} > maximum of ${v}`),x):S.minFramerate>E?(As(I,`min framerate of ${S.minFramerate} > maximum of ${E}`),x):m.some(w=>S.videoRanges[w]>0)?S.maxScore<p?(As(I,`max score of ${S.maxScore} < selected max of ${p}`),x):x&&(yc(I)>=yc(x)||S.fragmentError>n[x].fragmentError)?x:(p=S.maxScore,I):(As(I,`no variants with VIDEO-RANGE of ${JSON.stringify(m)} found`),x)},void 0),videoRanges:m,preferHDR:g,minFramerate:f,minBitrate:d}}function As(n,e){j.log(`[abr] start candidates with "${n}" ignored because ${e}`)}function X5(n){return n.reduce((e,t)=>{let i=e.groups[t.groupId];i||(i=e.groups[t.groupId]={tracks:[],channels:{2:0},hasDefault:!1,hasAutoSelect:!1}),i.tracks.push(t);const s=t.channels||"2";return i.channels[s]=(i.channels[s]||0)+1,i.hasDefault=i.hasDefault||t.default,i.hasAutoSelect=i.hasAutoSelect||t.autoselect,i.hasDefault&&(e.hasDefaultAudio=!0),i.hasAutoSelect&&(e.hasAutoSelectAudio=!0),e},{hasDefaultAudio:!1,hasAutoSelectAudio:!1,groups:{}})}function Z5(n,e,t,i){return n.slice(t,i+1).reduce((s,r)=>{if(!r.codecSet)return s;const o=r.audioGroups;let a=s[r.codecSet];a||(s[r.codecSet]=a={minBitrate:1/0,minHeight:1/0,minFramerate:1/0,maxScore:0,videoRanges:{SDR:0},channels:{2:0},hasDefaultAudio:!o,fragmentError:0}),a.minBitrate=Math.min(a.minBitrate,r.bitrate);const c=Math.min(r.height,r.width);return a.minHeight=Math.min(a.minHeight,c),a.minFramerate=Math.min(a.minFramerate,r.frameRate),a.maxScore=Math.max(a.maxScore,r.score),a.fragmentError+=r.fragmentError,a.videoRanges[r.videoRange]=(a.videoRanges[r.videoRange]||0)+1,o&&o.forEach(l=>{if(!l)return;const u=e.groups[l];u&&(a.hasDefaultAudio=a.hasDefaultAudio||e.hasDefaultAudio?u.hasDefault:u.hasAutoSelect||!e.hasDefaultAudio&&!e.hasAutoSelectAudio,Object.keys(u.channels).forEach(h=>{a.channels[h]=(a.channels[h]||0)+u.channels[h]}))}),s},{})}function ts(n,e,t){if("attrs"in n){const i=e.indexOf(n);if(i!==-1)return i}for(let i=0;i<e.length;i++){const s=e[i];if(fr(n,s,t))return i}return-1}function fr(n,e,t){const{groupId:i,name:s,lang:r,assocLang:o,characteristics:a,default:c}=n,l=n.forced;return(i===void 0||e.groupId===i)&&(s===void 0||e.name===s)&&(r===void 0||e.lang===r)&&(r===void 0||e.assocLang===o)&&(c===void 0||e.default===c)&&(l===void 0||e.forced===l)&&(a===void 0||e6(a,e.characteristics))&&(t===void 0||t(n,e))}function e6(n,e=""){const t=n.split(","),i=e.split(",");return t.length===i.length&&!t.some(s=>i.indexOf(s)===-1)}function Ln(n,e){const{audioCodec:t,channels:i}=n;return(t===void 0||(e.audioCodec||"").substring(0,4)===t.substring(0,4))&&(i===void 0||i===(e.channels||"2"))}function t6(n,e,t,i,s){const r=e[i],a=e.reduce((f,d,p)=>{const m=d.uri;return(f[m]||(f[m]=[])).push(p),f},{})[r.uri];a.length>1&&(i=Math.max.apply(Math,a));const c=r.videoRange,l=r.frameRate,u=r.codecSet.substring(0,4),h=q0(e,i,f=>{if(f.videoRange!==c||f.frameRate!==l||f.codecSet.substring(0,4)!==u)return!1;const d=f.audioGroups,p=t.filter(m=>!d||d.indexOf(m.groupId)!==-1);return ts(n,p,s)>-1});return h>-1?h:q0(e,i,f=>{const d=f.audioGroups,p=t.filter(m=>!d||d.indexOf(m.groupId)!==-1);return ts(n,p,s)>-1})}function q0(n,e,t){for(let i=e;i>-1;i--)if(t(n[i]))return i;for(let i=e+1;i<n.length;i++)if(t(n[i]))return i;return-1}class cg{constructor(e){this.hls=void 0,this.lastLevelLoadSec=0,this.lastLoadedFragLevel=-1,this.firstSelection=-1,this._nextAutoLevel=-1,this.nextAutoLevelKey="",this.audioTracksByGroup=null,this.codecTiers=null,this.timer=-1,this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.bwEstimator=void 0,this._abandonRulesCheck=()=>{const{fragCurrent:t,partCurrent:i,hls:s}=this,{autoLevelEnabled:r,media:o}=s;if(!t||!o)return;const a=performance.now(),c=i?i.stats:t.stats,l=i?i.duration:t.duration,u=a-c.loading.start,h=s.minAutoLevel;if(c.aborted||c.loaded&&c.loaded===c.total||t.level<=h){this.clearTimer(),this._nextAutoLevel=-1;return}if(!r||o.paused||!o.playbackRate||!o.readyState)return;const f=s.mainForwardBufferInfo;if(f===null)return;const d=this.bwEstimator.getEstimateTTFB(),p=Math.abs(o.playbackRate);if(u<=Math.max(d,1e3*(l/(p*2))))return;const m=f.len/p,g=c.loading.first?c.loading.first-c.loading.start:-1,y=c.loaded&&g>-1,v=this.getBwEstimate(),E=s.levels,C=E[t.level],x=c.total||Math.max(c.loaded,Math.round(l*C.averageBitrate/8));let I=y?u-g:u;I<1&&y&&(I=Math.min(u,c.loaded*8/v));const S=y?c.loaded*1e3/I:0,w=S?(x-c.loaded)/S:x*8/v+d/1e3;if(w<=m)return;const B=S?S*8:v;let T=Number.POSITIVE_INFINITY,R;for(R=t.level-1;R>h;R--){const L=E[R].maxBitrate;if(T=this.getTimeToLoadFrag(d/1e3,B,l*L,!E[R].details),T<m)break}if(T>=w||T>l*10)return;s.nextLoadLevel=s.nextAutoLevel=R,y?this.bwEstimator.sample(u-Math.min(d,g),c.loaded):this.bwEstimator.sampleTTFB(u);const _=E[R].maxBitrate;this.getBwEstimate()*this.hls.config.abrBandWidthUpFactor>_&&this.resetEstimator(_),this.clearTimer(),j.warn(`[abr] Fragment ${t.sn}${i?" part "+i.index:""} of level ${t.level} is loading too slowly;
      Time to underbuffer: ${m.toFixed(3)} s
      Estimated load time for current fragment: ${w.toFixed(3)} s
      Estimated load time for down switch fragment: ${T.toFixed(3)} s
      TTFB estimate: ${g|0} ms
      Current BW estimate: ${ve(v)?v|0:"Unknown"} bps
      New BW estimate: ${this.getBwEstimate()|0} bps
      Switching to level ${R} @ ${_|0} bps`),s.trigger(D.FRAG_LOAD_EMERGENCY_ABORTED,{frag:t,part:i,stats:c})},this.hls=e,this.bwEstimator=this.initEstimator(),this.registerListeners()}resetEstimator(e){e&&(j.log(`setting initial bwe to ${e}`),this.hls.config.abrEwmaDefaultEstimate=e),this.firstSelection=-1,this.bwEstimator=this.initEstimator()}initEstimator(){const e=this.hls.config;return new V5(e.abrEwmaSlowVoD,e.abrEwmaFastVoD,e.abrEwmaDefaultEstimate)}registerListeners(){const{hls:e}=this;e.on(D.MANIFEST_LOADING,this.onManifestLoading,this),e.on(D.FRAG_LOADING,this.onFragLoading,this),e.on(D.FRAG_LOADED,this.onFragLoaded,this),e.on(D.FRAG_BUFFERED,this.onFragBuffered,this),e.on(D.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(D.LEVEL_LOADED,this.onLevelLoaded,this),e.on(D.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(D.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.on(D.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e&&(e.off(D.MANIFEST_LOADING,this.onManifestLoading,this),e.off(D.FRAG_LOADING,this.onFragLoading,this),e.off(D.FRAG_LOADED,this.onFragLoaded,this),e.off(D.FRAG_BUFFERED,this.onFragBuffered,this),e.off(D.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(D.LEVEL_LOADED,this.onLevelLoaded,this),e.off(D.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(D.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),e.off(D.ERROR,this.onError,this))}destroy(){this.unregisterListeners(),this.clearTimer(),this.hls=this._abandonRulesCheck=null,this.fragCurrent=this.partCurrent=null}onManifestLoading(e,t){this.lastLoadedFragLevel=-1,this.firstSelection=-1,this.lastLevelLoadSec=0,this.fragCurrent=this.partCurrent=null,this.onLevelsUpdated(),this.clearTimer()}onLevelsUpdated(){this.lastLoadedFragLevel>-1&&this.fragCurrent&&(this.lastLoadedFragLevel=this.fragCurrent.level),this._nextAutoLevel=-1,this.onMaxAutoLevelUpdated(),this.codecTiers=null,this.audioTracksByGroup=null}onMaxAutoLevelUpdated(){this.firstSelection=-1,this.nextAutoLevelKey=""}onFragLoading(e,t){const i=t.frag;if(!this.ignoreFragment(i)){if(!i.bitrateTest){var s;this.fragCurrent=i,this.partCurrent=(s=t.part)!=null?s:null}this.clearTimer(),this.timer=self.setInterval(this._abandonRulesCheck,100)}}onLevelSwitching(e,t){this.clearTimer()}onError(e,t){if(!t.fatal)switch(t.details){case te.BUFFER_ADD_CODEC_ERROR:case te.BUFFER_APPEND_ERROR:this.lastLoadedFragLevel=-1,this.firstSelection=-1;break;case te.FRAG_LOAD_TIMEOUT:{const i=t.frag,{fragCurrent:s,partCurrent:r}=this;if(i&&s&&i.sn===s.sn&&i.level===s.level){const o=performance.now(),a=r?r.stats:i.stats,c=o-a.loading.start,l=a.loading.first?a.loading.first-a.loading.start:-1;if(a.loaded&&l>-1){const h=this.bwEstimator.getEstimateTTFB();this.bwEstimator.sample(c-Math.min(h,l),a.loaded)}else this.bwEstimator.sampleTTFB(c)}break}}}getTimeToLoadFrag(e,t,i,s){const r=e+i/t,o=s?this.lastLevelLoadSec:0;return r+o}onLevelLoaded(e,t){const i=this.hls.config,{loading:s}=t.stats,r=s.end-s.start;ve(r)&&(this.lastLevelLoadSec=r/1e3),t.details.live?this.bwEstimator.update(i.abrEwmaSlowLive,i.abrEwmaFastLive):this.bwEstimator.update(i.abrEwmaSlowVoD,i.abrEwmaFastVoD)}onFragLoaded(e,{frag:t,part:i}){const s=i?i.stats:t.stats;if(t.type===we.MAIN&&this.bwEstimator.sampleTTFB(s.loading.first-s.loading.start),!this.ignoreFragment(t)){if(this.clearTimer(),t.level===this._nextAutoLevel&&(this._nextAutoLevel=-1),this.firstSelection=-1,this.hls.config.abrMaxWithRealBitrate){const r=i?i.duration:t.duration,o=this.hls.levels[t.level],a=(o.loaded?o.loaded.bytes:0)+s.loaded,c=(o.loaded?o.loaded.duration:0)+r;o.loaded={bytes:a,duration:c},o.realBitrate=Math.round(8*a/c)}if(t.bitrateTest){const r={stats:s,frag:t,part:i,id:t.type};this.onFragBuffered(D.FRAG_BUFFERED,r),t.bitrateTest=!1}else this.lastLoadedFragLevel=t.level}}onFragBuffered(e,t){const{frag:i,part:s}=t,r=s!=null&&s.stats.loaded?s.stats:i.stats;if(r.aborted||this.ignoreFragment(i))return;const o=r.parsing.end-r.loading.start-Math.min(r.loading.first-r.loading.start,this.bwEstimator.getEstimateTTFB());this.bwEstimator.sample(o,r.loaded),r.bwEstimate=this.getBwEstimate(),i.bitrateTest?this.bitrateTestDelay=o/1e3:this.bitrateTestDelay=0}ignoreFragment(e){return e.type!==we.MAIN||e.sn==="initSegment"}clearTimer(){this.timer>-1&&(self.clearInterval(this.timer),this.timer=-1)}get firstAutoLevel(){const{maxAutoLevel:e,minAutoLevel:t}=this.hls,i=this.getBwEstimate(),s=this.hls.config.maxStarvationDelay,r=this.findBestLevel(i,t,e,0,s,1,1);if(r>-1)return r;const o=this.hls.firstLevel,a=Math.min(Math.max(o,t),e);return j.warn(`[abr] Could not find best starting auto level. Defaulting to first in playlist ${o} clamped to ${a}`),a}get forcedAutoLevel(){return this.nextAutoLevelKey?-1:this._nextAutoLevel}get nextAutoLevel(){const e=this.forcedAutoLevel,i=this.bwEstimator.canEstimate(),s=this.lastLoadedFragLevel>-1;if(e!==-1&&(!i||!s||this.nextAutoLevelKey===this.getAutoLevelKey()))return e;const r=i&&s?this.getNextABRAutoLevel():this.firstAutoLevel;if(e!==-1){const o=this.hls.levels;if(o.length>Math.max(e,r)&&o[e].loadError<=o[r].loadError)return e}return this._nextAutoLevel=r,this.nextAutoLevelKey=this.getAutoLevelKey(),r}getAutoLevelKey(){return`${this.getBwEstimate()}_${this.getStarvationDelay().toFixed(2)}`}getNextABRAutoLevel(){const{fragCurrent:e,partCurrent:t,hls:i}=this,{maxAutoLevel:s,config:r,minAutoLevel:o}=i,a=t?t.duration:e?e.duration:0,c=this.getBwEstimate(),l=this.getStarvationDelay();let u=r.abrBandWidthFactor,h=r.abrBandWidthUpFactor;if(l){const g=this.findBestLevel(c,o,s,l,0,u,h);if(g>=0)return g}let f=a?Math.min(a,r.maxStarvationDelay):r.maxStarvationDelay;if(!l){const g=this.bitrateTestDelay;g&&(f=(a?Math.min(a,r.maxLoadingDelay):r.maxLoadingDelay)-g,j.info(`[abr] bitrate test took ${Math.round(1e3*g)}ms, set first fragment max fetchDuration to ${Math.round(1e3*f)} ms`),u=h=1)}const d=this.findBestLevel(c,o,s,l,f,u,h);if(j.info(`[abr] ${l?"rebuffering expected":"buffer is empty"}, optimal quality level ${d}`),d>-1)return d;const p=i.levels[o],m=i.levels[i.loadLevel];return(p==null?void 0:p.bitrate)<(m==null?void 0:m.bitrate)?o:i.loadLevel}getStarvationDelay(){const e=this.hls,t=e.media;if(!t)return 1/0;const i=t&&t.playbackRate!==0?Math.abs(t.playbackRate):1,s=e.mainForwardBufferInfo;return(s?s.len:0)/i}getBwEstimate(){return this.bwEstimator.canEstimate()?this.bwEstimator.getEstimate():this.hls.config.abrEwmaDefaultEstimate}findBestLevel(e,t,i,s,r,o,a){var c;const l=s+r,u=this.lastLoadedFragLevel,h=u===-1?this.hls.firstLevel:u,{fragCurrent:f,partCurrent:d}=this,{levels:p,allAudioTracks:m,loadLevel:g,config:y}=this.hls;if(p.length===1)return 0;const v=p[h],E=!!(v!=null&&(c=v.details)!=null&&c.live),C=g===-1||u===-1;let x,I="SDR",S=(v==null?void 0:v.frameRate)||0;const{audioPreference:w,videoPreference:B}=y,T=this.audioTracksByGroup||(this.audioTracksByGroup=X5(m));if(C){if(this.firstSelection!==-1)return this.firstSelection;const U=this.codecTiers||(this.codecTiers=Z5(p,T,t,i)),Q=q5(U,I,e,w,B),{codecSet:G,videoRanges:z,minFramerate:H,minBitrate:N,preferHDR:V}=Q;x=G,I=V?z[z.length-1]:z[0],S=H,e=Math.max(e,N),j.log(`[abr] picked start tier ${JSON.stringify(Q)}`)}else x=v==null?void 0:v.codecSet,I=v==null?void 0:v.videoRange;const R=d?d.duration:f?f.duration:0,_=this.bwEstimator.getEstimateTTFB()/1e3,L=[];for(let U=i;U>=t;U--){var O;const Q=p[U],G=U>h;if(!Q)continue;if(y.useMediaCapabilities&&!Q.supportedResult&&!Q.supportedPromise){const M=navigator.mediaCapabilities;typeof(M==null?void 0:M.decodingInfo)=="function"&&Y5(Q,T,I,S,e,w)?(Q.supportedPromise=$5(Q,T,M),Q.supportedPromise.then(k=>{if(!this.hls)return;Q.supportedResult=k;const P=this.hls.levels,F=P.indexOf(Q);k.error?j.warn(`[abr] MediaCapabilities decodingInfo error: "${k.error}" for level ${F} ${JSON.stringify(k)}`):k.supported||(j.warn(`[abr] Unsupported MediaCapabilities decodingInfo result for level ${F} ${JSON.stringify(k)}`),F>-1&&P.length>1&&(j.log(`[abr] Removing unsupported level ${F}`),this.hls.removeLevel(F)))})):Q.supportedResult=ag}if(x&&Q.codecSet!==x||I&&Q.videoRange!==I||G&&S>Q.frameRate||!G&&S>0&&S<Q.frameRate||Q.supportedResult&&!((O=Q.supportedResult.decodingInfoResults)!=null&&O[0].smooth)){L.push(U);continue}const z=Q.details,H=(d?z==null?void 0:z.partTarget:z==null?void 0:z.averagetargetduration)||R;let N;G?N=a*e:N=o*e;const V=R&&s>=R*2&&r===0?p[U].averageBitrate:p[U].maxBitrate,$=this.getTimeToLoadFrag(_,N,V*H,z===void 0);if(N>=V&&(U===u||Q.loadError===0&&Q.fragmentError===0)&&($<=_||!ve($)||E&&!this.bitrateTestDelay||$<l)){const M=this.forcedAutoLevel;return U!==g&&(M===-1||M!==g)&&(L.length&&j.trace(`[abr] Skipped level(s) ${L.join(",")} of ${i} max with CODECS and VIDEO-RANGE:"${p[L[0]].codecs}" ${p[L[0]].videoRange}; not compatible with "${v.codecs}" ${I}`),j.info(`[abr] switch candidate:${h}->${U} adjustedbw(${Math.round(N)})-bitrate=${Math.round(N-V)} ttfb:${_.toFixed(1)} avgDuration:${H.toFixed(1)} maxFetchDuration:${l.toFixed(1)} fetchDuration:${$.toFixed(1)} firstSelection:${C} codecSet:${x} videoRange:${I} hls.loadLevel:${g}`)),C&&(this.firstSelection=U),U}}return-1}set nextAutoLevel(e){const{maxAutoLevel:t,minAutoLevel:i}=this.hls,s=Math.min(Math.max(e,i),t);this._nextAutoLevel!==s&&(this.nextAutoLevelKey="",this._nextAutoLevel=s)}}class i6{constructor(){this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}destroy(){this.onHandlerDestroying(),this.onHandlerDestroyed()}onHandlerDestroying(){this.clearNextTick(),this.clearInterval()}onHandlerDestroyed(){}hasInterval(){return!!this._tickInterval}hasNextTick(){return!!this._tickTimer}setInterval(e){return this._tickInterval?!1:(this._tickCallCount=0,this._tickInterval=self.setInterval(this._boundTick,e),!0)}clearInterval(){return this._tickInterval?(self.clearInterval(this._tickInterval),this._tickInterval=null,!0):!1}clearNextTick(){return this._tickTimer?(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0):!1}tick(){this._tickCallCount++,this._tickCallCount===1&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)}tickImmediate(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)}doTick(){}}var bt={NOT_LOADED:"NOT_LOADED",APPENDING:"APPENDING",PARTIAL:"PARTIAL",OK:"OK"};class s6{constructor(e){this.activePartLists=Object.create(null),this.endListFragments=Object.create(null),this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hasGaps=!1,this.hls=e,this._registerListeners()}_registerListeners(){const{hls:e}=this;e.on(D.BUFFER_APPENDED,this.onBufferAppended,this),e.on(D.FRAG_BUFFERED,this.onFragBuffered,this),e.on(D.FRAG_LOADED,this.onFragLoaded,this)}_unregisterListeners(){const{hls:e}=this;e.off(D.BUFFER_APPENDED,this.onBufferAppended,this),e.off(D.FRAG_BUFFERED,this.onFragBuffered,this),e.off(D.FRAG_LOADED,this.onFragLoaded,this)}destroy(){this._unregisterListeners(),this.fragments=this.activePartLists=this.endListFragments=this.timeRanges=null}getAppendedFrag(e,t){const i=this.activePartLists[t];if(i)for(let s=i.length;s--;){const r=i[s];if(!r)break;const o=r.end;if(r.start<=e&&o!==null&&e<=o)return r}return this.getBufferedFrag(e,t)}getBufferedFrag(e,t){const{fragments:i}=this,s=Object.keys(i);for(let r=s.length;r--;){const o=i[s[r]];if((o==null?void 0:o.body.type)===t&&o.buffered){const a=o.body;if(a.start<=e&&e<=a.end)return a}}return null}detectEvictedFragments(e,t,i,s){this.timeRanges&&(this.timeRanges[e]=t);const r=(s==null?void 0:s.fragment.sn)||-1;Object.keys(this.fragments).forEach(o=>{const a=this.fragments[o];if(!a||r>=a.body.sn)return;if(!a.buffered&&!a.loaded){a.body.type===i&&this.removeFragment(a.body);return}const c=a.range[e];c&&c.time.some(l=>{const u=!this.isTimeBuffered(l.startPTS,l.endPTS,t);return u&&this.removeFragment(a.body),u})})}detectPartialFragments(e){const t=this.timeRanges,{frag:i,part:s}=e;if(!t||i.sn==="initSegment")return;const r=Pn(i),o=this.fragments[r];if(!o||o.buffered&&i.gap)return;const a=!i.relurl;Object.keys(t).forEach(c=>{const l=i.elementaryStreams[c];if(!l)return;const u=t[c],h=a||l.partial===!0;o.range[c]=this.getBufferedTimes(i,s,h,u)}),o.loaded=null,Object.keys(o.range).length?(o.buffered=!0,(o.body.endList=i.endList||o.body.endList)&&(this.endListFragments[o.body.type]=o),fa(o)||this.removeParts(i.sn-1,i.type)):this.removeFragment(o.body)}removeParts(e,t){const i=this.activePartLists[t];i&&(this.activePartLists[t]=i.filter(s=>s.fragment.sn>=e))}fragBuffered(e,t){const i=Pn(e);let s=this.fragments[i];!s&&t&&(s=this.fragments[i]={body:e,appendedPTS:null,loaded:null,buffered:!1,range:Object.create(null)},e.gap&&(this.hasGaps=!0)),s&&(s.loaded=null,s.buffered=!0)}getBufferedTimes(e,t,i,s){const r={time:[],partial:i},o=e.start,a=e.end,c=e.minEndPTS||a,l=e.maxStartPTS||o;for(let u=0;u<s.length;u++){const h=s.start(u)-this.bufferPadding,f=s.end(u)+this.bufferPadding;if(l>=h&&c<=f){r.time.push({startPTS:Math.max(o,s.start(u)),endPTS:Math.min(a,s.end(u))});break}else if(o<f&&a>h){const d=Math.max(o,s.start(u)),p=Math.min(a,s.end(u));p>d&&(r.partial=!0,r.time.push({startPTS:d,endPTS:p}))}else if(a<=h)break}return r}getPartialFragment(e){let t=null,i,s,r,o=0;const{bufferPadding:a,fragments:c}=this;return Object.keys(c).forEach(l=>{const u=c[l];u&&fa(u)&&(s=u.body.start-a,r=u.body.end+a,e>=s&&e<=r&&(i=Math.min(e-s,r-e),o<=i&&(t=u.body,o=i)))}),t}isEndListAppended(e){const t=this.endListFragments[e];return t!==void 0&&(t.buffered||fa(t))}getState(e){const t=Pn(e),i=this.fragments[t];return i?i.buffered?fa(i)?bt.PARTIAL:bt.OK:bt.APPENDING:bt.NOT_LOADED}isTimeBuffered(e,t,i){let s,r;for(let o=0;o<i.length;o++){if(s=i.start(o)-this.bufferPadding,r=i.end(o)+this.bufferPadding,e>=s&&t<=r)return!0;if(t<=s)return!1}return!1}onFragLoaded(e,t){const{frag:i,part:s}=t;if(i.sn==="initSegment"||i.bitrateTest)return;const r=s?null:t,o=Pn(i);this.fragments[o]={body:i,appendedPTS:null,loaded:r,buffered:!1,range:Object.create(null)}}onBufferAppended(e,t){const{frag:i,part:s,timeRanges:r}=t;if(i.sn==="initSegment")return;const o=i.type;if(s){let a=this.activePartLists[o];a||(this.activePartLists[o]=a=[]),a.push(s)}this.timeRanges=r,Object.keys(r).forEach(a=>{const c=r[a];this.detectEvictedFragments(a,c,o,s)})}onFragBuffered(e,t){this.detectPartialFragments(t)}hasFragment(e){const t=Pn(e);return!!this.fragments[t]}hasParts(e){var t;return!!((t=this.activePartLists[e])!=null&&t.length)}removeFragmentsInRange(e,t,i,s,r){s&&!this.hasGaps||Object.keys(this.fragments).forEach(o=>{const a=this.fragments[o];if(!a)return;const c=a.body;c.type!==i||s&&!c.gap||c.start<t&&c.end>e&&(a.buffered||r)&&this.removeFragment(c)})}removeFragment(e){const t=Pn(e);e.stats.loaded=0,e.clearElementaryStreamInfo();const i=this.activePartLists[e.type];if(i){const s=e.sn;this.activePartLists[e.type]=i.filter(r=>r.fragment.sn!==s)}delete this.fragments[t],e.endList&&delete this.endListFragments[e.type]}removeAllFragments(){this.fragments=Object.create(null),this.endListFragments=Object.create(null),this.activePartLists=Object.create(null),this.hasGaps=!1}}function fa(n){var e,t,i;return n.buffered&&(n.body.gap||((e=n.range.video)==null?void 0:e.partial)||((t=n.range.audio)==null?void 0:t.partial)||((i=n.range.audiovideo)==null?void 0:i.partial))}function Pn(n){return`${n.type}_${n.level}_${n.sn}`}const n6={length:0,start:()=>0,end:()=>0};class Ze{static isBuffered(e,t){try{if(e){const i=Ze.getBuffered(e);for(let s=0;s<i.length;s++)if(t>=i.start(s)&&t<=i.end(s))return!0}}catch{}return!1}static bufferInfo(e,t,i){try{if(e){const s=Ze.getBuffered(e),r=[];let o;for(o=0;o<s.length;o++)r.push({start:s.start(o),end:s.end(o)});return this.bufferedInfo(r,t,i)}}catch{}return{len:0,start:t,end:t,nextStart:void 0}}static bufferedInfo(e,t,i){t=Math.max(0,t),e.sort(function(l,u){const h=l.start-u.start;return h||u.end-l.end});let s=[];if(i)for(let l=0;l<e.length;l++){const u=s.length;if(u){const h=s[u-1].end;e[l].start-h<i?e[l].end>h&&(s[u-1].end=e[l].end):s.push(e[l])}else s.push(e[l])}else s=e;let r=0,o,a=t,c=t;for(let l=0;l<s.length;l++){const u=s[l].start,h=s[l].end;if(t+i>=u&&t<h)a=u,c=h,r=c-t;else if(t+i<u){o=u;break}}return{len:r,start:a||0,end:c||0,nextStart:o}}static getBuffered(e){try{return e.buffered}catch(t){return j.log("failed to get media.buffered",t),n6}}}class zc{constructor(e,t,i,s=0,r=-1,o=!1){this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing=da(),this.buffering={audio:da(),video:da(),audiovideo:da()},this.level=e,this.sn=t,this.id=i,this.size=s,this.part=r,this.partial=o}}function da(){return{start:0,executeStart:0,executeEnd:0,end:0}}function Za(n,e){for(let i=0,s=n.length;i<s;i++){var t;if(((t=n[i])==null?void 0:t.cc)===e)return n[i]}return null}function r6(n,e,t){return!!(e&&(t.endCC>t.startCC||n&&n.cc<t.startCC))}function o6(n,e){const t=n.fragments,i=e.fragments;if(!i.length||!t.length){j.log("No fragments to align");return}const s=Za(t,i[0].cc);if(!s||s&&!s.startPTS){j.log("No frag in previous level to align on");return}return s}function X0(n,e){if(n){const t=n.start+e;n.start=n.startPTS=t,n.endPTS=t+n.duration}}function lg(n,e){const t=e.fragments;for(let i=0,s=t.length;i<s;i++)X0(t[i],n);e.fragmentHint&&X0(e.fragmentHint,n),e.alignedSliding=!0}function a6(n,e,t){e&&(c6(n,t,e),!t.alignedSliding&&e&&Sc(t,e),!t.alignedSliding&&e&&!t.skippedSegments&&ig(e,t))}function c6(n,e,t){if(r6(n,t,e)){const i=o6(t,e);i&&ve(i.start)&&(j.log(`Adjusting PTS using last level due to CC increase within current level ${e.url}`),lg(i.start,e))}}function Sc(n,e){if(!n.hasProgramDateTime||!e.hasProgramDateTime)return;const t=n.fragments,i=e.fragments;if(!t.length||!i.length)return;let s,r;const o=Math.min(e.endCC,n.endCC);e.startCC<o&&n.startCC<o&&(s=Za(i,o),r=Za(t,o)),(!s||!r)&&(s=i[Math.floor(i.length/2)],r=Za(t,s.cc)||t[Math.floor(t.length/2)]);const a=s.programDateTime,c=r.programDateTime;if(!a||!c)return;const l=(c-a)/1e3-(r.start-s.start);lg(l,n)}const Z0=Math.pow(2,17);class l6{constructor(e){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=e}destroy(){this.loader&&(this.loader.destroy(),this.loader=null)}abort(){this.loader&&this.loader.abort()}load(e,t){const i=e.url;if(!i)return Promise.reject(new Es({type:_e.NETWORK_ERROR,details:te.FRAG_LOAD_ERROR,fatal:!1,frag:e,error:new Error(`Fragment does not have a ${i?"part list":"url"}`),networkDetails:null}));this.abort();const s=this.config,r=s.fLoader,o=s.loader;return new Promise((a,c)=>{if(this.loader&&this.loader.destroy(),e.gap)if(e.tagList.some(d=>d[0]==="GAP")){c(tA(e));return}else e.gap=!1;const l=this.loader=e.loader=r?new r(s):new o(s),u=eA(e),h=j0(s.fragLoadPolicy.default),f={loadPolicy:h,timeout:h.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:e.sn==="initSegment"?1/0:Z0};e.stats=l.stats,l.load(u,f,{onSuccess:(d,p,m,g)=>{this.resetLoader(e,l);let y=d.data;m.resetIV&&e.decryptdata&&(e.decryptdata.iv=new Uint8Array(y.slice(0,16)),y=y.slice(16)),a({frag:e,part:null,payload:y,networkDetails:g})},onError:(d,p,m,g)=>{this.resetLoader(e,l),c(new Es({type:_e.NETWORK_ERROR,details:te.FRAG_LOAD_ERROR,fatal:!1,frag:e,response:Mt({url:i,data:void 0},d),error:new Error(`HTTP Error ${d.code} ${d.text}`),networkDetails:m,stats:g}))},onAbort:(d,p,m)=>{this.resetLoader(e,l),c(new Es({type:_e.NETWORK_ERROR,details:te.INTERNAL_ABORTED,fatal:!1,frag:e,error:new Error("Aborted"),networkDetails:m,stats:d}))},onTimeout:(d,p,m)=>{this.resetLoader(e,l),c(new Es({type:_e.NETWORK_ERROR,details:te.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,error:new Error(`Timeout after ${f.timeout}ms`),networkDetails:m,stats:d}))},onProgress:(d,p,m,g)=>{t&&t({frag:e,part:null,payload:m,networkDetails:g})}})})}loadPart(e,t,i){this.abort();const s=this.config,r=s.fLoader,o=s.loader;return new Promise((a,c)=>{if(this.loader&&this.loader.destroy(),e.gap||t.gap){c(tA(e,t));return}const l=this.loader=e.loader=r?new r(s):new o(s),u=eA(e,t),h=j0(s.fragLoadPolicy.default),f={loadPolicy:h,timeout:h.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:Z0};t.stats=l.stats,l.load(u,f,{onSuccess:(d,p,m,g)=>{this.resetLoader(e,l),this.updateStatsFromPart(e,t);const y={frag:e,part:t,payload:d.data,networkDetails:g};i(y),a(y)},onError:(d,p,m,g)=>{this.resetLoader(e,l),c(new Es({type:_e.NETWORK_ERROR,details:te.FRAG_LOAD_ERROR,fatal:!1,frag:e,part:t,response:Mt({url:u.url,data:void 0},d),error:new Error(`HTTP Error ${d.code} ${d.text}`),networkDetails:m,stats:g}))},onAbort:(d,p,m)=>{e.stats.aborted=t.stats.aborted,this.resetLoader(e,l),c(new Es({type:_e.NETWORK_ERROR,details:te.INTERNAL_ABORTED,fatal:!1,frag:e,part:t,error:new Error("Aborted"),networkDetails:m,stats:d}))},onTimeout:(d,p,m)=>{this.resetLoader(e,l),c(new Es({type:_e.NETWORK_ERROR,details:te.FRAG_LOAD_TIMEOUT,fatal:!1,frag:e,part:t,error:new Error(`Timeout after ${f.timeout}ms`),networkDetails:m,stats:d}))}})})}updateStatsFromPart(e,t){const i=e.stats,s=t.stats,r=s.total;if(i.loaded+=s.loaded,r){const c=Math.round(e.duration/t.duration),l=Math.min(Math.round(i.loaded/r),c),h=(c-l)*Math.round(i.loaded/l);i.total=i.loaded+h}else i.total=Math.max(i.loaded,i.total);const o=i.loading,a=s.loading;o.start?o.first+=a.first-a.start:(o.start=a.start,o.first=a.first),o.end=a.end}resetLoader(e,t){e.loader=null,this.loader===t&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),t.destroy()}}function eA(n,e=null){const t=e||n,i={frag:n,part:e,responseType:"arraybuffer",url:t.url,headers:{},rangeStart:0,rangeEnd:0},s=t.byteRangeStartOffset,r=t.byteRangeEndOffset;if(ve(s)&&ve(r)){var o;let a=s,c=r;if(n.sn==="initSegment"&&((o=n.decryptdata)==null?void 0:o.method)==="AES-128"){const l=r-s;l%16&&(c=r+(16-l%16)),s!==0&&(i.resetIV=!0,a=s-16)}i.rangeStart=a,i.rangeEnd=c}return i}function tA(n,e){const t=new Error(`GAP ${n.gap?"tag":"attribute"} found`),i={type:_e.MEDIA_ERROR,details:te.FRAG_GAP,fatal:!1,frag:n,error:t,networkDetails:null};return e&&(i.part=e),(e||n).stats.aborted=!0,new Es(i)}class Es extends Error{constructor(e){super(e.error.message),this.data=void 0,this.data=e}}class u6{constructor(e,t){this.subtle=void 0,this.aesIV=void 0,this.subtle=e,this.aesIV=t}decrypt(e,t){return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},t,e)}}class h6{constructor(e,t){this.subtle=void 0,this.key=void 0,this.subtle=e,this.key=t}expandKey(){return this.subtle.importKey("raw",this.key,{name:"AES-CBC"},!1,["encrypt","decrypt"])}}function f6(n){const e=n.byteLength,t=e&&new DataView(n.buffer).getUint8(e-1);return t?an(n,0,e-t):n}class d6{constructor(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}uint8ArrayToUint32Array_(e){const t=new DataView(e),i=new Uint32Array(4);for(let s=0;s<4;s++)i[s]=t.getUint32(s*4);return i}initTable(){const e=this.sBox,t=this.invSBox,i=this.subMix,s=i[0],r=i[1],o=i[2],a=i[3],c=this.invSubMix,l=c[0],u=c[1],h=c[2],f=c[3],d=new Uint32Array(256);let p=0,m=0,g=0;for(g=0;g<256;g++)g<128?d[g]=g<<1:d[g]=g<<1^283;for(g=0;g<256;g++){let y=m^m<<1^m<<2^m<<3^m<<4;y=y>>>8^y&255^99,e[p]=y,t[y]=p;const v=d[p],E=d[v],C=d[E];let x=d[y]*257^y*16843008;s[p]=x<<24|x>>>8,r[p]=x<<16|x>>>16,o[p]=x<<8|x>>>24,a[p]=x,x=C*16843009^E*65537^v*257^p*16843008,l[y]=x<<24|x>>>8,u[y]=x<<16|x>>>16,h[y]=x<<8|x>>>24,f[y]=x,p?(p=v^d[d[d[C^v]]],m^=d[d[m]]):p=m=1}}expandKey(e){const t=this.uint8ArrayToUint32Array_(e);let i=!0,s=0;for(;s<t.length&&i;)i=t[s]===this.key[s],s++;if(i)return;this.key=t;const r=this.keySize=t.length;if(r!==4&&r!==6&&r!==8)throw new Error("Invalid aes key size="+r);const o=this.ksRows=(r+6+1)*4;let a,c;const l=this.keySchedule=new Uint32Array(o),u=this.invKeySchedule=new Uint32Array(o),h=this.sBox,f=this.rcon,d=this.invSubMix,p=d[0],m=d[1],g=d[2],y=d[3];let v,E;for(a=0;a<o;a++){if(a<r){v=l[a]=t[a];continue}E=v,a%r===0?(E=E<<8|E>>>24,E=h[E>>>24]<<24|h[E>>>16&255]<<16|h[E>>>8&255]<<8|h[E&255],E^=f[a/r|0]<<24):r>6&&a%r===4&&(E=h[E>>>24]<<24|h[E>>>16&255]<<16|h[E>>>8&255]<<8|h[E&255]),l[a]=v=(l[a-r]^E)>>>0}for(c=0;c<o;c++)a=o-c,c&3?E=l[a]:E=l[a-4],c<4||a<=4?u[c]=E:u[c]=p[h[E>>>24]]^m[h[E>>>16&255]]^g[h[E>>>8&255]]^y[h[E&255]],u[c]=u[c]>>>0}networkToHostOrderSwap(e){return e<<24|(e&65280)<<8|(e&16711680)>>8|e>>>24}decrypt(e,t,i){const s=this.keySize+6,r=this.invKeySchedule,o=this.invSBox,a=this.invSubMix,c=a[0],l=a[1],u=a[2],h=a[3],f=this.uint8ArrayToUint32Array_(i);let d=f[0],p=f[1],m=f[2],g=f[3];const y=new Int32Array(e),v=new Int32Array(y.length);let E,C,x,I,S,w,B,T,R,_,L,O,U,Q;const G=this.networkToHostOrderSwap;for(;t<y.length;){for(R=G(y[t]),_=G(y[t+1]),L=G(y[t+2]),O=G(y[t+3]),S=R^r[0],w=O^r[1],B=L^r[2],T=_^r[3],U=4,Q=1;Q<s;Q++)E=c[S>>>24]^l[w>>16&255]^u[B>>8&255]^h[T&255]^r[U],C=c[w>>>24]^l[B>>16&255]^u[T>>8&255]^h[S&255]^r[U+1],x=c[B>>>24]^l[T>>16&255]^u[S>>8&255]^h[w&255]^r[U+2],I=c[T>>>24]^l[S>>16&255]^u[w>>8&255]^h[B&255]^r[U+3],S=E,w=C,B=x,T=I,U=U+4;E=o[S>>>24]<<24^o[w>>16&255]<<16^o[B>>8&255]<<8^o[T&255]^r[U],C=o[w>>>24]<<24^o[B>>16&255]<<16^o[T>>8&255]<<8^o[S&255]^r[U+1],x=o[B>>>24]<<24^o[T>>16&255]<<16^o[S>>8&255]<<8^o[w&255]^r[U+2],I=o[T>>>24]<<24^o[S>>16&255]<<16^o[w>>8&255]<<8^o[B&255]^r[U+3],v[t]=G(E^d),v[t+1]=G(I^p),v[t+2]=G(x^m),v[t+3]=G(C^g),d=R,p=_,m=L,g=O,t=t+4}return v.buffer}}const A6=16;class hf{constructor(e,{removePKCS7Padding:t=!0}={}){if(this.logEnabled=!0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.useSoftware=void 0,this.useSoftware=e.enableSoftwareAES,this.removePKCS7Padding=t,t)try{const i=self.crypto;i&&(this.subtle=i.subtle||i.webkitSubtle)}catch{}this.useSoftware=!this.subtle}destroy(){this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null}isSync(){return this.useSoftware}flush(){const{currentResult:e,remainderData:t}=this;if(!e||t)return this.reset(),null;const i=new Uint8Array(e);return this.reset(),this.removePKCS7Padding?f6(i):i}reset(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)}decrypt(e,t,i){return this.useSoftware?new Promise((s,r)=>{this.softwareDecrypt(new Uint8Array(e),t,i);const o=this.flush();o?s(o.buffer):r(new Error("[softwareDecrypt] Failed to decrypt data"))}):this.webCryptoDecrypt(new Uint8Array(e),t,i)}softwareDecrypt(e,t,i){const{currentIV:s,currentResult:r,remainderData:o}=this;this.logOnce("JS AES decrypt"),o&&(e=_i(o,e),this.remainderData=null);const a=this.getValidChunk(e);if(!a.length)return null;s&&(i=s);let c=this.softwareDecrypter;c||(c=this.softwareDecrypter=new d6),c.expandKey(t);const l=r;return this.currentResult=c.decrypt(a.buffer,0,i),this.currentIV=an(a,-16).buffer,l||null}webCryptoDecrypt(e,t,i){if(this.key!==t||!this.fastAesKey){if(!this.subtle)return Promise.resolve(this.onWebCryptoError(e,t,i));this.key=t,this.fastAesKey=new h6(this.subtle,t)}return this.fastAesKey.expandKey().then(s=>this.subtle?(this.logOnce("WebCrypto AES decrypt"),new u6(this.subtle,new Uint8Array(i)).decrypt(e.buffer,s)):Promise.reject(new Error("web crypto not initialized"))).catch(s=>(j.warn(`[decrypter]: WebCrypto Error, disable WebCrypto API, ${s.name}: ${s.message}`),this.onWebCryptoError(e,t,i)))}onWebCryptoError(e,t,i){this.useSoftware=!0,this.logEnabled=!0,this.softwareDecrypt(e,t,i);const s=this.flush();if(s)return s.buffer;throw new Error("WebCrypto and softwareDecrypt: failed to decrypt data")}getValidChunk(e){let t=e;const i=e.length-e.length%A6;return i!==e.length&&(t=an(e,0,i),this.remainderData=an(e,i)),t}logOnce(e){this.logEnabled&&(j.log(`[decrypter]: ${e}`),this.logEnabled=!1)}}const m6={toString:function(n){let e="";const t=n.length;for(let i=0;i<t;i++)e+=`[${n.start(i).toFixed(3)}-${n.end(i).toFixed(3)}]`;return e}},le={STOPPED:"STOPPED",IDLE:"IDLE",KEY_LOADING:"KEY_LOADING",FRAG_LOADING:"FRAG_LOADING",FRAG_LOADING_WAITING_RETRY:"FRAG_LOADING_WAITING_RETRY",WAITING_TRACK:"WAITING_TRACK",PARSING:"PARSING",PARSED:"PARSED",ENDED:"ENDED",ERROR:"ERROR",WAITING_INIT_PTS:"WAITING_INIT_PTS",WAITING_LEVEL:"WAITING_LEVEL"};class Hc extends i6{constructor(e,t,i,s,r){super(),this.hls=void 0,this.fragPrevious=null,this.fragCurrent=null,this.fragmentTracker=void 0,this.transmuxer=null,this._state=le.STOPPED,this.playlistType=void 0,this.media=null,this.mediaBuffer=null,this.config=void 0,this.bitrateTest=!1,this.lastCurrentTime=0,this.nextLoadPosition=0,this.startPosition=0,this.startTimeOffset=null,this.loadedmetadata=!1,this.retryDate=0,this.levels=null,this.fragmentLoader=void 0,this.keyLoader=void 0,this.levelLastLoaded=null,this.startFragRequested=!1,this.decrypter=void 0,this.initPTS=[],this.onvseeking=null,this.onvended=null,this.logPrefix="",this.log=void 0,this.warn=void 0,this.playlistType=r,this.logPrefix=s,this.log=j.log.bind(j,`${s}:`),this.warn=j.warn.bind(j,`${s}:`),this.hls=e,this.fragmentLoader=new l6(e.config),this.keyLoader=i,this.fragmentTracker=t,this.config=e.config,this.decrypter=new hf(e.config),e.on(D.MANIFEST_LOADED,this.onManifestLoaded,this)}doTick(){this.onTickEnd()}onTickEnd(){}startLoad(e){}stopLoad(){this.fragmentLoader.abort(),this.keyLoader.abort(this.playlistType);const e=this.fragCurrent;e!=null&&e.loader&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=le.STOPPED}_streamEnded(e,t){if(t.live||e.nextStart||!e.end||!this.media)return!1;const i=t.partList;if(i!=null&&i.length){const r=i[i.length-1];return Ze.isBuffered(this.media,r.start+r.duration/2)}const s=t.fragments[t.fragments.length-1].type;return this.fragmentTracker.isEndListAppended(s)}getLevelDetails(){if(this.levels&&this.levelLastLoaded!==null){var e;return(e=this.levelLastLoaded)==null?void 0:e.details}}onMediaAttached(e,t){const i=this.media=this.mediaBuffer=t.media;this.onvseeking=this.onMediaSeeking.bind(this),this.onvended=this.onMediaEnded.bind(this),i.addEventListener("seeking",this.onvseeking),i.addEventListener("ended",this.onvended);const s=this.config;this.levels&&s.autoStartLoad&&this.state===le.STOPPED&&this.startLoad(s.startPosition)}onMediaDetaching(){const e=this.media;e!=null&&e.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),e&&this.onvseeking&&this.onvended&&(e.removeEventListener("seeking",this.onvseeking),e.removeEventListener("ended",this.onvended),this.onvseeking=this.onvended=null),this.keyLoader&&this.keyLoader.detach(),this.media=this.mediaBuffer=null,this.loadedmetadata=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()}onMediaSeeking(){const{config:e,fragCurrent:t,media:i,mediaBuffer:s,state:r}=this,o=i?i.currentTime:0,a=Ze.bufferInfo(s||i,o,e.maxBufferHole);if(this.log(`media seeking to ${ve(o)?o.toFixed(3):o}, state: ${r}`),this.state===le.ENDED)this.resetLoadingState();else if(t){const c=e.maxFragLookUpTolerance,l=t.start-c,u=t.start+t.duration+c;if(!a.len||u<a.start||l>a.end){const h=o>u;(o<l||h)&&(h&&t.loader&&(this.log("seeking outside of buffer while fragment load in progress, cancel fragment load"),t.abortRequests(),this.resetLoadingState()),this.fragPrevious=null)}}i&&(this.fragmentTracker.removeFragmentsInRange(o,1/0,this.playlistType,!0),this.lastCurrentTime=o),!this.loadedmetadata&&!a.len&&(this.nextLoadPosition=this.startPosition=o),this.tickImmediate()}onMediaEnded(){this.startPosition=this.lastCurrentTime=0}onManifestLoaded(e,t){this.startTimeOffset=t.startTimeOffset,this.initPTS=[]}onHandlerDestroying(){this.hls.off(D.MANIFEST_LOADED,this.onManifestLoaded,this),this.stopLoad(),super.onHandlerDestroying(),this.hls=null}onHandlerDestroyed(){this.state=le.STOPPED,this.fragmentLoader&&this.fragmentLoader.destroy(),this.keyLoader&&this.keyLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.keyLoader=this.fragmentLoader=this.fragmentTracker=null,super.onHandlerDestroyed()}loadFragment(e,t,i){this._loadFragForPlayback(e,t,i)}_loadFragForPlayback(e,t,i){const s=r=>{if(this.fragContextChanged(e)){this.warn(`Fragment ${e.sn}${r.part?" p: "+r.part.index:""} of level ${e.level} was dropped during download.`),this.fragmentTracker.removeFragment(e);return}e.stats.chunkCount++,this._handleFragmentLoadProgress(r)};this._doFragLoad(e,t,i,s).then(r=>{if(!r)return;const o=this.state;if(this.fragContextChanged(e)){(o===le.FRAG_LOADING||!this.fragCurrent&&o===le.PARSING)&&(this.fragmentTracker.removeFragment(e),this.state=le.IDLE);return}"payload"in r&&(this.log(`Loaded fragment ${e.sn} of level ${e.level}`),this.hls.trigger(D.FRAG_LOADED,r)),this._handleFragmentLoadComplete(r)}).catch(r=>{this.state===le.STOPPED||this.state===le.ERROR||(this.warn(`Frag error: ${(r==null?void 0:r.message)||r}`),this.resetFragmentLoading(e))})}clearTrackerIfNeeded(e){var t;const{fragmentTracker:i}=this;if(i.getState(e)===bt.APPENDING){const r=e.type,o=this.getFwdBufferInfo(this.mediaBuffer,r),a=Math.max(e.duration,o?o.len:this.config.maxBufferLength),c=this.backtrackFragment;((c?e.sn-c.sn:0)===1||this.reduceMaxBufferLength(a,e.duration))&&i.removeFragment(e)}else((t=this.mediaBuffer)==null?void 0:t.buffered.length)===0?i.removeAllFragments():i.hasParts(e.type)&&(i.detectPartialFragments({frag:e,part:null,stats:e.stats,id:e.type}),i.getState(e)===bt.PARTIAL&&i.removeFragment(e))}checkLiveUpdate(e){if(e.updated&&!e.live){const t=e.fragments[e.fragments.length-1];this.fragmentTracker.detectPartialFragments({frag:t,part:null,stats:t.stats,id:t.type})}e.fragments[0]||(e.deltaUpdateFailed=!0)}flushMainBuffer(e,t,i=null){if(!(e-t))return;const s={startOffset:e,endOffset:t,type:i};this.hls.trigger(D.BUFFER_FLUSHING,s)}_loadInitSegment(e,t){this._doFragLoad(e,t).then(i=>{if(!i||this.fragContextChanged(e)||!this.levels)throw new Error("init load aborted");return i}).then(i=>{const{hls:s}=this,{payload:r}=i,o=e.decryptdata;if(r&&r.byteLength>0&&o!=null&&o.key&&o.iv&&o.method==="AES-128"){const a=self.performance.now();return this.decrypter.decrypt(new Uint8Array(r),o.key.buffer,o.iv.buffer).catch(c=>{throw s.trigger(D.ERROR,{type:_e.MEDIA_ERROR,details:te.FRAG_DECRYPT_ERROR,fatal:!1,error:c,reason:c.message,frag:e}),c}).then(c=>{const l=self.performance.now();return s.trigger(D.FRAG_DECRYPTED,{frag:e,payload:c,stats:{tstart:a,tdecrypt:l}}),i.payload=c,this.completeInitSegmentLoad(i)})}return this.completeInitSegmentLoad(i)}).catch(i=>{this.state===le.STOPPED||this.state===le.ERROR||(this.warn(i),this.resetFragmentLoading(e))})}completeInitSegmentLoad(e){const{levels:t}=this;if(!t)throw new Error("init load aborted, missing levels");const i=e.frag.stats;this.state=le.IDLE,e.frag.data=new Uint8Array(e.payload),i.parsing.start=i.buffering.start=self.performance.now(),i.parsing.end=i.buffering.end=self.performance.now(),this.tick()}fragContextChanged(e){const{fragCurrent:t}=this;return!e||!t||e.sn!==t.sn||e.level!==t.level}fragBufferedComplete(e,t){var i,s,r,o;const a=this.mediaBuffer?this.mediaBuffer:this.media;if(this.log(`Buffered ${e.type} sn: ${e.sn}${t?" part: "+t.index:""} of ${this.playlistType===we.MAIN?"level":"track"} ${e.level} (frag:[${((i=e.startPTS)!=null?i:NaN).toFixed(3)}-${((s=e.endPTS)!=null?s:NaN).toFixed(3)}] > buffer:${a?m6.toString(Ze.getBuffered(a)):"(detached)"})`),e.sn!=="initSegment"){var c;if(e.type!==we.SUBTITLE){const u=e.elementaryStreams;if(!Object.keys(u).some(h=>!!u[h])){this.state=le.IDLE;return}}const l=(c=this.levels)==null?void 0:c[e.level];l!=null&&l.fragmentError&&(this.log(`Resetting level fragment error count of ${l.fragmentError} on frag buffered`),l.fragmentError=0)}this.state=le.IDLE,a&&(!this.loadedmetadata&&e.type==we.MAIN&&a.buffered.length&&((r=this.fragCurrent)==null?void 0:r.sn)===((o=this.fragPrevious)==null?void 0:o.sn)&&(this.loadedmetadata=!0,this.seekToStartPos()),this.tick())}seekToStartPos(){}_handleFragmentLoadComplete(e){const{transmuxer:t}=this;if(!t)return;const{frag:i,part:s,partsLoaded:r}=e,o=!r||r.length===0||r.some(c=>!c),a=new zc(i.level,i.sn,i.stats.chunkCount+1,0,s?s.index:-1,!o);t.flush(a)}_handleFragmentLoadProgress(e){}_doFragLoad(e,t,i=null,s){var r;const o=t==null?void 0:t.details;if(!this.levels||!o)throw new Error(`frag load aborted, missing level${o?"":" detail"}s`);let a=null;if(e.encrypted&&!((r=e.decryptdata)!=null&&r.key)?(this.log(`Loading key for ${e.sn} of [${o.startSN}-${o.endSN}], ${this.logPrefix==="[stream-controller]"?"level":"track"} ${e.level}`),this.state=le.KEY_LOADING,this.fragCurrent=e,a=this.keyLoader.load(e).then(u=>{if(!this.fragContextChanged(u.frag))return this.hls.trigger(D.KEY_LOADED,u),this.state===le.KEY_LOADING&&(this.state=le.IDLE),u}),this.hls.trigger(D.KEY_LOADING,{frag:e}),this.fragCurrent===null&&(a=Promise.reject(new Error("frag load aborted, context changed in KEY_LOADING")))):!e.encrypted&&o.encryptedFragments.length&&this.keyLoader.loadClear(e,o.encryptedFragments),i=Math.max(e.start,i||0),this.config.lowLatencyMode&&e.sn!=="initSegment"){const u=o.partList;if(u&&s){i>e.end&&o.fragmentHint&&(e=o.fragmentHint);const h=this.getNextPart(u,e,i);if(h>-1){const f=u[h];this.log(`Loading part sn: ${e.sn} p: ${f.index} cc: ${e.cc} of playlist [${o.startSN}-${o.endSN}] parts [0-${h}-${u.length-1}] ${this.logPrefix==="[stream-controller]"?"level":"track"}: ${e.level}, target: ${parseFloat(i.toFixed(3))}`),this.nextLoadPosition=f.start+f.duration,this.state=le.FRAG_LOADING;let d;return a?d=a.then(p=>!p||this.fragContextChanged(p.frag)?null:this.doFragPartsLoad(e,f,t,s)).catch(p=>this.handleFragLoadError(p)):d=this.doFragPartsLoad(e,f,t,s).catch(p=>this.handleFragLoadError(p)),this.hls.trigger(D.FRAG_LOADING,{frag:e,part:f,targetBufferTime:i}),this.fragCurrent===null?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING parts")):d}else if(!e.url||this.loadedEndOfParts(u,i))return Promise.resolve(null)}}this.log(`Loading fragment ${e.sn} cc: ${e.cc} ${o?"of ["+o.startSN+"-"+o.endSN+"] ":""}${this.logPrefix==="[stream-controller]"?"level":"track"}: ${e.level}, target: ${parseFloat(i.toFixed(3))}`),ve(e.sn)&&!this.bitrateTest&&(this.nextLoadPosition=e.start+e.duration),this.state=le.FRAG_LOADING;const c=this.config.progressive;let l;return c&&a?l=a.then(u=>!u||this.fragContextChanged(u==null?void 0:u.frag)?null:this.fragmentLoader.load(e,s)).catch(u=>this.handleFragLoadError(u)):l=Promise.all([this.fragmentLoader.load(e,c?s:void 0),a]).then(([u])=>(!c&&u&&s&&s(u),u)).catch(u=>this.handleFragLoadError(u)),this.hls.trigger(D.FRAG_LOADING,{frag:e,targetBufferTime:i}),this.fragCurrent===null?Promise.reject(new Error("frag load aborted, context changed in FRAG_LOADING")):l}doFragPartsLoad(e,t,i,s){return new Promise((r,o)=>{var a;const c=[],l=(a=i.details)==null?void 0:a.partList,u=h=>{this.fragmentLoader.loadPart(e,h,s).then(f=>{c[h.index]=f;const d=f.part;this.hls.trigger(D.FRAG_LOADED,f);const p=$0(i,e.sn,h.index+1)||sg(l,e.sn,h.index+1);if(p)u(p);else return r({frag:e,part:d,partsLoaded:c})}).catch(o)};u(t)})}handleFragLoadError(e){if("data"in e){const t=e.data;e.data&&t.details===te.INTERNAL_ABORTED?this.handleFragLoadAborted(t.frag,t.part):this.hls.trigger(D.ERROR,t)}else this.hls.trigger(D.ERROR,{type:_e.OTHER_ERROR,details:te.INTERNAL_EXCEPTION,err:e,error:e,fatal:!0});return null}_handleTransmuxerFlush(e){const t=this.getCurrentContext(e);if(!t||this.state!==le.PARSING){!this.fragCurrent&&this.state!==le.STOPPED&&this.state!==le.ERROR&&(this.state=le.IDLE);return}const{frag:i,part:s,level:r}=t,o=self.performance.now();i.stats.parsing.end=o,s&&(s.stats.parsing.end=o),this.updateLevelTiming(i,s,r,e.partial)}getCurrentContext(e){const{levels:t,fragCurrent:i}=this,{level:s,sn:r,part:o}=e;if(!(t!=null&&t[s]))return this.warn(`Levels object was unset while buffering fragment ${r} of level ${s}. The current chunk will not be buffered.`),null;const a=t[s],c=o>-1?$0(a,r,o):null,l=c?c.fragment:Q5(a,r,i);return l?(i&&i!==l&&(l.stats=i.stats),{frag:l,part:c,level:a}):null}bufferFragmentData(e,t,i,s,r){var o;if(!e||this.state!==le.PARSING)return;const{data1:a,data2:c}=e;let l=a;if(a&&c&&(l=_i(a,c)),!((o=l)!=null&&o.length))return;const u={type:e.type,frag:t,part:i,chunkMeta:s,parent:t.type,data:l};if(this.hls.trigger(D.BUFFER_APPENDING,u),e.dropped&&e.independent&&!i){if(r)return;this.flushBufferGap(t)}}flushBufferGap(e){const t=this.media;if(!t)return;if(!Ze.isBuffered(t,t.currentTime)){this.flushMainBuffer(0,e.start);return}const i=t.currentTime,s=Ze.bufferInfo(t,i,0),r=e.duration,o=Math.min(this.config.maxFragLookUpTolerance*2,r*.25),a=Math.max(Math.min(e.start-o,s.end-o),i+o);e.start-a>o&&this.flushMainBuffer(a,e.start)}getFwdBufferInfo(e,t){const i=this.getLoadPosition();return ve(i)?this.getFwdBufferInfoAtPos(e,i,t):null}getFwdBufferInfoAtPos(e,t,i){const{config:{maxBufferHole:s}}=this,r=Ze.bufferInfo(e,t,s);if(r.len===0&&r.nextStart!==void 0){const o=this.fragmentTracker.getBufferedFrag(t,i);if(o&&r.nextStart<o.end)return Ze.bufferInfo(e,t,Math.max(r.nextStart,s))}return r}getMaxBufferLength(e){const{config:t}=this;let i;return e?i=Math.max(8*t.maxBufferSize/e,t.maxBufferLength):i=t.maxBufferLength,Math.min(i,t.maxMaxBufferLength)}reduceMaxBufferLength(e,t){const i=this.config,s=Math.max(Math.min(e-t,i.maxBufferLength),t),r=Math.max(e-t*3,i.maxMaxBufferLength/2,s);return r>=s?(i.maxMaxBufferLength=r,this.warn(`Reduce max buffer length to ${r}s`),!0):!1}getAppendedFrag(e,t=we.MAIN){const i=this.fragmentTracker.getAppendedFrag(e,we.MAIN);return i&&"fragment"in i?i.fragment:i}getNextFragment(e,t){const i=t.fragments,s=i.length;if(!s)return null;const{config:r}=this,o=i[0].start;let a;if(t.live){const c=r.initialLiveManifestSize;if(s<c)return this.warn(`Not enough fragments to start playback (have: ${s}, need: ${c})`),null;(!t.PTSKnown&&!this.startFragRequested&&this.startPosition===-1||e<o)&&(a=this.getInitialLiveFragment(t,i),this.startPosition=this.nextLoadPosition=a?this.hls.liveSyncPosition||a.start:e)}else e<=o&&(a=i[0]);if(!a){const c=r.lowLatencyMode?t.partEnd:t.fragmentEnd;a=this.getFragmentAtPosition(e,c,t)}return this.mapToInitFragWhenRequired(a)}isLoopLoading(e,t){const i=this.fragmentTracker.getState(e);return(i===bt.OK||i===bt.PARTIAL&&!!e.gap)&&this.nextLoadPosition>t}getNextFragmentLoopLoading(e,t,i,s,r){const o=e.gap,a=this.getNextFragment(this.nextLoadPosition,t);if(a===null)return a;if(e=a,o&&e&&!e.gap&&i.nextStart){const c=this.getFwdBufferInfoAtPos(this.mediaBuffer?this.mediaBuffer:this.media,i.nextStart,s);if(c!==null&&i.len+c.len>=r)return this.log(`buffer full after gaps in "${s}" playlist starting at sn: ${e.sn}`),null}return e}mapToInitFragWhenRequired(e){return e!=null&&e.initSegment&&!(e!=null&&e.initSegment.data)&&!this.bitrateTest?e.initSegment:e}getNextPart(e,t,i){let s=-1,r=!1,o=!0;for(let a=0,c=e.length;a<c;a++){const l=e[a];if(o=o&&!l.independent,s>-1&&i<l.start)break;const u=l.loaded;u?s=-1:(r||l.independent||o)&&l.fragment===t&&(s=a),r=u}return s}loadedEndOfParts(e,t){const i=e[e.length-1];return i&&t>i.start&&i.loaded}getInitialLiveFragment(e,t){const i=this.fragPrevious;let s=null;if(i){if(e.hasProgramDateTime&&(this.log(`Live playlist, switching playlist, load frag with same PDT: ${i.programDateTime}`),s=G5(t,i.endProgramDateTime,this.config.maxFragLookUpTolerance)),!s){const r=i.sn+1;if(r>=e.startSN&&r<=e.endSN){const o=t[r-e.startSN];i.cc===o.cc&&(s=o,this.log(`Live playlist, switching playlist, load frag with next SN: ${s.sn}`))}s||(s=K5(t,i.cc),s&&this.log(`Live playlist, switching playlist, load frag with same CC: ${s.sn}`))}}else{const r=this.hls.liveSyncPosition;r!==null&&(s=this.getFragmentAtPosition(r,this.bitrateTest?e.fragmentEnd:e.edge,e))}return s}getFragmentAtPosition(e,t,i){const{config:s}=this;let{fragPrevious:r}=this,{fragments:o,endSN:a}=i;const{fragmentHint:c}=i,{maxFragLookUpTolerance:l}=s,u=i.partList,h=!!(s.lowLatencyMode&&u!=null&&u.length&&c);h&&c&&!this.bitrateTest&&(o=o.concat(c),a=c.sn);let f;if(e<t){const d=e>t-l?0:l;f=Ic(r,o,e,d)}else f=o[o.length-1];if(f){const d=f.sn-i.startSN,p=this.fragmentTracker.getState(f);if((p===bt.OK||p===bt.PARTIAL&&f.gap)&&(r=f),r&&f.sn===r.sn&&(!h||u[0].fragment.sn>f.sn)&&r&&f.level===r.level){const g=o[d+1];f.sn<a&&this.fragmentTracker.getState(g)!==bt.OK?f=g:f=null}}return f}synchronizeToLiveEdge(e){const{config:t,media:i}=this;if(!i)return;const s=this.hls.liveSyncPosition,r=i.currentTime,o=e.fragments[0].start,a=e.edge,c=r>=o-t.maxFragLookUpTolerance&&r<=a;if(s!==null&&i.duration>s&&(r<s||!c)){const l=t.liveMaxLatencyDuration!==void 0?t.liveMaxLatencyDuration:t.liveMaxLatencyDurationCount*e.targetduration;(!c&&i.readyState<4||r<a-l)&&(this.loadedmetadata||(this.nextLoadPosition=s),i.readyState&&(this.warn(`Playback: ${r.toFixed(3)} is located too far from the end of live sliding playlist: ${a}, reset currentTime to : ${s.toFixed(3)}`),i.currentTime=s))}}alignPlaylists(e,t,i){const s=e.fragments.length;if(!s)return this.warn("No fragments in live playlist"),0;const r=e.fragments[0].start,o=!t,a=e.alignedSliding&&ve(r);if(o||!a&&!r){const{fragPrevious:c}=this;a6(c,i,e);const l=e.fragments[0].start;return this.log(`Live playlist sliding: ${l.toFixed(2)} start-sn: ${t?t.startSN:"na"}->${e.startSN} prev-sn: ${c?c.sn:"na"} fragments: ${s}`),l}return r}waitForCdnTuneIn(e){return e.live&&e.canBlockReload&&e.partTarget&&e.tuneInGoal>Math.max(e.partHoldBack,e.partTarget*3)}setStartPosition(e,t){let i=this.startPosition;if(i<t&&(i=-1),i===-1||this.lastCurrentTime===-1){const s=this.startTimeOffset!==null,r=s?this.startTimeOffset:e.startTimeOffset;r!==null&&ve(r)?(i=t+r,r<0&&(i+=e.totalduration),i=Math.min(Math.max(t,i),t+e.totalduration),this.log(`Start time offset ${r} found in ${s?"multivariant":"media"} playlist, adjust startPosition to ${i}`),this.startPosition=i):e.live?i=this.hls.liveSyncPosition||t:this.startPosition=i=0,this.lastCurrentTime=i}this.nextLoadPosition=i}getLoadPosition(){const{media:e}=this;let t=0;return this.loadedmetadata&&e?t=e.currentTime:this.nextLoadPosition&&(t=this.nextLoadPosition),t}handleFragLoadAborted(e,t){this.transmuxer&&e.sn!=="initSegment"&&e.stats.aborted&&(this.warn(`Fragment ${e.sn}${t?" part "+t.index:""} of level ${e.level} was aborted`),this.resetFragmentLoading(e))}resetFragmentLoading(e){(!this.fragCurrent||!this.fragContextChanged(e)&&this.state!==le.FRAG_LOADING_WAITING_RETRY)&&(this.state=le.IDLE)}onFragmentOrKeyLoadError(e,t){if(t.chunkMeta&&!t.frag){const u=this.getCurrentContext(t.chunkMeta);u&&(t.frag=u.frag)}const i=t.frag;if(!i||i.type!==e||!this.levels)return;if(this.fragContextChanged(i)){var s;this.warn(`Frag load error must match current frag to retry ${i.url} > ${(s=this.fragCurrent)==null?void 0:s.url}`);return}const r=t.details===te.FRAG_GAP;r&&this.fragmentTracker.fragBuffered(i,!0);const o=t.errorAction,{action:a,retryCount:c=0,retryConfig:l}=o||{};if(o&&a===Ct.RetryRequest&&l){this.resetStartWhenNotLoaded(this.levelLastLoaded);const u=uf(l,c);this.warn(`Fragment ${i.sn} of ${e} ${i.level} errored with ${t.details}, retrying loading ${c+1}/${l.maxNumRetry} in ${u}ms`),o.resolved=!0,this.retryDate=self.performance.now()+u,this.state=le.FRAG_LOADING_WAITING_RETRY}else if(l&&o)if(this.resetFragmentErrors(e),c<l.maxNumRetry)!r&&a!==Ct.RemoveAlternatePermanently&&(o.resolved=!0);else{j.warn(`${t.details} reached or exceeded max retry (${c})`);return}else(o==null?void 0:o.action)===Ct.SendAlternateToPenaltyBox?this.state=le.WAITING_LEVEL:this.state=le.ERROR;this.tickImmediate()}reduceLengthAndFlushBuffer(e){if(this.state===le.PARSING||this.state===le.PARSED){const t=e.frag,i=e.parent,s=this.getFwdBufferInfo(this.mediaBuffer,i),r=s&&s.len>.5;r&&this.reduceMaxBufferLength(s.len,(t==null?void 0:t.duration)||10);const o=!r;return o&&this.warn(`Buffer full error while media.currentTime is not buffered, flush ${i} buffer`),t&&(this.fragmentTracker.removeFragment(t),this.nextLoadPosition=t.start),this.resetLoadingState(),o}return!1}resetFragmentErrors(e){e===we.AUDIO&&(this.fragCurrent=null),this.loadedmetadata||(this.startFragRequested=!1),this.state!==le.STOPPED&&(this.state=le.IDLE)}afterBufferFlushed(e,t,i){if(!e)return;const s=Ze.getBuffered(e);this.fragmentTracker.detectEvictedFragments(t,s,i),this.state===le.ENDED&&this.resetLoadingState()}resetLoadingState(){this.log("Reset loading state"),this.fragCurrent=null,this.fragPrevious=null,this.state=le.IDLE}resetStartWhenNotLoaded(e){if(!this.loadedmetadata){this.startFragRequested=!1;const t=e?e.details:null;t!=null&&t.live?(this.startPosition=-1,this.setStartPosition(t,0),this.resetLoadingState()):this.nextLoadPosition=this.startPosition}}resetWhenMissingContext(e){this.warn(`The loading context changed while buffering fragment ${e.sn} of level ${e.level}. This chunk will not be buffered.`),this.removeUnbufferedFrags(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState()}removeUnbufferedFrags(e=0){this.fragmentTracker.removeFragmentsInRange(e,1/0,this.playlistType,!1,!0)}updateLevelTiming(e,t,i,s){var r;const o=i.details;if(!o){this.warn("level.details undefined");return}if(!Object.keys(e.elementaryStreams).reduce((c,l)=>{const u=e.elementaryStreams[l];if(u){const h=u.endPTS-u.startPTS;if(h<=0)return this.warn(`Could not parse fragment ${e.sn} ${l} duration reliably (${h})`),c||!1;const f=s?0:tg(o,e,u.startPTS,u.endPTS,u.startDTS,u.endDTS);return this.hls.trigger(D.LEVEL_PTS_UPDATED,{details:o,level:i,drift:f,type:l,frag:e,start:u.startPTS,end:u.endPTS}),!0}return c},!1)&&((r=this.transmuxer)==null?void 0:r.error)===null){const c=new Error(`Found no media in fragment ${e.sn} of level ${e.level} resetting transmuxer to fallback to playlist timing`);if(i.fragmentError===0&&(i.fragmentError++,e.gap=!0,this.fragmentTracker.removeFragment(e),this.fragmentTracker.fragBuffered(e,!0)),this.warn(c.message),this.hls.trigger(D.ERROR,{type:_e.MEDIA_ERROR,details:te.FRAG_PARSING_ERROR,fatal:!1,error:c,frag:e,reason:`Found no media in msn ${e.sn} of level "${i.url}"`}),!this.hls)return;this.resetTransmuxer()}this.state=le.PARSED,this.hls.trigger(D.FRAG_PARSED,{frag:e,part:t})}resetTransmuxer(){this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null)}recoverWorkerError(e){e.event==="demuxerWorker"&&(this.fragmentTracker.removeAllFragments(),this.resetTransmuxer(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState())}set state(e){const t=this._state;t!==e&&(this._state=e,this.log(`${t}->${e}`))}get state(){return this._state}}class ug{constructor(){this.chunks=[],this.dataLength=0}push(e){this.chunks.push(e),this.dataLength+=e.length}flush(){const{chunks:e,dataLength:t}=this;let i;if(e.length)e.length===1?i=e[0]:i=p6(e,t);else return new Uint8Array(0);return this.reset(),i}reset(){this.chunks.length=0,this.dataLength=0}}function p6(n,e){const t=new Uint8Array(e);let i=0;for(let s=0;s<n.length;s++){const r=n[s];t.set(r,i),i+=r.length}return t}function g6(){return typeof __HLS_WORKER_BUNDLE__=="function"}function y6(){const n=new self.Blob([`var exports={};var module={exports:exports};function define(f){f()};define.amd=true;(${__HLS_WORKER_BUNDLE__.toString()})(true);`],{type:"text/javascript"}),e=self.URL.createObjectURL(n);return{worker:new self.Worker(e),objectURL:e}}function E6(n){const e=new self.URL(n,self.location.href).href;return{worker:new self.Worker(e),scriptURL:e}}function qi(n="",e=9e4){return{type:n,id:-1,pid:-1,inputTimeScale:e,sequenceNumber:-1,samples:[],dropped:0}}class ff{constructor(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null,this.lastPTS=null}resetInitSegment(e,t,i,s){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}}resetTimeStamp(e){this.initPTS=e,this.resetContiguity()}resetContiguity(){this.basePTS=null,this.lastPTS=null,this.frameIndex=0}canParse(e,t){return!1}appendFrame(e,t,i){}demux(e,t){this.cachedData&&(e=_i(this.cachedData,e),this.cachedData=null);let i=Mo(e,0),s=i?i.length:0,r;const o=this._audioTrack,a=this._id3Track,c=i?lf(i):void 0,l=e.length;for((this.basePTS===null||this.frameIndex===0&&ve(c))&&(this.basePTS=v6(c,t,this.initPTS),this.lastPTS=this.basePTS),this.lastPTS===null&&(this.lastPTS=this.basePTS),i&&i.length>0&&a.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:i,type:Si.audioId3,duration:Number.POSITIVE_INFINITY});s<l;){if(this.canParse(e,s)){const u=this.appendFrame(o,e,s);u?(this.frameIndex++,this.lastPTS=u.sample.pts,s+=u.length,r=s):s=l}else HI(e,s)?(i=Mo(e,s),a.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:i,type:Si.audioId3,duration:Number.POSITIVE_INFINITY}),s+=i.length,r=s):s++;if(s===l&&r!==l){const u=an(e,r);this.cachedData?this.cachedData=_i(this.cachedData,u):this.cachedData=u}}return{audioTrack:o,videoTrack:qi(),id3Track:a,textTrack:qi()}}demuxSampleAes(e,t,i){return Promise.reject(new Error(`[${this}] This demuxer does not support Sample-AES decryption`))}flush(e){const t=this.cachedData;return t&&(this.cachedData=null,this.demux(t,0)),{audioTrack:this._audioTrack,videoTrack:qi(),id3Track:this._id3Track,textTrack:qi()}}destroy(){}}const v6=(n,e,t)=>{if(ve(n))return n*90;const i=t?t.baseTime*9e4/t.timescale:0;return e*9e4+i};function x6(n,e,t,i){let s,r,o,a;const c=navigator.userAgent.toLowerCase(),l=i,u=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];s=((e[t+2]&192)>>>6)+1;const h=(e[t+2]&60)>>>2;if(h>u.length-1){const f=new Error(`invalid ADTS sampling index:${h}`);n.emit(D.ERROR,D.ERROR,{type:_e.MEDIA_ERROR,details:te.FRAG_PARSING_ERROR,fatal:!0,error:f,reason:f.message});return}return o=(e[t+2]&1)<<2,o|=(e[t+3]&192)>>>6,j.log(`manifest codec:${i}, ADTS type:${s}, samplingIndex:${h}`),/firefox/i.test(c)?h>=6?(s=5,a=new Array(4),r=h-3):(s=2,a=new Array(2),r=h):c.indexOf("android")!==-1?(s=2,a=new Array(2),r=h):(s=5,a=new Array(4),i&&(i.indexOf("mp4a.40.29")!==-1||i.indexOf("mp4a.40.5")!==-1)||!i&&h>=6?r=h-3:((i&&i.indexOf("mp4a.40.2")!==-1&&(h>=6&&o===1||/vivaldi/i.test(c))||!i&&o===1)&&(s=2,a=new Array(2)),r=h)),a[0]=s<<3,a[0]|=(h&14)>>1,a[1]|=(h&1)<<7,a[1]|=o<<3,s===5&&(a[1]|=(r&14)>>1,a[2]=(r&1)<<7,a[2]|=8,a[3]=0),{config:a,samplerate:u[h],channelCount:o,codec:"mp4a.40."+s,manifestCodec:l}}function hg(n,e){return n[e]===255&&(n[e+1]&246)===240}function fg(n,e){return n[e+1]&1?7:9}function df(n,e){return(n[e+3]&3)<<11|n[e+4]<<3|(n[e+5]&224)>>>5}function C6(n,e){return e+5<n.length}function wc(n,e){return e+1<n.length&&hg(n,e)}function I6(n,e){return C6(n,e)&&hg(n,e)&&df(n,e)<=n.length-e}function S6(n,e){if(wc(n,e)){const t=fg(n,e);if(e+t>=n.length)return!1;const i=df(n,e);if(i<=t)return!1;const s=e+i;return s===n.length||wc(n,s)}return!1}function dg(n,e,t,i,s){if(!n.samplerate){const r=x6(e,t,i,s);if(!r)return;n.config=r.config,n.samplerate=r.samplerate,n.channelCount=r.channelCount,n.codec=r.codec,n.manifestCodec=r.manifestCodec,j.log(`parsed codec:${n.codec}, rate:${r.samplerate}, channels:${r.channelCount}`)}}function Ag(n){return 1024*9e4/n}function w6(n,e){const t=fg(n,e);if(e+t<=n.length){const i=df(n,e)-t;if(i>0)return{headerLength:t,frameLength:i}}}function mg(n,e,t,i,s){const r=Ag(n.samplerate),o=i+s*r,a=w6(e,t);let c;if(a){const{frameLength:h,headerLength:f}=a,d=f+h,p=Math.max(0,t+d-e.length);p?(c=new Uint8Array(d-f),c.set(e.subarray(t+f,e.length),0)):c=e.subarray(t+f,t+d);const m={unit:c,pts:o};return p||n.samples.push(m),{sample:m,length:d,missing:p}}const l=e.length-t;return c=new Uint8Array(l),c.set(e.subarray(t,e.length),0),{sample:{unit:c,pts:o},length:l,missing:-1}}let Aa=null;const T6=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],B6=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],_6=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],b6=[0,1,1,4];function pg(n,e,t,i,s){if(t+24>e.length)return;const r=gg(e,t);if(r&&t+r.frameLength<=e.length){const o=r.samplesPerFrame*9e4/r.sampleRate,a=i+s*o,c={unit:e.subarray(t,t+r.frameLength),pts:a,dts:a};return n.config=[],n.channelCount=r.channelCount,n.samplerate=r.sampleRate,n.samples.push(c),{sample:c,length:r.frameLength,missing:0}}}function gg(n,e){const t=n[e+1]>>3&3,i=n[e+1]>>1&3,s=n[e+2]>>4&15,r=n[e+2]>>2&3;if(t!==1&&s!==0&&s!==15&&r!==3){const o=n[e+2]>>1&1,a=n[e+3]>>6,c=t===3?3-i:i===3?3:4,l=T6[c*14+s-1]*1e3,h=B6[(t===3?0:t===2?1:2)*3+r],f=a===3?1:2,d=_6[t][i],p=b6[i],m=d*8*p,g=Math.floor(d*l/h+o)*p;if(Aa===null){const E=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);Aa=E?parseInt(E[1]):0}return!!Aa&&Aa<=87&&i===2&&l>=224e3&&a===0&&(n[e+3]=n[e+3]|128),{sampleRate:h,channelCount:f,frameLength:g,samplesPerFrame:m}}}function Af(n,e){return n[e]===255&&(n[e+1]&224)===224&&(n[e+1]&6)!==0}function yg(n,e){return e+1<n.length&&Af(n,e)}function R6(n,e){return Af(n,e)&&4<=n.length-e}function Eg(n,e){if(e+1<n.length&&Af(n,e)){const i=gg(n,e);let s=4;i!=null&&i.frameLength&&(s=i.frameLength);const r=e+s;return r===n.length||yg(n,r)}return!1}class D6 extends ff{constructor(e,t){super(),this.observer=void 0,this.config=void 0,this.observer=e,this.config=t}resetInitSegment(e,t,i,s){super.resetInitSegment(e,t,i,s),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"aac",samples:[],manifestCodec:t,duration:s,inputTimeScale:9e4,dropped:0}}static probe(e){if(!e)return!1;const t=Mo(e,0);let i=(t==null?void 0:t.length)||0;if(Eg(e,i))return!1;for(let s=e.length;i<s;i++)if(S6(e,i))return j.log("ADTS sync word found !"),!0;return!1}canParse(e,t){return I6(e,t)}appendFrame(e,t,i){dg(e,this.observer,t,i,e.manifestCodec);const s=mg(e,t,i,this.basePTS,this.frameIndex);if(s&&s.missing===0)return s}}const M6=/\/emsg[-/]ID3/i;class L6{constructor(e,t){this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=t}resetTimeStamp(){}resetInitSegment(e,t,i,s){const r=this.videoTrack=qi("video",1),o=this.audioTrack=qi("audio",1),a=this.txtTrack=qi("text",1);if(this.id3Track=qi("id3",1),this.timeOffset=0,!(e!=null&&e.byteLength))return;const c=$p(e);if(c.video){const{id:l,timescale:u,codec:h}=c.video;r.id=l,r.timescale=a.timescale=u,r.codec=h}if(c.audio){const{id:l,timescale:u,codec:h}=c.audio;o.id=l,o.timescale=u,o.codec=h}a.id=Kp.text,r.sampleDuration=0,r.duration=o.duration=s}resetContiguity(){this.remainderData=null}static probe(e){return XI(e)}demux(e,t){this.timeOffset=t;let i=e;const s=this.videoTrack,r=this.txtTrack;if(this.config.progressive){this.remainderData&&(i=_i(this.remainderData,e));const a=o5(i);this.remainderData=a.remainder,s.samples=a.valid||new Uint8Array}else s.samples=i;const o=this.extractID3Track(s,t);return r.samples=b0(t,s),{videoTrack:s,audioTrack:this.audioTrack,id3Track:o,textTrack:this.txtTrack}}flush(){const e=this.timeOffset,t=this.videoTrack,i=this.txtTrack;t.samples=this.remainderData||new Uint8Array,this.remainderData=null;const s=this.extractID3Track(t,this.timeOffset);return i.samples=b0(e,t),{videoTrack:t,audioTrack:qi(),id3Track:s,textTrack:qi()}}extractID3Track(e,t){const i=this.id3Track;if(e.samples.length){const s=Le(e.samples,["emsg"]);s&&s.forEach(r=>{const o=l5(r);if(M6.test(o.schemeIdUri)){const a=ve(o.presentationTime)?o.presentationTime/o.timeScale:t+o.presentationTimeDelta/o.timeScale;let c=o.eventDuration===4294967295?Number.POSITIVE_INFINITY:o.eventDuration/o.timeScale;c<=.001&&(c=Number.POSITIVE_INFINITY);const l=o.payload;i.samples.push({data:l,len:l.byteLength,dts:a,pts:a,type:Si.emsg,duration:c})}})}return i}demuxSampleAes(e,t,i){return Promise.reject(new Error("The MP4 demuxer does not support SAMPLE-AES decryption"))}destroy(){}}const vg=(n,e)=>{let t=0,i=5;e+=i;const s=new Uint32Array(1),r=new Uint32Array(1),o=new Uint8Array(1);for(;i>0;){o[0]=n[e];const a=Math.min(i,8),c=8-a;r[0]=4278190080>>>24+c<<c,s[0]=(o[0]&r[0])>>c,t=t?t<<a|s[0]:s[0],e+=1,i-=a}return t};class P6 extends ff{constructor(e){super(),this.observer=void 0,this.observer=e}resetInitSegment(e,t,i,s){super.resetInitSegment(e,t,i,s),this._audioTrack={container:"audio/ac-3",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"ac3",samples:[],manifestCodec:t,duration:s,inputTimeScale:9e4,dropped:0}}canParse(e,t){return t+64<e.length}appendFrame(e,t,i){const s=xg(e,t,i,this.basePTS,this.frameIndex);if(s!==-1)return{sample:e.samples[e.samples.length-1],length:s,missing:0}}static probe(e){if(!e)return!1;const t=Mo(e,0);if(!t)return!1;const i=t.length;return e[i]===11&&e[i+1]===119&&lf(t)!==void 0&&vg(e,i)<16}}function xg(n,e,t,i,s){if(t+8>e.length||e[t]!==11||e[t+1]!==119)return-1;const r=e[t+4]>>6;if(r>=3)return-1;const a=[48e3,44100,32e3][r],c=e[t+4]&63,u=[64,69,96,64,70,96,80,87,120,80,88,120,96,104,144,96,105,144,112,121,168,112,122,168,128,139,192,128,140,192,160,174,240,160,175,240,192,208,288,192,209,288,224,243,336,224,244,336,256,278,384,256,279,384,320,348,480,320,349,480,384,417,576,384,418,576,448,487,672,448,488,672,512,557,768,512,558,768,640,696,960,640,697,960,768,835,1152,768,836,1152,896,975,1344,896,976,1344,1024,1114,1536,1024,1115,1536,1152,1253,1728,1152,1254,1728,1280,1393,1920,1280,1394,1920][c*3+r]*2;if(t+u>e.length)return-1;const h=e[t+6]>>5;let f=0;h===2?f+=2:(h&1&&h!==1&&(f+=2),h&4&&(f+=2));const d=(e[t+6]<<8|e[t+7])>>12-f&1,m=[2,1,2,3,3,4,4,5][h]+d,g=e[t+5]>>3,y=e[t+5]&7,v=new Uint8Array([r<<6|g<<1|y>>2,(y&3)<<6|h<<3|d<<2|c>>4,c<<4&224]),E=1536/a*9e4,C=i+s*E,x=e.subarray(t,t+u);return n.config=v,n.channelCount=m,n.samplerate=a,n.samples.push({unit:x,pts:C}),u}class F6{constructor(){this.VideoSample=null}createVideoSample(e,t,i,s){return{key:e,frame:!1,pts:t,dts:i,units:[],debug:s,length:0}}getLastNalUnit(e){var t;let i=this.VideoSample,s;if((!i||i.units.length===0)&&(i=e[e.length-1]),(t=i)!=null&&t.units){const r=i.units;s=r[r.length-1]}return s}pushAccessUnit(e,t){if(e.units.length&&e.frame){if(e.pts===void 0){const i=t.samples,s=i.length;if(s){const r=i[s-1];e.pts=r.pts,e.dts=r.dts}else{t.dropped++;return}}t.samples.push(e)}e.debug.length&&j.log(e.pts+"/"+e.dts+":"+e.debug)}}class iA{constructor(e){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=e,this.bytesAvailable=e.byteLength,this.word=0,this.bitsAvailable=0}loadWord(){const e=this.data,t=this.bytesAvailable,i=e.byteLength-t,s=new Uint8Array(4),r=Math.min(4,t);if(r===0)throw new Error("no bytes available");s.set(e.subarray(i,i+r)),this.word=new DataView(s.buffer).getUint32(0),this.bitsAvailable=r*8,this.bytesAvailable-=r}skipBits(e){let t;e=Math.min(e,this.bytesAvailable*8+this.bitsAvailable),this.bitsAvailable>e?(this.word<<=e,this.bitsAvailable-=e):(e-=this.bitsAvailable,t=e>>3,e-=t<<3,this.bytesAvailable-=t,this.loadWord(),this.word<<=e,this.bitsAvailable-=e)}readBits(e){let t=Math.min(this.bitsAvailable,e);const i=this.word>>>32-t;if(e>32&&j.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=t,this.bitsAvailable>0)this.word<<=t;else if(this.bytesAvailable>0)this.loadWord();else throw new Error("no bits available");return t=e-t,t>0&&this.bitsAvailable?i<<t|this.readBits(t):i}skipLZ(){let e;for(e=0;e<this.bitsAvailable;++e)if(this.word&2147483648>>>e)return this.word<<=e,this.bitsAvailable-=e,e;return this.loadWord(),e+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){const e=this.skipLZ();return this.readBits(e+1)-1}readEG(){const e=this.readUEG();return 1&e?1+e>>>1:-1*(e>>>1)}readBoolean(){return this.readBits(1)===1}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}skipScalingList(e){let t=8,i=8,s;for(let r=0;r<e;r++)i!==0&&(s=this.readEG(),i=(t+s+256)%256),t=i===0?t:i}readSPS(){let e=0,t=0,i=0,s=0,r,o,a;const c=this.readUByte.bind(this),l=this.readBits.bind(this),u=this.readUEG.bind(this),h=this.readBoolean.bind(this),f=this.skipBits.bind(this),d=this.skipEG.bind(this),p=this.skipUEG.bind(this),m=this.skipScalingList.bind(this);c();const g=c();if(l(5),f(3),c(),p(),g===100||g===110||g===122||g===244||g===44||g===83||g===86||g===118||g===128){const I=u();if(I===3&&f(1),p(),p(),f(1),h())for(o=I!==3?8:12,a=0;a<o;a++)h()&&(a<6?m(16):m(64))}p();const y=u();if(y===0)u();else if(y===1)for(f(1),d(),d(),r=u(),a=0;a<r;a++)d();p(),f(1);const v=u(),E=u(),C=l(1);C===0&&f(1),f(1),h()&&(e=u(),t=u(),i=u(),s=u());let x=[1,1];if(h()&&h())switch(c()){case 1:x=[1,1];break;case 2:x=[12,11];break;case 3:x=[10,11];break;case 4:x=[16,11];break;case 5:x=[40,33];break;case 6:x=[24,11];break;case 7:x=[20,11];break;case 8:x=[32,11];break;case 9:x=[80,33];break;case 10:x=[18,11];break;case 11:x=[15,11];break;case 12:x=[64,33];break;case 13:x=[160,99];break;case 14:x=[4,3];break;case 15:x=[3,2];break;case 16:x=[2,1];break;case 255:{x=[c()<<8|c(),c()<<8|c()];break}}return{width:Math.ceil((v+1)*16-e*2-t*2),height:(2-C)*(E+1)*16-(C?2:4)*(i+s),pixelRatio:x}}readSliceType(){return this.readUByte(),this.readUEG(),this.readUEG()}}class k6 extends F6{parseAVCPES(e,t,i,s,r){const o=this.parseAVCNALu(e,i.data);let a=this.VideoSample,c,l=!1;i.data=null,a&&o.length&&!e.audFound&&(this.pushAccessUnit(a,e),a=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts,"")),o.forEach(u=>{var h;switch(u.type){case 1:{let m=!1;c=!0;const g=u.data;if(l&&g.length>4){const y=new iA(g).readSliceType();(y===2||y===4||y===7||y===9)&&(m=!0)}if(m){var f;(f=a)!=null&&f.frame&&!a.key&&(this.pushAccessUnit(a,e),a=this.VideoSample=null)}a||(a=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts,"")),a.frame=!0,a.key=m;break}case 5:c=!0,(h=a)!=null&&h.frame&&!a.key&&(this.pushAccessUnit(a,e),a=this.VideoSample=null),a||(a=this.VideoSample=this.createVideoSample(!0,i.pts,i.dts,"")),a.key=!0,a.frame=!0;break;case 6:{c=!0,jp(u.data,1,i.pts,t.samples);break}case 7:{var d,p;c=!0,l=!0;const m=u.data,y=new iA(m).readSPS();if(!e.sps||e.width!==y.width||e.height!==y.height||((d=e.pixelRatio)==null?void 0:d[0])!==y.pixelRatio[0]||((p=e.pixelRatio)==null?void 0:p[1])!==y.pixelRatio[1]){e.width=y.width,e.height=y.height,e.pixelRatio=y.pixelRatio,e.sps=[m],e.duration=r;const v=m.subarray(1,4);let E="avc1.";for(let C=0;C<3;C++){let x=v[C].toString(16);x.length<2&&(x="0"+x),E+=x}e.codec=E}break}case 8:c=!0,e.pps=[u.data];break;case 9:c=!0,e.audFound=!0,a&&this.pushAccessUnit(a,e),a=this.VideoSample=this.createVideoSample(!1,i.pts,i.dts,"");break;case 12:c=!0;break;default:c=!1,a&&(a.debug+="unknown NAL "+u.type+" ");break}a&&c&&a.units.push(u)}),s&&a&&(this.pushAccessUnit(a,e),this.VideoSample=null)}parseAVCNALu(e,t){const i=t.byteLength;let s=e.naluState||0;const r=s,o=[];let a=0,c,l,u,h=-1,f=0;for(s===-1&&(h=0,f=t[0]&31,s=0,a=1);a<i;){if(c=t[a++],!s){s=c?0:1;continue}if(s===1){s=c?0:2;continue}if(!c)s=3;else if(c===1){if(l=a-s-1,h>=0){const d={data:t.subarray(h,l),type:f};o.push(d)}else{const d=this.getLastNalUnit(e.samples);d&&(r&&a<=4-r&&d.state&&(d.data=d.data.subarray(0,d.data.byteLength-r)),l>0&&(d.data=_i(d.data,t.subarray(0,l)),d.state=0))}a<i?(u=t[a]&31,h=a,f=u,s=0):s=-1}else s=0}if(h>=0&&s>=0){const d={data:t.subarray(h,i),type:f,state:s};o.push(d)}if(o.length===0){const d=this.getLastNalUnit(e.samples);d&&(d.data=_i(d.data,t))}return e.naluState=s,o}}class O6{constructor(e,t,i){this.keyData=void 0,this.decrypter=void 0,this.keyData=i,this.decrypter=new hf(t,{removePKCS7Padding:!1})}decryptBuffer(e){return this.decrypter.decrypt(e,this.keyData.key.buffer,this.keyData.iv.buffer)}decryptAacSample(e,t,i){const s=e[t].unit;if(s.length<=16)return;const r=s.subarray(16,s.length-s.length%16),o=r.buffer.slice(r.byteOffset,r.byteOffset+r.length);this.decryptBuffer(o).then(a=>{const c=new Uint8Array(a);s.set(c,16),this.decrypter.isSync()||this.decryptAacSamples(e,t+1,i)})}decryptAacSamples(e,t,i){for(;;t++){if(t>=e.length){i();return}if(!(e[t].unit.length<32)&&(this.decryptAacSample(e,t,i),!this.decrypter.isSync()))return}}getAvcEncryptedData(e){const t=Math.floor((e.length-48)/160)*16+16,i=new Int8Array(t);let s=0;for(let r=32;r<e.length-16;r+=160,s+=16)i.set(e.subarray(r,r+16),s);return i}getAvcDecryptedUnit(e,t){const i=new Uint8Array(t);let s=0;for(let r=32;r<e.length-16;r+=160,s+=16)e.set(i.subarray(s,s+16),r);return e}decryptAvcSample(e,t,i,s,r){const o=Jp(r.data),a=this.getAvcEncryptedData(o);this.decryptBuffer(a.buffer).then(c=>{r.data=this.getAvcDecryptedUnit(o,c),this.decrypter.isSync()||this.decryptAvcSamples(e,t,i+1,s)})}decryptAvcSamples(e,t,i,s){if(e instanceof Uint8Array)throw new Error("Cannot decrypt samples of type Uint8Array");for(;;t++,i=0){if(t>=e.length){s();return}const r=e[t].units;for(;!(i>=r.length);i++){const o=r[i];if(!(o.data.length<=48||o.type!==1&&o.type!==5)&&(this.decryptAvcSample(e,t,i,s,o),!this.decrypter.isSync()))return}}}}const _t=188;class ks{constructor(e,t,i){this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._duration=0,this._pmtId=-1,this._videoTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.remainderData=null,this.videoParser=void 0,this.observer=e,this.config=t,this.typeSupported=i,this.videoParser=new k6}static probe(e){const t=ks.syncOffset(e);return t>0&&j.warn(`MPEG2-TS detected but first sync word found @ offset ${t}`),t!==-1}static syncOffset(e){const t=e.length;let i=Math.min(_t*5,t-_t)+1,s=0;for(;s<i;){let r=!1,o=-1,a=0;for(let c=s;c<t;c+=_t)if(e[c]===71&&(t-c===_t||e[c+_t]===71)){if(a++,o===-1&&(o=c,o!==0&&(i=Math.min(o+_t*99,e.length-_t)+1)),r||(r=Ah(e,c)===0),r&&a>1&&(o===0&&a>2||c+_t>i))return o}else{if(a)return-1;break}s++}return-1}static createTrack(e,t){return{container:e==="video"||e==="audio"?"video/mp2t":void 0,type:e,id:Kp[e],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:e==="audio"?t:void 0}}resetInitSegment(e,t,i,s){this.pmtParsed=!1,this._pmtId=-1,this._videoTrack=ks.createTrack("video"),this._audioTrack=ks.createTrack("audio",s),this._id3Track=ks.createTrack("id3"),this._txtTrack=ks.createTrack("text"),this._audioTrack.segmentCodec="aac",this.aacOverFlow=null,this.remainderData=null,this.audioCodec=t,this.videoCodec=i,this._duration=s}resetTimeStamp(){}resetContiguity(){const{_audioTrack:e,_videoTrack:t,_id3Track:i}=this;e&&(e.pesData=null),t&&(t.pesData=null),i&&(i.pesData=null),this.aacOverFlow=null,this.remainderData=null}demux(e,t,i=!1,s=!1){i||(this.sampleAes=null);let r;const o=this._videoTrack,a=this._audioTrack,c=this._id3Track,l=this._txtTrack;let u=o.pid,h=o.pesData,f=a.pid,d=c.pid,p=a.pesData,m=c.pesData,g=null,y=this.pmtParsed,v=this._pmtId,E=e.length;if(this.remainderData&&(e=_i(this.remainderData,e),E=e.length,this.remainderData=null),E<_t&&!s)return this.remainderData=e,{audioTrack:a,videoTrack:o,id3Track:c,textTrack:l};const C=Math.max(0,ks.syncOffset(e));E-=(E-C)%_t,E<e.byteLength&&!s&&(this.remainderData=new Uint8Array(e.buffer,E,e.buffer.byteLength-E));let x=0;for(let S=C;S<E;S+=_t)if(e[S]===71){const w=!!(e[S+1]&64),B=Ah(e,S),T=(e[S+3]&48)>>4;let R;if(T>1){if(R=S+5+e[S+4],R===S+_t)continue}else R=S+4;switch(B){case u:w&&(h&&(r=Fn(h))&&this.videoParser.parseAVCPES(o,l,r,!1,this._duration),h={data:[],size:0}),h&&(h.data.push(e.subarray(R,S+_t)),h.size+=S+_t-R);break;case f:if(w){if(p&&(r=Fn(p)))switch(a.segmentCodec){case"aac":this.parseAACPES(a,r);break;case"mp3":this.parseMPEGPES(a,r);break;case"ac3":this.parseAC3PES(a,r);break}p={data:[],size:0}}p&&(p.data.push(e.subarray(R,S+_t)),p.size+=S+_t-R);break;case d:w&&(m&&(r=Fn(m))&&this.parseID3PES(c,r),m={data:[],size:0}),m&&(m.data.push(e.subarray(R,S+_t)),m.size+=S+_t-R);break;case 0:w&&(R+=e[R]+1),v=this._pmtId=U6(e,R);break;case v:{w&&(R+=e[R]+1);const _=Q6(e,R,this.typeSupported,i,this.observer);u=_.videoPid,u>0&&(o.pid=u,o.segmentCodec=_.segmentVideoCodec),f=_.audioPid,f>0&&(a.pid=f,a.segmentCodec=_.segmentAudioCodec),d=_.id3Pid,d>0&&(c.pid=d),g!==null&&!y&&(j.warn(`MPEG-TS PMT found at ${S} after unknown PID '${g}'. Backtracking to sync byte @${C} to parse all TS packets.`),g=null,S=C-188),y=this.pmtParsed=!0;break}case 17:case 8191:break;default:g=B;break}}else x++;x>0&&Tc(this.observer,new Error(`Found ${x} TS packet/s that do not start with 0x47`)),o.pesData=h,a.pesData=p,c.pesData=m;const I={audioTrack:a,videoTrack:o,id3Track:c,textTrack:l};return s&&this.extractRemainingSamples(I),I}flush(){const{remainderData:e}=this;this.remainderData=null;let t;return e?t=this.demux(e,-1,!1,!0):t={videoTrack:this._videoTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack},this.extractRemainingSamples(t),this.sampleAes?this.decrypt(t,this.sampleAes):t}extractRemainingSamples(e){const{audioTrack:t,videoTrack:i,id3Track:s,textTrack:r}=e,o=i.pesData,a=t.pesData,c=s.pesData;let l;if(o&&(l=Fn(o))?(this.videoParser.parseAVCPES(i,r,l,!0,this._duration),i.pesData=null):i.pesData=o,a&&(l=Fn(a))){switch(t.segmentCodec){case"aac":this.parseAACPES(t,l);break;case"mp3":this.parseMPEGPES(t,l);break;case"ac3":this.parseAC3PES(t,l);break}t.pesData=null}else a!=null&&a.size&&j.log("last AAC PES packet truncated,might overlap between fragments"),t.pesData=a;c&&(l=Fn(c))?(this.parseID3PES(s,l),s.pesData=null):s.pesData=c}demuxSampleAes(e,t,i){const s=this.demux(e,i,!0,!this.config.progressive),r=this.sampleAes=new O6(this.observer,this.config,t);return this.decrypt(s,r)}decrypt(e,t){return new Promise(i=>{const{audioTrack:s,videoTrack:r}=e;s.samples&&s.segmentCodec==="aac"?t.decryptAacSamples(s.samples,0,()=>{r.samples?t.decryptAvcSamples(r.samples,0,0,()=>{i(e)}):i(e)}):r.samples&&t.decryptAvcSamples(r.samples,0,0,()=>{i(e)})})}destroy(){this._duration=0}parseAACPES(e,t){let i=0;const s=this.aacOverFlow;let r=t.data;if(s){this.aacOverFlow=null;const h=s.missing,f=s.sample.unit.byteLength;if(h===-1)r=_i(s.sample.unit,r);else{const d=f-h;s.sample.unit.set(r.subarray(0,h),d),e.samples.push(s.sample),i=s.missing}}let o,a;for(o=i,a=r.length;o<a-1&&!wc(r,o);o++);if(o!==i){let h;const f=o<a-1;if(f?h=`AAC PES did not start with ADTS header,offset:${o}`:h="No ADTS header found in AAC PES",Tc(this.observer,new Error(h),f),!f)return}dg(e,this.observer,r,o,this.audioCodec);let c;if(t.pts!==void 0)c=t.pts;else if(s){const h=Ag(e.samplerate);c=s.sample.pts+h}else{j.warn("[tsdemuxer]: AAC PES unknown PTS");return}let l=0,u;for(;o<a;)if(u=mg(e,r,o,c,l),o+=u.length,u.missing){this.aacOverFlow=u;break}else for(l++;o<a-1&&!wc(r,o);o++);}parseMPEGPES(e,t){const i=t.data,s=i.length;let r=0,o=0;const a=t.pts;if(a===void 0){j.warn("[tsdemuxer]: MPEG PES unknown PTS");return}for(;o<s;)if(yg(i,o)){const c=pg(e,i,o,a,r);if(c)o+=c.length,r++;else break}else o++}parseAC3PES(e,t){{const i=t.data,s=t.pts;if(s===void 0){j.warn("[tsdemuxer]: AC3 PES unknown PTS");return}const r=i.length;let o=0,a=0,c;for(;a<r&&(c=xg(e,i,a,s,o++))>0;)a+=c}}parseID3PES(e,t){if(t.pts===void 0){j.warn("[tsdemuxer]: ID3 PES unknown PTS");return}const i=pt({},t,{type:this._videoTrack?Si.emsg:Si.audioId3,duration:Number.POSITIVE_INFINITY});e.samples.push(i)}}function Ah(n,e){return((n[e+1]&31)<<8)+n[e+2]}function U6(n,e){return(n[e+10]&31)<<8|n[e+11]}function Q6(n,e,t,i,s){const r={audioPid:-1,videoPid:-1,id3Pid:-1,segmentVideoCodec:"avc",segmentAudioCodec:"aac"},o=(n[e+1]&15)<<8|n[e+2],a=e+3+o-4,c=(n[e+10]&15)<<8|n[e+11];for(e+=12+c;e<a;){const l=Ah(n,e),u=(n[e+3]&15)<<8|n[e+4];switch(n[e]){case 207:if(!i){Jl("ADTS AAC");break}case 15:r.audioPid===-1&&(r.audioPid=l);break;case 21:r.id3Pid===-1&&(r.id3Pid=l);break;case 219:if(!i){Jl("H.264");break}case 27:r.videoPid===-1&&(r.videoPid=l,r.segmentVideoCodec="avc");break;case 3:case 4:!t.mpeg&&!t.mp3?j.log("MPEG audio found, not supported in this browser"):r.audioPid===-1&&(r.audioPid=l,r.segmentAudioCodec="mp3");break;case 193:if(!i){Jl("AC-3");break}case 129:t.ac3?r.audioPid===-1&&(r.audioPid=l,r.segmentAudioCodec="ac3"):j.log("AC-3 audio found, not supported in this browser");break;case 6:if(r.audioPid===-1&&u>0){let h=e+5,f=u;for(;f>2;){switch(n[h]){case 106:t.ac3!==!0?j.log("AC-3 audio found, not supported in this browser for now"):(r.audioPid=l,r.segmentAudioCodec="ac3");break}const p=n[h+1]+2;h+=p,f-=p}}break;case 194:case 135:return Tc(s,new Error("Unsupported EC-3 in M2TS found")),r;case 36:return Tc(s,new Error("Unsupported HEVC in M2TS found")),r}e+=u+5}return r}function Tc(n,e,t){j.warn(`parsing error: ${e.message}`),n.emit(D.ERROR,D.ERROR,{type:_e.MEDIA_ERROR,details:te.FRAG_PARSING_ERROR,fatal:!1,levelRetry:t,error:e,reason:e.message})}function Jl(n){j.log(`${n} with AES-128-CBC encryption found in unencrypted stream`)}function Fn(n){let e=0,t,i,s,r,o;const a=n.data;if(!n||n.size===0)return null;for(;a[0].length<19&&a.length>1;)a[0]=_i(a[0],a[1]),a.splice(1,1);if(t=a[0],(t[0]<<16)+(t[1]<<8)+t[2]===1){if(i=(t[4]<<8)+t[5],i&&i>n.size-6)return null;const l=t[7];l&192&&(r=(t[9]&14)*536870912+(t[10]&255)*4194304+(t[11]&254)*16384+(t[12]&255)*128+(t[13]&254)/2,l&64?(o=(t[14]&14)*536870912+(t[15]&255)*4194304+(t[16]&254)*16384+(t[17]&255)*128+(t[18]&254)/2,r-o>60*9e4&&(j.warn(`${Math.round((r-o)/9e4)}s delta between PTS and DTS, align them`),r=o)):o=r),s=t[8];let u=s+9;if(n.size<=u)return null;n.size-=u;const h=new Uint8Array(n.size);for(let f=0,d=a.length;f<d;f++){t=a[f];let p=t.byteLength;if(u)if(u>p){u-=p;continue}else t=t.subarray(u),p-=u,u=0;h.set(t,e),e+=p}return i&&(i-=s+3),{data:h,pts:r,dts:o,len:i}}return null}class N6 extends ff{resetInitSegment(e,t,i,s){super.resetInitSegment(e,t,i,s),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"mp3",samples:[],manifestCodec:t,duration:s,inputTimeScale:9e4,dropped:0}}static probe(e){if(!e)return!1;const t=Mo(e,0);let i=(t==null?void 0:t.length)||0;if(t&&e[i]===11&&e[i+1]===119&&lf(t)!==void 0&&vg(e,i)<=16)return!1;for(let s=e.length;i<s;i++)if(Eg(e,i))return j.log("MPEG Audio sync word found !"),!0;return!1}canParse(e,t){return R6(e,t)}appendFrame(e,t,i){if(this.basePTS!==null)return pg(e,t,i,this.basePTS,this.frameIndex)}}class sA{static getSilentFrame(e,t){switch(e){case"mp4a.40.2":if(t===1)return new Uint8Array([0,200,0,128,35,128]);if(t===2)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(t===3)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(t===4)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);if(t===5)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);if(t===6)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224]);break;default:if(t===1)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(t===2)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(t===3)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);break}}}const Ds=Math.pow(2,32)-1;class X{static init(){X.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],dac3:[],"ac-3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]};let e;for(e in X.types)X.types.hasOwnProperty(e)&&(X.types[e]=[e.charCodeAt(0),e.charCodeAt(1),e.charCodeAt(2),e.charCodeAt(3)]);const t=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),i=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);X.HDLR_TYPES={video:t,audio:i};const s=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),r=new Uint8Array([0,0,0,0,0,0,0,0]);X.STTS=X.STSC=X.STCO=r,X.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),X.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),X.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),X.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);const o=new Uint8Array([105,115,111,109]),a=new Uint8Array([97,118,99,49]),c=new Uint8Array([0,0,0,1]);X.FTYP=X.box(X.types.ftyp,o,c,o,a),X.DINF=X.box(X.types.dinf,X.box(X.types.dref,s))}static box(e,...t){let i=8,s=t.length;const r=s;for(;s--;)i+=t[s].byteLength;const o=new Uint8Array(i);for(o[0]=i>>24&255,o[1]=i>>16&255,o[2]=i>>8&255,o[3]=i&255,o.set(e,4),s=0,i=8;s<r;s++)o.set(t[s],i),i+=t[s].byteLength;return o}static hdlr(e){return X.box(X.types.hdlr,X.HDLR_TYPES[e])}static mdat(e){return X.box(X.types.mdat,e)}static mdhd(e,t){t*=e;const i=Math.floor(t/(Ds+1)),s=Math.floor(t%(Ds+1));return X.box(X.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,e&255,i>>24,i>>16&255,i>>8&255,i&255,s>>24,s>>16&255,s>>8&255,s&255,85,196,0,0]))}static mdia(e){return X.box(X.types.mdia,X.mdhd(e.timescale,e.duration),X.hdlr(e.type),X.minf(e))}static mfhd(e){return X.box(X.types.mfhd,new Uint8Array([0,0,0,0,e>>24,e>>16&255,e>>8&255,e&255]))}static minf(e){return e.type==="audio"?X.box(X.types.minf,X.box(X.types.smhd,X.SMHD),X.DINF,X.stbl(e)):X.box(X.types.minf,X.box(X.types.vmhd,X.VMHD),X.DINF,X.stbl(e))}static moof(e,t,i){return X.box(X.types.moof,X.mfhd(e),X.traf(i,t))}static moov(e){let t=e.length;const i=[];for(;t--;)i[t]=X.trak(e[t]);return X.box.apply(null,[X.types.moov,X.mvhd(e[0].timescale,e[0].duration)].concat(i).concat(X.mvex(e)))}static mvex(e){let t=e.length;const i=[];for(;t--;)i[t]=X.trex(e[t]);return X.box.apply(null,[X.types.mvex,...i])}static mvhd(e,t){t*=e;const i=Math.floor(t/(Ds+1)),s=Math.floor(t%(Ds+1)),r=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,e>>24&255,e>>16&255,e>>8&255,e&255,i>>24,i>>16&255,i>>8&255,i&255,s>>24,s>>16&255,s>>8&255,s&255,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return X.box(X.types.mvhd,r)}static sdtp(e){const t=e.samples||[],i=new Uint8Array(4+t.length);let s,r;for(s=0;s<t.length;s++)r=t[s].flags,i[s+4]=r.dependsOn<<4|r.isDependedOn<<2|r.hasRedundancy;return X.box(X.types.sdtp,i)}static stbl(e){return X.box(X.types.stbl,X.stsd(e),X.box(X.types.stts,X.STTS),X.box(X.types.stsc,X.STSC),X.box(X.types.stsz,X.STSZ),X.box(X.types.stco,X.STCO))}static avc1(e){let t=[],i=[],s,r,o;for(s=0;s<e.sps.length;s++)r=e.sps[s],o=r.byteLength,t.push(o>>>8&255),t.push(o&255),t=t.concat(Array.prototype.slice.call(r));for(s=0;s<e.pps.length;s++)r=e.pps[s],o=r.byteLength,i.push(o>>>8&255),i.push(o&255),i=i.concat(Array.prototype.slice.call(r));const a=X.box(X.types.avcC,new Uint8Array([1,t[3],t[4],t[5],255,224|e.sps.length].concat(t).concat([e.pps.length]).concat(i))),c=e.width,l=e.height,u=e.pixelRatio[0],h=e.pixelRatio[1];return X.box(X.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,c>>8&255,c&255,l>>8&255,l&255,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),a,X.box(X.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),X.box(X.types.pasp,new Uint8Array([u>>24,u>>16&255,u>>8&255,u&255,h>>24,h>>16&255,h>>8&255,h&255])))}static esds(e){const t=e.config.length;return new Uint8Array([0,0,0,0,3,23+t,0,1,0,4,15+t,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([t]).concat(e.config).concat([6,1,2]))}static audioStsd(e){const t=e.samplerate;return new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,e.channelCount,0,16,0,0,0,0,t>>8&255,t&255,0,0])}static mp4a(e){return X.box(X.types.mp4a,X.audioStsd(e),X.box(X.types.esds,X.esds(e)))}static mp3(e){return X.box(X.types[".mp3"],X.audioStsd(e))}static ac3(e){return X.box(X.types["ac-3"],X.audioStsd(e),X.box(X.types.dac3,e.config))}static stsd(e){return e.type==="audio"?e.segmentCodec==="mp3"&&e.codec==="mp3"?X.box(X.types.stsd,X.STSD,X.mp3(e)):e.segmentCodec==="ac3"?X.box(X.types.stsd,X.STSD,X.ac3(e)):X.box(X.types.stsd,X.STSD,X.mp4a(e)):X.box(X.types.stsd,X.STSD,X.avc1(e))}static tkhd(e){const t=e.id,i=e.duration*e.timescale,s=e.width,r=e.height,o=Math.floor(i/(Ds+1)),a=Math.floor(i%(Ds+1));return X.box(X.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,t>>24&255,t>>16&255,t>>8&255,t&255,0,0,0,0,o>>24,o>>16&255,o>>8&255,o&255,a>>24,a>>16&255,a>>8&255,a&255,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,s>>8&255,s&255,0,0,r>>8&255,r&255,0,0]))}static traf(e,t){const i=X.sdtp(e),s=e.id,r=Math.floor(t/(Ds+1)),o=Math.floor(t%(Ds+1));return X.box(X.types.traf,X.box(X.types.tfhd,new Uint8Array([0,0,0,0,s>>24,s>>16&255,s>>8&255,s&255])),X.box(X.types.tfdt,new Uint8Array([1,0,0,0,r>>24,r>>16&255,r>>8&255,r&255,o>>24,o>>16&255,o>>8&255,o&255])),X.trun(e,i.length+16+20+8+16+8+8),i)}static trak(e){return e.duration=e.duration||4294967295,X.box(X.types.trak,X.tkhd(e),X.mdia(e))}static trex(e){const t=e.id;return X.box(X.types.trex,new Uint8Array([0,0,0,0,t>>24,t>>16&255,t>>8&255,t&255,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(e,t){const i=e.samples||[],s=i.length,r=12+16*s,o=new Uint8Array(r);let a,c,l,u,h,f;for(t+=8+r,o.set([e.type==="video"?1:0,0,15,1,s>>>24&255,s>>>16&255,s>>>8&255,s&255,t>>>24&255,t>>>16&255,t>>>8&255,t&255],0),a=0;a<s;a++)c=i[a],l=c.duration,u=c.size,h=c.flags,f=c.cts,o.set([l>>>24&255,l>>>16&255,l>>>8&255,l&255,u>>>24&255,u>>>16&255,u>>>8&255,u&255,h.isLeading<<2|h.dependsOn,h.isDependedOn<<6|h.hasRedundancy<<4|h.paddingValue<<1|h.isNonSync,h.degradPrio&61440,h.degradPrio&15,f>>>24&255,f>>>16&255,f>>>8&255,f&255],12+16*a);return X.box(X.types.trun,o)}static initSegment(e){X.types||X.init();const t=X.moov(e);return _i(X.FTYP,t)}}X.types=void 0;X.HDLR_TYPES=void 0;X.STTS=void 0;X.STSC=void 0;X.STCO=void 0;X.STSZ=void 0;X.VMHD=void 0;X.SMHD=void 0;X.STSD=void 0;X.FTYP=void 0;X.DINF=void 0;const Cg=9e4;function mf(n,e,t=1,i=!1){const s=n*e*t;return i?Math.round(s):s}function G6(n,e,t=1,i=!1){return mf(n,e,1/t,i)}function Zr(n,e=!1){return mf(n,1e3,1/Cg,e)}function z6(n,e=1){return mf(n,Cg,1/e)}const H6=10*1e3,nA=1024,K6=1152,V6=1536;let kn=null,ql=null;class ec{constructor(e,t,i,s=""){if(this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=null,this._initDTS=null,this.nextAvcDts=null,this.nextAudioPts=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.videoTrackConfig=void 0,this.observer=e,this.config=t,this.typeSupported=i,this.ISGenerated=!1,kn===null){const o=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);kn=o?parseInt(o[1]):0}if(ql===null){const r=navigator.userAgent.match(/Safari\/(\d+)/i);ql=r?parseInt(r[1]):0}}destroy(){this.config=this.videoTrackConfig=this._initPTS=this._initDTS=null}resetTimeStamp(e){j.log("[mp4-remuxer]: initPTS & initDTS reset"),this._initPTS=this._initDTS=e}resetNextTimestamp(){j.log("[mp4-remuxer]: reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1}resetInitSegment(){j.log("[mp4-remuxer]: ISGenerated flag reset"),this.ISGenerated=!1,this.videoTrackConfig=void 0}getVideoStartPts(e){let t=!1;const i=e.reduce((s,r)=>{const o=r.pts-s;return o<-4294967296?(t=!0,xi(s,r.pts)):o>0?s:r.pts},e[0].pts);return t&&j.debug("PTS rollover detected"),i}remux(e,t,i,s,r,o,a,c){let l,u,h,f,d,p,m=r,g=r;const y=e.pid>-1,v=t.pid>-1,E=t.samples.length,C=e.samples.length>0,x=a&&E>0||E>1;if((!y||C)&&(!v||x)||this.ISGenerated||a){if(this.ISGenerated){var S,w,B,T;const O=this.videoTrackConfig;O&&(t.width!==O.width||t.height!==O.height||((S=t.pixelRatio)==null?void 0:S[0])!==((w=O.pixelRatio)==null?void 0:w[0])||((B=t.pixelRatio)==null?void 0:B[1])!==((T=O.pixelRatio)==null?void 0:T[1]))&&this.resetInitSegment()}else h=this.generateIS(e,t,r,o);const R=this.isVideoContiguous;let _=-1,L;if(x&&(_=Y6(t.samples),!R&&this.config.forceKeyFrameOnDiscontinuity))if(p=!0,_>0){j.warn(`[mp4-remuxer]: Dropped ${_} out of ${E} video samples due to a missing keyframe`);const O=this.getVideoStartPts(t.samples);t.samples=t.samples.slice(_),t.dropped+=_,g+=(t.samples[0].pts-O)/t.inputTimeScale,L=g}else _===-1&&(j.warn(`[mp4-remuxer]: No keyframe found out of ${E} video samples`),p=!1);if(this.ISGenerated){if(C&&x){const O=this.getVideoStartPts(t.samples),Q=(xi(e.samples[0].pts,O)-O)/t.inputTimeScale;m+=Math.max(0,Q),g+=Math.max(0,-Q)}if(C){if(e.samplerate||(j.warn("[mp4-remuxer]: regenerate InitSegment as audio detected"),h=this.generateIS(e,t,r,o)),u=this.remuxAudio(e,m,this.isAudioContiguous,o,v||x||c===we.AUDIO?g:void 0),x){const O=u?u.endPTS-u.startPTS:0;t.inputTimeScale||(j.warn("[mp4-remuxer]: regenerate InitSegment as video detected"),h=this.generateIS(e,t,r,o)),l=this.remuxVideo(t,g,R,O)}}else x&&(l=this.remuxVideo(t,g,R,0));l&&(l.firstKeyFrame=_,l.independent=_!==-1,l.firstKeyFramePTS=L)}}return this.ISGenerated&&this._initPTS&&this._initDTS&&(i.samples.length&&(d=Ig(i,r,this._initPTS,this._initDTS)),s.samples.length&&(f=Sg(s,r,this._initPTS))),{audio:u,video:l,initSegment:h,independent:p,text:f,id3:d}}generateIS(e,t,i,s){const r=e.samples,o=t.samples,a=this.typeSupported,c={},l=this._initPTS;let u=!l||s,h="audio/mp4",f,d,p;if(u&&(f=d=1/0),e.config&&r.length){switch(e.timescale=e.samplerate,e.segmentCodec){case"mp3":a.mpeg?(h="audio/mpeg",e.codec=""):a.mp3&&(e.codec="mp3");break;case"ac3":e.codec="ac-3";break}c.audio={id:"audio",container:h,codec:e.codec,initSegment:e.segmentCodec==="mp3"&&a.mpeg?new Uint8Array(0):X.initSegment([e]),metadata:{channelCount:e.channelCount}},u&&(p=e.inputTimeScale,!l||p!==l.timescale?f=d=r[0].pts-Math.round(p*i):u=!1)}if(t.sps&&t.pps&&o.length){if(t.timescale=t.inputTimeScale,c.video={id:"main",container:"video/mp4",codec:t.codec,initSegment:X.initSegment([t]),metadata:{width:t.width,height:t.height}},u)if(p=t.inputTimeScale,!l||p!==l.timescale){const m=this.getVideoStartPts(o),g=Math.round(p*i);d=Math.min(d,xi(o[0].dts,m)-g),f=Math.min(f,m-g)}else u=!1;this.videoTrackConfig={width:t.width,height:t.height,pixelRatio:t.pixelRatio}}if(Object.keys(c).length)return this.ISGenerated=!0,u?(this._initPTS={baseTime:f,timescale:p},this._initDTS={baseTime:d,timescale:p}):f=p=void 0,{tracks:c,initPTS:f,timescale:p}}remuxVideo(e,t,i,s){const r=e.inputTimeScale,o=e.samples,a=[],c=o.length,l=this._initPTS;let u=this.nextAvcDts,h=8,f=this.videoSampleDuration,d,p,m=Number.POSITIVE_INFINITY,g=Number.NEGATIVE_INFINITY,y=!1;if(!i||u===null){const H=t*r,N=o[0].pts-xi(o[0].dts,o[0].pts);kn&&u!==null&&Math.abs(H-N-u)<15e3?i=!0:u=H-N}const v=l.baseTime*r/l.timescale;for(let H=0;H<c;H++){const N=o[H];N.pts=xi(N.pts-v,u),N.dts=xi(N.dts-v,u),N.dts<o[H>0?H-1:H].dts&&(y=!0)}y&&o.sort(function(H,N){const V=H.dts-N.dts,$=H.pts-N.pts;return V||$}),d=o[0].dts,p=o[o.length-1].dts;const E=p-d,C=E?Math.round(E/(c-1)):f||e.inputTimeScale/30;if(i){const H=d-u,N=H>C,V=H<-1;if((N||V)&&(N?j.warn(`AVC: ${Zr(H,!0)} ms (${H}dts) hole between fragments detected at ${t.toFixed(3)}`):j.warn(`AVC: ${Zr(-H,!0)} ms (${H}dts) overlapping between fragments detected at ${t.toFixed(3)}`),!V||u>=o[0].pts||kn)){d=u;const $=o[0].pts-H;if(N)o[0].dts=d,o[0].pts=$;else for(let Y=0;Y<o.length&&!(o[Y].dts>$);Y++)o[Y].dts-=H,o[Y].pts-=H;j.log(`Video: Initial PTS/DTS adjusted: ${Zr($,!0)}/${Zr(d,!0)}, delta: ${Zr(H,!0)} ms`)}}d=Math.max(0,d);let x=0,I=0,S=d;for(let H=0;H<c;H++){const N=o[H],V=N.units,$=V.length;let Y=0;for(let M=0;M<$;M++)Y+=V[M].data.length;I+=Y,x+=$,N.length=Y,N.dts<S?(N.dts=S,S+=C/4|0||1):S=N.dts,m=Math.min(N.pts,m),g=Math.max(N.pts,g)}p=o[c-1].dts;const w=I+4*x+8;let B;try{B=new Uint8Array(w)}catch(H){this.observer.emit(D.ERROR,D.ERROR,{type:_e.MUX_ERROR,details:te.REMUX_ALLOC_ERROR,fatal:!1,error:H,bytes:w,reason:`fail allocating video mdat ${w}`});return}const T=new DataView(B.buffer);T.setUint32(0,w),B.set(X.types.mdat,4);let R=!1,_=Number.POSITIVE_INFINITY,L=Number.POSITIVE_INFINITY,O=Number.NEGATIVE_INFINITY,U=Number.NEGATIVE_INFINITY;for(let H=0;H<c;H++){const N=o[H],V=N.units;let $=0;for(let k=0,P=V.length;k<P;k++){const F=V[k],J=F.data,se=F.data.byteLength;T.setUint32(h,se),h+=4,B.set(J,h),h+=se,$+=4+se}let Y;if(H<c-1)f=o[H+1].dts-N.dts,Y=o[H+1].pts-N.pts;else{const k=this.config,P=H>0?N.dts-o[H-1].dts:C;if(Y=H>0?N.pts-o[H-1].pts:C,k.stretchShortVideoTrack&&this.nextAudioPts!==null){const F=Math.floor(k.maxBufferHole*r),J=(s?m+s*r:this.nextAudioPts)-N.pts;J>F?(f=J-P,f<0?f=P:R=!0,j.log(`[mp4-remuxer]: It is approximately ${J/90} ms to the next segment; using duration ${f/90} ms for the last video frame.`)):f=P}else f=P}const M=Math.round(N.pts-N.dts);_=Math.min(_,f),O=Math.max(O,f),L=Math.min(L,Y),U=Math.max(U,Y),a.push(new rA(N.key,f,$,M))}if(a.length){if(kn){if(kn<70){const H=a[0].flags;H.dependsOn=2,H.isNonSync=0}}else if(ql&&U-L<O-_&&C/O<.025&&a[0].cts===0){j.warn("Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.");let H=d;for(let N=0,V=a.length;N<V;N++){const $=H+a[N].duration,Y=H+a[N].cts;if(N<V-1){const M=$+a[N+1].cts;a[N].duration=M-Y}else a[N].duration=N?a[N-1].duration:C;a[N].cts=0,H=$}}}f=R||!f?C:f,this.nextAvcDts=u=p+f,this.videoSampleDuration=f,this.isVideoContiguous=!0;const z={data1:X.moof(e.sequenceNumber++,d,pt({},e,{samples:a})),data2:B,startPTS:m/r,endPTS:(g+f)/r,startDTS:d/r,endDTS:u/r,type:"video",hasAudio:!1,hasVideo:!0,nb:a.length,dropped:e.dropped};return e.samples=[],e.dropped=0,z}getSamplesPerFrame(e){switch(e.segmentCodec){case"mp3":return K6;case"ac3":return V6;default:return nA}}remuxAudio(e,t,i,s,r){const o=e.inputTimeScale,a=e.samplerate?e.samplerate:o,c=o/a,l=this.getSamplesPerFrame(e),u=l*c,h=this._initPTS,f=e.segmentCodec==="mp3"&&this.typeSupported.mpeg,d=[],p=r!==void 0;let m=e.samples,g=f?0:8,y=this.nextAudioPts||-1;const v=t*o,E=h.baseTime*o/h.timescale;if(this.isAudioContiguous=i=i||m.length&&y>0&&(s&&Math.abs(v-y)<9e3||Math.abs(xi(m[0].pts-E,v)-y)<20*u),m.forEach(function(Q){Q.pts=xi(Q.pts-E,v)}),!i||y<0){if(m=m.filter(Q=>Q.pts>=0),!m.length)return;r===0?y=0:s&&!p?y=Math.max(0,v):y=m[0].pts}if(e.segmentCodec==="aac"){const Q=this.config.maxAudioFramesDrift;for(let G=0,z=y;G<m.length;G++){const H=m[G],N=H.pts,V=N-z,$=Math.abs(1e3*V/o);if(V<=-Q*u&&p)G===0&&(j.warn(`Audio frame @ ${(N/o).toFixed(3)}s overlaps nextAudioPts by ${Math.round(1e3*V/o)} ms.`),this.nextAudioPts=y=z=N);else if(V>=Q*u&&$<H6&&p){let Y=Math.round(V/u);z=N-Y*u,z<0&&(Y--,z+=u),G===0&&(this.nextAudioPts=y=z),j.warn(`[mp4-remuxer]: Injecting ${Y} audio frame @ ${(z/o).toFixed(3)}s due to ${Math.round(1e3*V/o)} ms gap.`);for(let M=0;M<Y;M++){const k=Math.max(z,0);let P=sA.getSilentFrame(e.manifestCodec||e.codec,e.channelCount);P||(j.log("[mp4-remuxer]: Unable to get silent frame for given audio codec; duplicating last frame instead."),P=H.unit.subarray()),m.splice(G,0,{unit:P,pts:k}),z+=u,G++}}H.pts=z,z+=u}}let C=null,x=null,I,S=0,w=m.length;for(;w--;)S+=m[w].unit.byteLength;for(let Q=0,G=m.length;Q<G;Q++){const z=m[Q],H=z.unit;let N=z.pts;if(x!==null){const $=d[Q-1];$.duration=Math.round((N-x)/c)}else if(i&&e.segmentCodec==="aac"&&(N=y),C=N,S>0){S+=g;try{I=new Uint8Array(S)}catch($){this.observer.emit(D.ERROR,D.ERROR,{type:_e.MUX_ERROR,details:te.REMUX_ALLOC_ERROR,fatal:!1,error:$,bytes:S,reason:`fail allocating audio mdat ${S}`});return}f||(new DataView(I.buffer).setUint32(0,S),I.set(X.types.mdat,4))}else return;I.set(H,g);const V=H.byteLength;g+=V,d.push(new rA(!0,l,V,0)),x=N}const B=d.length;if(!B)return;const T=d[d.length-1];this.nextAudioPts=y=x+c*T.duration;const R=f?new Uint8Array(0):X.moof(e.sequenceNumber++,C/c,pt({},e,{samples:d}));e.samples=[];const _=C/o,L=y/o,U={data1:R,data2:I,startPTS:_,endPTS:L,startDTS:_,endDTS:L,type:"audio",hasAudio:!0,hasVideo:!1,nb:B};return this.isAudioContiguous=!0,U}remuxEmptyAudio(e,t,i,s){const r=e.inputTimeScale,o=e.samplerate?e.samplerate:r,a=r/o,c=this.nextAudioPts,l=this._initDTS,u=l.baseTime*9e4/l.timescale,h=(c!==null?c:s.startDTS*r)+u,f=s.endDTS*r+u,d=a*nA,p=Math.ceil((f-h)/d),m=sA.getSilentFrame(e.manifestCodec||e.codec,e.channelCount);if(j.warn("[mp4-remuxer]: remux empty Audio"),!m){j.trace("[mp4-remuxer]: Unable to remuxEmptyAudio since we were unable to get a silent frame for given audio codec");return}const g=[];for(let y=0;y<p;y++){const v=h+y*d;g.push({unit:m,pts:v,dts:v})}return e.samples=g,this.remuxAudio(e,t,i,!1)}}function xi(n,e){let t;if(e===null)return n;for(e<n?t=-8589934592:t=8589934592;Math.abs(n-e)>4294967296;)n+=t;return n}function Y6(n){for(let e=0;e<n.length;e++)if(n[e].key)return e;return-1}function Ig(n,e,t,i){const s=n.samples.length;if(!s)return;const r=n.inputTimeScale;for(let a=0;a<s;a++){const c=n.samples[a];c.pts=xi(c.pts-t.baseTime*r/t.timescale,e*r)/r,c.dts=xi(c.dts-i.baseTime*r/i.timescale,e*r)/r}const o=n.samples;return n.samples=[],{samples:o}}function Sg(n,e,t){const i=n.samples.length;if(!i)return;const s=n.inputTimeScale;for(let o=0;o<i;o++){const a=n.samples[o];a.pts=xi(a.pts-t.baseTime*s/t.timescale,e*s)/s}n.samples.sort((o,a)=>o.pts-a.pts);const r=n.samples;return n.samples=[],{samples:r}}class rA{constructor(e,t,i,s){this.size=void 0,this.duration=void 0,this.cts=void 0,this.flags=void 0,this.duration=t,this.size=i,this.cts=s,this.flags={isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:e?2:1,isNonSync:e?0:1}}}class $6{constructor(){this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=null,this.initTracks=void 0,this.lastEndTime=null}destroy(){}resetTimeStamp(e){this.initPTS=e,this.lastEndTime=null}resetNextTimestamp(){this.lastEndTime=null}resetInitSegment(e,t,i,s){this.audioCodec=t,this.videoCodec=i,this.generateInitSegment(t5(e,s)),this.emitInitSegment=!0}generateInitSegment(e){let{audioCodec:t,videoCodec:i}=this;if(!(e!=null&&e.byteLength)){this.initTracks=void 0,this.initData=void 0;return}const s=this.initData=$p(e);s.audio&&(t=oA(s.audio,$e.AUDIO)),s.video&&(i=oA(s.video,$e.VIDEO));const r={};s.audio&&s.video?r.audiovideo={container:"video/mp4",codec:t+","+i,initSegment:e,id:"main"}:s.audio?r.audio={container:"audio/mp4",codec:t,initSegment:e,id:"audio"}:s.video?r.video={container:"video/mp4",codec:i,initSegment:e,id:"main"}:j.warn("[passthrough-remuxer.ts]: initSegment does not contain moov or trak boxes."),this.initTracks=r}remux(e,t,i,s,r,o){var a,c;let{initPTS:l,lastEndTime:u}=this;const h={audio:void 0,video:void 0,text:s,id3:i,initSegment:void 0};ve(u)||(u=this.lastEndTime=r||0);const f=t.samples;if(!(f!=null&&f.length))return h;const d={initPTS:void 0,timescale:1};let p=this.initData;if((a=p)!=null&&a.length||(this.generateInitSegment(f),p=this.initData),!((c=p)!=null&&c.length))return j.warn("[passthrough-remuxer.ts]: Failed to generate initSegment."),h;this.emitInitSegment&&(d.tracks=this.initTracks,this.emitInitSegment=!1);const m=s5(f,p),g=i5(p,f),y=g===null?r:g;(W6(l,y,r,m)||d.timescale!==l.timescale&&o)&&(d.initPTS=y-r,l&&l.timescale===1&&j.warn(`Adjusting initPTS by ${d.initPTS-l.baseTime}`),this.initPTS=l={baseTime:d.initPTS,timescale:1});const v=e?y-l.baseTime/l.timescale:u,E=v+m;r5(p,f,l.baseTime/l.timescale),m>0?this.lastEndTime=E:(j.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());const C=!!p.audio,x=!!p.video;let I="";C&&(I+="audio"),x&&(I+="video");const S={data1:f,startPTS:v,startDTS:v,endPTS:E,endDTS:E,type:I,hasAudio:C,hasVideo:x,nb:1,dropped:0};return h.audio=S.type==="audio"?S:void 0,h.video=S.type!=="audio"?S:void 0,h.initSegment=d,h.id3=Ig(i,r,l,l),s.samples.length&&(h.text=Sg(s,r,l)),h}}function W6(n,e,t,i){if(n===null)return!0;const s=Math.max(i,1),r=e-n.baseTime/n.timescale;return Math.abs(r-t)>s}function oA(n,e){const t=n==null?void 0:n.codec;if(t&&t.length>4)return t;if(e===$e.AUDIO){if(t==="ec-3"||t==="ac-3"||t==="alac")return t;if(t==="fLaC"||t==="Opus")return Ec(t,!1);const i="mp4a.40.5";return j.info(`Parsed audio codec "${t}" or audio object type not handled. Using "${i}"`),i}return j.warn(`Unhandled video codec "${t}"`),t==="hvc1"||t==="hev1"?"hvc1.1.6.L120.90":t==="av01"?"av01.0.04M.08":"avc1.42e01e"}let vs;try{vs=self.performance.now.bind(self.performance)}catch{j.debug("Unable to use Performance API on this environment"),vs=pr==null?void 0:pr.Date.now}const tc=[{demux:L6,remux:$6},{demux:ks,remux:ec},{demux:D6,remux:ec},{demux:N6,remux:ec}];tc.splice(2,0,{demux:P6,remux:ec});class aA{constructor(e,t,i,s,r){this.async=!1,this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.vendor=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=e,this.typeSupported=t,this.config=i,this.vendor=s,this.id=r}configure(e){this.transmuxConfig=e,this.decrypter&&this.decrypter.reset()}push(e,t,i,s){const r=i.transmuxing;r.executeStart=vs();let o=new Uint8Array(e);const{currentTransmuxState:a,transmuxConfig:c}=this;s&&(this.currentTransmuxState=s);const{contiguous:l,discontinuity:u,trackSwitch:h,accurateTimeOffset:f,timeOffset:d,initSegmentChange:p}=s||a,{audioCodec:m,videoCodec:g,defaultInitPts:y,duration:v,initSegmentData:E}=c,C=j6(o,t);if(C&&C.method==="AES-128"){const w=this.getDecrypter();if(w.isSync()){let B=w.softwareDecrypt(o,C.key.buffer,C.iv.buffer);if(i.part>-1&&(B=w.flush()),!B)return r.executeEnd=vs(),Xl(i);o=new Uint8Array(B)}else return this.decryptionPromise=w.webCryptoDecrypt(o,C.key.buffer,C.iv.buffer).then(B=>{const T=this.push(B,null,i);return this.decryptionPromise=null,T}),this.decryptionPromise}const x=this.needsProbing(u,h);if(x){const w=this.configureTransmuxer(o);if(w)return j.warn(`[transmuxer] ${w.message}`),this.observer.emit(D.ERROR,D.ERROR,{type:_e.MEDIA_ERROR,details:te.FRAG_PARSING_ERROR,fatal:!1,error:w,reason:w.message}),r.executeEnd=vs(),Xl(i)}(u||h||p||x)&&this.resetInitSegment(E,m,g,v,t),(u||p||x)&&this.resetInitialTimestamp(y),l||this.resetContiguity();const I=this.transmux(o,C,d,f,i),S=this.currentTransmuxState;return S.contiguous=!0,S.discontinuity=!1,S.trackSwitch=!1,r.executeEnd=vs(),I}flush(e){const t=e.transmuxing;t.executeStart=vs();const{decrypter:i,currentTransmuxState:s,decryptionPromise:r}=this;if(r)return r.then(()=>this.flush(e));const o=[],{timeOffset:a}=s;if(i){const h=i.flush();h&&o.push(this.push(h,null,e))}const{demuxer:c,remuxer:l}=this;if(!c||!l)return t.executeEnd=vs(),[Xl(e)];const u=c.flush(a);return ic(u)?u.then(h=>(this.flushRemux(o,h,e),o)):(this.flushRemux(o,u,e),o)}flushRemux(e,t,i){const{audioTrack:s,videoTrack:r,id3Track:o,textTrack:a}=t,{accurateTimeOffset:c,timeOffset:l}=this.currentTransmuxState;j.log(`[transmuxer.ts]: Flushed fragment ${i.sn}${i.part>-1?" p: "+i.part:""} of level ${i.level}`);const u=this.remuxer.remux(s,r,o,a,l,c,!0,this.id);e.push({remuxResult:u,chunkMeta:i}),i.transmuxing.executeEnd=vs()}resetInitialTimestamp(e){const{demuxer:t,remuxer:i}=this;!t||!i||(t.resetTimeStamp(e),i.resetTimeStamp(e))}resetContiguity(){const{demuxer:e,remuxer:t}=this;!e||!t||(e.resetContiguity(),t.resetNextTimestamp())}resetInitSegment(e,t,i,s,r){const{demuxer:o,remuxer:a}=this;!o||!a||(o.resetInitSegment(e,t,i,s),a.resetInitSegment(e,t,i,r))}destroy(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)}transmux(e,t,i,s,r){let o;return t&&t.method==="SAMPLE-AES"?o=this.transmuxSampleAes(e,t,i,s,r):o=this.transmuxUnencrypted(e,i,s,r),o}transmuxUnencrypted(e,t,i,s){const{audioTrack:r,videoTrack:o,id3Track:a,textTrack:c}=this.demuxer.demux(e,t,!1,!this.config.progressive);return{remuxResult:this.remuxer.remux(r,o,a,c,t,i,!1,this.id),chunkMeta:s}}transmuxSampleAes(e,t,i,s,r){return this.demuxer.demuxSampleAes(e,t,i).then(o=>({remuxResult:this.remuxer.remux(o.audioTrack,o.videoTrack,o.id3Track,o.textTrack,i,s,!1,this.id),chunkMeta:r}))}configureTransmuxer(e){const{config:t,observer:i,typeSupported:s,vendor:r}=this;let o;for(let f=0,d=tc.length;f<d;f++){var a;if((a=tc[f].demux)!=null&&a.probe(e)){o=tc[f];break}}if(!o)return new Error("Failed to find demuxer by probing fragment data");const c=this.demuxer,l=this.remuxer,u=o.remux,h=o.demux;(!l||!(l instanceof u))&&(this.remuxer=new u(i,t,s,r)),(!c||!(c instanceof h))&&(this.demuxer=new h(i,t,s),this.probe=h.probe)}needsProbing(e,t){return!this.demuxer||!this.remuxer||e||t}getDecrypter(){let e=this.decrypter;return e||(e=this.decrypter=new hf(this.config)),e}}function j6(n,e){let t=null;return n.byteLength>0&&(e==null?void 0:e.key)!=null&&e.iv!==null&&e.method!=null&&(t=e),t}const Xl=n=>({remuxResult:{},chunkMeta:n});function ic(n){return"then"in n&&n.then instanceof Function}class J6{constructor(e,t,i,s,r){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=e,this.videoCodec=t,this.initSegmentData=i,this.duration=s,this.defaultInitPts=r||null}}class q6{constructor(e,t,i,s,r,o){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=e,this.contiguous=t,this.accurateTimeOffset=i,this.trackSwitch=s,this.timeOffset=r,this.initSegmentChange=o}}var wg={exports:{}};(function(n){var e=Object.prototype.hasOwnProperty,t="~";function i(){}Object.create&&(i.prototype=Object.create(null),new i().__proto__||(t=!1));function s(c,l,u){this.fn=c,this.context=l,this.once=u||!1}function r(c,l,u,h,f){if(typeof u!="function")throw new TypeError("The listener must be a function");var d=new s(u,h||c,f),p=t?t+l:l;return c._events[p]?c._events[p].fn?c._events[p]=[c._events[p],d]:c._events[p].push(d):(c._events[p]=d,c._eventsCount++),c}function o(c,l){--c._eventsCount===0?c._events=new i:delete c._events[l]}function a(){this._events=new i,this._eventsCount=0}a.prototype.eventNames=function(){var l=[],u,h;if(this._eventsCount===0)return l;for(h in u=this._events)e.call(u,h)&&l.push(t?h.slice(1):h);return Object.getOwnPropertySymbols?l.concat(Object.getOwnPropertySymbols(u)):l},a.prototype.listeners=function(l){var u=t?t+l:l,h=this._events[u];if(!h)return[];if(h.fn)return[h.fn];for(var f=0,d=h.length,p=new Array(d);f<d;f++)p[f]=h[f].fn;return p},a.prototype.listenerCount=function(l){var u=t?t+l:l,h=this._events[u];return h?h.fn?1:h.length:0},a.prototype.emit=function(l,u,h,f,d,p){var m=t?t+l:l;if(!this._events[m])return!1;var g=this._events[m],y=arguments.length,v,E;if(g.fn){switch(g.once&&this.removeListener(l,g.fn,void 0,!0),y){case 1:return g.fn.call(g.context),!0;case 2:return g.fn.call(g.context,u),!0;case 3:return g.fn.call(g.context,u,h),!0;case 4:return g.fn.call(g.context,u,h,f),!0;case 5:return g.fn.call(g.context,u,h,f,d),!0;case 6:return g.fn.call(g.context,u,h,f,d,p),!0}for(E=1,v=new Array(y-1);E<y;E++)v[E-1]=arguments[E];g.fn.apply(g.context,v)}else{var C=g.length,x;for(E=0;E<C;E++)switch(g[E].once&&this.removeListener(l,g[E].fn,void 0,!0),y){case 1:g[E].fn.call(g[E].context);break;case 2:g[E].fn.call(g[E].context,u);break;case 3:g[E].fn.call(g[E].context,u,h);break;case 4:g[E].fn.call(g[E].context,u,h,f);break;default:if(!v)for(x=1,v=new Array(y-1);x<y;x++)v[x-1]=arguments[x];g[E].fn.apply(g[E].context,v)}}return!0},a.prototype.on=function(l,u,h){return r(this,l,u,h,!1)},a.prototype.once=function(l,u,h){return r(this,l,u,h,!0)},a.prototype.removeListener=function(l,u,h,f){var d=t?t+l:l;if(!this._events[d])return this;if(!u)return o(this,d),this;var p=this._events[d];if(p.fn)p.fn===u&&(!f||p.once)&&(!h||p.context===h)&&o(this,d);else{for(var m=0,g=[],y=p.length;m<y;m++)(p[m].fn!==u||f&&!p[m].once||h&&p[m].context!==h)&&g.push(p[m]);g.length?this._events[d]=g.length===1?g[0]:g:o(this,d)}return this},a.prototype.removeAllListeners=function(l){var u;return l?(u=t?t+l:l,this._events[u]&&o(this,u)):(this._events=new i,this._eventsCount=0),this},a.prototype.off=a.prototype.removeListener,a.prototype.addListener=a.prototype.on,a.prefixed=t,a.EventEmitter=a,n.exports=a})(wg);var X6=wg.exports,pf=wI(X6);class Tg{constructor(e,t,i,s){this.error=null,this.hls=void 0,this.id=void 0,this.observer=void 0,this.frag=null,this.part=null,this.useWorker=void 0,this.workerContext=null,this.onwmsg=void 0,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0;const r=e.config;this.hls=e,this.id=t,this.useWorker=!!r.enableWorker,this.onTransmuxComplete=i,this.onFlush=s;const o=(l,u)=>{u=u||{},u.frag=this.frag,u.id=this.id,l===D.ERROR&&(this.error=u.error),this.hls.trigger(l,u)};this.observer=new pf,this.observer.on(D.FRAG_DECRYPTED,o),this.observer.on(D.ERROR,o);const a=zs(r.preferManagedMediaSource)||{isTypeSupported:()=>!1},c={mpeg:a.isTypeSupported("audio/mpeg"),mp3:a.isTypeSupported('audio/mp4; codecs="mp3"'),ac3:a.isTypeSupported('audio/mp4; codecs="ac-3"')};if(this.useWorker&&typeof Worker<"u"&&(r.workerPath||g6())){try{r.workerPath?(j.log(`loading Web Worker ${r.workerPath} for "${t}"`),this.workerContext=E6(r.workerPath)):(j.log(`injecting Web Worker for "${t}"`),this.workerContext=y6()),this.onwmsg=h=>this.onWorkerMessage(h);const{worker:u}=this.workerContext;u.addEventListener("message",this.onwmsg),u.onerror=h=>{const f=new Error(`${h.message}  (${h.filename}:${h.lineno})`);r.enableWorker=!1,j.warn(`Error in "${t}" Web Worker, fallback to inline`),this.hls.trigger(D.ERROR,{type:_e.OTHER_ERROR,details:te.INTERNAL_EXCEPTION,fatal:!1,event:"demuxerWorker",error:f})},u.postMessage({cmd:"init",typeSupported:c,vendor:"",id:t,config:JSON.stringify(r)})}catch(u){j.warn(`Error setting up "${t}" Web Worker, fallback to inline`,u),this.resetWorker(),this.error=null,this.transmuxer=new aA(this.observer,c,r,"",t)}return}this.transmuxer=new aA(this.observer,c,r,"",t)}resetWorker(){if(this.workerContext){const{worker:e,objectURL:t}=this.workerContext;t&&self.URL.revokeObjectURL(t),e.removeEventListener("message",this.onwmsg),e.onerror=null,e.terminate(),this.workerContext=null}}destroy(){if(this.workerContext)this.resetWorker(),this.onwmsg=void 0;else{const t=this.transmuxer;t&&(t.destroy(),this.transmuxer=null)}const e=this.observer;e&&e.removeAllListeners(),this.frag=null,this.observer=null,this.hls=null}push(e,t,i,s,r,o,a,c,l,u){var h,f;l.transmuxing.start=self.performance.now();const{transmuxer:d}=this,p=o?o.start:r.start,m=r.decryptdata,g=this.frag,y=!(g&&r.cc===g.cc),v=!(g&&l.level===g.level),E=g?l.sn-g.sn:-1,C=this.part?l.part-this.part.index:-1,x=E===0&&l.id>1&&l.id===(g==null?void 0:g.stats.chunkCount),I=!v&&(E===1||E===0&&(C===1||x&&C<=0)),S=self.performance.now();(v||E||r.stats.parsing.start===0)&&(r.stats.parsing.start=S),o&&(C||!I)&&(o.stats.parsing.start=S);const w=!(g&&((h=r.initSegment)==null?void 0:h.url)===((f=g.initSegment)==null?void 0:f.url)),B=new q6(y,I,c,v,p,w);if(!I||y||w){j.log(`[transmuxer-interface, ${r.type}]: Starting new transmux session for sn: ${l.sn} p: ${l.part} level: ${l.level} id: ${l.id}
        discontinuity: ${y}
        trackSwitch: ${v}
        contiguous: ${I}
        accurateTimeOffset: ${c}
        timeOffset: ${p}
        initSegmentChange: ${w}`);const T=new J6(i,s,t,a,u);this.configureTransmuxer(T)}if(this.frag=r,this.part=o,this.workerContext)this.workerContext.worker.postMessage({cmd:"demux",data:e,decryptdata:m,chunkMeta:l,state:B},e instanceof ArrayBuffer?[e]:[]);else if(d){const T=d.push(e,m,l,B);ic(T)?(d.async=!0,T.then(R=>{this.handleTransmuxComplete(R)}).catch(R=>{this.transmuxerError(R,l,"transmuxer-interface push error")})):(d.async=!1,this.handleTransmuxComplete(T))}}flush(e){e.transmuxing.start=self.performance.now();const{transmuxer:t}=this;if(this.workerContext)this.workerContext.worker.postMessage({cmd:"flush",chunkMeta:e});else if(t){let i=t.flush(e);ic(i)||t.async?(ic(i)||(i=Promise.resolve(i)),i.then(r=>{this.handleFlushResult(r,e)}).catch(r=>{this.transmuxerError(r,e,"transmuxer-interface flush error")})):this.handleFlushResult(i,e)}}transmuxerError(e,t,i){this.hls&&(this.error=e,this.hls.trigger(D.ERROR,{type:_e.MEDIA_ERROR,details:te.FRAG_PARSING_ERROR,chunkMeta:t,frag:this.frag||void 0,fatal:!1,error:e,err:e,reason:i}))}handleFlushResult(e,t){e.forEach(i=>{this.handleTransmuxComplete(i)}),this.onFlush(t)}onWorkerMessage(e){const t=e.data;if(!(t!=null&&t.event)){j.warn(`worker message received with no ${t?"event name":"data"}`);return}const i=this.hls;if(this.hls)switch(t.event){case"init":{var s;const r=(s=this.workerContext)==null?void 0:s.objectURL;r&&self.URL.revokeObjectURL(r);break}case"transmuxComplete":{this.handleTransmuxComplete(t.data);break}case"flush":{this.onFlush(t.data);break}case"workerLog":j[t.data.logType]&&j[t.data.logType](t.data.message);break;default:{t.data=t.data||{},t.data.frag=this.frag,t.data.id=this.id,i.trigger(t.event,t.data);break}}}configureTransmuxer(e){const{transmuxer:t}=this;this.workerContext?this.workerContext.worker.postMessage({cmd:"configure",config:e}):t&&t.configure(e)}handleTransmuxComplete(e){e.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(e)}}function Bg(n,e){if(n.length!==e.length)return!1;for(let t=0;t<n.length;t++)if(!yr(n[t].attrs,e[t].attrs))return!1;return!0}function yr(n,e,t){const i=n["STABLE-RENDITION-ID"];return i&&!t?i===e["STABLE-RENDITION-ID"]:!(t||["LANGUAGE","NAME","CHARACTERISTICS","AUTOSELECT","DEFAULT","FORCED","ASSOC-LANGUAGE"]).some(s=>n[s]!==e[s])}function mh(n,e){return e.label.toLowerCase()===n.name.toLowerCase()&&(!e.language||e.language.toLowerCase()===(n.lang||"").toLowerCase())}const cA=100;class _g extends Hc{constructor(e,t,i){super(e,t,i,"[audio-stream-controller]",we.AUDIO),this.videoBuffer=null,this.videoTrackCC=-1,this.waitingVideoCC=-1,this.bufferedTrack=null,this.switchingTrack=null,this.trackId=-1,this.waitingData=null,this.mainDetails=null,this.flushing=!1,this.bufferFlushed=!1,this.cachedTrackLoadedData=null,this._registerListeners()}onHandlerDestroying(){this._unregisterListeners(),super.onHandlerDestroying(),this.mainDetails=null,this.bufferedTrack=null,this.switchingTrack=null}_registerListeners(){const{hls:e}=this;e.on(D.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(D.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(D.MANIFEST_LOADING,this.onManifestLoading,this),e.on(D.LEVEL_LOADED,this.onLevelLoaded,this),e.on(D.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.on(D.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(D.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(D.ERROR,this.onError,this),e.on(D.BUFFER_RESET,this.onBufferReset,this),e.on(D.BUFFER_CREATED,this.onBufferCreated,this),e.on(D.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(D.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(D.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(D.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){const{hls:e}=this;e.off(D.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(D.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(D.MANIFEST_LOADING,this.onManifestLoading,this),e.off(D.LEVEL_LOADED,this.onLevelLoaded,this),e.off(D.AUDIO_TRACKS_UPDATED,this.onAudioTracksUpdated,this),e.off(D.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(D.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(D.ERROR,this.onError,this),e.off(D.BUFFER_RESET,this.onBufferReset,this),e.off(D.BUFFER_CREATED,this.onBufferCreated,this),e.off(D.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(D.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(D.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(D.FRAG_BUFFERED,this.onFragBuffered,this)}onInitPtsFound(e,{frag:t,id:i,initPTS:s,timescale:r}){if(i==="main"){const o=t.cc;this.initPTS[t.cc]={baseTime:s,timescale:r},this.log(`InitPTS for cc: ${o} found from main: ${s}`),this.videoTrackCC=o,this.state===le.WAITING_INIT_PTS&&this.tick()}}startLoad(e){if(!this.levels){this.startPosition=e,this.state=le.STOPPED;return}const t=this.lastCurrentTime;this.stopLoad(),this.setInterval(cA),t>0&&e===-1?(this.log(`Override startPosition with lastCurrentTime @${t.toFixed(3)}`),e=t,this.state=le.IDLE):(this.loadedmetadata=!1,this.state=le.WAITING_TRACK),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=e,this.tick()}doTick(){switch(this.state){case le.IDLE:this.doTickIdle();break;case le.WAITING_TRACK:{var e;const{levels:i,trackId:s}=this,r=i==null||(e=i[s])==null?void 0:e.details;if(r){if(this.waitForCdnTuneIn(r))break;this.state=le.WAITING_INIT_PTS}break}case le.FRAG_LOADING_WAITING_RETRY:{var t;const i=performance.now(),s=this.retryDate;if(!s||i>=s||(t=this.media)!=null&&t.seeking){const{levels:r,trackId:o}=this;this.log("RetryDate reached, switch back to IDLE state"),this.resetStartWhenNotLoaded((r==null?void 0:r[o])||null),this.state=le.IDLE}break}case le.WAITING_INIT_PTS:{const i=this.waitingData;if(i){const{frag:s,part:r,cache:o,complete:a}=i;if(this.initPTS[s.cc]!==void 0){this.waitingData=null,this.waitingVideoCC=-1,this.state=le.FRAG_LOADING;const c=o.flush(),l={frag:s,part:r,payload:c,networkDetails:null};this._handleFragmentLoadProgress(l),a&&super._handleFragmentLoadComplete(l)}else if(this.videoTrackCC!==this.waitingVideoCC)this.log(`Waiting fragment cc (${s.cc}) cancelled because video is at cc ${this.videoTrackCC}`),this.clearWaitingFragment();else{const c=this.getLoadPosition(),l=Ze.bufferInfo(this.mediaBuffer,c,this.config.maxBufferHole);dh(l.end,this.config.maxFragLookUpTolerance,s)<0&&(this.log(`Waiting fragment cc (${s.cc}) @ ${s.start} cancelled because another fragment at ${l.end} is needed`),this.clearWaitingFragment())}}else this.state=le.IDLE}}this.onTickEnd()}clearWaitingFragment(){const e=this.waitingData;e&&(this.fragmentTracker.removeFragment(e.frag),this.waitingData=null,this.waitingVideoCC=-1,this.state=le.IDLE)}resetLoadingState(){this.clearWaitingFragment(),super.resetLoadingState()}onTickEnd(){const{media:e}=this;e!=null&&e.readyState&&(this.lastCurrentTime=e.currentTime)}doTickIdle(){const{hls:e,levels:t,media:i,trackId:s}=this,r=e.config;if(!i&&(this.startFragRequested||!r.startFragPrefetch)||!(t!=null&&t[s]))return;const o=t[s],a=o.details;if(!a||a.live&&this.levelLastLoaded!==o||this.waitForCdnTuneIn(a)){this.state=le.WAITING_TRACK;return}const c=this.mediaBuffer?this.mediaBuffer:this.media;this.bufferFlushed&&c&&(this.bufferFlushed=!1,this.afterBufferFlushed(c,$e.AUDIO,we.AUDIO));const l=this.getFwdBufferInfo(c,we.AUDIO);if(l===null)return;const{bufferedTrack:u,switchingTrack:h}=this;if(!h&&this._streamEnded(l,a)){e.trigger(D.BUFFER_EOS,{type:"audio"}),this.state=le.ENDED;return}const f=this.getFwdBufferInfo(this.videoBuffer?this.videoBuffer:this.media,we.MAIN),d=l.len,p=this.getMaxBufferLength(f==null?void 0:f.len),m=a.fragments,g=m[0].start;let y=this.flushing?this.getLoadPosition():l.end;if(h&&i){const x=this.getLoadPosition();u&&!yr(h.attrs,u.attrs)&&(y=x),a.PTSKnown&&x<g&&(l.end>g||l.nextStart)&&(this.log("Alt audio track ahead of main track, seek to start of alt audio track"),i.currentTime=g+.05)}if(d>=p&&!h&&y<m[m.length-1].start)return;let v=this.getNextFragment(y,a),E=!1;if(v&&this.isLoopLoading(v,y)&&(E=!!v.gap,v=this.getNextFragmentLoopLoading(v,a,l,we.MAIN,p)),!v){this.bufferFlushed=!0;return}const C=f&&v.start>f.end+a.targetduration;if(C||!(f!=null&&f.len)&&l.len){const x=this.getAppendedFrag(v.start,we.MAIN);if(x===null||(E||(E=!!x.gap||!!C&&f.len===0),C&&!E||E&&l.nextStart&&l.nextStart<x.end))return}this.loadFragment(v,o,y)}getMaxBufferLength(e){const t=super.getMaxBufferLength();return e?Math.min(Math.max(t,e),this.config.maxMaxBufferLength):t}onMediaDetaching(){this.videoBuffer=null,this.bufferFlushed=this.flushing=!1,super.onMediaDetaching()}onAudioTracksUpdated(e,{audioTracks:t}){this.resetTransmuxer(),this.levels=t.map(i=>new un(i))}onAudioTrackSwitching(e,t){const i=!!t.url;this.trackId=t.id;const{fragCurrent:s}=this;s&&(s.abortRequests(),this.removeUnbufferedFrags(s.start)),this.resetLoadingState(),i?this.setInterval(cA):this.resetTransmuxer(),i?(this.switchingTrack=t,this.state=le.IDLE,this.flushAudioIfNeeded(t)):(this.switchingTrack=null,this.bufferedTrack=t,this.state=le.STOPPED),this.tick()}onManifestLoading(){this.fragmentTracker.removeAllFragments(),this.startPosition=this.lastCurrentTime=0,this.bufferFlushed=this.flushing=!1,this.levels=this.mainDetails=this.waitingData=this.bufferedTrack=this.cachedTrackLoadedData=this.switchingTrack=null,this.startFragRequested=!1,this.trackId=this.videoTrackCC=this.waitingVideoCC=-1}onLevelLoaded(e,t){this.mainDetails=t.details,this.cachedTrackLoadedData!==null&&(this.hls.trigger(D.AUDIO_TRACK_LOADED,this.cachedTrackLoadedData),this.cachedTrackLoadedData=null)}onAudioTrackLoaded(e,t){var i;if(this.mainDetails==null){this.cachedTrackLoadedData=t;return}const{levels:s}=this,{details:r,id:o}=t;if(!s){this.warn(`Audio tracks were reset while loading level ${o}`);return}this.log(`Audio track ${o} loaded [${r.startSN},${r.endSN}]${r.lastPartSn?`[part-${r.lastPartSn}-${r.lastPartIndex}]`:""},duration:${r.totalduration}`);const a=s[o];let c=0;if(r.live||(i=a.details)!=null&&i.live){this.checkLiveUpdate(r);const u=this.mainDetails;if(r.deltaUpdateFailed||!u)return;if(!a.details&&r.hasProgramDateTime&&u.hasProgramDateTime)Sc(r,u),c=r.fragments[0].start;else{var l;c=this.alignPlaylists(r,a.details,(l=this.levelLastLoaded)==null?void 0:l.details)}}a.details=r,this.levelLastLoaded=a,!this.startFragRequested&&(this.mainDetails||!r.live)&&this.setStartPosition(this.mainDetails||r,c),this.state===le.WAITING_TRACK&&!this.waitForCdnTuneIn(r)&&(this.state=le.IDLE),this.tick()}_handleFragmentLoadProgress(e){var t;const{frag:i,part:s,payload:r}=e,{config:o,trackId:a,levels:c}=this;if(!c){this.warn(`Audio tracks were reset while fragment load was in progress. Fragment ${i.sn} of level ${i.level} will not be buffered`);return}const l=c[a];if(!l){this.warn("Audio track is undefined on fragment load progress");return}const u=l.details;if(!u){this.warn("Audio track details undefined on fragment load progress"),this.removeUnbufferedFrags(i.start);return}const h=o.defaultAudioCodec||l.audioCodec||"mp4a.40.2";let f=this.transmuxer;f||(f=this.transmuxer=new Tg(this.hls,we.AUDIO,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)));const d=this.initPTS[i.cc],p=(t=i.initSegment)==null?void 0:t.data;if(d!==void 0){const g=s?s.index:-1,y=g!==-1,v=new zc(i.level,i.sn,i.stats.chunkCount,r.byteLength,g,y);f.push(r,p,h,"",i,s,u.totalduration,!1,v,d)}else{this.log(`Unknown video PTS for cc ${i.cc}, waiting for video PTS before demuxing audio frag ${i.sn} of [${u.startSN} ,${u.endSN}],track ${a}`);const{cache:m}=this.waitingData=this.waitingData||{frag:i,part:s,cache:new ug,complete:!1};m.push(new Uint8Array(r)),this.waitingVideoCC=this.videoTrackCC,this.state=le.WAITING_INIT_PTS}}_handleFragmentLoadComplete(e){if(this.waitingData){this.waitingData.complete=!0;return}super._handleFragmentLoadComplete(e)}onBufferReset(){this.mediaBuffer=this.videoBuffer=null,this.loadedmetadata=!1}onBufferCreated(e,t){const i=t.tracks.audio;i&&(this.mediaBuffer=i.buffer||null),t.tracks.video&&(this.videoBuffer=t.tracks.video.buffer||null)}onFragBuffered(e,t){const{frag:i,part:s}=t;if(i.type!==we.AUDIO){if(!this.loadedmetadata&&i.type===we.MAIN){const r=this.videoBuffer||this.media;r&&Ze.getBuffered(r).length&&(this.loadedmetadata=!0)}return}if(this.fragContextChanged(i)){this.warn(`Fragment ${i.sn}${s?" p: "+s.index:""} of level ${i.level} finished buffering, but was aborted. state: ${this.state}, audioSwitch: ${this.switchingTrack?this.switchingTrack.name:"false"}`);return}if(i.sn!=="initSegment"){this.fragPrevious=i;const r=this.switchingTrack;r&&(this.bufferedTrack=r,this.switchingTrack=null,this.hls.trigger(D.AUDIO_TRACK_SWITCHED,Mt({},r)))}this.fragBufferedComplete(i,s)}onError(e,t){var i;if(t.fatal){this.state=le.ERROR;return}switch(t.details){case te.FRAG_GAP:case te.FRAG_PARSING_ERROR:case te.FRAG_DECRYPT_ERROR:case te.FRAG_LOAD_ERROR:case te.FRAG_LOAD_TIMEOUT:case te.KEY_LOAD_ERROR:case te.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(we.AUDIO,t);break;case te.AUDIO_TRACK_LOAD_ERROR:case te.AUDIO_TRACK_LOAD_TIMEOUT:case te.LEVEL_PARSING_ERROR:!t.levelRetry&&this.state===le.WAITING_TRACK&&((i=t.context)==null?void 0:i.type)===Ge.AUDIO_TRACK&&(this.state=le.IDLE);break;case te.BUFFER_APPEND_ERROR:case te.BUFFER_FULL_ERROR:if(!t.parent||t.parent!=="audio")return;if(t.details===te.BUFFER_APPEND_ERROR){this.resetLoadingState();return}this.reduceLengthAndFlushBuffer(t)&&(this.bufferedTrack=null,super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"));break;case te.INTERNAL_EXCEPTION:this.recoverWorkerError(t);break}}onBufferFlushing(e,{type:t}){t!==$e.VIDEO&&(this.flushing=!0)}onBufferFlushed(e,{type:t}){if(t!==$e.VIDEO){this.flushing=!1,this.bufferFlushed=!0,this.state===le.ENDED&&(this.state=le.IDLE);const i=this.mediaBuffer||this.media;i&&(this.afterBufferFlushed(i,t,we.AUDIO),this.tick())}}_handleTransmuxComplete(e){var t;const i="audio",{hls:s}=this,{remuxResult:r,chunkMeta:o}=e,a=this.getCurrentContext(o);if(!a){this.resetWhenMissingContext(o);return}const{frag:c,part:l,level:u}=a,{details:h}=u,{audio:f,text:d,id3:p,initSegment:m}=r;if(this.fragContextChanged(c)||!h){this.fragmentTracker.removeFragment(c);return}if(this.state=le.PARSING,this.switchingTrack&&f&&this.completeAudioSwitch(this.switchingTrack),m!=null&&m.tracks){const g=c.initSegment||c;this._bufferInitSegment(u,m.tracks,g,o),s.trigger(D.FRAG_PARSING_INIT_SEGMENT,{frag:g,id:i,tracks:m.tracks})}if(f){const{startPTS:g,endPTS:y,startDTS:v,endDTS:E}=f;l&&(l.elementaryStreams[$e.AUDIO]={startPTS:g,endPTS:y,startDTS:v,endDTS:E}),c.setElementaryStreamInfo($e.AUDIO,g,y,v,E),this.bufferFragmentData(f,c,l,o)}if(p!=null&&(t=p.samples)!=null&&t.length){const g=pt({id:i,frag:c,details:h},p);s.trigger(D.FRAG_PARSING_METADATA,g)}if(d){const g=pt({id:i,frag:c,details:h},d);s.trigger(D.FRAG_PARSING_USERDATA,g)}}_bufferInitSegment(e,t,i,s){if(this.state!==le.PARSING)return;t.video&&delete t.video;const r=t.audio;if(!r)return;r.id="audio";const o=e.audioCodec;this.log(`Init audio buffer, container:${r.container}, codecs[level/parsed]=[${o}/${r.codec}]`),o&&o.split(",").length===1&&(r.levelCodec=o),this.hls.trigger(D.BUFFER_CODECS,t);const a=r.initSegment;if(a!=null&&a.byteLength){const c={type:"audio",frag:i,part:null,chunkMeta:s,parent:i.type,data:a};this.hls.trigger(D.BUFFER_APPENDING,c)}this.tickImmediate()}loadFragment(e,t,i){const s=this.fragmentTracker.getState(e);if(this.fragCurrent=e,this.switchingTrack||s===bt.NOT_LOADED||s===bt.PARTIAL){var r;if(e.sn==="initSegment")this._loadInitSegment(e,t);else if((r=t.details)!=null&&r.live&&!this.initPTS[e.cc]){this.log(`Waiting for video PTS in continuity counter ${e.cc} of live stream before loading audio fragment ${e.sn} of level ${this.trackId}`),this.state=le.WAITING_INIT_PTS;const o=this.mainDetails;o&&o.fragments[0].start!==t.details.fragments[0].start&&Sc(t.details,o)}else this.startFragRequested=!0,super.loadFragment(e,t,i)}else this.clearTrackerIfNeeded(e)}flushAudioIfNeeded(e){const{media:t,bufferedTrack:i}=this,s=i==null?void 0:i.attrs,r=e.attrs;t&&s&&(s.CHANNELS!==r.CHANNELS||i.name!==e.name||i.lang!==e.lang)&&(this.log("Switching audio track : flushing all audio"),super.flushMainBuffer(0,Number.POSITIVE_INFINITY,"audio"),this.bufferedTrack=null)}completeAudioSwitch(e){const{hls:t}=this;this.flushAudioIfNeeded(e),this.bufferedTrack=e,this.switchingTrack=null,t.trigger(D.AUDIO_TRACK_SWITCHED,Mt({},e))}}class bg extends Gc{constructor(e){super(e,"[audio-track-controller]"),this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.registerListeners()}registerListeners(){const{hls:e}=this;e.on(D.MANIFEST_LOADING,this.onManifestLoading,this),e.on(D.MANIFEST_PARSED,this.onManifestParsed,this),e.on(D.LEVEL_LOADING,this.onLevelLoading,this),e.on(D.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(D.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.on(D.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(D.MANIFEST_LOADING,this.onManifestLoading,this),e.off(D.MANIFEST_PARSED,this.onManifestParsed,this),e.off(D.LEVEL_LOADING,this.onLevelLoading,this),e.off(D.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(D.AUDIO_TRACK_LOADED,this.onAudioTrackLoaded,this),e.off(D.ERROR,this.onError,this)}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,super.destroy()}onManifestLoading(){this.tracks=[],this.tracksInGroup=[],this.groupIds=null,this.currentTrack=null,this.trackId=-1,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.audioTracks||[]}onAudioTrackLoaded(e,t){const{id:i,groupId:s,details:r}=t,o=this.tracksInGroup[i];if(!o||o.groupId!==s){this.warn(`Audio track with id:${i} and group:${s} not found in active group ${o==null?void 0:o.groupId}`);return}const a=o.details;o.details=t.details,this.log(`Audio track ${i} "${o.name}" lang:${o.lang} group:${s} loaded [${r.startSN}-${r.endSN}]`),i===this.trackId&&this.playlistLoaded(i,t,a)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){const t=this.hls.levels[e];if(!t)return;const i=t.audioGroups||null,s=this.groupIds;let r=this.currentTrack;if(!i||(s==null?void 0:s.length)!==(i==null?void 0:i.length)||i!=null&&i.some(a=>(s==null?void 0:s.indexOf(a))===-1)){this.groupIds=i,this.trackId=-1,this.currentTrack=null;const a=this.tracks.filter(f=>!i||i.indexOf(f.groupId)!==-1);if(a.length)this.selectDefaultTrack&&!a.some(f=>f.default)&&(this.selectDefaultTrack=!1),a.forEach((f,d)=>{f.id=d});else if(!r&&!this.tracksInGroup.length)return;this.tracksInGroup=a;const c=this.hls.config.audioPreference;if(!r&&c){const f=ts(c,a,Ln);if(f>-1)r=a[f];else{const d=ts(c,this.tracks);r=this.tracks[d]}}let l=this.findTrackId(r);l===-1&&r&&(l=this.findTrackId(null));const u={audioTracks:a};this.log(`Updating audio tracks, ${a.length} track(s) found in group(s): ${i==null?void 0:i.join(",")}`),this.hls.trigger(D.AUDIO_TRACKS_UPDATED,u);const h=this.trackId;if(l!==-1&&h===-1)this.setAudioTrack(l);else if(a.length&&h===-1){var o;const f=new Error(`No audio track selected for current audio group-ID(s): ${(o=this.groupIds)==null?void 0:o.join(",")} track count: ${a.length}`);this.warn(f.message),this.hls.trigger(D.ERROR,{type:_e.MEDIA_ERROR,details:te.AUDIO_TRACK_LOAD_ERROR,fatal:!0,error:f})}}else this.shouldReloadPlaylist(r)&&this.setAudioTrack(this.trackId)}onError(e,t){t.fatal||!t.context||t.context.type===Ge.AUDIO_TRACK&&t.context.id===this.trackId&&(!this.groupIds||this.groupIds.indexOf(t.context.groupId)!==-1)&&(this.requestScheduled=-1,this.checkRetry(t))}get allAudioTracks(){return this.tracks}get audioTracks(){return this.tracksInGroup}get audioTrack(){return this.trackId}set audioTrack(e){this.selectDefaultTrack=!1,this.setAudioTrack(e)}setAudioOption(e){const t=this.hls;if(t.config.audioPreference=e,e){const i=this.allAudioTracks;if(this.selectDefaultTrack=!1,i.length){const s=this.currentTrack;if(s&&fr(e,s,Ln))return s;const r=ts(e,this.tracksInGroup,Ln);if(r>-1){const o=this.tracksInGroup[r];return this.setAudioTrack(r),o}else if(s){let o=t.loadLevel;o===-1&&(o=t.firstAutoLevel);const a=t6(e,t.levels,i,o,Ln);if(a===-1)return null;t.nextLoadLevel=a}if(e.channels||e.audioCodec){const o=ts(e,i);if(o>-1)return i[o]}}}return null}setAudioTrack(e){const t=this.tracksInGroup;if(e<0||e>=t.length){this.warn(`Invalid audio track id: ${e}`);return}this.clearTimer(),this.selectDefaultTrack=!1;const i=this.currentTrack,s=t[e],r=s.details&&!s.details.live;if(e===this.trackId&&s===i&&r||(this.log(`Switching to audio-track ${e} "${s.name}" lang:${s.lang} group:${s.groupId} channels:${s.channels}`),this.trackId=e,this.currentTrack=s,this.hls.trigger(D.AUDIO_TRACK_SWITCHING,Mt({},s)),r))return;const o=this.switchParams(s.url,i==null?void 0:i.details,s.details);this.loadPlaylist(o)}findTrackId(e){const t=this.tracksInGroup;for(let i=0;i<t.length;i++){const s=t[i];if(!(this.selectDefaultTrack&&!s.default)&&(!e||fr(e,s,Ln)))return i}if(e){const{name:i,lang:s,assocLang:r,characteristics:o,audioCodec:a,channels:c}=e;for(let l=0;l<t.length;l++){const u=t[l];if(fr({name:i,lang:s,assocLang:r,characteristics:o,audioCodec:a,channels:c},u,Ln))return l}for(let l=0;l<t.length;l++){const u=t[l];if(yr(e.attrs,u.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return l}for(let l=0;l<t.length;l++){const u=t[l];if(yr(e.attrs,u.attrs,["LANGUAGE"]))return l}}return-1}loadPlaylist(e){const t=this.currentTrack;if(this.shouldLoadPlaylist(t)&&t){super.loadPlaylist();const i=t.id,s=t.groupId;let r=t.url;if(e)try{r=e.addDirectives(r)}catch(o){this.warn(`Could not construct new URL with HLS Delivery Directives: ${o}`)}this.log(`loading audio-track playlist ${i} "${t.name}" lang:${t.lang} group:${s}`),this.clearTimer(),this.hls.trigger(D.AUDIO_TRACK_LOADING,{url:r,id:i,groupId:s,deliveryDirectives:e||null})}}}const lA=500;class Rg extends Hc{constructor(e,t,i){super(e,t,i,"[subtitle-stream-controller]",we.SUBTITLE),this.currentTrackId=-1,this.tracksBuffered=[],this.mainDetails=null,this._registerListeners()}onHandlerDestroying(){this._unregisterListeners(),super.onHandlerDestroying(),this.mainDetails=null}_registerListeners(){const{hls:e}=this;e.on(D.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(D.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(D.MANIFEST_LOADING,this.onManifestLoading,this),e.on(D.LEVEL_LOADED,this.onLevelLoaded,this),e.on(D.ERROR,this.onError,this),e.on(D.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(D.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.on(D.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(D.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.on(D.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(D.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){const{hls:e}=this;e.off(D.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(D.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(D.MANIFEST_LOADING,this.onManifestLoading,this),e.off(D.LEVEL_LOADED,this.onLevelLoaded,this),e.off(D.ERROR,this.onError,this),e.off(D.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(D.SUBTITLE_TRACK_SWITCH,this.onSubtitleTrackSwitch,this),e.off(D.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(D.SUBTITLE_FRAG_PROCESSED,this.onSubtitleFragProcessed,this),e.off(D.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(D.FRAG_BUFFERED,this.onFragBuffered,this)}startLoad(e){this.stopLoad(),this.state=le.IDLE,this.setInterval(lA),this.nextLoadPosition=this.startPosition=this.lastCurrentTime=e,this.tick()}onManifestLoading(){this.mainDetails=null,this.fragmentTracker.removeAllFragments()}onMediaDetaching(){this.tracksBuffered=[],super.onMediaDetaching()}onLevelLoaded(e,t){this.mainDetails=t.details}onSubtitleFragProcessed(e,t){const{frag:i,success:s}=t;if(this.fragPrevious=i,this.state=le.IDLE,!s)return;const r=this.tracksBuffered[this.currentTrackId];if(!r)return;let o;const a=i.start;for(let l=0;l<r.length;l++)if(a>=r[l].start&&a<=r[l].end){o=r[l];break}const c=i.start+i.duration;o?o.end=c:(o={start:a,end:c},r.push(o)),this.fragmentTracker.fragBuffered(i),this.fragBufferedComplete(i,null)}onBufferFlushing(e,t){const{startOffset:i,endOffset:s}=t;if(i===0&&s!==Number.POSITIVE_INFINITY){const r=s-1;if(r<=0)return;t.endOffsetSubtitles=Math.max(0,r),this.tracksBuffered.forEach(o=>{for(let a=0;a<o.length;){if(o[a].end<=r){o.shift();continue}else if(o[a].start<r)o[a].start=r;else break;a++}}),this.fragmentTracker.removeFragmentsInRange(i,r,we.SUBTITLE)}}onFragBuffered(e,t){if(!this.loadedmetadata&&t.frag.type===we.MAIN){var i;(i=this.media)!=null&&i.buffered.length&&(this.loadedmetadata=!0)}}onError(e,t){const i=t.frag;(i==null?void 0:i.type)===we.SUBTITLE&&(t.details===te.FRAG_GAP&&this.fragmentTracker.fragBuffered(i,!0),this.fragCurrent&&this.fragCurrent.abortRequests(),this.state!==le.STOPPED&&(this.state=le.IDLE))}onSubtitleTracksUpdated(e,{subtitleTracks:t}){if(this.levels&&Bg(this.levels,t)){this.levels=t.map(i=>new un(i));return}this.tracksBuffered=[],this.levels=t.map(i=>{const s=new un(i);return this.tracksBuffered[s.id]=[],s}),this.fragmentTracker.removeFragmentsInRange(0,Number.POSITIVE_INFINITY,we.SUBTITLE),this.fragPrevious=null,this.mediaBuffer=null}onSubtitleTrackSwitch(e,t){var i;if(this.currentTrackId=t.id,!((i=this.levels)!=null&&i.length)||this.currentTrackId===-1){this.clearInterval();return}const s=this.levels[this.currentTrackId];s!=null&&s.details?this.mediaBuffer=this.mediaBufferTimeRanges:this.mediaBuffer=null,s&&this.setInterval(lA)}onSubtitleTrackLoaded(e,t){var i;const{currentTrackId:s,levels:r}=this,{details:o,id:a}=t;if(!r){this.warn(`Subtitle tracks were reset while loading level ${a}`);return}const c=r[a];if(a>=r.length||!c)return;this.log(`Subtitle track ${a} loaded [${o.startSN},${o.endSN}]${o.lastPartSn?`[part-${o.lastPartSn}-${o.lastPartIndex}]`:""},duration:${o.totalduration}`),this.mediaBuffer=this.mediaBufferTimeRanges;let l=0;if(o.live||(i=c.details)!=null&&i.live){const h=this.mainDetails;if(o.deltaUpdateFailed||!h)return;const f=h.fragments[0];if(!c.details)o.hasProgramDateTime&&h.hasProgramDateTime?(Sc(o,h),l=o.fragments[0].start):f&&(l=f.start,fh(o,l));else{var u;l=this.alignPlaylists(o,c.details,(u=this.levelLastLoaded)==null?void 0:u.details),l===0&&f&&(l=f.start,fh(o,l))}}c.details=o,this.levelLastLoaded=c,a===s&&(!this.startFragRequested&&(this.mainDetails||!o.live)&&this.setStartPosition(this.mainDetails||o,l),this.tick(),o.live&&!this.fragCurrent&&this.media&&this.state===le.IDLE&&(Ic(null,o.fragments,this.media.currentTime,0)||(this.warn("Subtitle playlist not aligned with playback"),c.details=void 0)))}_handleFragmentLoadComplete(e){const{frag:t,payload:i}=e,s=t.decryptdata,r=this.hls;if(!this.fragContextChanged(t)&&i&&i.byteLength>0&&s!=null&&s.key&&s.iv&&s.method==="AES-128"){const o=performance.now();this.decrypter.decrypt(new Uint8Array(i),s.key.buffer,s.iv.buffer).catch(a=>{throw r.trigger(D.ERROR,{type:_e.MEDIA_ERROR,details:te.FRAG_DECRYPT_ERROR,fatal:!1,error:a,reason:a.message,frag:t}),a}).then(a=>{const c=performance.now();r.trigger(D.FRAG_DECRYPTED,{frag:t,payload:a,stats:{tstart:o,tdecrypt:c}})}).catch(a=>{this.warn(`${a.name}: ${a.message}`),this.state=le.IDLE})}}doTick(){if(!this.media){this.state=le.IDLE;return}if(this.state===le.IDLE){const{currentTrackId:e,levels:t}=this,i=t==null?void 0:t[e];if(!i||!t.length||!i.details)return;const{config:s}=this,r=this.getLoadPosition(),o=Ze.bufferedInfo(this.tracksBuffered[this.currentTrackId]||[],r,s.maxBufferHole),{end:a,len:c}=o,l=this.getFwdBufferInfo(this.media,we.MAIN),u=i.details,h=this.getMaxBufferLength(l==null?void 0:l.len)+u.levelTargetDuration;if(c>h)return;const f=u.fragments,d=f.length,p=u.edge;let m=null;const g=this.fragPrevious;if(a<p){const y=s.maxFragLookUpTolerance,v=a>p-y?0:y;m=Ic(g,f,Math.max(f[0].start,a),v),!m&&g&&g.start<f[0].start&&(m=f[0])}else m=f[d-1];if(!m)return;if(m=this.mapToInitFragWhenRequired(m),m.sn!=="initSegment"){const y=m.sn-u.startSN,v=f[y-1];v&&v.cc===m.cc&&this.fragmentTracker.getState(v)===bt.NOT_LOADED&&(m=v)}this.fragmentTracker.getState(m)===bt.NOT_LOADED&&this.loadFragment(m,i,a)}}getMaxBufferLength(e){const t=super.getMaxBufferLength();return e?Math.max(t,e):t}loadFragment(e,t,i){this.fragCurrent=e,e.sn==="initSegment"?this._loadInitSegment(e,t):(this.startFragRequested=!0,super.loadFragment(e,t,i))}get mediaBufferTimeRanges(){return new Z6(this.tracksBuffered[this.currentTrackId]||[])}}class Z6{constructor(e){this.buffered=void 0;const t=(i,s,r)=>{if(s=s>>>0,s>r-1)throw new DOMException(`Failed to execute '${i}' on 'TimeRanges': The index provided (${s}) is greater than the maximum bound (${r})`);return e[s][i]};this.buffered={get length(){return e.length},end(i){return t("end",i,e.length)},start(i){return t("start",i,e.length)}}}}class Dg extends Gc{constructor(e){super(e,"[subtitle-track-controller]"),this.media=null,this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0,this.queuedDefaultTrack=-1,this.asyncPollTrackChange=()=>this.pollTrackChange(0),this.useTextTrackPolling=!1,this.subtitlePollingInterval=-1,this._subtitleDisplay=!0,this.onTextTracksChanged=()=>{if(this.useTextTrackPolling||self.clearInterval(this.subtitlePollingInterval),!this.media||!this.hls.config.renderTextTracksNatively)return;let t=null;const i=Xa(this.media.textTracks);for(let r=0;r<i.length;r++)if(i[r].mode==="hidden")t=i[r];else if(i[r].mode==="showing"){t=i[r];break}const s=this.findTrackForTextTrack(t);this.subtitleTrack!==s&&this.setSubtitleTrack(s)},this.registerListeners()}destroy(){this.unregisterListeners(),this.tracks.length=0,this.tracksInGroup.length=0,this.currentTrack=null,this.onTextTracksChanged=this.asyncPollTrackChange=null,super.destroy()}get subtitleDisplay(){return this._subtitleDisplay}set subtitleDisplay(e){this._subtitleDisplay=e,this.trackId>-1&&this.toggleTrackModes()}registerListeners(){const{hls:e}=this;e.on(D.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(D.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(D.MANIFEST_LOADING,this.onManifestLoading,this),e.on(D.MANIFEST_PARSED,this.onManifestParsed,this),e.on(D.LEVEL_LOADING,this.onLevelLoading,this),e.on(D.LEVEL_SWITCHING,this.onLevelSwitching,this),e.on(D.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.on(D.ERROR,this.onError,this)}unregisterListeners(){const{hls:e}=this;e.off(D.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(D.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(D.MANIFEST_LOADING,this.onManifestLoading,this),e.off(D.MANIFEST_PARSED,this.onManifestParsed,this),e.off(D.LEVEL_LOADING,this.onLevelLoading,this),e.off(D.LEVEL_SWITCHING,this.onLevelSwitching,this),e.off(D.SUBTITLE_TRACK_LOADED,this.onSubtitleTrackLoaded,this),e.off(D.ERROR,this.onError,this)}onMediaAttached(e,t){this.media=t.media,this.media&&(this.queuedDefaultTrack>-1&&(this.subtitleTrack=this.queuedDefaultTrack,this.queuedDefaultTrack=-1),this.useTextTrackPolling=!(this.media.textTracks&&"onchange"in this.media.textTracks),this.useTextTrackPolling?this.pollTrackChange(500):this.media.textTracks.addEventListener("change",this.asyncPollTrackChange))}pollTrackChange(e){self.clearInterval(this.subtitlePollingInterval),this.subtitlePollingInterval=self.setInterval(this.onTextTracksChanged,e)}onMediaDetaching(){if(!this.media)return;self.clearInterval(this.subtitlePollingInterval),this.useTextTrackPolling||this.media.textTracks.removeEventListener("change",this.asyncPollTrackChange),this.trackId>-1&&(this.queuedDefaultTrack=this.trackId),Xa(this.media.textTracks).forEach(t=>{nr(t)}),this.subtitleTrack=-1,this.media=null}onManifestLoading(){this.tracks=[],this.groupIds=null,this.tracksInGroup=[],this.trackId=-1,this.currentTrack=null,this.selectDefaultTrack=!0}onManifestParsed(e,t){this.tracks=t.subtitleTracks}onSubtitleTrackLoaded(e,t){const{id:i,groupId:s,details:r}=t,o=this.tracksInGroup[i];if(!o||o.groupId!==s){this.warn(`Subtitle track with id:${i} and group:${s} not found in active group ${o==null?void 0:o.groupId}`);return}const a=o.details;o.details=t.details,this.log(`Subtitle track ${i} "${o.name}" lang:${o.lang} group:${s} loaded [${r.startSN}-${r.endSN}]`),i===this.trackId&&this.playlistLoaded(i,t,a)}onLevelLoading(e,t){this.switchLevel(t.level)}onLevelSwitching(e,t){this.switchLevel(t.level)}switchLevel(e){const t=this.hls.levels[e];if(!t)return;const i=t.subtitleGroups||null,s=this.groupIds;let r=this.currentTrack;if(!i||(s==null?void 0:s.length)!==(i==null?void 0:i.length)||i!=null&&i.some(o=>(s==null?void 0:s.indexOf(o))===-1)){this.groupIds=i,this.trackId=-1,this.currentTrack=null;const o=this.tracks.filter(u=>!i||i.indexOf(u.groupId)!==-1);if(o.length)this.selectDefaultTrack&&!o.some(u=>u.default)&&(this.selectDefaultTrack=!1),o.forEach((u,h)=>{u.id=h});else if(!r&&!this.tracksInGroup.length)return;this.tracksInGroup=o;const a=this.hls.config.subtitlePreference;if(!r&&a){this.selectDefaultTrack=!1;const u=ts(a,o);if(u>-1)r=o[u];else{const h=ts(a,this.tracks);r=this.tracks[h]}}let c=this.findTrackId(r);c===-1&&r&&(c=this.findTrackId(null));const l={subtitleTracks:o};this.log(`Updating subtitle tracks, ${o.length} track(s) found in "${i==null?void 0:i.join(",")}" group-id`),this.hls.trigger(D.SUBTITLE_TRACKS_UPDATED,l),c!==-1&&this.trackId===-1&&this.setSubtitleTrack(c)}else this.shouldReloadPlaylist(r)&&this.setSubtitleTrack(this.trackId)}findTrackId(e){const t=this.tracksInGroup,i=this.selectDefaultTrack;for(let s=0;s<t.length;s++){const r=t[s];if(!(i&&!r.default||!i&&!e)&&(!e||fr(r,e)))return s}if(e){for(let s=0;s<t.length;s++){const r=t[s];if(yr(e.attrs,r.attrs,["LANGUAGE","ASSOC-LANGUAGE","CHARACTERISTICS"]))return s}for(let s=0;s<t.length;s++){const r=t[s];if(yr(e.attrs,r.attrs,["LANGUAGE"]))return s}}return-1}findTrackForTextTrack(e){if(e){const t=this.tracksInGroup;for(let i=0;i<t.length;i++){const s=t[i];if(mh(s,e))return i}}return-1}onError(e,t){t.fatal||!t.context||t.context.type===Ge.SUBTITLE_TRACK&&t.context.id===this.trackId&&(!this.groupIds||this.groupIds.indexOf(t.context.groupId)!==-1)&&this.checkRetry(t)}get allSubtitleTracks(){return this.tracks}get subtitleTracks(){return this.tracksInGroup}get subtitleTrack(){return this.trackId}set subtitleTrack(e){this.selectDefaultTrack=!1,this.setSubtitleTrack(e)}setSubtitleOption(e){if(this.hls.config.subtitlePreference=e,e){const t=this.allSubtitleTracks;if(this.selectDefaultTrack=!1,t.length){const i=this.currentTrack;if(i&&fr(e,i))return i;const s=ts(e,this.tracksInGroup);if(s>-1){const r=this.tracksInGroup[s];return this.setSubtitleTrack(s),r}else{if(i)return null;{const r=ts(e,t);if(r>-1)return t[r]}}}}return null}loadPlaylist(e){super.loadPlaylist();const t=this.currentTrack;if(this.shouldLoadPlaylist(t)&&t){const i=t.id,s=t.groupId;let r=t.url;if(e)try{r=e.addDirectives(r)}catch(o){this.warn(`Could not construct new URL with HLS Delivery Directives: ${o}`)}this.log(`Loading subtitle playlist for id ${i}`),this.hls.trigger(D.SUBTITLE_TRACK_LOADING,{url:r,id:i,groupId:s,deliveryDirectives:e||null})}}toggleTrackModes(){const{media:e}=this;if(!e)return;const t=Xa(e.textTracks),i=this.currentTrack;let s;if(i&&(s=t.filter(r=>mh(i,r))[0],s||this.warn(`Unable to find subtitle TextTrack with name "${i.name}" and language "${i.lang}"`)),[].slice.call(t).forEach(r=>{r.mode!=="disabled"&&r!==s&&(r.mode="disabled")}),s){const r=this.subtitleDisplay?"showing":"hidden";s.mode!==r&&(s.mode=r)}}setSubtitleTrack(e){const t=this.tracksInGroup;if(!this.media){this.queuedDefaultTrack=e;return}if(e<-1||e>=t.length||!ve(e)){this.warn(`Invalid subtitle track id: ${e}`);return}this.clearTimer(),this.selectDefaultTrack=!1;const i=this.currentTrack,s=t[e]||null;if(this.trackId=e,this.currentTrack=s,this.toggleTrackModes(),!s){this.hls.trigger(D.SUBTITLE_TRACK_SWITCH,{id:e});return}const r=!!s.details&&!s.details.live;if(e===this.trackId&&s===i&&r)return;this.log(`Switching to subtitle-track ${e}`+(s?` "${s.name}" lang:${s.lang} group:${s.groupId}`:""));const{id:o,groupId:a="",name:c,type:l,url:u}=s;this.hls.trigger(D.SUBTITLE_TRACK_SWITCH,{id:o,groupId:a,name:c,type:l,url:u});const h=this.switchParams(s.url,i==null?void 0:i.details,s.details);this.loadPlaylist(h)}}class e8{constructor(e){this.buffers=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.buffers=e}append(e,t,i){const s=this.queues[t];s.push(e),s.length===1&&!i&&this.executeNext(t)}insertAbort(e,t){this.queues[t].unshift(e),this.executeNext(t)}appendBlocker(e){let t;const i=new Promise(r=>{t=r}),s={execute:t,onStart:()=>{},onComplete:()=>{},onError:()=>{}};return this.append(s,e),i}executeNext(e){const t=this.queues[e];if(t.length){const i=t[0];try{i.execute()}catch(s){j.warn(`[buffer-operation-queue]: Exception executing "${e}" SourceBuffer operation: ${s}`),i.onError(s);const r=this.buffers[e];r!=null&&r.updating||this.shiftAndExecuteNext(e)}}}shiftAndExecuteNext(e){this.queues[e].shift(),this.executeNext(e)}current(e){return this.queues[e][0]}}const uA=/(avc[1234]|hvc1|hev1|dvh[1e]|vp09|av01)(?:\.[^.,]+)+/;class Mg{constructor(e){this.details=null,this._objectUrl=null,this.operationQueue=void 0,this.listeners=void 0,this.hls=void 0,this.bufferCodecEventsExpected=0,this._bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.lastMpegAudioChunk=null,this.appendSource=void 0,this.appendErrors={audio:0,video:0,audiovideo:0},this.tracks={},this.pendingTracks={},this.sourceBuffer=void 0,this.log=void 0,this.warn=void 0,this.error=void 0,this._onEndStreaming=i=>{this.hls&&this.hls.pauseBuffering()},this._onStartStreaming=i=>{this.hls&&this.hls.resumeBuffering()},this._onMediaSourceOpen=()=>{const{media:i,mediaSource:s}=this;this.log("Media source opened"),i&&(i.removeEventListener("emptied",this._onMediaEmptied),this.updateMediaElementDuration(),this.hls.trigger(D.MEDIA_ATTACHED,{media:i,mediaSource:s})),s&&s.removeEventListener("sourceopen",this._onMediaSourceOpen),this.checkPendingTracks()},this._onMediaSourceClose=()=>{this.log("Media source closed")},this._onMediaSourceEnded=()=>{this.log("Media source ended")},this._onMediaEmptied=()=>{const{mediaSrc:i,_objectUrl:s}=this;i!==s&&j.error(`Media element src was set while attaching MediaSource (${s} > ${i})`)},this.hls=e;const t="[buffer-controller]";this.appendSource=p5(zs(e.config.preferManagedMediaSource)),this.log=j.log.bind(j,t),this.warn=j.warn.bind(j,t),this.error=j.error.bind(j,t),this._initSourceBuffer(),this.registerListeners()}hasSourceTypes(){return this.getSourceBufferTypes().length>0||Object.keys(this.pendingTracks).length>0}destroy(){this.unregisterListeners(),this.details=null,this.lastMpegAudioChunk=null,this.hls=null}registerListeners(){const{hls:e}=this;e.on(D.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(D.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(D.MANIFEST_LOADING,this.onManifestLoading,this),e.on(D.MANIFEST_PARSED,this.onManifestParsed,this),e.on(D.BUFFER_RESET,this.onBufferReset,this),e.on(D.BUFFER_APPENDING,this.onBufferAppending,this),e.on(D.BUFFER_CODECS,this.onBufferCodecs,this),e.on(D.BUFFER_EOS,this.onBufferEos,this),e.on(D.BUFFER_FLUSHING,this.onBufferFlushing,this),e.on(D.LEVEL_UPDATED,this.onLevelUpdated,this),e.on(D.FRAG_PARSED,this.onFragParsed,this),e.on(D.FRAG_CHANGED,this.onFragChanged,this)}unregisterListeners(){const{hls:e}=this;e.off(D.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(D.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(D.MANIFEST_LOADING,this.onManifestLoading,this),e.off(D.MANIFEST_PARSED,this.onManifestParsed,this),e.off(D.BUFFER_RESET,this.onBufferReset,this),e.off(D.BUFFER_APPENDING,this.onBufferAppending,this),e.off(D.BUFFER_CODECS,this.onBufferCodecs,this),e.off(D.BUFFER_EOS,this.onBufferEos,this),e.off(D.BUFFER_FLUSHING,this.onBufferFlushing,this),e.off(D.LEVEL_UPDATED,this.onLevelUpdated,this),e.off(D.FRAG_PARSED,this.onFragParsed,this),e.off(D.FRAG_CHANGED,this.onFragChanged,this)}_initSourceBuffer(){this.sourceBuffer={},this.operationQueue=new e8(this.sourceBuffer),this.listeners={audio:[],video:[],audiovideo:[]},this.appendErrors={audio:0,video:0,audiovideo:0},this.lastMpegAudioChunk=null}onManifestLoading(){this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=0,this.details=null}onManifestParsed(e,t){let i=2;(t.audio&&!t.video||!t.altAudio)&&(i=1),this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=i,this.log(`${this.bufferCodecEventsExpected} bufferCodec event(s) expected`)}onMediaAttaching(e,t){const i=this.media=t.media,s=zs(this.appendSource);if(i&&s){var r;const o=this.mediaSource=new s;this.log(`created media source: ${(r=o.constructor)==null?void 0:r.name}`),o.addEventListener("sourceopen",this._onMediaSourceOpen),o.addEventListener("sourceended",this._onMediaSourceEnded),o.addEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(o.addEventListener("startstreaming",this._onStartStreaming),o.addEventListener("endstreaming",this._onEndStreaming));const a=this._objectUrl=self.URL.createObjectURL(o);if(this.appendSource)try{i.removeAttribute("src");const c=self.ManagedMediaSource;i.disableRemotePlayback=i.disableRemotePlayback||c&&o instanceof c,hA(i),t8(i,a),i.load()}catch{i.src=a}else i.src=a;i.addEventListener("emptied",this._onMediaEmptied)}}onMediaDetaching(){const{media:e,mediaSource:t,_objectUrl:i}=this;if(t){if(this.log("media source detaching"),t.readyState==="open")try{t.endOfStream()}catch(s){this.warn(`onMediaDetaching: ${s.message} while calling endOfStream`)}this.onBufferReset(),t.removeEventListener("sourceopen",this._onMediaSourceOpen),t.removeEventListener("sourceended",this._onMediaSourceEnded),t.removeEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(t.removeEventListener("startstreaming",this._onStartStreaming),t.removeEventListener("endstreaming",this._onEndStreaming)),e&&(e.removeEventListener("emptied",this._onMediaEmptied),i&&self.URL.revokeObjectURL(i),this.mediaSrc===i?(e.removeAttribute("src"),this.appendSource&&hA(e),e.load()):this.warn("media|source.src was changed by a third party - skip cleanup")),this.mediaSource=null,this.media=null,this._objectUrl=null,this.bufferCodecEventsExpected=this._bufferCodecEventsTotal,this.pendingTracks={},this.tracks={}}this.hls.trigger(D.MEDIA_DETACHED,void 0)}onBufferReset(){this.getSourceBufferTypes().forEach(e=>{this.resetBuffer(e)}),this._initSourceBuffer()}resetBuffer(e){const t=this.sourceBuffer[e];try{if(t){var i;this.removeBufferListeners(e),this.sourceBuffer[e]=void 0,(i=this.mediaSource)!=null&&i.sourceBuffers.length&&this.mediaSource.removeSourceBuffer(t)}}catch(s){this.warn(`onBufferReset ${e}`,s)}}onBufferCodecs(e,t){const i=this.getSourceBufferTypes().length,s=Object.keys(t);if(s.forEach(o=>{if(i){const c=this.tracks[o];if(c&&typeof c.buffer.changeType=="function"){var a;const{id:l,codec:u,levelCodec:h,container:f,metadata:d}=t[o],p=L0(c.codec,c.levelCodec),m=p==null?void 0:p.replace(uA,"$1");let g=L0(u,h);const y=(a=g)==null?void 0:a.replace(uA,"$1");if(g&&m!==y){o.slice(0,5)==="audio"&&(g=Ec(g,this.appendSource));const v=`${f};codecs=${g}`;this.appendChangeType(o,v),this.log(`switching codec ${p} to ${g}`),this.tracks[o]={buffer:c.buffer,codec:u,container:f,levelCodec:h,metadata:d,id:l}}}}else this.pendingTracks[o]=t[o]}),i)return;const r=Math.max(this.bufferCodecEventsExpected-1,0);this.bufferCodecEventsExpected!==r&&(this.log(`${r} bufferCodec event(s) expected ${s.join(",")}`),this.bufferCodecEventsExpected=r),this.mediaSource&&this.mediaSource.readyState==="open"&&this.checkPendingTracks()}appendChangeType(e,t){const{operationQueue:i}=this,s={execute:()=>{const r=this.sourceBuffer[e];r&&(this.log(`changing ${e} sourceBuffer type to ${t}`),r.changeType(t)),i.shiftAndExecuteNext(e)},onStart:()=>{},onComplete:()=>{},onError:r=>{this.warn(`Failed to change ${e} SourceBuffer type`,r)}};i.append(s,e,!!this.pendingTracks[e])}onBufferAppending(e,t){const{hls:i,operationQueue:s,tracks:r}=this,{data:o,type:a,frag:c,part:l,chunkMeta:u}=t,h=u.buffering[a],f=self.performance.now();h.start=f;const d=c.stats.buffering,p=l?l.stats.buffering:null;d.start===0&&(d.start=f),p&&p.start===0&&(p.start=f);const m=r.audio;let g=!1;a==="audio"&&(m==null?void 0:m.container)==="audio/mpeg"&&(g=!this.lastMpegAudioChunk||u.id===1||this.lastMpegAudioChunk.sn!==u.sn,this.lastMpegAudioChunk=u);const y=c.start,v={execute:()=>{if(h.executeStart=self.performance.now(),g){const E=this.sourceBuffer[a];if(E){const C=y-E.timestampOffset;Math.abs(C)>=.1&&(this.log(`Updating audio SourceBuffer timestampOffset to ${y} (delta: ${C}) sn: ${c.sn})`),E.timestampOffset=y)}}this.appendExecutor(o,a)},onStart:()=>{},onComplete:()=>{const E=self.performance.now();h.executeEnd=h.end=E,d.first===0&&(d.first=E),p&&p.first===0&&(p.first=E);const{sourceBuffer:C}=this,x={};for(const I in C)x[I]=Ze.getBuffered(C[I]);this.appendErrors[a]=0,a==="audio"||a==="video"?this.appendErrors.audiovideo=0:(this.appendErrors.audio=0,this.appendErrors.video=0),this.hls.trigger(D.BUFFER_APPENDED,{type:a,frag:c,part:l,chunkMeta:u,parent:c.type,timeRanges:x})},onError:E=>{const C={type:_e.MEDIA_ERROR,parent:c.type,details:te.BUFFER_APPEND_ERROR,sourceBufferName:a,frag:c,part:l,chunkMeta:u,error:E,err:E,fatal:!1};if(E.code===DOMException.QUOTA_EXCEEDED_ERR)C.details=te.BUFFER_FULL_ERROR;else{const x=++this.appendErrors[a];C.details=te.BUFFER_APPEND_ERROR,this.warn(`Failed ${x}/${i.config.appendErrorMaxRetry} times to append segment in "${a}" sourceBuffer`),x>=i.config.appendErrorMaxRetry&&(C.fatal=!0)}i.trigger(D.ERROR,C)}};s.append(v,a,!!this.pendingTracks[a])}onBufferFlushing(e,t){const{operationQueue:i}=this,s=r=>({execute:this.removeExecutor.bind(this,r,t.startOffset,t.endOffset),onStart:()=>{},onComplete:()=>{this.hls.trigger(D.BUFFER_FLUSHED,{type:r})},onError:o=>{this.warn(`Failed to remove from ${r} SourceBuffer`,o)}});t.type?i.append(s(t.type),t.type):this.getSourceBufferTypes().forEach(r=>{i.append(s(r),r)})}onFragParsed(e,t){const{frag:i,part:s}=t,r=[],o=s?s.elementaryStreams:i.elementaryStreams;o[$e.AUDIOVIDEO]?r.push("audiovideo"):(o[$e.AUDIO]&&r.push("audio"),o[$e.VIDEO]&&r.push("video"));const a=()=>{const c=self.performance.now();i.stats.buffering.end=c,s&&(s.stats.buffering.end=c);const l=s?s.stats:i.stats;this.hls.trigger(D.FRAG_BUFFERED,{frag:i,part:s,stats:l,id:i.type})};r.length===0&&this.warn(`Fragments must have at least one ElementaryStreamType set. type: ${i.type} level: ${i.level} sn: ${i.sn}`),this.blockBuffers(a,r)}onFragChanged(e,t){this.trimBuffers()}onBufferEos(e,t){this.getSourceBufferTypes().reduce((s,r)=>{const o=this.sourceBuffer[r];return o&&(!t.type||t.type===r)&&(o.ending=!0,o.ended||(o.ended=!0,this.log(`${r} sourceBuffer now EOS`))),s&&!!(!o||o.ended)},!0)&&(this.log("Queueing mediaSource.endOfStream()"),this.blockBuffers(()=>{this.getSourceBufferTypes().forEach(r=>{const o=this.sourceBuffer[r];o&&(o.ending=!1)});const{mediaSource:s}=this;if(!s||s.readyState!=="open"){s&&this.log(`Could not call mediaSource.endOfStream(). mediaSource.readyState: ${s.readyState}`);return}this.log("Calling mediaSource.endOfStream()"),s.endOfStream()}))}onLevelUpdated(e,{details:t}){t.fragments.length&&(this.details=t,this.getSourceBufferTypes().length?this.blockBuffers(this.updateMediaElementDuration.bind(this)):this.updateMediaElementDuration())}trimBuffers(){const{hls:e,details:t,media:i}=this;if(!i||t===null||!this.getSourceBufferTypes().length)return;const r=e.config,o=i.currentTime,a=t.levelTargetDuration,c=t.live&&r.liveBackBufferLength!==null?r.liveBackBufferLength:r.backBufferLength;if(ve(c)&&c>0){const l=Math.max(c,a),u=Math.floor(o/a)*a-l;this.flushBackBuffer(o,a,u)}if(ve(r.frontBufferFlushThreshold)&&r.frontBufferFlushThreshold>0){const l=Math.max(r.maxBufferLength,r.frontBufferFlushThreshold),u=Math.max(l,a),h=Math.floor(o/a)*a+u;this.flushFrontBuffer(o,a,h)}}flushBackBuffer(e,t,i){const{details:s,sourceBuffer:r}=this;this.getSourceBufferTypes().forEach(a=>{const c=r[a];if(c){const l=Ze.getBuffered(c);if(l.length>0&&i>l.start(0)){if(this.hls.trigger(D.BACK_BUFFER_REACHED,{bufferEnd:i}),s!=null&&s.live)this.hls.trigger(D.LIVE_BACK_BUFFER_REACHED,{bufferEnd:i});else if(c.ended&&l.end(l.length-1)-e<t*2){this.log(`Cannot flush ${a} back buffer while SourceBuffer is in ended state`);return}this.hls.trigger(D.BUFFER_FLUSHING,{startOffset:0,endOffset:i,type:a})}}})}flushFrontBuffer(e,t,i){const{sourceBuffer:s}=this;this.getSourceBufferTypes().forEach(o=>{const a=s[o];if(a){const c=Ze.getBuffered(a),l=c.length;if(l<2)return;const u=c.start(l-1),h=c.end(l-1);if(i>u||e>=u&&e<=h)return;if(a.ended&&e-h<2*t){this.log(`Cannot flush ${o} front buffer while SourceBuffer is in ended state`);return}this.hls.trigger(D.BUFFER_FLUSHING,{startOffset:u,endOffset:1/0,type:o})}})}updateMediaElementDuration(){if(!this.details||!this.media||!this.mediaSource||this.mediaSource.readyState!=="open")return;const{details:e,hls:t,media:i,mediaSource:s}=this,r=e.fragments[0].start+e.totalduration,o=i.duration,a=ve(s.duration)?s.duration:0;e.live&&t.config.liveDurationInfinity?(s.duration=1/0,this.updateSeekableRange(e)):(r>a&&r>o||!ve(o))&&(this.log(`Updating Media Source duration to ${r.toFixed(3)}`),s.duration=r)}updateSeekableRange(e){const t=this.mediaSource,i=e.fragments;if(i.length&&e.live&&t!=null&&t.setLiveSeekableRange){const r=Math.max(0,i[0].start),o=Math.max(r,r+e.totalduration);this.log(`Media Source duration is set to ${t.duration}. Setting seekable range to ${r}-${o}.`),t.setLiveSeekableRange(r,o)}}checkPendingTracks(){const{bufferCodecEventsExpected:e,operationQueue:t,pendingTracks:i}=this,s=Object.keys(i).length;if(s&&(!e||s===2||"audiovideo"in i)){this.createSourceBuffers(i),this.pendingTracks={};const r=this.getSourceBufferTypes();if(r.length)this.hls.trigger(D.BUFFER_CREATED,{tracks:this.tracks}),r.forEach(o=>{t.executeNext(o)});else{const o=new Error("could not create source buffer for media codec(s)");this.hls.trigger(D.ERROR,{type:_e.MEDIA_ERROR,details:te.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,error:o,reason:o.message})}}}createSourceBuffers(e){const{sourceBuffer:t,mediaSource:i}=this;if(!i)throw Error("createSourceBuffers called when mediaSource was null");for(const r in e)if(!t[r]){var s;const o=e[r];if(!o)throw Error(`source buffer exists for track ${r}, however track does not`);let a=((s=o.levelCodec)==null?void 0:s.indexOf(","))===-1?o.levelCodec:o.codec;a&&r.slice(0,5)==="audio"&&(a=Ec(a,this.appendSource));const c=`${o.container};codecs=${a}`;this.log(`creating sourceBuffer(${c})`);try{const l=t[r]=i.addSourceBuffer(c),u=r;this.addBufferListener(u,"updatestart",this._onSBUpdateStart),this.addBufferListener(u,"updateend",this._onSBUpdateEnd),this.addBufferListener(u,"error",this._onSBUpdateError),this.appendSource&&this.addBufferListener(u,"bufferedchange",(h,f)=>{const d=f.removedRanges;d!=null&&d.length&&this.hls.trigger(D.BUFFER_FLUSHED,{type:r})}),this.tracks[r]={buffer:l,codec:a,container:o.container,levelCodec:o.levelCodec,metadata:o.metadata,id:o.id}}catch(l){this.error(`error while trying to add sourceBuffer: ${l.message}`),this.hls.trigger(D.ERROR,{type:_e.MEDIA_ERROR,details:te.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:l,sourceBufferName:r,mimeType:c})}}}get mediaSrc(){var e,t;const i=((e=this.media)==null||(t=e.querySelector)==null?void 0:t.call(e,"source"))||this.media;return i==null?void 0:i.src}_onSBUpdateStart(e){const{operationQueue:t}=this;t.current(e).onStart()}_onSBUpdateEnd(e){var t;if(((t=this.mediaSource)==null?void 0:t.readyState)==="closed"){this.resetBuffer(e);return}const{operationQueue:i}=this;i.current(e).onComplete(),i.shiftAndExecuteNext(e)}_onSBUpdateError(e,t){var i;const s=new Error(`${e} SourceBuffer error. MediaSource readyState: ${(i=this.mediaSource)==null?void 0:i.readyState}`);this.error(`${s}`,t),this.hls.trigger(D.ERROR,{type:_e.MEDIA_ERROR,details:te.BUFFER_APPENDING_ERROR,sourceBufferName:e,error:s,fatal:!1});const r=this.operationQueue.current(e);r&&r.onError(s)}removeExecutor(e,t,i){const{media:s,mediaSource:r,operationQueue:o,sourceBuffer:a}=this,c=a[e];if(!s||!r||!c){this.warn(`Attempting to remove from the ${e} SourceBuffer, but it does not exist`),o.shiftAndExecuteNext(e);return}const l=ve(s.duration)?s.duration:1/0,u=ve(r.duration)?r.duration:1/0,h=Math.max(0,t),f=Math.min(i,l,u);f>h&&(!c.ending||c.ended)?(c.ended=!1,this.log(`Removing [${h},${f}] from the ${e} SourceBuffer`),c.remove(h,f)):o.shiftAndExecuteNext(e)}appendExecutor(e,t){const i=this.sourceBuffer[t];if(!i){if(!this.pendingTracks[t])throw new Error(`Attempting to append to the ${t} SourceBuffer, but it does not exist`);return}i.ended=!1,i.appendBuffer(e)}blockBuffers(e,t=this.getSourceBufferTypes()){if(!t.length){this.log("Blocking operation requested, but no SourceBuffers exist"),Promise.resolve().then(e);return}const{operationQueue:i}=this,s=t.map(r=>i.appendBlocker(r));Promise.all(s).then(()=>{e(),t.forEach(r=>{const o=this.sourceBuffer[r];o!=null&&o.updating||i.shiftAndExecuteNext(r)})})}getSourceBufferTypes(){return Object.keys(this.sourceBuffer)}addBufferListener(e,t,i){const s=this.sourceBuffer[e];if(!s)return;const r=i.bind(this,e);this.listeners[e].push({event:t,listener:r}),s.addEventListener(t,r)}removeBufferListeners(e){const t=this.sourceBuffer[e];t&&this.listeners[e].forEach(i=>{t.removeEventListener(i.event,i.listener)})}}function hA(n){const e=n.querySelectorAll("source");[].slice.call(e).forEach(t=>{n.removeChild(t)})}function t8(n,e){const t=self.document.createElement("source");t.type="video/mp4",t.src=e,n.appendChild(t)}const i8={42:225,92:233,94:237,95:243,96:250,123:231,124:247,125:209,126:241,127:9608,128:174,129:176,130:189,131:191,132:8482,133:162,134:163,135:9834,136:224,137:32,138:232,139:226,140:234,141:238,142:244,143:251,144:193,145:201,146:211,147:218,148:220,149:252,150:8216,151:161,152:42,153:8217,154:9473,155:169,156:8480,157:8226,158:8220,159:8221,160:192,161:194,162:199,163:200,164:202,165:203,166:235,167:206,168:207,169:239,170:212,171:217,172:249,173:219,174:171,175:187,176:195,177:227,178:205,179:204,180:236,181:210,182:242,183:213,184:245,185:123,186:125,187:92,188:94,189:95,190:124,191:8764,192:196,193:228,194:214,195:246,196:223,197:165,198:164,199:9475,200:197,201:229,202:216,203:248,204:9487,205:9491,206:9495,207:9499},Lg=n=>String.fromCharCode(i8[n]||n),Ui=15,ms=100,s8={17:1,18:3,21:5,22:7,23:9,16:11,19:12,20:14},n8={17:2,18:4,21:6,22:8,23:10,19:13,20:15},r8={25:1,26:3,29:5,30:7,31:9,24:11,27:12,28:14},o8={25:2,26:4,29:6,30:8,31:10,27:13,28:15},a8=["white","green","blue","cyan","red","yellow","magenta","black","transparent"];class c8{constructor(){this.time=null,this.verboseLevel=0}log(e,t){if(this.verboseLevel>=e){const i=typeof t=="function"?t():t;j.log(`${this.time} [${e}] ${i}`)}}}const Xs=function(e){const t=[];for(let i=0;i<e.length;i++)t.push(e[i].toString(16));return t};class Pg{constructor(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}reset(){this.foreground="white",this.underline=!1,this.italics=!1,this.background="black",this.flash=!1}setStyles(e){const t=["foreground","underline","italics","background","flash"];for(let i=0;i<t.length;i++){const s=t[i];e.hasOwnProperty(s)&&(this[s]=e[s])}}isDefault(){return this.foreground==="white"&&!this.underline&&!this.italics&&this.background==="black"&&!this.flash}equals(e){return this.foreground===e.foreground&&this.underline===e.underline&&this.italics===e.italics&&this.background===e.background&&this.flash===e.flash}copy(e){this.foreground=e.foreground,this.underline=e.underline,this.italics=e.italics,this.background=e.background,this.flash=e.flash}toString(){return"color="+this.foreground+", underline="+this.underline+", italics="+this.italics+", background="+this.background+", flash="+this.flash}}class l8{constructor(){this.uchar=" ",this.penState=new Pg}reset(){this.uchar=" ",this.penState.reset()}setChar(e,t){this.uchar=e,this.penState.copy(t)}setPenState(e){this.penState.copy(e)}equals(e){return this.uchar===e.uchar&&this.penState.equals(e.penState)}copy(e){this.uchar=e.uchar,this.penState.copy(e.penState)}isEmpty(){return this.uchar===" "&&this.penState.isDefault()}}class u8{constructor(e){this.chars=[],this.pos=0,this.currPenState=new Pg,this.cueStartTime=null,this.logger=void 0;for(let t=0;t<ms;t++)this.chars.push(new l8);this.logger=e}equals(e){for(let t=0;t<ms;t++)if(!this.chars[t].equals(e.chars[t]))return!1;return!0}copy(e){for(let t=0;t<ms;t++)this.chars[t].copy(e.chars[t])}isEmpty(){let e=!0;for(let t=0;t<ms;t++)if(!this.chars[t].isEmpty()){e=!1;break}return e}setCursor(e){this.pos!==e&&(this.pos=e),this.pos<0?(this.logger.log(3,"Negative cursor position "+this.pos),this.pos=0):this.pos>ms&&(this.logger.log(3,"Too large cursor position "+this.pos),this.pos=ms)}moveCursor(e){const t=this.pos+e;if(e>1)for(let i=this.pos+1;i<t+1;i++)this.chars[i].setPenState(this.currPenState);this.setCursor(t)}backSpace(){this.moveCursor(-1),this.chars[this.pos].setChar(" ",this.currPenState)}insertChar(e){e>=144&&this.backSpace();const t=Lg(e);if(this.pos>=ms){this.logger.log(0,()=>"Cannot insert "+e.toString(16)+" ("+t+") at position "+this.pos+". Skipping it!");return}this.chars[this.pos].setChar(t,this.currPenState),this.moveCursor(1)}clearFromPos(e){let t;for(t=e;t<ms;t++)this.chars[t].reset()}clear(){this.clearFromPos(0),this.pos=0,this.currPenState.reset()}clearToEndOfRow(){this.clearFromPos(this.pos)}getTextString(){const e=[];let t=!0;for(let i=0;i<ms;i++){const s=this.chars[i].uchar;s!==" "&&(t=!1),e.push(s)}return t?"":e.join("")}setPenStyles(e){this.currPenState.setStyles(e),this.chars[this.pos].setPenState(this.currPenState)}}class Zl{constructor(e){this.rows=[],this.currRow=Ui-1,this.nrRollUpRows=null,this.lastOutputScreen=null,this.logger=void 0;for(let t=0;t<Ui;t++)this.rows.push(new u8(e));this.logger=e}reset(){for(let e=0;e<Ui;e++)this.rows[e].clear();this.currRow=Ui-1}equals(e){let t=!0;for(let i=0;i<Ui;i++)if(!this.rows[i].equals(e.rows[i])){t=!1;break}return t}copy(e){for(let t=0;t<Ui;t++)this.rows[t].copy(e.rows[t])}isEmpty(){let e=!0;for(let t=0;t<Ui;t++)if(!this.rows[t].isEmpty()){e=!1;break}return e}backSpace(){this.rows[this.currRow].backSpace()}clearToEndOfRow(){this.rows[this.currRow].clearToEndOfRow()}insertChar(e){this.rows[this.currRow].insertChar(e)}setPen(e){this.rows[this.currRow].setPenStyles(e)}moveCursor(e){this.rows[this.currRow].moveCursor(e)}setCursor(e){this.logger.log(2,"setCursor: "+e),this.rows[this.currRow].setCursor(e)}setPAC(e){this.logger.log(2,()=>"pacData = "+JSON.stringify(e));let t=e.row-1;if(this.nrRollUpRows&&t<this.nrRollUpRows-1&&(t=this.nrRollUpRows-1),this.nrRollUpRows&&this.currRow!==t){for(let a=0;a<Ui;a++)this.rows[a].clear();const r=this.currRow+1-this.nrRollUpRows,o=this.lastOutputScreen;if(o){const a=o.rows[r].cueStartTime,c=this.logger.time;if(a!==null&&c!==null&&a<c)for(let l=0;l<this.nrRollUpRows;l++)this.rows[t-this.nrRollUpRows+l+1].copy(o.rows[r+l])}}this.currRow=t;const i=this.rows[this.currRow];if(e.indent!==null){const r=e.indent,o=Math.max(r-1,0);i.setCursor(e.indent),e.color=i.chars[o].penState.foreground}const s={foreground:e.color,underline:e.underline,italics:e.italics,background:"black",flash:!1};this.setPen(s)}setBkgData(e){this.logger.log(2,()=>"bkgData = "+JSON.stringify(e)),this.backSpace(),this.setPen(e),this.insertChar(32)}setRollUpRows(e){this.nrRollUpRows=e}rollUp(){if(this.nrRollUpRows===null){this.logger.log(3,"roll_up but nrRollUpRows not set yet");return}this.logger.log(1,()=>this.getDisplayText());const e=this.currRow+1-this.nrRollUpRows,t=this.rows.splice(e,1)[0];t.clear(),this.rows.splice(this.currRow,0,t),this.logger.log(2,"Rolling up")}getDisplayText(e){e=e||!1;const t=[];let i="",s=-1;for(let r=0;r<Ui;r++){const o=this.rows[r].getTextString();o&&(s=r+1,e?t.push("Row "+s+": '"+o+"'"):t.push(o.trim()))}return t.length>0&&(e?i="["+t.join(" | ")+"]":i=t.join(`
`)),i}getTextAndFormat(){return this.rows}}class fA{constructor(e,t,i){this.chNr=void 0,this.outputFilter=void 0,this.mode=void 0,this.verbose=void 0,this.displayedMemory=void 0,this.nonDisplayedMemory=void 0,this.lastOutputScreen=void 0,this.currRollUpRow=void 0,this.writeScreen=void 0,this.cueStartTime=void 0,this.logger=void 0,this.chNr=e,this.outputFilter=t,this.mode=null,this.verbose=0,this.displayedMemory=new Zl(i),this.nonDisplayedMemory=new Zl(i),this.lastOutputScreen=new Zl(i),this.currRollUpRow=this.displayedMemory.rows[Ui-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null,this.logger=i}reset(){this.mode=null,this.displayedMemory.reset(),this.nonDisplayedMemory.reset(),this.lastOutputScreen.reset(),this.outputFilter.reset(),this.currRollUpRow=this.displayedMemory.rows[Ui-1],this.writeScreen=this.displayedMemory,this.mode=null,this.cueStartTime=null}getHandler(){return this.outputFilter}setHandler(e){this.outputFilter=e}setPAC(e){this.writeScreen.setPAC(e)}setBkgData(e){this.writeScreen.setBkgData(e)}setMode(e){e!==this.mode&&(this.mode=e,this.logger.log(2,()=>"MODE="+e),this.mode==="MODE_POP-ON"?this.writeScreen=this.nonDisplayedMemory:(this.writeScreen=this.displayedMemory,this.writeScreen.reset()),this.mode!=="MODE_ROLL-UP"&&(this.displayedMemory.nrRollUpRows=null,this.nonDisplayedMemory.nrRollUpRows=null),this.mode=e)}insertChars(e){for(let i=0;i<e.length;i++)this.writeScreen.insertChar(e[i]);const t=this.writeScreen===this.displayedMemory?"DISP":"NON_DISP";this.logger.log(2,()=>t+": "+this.writeScreen.getDisplayText(!0)),(this.mode==="MODE_PAINT-ON"||this.mode==="MODE_ROLL-UP")&&(this.logger.log(1,()=>"DISPLAYED: "+this.displayedMemory.getDisplayText(!0)),this.outputDataUpdate())}ccRCL(){this.logger.log(2,"RCL - Resume Caption Loading"),this.setMode("MODE_POP-ON")}ccBS(){this.logger.log(2,"BS - BackSpace"),this.mode!=="MODE_TEXT"&&(this.writeScreen.backSpace(),this.writeScreen===this.displayedMemory&&this.outputDataUpdate())}ccAOF(){}ccAON(){}ccDER(){this.logger.log(2,"DER- Delete to End of Row"),this.writeScreen.clearToEndOfRow(),this.outputDataUpdate()}ccRU(e){this.logger.log(2,"RU("+e+") - Roll Up"),this.writeScreen=this.displayedMemory,this.setMode("MODE_ROLL-UP"),this.writeScreen.setRollUpRows(e)}ccFON(){this.logger.log(2,"FON - Flash On"),this.writeScreen.setPen({flash:!0})}ccRDC(){this.logger.log(2,"RDC - Resume Direct Captioning"),this.setMode("MODE_PAINT-ON")}ccTR(){this.logger.log(2,"TR"),this.setMode("MODE_TEXT")}ccRTD(){this.logger.log(2,"RTD"),this.setMode("MODE_TEXT")}ccEDM(){this.logger.log(2,"EDM - Erase Displayed Memory"),this.displayedMemory.reset(),this.outputDataUpdate(!0)}ccCR(){this.logger.log(2,"CR - Carriage Return"),this.writeScreen.rollUp(),this.outputDataUpdate(!0)}ccENM(){this.logger.log(2,"ENM - Erase Non-displayed Memory"),this.nonDisplayedMemory.reset()}ccEOC(){if(this.logger.log(2,"EOC - End Of Caption"),this.mode==="MODE_POP-ON"){const e=this.displayedMemory;this.displayedMemory=this.nonDisplayedMemory,this.nonDisplayedMemory=e,this.writeScreen=this.nonDisplayedMemory,this.logger.log(1,()=>"DISP: "+this.displayedMemory.getDisplayText())}this.outputDataUpdate(!0)}ccTO(e){this.logger.log(2,"TO("+e+") - Tab Offset"),this.writeScreen.moveCursor(e)}ccMIDROW(e){const t={flash:!1};if(t.underline=e%2===1,t.italics=e>=46,t.italics)t.foreground="white";else{const i=Math.floor(e/2)-16,s=["white","green","blue","cyan","red","yellow","magenta"];t.foreground=s[i]}this.logger.log(2,"MIDROW: "+JSON.stringify(t)),this.writeScreen.setPen(t)}outputDataUpdate(e=!1){const t=this.logger.time;t!==null&&this.outputFilter&&(this.cueStartTime===null&&!this.displayedMemory.isEmpty()?this.cueStartTime=t:this.displayedMemory.equals(this.lastOutputScreen)||(this.outputFilter.newCue(this.cueStartTime,t,this.lastOutputScreen),e&&this.outputFilter.dispatchCue&&this.outputFilter.dispatchCue(),this.cueStartTime=this.displayedMemory.isEmpty()?null:t),this.lastOutputScreen.copy(this.displayedMemory))}cueSplitAtTime(e){this.outputFilter&&(this.displayedMemory.isEmpty()||(this.outputFilter.newCue&&this.outputFilter.newCue(this.cueStartTime,e,this.displayedMemory),this.cueStartTime=e))}}class dA{constructor(e,t,i){this.channels=void 0,this.currentChannel=0,this.cmdHistory=f8(),this.logger=void 0;const s=this.logger=new c8;this.channels=[null,new fA(e,t,s),new fA(e+1,i,s)]}getHandler(e){return this.channels[e].getHandler()}setHandler(e,t){this.channels[e].setHandler(t)}addData(e,t){this.logger.time=e;for(let i=0;i<t.length;i+=2){const s=t[i]&127,r=t[i+1]&127;let o=!1,a=null;if(s===0&&r===0)continue;this.logger.log(3,()=>"["+Xs([t[i],t[i+1]])+"] -> ("+Xs([s,r])+")");const c=this.cmdHistory;if(s>=16&&s<=31){if(h8(s,r,c)){ma(null,null,c),this.logger.log(3,()=>"Repeated command ("+Xs([s,r])+") is dropped");continue}ma(s,r,this.cmdHistory),o=this.parseCmd(s,r),o||(o=this.parseMidrow(s,r)),o||(o=this.parsePAC(s,r)),o||(o=this.parseBackgroundAttributes(s,r))}else ma(null,null,c);if(!o&&(a=this.parseChars(s,r),a)){const u=this.currentChannel;u&&u>0?this.channels[u].insertChars(a):this.logger.log(2,"No channel found yet. TEXT-MODE?")}!o&&!a&&this.logger.log(2,()=>"Couldn't parse cleaned data "+Xs([s,r])+" orig: "+Xs([t[i],t[i+1]]))}}parseCmd(e,t){const i=(e===20||e===28||e===21||e===29)&&t>=32&&t<=47,s=(e===23||e===31)&&t>=33&&t<=35;if(!(i||s))return!1;const r=e===20||e===21||e===23?1:2,o=this.channels[r];return e===20||e===21||e===28||e===29?t===32?o.ccRCL():t===33?o.ccBS():t===34?o.ccAOF():t===35?o.ccAON():t===36?o.ccDER():t===37?o.ccRU(2):t===38?o.ccRU(3):t===39?o.ccRU(4):t===40?o.ccFON():t===41?o.ccRDC():t===42?o.ccTR():t===43?o.ccRTD():t===44?o.ccEDM():t===45?o.ccCR():t===46?o.ccENM():t===47&&o.ccEOC():o.ccTO(t-32),this.currentChannel=r,!0}parseMidrow(e,t){let i=0;if((e===17||e===25)&&t>=32&&t<=47){if(e===17?i=1:i=2,i!==this.currentChannel)return this.logger.log(0,"Mismatch channel in midrow parsing"),!1;const s=this.channels[i];return s?(s.ccMIDROW(t),this.logger.log(3,()=>"MIDROW ("+Xs([e,t])+")"),!0):!1}return!1}parsePAC(e,t){let i;const s=(e>=17&&e<=23||e>=25&&e<=31)&&t>=64&&t<=127,r=(e===16||e===24)&&t>=64&&t<=95;if(!(s||r))return!1;const o=e<=23?1:2;t>=64&&t<=95?i=o===1?s8[e]:r8[e]:i=o===1?n8[e]:o8[e];const a=this.channels[o];return a?(a.setPAC(this.interpretPAC(i,t)),this.currentChannel=o,!0):!1}interpretPAC(e,t){let i;const s={color:null,italics:!1,indent:null,underline:!1,row:e};return t>95?i=t-96:i=t-64,s.underline=(i&1)===1,i<=13?s.color=["white","green","blue","cyan","red","yellow","magenta","white"][Math.floor(i/2)]:i<=15?(s.italics=!0,s.color="white"):s.indent=Math.floor((i-16)/2)*4,s}parseChars(e,t){let i,s=null,r=null;if(e>=25?(i=2,r=e-8):(i=1,r=e),r>=17&&r<=19){let o;r===17?o=t+80:r===18?o=t+112:o=t+144,this.logger.log(2,()=>"Special char '"+Lg(o)+"' in channel "+i),s=[o]}else e>=32&&e<=127&&(s=t===0?[e]:[e,t]);return s&&this.logger.log(3,()=>"Char codes =  "+Xs(s).join(",")),s}parseBackgroundAttributes(e,t){const i=(e===16||e===24)&&t>=32&&t<=47,s=(e===23||e===31)&&t>=45&&t<=47;if(!(i||s))return!1;let r;const o={};e===16||e===24?(r=Math.floor((t-32)/2),o.background=a8[r],t%2===1&&(o.background=o.background+"_semi")):t===45?o.background="transparent":(o.foreground="black",t===47&&(o.underline=!0));const a=e<=23?1:2;return this.channels[a].setBkgData(o),!0}reset(){for(let e=0;e<Object.keys(this.channels).length;e++){const t=this.channels[e];t&&t.reset()}ma(null,null,this.cmdHistory)}cueSplitAtTime(e){for(let t=0;t<this.channels.length;t++){const i=this.channels[t];i&&i.cueSplitAtTime(e)}}}function ma(n,e,t){t.a=n,t.b=e}function h8(n,e,t){return t.a===n&&t.b===e}function f8(){return{a:null,b:null}}class pa{constructor(e,t){this.timelineController=void 0,this.cueRanges=[],this.trackName=void 0,this.startTime=null,this.endTime=null,this.screen=null,this.timelineController=e,this.trackName=t}dispatchCue(){this.startTime!==null&&(this.timelineController.addCues(this.trackName,this.startTime,this.endTime,this.screen,this.cueRanges),this.startTime=null)}newCue(e,t,i){(this.startTime===null||this.startTime>e)&&(this.startTime=e),this.endTime=t,this.screen=i,this.timelineController.createCaptionsTrack(this.trackName)}reset(){this.cueRanges=[],this.startTime=null}}var gf=function(){if(pr!=null&&pr.VTTCue)return self.VTTCue;const n=["","lr","rl"],e=["start","middle","end","left","right"];function t(a,c){if(typeof c!="string"||!Array.isArray(a))return!1;const l=c.toLowerCase();return~a.indexOf(l)?l:!1}function i(a){return t(n,a)}function s(a){return t(e,a)}function r(a,...c){let l=1;for(;l<arguments.length;l++){const u=arguments[l];for(const h in u)a[h]=u[h]}return a}function o(a,c,l){const u=this,h={enumerable:!0};u.hasBeenReset=!1;let f="",d=!1,p=a,m=c,g=l,y=null,v="",E=!0,C="auto",x="start",I=50,S="middle",w=50,B="middle";Object.defineProperty(u,"id",r({},h,{get:function(){return f},set:function(T){f=""+T}})),Object.defineProperty(u,"pauseOnExit",r({},h,{get:function(){return d},set:function(T){d=!!T}})),Object.defineProperty(u,"startTime",r({},h,{get:function(){return p},set:function(T){if(typeof T!="number")throw new TypeError("Start time must be set to a number.");p=T,this.hasBeenReset=!0}})),Object.defineProperty(u,"endTime",r({},h,{get:function(){return m},set:function(T){if(typeof T!="number")throw new TypeError("End time must be set to a number.");m=T,this.hasBeenReset=!0}})),Object.defineProperty(u,"text",r({},h,{get:function(){return g},set:function(T){g=""+T,this.hasBeenReset=!0}})),Object.defineProperty(u,"region",r({},h,{get:function(){return y},set:function(T){y=T,this.hasBeenReset=!0}})),Object.defineProperty(u,"vertical",r({},h,{get:function(){return v},set:function(T){const R=i(T);if(R===!1)throw new SyntaxError("An invalid or illegal string was specified.");v=R,this.hasBeenReset=!0}})),Object.defineProperty(u,"snapToLines",r({},h,{get:function(){return E},set:function(T){E=!!T,this.hasBeenReset=!0}})),Object.defineProperty(u,"line",r({},h,{get:function(){return C},set:function(T){if(typeof T!="number"&&T!=="auto")throw new SyntaxError("An invalid number or illegal string was specified.");C=T,this.hasBeenReset=!0}})),Object.defineProperty(u,"lineAlign",r({},h,{get:function(){return x},set:function(T){const R=s(T);if(!R)throw new SyntaxError("An invalid or illegal string was specified.");x=R,this.hasBeenReset=!0}})),Object.defineProperty(u,"position",r({},h,{get:function(){return I},set:function(T){if(T<0||T>100)throw new Error("Position must be between 0 and 100.");I=T,this.hasBeenReset=!0}})),Object.defineProperty(u,"positionAlign",r({},h,{get:function(){return S},set:function(T){const R=s(T);if(!R)throw new SyntaxError("An invalid or illegal string was specified.");S=R,this.hasBeenReset=!0}})),Object.defineProperty(u,"size",r({},h,{get:function(){return w},set:function(T){if(T<0||T>100)throw new Error("Size must be between 0 and 100.");w=T,this.hasBeenReset=!0}})),Object.defineProperty(u,"align",r({},h,{get:function(){return B},set:function(T){const R=s(T);if(!R)throw new SyntaxError("An invalid or illegal string was specified.");B=R,this.hasBeenReset=!0}})),u.displayState=void 0}return o.prototype.getCueAsHTML=function(){return self.WebVTT.convertCueToDOMTree(self,this.text)},o}();class d8{decode(e,t){if(!e)return"";if(typeof e!="string")throw new Error("Error - expected string data.");return decodeURIComponent(encodeURIComponent(e))}}function Fg(n){function e(i,s,r,o){return(i|0)*3600+(s|0)*60+(r|0)+parseFloat(o||0)}const t=n.match(/^(?:(\d+):)?(\d{2}):(\d{2})(\.\d+)?/);return t?parseFloat(t[2])>59?e(t[2],t[3],0,t[4]):e(t[1],t[2],t[3],t[4]):null}class A8{constructor(){this.values=Object.create(null)}set(e,t){!this.get(e)&&t!==""&&(this.values[e]=t)}get(e,t,i){return i?this.has(e)?this.values[e]:t[i]:this.has(e)?this.values[e]:t}has(e){return e in this.values}alt(e,t,i){for(let s=0;s<i.length;++s)if(t===i[s]){this.set(e,t);break}}integer(e,t){/^-?\d+$/.test(t)&&this.set(e,parseInt(t,10))}percent(e,t){if(/^([\d]{1,3})(\.[\d]*)?%$/.test(t)){const i=parseFloat(t);if(i>=0&&i<=100)return this.set(e,i),!0}return!1}}function kg(n,e,t,i){const s=i?n.split(i):[n];for(const r in s){if(typeof s[r]!="string")continue;const o=s[r].split(t);if(o.length!==2)continue;const a=o[0],c=o[1];e(a,c)}}const ph=new gf(0,0,""),ga=ph.align==="middle"?"middle":"center";function m8(n,e,t){const i=n;function s(){const a=Fg(n);if(a===null)throw new Error("Malformed timestamp: "+i);return n=n.replace(/^[^\sa-zA-Z-]+/,""),a}function r(a,c){const l=new A8;kg(a,function(f,d){let p;switch(f){case"region":for(let m=t.length-1;m>=0;m--)if(t[m].id===d){l.set(f,t[m].region);break}break;case"vertical":l.alt(f,d,["rl","lr"]);break;case"line":p=d.split(","),l.integer(f,p[0]),l.percent(f,p[0])&&l.set("snapToLines",!1),l.alt(f,p[0],["auto"]),p.length===2&&l.alt("lineAlign",p[1],["start",ga,"end"]);break;case"position":p=d.split(","),l.percent(f,p[0]),p.length===2&&l.alt("positionAlign",p[1],["start",ga,"end","line-left","line-right","auto"]);break;case"size":l.percent(f,d);break;case"align":l.alt(f,d,["start",ga,"end","left","right"]);break}},/:/,/\s/),c.region=l.get("region",null),c.vertical=l.get("vertical","");let u=l.get("line","auto");u==="auto"&&ph.line===-1&&(u=-1),c.line=u,c.lineAlign=l.get("lineAlign","start"),c.snapToLines=l.get("snapToLines",!0),c.size=l.get("size",100),c.align=l.get("align",ga);let h=l.get("position","auto");h==="auto"&&ph.position===50&&(h=c.align==="start"||c.align==="left"?0:c.align==="end"||c.align==="right"?100:50),c.position=h}function o(){n=n.replace(/^\s+/,"")}if(o(),e.startTime=s(),o(),n.slice(0,3)!=="-->")throw new Error("Malformed time stamp (time stamps must be separated by '-->'): "+i);n=n.slice(3),o(),e.endTime=s(),o(),r(n,e)}function Og(n){return n.replace(/<br(?: \/)?>/gi,`
`)}class p8{constructor(){this.state="INITIAL",this.buffer="",this.decoder=new d8,this.regionList=[],this.cue=null,this.oncue=void 0,this.onparsingerror=void 0,this.onflush=void 0}parse(e){const t=this;e&&(t.buffer+=t.decoder.decode(e,{stream:!0}));function i(){let r=t.buffer,o=0;for(r=Og(r);o<r.length&&r[o]!=="\r"&&r[o]!==`
`;)++o;const a=r.slice(0,o);return r[o]==="\r"&&++o,r[o]===`
`&&++o,t.buffer=r.slice(o),a}function s(r){kg(r,function(o,a){},/:/)}try{let r="";if(t.state==="INITIAL"){if(!/\r\n|\n/.test(t.buffer))return this;r=i();const a=r.match(/^(ï»¿)?WEBVTT([ \t].*)?$/);if(!(a!=null&&a[0]))throw new Error("Malformed WebVTT signature.");t.state="HEADER"}let o=!1;for(;t.buffer;){if(!/\r\n|\n/.test(t.buffer))return this;switch(o?o=!1:r=i(),t.state){case"HEADER":/:/.test(r)?s(r):r||(t.state="ID");continue;case"NOTE":r||(t.state="ID");continue;case"ID":if(/^NOTE($|[ \t])/.test(r)){t.state="NOTE";break}if(!r)continue;if(t.cue=new gf(0,0,""),t.state="CUE",r.indexOf("-->")===-1){t.cue.id=r;continue}case"CUE":if(!t.cue){t.state="BADCUE";continue}try{m8(r,t.cue,t.regionList)}catch{t.cue=null,t.state="BADCUE";continue}t.state="CUETEXT";continue;case"CUETEXT":{const a=r.indexOf("-->")!==-1;if(!r||a&&(o=!0)){t.oncue&&t.cue&&t.oncue(t.cue),t.cue=null,t.state="ID";continue}if(t.cue===null)continue;t.cue.text&&(t.cue.text+=`
`),t.cue.text+=r}continue;case"BADCUE":r||(t.state="ID")}}}catch{t.state==="CUETEXT"&&t.cue&&t.oncue&&t.oncue(t.cue),t.cue=null,t.state=t.state==="INITIAL"?"BADWEBVTT":"BADCUE"}return this}flush(){const e=this;try{if((e.cue||e.state==="HEADER")&&(e.buffer+=`

`,e.parse()),e.state==="INITIAL"||e.state==="BADWEBVTT")throw new Error("Malformed WebVTT signature.")}catch(t){e.onparsingerror&&e.onparsingerror(t)}return e.onflush&&e.onflush(),this}}const g8=/\r\n|\n\r|\n|\r/g,eu=function(e,t,i=0){return e.slice(i,i+t.length)===t},y8=function(e){let t=parseInt(e.slice(-3));const i=parseInt(e.slice(-6,-4)),s=parseInt(e.slice(-9,-7)),r=e.length>9?parseInt(e.substring(0,e.indexOf(":"))):0;if(!ve(t)||!ve(i)||!ve(s)||!ve(r))throw Error(`Malformed X-TIMESTAMP-MAP: Local:${e}`);return t+=1e3*i,t+=60*1e3*s,t+=60*60*1e3*r,t},tu=function(e){let t=5381,i=e.length;for(;i;)t=t*33^e.charCodeAt(--i);return(t>>>0).toString()};function yf(n,e,t){return tu(n.toString())+tu(e.toString())+tu(t)}const E8=function(e,t,i){let s=e[t],r=e[s.prevCC];if(!r||!r.new&&s.new){e.ccOffset=e.presentationOffset=s.start,s.new=!1;return}for(;(o=r)!=null&&o.new;){var o;e.ccOffset+=s.start-r.start,s.new=!1,s=r,r=e[s.prevCC]}e.presentationOffset=i};function v8(n,e,t,i,s,r,o){const a=new p8,c=os(new Uint8Array(n)).trim().replace(g8,`
`).split(`
`),l=[],u=e?z6(e.baseTime,e.timescale):0;let h="00:00.000",f=0,d=0,p,m=!0;a.oncue=function(g){const y=t[i];let v=t.ccOffset;const E=(f-u)/9e4;if(y!=null&&y.new&&(d!==void 0?v=t.ccOffset=y.start:E8(t,i,E)),E){if(!e){p=new Error("Missing initPTS for VTT MPEGTS");return}v=E-t.presentationOffset}const C=g.endTime-g.startTime,x=xi((g.startTime+v-d)*9e4,s*9e4)/9e4;g.startTime=Math.max(x,0),g.endTime=Math.max(x+C,0);const I=g.text.trim();g.text=decodeURIComponent(encodeURIComponent(I)),g.id||(g.id=yf(g.startTime,g.endTime,I)),g.endTime>0&&l.push(g)},a.onparsingerror=function(g){p=g},a.onflush=function(){if(p){o(p);return}r(l)},c.forEach(g=>{if(m)if(eu(g,"X-TIMESTAMP-MAP=")){m=!1,g.slice(16).split(",").forEach(y=>{eu(y,"LOCAL:")?h=y.slice(6):eu(y,"MPEGTS:")&&(f=parseInt(y.slice(7)))});try{d=y8(h)/1e3}catch(y){p=y}return}else g===""&&(m=!1);a.parse(g+`
`)}),a.flush()}const iu="stpp.ttml.im1t",Ug=/^(\d{2,}):(\d{2}):(\d{2}):(\d{2})\.?(\d+)?$/,Qg=/^(\d*(?:\.\d*)?)(h|m|s|ms|f|t)$/,x8={left:"start",center:"center",right:"end",start:"start",end:"end"};function AA(n,e,t,i){const s=Le(new Uint8Array(n),["mdat"]);if(s.length===0){i(new Error("Could not parse IMSC1 mdat"));return}const r=s.map(a=>os(a)),o=G6(e.baseTime,1,e.timescale);try{r.forEach(a=>t(C8(a,o)))}catch(a){i(a)}}function C8(n,e){const s=new DOMParser().parseFromString(n,"text/xml").getElementsByTagName("tt")[0];if(!s)throw new Error("Invalid ttml");const r={frameRate:30,subFrameRate:1,frameRateMultiplier:0,tickRate:0},o=Object.keys(r).reduce((h,f)=>(h[f]=s.getAttribute(`ttp:${f}`)||r[f],h),{}),a=s.getAttribute("xml:space")!=="preserve",c=mA(su(s,"styling","style")),l=mA(su(s,"layout","region")),u=su(s,"body","[begin]");return[].map.call(u,h=>{const f=Ng(h,a);if(!f||!h.hasAttribute("begin"))return null;const d=ru(h.getAttribute("begin"),o),p=ru(h.getAttribute("dur"),o);let m=ru(h.getAttribute("end"),o);if(d===null)throw pA(h);if(m===null){if(p===null)throw pA(h);m=d+p}const g=new gf(d-e,m-e,f);g.id=yf(g.startTime,g.endTime,g.text);const y=l[h.getAttribute("region")],v=c[h.getAttribute("style")],E=I8(y,v,c),{textAlign:C}=E;if(C){const x=x8[C];x&&(g.lineAlign=x),g.align=C}return pt(g,E),g}).filter(h=>h!==null)}function su(n,e,t){const i=n.getElementsByTagName(e)[0];return i?[].slice.call(i.querySelectorAll(t)):[]}function mA(n){return n.reduce((e,t)=>{const i=t.getAttribute("xml:id");return i&&(e[i]=t),e},{})}function Ng(n,e){return[].slice.call(n.childNodes).reduce((t,i,s)=>{var r;return i.nodeName==="br"&&s?t+`
`:(r=i.childNodes)!=null&&r.length?Ng(i,e):e?t+i.textContent.trim().replace(/\s+/g," "):t+i.textContent},"")}function I8(n,e,t){const i="http://www.w3.org/ns/ttml#styling";let s=null;const r=["displayAlign","textAlign","color","backgroundColor","fontSize","fontFamily"],o=n!=null&&n.hasAttribute("style")?n.getAttribute("style"):null;return o&&t.hasOwnProperty(o)&&(s=t[o]),r.reduce((a,c)=>{const l=nu(e,i,c)||nu(n,i,c)||nu(s,i,c);return l&&(a[c]=l),a},{})}function nu(n,e,t){return n&&n.hasAttributeNS(e,t)?n.getAttributeNS(e,t):null}function pA(n){return new Error(`Could not parse ttml timestamp ${n}`)}function ru(n,e){if(!n)return null;let t=Fg(n);return t===null&&(Ug.test(n)?t=S8(n,e):Qg.test(n)&&(t=w8(n,e))),t}function S8(n,e){const t=Ug.exec(n),i=(t[4]|0)+(t[5]|0)/e.subFrameRate;return(t[1]|0)*3600+(t[2]|0)*60+(t[3]|0)+i/e.frameRate}function w8(n,e){const t=Qg.exec(n),i=Number(t[1]);switch(t[2]){case"h":return i*3600;case"m":return i*60;case"ms":return i*1e3;case"f":return i/e.frameRate;case"t":return i/e.tickRate}return i}class Gg{constructor(e){this.hls=void 0,this.media=null,this.config=void 0,this.enabled=!0,this.Cues=void 0,this.textTracks=[],this.tracks=[],this.initPTS=[],this.unparsedVttFrags=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.cea608Parser1=void 0,this.cea608Parser2=void 0,this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=yA(),this.captionsProperties=void 0,this.hls=e,this.config=e.config,this.Cues=e.config.cueHandler,this.captionsProperties={textTrack1:{label:this.config.captionsTextTrack1Label,languageCode:this.config.captionsTextTrack1LanguageCode},textTrack2:{label:this.config.captionsTextTrack2Label,languageCode:this.config.captionsTextTrack2LanguageCode},textTrack3:{label:this.config.captionsTextTrack3Label,languageCode:this.config.captionsTextTrack3LanguageCode},textTrack4:{label:this.config.captionsTextTrack4Label,languageCode:this.config.captionsTextTrack4LanguageCode}},e.on(D.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(D.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(D.MANIFEST_LOADING,this.onManifestLoading,this),e.on(D.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(D.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.on(D.FRAG_LOADING,this.onFragLoading,this),e.on(D.FRAG_LOADED,this.onFragLoaded,this),e.on(D.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.on(D.FRAG_DECRYPTED,this.onFragDecrypted,this),e.on(D.INIT_PTS_FOUND,this.onInitPtsFound,this),e.on(D.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.on(D.BUFFER_FLUSHING,this.onBufferFlushing,this)}destroy(){const{hls:e}=this;e.off(D.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(D.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(D.MANIFEST_LOADING,this.onManifestLoading,this),e.off(D.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(D.SUBTITLE_TRACKS_UPDATED,this.onSubtitleTracksUpdated,this),e.off(D.FRAG_LOADING,this.onFragLoading,this),e.off(D.FRAG_LOADED,this.onFragLoaded,this),e.off(D.FRAG_PARSING_USERDATA,this.onFragParsingUserdata,this),e.off(D.FRAG_DECRYPTED,this.onFragDecrypted,this),e.off(D.INIT_PTS_FOUND,this.onInitPtsFound,this),e.off(D.SUBTITLE_TRACKS_CLEARED,this.onSubtitleTracksCleared,this),e.off(D.BUFFER_FLUSHING,this.onBufferFlushing,this),this.hls=this.config=null,this.cea608Parser1=this.cea608Parser2=void 0}initCea608Parsers(){if(this.config.enableCEA708Captions&&(!this.cea608Parser1||!this.cea608Parser2)){const e=new pa(this,"textTrack1"),t=new pa(this,"textTrack2"),i=new pa(this,"textTrack3"),s=new pa(this,"textTrack4");this.cea608Parser1=new dA(1,e,t),this.cea608Parser2=new dA(3,i,s)}}addCues(e,t,i,s,r){let o=!1;for(let a=r.length;a--;){const c=r[a],l=T8(c[0],c[1],t,i);if(l>=0&&(c[0]=Math.min(c[0],t),c[1]=Math.max(c[1],i),o=!0,l/(i-t)>.5))return}if(o||r.push([t,i]),this.config.renderTextTracksNatively){const a=this.captionsTracks[e];this.Cues.newCue(a,t,i,s)}else{const a=this.Cues.newCue(null,t,i,s);this.hls.trigger(D.CUES_PARSED,{type:"captions",cues:a,track:e})}}onInitPtsFound(e,{frag:t,id:i,initPTS:s,timescale:r}){const{unparsedVttFrags:o}=this;i==="main"&&(this.initPTS[t.cc]={baseTime:s,timescale:r}),o.length&&(this.unparsedVttFrags=[],o.forEach(a=>{this.onFragLoaded(D.FRAG_LOADED,a)}))}getExistingTrack(e,t){const{media:i}=this;if(i)for(let s=0;s<i.textTracks.length;s++){const r=i.textTracks[s];if(gA(r,{name:e,lang:t,attrs:{}}))return r}return null}createCaptionsTrack(e){this.config.renderTextTracksNatively?this.createNativeTrack(e):this.createNonNativeTrack(e)}createNativeTrack(e){if(this.captionsTracks[e])return;const{captionsProperties:t,captionsTracks:i,media:s}=this,{label:r,languageCode:o}=t[e],a=this.getExistingTrack(r,o);if(a)i[e]=a,nr(i[e]),Zp(i[e],s);else{const c=this.createTextTrack("captions",r,o);c&&(c[e]=!0,i[e]=c)}}createNonNativeTrack(e){if(this.nonNativeCaptionsTracks[e])return;const t=this.captionsProperties[e];if(!t)return;const i=t.label,s={_id:e,label:i,kind:"captions",default:t.media?!!t.media.default:!1,closedCaptions:t.media};this.nonNativeCaptionsTracks[e]=s,this.hls.trigger(D.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:[s]})}createTextTrack(e,t,i){const s=this.media;if(s)return s.addTextTrack(e,t,i)}onMediaAttaching(e,t){this.media=t.media,this._cleanTracks()}onMediaDetaching(){const{captionsTracks:e}=this;Object.keys(e).forEach(t=>{nr(e[t]),delete e[t]}),this.nonNativeCaptionsTracks={}}onManifestLoading(){this.lastCc=-1,this.lastSn=-1,this.lastPartIndex=-1,this.prevCC=-1,this.vttCCs=yA(),this._cleanTracks(),this.tracks=[],this.captionsTracks={},this.nonNativeCaptionsTracks={},this.textTracks=[],this.unparsedVttFrags=[],this.initPTS=[],this.cea608Parser1&&this.cea608Parser2&&(this.cea608Parser1.reset(),this.cea608Parser2.reset())}_cleanTracks(){const{media:e}=this;if(!e)return;const t=e.textTracks;if(t)for(let i=0;i<t.length;i++)nr(t[i])}onSubtitleTracksUpdated(e,t){const i=t.subtitleTracks||[],s=i.some(r=>r.textCodec===iu);if(this.config.enableWebVTT||s&&this.config.enableIMSC1){if(Bg(this.tracks,i)){this.tracks=i;return}if(this.textTracks=[],this.tracks=i,this.config.renderTextTracksNatively){const o=this.media,a=o?Xa(o.textTracks):null;if(this.tracks.forEach((c,l)=>{let u;if(a){let h=null;for(let f=0;f<a.length;f++)if(a[f]&&gA(a[f],c)){h=a[f],a[f]=null;break}h&&(u=h)}if(u)nr(u);else{const h=zg(c);u=this.createTextTrack(h,c.name,c.lang),u&&(u.mode="disabled")}u&&this.textTracks.push(u)}),a!=null&&a.length){const c=a.filter(l=>l!==null).map(l=>l.label);c.length&&j.warn(`Media element contains unused subtitle tracks: ${c.join(", ")}. Replace media element for each source to clear TextTracks and captions menu.`)}}else if(this.tracks.length){const o=this.tracks.map(a=>({label:a.name,kind:a.type.toLowerCase(),default:a.default,subtitleTrack:a}));this.hls.trigger(D.NON_NATIVE_TEXT_TRACKS_FOUND,{tracks:o})}}}onManifestLoaded(e,t){this.config.enableCEA708Captions&&t.captions&&t.captions.forEach(i=>{const s=/(?:CC|SERVICE)([1-4])/.exec(i.instreamId);if(!s)return;const r=`textTrack${s[1]}`,o=this.captionsProperties[r];o&&(o.label=i.name,i.lang&&(o.languageCode=i.lang),o.media=i)})}closedCaptionsForLevel(e){const t=this.hls.levels[e.level];return t==null?void 0:t.attrs["CLOSED-CAPTIONS"]}onFragLoading(e,t){if(this.enabled&&t.frag.type===we.MAIN){var i,s;const{cea608Parser1:r,cea608Parser2:o,lastSn:a}=this,{cc:c,sn:l}=t.frag,u=(i=(s=t.part)==null?void 0:s.index)!=null?i:-1;r&&o&&(l!==a+1||l===a&&u!==this.lastPartIndex+1||c!==this.lastCc)&&(r.reset(),o.reset()),this.lastCc=c,this.lastSn=l,this.lastPartIndex=u}}onFragLoaded(e,t){const{frag:i,payload:s}=t;if(i.type===we.SUBTITLE)if(s.byteLength){const r=i.decryptdata,o="stats"in t;if(r==null||!r.encrypted||o){const a=this.tracks[i.level],c=this.vttCCs;c[i.cc]||(c[i.cc]={start:i.start,prevCC:this.prevCC,new:!0},this.prevCC=i.cc),a&&a.textCodec===iu?this._parseIMSC1(i,s):this._parseVTTs(t)}}else this.hls.trigger(D.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:new Error("Empty subtitle payload")})}_parseIMSC1(e,t){const i=this.hls;AA(t,this.initPTS[e.cc],s=>{this._appendCues(s,e.level),i.trigger(D.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:e})},s=>{j.log(`Failed to parse IMSC1: ${s}`),i.trigger(D.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:e,error:s})})}_parseVTTs(e){var t;const{frag:i,payload:s}=e,{initPTS:r,unparsedVttFrags:o}=this,a=r.length-1;if(!r[i.cc]&&a===-1){o.push(e);return}const c=this.hls,l=(t=i.initSegment)!=null&&t.data?_i(i.initSegment.data,new Uint8Array(s)):s;v8(l,this.initPTS[i.cc],this.vttCCs,i.cc,i.start,u=>{this._appendCues(u,i.level),c.trigger(D.SUBTITLE_FRAG_PROCESSED,{success:!0,frag:i})},u=>{const h=u.message==="Missing initPTS for VTT MPEGTS";h?o.push(e):this._fallbackToIMSC1(i,s),j.log(`Failed to parse VTT cue: ${u}`),!(h&&a>i.cc)&&c.trigger(D.SUBTITLE_FRAG_PROCESSED,{success:!1,frag:i,error:u})})}_fallbackToIMSC1(e,t){const i=this.tracks[e.level];i.textCodec||AA(t,this.initPTS[e.cc],()=>{i.textCodec=iu,this._parseIMSC1(e,t)},()=>{i.textCodec="wvtt"})}_appendCues(e,t){const i=this.hls;if(this.config.renderTextTracksNatively){const s=this.textTracks[t];if(!s||s.mode==="disabled")return;e.forEach(r=>eg(s,r))}else{const s=this.tracks[t];if(!s)return;const r=s.default?"default":"subtitles"+t;i.trigger(D.CUES_PARSED,{type:"subtitles",cues:e,track:r})}}onFragDecrypted(e,t){const{frag:i}=t;i.type===we.SUBTITLE&&this.onFragLoaded(D.FRAG_LOADED,t)}onSubtitleTracksCleared(){this.tracks=[],this.captionsTracks={}}onFragParsingUserdata(e,t){this.initCea608Parsers();const{cea608Parser1:i,cea608Parser2:s}=this;if(!this.enabled||!i||!s)return;const{frag:r,samples:o}=t;if(!(r.type===we.MAIN&&this.closedCaptionsForLevel(r)==="NONE"))for(let a=0;a<o.length;a++){const c=o[a].bytes;if(c){const l=this.extractCea608Data(c);i.addData(o[a].pts,l[0]),s.addData(o[a].pts,l[1])}}}onBufferFlushing(e,{startOffset:t,endOffset:i,endOffsetSubtitles:s,type:r}){const{media:o}=this;if(!(!o||o.currentTime<i)){if(!r||r==="video"){const{captionsTracks:a}=this;Object.keys(a).forEach(c=>ch(a[c],t,i))}if(this.config.renderTextTracksNatively&&t===0&&s!==void 0){const{textTracks:a}=this;Object.keys(a).forEach(c=>ch(a[c],t,s))}}}extractCea608Data(e){const t=[[],[]],i=e[0]&31;let s=2;for(let r=0;r<i;r++){const o=e[s++],a=127&e[s++],c=127&e[s++];if(a===0&&c===0)continue;if((4&o)!==0){const u=3&o;(u===0||u===1)&&(t[u].push(a),t[u].push(c))}}return t}}function zg(n){return n.characteristics&&/transcribes-spoken-dialog/gi.test(n.characteristics)&&/describes-music-and-sound/gi.test(n.characteristics)?"captions":"subtitles"}function gA(n,e){return!!n&&n.kind===zg(e)&&mh(e,n)}function T8(n,e,t,i){return Math.min(e,i)-Math.max(n,t)}function yA(){return{ccOffset:0,presentationOffset:0,0:{start:0,prevCC:-1,new:!0}}}class Kc{constructor(e){this.hls=void 0,this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.clientRect=void 0,this.streamController=void 0,this.hls=e,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}setStreamController(e){this.streamController=e}destroy(){this.hls&&this.unregisterListener(),this.timer&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null}registerListeners(){const{hls:e}=this;e.on(D.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.on(D.MEDIA_ATTACHING,this.onMediaAttaching,this),e.on(D.MANIFEST_PARSED,this.onManifestParsed,this),e.on(D.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(D.BUFFER_CODECS,this.onBufferCodecs,this),e.on(D.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListener(){const{hls:e}=this;e.off(D.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),e.off(D.MEDIA_ATTACHING,this.onMediaAttaching,this),e.off(D.MANIFEST_PARSED,this.onManifestParsed,this),e.off(D.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(D.BUFFER_CODECS,this.onBufferCodecs,this),e.off(D.MEDIA_DETACHING,this.onMediaDetaching,this)}onFpsDropLevelCapping(e,t){const i=this.hls.levels[t.droppedLevel];this.isLevelAllowed(i)&&this.restrictedLevels.push({bitrate:i.bitrate,height:i.height,width:i.width})}onMediaAttaching(e,t){this.media=t.media instanceof HTMLVideoElement?t.media:null,this.clientRect=null,this.timer&&this.hls.levels.length&&this.detectPlayerSize()}onManifestParsed(e,t){const i=this.hls;this.restrictedLevels=[],this.firstLevel=t.firstLevel,i.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onLevelsUpdated(e,t){this.timer&&ve(this.autoLevelCapping)&&this.detectPlayerSize()}onBufferCodecs(e,t){this.hls.config.capLevelToPlayerSize&&t.video&&this.startCapping()}onMediaDetaching(){this.stopCapping()}detectPlayerSize(){if(this.media){if(this.mediaHeight<=0||this.mediaWidth<=0){this.clientRect=null;return}const e=this.hls.levels;if(e.length){const t=this.hls,i=this.getMaxLevel(e.length-1);i!==this.autoLevelCapping&&j.log(`Setting autoLevelCapping to ${i}: ${e[i].height}p@${e[i].bitrate} for media ${this.mediaWidth}x${this.mediaHeight}`),t.autoLevelCapping=i,t.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=t.autoLevelCapping}}}getMaxLevel(e){const t=this.hls.levels;if(!t.length)return-1;const i=t.filter((s,r)=>this.isLevelAllowed(s)&&r<=e);return this.clientRect=null,Kc.getMaxLevelByMediaSize(i,this.mediaWidth,this.mediaHeight)}startCapping(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())}stopCapping(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)}getDimensions(){if(this.clientRect)return this.clientRect;const e=this.media,t={width:0,height:0};if(e){const i=e.getBoundingClientRect();t.width=i.width,t.height=i.height,!t.width&&!t.height&&(t.width=i.right-i.left||e.width||0,t.height=i.bottom-i.top||e.height||0)}return this.clientRect=t,t}get mediaWidth(){return this.getDimensions().width*this.contentScaleFactor}get mediaHeight(){return this.getDimensions().height*this.contentScaleFactor}get contentScaleFactor(){let e=1;if(!this.hls.config.ignoreDevicePixelRatio)try{e=self.devicePixelRatio}catch{}return e}isLevelAllowed(e){return!this.restrictedLevels.some(i=>e.bitrate===i.bitrate&&e.width===i.width&&e.height===i.height)}static getMaxLevelByMediaSize(e,t,i){if(!(e!=null&&e.length))return-1;const s=(a,c)=>c?a.width!==c.width||a.height!==c.height:!0;let r=e.length-1;const o=Math.max(t,i);for(let a=0;a<e.length;a+=1){const c=e[a];if((c.width>=o||c.height>=o)&&s(c,e[a+1])){r=a;break}}return r}}class Hg{constructor(e){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=e,this.registerListeners()}setStreamController(e){this.streamController=e}registerListeners(){this.hls.on(D.MEDIA_ATTACHING,this.onMediaAttaching,this)}unregisterListeners(){this.hls.off(D.MEDIA_ATTACHING,this.onMediaAttaching,this)}destroy(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null}onMediaAttaching(e,t){const i=this.hls.config;if(i.capLevelOnFPSDrop){const s=t.media instanceof self.HTMLVideoElement?t.media:null;this.media=s,s&&typeof s.getVideoPlaybackQuality=="function"&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),i.fpsDroppedMonitoringPeriod)}}checkFPS(e,t,i){const s=performance.now();if(t){if(this.lastTime){const r=s-this.lastTime,o=i-this.lastDroppedFrames,a=t-this.lastDecodedFrames,c=1e3*o/r,l=this.hls;if(l.trigger(D.FPS_DROP,{currentDropped:o,currentDecoded:a,totalDroppedFrames:i}),c>0&&o>l.config.fpsDroppedMonitoringThreshold*a){let u=l.currentLevel;j.warn("drop FPS ratio greater than max allowed value for currentLevel: "+u),u>0&&(l.autoLevelCapping===-1||l.autoLevelCapping>=u)&&(u=u-1,l.trigger(D.FPS_DROP_LEVEL_CAPPING,{level:u,droppedLevel:l.currentLevel}),l.autoLevelCapping=u,this.streamController.nextLevelSwitch())}}this.lastTime=s,this.lastDroppedFrames=i,this.lastDecodedFrames=t}}checkFPSInterval(){const e=this.media;if(e)if(this.isVideoPlaybackQualityAvailable){const t=e.getVideoPlaybackQuality();this.checkFPS(e,t.totalVideoFrames,t.droppedVideoFrames)}else this.checkFPS(e,e.webkitDecodedFrameCount,e.webkitDroppedFrameCount)}}const ya="[eme]";class cn{constructor(e){this.hls=void 0,this.config=void 0,this.media=null,this.keyFormatPromise=null,this.keySystemAccessPromises={},this._requestLicenseFailureCount=0,this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},this.setMediaKeysQueue=cn.CDMCleanupPromise?[cn.CDMCleanupPromise]:[],this.onMediaEncrypted=this._onMediaEncrypted.bind(this),this.onWaitingForKey=this._onWaitingForKey.bind(this),this.debug=j.debug.bind(j,ya),this.log=j.log.bind(j,ya),this.warn=j.warn.bind(j,ya),this.error=j.error.bind(j,ya),this.hls=e,this.config=e.config,this.registerListeners()}destroy(){this.unregisterListeners(),this.onMediaDetached();const e=this.config;e.requestMediaKeySystemAccessFunc=null,e.licenseXhrSetup=e.licenseResponseCallback=void 0,e.drmSystems=e.drmSystemOptions={},this.hls=this.onMediaEncrypted=this.onWaitingForKey=this.keyIdToKeySessionPromise=null,this.config=null}registerListeners(){this.hls.on(D.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(D.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.on(D.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(D.MANIFEST_LOADED,this.onManifestLoaded,this)}unregisterListeners(){this.hls.off(D.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(D.MEDIA_DETACHED,this.onMediaDetached,this),this.hls.off(D.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(D.MANIFEST_LOADED,this.onManifestLoaded,this)}getLicenseServerUrl(e){const{drmSystems:t,widevineLicenseUrl:i}=this.config,s=t[e];if(s)return s.licenseUrl;if(e===je.WIDEVINE&&i)return i;throw new Error(`no license server URL configured for key-system "${e}"`)}getServerCertificateUrl(e){const{drmSystems:t}=this.config,i=t[e];if(i)return i.serverCertificateUrl;this.log(`No Server Certificate in config.drmSystems["${e}"]`)}attemptKeySystemAccess(e){const t=this.hls.levels,i=(o,a,c)=>!!o&&c.indexOf(o)===a,s=t.map(o=>o.audioCodec).filter(i),r=t.map(o=>o.videoCodec).filter(i);return s.length+r.length===0&&r.push("avc1.42e01e"),new Promise((o,a)=>{const c=l=>{const u=l.shift();this.getMediaKeysPromise(u,s,r).then(h=>o({keySystem:u,mediaKeys:h})).catch(h=>{l.length?c(l):h instanceof pi?a(h):a(new pi({type:_e.KEY_SYSTEM_ERROR,details:te.KEY_SYSTEM_NO_ACCESS,error:h,fatal:!0},h.message))})};c(e)})}requestMediaKeySystemAccess(e,t){const{requestMediaKeySystemAccessFunc:i}=this.config;if(typeof i!="function"){let s=`Configured requestMediaKeySystemAccess is not a function ${i}`;return Np===null&&self.location.protocol==="http:"&&(s=`navigator.requestMediaKeySystemAccess is not available over insecure protocol ${location.protocol}`),Promise.reject(new Error(s))}return i(e,t)}getMediaKeysPromise(e,t,i){const s=GI(e,t,i,this.config.drmSystemOptions),r=this.keySystemAccessPromises[e];let o=r==null?void 0:r.keySystemAccess;if(!o){this.log(`Requesting encrypted media "${e}" key-system access with config: ${JSON.stringify(s)}`),o=this.requestMediaKeySystemAccess(e,s);const a=this.keySystemAccessPromises[e]={keySystemAccess:o};return o.catch(c=>{this.log(`Failed to obtain access to key-system "${e}": ${c}`)}),o.then(c=>{this.log(`Access for key-system "${c.keySystem}" obtained`);const l=this.fetchServerCertificate(e);return this.log(`Create media-keys for "${e}"`),a.mediaKeys=c.createMediaKeys().then(u=>(this.log(`Media-keys created for "${e}"`),l.then(h=>h?this.setMediaKeysServerCertificate(u,e,h):u))),a.mediaKeys.catch(u=>{this.error(`Failed to create media-keys for "${e}"}: ${u}`)}),a.mediaKeys})}return o.then(()=>r.mediaKeys)}createMediaKeySessionContext({decryptdata:e,keySystem:t,mediaKeys:i}){this.log(`Creating key-system session "${t}" keyId: ${ji.hexDump(e.keyId||[])}`);const s=i.createSession(),r={decryptdata:e,keySystem:t,mediaKeys:i,mediaKeysSession:s,keyStatus:"status-pending"};return this.mediaKeySessions.push(r),r}renewKeySession(e){const t=e.decryptdata;if(t.pssh){const i=this.createMediaKeySessionContext(e),s=this.getKeyIdString(t),r="cenc";this.keyIdToKeySessionPromise[s]=this.generateRequestWithPreferredKeySession(i,r,t.pssh,"expired")}else this.warn("Could not renew expired session. Missing pssh initData.");this.removeSession(e)}getKeyIdString(e){if(!e)throw new Error("Could not read keyId of undefined decryptdata");if(e.keyId===null)throw new Error("keyId is null");return ji.hexDump(e.keyId)}updateKeySession(e,t){var i;const s=e.mediaKeysSession;return this.log(`Updating key-session "${s.sessionId}" for keyID ${ji.hexDump(((i=e.decryptdata)==null?void 0:i.keyId)||[])}
      } (data length: ${t&&t.byteLength})`),s.update(t)}selectKeySystemFormat(e){const t=Object.keys(e.levelkeys||{});return this.keyFormatPromise||(this.log(`Selecting key-system from fragment (sn: ${e.sn} ${e.type}: ${e.level}) key formats ${t.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(t)),this.keyFormatPromise}getKeyFormatPromise(e){return new Promise((t,i)=>{const s=Gl(this.config),r=e.map(w0).filter(o=>!!o&&s.indexOf(o)!==-1);return this.getKeySystemSelectionPromise(r).then(({keySystem:o})=>{const a=B0(o);a?t(a):i(new Error(`Unable to find format for key-system "${o}"`))}).catch(i)})}loadKey(e){const t=e.keyInfo.decryptdata,i=this.getKeyIdString(t),s=`(keyId: ${i} format: "${t.keyFormat}" method: ${t.method} uri: ${t.uri})`;this.log(`Starting session for key ${s}`);let r=this.keyIdToKeySessionPromise[i];return r||(r=this.keyIdToKeySessionPromise[i]=this.getKeySystemForKeyPromise(t).then(({keySystem:o,mediaKeys:a})=>(this.throwIfDestroyed(),this.log(`Handle encrypted media sn: ${e.frag.sn} ${e.frag.type}: ${e.frag.level} using key ${s}`),this.attemptSetMediaKeys(o,a).then(()=>{this.throwIfDestroyed();const c=this.createMediaKeySessionContext({keySystem:o,mediaKeys:a,decryptdata:t});return this.generateRequestWithPreferredKeySession(c,"cenc",t.pssh,"playlist-key")}))),r.catch(o=>this.handleError(o))),r}throwIfDestroyed(e="Invalid state"){if(!this.hls)throw new Error("invalid state")}handleError(e){this.hls&&(this.error(e.message),e instanceof pi?this.hls.trigger(D.ERROR,e.data):this.hls.trigger(D.ERROR,{type:_e.KEY_SYSTEM_ERROR,details:te.KEY_SYSTEM_NO_KEYS,error:e,fatal:!0}))}getKeySystemForKeyPromise(e){const t=this.getKeyIdString(e),i=this.keyIdToKeySessionPromise[t];if(!i){const s=w0(e.keyFormat),r=s?[s]:Gl(this.config);return this.attemptKeySystemAccess(r)}return i}getKeySystemSelectionPromise(e){if(e.length||(e=Gl(this.config)),e.length===0)throw new pi({type:_e.KEY_SYSTEM_ERROR,details:te.KEY_SYSTEM_NO_CONFIGURED_LICENSE,fatal:!0},`Missing key-system license configuration options ${JSON.stringify({drmSystems:this.config.drmSystems})}`);return this.attemptKeySystemAccess(e)}_onMediaEncrypted(e){const{initDataType:t,initData:i}=e,s=`"${e.type}" event: init data type: "${t}"`;if(this.debug(s),i===null)return;let r,o;if(t==="sinf"&&this.config.drmSystems[je.FAIRPLAY]){const h=xt(new Uint8Array(i));try{const f=af(JSON.parse(h).sinf),d=Wp(new Uint8Array(f));if(!d)throw new Error("'schm' box missing or not cbcs/cenc with schi > tenc");r=d.subarray(8,24),o=je.FAIRPLAY}catch(f){this.warn(`${s} Failed to parse sinf: ${f}`);return}}else{const h=f5(i),f=h.filter(d=>d.systemId===yo.WIDEVINE)[0];if(!f){h.length===0||h.some(d=>!d.systemId)?this.warn(`${s} contains incomplete or invalid pssh data`):this.log(`ignoring ${s} for ${h.map(d=>T0(d.systemId)).join(",")} pssh data in favor of playlist keys`);return}if(o=T0(f.systemId),f.version===0&&f.data){const d=f.data.length-22;r=f.data.subarray(d,d+16)}}if(!o||!r)return;const a=ji.hexDump(r),{keyIdToKeySessionPromise:c,mediaKeySessions:l}=this;let u=c[a];for(let h=0;h<l.length;h++){const f=l[h],d=f.decryptdata;if(!d.keyId)continue;const p=ji.hexDump(d.keyId);if(a===p||d.uri.replace(/-/g,"").indexOf(a)!==-1){if(u=c[p],d.pssh)break;delete c[p],d.pssh=new Uint8Array(i),d.keyId=r,u=c[a]=u.then(()=>this.generateRequestWithPreferredKeySession(f,t,i,"encrypted-event-key-match"));break}}u||(u=c[a]=this.getKeySystemSelectionPromise([o]).then(({keySystem:h,mediaKeys:f})=>{var d;this.throwIfDestroyed();const p=new gr("ISO-23001-7",a,(d=B0(h))!=null?d:"");return p.pssh=new Uint8Array(i),p.keyId=r,this.attemptSetMediaKeys(h,f).then(()=>{this.throwIfDestroyed();const m=this.createMediaKeySessionContext({decryptdata:p,keySystem:h,mediaKeys:f});return this.generateRequestWithPreferredKeySession(m,t,i,"encrypted-event-no-match")})})),u.catch(h=>this.handleError(h))}_onWaitingForKey(e){this.log(`"${e.type}" event`)}attemptSetMediaKeys(e,t){const i=this.setMediaKeysQueue.slice();this.log(`Setting media-keys for "${e}"`);const s=Promise.all(i).then(()=>{if(!this.media)throw new Error("Attempted to set mediaKeys without media element attached");return this.media.setMediaKeys(t)});return this.setMediaKeysQueue.push(s),s.then(()=>{this.log(`Media-keys set for "${e}"`),i.push(s),this.setMediaKeysQueue=this.setMediaKeysQueue.filter(r=>i.indexOf(r)===-1)})}generateRequestWithPreferredKeySession(e,t,i,s){var r,o;const a=(r=this.config.drmSystems)==null||(o=r[e.keySystem])==null?void 0:o.generateRequest;if(a)try{const p=a.call(this.hls,t,i,e);if(!p)throw new Error("Invalid response from configured generateRequest filter");t=p.initDataType,i=e.decryptdata.pssh=p.initData?new Uint8Array(p.initData):null}catch(p){var c;if(this.warn(p.message),(c=this.hls)!=null&&c.config.debug)throw p}if(i===null)return this.log(`Skipping key-session request for "${s}" (no initData)`),Promise.resolve(e);const l=this.getKeyIdString(e.decryptdata);this.log(`Generating key-session request for "${s}": ${l} (init data type: ${t} length: ${i?i.byteLength:null})`);const u=new pf,h=e._onmessage=p=>{const m=e.mediaKeysSession;if(!m){u.emit("error",new Error("invalid state"));return}const{messageType:g,message:y}=p;this.log(`"${g}" message event for session "${m.sessionId}" message size: ${y.byteLength}`),g==="license-request"||g==="license-renewal"?this.renewLicense(e,y).catch(v=>{this.handleError(v),u.emit("error",v)}):g==="license-release"?e.keySystem===je.FAIRPLAY&&(this.updateKeySession(e,oh("acknowledged")),this.removeSession(e)):this.warn(`unhandled media key message type "${g}"`)},f=e._onkeystatuseschange=p=>{if(!e.mediaKeysSession){u.emit("error",new Error("invalid state"));return}this.onKeyStatusChange(e);const g=e.keyStatus;u.emit("keyStatus",g),g==="expired"&&(this.warn(`${e.keySystem} expired for key ${l}`),this.renewKeySession(e))};e.mediaKeysSession.addEventListener("message",h),e.mediaKeysSession.addEventListener("keystatuseschange",f);const d=new Promise((p,m)=>{u.on("error",m),u.on("keyStatus",g=>{g.startsWith("usable")?p():g==="output-restricted"?m(new pi({type:_e.KEY_SYSTEM_ERROR,details:te.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED,fatal:!1},"HDCP level output restricted")):g==="internal-error"?m(new pi({type:_e.KEY_SYSTEM_ERROR,details:te.KEY_SYSTEM_STATUS_INTERNAL_ERROR,fatal:!0},`key status changed to "${g}"`)):g==="expired"?m(new Error("key expired while generating request")):this.warn(`unhandled key status change "${g}"`)})});return e.mediaKeysSession.generateRequest(t,i).then(()=>{var p;this.log(`Request generated for key-session "${(p=e.mediaKeysSession)==null?void 0:p.sessionId}" keyId: ${l}`)}).catch(p=>{throw new pi({type:_e.KEY_SYSTEM_ERROR,details:te.KEY_SYSTEM_NO_SESSION,error:p,fatal:!1},`Error generating key-session request: ${p}`)}).then(()=>d).catch(p=>{throw u.removeAllListeners(),this.removeSession(e),p}).then(()=>(u.removeAllListeners(),e))}onKeyStatusChange(e){e.mediaKeysSession.keyStatuses.forEach((t,i)=>{this.log(`key status change "${t}" for keyStatuses keyId: ${ji.hexDump("buffer"in i?new Uint8Array(i.buffer,i.byteOffset,i.byteLength):new Uint8Array(i))} session keyId: ${ji.hexDump(new Uint8Array(e.decryptdata.keyId||[]))} uri: ${e.decryptdata.uri}`),e.keyStatus=t})}fetchServerCertificate(e){const t=this.config,i=t.loader,s=new i(t),r=this.getServerCertificateUrl(e);return r?(this.log(`Fetching server certificate for "${e}"`),new Promise((o,a)=>{const c={responseType:"arraybuffer",url:r},l=t.certLoadPolicy.default,u={loadPolicy:l,timeout:l.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},h={onSuccess:(f,d,p,m)=>{o(f.data)},onError:(f,d,p,m)=>{a(new pi({type:_e.KEY_SYSTEM_ERROR,details:te.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:p,response:Mt({url:c.url,data:void 0},f)},`"${e}" certificate request failed (${r}). Status: ${f.code} (${f.text})`))},onTimeout:(f,d,p)=>{a(new pi({type:_e.KEY_SYSTEM_ERROR,details:te.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED,fatal:!0,networkDetails:p,response:{url:c.url,data:void 0}},`"${e}" certificate request timed out (${r})`))},onAbort:(f,d,p)=>{a(new Error("aborted"))}};s.load(c,u,h)})):Promise.resolve()}setMediaKeysServerCertificate(e,t,i){return new Promise((s,r)=>{e.setServerCertificate(i).then(o=>{this.log(`setServerCertificate ${o?"success":"not supported by CDM"} (${i==null?void 0:i.byteLength}) on "${t}"`),s(e)}).catch(o=>{r(new pi({type:_e.KEY_SYSTEM_ERROR,details:te.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED,error:o,fatal:!0},o.message))})})}renewLicense(e,t){return this.requestLicense(e,new Uint8Array(t)).then(i=>this.updateKeySession(e,new Uint8Array(i)).catch(s=>{throw new pi({type:_e.KEY_SYSTEM_ERROR,details:te.KEY_SYSTEM_SESSION_UPDATE_FAILED,error:s,fatal:!0},s.message)}))}unpackPlayReadyKeyMessage(e,t){const i=String.fromCharCode.apply(null,new Uint16Array(t.buffer));if(!i.includes("PlayReadyKeyMessage"))return e.setRequestHeader("Content-Type","text/xml; charset=utf-8"),t;const s=new DOMParser().parseFromString(i,"application/xml"),r=s.querySelectorAll("HttpHeader");if(r.length>0){let u;for(let h=0,f=r.length;h<f;h++){var o,a;u=r[h];const d=(o=u.querySelector("name"))==null?void 0:o.textContent,p=(a=u.querySelector("value"))==null?void 0:a.textContent;d&&p&&e.setRequestHeader(d,p)}}const c=s.querySelector("Challenge"),l=c==null?void 0:c.textContent;if(!l)throw new Error("Cannot find <Challenge> in key message");return oh(atob(l))}setupLicenseXHR(e,t,i,s){const r=this.config.licenseXhrSetup;return r?Promise.resolve().then(()=>{if(!i.decryptdata)throw new Error("Key removed");return r.call(this.hls,e,t,i,s)}).catch(o=>{if(!i.decryptdata)throw o;return e.open("POST",t,!0),r.call(this.hls,e,t,i,s)}).then(o=>(e.readyState||e.open("POST",t,!0),{xhr:e,licenseChallenge:o||s})):(e.open("POST",t,!0),Promise.resolve({xhr:e,licenseChallenge:s}))}requestLicense(e,t){const i=this.config.keyLoadPolicy.default;return new Promise((s,r)=>{const o=this.getLicenseServerUrl(e.keySystem);this.log(`Sending license request to URL: ${o}`);const a=new XMLHttpRequest;a.responseType="arraybuffer",a.onreadystatechange=()=>{if(!this.hls||!e.mediaKeysSession)return r(new Error("invalid state"));if(a.readyState===4)if(a.status===200){this._requestLicenseFailureCount=0;let c=a.response;this.log(`License received ${c instanceof ArrayBuffer?c.byteLength:c}`);const l=this.config.licenseResponseCallback;if(l)try{c=l.call(this.hls,a,o,e)}catch(u){this.error(u)}s(c)}else{const c=i.errorRetry,l=c?c.maxNumRetry:0;if(this._requestLicenseFailureCount++,this._requestLicenseFailureCount>l||a.status>=400&&a.status<500)r(new pi({type:_e.KEY_SYSTEM_ERROR,details:te.KEY_SYSTEM_LICENSE_REQUEST_FAILED,fatal:!0,networkDetails:a,response:{url:o,data:void 0,code:a.status,text:a.statusText}},`License Request XHR failed (${o}). Status: ${a.status} (${a.statusText})`));else{const u=l-this._requestLicenseFailureCount+1;this.warn(`Retrying license request, ${u} attempts left`),this.requestLicense(e,t).then(s,r)}}},e.licenseXhr&&e.licenseXhr.readyState!==XMLHttpRequest.DONE&&e.licenseXhr.abort(),e.licenseXhr=a,this.setupLicenseXHR(a,o,e,t).then(({xhr:c,licenseChallenge:l})=>{e.keySystem==je.PLAYREADY&&(l=this.unpackPlayReadyKeyMessage(c,l)),c.send(l)})})}onMediaAttached(e,t){if(!this.config.emeEnabled)return;const i=t.media;this.media=i,i.addEventListener("encrypted",this.onMediaEncrypted),i.addEventListener("waitingforkey",this.onWaitingForKey)}onMediaDetached(){const e=this.media,t=this.mediaKeySessions;e&&(e.removeEventListener("encrypted",this.onMediaEncrypted),e.removeEventListener("waitingforkey",this.onWaitingForKey),this.media=null),this._requestLicenseFailureCount=0,this.setMediaKeysQueue=[],this.mediaKeySessions=[],this.keyIdToKeySessionPromise={},gr.clearKeyUriToKeyIdMap();const i=t.length;cn.CDMCleanupPromise=Promise.all(t.map(s=>this.removeSession(s)).concat(e==null?void 0:e.setMediaKeys(null).catch(s=>{this.log(`Could not clear media keys: ${s}`)}))).then(()=>{i&&(this.log("finished closing key sessions and clearing media keys"),t.length=0)}).catch(s=>{this.log(`Could not close sessions and clear media keys: ${s}`)})}onManifestLoading(){this.keyFormatPromise=null}onManifestLoaded(e,{sessionKeys:t}){if(!(!t||!this.config.emeEnabled)&&!this.keyFormatPromise){const i=t.reduce((s,r)=>(s.indexOf(r.keyFormat)===-1&&s.push(r.keyFormat),s),[]);this.log(`Selecting key-system from session-keys ${i.join(", ")}`),this.keyFormatPromise=this.getKeyFormatPromise(i)}}removeSession(e){const{mediaKeysSession:t,licenseXhr:i}=e;if(t){this.log(`Remove licenses and keys and close session ${t.sessionId}`),e._onmessage&&(t.removeEventListener("message",e._onmessage),e._onmessage=void 0),e._onkeystatuseschange&&(t.removeEventListener("keystatuseschange",e._onkeystatuseschange),e._onkeystatuseschange=void 0),i&&i.readyState!==XMLHttpRequest.DONE&&i.abort(),e.mediaKeysSession=e.decryptdata=e.licenseXhr=void 0;const s=this.mediaKeySessions.indexOf(e);return s>-1&&this.mediaKeySessions.splice(s,1),t.remove().catch(r=>{this.log(`Could not remove session: ${r}`)}).then(()=>t.close()).catch(r=>{this.log(`Could not close session: ${r}`)})}}}cn.CDMCleanupPromise=void 0;class pi extends Error{constructor(e,t){super(t),this.data=void 0,e.error||(e.error=new Error(t)),this.data=e,e.err=e.error}}var Nt;(function(n){n.MANIFEST="m",n.AUDIO="a",n.VIDEO="v",n.MUXED="av",n.INIT="i",n.CAPTION="c",n.TIMED_TEXT="tt",n.KEY="k",n.OTHER="o"})(Nt||(Nt={}));var gh;(function(n){n.DASH="d",n.HLS="h",n.SMOOTH="s",n.OTHER="o"})(gh||(gh={}));var rn;(function(n){n.OBJECT="CMCD-Object",n.REQUEST="CMCD-Request",n.SESSION="CMCD-Session",n.STATUS="CMCD-Status"})(rn||(rn={}));const B8={[rn.OBJECT]:["br","d","ot","tb"],[rn.REQUEST]:["bl","dl","mtp","nor","nrr","su"],[rn.SESSION]:["cid","pr","sf","sid","st","v"],[rn.STATUS]:["bs","rtp"]};class Er{constructor(e,t){this.value=void 0,this.params=void 0,Array.isArray(e)&&(e=e.map(i=>i instanceof Er?i:new Er(i))),this.value=e,this.params=t}}class Kg{constructor(e){this.description=void 0,this.description=e}}const _8="Dict";function b8(n){return Array.isArray(n)?JSON.stringify(n):n instanceof Map?"Map{}":n instanceof Set?"Set{}":typeof n=="object"?JSON.stringify(n):String(n)}function R8(n,e,t,i){return new Error(`failed to ${n} "${b8(e)}" as ${t}`,{cause:i})}const EA="Bare Item",D8="Boolean",M8="Byte Sequence",L8="Decimal",P8="Integer";function F8(n){return n<-999999999999999||999999999999999<n}const k8=/[\x00-\x1f\x7f]+/,O8="Token",U8="Key";function ls(n,e,t){return R8("serialize",n,e,t)}function Q8(n){if(typeof n!="boolean")throw ls(n,D8);return n?"?1":"?0"}function N8(n){return btoa(String.fromCharCode(...n))}function G8(n){if(ArrayBuffer.isView(n)===!1)throw ls(n,M8);return`:${N8(n)}:`}function Vg(n){if(F8(n))throw ls(n,P8);return n.toString()}function z8(n){return`@${Vg(n.getTime()/1e3)}`}function Yg(n,e){if(n<0)return-Yg(-n,e);const t=Math.pow(10,e);if(Math.abs(n*t%1-.5)<Number.EPSILON){const s=Math.floor(n*t);return(s%2===0?s:s+1)/t}else return Math.round(n*t)/t}function H8(n){const e=Yg(n,3);if(Math.floor(Math.abs(e)).toString().length>12)throw ls(n,L8);const t=e.toString();return t.includes(".")?t:`${t}.0`}const K8="String";function V8(n){if(k8.test(n))throw ls(n,K8);return`"${n.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}"`}function Y8(n){return n.description||n.toString().slice(7,-1)}function vA(n){const e=Y8(n);if(/^([a-zA-Z*])([!#$%&'*+\-.^_`|~\w:/]*)$/.test(e)===!1)throw ls(e,O8);return e}function yh(n){switch(typeof n){case"number":if(!ve(n))throw ls(n,EA);return Number.isInteger(n)?Vg(n):H8(n);case"string":return V8(n);case"symbol":return vA(n);case"boolean":return Q8(n);case"object":if(n instanceof Date)return z8(n);if(n instanceof Uint8Array)return G8(n);if(n instanceof Kg)return vA(n);default:throw ls(n,EA)}}function Eh(n){if(/^[a-z*][a-z0-9\-_.*]*$/.test(n)===!1)throw ls(n,U8);return n}function Ef(n){return n==null?"":Object.entries(n).map(([e,t])=>t===!0?`;${Eh(e)}`:`;${Eh(e)}=${yh(t)}`).join("")}function $g(n){return n instanceof Er?`${yh(n.value)}${Ef(n.params)}`:yh(n)}function $8(n){return`(${n.value.map($g).join(" ")})${Ef(n.params)}`}function W8(n,e={whitespace:!0}){if(typeof n!="object")throw ls(n,_8);const t=n instanceof Map?n.entries():Object.entries(n),i=e!=null&&e.whitespace?" ":"";return Array.from(t).map(([s,r])=>{r instanceof Er||(r=new Er(r));let o=Eh(s);return r.value===!0?o+=Ef(r.params):(o+="=",Array.isArray(r.value)?o+=$8(r):o+=$g(r)),o}).join(`,${i}`)}function j8(n,e){return W8(n,e)}const J8=n=>n==="ot"||n==="sf"||n==="st",q8=n=>typeof n=="number"?ve(n):n!=null&&n!==""&&n!==!1;function X8(n,e){const t=new URL(n),i=new URL(e);if(t.origin!==i.origin)return n;const s=t.pathname.split("/").slice(1),r=i.pathname.split("/").slice(1,-1);for(;s[0]===r[0];)s.shift(),r.shift();for(;r.length;)r.shift(),s.unshift("..");return s.join("/")}function Z8(){try{return crypto.randomUUID()}catch{try{const e=URL.createObjectURL(new Blob),t=e.toString();return URL.revokeObjectURL(e),t.slice(t.lastIndexOf("/")+1)}catch{let t=new Date().getTime();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,s=>{const r=(t+Math.random()*16)%16|0;return t=Math.floor(t/16),(s=="x"?r:r&3|8).toString(16)})}}}const sc=n=>Math.round(n),e9=(n,e)=>(e!=null&&e.baseUrl&&(n=X8(n,e.baseUrl)),encodeURIComponent(n)),Ea=n=>sc(n/100)*100,t9={br:sc,d:sc,bl:Ea,dl:Ea,mtp:Ea,nor:e9,rtp:Ea,tb:sc};function i9(n,e){const t={};if(n==null||typeof n!="object")return t;const i=Object.keys(n).sort(),s=pt({},t9,e==null?void 0:e.formatters),r=e==null?void 0:e.filter;return i.forEach(o=>{if(r!=null&&r(o))return;let a=n[o];const c=s[o];c&&(a=c(a,e)),!(o==="v"&&a===1)&&(o=="pr"&&a===1||q8(a)&&(J8(o)&&typeof a=="string"&&(a=new Kg(a)),t[o]=a))}),t}function Wg(n,e={}){return n?j8(i9(n,e),pt({whitespace:!1},e)):""}function s9(n,e={}){if(!n)return{};const t=Object.entries(n),i=Object.entries(B8).concat(Object.entries((e==null?void 0:e.customHeaderMap)||{})),s=t.reduce((r,o)=>{var a,c;const[l,u]=o,h=((a=i.find(f=>f[1].includes(l)))==null?void 0:a[0])||rn.REQUEST;return(c=r[h])!=null||(r[h]={}),r[h][l]=u,r},{});return Object.entries(s).reduce((r,[o,a])=>(r[o]=Wg(a,e),r),{})}function n9(n,e,t){return pt(n,s9(e,t))}const r9="CMCD";function o9(n,e={}){if(!n)return"";const t=Wg(n,e);return`${r9}=${encodeURIComponent(t)}`}const xA=/CMCD=[^&#]+/;function a9(n,e,t){const i=o9(e,t);if(!i)return n;if(xA.test(n))return n.replace(xA,i);const s=n.includes("?")?"&":"?";return`${n}${s}${i}`}class jg{constructor(e){this.hls=void 0,this.config=void 0,this.media=void 0,this.sid=void 0,this.cid=void 0,this.useHeaders=!1,this.includeKeys=void 0,this.initialized=!1,this.starved=!1,this.buffering=!0,this.audioBuffer=void 0,this.videoBuffer=void 0,this.onWaiting=()=>{this.initialized&&(this.starved=!0),this.buffering=!0},this.onPlaying=()=>{this.initialized||(this.initialized=!0),this.buffering=!1},this.applyPlaylistData=s=>{try{this.apply(s,{ot:Nt.MANIFEST,su:!this.initialized})}catch(r){j.warn("Could not generate manifest CMCD data.",r)}},this.applyFragmentData=s=>{try{const r=s.frag,o=this.hls.levels[r.level],a=this.getObjectType(r),c={d:r.duration*1e3,ot:a};(a===Nt.VIDEO||a===Nt.AUDIO||a==Nt.MUXED)&&(c.br=o.bitrate/1e3,c.tb=this.getTopBandwidth(a)/1e3,c.bl=this.getBufferLength(a)),this.apply(s,c)}catch(r){j.warn("Could not generate segment CMCD data.",r)}},this.hls=e;const t=this.config=e.config,{cmcd:i}=t;i!=null&&(t.pLoader=this.createPlaylistLoader(),t.fLoader=this.createFragmentLoader(),this.sid=i.sessionId||Z8(),this.cid=i.contentId,this.useHeaders=i.useHeaders===!0,this.includeKeys=i.includeKeys,this.registerListeners())}registerListeners(){const e=this.hls;e.on(D.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(D.MEDIA_DETACHED,this.onMediaDetached,this),e.on(D.BUFFER_CREATED,this.onBufferCreated,this)}unregisterListeners(){const e=this.hls;e.off(D.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(D.MEDIA_DETACHED,this.onMediaDetached,this),e.off(D.BUFFER_CREATED,this.onBufferCreated,this)}destroy(){this.unregisterListeners(),this.onMediaDetached(),this.hls=this.config=this.audioBuffer=this.videoBuffer=null,this.onWaiting=this.onPlaying=null}onMediaAttached(e,t){this.media=t.media,this.media.addEventListener("waiting",this.onWaiting),this.media.addEventListener("playing",this.onPlaying)}onMediaDetached(){this.media&&(this.media.removeEventListener("waiting",this.onWaiting),this.media.removeEventListener("playing",this.onPlaying),this.media=null)}onBufferCreated(e,t){var i,s;this.audioBuffer=(i=t.tracks.audio)==null?void 0:i.buffer,this.videoBuffer=(s=t.tracks.video)==null?void 0:s.buffer}createData(){var e;return{v:1,sf:gh.HLS,sid:this.sid,cid:this.cid,pr:(e=this.media)==null?void 0:e.playbackRate,mtp:this.hls.bandwidthEstimate/1e3}}apply(e,t={}){pt(t,this.createData());const i=t.ot===Nt.INIT||t.ot===Nt.VIDEO||t.ot===Nt.MUXED;this.starved&&i&&(t.bs=!0,t.su=!0,this.starved=!1),t.su==null&&(t.su=this.buffering);const{includeKeys:s}=this;s&&(t=Object.keys(t).reduce((r,o)=>(s.includes(o)&&(r[o]=t[o]),r),{})),this.useHeaders?(e.headers||(e.headers={}),n9(e.headers,t)):e.url=a9(e.url,t)}getObjectType(e){const{type:t}=e;if(t==="subtitle")return Nt.TIMED_TEXT;if(e.sn==="initSegment")return Nt.INIT;if(t==="audio")return Nt.AUDIO;if(t==="main")return this.hls.audioTracks.length?Nt.VIDEO:Nt.MUXED}getTopBandwidth(e){let t=0,i;const s=this.hls;if(e===Nt.AUDIO)i=s.audioTracks;else{const r=s.maxAutoLevel,o=r>-1?r+1:s.levels.length;i=s.levels.slice(0,o)}for(const r of i)r.bitrate>t&&(t=r.bitrate);return t>0?t:NaN}getBufferLength(e){const t=this.hls.media,i=e===Nt.AUDIO?this.audioBuffer:this.videoBuffer;return!i||!t?NaN:Ze.bufferInfo(i,t.currentTime,this.config.maxBufferHole).len*1e3}createPlaylistLoader(){const{pLoader:e}=this.config,t=this.applyPlaylistData,i=e||this.config.loader;return class{constructor(r){this.loader=void 0,this.loader=new i(r)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(r,o,a){t(r),this.loader.load(r,o,a)}}}createFragmentLoader(){const{fLoader:e}=this.config,t=this.applyFragmentData,i=e||this.config.loader;return class{constructor(r){this.loader=void 0,this.loader=new i(r)}get stats(){return this.loader.stats}get context(){return this.loader.context}destroy(){this.loader.destroy()}abort(){this.loader.abort()}load(r,o,a){t(r),this.loader.load(r,o,a)}}}}const c9=3e5;class Jg{constructor(e){this.hls=void 0,this.log=void 0,this.loader=null,this.uri=null,this.pathwayId=".",this.pathwayPriority=null,this.timeToLoad=300,this.reloadTimer=-1,this.updated=0,this.started=!1,this.enabled=!0,this.levels=null,this.audioTracks=null,this.subtitleTracks=null,this.penalizedPathways={},this.hls=e,this.log=j.log.bind(j,"[content-steering]:"),this.registerListeners()}registerListeners(){const e=this.hls;e.on(D.MANIFEST_LOADING,this.onManifestLoading,this),e.on(D.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(D.MANIFEST_PARSED,this.onManifestParsed,this),e.on(D.ERROR,this.onError,this)}unregisterListeners(){const e=this.hls;e&&(e.off(D.MANIFEST_LOADING,this.onManifestLoading,this),e.off(D.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(D.MANIFEST_PARSED,this.onManifestParsed,this),e.off(D.ERROR,this.onError,this))}startLoad(){if(this.started=!0,this.clearTimeout(),this.enabled&&this.uri){if(this.updated){const e=this.timeToLoad*1e3-(performance.now()-this.updated);if(e>0){this.scheduleRefresh(this.uri,e);return}}this.loadSteeringManifest(this.uri)}}stopLoad(){this.started=!1,this.loader&&(this.loader.destroy(),this.loader=null),this.clearTimeout()}clearTimeout(){this.reloadTimer!==-1&&(self.clearTimeout(this.reloadTimer),this.reloadTimer=-1)}destroy(){this.unregisterListeners(),this.stopLoad(),this.hls=null,this.levels=this.audioTracks=this.subtitleTracks=null}removeLevel(e){const t=this.levels;t&&(this.levels=t.filter(i=>i!==e))}onManifestLoading(){this.stopLoad(),this.enabled=!0,this.timeToLoad=300,this.updated=0,this.uri=null,this.pathwayId=".",this.levels=this.audioTracks=this.subtitleTracks=null}onManifestLoaded(e,t){const{contentSteering:i}=t;i!==null&&(this.pathwayId=i.pathwayId,this.uri=i.uri,this.started&&this.startLoad())}onManifestParsed(e,t){this.audioTracks=t.audioTracks,this.subtitleTracks=t.subtitleTracks}onError(e,t){const{errorAction:i}=t;if((i==null?void 0:i.action)===Ct.SendAlternateToPenaltyBox&&i.flags===Ei.MoveAllAlternatesMatchingHost){const s=this.levels;let r=this.pathwayPriority,o=this.pathwayId;if(t.context){const{groupId:a,pathwayId:c,type:l}=t.context;a&&s?o=this.getPathwayForGroupId(a,l,o):c&&(o=c)}o in this.penalizedPathways||(this.penalizedPathways[o]=performance.now()),!r&&s&&(r=s.reduce((a,c)=>(a.indexOf(c.pathwayId)===-1&&a.push(c.pathwayId),a),[])),r&&r.length>1&&(this.updatePathwayPriority(r),i.resolved=this.pathwayId!==o),i.resolved||j.warn(`Could not resolve ${t.details} ("${t.error.message}") with content-steering for Pathway: ${o} levels: ${s&&s.length} priorities: ${JSON.stringify(r)} penalized: ${JSON.stringify(this.penalizedPathways)}`)}}filterParsedLevels(e){this.levels=e;let t=this.getLevelsForPathway(this.pathwayId);if(t.length===0){const i=e[0].pathwayId;this.log(`No levels found in Pathway ${this.pathwayId}. Setting initial Pathway to "${i}"`),t=this.getLevelsForPathway(i),this.pathwayId=i}return t.length!==e.length&&this.log(`Found ${t.length}/${e.length} levels in Pathway "${this.pathwayId}"`),t}getLevelsForPathway(e){return this.levels===null?[]:this.levels.filter(t=>e===t.pathwayId)}updatePathwayPriority(e){this.pathwayPriority=e;let t;const i=this.penalizedPathways,s=performance.now();Object.keys(i).forEach(r=>{s-i[r]>c9&&delete i[r]});for(let r=0;r<e.length;r++){const o=e[r];if(o in i)continue;if(o===this.pathwayId)return;const a=this.hls.nextLoadLevel,c=this.hls.levels[a];if(t=this.getLevelsForPathway(o),t.length>0){this.log(`Setting Pathway to "${o}"`),this.pathwayId=o,ng(t),this.hls.trigger(D.LEVELS_UPDATED,{levels:t});const l=this.hls.levels[a];c&&l&&this.levels&&(l.attrs["STABLE-VARIANT-ID"]!==c.attrs["STABLE-VARIANT-ID"]&&l.bitrate!==c.bitrate&&this.log(`Unstable Pathways change from bitrate ${c.bitrate} to ${l.bitrate}`),this.hls.nextLoadLevel=a);break}}}getPathwayForGroupId(e,t,i){const s=this.getLevelsForPathway(i).concat(this.levels||[]);for(let r=0;r<s.length;r++)if(t===Ge.AUDIO_TRACK&&s[r].hasAudioGroup(e)||t===Ge.SUBTITLE_TRACK&&s[r].hasSubtitleGroup(e))return s[r].pathwayId;return i}clonePathways(e){const t=this.levels;if(!t)return;const i={},s={};e.forEach(r=>{const{ID:o,"BASE-ID":a,"URI-REPLACEMENT":c}=r;if(t.some(u=>u.pathwayId===o))return;const l=this.getLevelsForPathway(a).map(u=>{const h=new rt(u.attrs);h["PATHWAY-ID"]=o;const f=h.AUDIO&&`${h.AUDIO}_clone_${o}`,d=h.SUBTITLES&&`${h.SUBTITLES}_clone_${o}`;f&&(i[h.AUDIO]=f,h.AUDIO=f),d&&(s[h.SUBTITLES]=d,h.SUBTITLES=d);const p=qg(u.uri,h["STABLE-VARIANT-ID"],"PER-VARIANT-URIS",c),m=new un({attrs:h,audioCodec:u.audioCodec,bitrate:u.bitrate,height:u.height,name:u.name,url:p,videoCodec:u.videoCodec,width:u.width});if(u.audioGroups)for(let g=1;g<u.audioGroups.length;g++)m.addGroupId("audio",`${u.audioGroups[g]}_clone_${o}`);if(u.subtitleGroups)for(let g=1;g<u.subtitleGroups.length;g++)m.addGroupId("text",`${u.subtitleGroups[g]}_clone_${o}`);return m});t.push(...l),CA(this.audioTracks,i,c,o),CA(this.subtitleTracks,s,c,o)})}loadSteeringManifest(e){const t=this.hls.config,i=t.loader;this.loader&&this.loader.destroy(),this.loader=new i(t);let s;try{s=new self.URL(e)}catch{this.enabled=!1,this.log(`Failed to parse Steering Manifest URI: ${e}`);return}if(s.protocol!=="data:"){const u=(this.hls.bandwidthEstimate||t.abrEwmaDefaultEstimate)|0;s.searchParams.set("_HLS_pathway",this.pathwayId),s.searchParams.set("_HLS_throughput",""+u)}const r={responseType:"json",url:s.href},o=t.steeringManifestLoadPolicy.default,a=o.errorRetry||o.timeoutRetry||{},c={loadPolicy:o,timeout:o.maxLoadTimeMs,maxRetry:a.maxNumRetry||0,retryDelay:a.retryDelayMs||0,maxRetryDelay:a.maxRetryDelayMs||0},l={onSuccess:(u,h,f,d)=>{this.log(`Loaded steering manifest: "${s}"`);const p=u.data;if(p.VERSION!==1){this.log(`Steering VERSION ${p.VERSION} not supported!`);return}this.updated=performance.now(),this.timeToLoad=p.TTL;const{"RELOAD-URI":m,"PATHWAY-CLONES":g,"PATHWAY-PRIORITY":y}=p;if(m)try{this.uri=new self.URL(m,s).href}catch{this.enabled=!1,this.log(`Failed to parse Steering Manifest RELOAD-URI: ${m}`);return}this.scheduleRefresh(this.uri||f.url),g&&this.clonePathways(g);const v={steeringManifest:p,url:s.toString()};this.hls.trigger(D.STEERING_MANIFEST_LOADED,v),y&&this.updatePathwayPriority(y)},onError:(u,h,f,d)=>{if(this.log(`Error loading steering manifest: ${u.code} ${u.text} (${h.url})`),this.stopLoad(),u.code===410){this.enabled=!1,this.log(`Steering manifest ${h.url} no longer available`);return}let p=this.timeToLoad*1e3;if(u.code===429){const m=this.loader;if(typeof(m==null?void 0:m.getResponseHeader)=="function"){const g=m.getResponseHeader("Retry-After");g&&(p=parseFloat(g)*1e3)}this.log(`Steering manifest ${h.url} rate limited`);return}this.scheduleRefresh(this.uri||h.url,p)},onTimeout:(u,h,f)=>{this.log(`Timeout loading steering manifest (${h.url})`),this.scheduleRefresh(this.uri||h.url)}};this.log(`Requesting steering manifest: ${s}`),this.loader.load(r,c,l)}scheduleRefresh(e,t=this.timeToLoad*1e3){this.clearTimeout(),this.reloadTimer=self.setTimeout(()=>{var i;const s=(i=this.hls)==null?void 0:i.media;if(s&&!s.ended){this.loadSteeringManifest(e);return}this.scheduleRefresh(e,this.timeToLoad*1e3)},t)}}function CA(n,e,t,i){n&&Object.keys(e).forEach(s=>{const r=n.filter(o=>o.groupId===s).map(o=>{const a=pt({},o);return a.details=void 0,a.attrs=new rt(a.attrs),a.url=a.attrs.URI=qg(o.url,o.attrs["STABLE-RENDITION-ID"],"PER-RENDITION-URIS",t),a.groupId=a.attrs["GROUP-ID"]=e[s],a.attrs["PATHWAY-ID"]=i,a});n.push(...r)})}function qg(n,e,t,i){const{HOST:s,PARAMS:r,[t]:o}=i;let a;e&&(a=o==null?void 0:o[e],a&&(n=a));const c=new self.URL(n);return s&&!a&&(c.host=s),r&&Object.keys(r).sort().forEach(l=>{l&&c.searchParams.set(l,r[l])}),c.href}const l9=/^age:\s*[\d.]+\s*$/im;class Xg{constructor(e){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=null,this.loader=null,this.stats=void 0,this.xhrSetup=e&&e.xhrSetup||null,this.stats=new Qo,this.retryDelay=0}destroy(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null,this.context=null,this.xhrSetup=null}abortInternal(){const e=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),e&&(e.onreadystatechange=null,e.onprogress=null,e.readyState!==4&&(this.stats.aborted=!0,e.abort()))}abort(){var e;this.abortInternal(),(e=this.callbacks)!=null&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)}load(e,t,i){if(this.stats.loading.start)throw new Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=e,this.config=t,this.callbacks=i,this.loadInternal()}loadInternal(){const{config:e,context:t}=this;if(!e||!t)return;const i=this.loader=new self.XMLHttpRequest,s=this.stats;s.loading.first=0,s.loaded=0,s.aborted=!1;const r=this.xhrSetup;r?Promise.resolve().then(()=>{if(!(this.loader!==i||this.stats.aborted))return r(i,t.url)}).catch(o=>{if(!(this.loader!==i||this.stats.aborted))return i.open("GET",t.url,!0),r(i,t.url)}).then(()=>{this.loader!==i||this.stats.aborted||this.openAndSendXhr(i,t,e)}).catch(o=>{this.callbacks.onError({code:i.status,text:o.message},t,i,s)}):this.openAndSendXhr(i,t,e)}openAndSendXhr(e,t,i){e.readyState||e.open("GET",t.url,!0);const s=t.headers,{maxTimeToFirstByteMs:r,maxLoadTimeMs:o}=i.loadPolicy;if(s)for(const a in s)e.setRequestHeader(a,s[a]);t.rangeEnd&&e.setRequestHeader("Range","bytes="+t.rangeStart+"-"+(t.rangeEnd-1)),e.onreadystatechange=this.readystatechange.bind(this),e.onprogress=this.loadprogress.bind(this),e.responseType=t.responseType,self.clearTimeout(this.requestTimeout),i.timeout=r&&ve(r)?r:o,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),i.timeout),e.send()}readystatechange(){const{context:e,loader:t,stats:i}=this;if(!e||!t)return;const s=t.readyState,r=this.config;if(!i.aborted&&s>=2&&(i.loading.first===0&&(i.loading.first=Math.max(self.performance.now(),i.loading.start),r.timeout!==r.loadPolicy.maxLoadTimeMs&&(self.clearTimeout(this.requestTimeout),r.timeout=r.loadPolicy.maxLoadTimeMs,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),r.loadPolicy.maxLoadTimeMs-(i.loading.first-i.loading.start)))),s===4)){self.clearTimeout(this.requestTimeout),t.onreadystatechange=null,t.onprogress=null;const o=t.status,a=t.responseType!=="text";if(o>=200&&o<300&&(a&&t.response||t.responseText!==null)){i.loading.end=Math.max(self.performance.now(),i.loading.first);const c=a?t.response:t.responseText,l=t.responseType==="arraybuffer"?c.byteLength:c.length;if(i.loaded=i.total=l,i.bwEstimate=i.total*8e3/(i.loading.end-i.loading.first),!this.callbacks)return;const u=this.callbacks.onProgress;if(u&&u(i,e,c,t),!this.callbacks)return;const h={url:t.responseURL,data:c,code:o};this.callbacks.onSuccess(h,i,e,t)}else{const c=r.loadPolicy.errorRetry,l=i.retry,u={url:e.url,data:void 0,code:o};Cc(c,l,!1,u)?this.retry(c):(j.error(`${o} while loading ${e.url}`),this.callbacks.onError({code:o,text:t.statusText},e,t,i))}}}loadtimeout(){if(!this.config)return;const e=this.config.loadPolicy.timeoutRetry,t=this.stats.retry;if(Cc(e,t,!0))this.retry(e);else{var i;j.warn(`timeout while loading ${(i=this.context)==null?void 0:i.url}`);const s=this.callbacks;s&&(this.abortInternal(),s.onTimeout(this.stats,this.context,this.loader))}}retry(e){const{context:t,stats:i}=this;this.retryDelay=uf(e,i.retry),i.retry++,j.warn(`${status?"HTTP Status "+status:"Timeout"} while loading ${t==null?void 0:t.url}, retrying ${i.retry}/${e.maxNumRetry} in ${this.retryDelay}ms`),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay)}loadprogress(e){const t=this.stats;t.loaded=e.loaded,e.lengthComputable&&(t.total=e.total)}getCacheAge(){let e=null;if(this.loader&&l9.test(this.loader.getAllResponseHeaders())){const t=this.loader.getResponseHeader("age");e=t?parseFloat(t):null}return e}getResponseHeader(e){return this.loader&&new RegExp(`^${e}:\\s*[\\d.]+\\s*$`,"im").test(this.loader.getAllResponseHeaders())?this.loader.getResponseHeader(e):null}}function u9(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch{}return!1}const h9=/(\d+)-(\d+)\/(\d+)/;class IA{constructor(e){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=null,this.response=null,this.controller=void 0,this.context=null,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=e.fetchSetup||m9,this.controller=new self.AbortController,this.stats=new Qo}destroy(){this.loader=this.callbacks=this.context=this.config=this.request=null,this.abortInternal(),this.response=null,this.fetchSetup=this.controller=this.stats=null}abortInternal(){this.controller&&!this.stats.loading.end&&(this.stats.aborted=!0,this.controller.abort())}abort(){var e;this.abortInternal(),(e=this.callbacks)!=null&&e.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)}load(e,t,i){const s=this.stats;if(s.loading.start)throw new Error("Loader can only be used once.");s.loading.start=self.performance.now();const r=f9(e,this.controller.signal),o=i.onProgress,a=e.responseType==="arraybuffer",c=a?"byteLength":"length",{maxTimeToFirstByteMs:l,maxLoadTimeMs:u}=t.loadPolicy;this.context=e,this.config=t,this.callbacks=i,this.request=this.fetchSetup(e,r),self.clearTimeout(this.requestTimeout),t.timeout=l&&ve(l)?l:u,this.requestTimeout=self.setTimeout(()=>{this.abortInternal(),i.onTimeout(s,e,this.response)},t.timeout),self.fetch(this.request).then(h=>{this.response=this.loader=h;const f=Math.max(self.performance.now(),s.loading.start);if(self.clearTimeout(this.requestTimeout),t.timeout=u,this.requestTimeout=self.setTimeout(()=>{this.abortInternal(),i.onTimeout(s,e,this.response)},u-(f-s.loading.start)),!h.ok){const{status:d,statusText:p}=h;throw new p9(p||"fetch, bad network response",d,h)}return s.loading.first=f,s.total=A9(h.headers)||s.total,o&&ve(t.highWaterMark)?this.loadProgressively(h,s,e,t.highWaterMark,o):a?h.arrayBuffer():e.responseType==="json"?h.json():h.text()}).then(h=>{const f=this.response;if(!f)throw new Error("loader destroyed");self.clearTimeout(this.requestTimeout),s.loading.end=Math.max(self.performance.now(),s.loading.first);const d=h[c];d&&(s.loaded=s.total=d);const p={url:f.url,data:h,code:f.status};o&&!ve(t.highWaterMark)&&o(s,e,h,f),i.onSuccess(p,s,e,f)}).catch(h=>{if(self.clearTimeout(this.requestTimeout),s.aborted)return;const f=h&&h.code||0,d=h?h.message:null;i.onError({code:f,text:d},e,h?h.details:null,s)})}getCacheAge(){let e=null;if(this.response){const t=this.response.headers.get("age");e=t?parseFloat(t):null}return e}getResponseHeader(e){return this.response?this.response.headers.get(e):null}loadProgressively(e,t,i,s=0,r){const o=new ug,a=e.body.getReader(),c=()=>a.read().then(l=>{if(l.done)return o.dataLength&&r(t,i,o.flush(),e),Promise.resolve(new ArrayBuffer(0));const u=l.value,h=u.length;return t.loaded+=h,h<s||o.dataLength?(o.push(u),o.dataLength>=s&&r(t,i,o.flush(),e)):r(t,i,u,e),c()}).catch(()=>Promise.reject());return c()}}function f9(n,e){const t={method:"GET",mode:"cors",credentials:"same-origin",signal:e,headers:new self.Headers(pt({},n.headers))};return n.rangeEnd&&t.headers.set("Range","bytes="+n.rangeStart+"-"+String(n.rangeEnd-1)),t}function d9(n){const e=h9.exec(n);if(e)return parseInt(e[2])-parseInt(e[1])+1}function A9(n){const e=n.get("Content-Range");if(e){const i=d9(e);if(ve(i))return i}const t=n.get("Content-Length");if(t)return parseInt(t)}function m9(n,e){return new self.Request(n.url,e)}class p9 extends Error{constructor(e,t,i){super(e),this.code=void 0,this.details=void 0,this.code=t,this.details=i}}const g9=/\s/,y9={newCue(n,e,t,i){const s=[];let r,o,a,c,l;const u=self.VTTCue||self.TextTrackCue;for(let f=0;f<i.rows.length;f++)if(r=i.rows[f],a=!0,c=0,l="",!r.isEmpty()){var h;for(let m=0;m<r.chars.length;m++)g9.test(r.chars[m].uchar)&&a?c++:(l+=r.chars[m].uchar,a=!1);r.cueStartTime=e,e===t&&(t+=1e-4),c>=16?c--:c++;const d=Og(l.trim()),p=yf(e,t,d);n!=null&&(h=n.cues)!=null&&h.getCueById(p)||(o=new u(e,t,d),o.id=p,o.line=f+1,o.align="left",o.position=10+Math.min(80,Math.floor(c*8/32)*10),s.push(o))}return n&&s.length&&(s.sort((f,d)=>f.line==="auto"||d.line==="auto"?0:f.line>8&&d.line>8?d.line-f.line:f.line-d.line),s.forEach(f=>eg(n,f))),s}},E9={maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:null,errorRetry:null},Zg=Mt(Mt({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,ignoreDevicePixelRatio:!1,preferManagedMediaSource:!0,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,frontBufferFlushThreshold:1/0,maxBufferSize:60*1e3*1e3,maxBufferHole:.1,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,maxFragLookUpTolerance:.25,liveSyncDurationCount:3,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,workerPath:null,enableSoftwareAES:!0,startLevel:void 0,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,loader:Xg,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:cg,bufferController:Mg,capLevelController:Kc,errorController:og,fpsController:Hg,stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrEwmaDefaultEstimateMax:5e6,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystems:{},drmSystemOptions:{},requestMediaKeySystemAccessFunc:Np,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0,enableDateRangeMetadataCues:!0,enableEmsgMetadataCues:!0,enableID3MetadataCues:!0,useMediaCapabilities:!0,certLoadPolicy:{default:E9},keyLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"},errorRetry:{maxNumRetry:8,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"}}},manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1/0,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:12e4,timeoutRetry:{maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},steeringManifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3},v9()),{},{subtitleStreamController:Rg,subtitleTrackController:Dg,timelineController:Gg,audioStreamController:_g,audioTrackController:bg,emeController:cn,cmcdController:jg,contentSteeringController:Jg});function v9(){return{cueHandler:y9,enableWebVTT:!0,enableIMSC1:!0,enableCEA708Captions:!0,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}}function x9(n,e){if((e.liveSyncDurationCount||e.liveMaxLatencyDurationCount)&&(e.liveSyncDuration||e.liveMaxLatencyDuration))throw new Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(e.liveMaxLatencyDurationCount!==void 0&&(e.liveSyncDurationCount===void 0||e.liveMaxLatencyDurationCount<=e.liveSyncDurationCount))throw new Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"');if(e.liveMaxLatencyDuration!==void 0&&(e.liveSyncDuration===void 0||e.liveMaxLatencyDuration<=e.liveSyncDuration))throw new Error('Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"');const t=vh(n),i=["manifest","level","frag"],s=["TimeOut","MaxRetry","RetryDelay","MaxRetryTimeout"];return i.forEach(r=>{const o=`${r==="level"?"playlist":r}LoadPolicy`,a=e[o]===void 0,c=[];s.forEach(l=>{const u=`${r}Loading${l}`,h=e[u];if(h!==void 0&&a){c.push(u);const f=t[o].default;switch(e[o]={default:f},l){case"TimeOut":f.maxLoadTimeMs=h,f.maxTimeToFirstByteMs=h;break;case"MaxRetry":f.errorRetry.maxNumRetry=h,f.timeoutRetry.maxNumRetry=h;break;case"RetryDelay":f.errorRetry.retryDelayMs=h,f.timeoutRetry.retryDelayMs=h;break;case"MaxRetryTimeout":f.errorRetry.maxRetryDelayMs=h,f.timeoutRetry.maxRetryDelayMs=h;break}}}),c.length&&j.warn(`hls.js config: "${c.join('", "')}" setting(s) are deprecated, use "${o}": ${JSON.stringify(e[o])}`)}),Mt(Mt({},t),e)}function vh(n){return n&&typeof n=="object"?Array.isArray(n)?n.map(vh):Object.keys(n).reduce((e,t)=>(e[t]=vh(n[t]),e),{}):n}function C9(n){const e=n.loader;e!==IA&&e!==Xg?(j.log("[config]: Custom loader detected, cannot enable progressive streaming"),n.progressive=!1):u9()&&(n.loader=IA,n.progressive=!0,n.enableSoftwareAES=!0,j.log("[config]: Progressive streaming enabled, using FetchLoader"))}let ou;class I9 extends Gc{constructor(e,t){super(e,"[level-controller]"),this._levels=[],this._firstLevel=-1,this._maxAutoLevel=-1,this._startLevel=void 0,this.currentLevel=null,this.currentLevelIndex=-1,this.manualLevelIndex=-1,this.steering=void 0,this.onParsedComplete=void 0,this.steering=t,this._registerListeners()}_registerListeners(){const{hls:e}=this;e.on(D.MANIFEST_LOADING,this.onManifestLoading,this),e.on(D.MANIFEST_LOADED,this.onManifestLoaded,this),e.on(D.LEVEL_LOADED,this.onLevelLoaded,this),e.on(D.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(D.FRAG_BUFFERED,this.onFragBuffered,this),e.on(D.ERROR,this.onError,this)}_unregisterListeners(){const{hls:e}=this;e.off(D.MANIFEST_LOADING,this.onManifestLoading,this),e.off(D.MANIFEST_LOADED,this.onManifestLoaded,this),e.off(D.LEVEL_LOADED,this.onLevelLoaded,this),e.off(D.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(D.FRAG_BUFFERED,this.onFragBuffered,this),e.off(D.ERROR,this.onError,this)}destroy(){this._unregisterListeners(),this.steering=null,this.resetLevels(),super.destroy()}stopLoad(){this._levels.forEach(t=>{t.loadError=0,t.fragmentError=0}),super.stopLoad()}resetLevels(){this._startLevel=void 0,this.manualLevelIndex=-1,this.currentLevelIndex=-1,this.currentLevel=null,this._levels=[],this._maxAutoLevel=-1}onManifestLoading(e,t){this.resetLevels()}onManifestLoaded(e,t){const i=this.hls.config.preferManagedMediaSource,s=[],r={},o={};let a=!1,c=!1,l=!1;t.levels.forEach(u=>{var h,f;const d=u.attrs;let{audioCodec:p,videoCodec:m}=u;((h=p)==null?void 0:h.indexOf("mp4a.40.34"))!==-1&&(ou||(ou=/chrome|firefox/i.test(navigator.userAgent)),ou&&(u.audioCodec=p=void 0)),p&&(u.audioCodec=p=Ec(p,i)),((f=m)==null?void 0:f.indexOf("avc1"))===0&&(m=u.videoCodec=v5(m));const{width:g,height:y,unknownCodecs:v}=u;if(a||(a=!!(g&&y)),c||(c=!!m),l||(l=!!p),v!=null&&v.length||p&&!Vl(p,"audio",i)||m&&!Vl(m,"video",i))return;const{CODECS:E,"FRAME-RATE":C,"HDCP-LEVEL":x,"PATHWAY-ID":I,RESOLUTION:S,"VIDEO-RANGE":w}=d,T=`${`${I||"."}-`}${u.bitrate}-${S}-${C}-${E}-${w}-${x}`;if(r[T])if(r[T].uri!==u.url&&!u.attrs["PATHWAY-ID"]){const R=o[T]+=1;u.attrs["PATHWAY-ID"]=new Array(R+1).join(".");const _=new un(u);r[T]=_,s.push(_)}else r[T].addGroupId("audio",d.AUDIO),r[T].addGroupId("text",d.SUBTITLES);else{const R=new un(u);r[T]=R,o[T]=1,s.push(R)}}),this.filterAndSortMediaOptions(s,t,a,c,l)}filterAndSortMediaOptions(e,t,i,s,r){let o=[],a=[],c=e;if((i||s)&&r&&(c=c.filter(({videoCodec:p,videoRange:m,width:g,height:y})=>(!!p||!!(g&&y))&&L5(m))),c.length===0){Promise.resolve().then(()=>{if(this.hls){t.levels.length&&this.warn(`One or more CODECS in variant not supported: ${JSON.stringify(t.levels[0].attrs)}`);const p=new Error("no level with compatible codecs found in manifest");this.hls.trigger(D.ERROR,{type:_e.MEDIA_ERROR,details:te.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:t.url,error:p,reason:p.message})}});return}if(t.audioTracks){const{preferManagedMediaSource:p}=this.hls.config;o=t.audioTracks.filter(m=>!m.audioCodec||Vl(m.audioCodec,"audio",p)),SA(o)}t.subtitles&&(a=t.subtitles,SA(a));const l=c.slice(0);c.sort((p,m)=>{if(p.attrs["HDCP-LEVEL"]!==m.attrs["HDCP-LEVEL"])return(p.attrs["HDCP-LEVEL"]||"")>(m.attrs["HDCP-LEVEL"]||"")?1:-1;if(i&&p.height!==m.height)return p.height-m.height;if(p.frameRate!==m.frameRate)return p.frameRate-m.frameRate;if(p.videoRange!==m.videoRange)return vc.indexOf(p.videoRange)-vc.indexOf(m.videoRange);if(p.videoCodec!==m.videoCodec){const g=M0(p.videoCodec),y=M0(m.videoCodec);if(g!==y)return y-g}if(p.uri===m.uri&&p.codecSet!==m.codecSet){const g=yc(p.codecSet),y=yc(m.codecSet);if(g!==y)return y-g}return p.averageBitrate!==m.averageBitrate?p.averageBitrate-m.averageBitrate:0});let u=l[0];if(this.steering&&(c=this.steering.filterParsedLevels(c),c.length!==l.length)){for(let p=0;p<l.length;p++)if(l[p].pathwayId===c[0].pathwayId){u=l[p];break}}this._levels=c;for(let p=0;p<c.length;p++)if(c[p]===u){var h;this._firstLevel=p;const m=u.bitrate,g=this.hls.bandwidthEstimate;if(this.log(`manifest loaded, ${c.length} level(s) found, first bitrate: ${m}`),((h=this.hls.userConfig)==null?void 0:h.abrEwmaDefaultEstimate)===void 0){const y=Math.min(m,this.hls.config.abrEwmaDefaultEstimateMax);y>g&&g===Zg.abrEwmaDefaultEstimate&&(this.hls.bandwidthEstimate=y)}break}const f=r&&!s,d={levels:c,audioTracks:o,subtitleTracks:a,sessionData:t.sessionData,sessionKeys:t.sessionKeys,firstLevel:this._firstLevel,stats:t.stats,audio:r,video:s,altAudio:!f&&o.some(p=>!!p.url)};this.hls.trigger(D.MANIFEST_PARSED,d),(this.hls.config.autoStartLoad||this.hls.forceStartLoad)&&this.hls.startLoad(this.hls.config.startPosition)}get levels(){return this._levels.length===0?null:this._levels}get level(){return this.currentLevelIndex}set level(e){const t=this._levels;if(t.length===0)return;if(e<0||e>=t.length){const u=new Error("invalid level idx"),h=e<0;if(this.hls.trigger(D.ERROR,{type:_e.OTHER_ERROR,details:te.LEVEL_SWITCH_ERROR,level:e,fatal:h,error:u,reason:u.message}),h)return;e=Math.min(e,t.length-1)}const i=this.currentLevelIndex,s=this.currentLevel,r=s?s.attrs["PATHWAY-ID"]:void 0,o=t[e],a=o.attrs["PATHWAY-ID"];if(this.currentLevelIndex=e,this.currentLevel=o,i===e&&o.details&&s&&r===a)return;this.log(`Switching to level ${e} (${o.height?o.height+"p ":""}${o.videoRange?o.videoRange+" ":""}${o.codecSet?o.codecSet+" ":""}@${o.bitrate})${a?" with Pathway "+a:""} from level ${i}${r?" with Pathway "+r:""}`);const c={level:e,attrs:o.attrs,details:o.details,bitrate:o.bitrate,averageBitrate:o.averageBitrate,maxBitrate:o.maxBitrate,realBitrate:o.realBitrate,width:o.width,height:o.height,codecSet:o.codecSet,audioCodec:o.audioCodec,videoCodec:o.videoCodec,audioGroups:o.audioGroups,subtitleGroups:o.subtitleGroups,loaded:o.loaded,loadError:o.loadError,fragmentError:o.fragmentError,name:o.name,id:o.id,uri:o.uri,url:o.url,urlId:0,audioGroupIds:o.audioGroupIds,textGroupIds:o.textGroupIds};this.hls.trigger(D.LEVEL_SWITCHING,c);const l=o.details;if(!l||l.live){const u=this.switchParams(o.uri,s==null?void 0:s.details,l);this.loadPlaylist(u)}}get manualLevel(){return this.manualLevelIndex}set manualLevel(e){this.manualLevelIndex=e,this._startLevel===void 0&&(this._startLevel=e),e!==-1&&(this.level=e)}get firstLevel(){return this._firstLevel}set firstLevel(e){this._firstLevel=e}get startLevel(){if(this._startLevel===void 0){const e=this.hls.config.startLevel;return e!==void 0?e:this.hls.firstAutoLevel}return this._startLevel}set startLevel(e){this._startLevel=e}onError(e,t){t.fatal||!t.context||t.context.type===Ge.LEVEL&&t.context.level===this.level&&this.checkRetry(t)}onFragBuffered(e,{frag:t}){if(t!==void 0&&t.type===we.MAIN){const i=t.elementaryStreams;if(!Object.keys(i).some(r=>!!i[r]))return;const s=this._levels[t.level];s!=null&&s.loadError&&(this.log(`Resetting level error count of ${s.loadError} on frag buffered`),s.loadError=0)}}onLevelLoaded(e,t){var i;const{level:s,details:r}=t,o=this._levels[s];if(!o){var a;this.warn(`Invalid level index ${s}`),(a=t.deliveryDirectives)!=null&&a.skip&&(r.deltaUpdateFailed=!0);return}s===this.currentLevelIndex?(o.fragmentError===0&&(o.loadError=0),this.playlistLoaded(s,t,o.details)):(i=t.deliveryDirectives)!=null&&i.skip&&(r.deltaUpdateFailed=!0)}loadPlaylist(e){super.loadPlaylist();const t=this.currentLevelIndex,i=this.currentLevel;if(i&&this.shouldLoadPlaylist(i)){let s=i.uri;if(e)try{s=e.addDirectives(s)}catch(o){this.warn(`Could not construct new URL with HLS Delivery Directives: ${o}`)}const r=i.attrs["PATHWAY-ID"];this.log(`Loading level index ${t}${(e==null?void 0:e.msn)!==void 0?" at sn "+e.msn+" part "+e.part:""} with${r?" Pathway "+r:""} ${s}`),this.clearTimer(),this.hls.trigger(D.LEVEL_LOADING,{url:s,level:t,pathwayId:i.attrs["PATHWAY-ID"],id:0,deliveryDirectives:e||null})}}get nextLoadLevel(){return this.manualLevelIndex!==-1?this.manualLevelIndex:this.hls.nextAutoLevel}set nextLoadLevel(e){this.level=e,this.manualLevelIndex===-1&&(this.hls.nextAutoLevel=e)}removeLevel(e){var t;const i=this._levels.filter((s,r)=>r!==e?!0:(this.steering&&this.steering.removeLevel(s),s===this.currentLevel&&(this.currentLevel=null,this.currentLevelIndex=-1,s.details&&s.details.fragments.forEach(o=>o.level=-1)),!1));ng(i),this._levels=i,this.currentLevelIndex>-1&&(t=this.currentLevel)!=null&&t.details&&(this.currentLevelIndex=this.currentLevel.details.fragments[0].level),this.hls.trigger(D.LEVELS_UPDATED,{levels:i})}onLevelsUpdated(e,{levels:t}){this._levels=t}checkMaxAutoUpdated(){const{autoLevelCapping:e,maxAutoLevel:t,maxHdcpLevel:i}=this.hls;this._maxAutoLevel!==t&&(this._maxAutoLevel=t,this.hls.trigger(D.MAX_AUTO_LEVEL_UPDATED,{autoLevelCapping:e,levels:this.levels,maxAutoLevel:t,minAutoLevel:this.hls.minAutoLevel,maxHdcpLevel:i}))}}function SA(n){const e={};n.forEach(t=>{const i=t.groupId||"";t.id=e[i]=e[i]||0,e[i]++})}class S9{constructor(e){this.config=void 0,this.keyUriToKeyInfo={},this.emeController=null,this.config=e}abort(e){for(const i in this.keyUriToKeyInfo){const s=this.keyUriToKeyInfo[i].loader;if(s){var t;if(e&&e!==((t=s.context)==null?void 0:t.frag.type))return;s.abort()}}}detach(){for(const e in this.keyUriToKeyInfo){const t=this.keyUriToKeyInfo[e];(t.mediaKeySessionContext||t.decryptdata.isCommonEncryption)&&delete this.keyUriToKeyInfo[e]}}destroy(){this.detach();for(const e in this.keyUriToKeyInfo){const t=this.keyUriToKeyInfo[e].loader;t&&t.destroy()}this.keyUriToKeyInfo={}}createKeyLoadError(e,t=te.KEY_LOAD_ERROR,i,s,r){return new Es({type:_e.NETWORK_ERROR,details:t,fatal:!1,frag:e,response:r,error:i,networkDetails:s})}loadClear(e,t){if(this.emeController&&this.config.emeEnabled){const{sn:i,cc:s}=e;for(let r=0;r<t.length;r++){const o=t[r];if(s<=o.cc&&(i==="initSegment"||o.sn==="initSegment"||i<o.sn)){this.emeController.selectKeySystemFormat(o).then(a=>{o.setKeyFormat(a)});break}}}}load(e){return!e.decryptdata&&e.encrypted&&this.emeController?this.emeController.selectKeySystemFormat(e).then(t=>this.loadInternal(e,t)):this.loadInternal(e)}loadInternal(e,t){var i,s;t&&e.setKeyFormat(t);const r=e.decryptdata;if(!r){const l=new Error(t?`Expected frag.decryptdata to be defined after setting format ${t}`:"Missing decryption data on fragment in onKeyLoading");return Promise.reject(this.createKeyLoadError(e,te.KEY_LOAD_ERROR,l))}const o=r.uri;if(!o)return Promise.reject(this.createKeyLoadError(e,te.KEY_LOAD_ERROR,new Error(`Invalid key URI: "${o}"`)));let a=this.keyUriToKeyInfo[o];if((i=a)!=null&&i.decryptdata.key)return r.key=a.decryptdata.key,Promise.resolve({frag:e,keyInfo:a});if((s=a)!=null&&s.keyLoadPromise){var c;switch((c=a.mediaKeySessionContext)==null?void 0:c.keyStatus){case void 0:case"status-pending":case"usable":case"usable-in-future":return a.keyLoadPromise.then(l=>(r.key=l.keyInfo.decryptdata.key,{frag:e,keyInfo:a}))}}switch(a=this.keyUriToKeyInfo[o]={decryptdata:r,keyLoadPromise:null,loader:null,mediaKeySessionContext:null},r.method){case"ISO-23001-7":case"SAMPLE-AES":case"SAMPLE-AES-CENC":case"SAMPLE-AES-CTR":return r.keyFormat==="identity"?this.loadKeyHTTP(a,e):this.loadKeyEME(a,e);case"AES-128":return this.loadKeyHTTP(a,e);default:return Promise.reject(this.createKeyLoadError(e,te.KEY_LOAD_ERROR,new Error(`Key supplied with unsupported METHOD: "${r.method}"`)))}}loadKeyEME(e,t){const i={frag:t,keyInfo:e};if(this.emeController&&this.config.emeEnabled){const s=this.emeController.loadKey(i);if(s)return(e.keyLoadPromise=s.then(r=>(e.mediaKeySessionContext=r,i))).catch(r=>{throw e.keyLoadPromise=null,r})}return Promise.resolve(i)}loadKeyHTTP(e,t){const i=this.config,s=i.loader,r=new s(i);return t.keyLoader=e.loader=r,e.keyLoadPromise=new Promise((o,a)=>{const c={keyInfo:e,frag:t,responseType:"arraybuffer",url:e.decryptdata.uri},l=i.keyLoadPolicy.default,u={loadPolicy:l,timeout:l.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0},h={onSuccess:(f,d,p,m)=>{const{frag:g,keyInfo:y,url:v}=p;if(!g.decryptdata||y!==this.keyUriToKeyInfo[v])return a(this.createKeyLoadError(g,te.KEY_LOAD_ERROR,new Error("after key load, decryptdata unset or changed"),m));y.decryptdata.key=g.decryptdata.key=new Uint8Array(f.data),g.keyLoader=null,y.loader=null,o({frag:g,keyInfo:y})},onError:(f,d,p,m)=>{this.resetLoader(d),a(this.createKeyLoadError(t,te.KEY_LOAD_ERROR,new Error(`HTTP Error ${f.code} loading key ${f.text}`),p,Mt({url:c.url,data:void 0},f)))},onTimeout:(f,d,p)=>{this.resetLoader(d),a(this.createKeyLoadError(t,te.KEY_LOAD_TIMEOUT,new Error("key loading timed out"),p))},onAbort:(f,d,p)=>{this.resetLoader(d),a(this.createKeyLoadError(t,te.INTERNAL_ABORTED,new Error("key loading aborted"),p))}};r.load(c,u,h)})}resetLoader(e){const{frag:t,keyInfo:i,url:s}=e,r=i.loader;t.keyLoader===r&&(t.keyLoader=null,i.loader=null),delete this.keyUriToKeyInfo[s],r&&r.destroy()}}function e2(){return self.SourceBuffer||self.WebKitSourceBuffer}function vf(){if(!zs())return!1;const e=e2();return!e||e.prototype&&typeof e.prototype.appendBuffer=="function"&&typeof e.prototype.remove=="function"}function t2(){if(!vf())return!1;const n=zs();return typeof(n==null?void 0:n.isTypeSupported)=="function"&&(["avc1.42E01E,mp4a.40.2","av01.0.01M.08","vp09.00.50.08"].some(e=>n.isTypeSupported(Lo(e,"video")))||["mp4a.40.2","fLaC"].some(e=>n.isTypeSupported(Lo(e,"audio"))))}function w9(){var n;const e=e2();return typeof(e==null||(n=e.prototype)==null?void 0:n.changeType)=="function"}const T9=250,nc=2,B9=.1,_9=.05;class b9{constructor(e,t,i,s){this.config=void 0,this.media=null,this.fragmentTracker=void 0,this.hls=void 0,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.config=e,this.media=t,this.fragmentTracker=i,this.hls=s}destroy(){this.media=null,this.hls=this.fragmentTracker=null}poll(e,t){const{config:i,media:s,stalled:r}=this;if(s===null)return;const{currentTime:o,seeking:a}=s,c=this.seeking&&!a,l=!this.seeking&&a;if(this.seeking=a,o!==e){if(this.moved=!0,a||(this.nudgeRetry=0),r!==null){if(this.stallReported){const g=self.performance.now()-r;j.warn(`playback not stuck anymore @${o}, after ${Math.round(g)}ms`),this.stallReported=!1}this.stalled=null}return}if(l||c){this.stalled=null;return}if(s.paused&&!a||s.ended||s.playbackRate===0||!Ze.getBuffered(s).length){this.nudgeRetry=0;return}const u=Ze.bufferInfo(s,o,0),h=u.nextStart||0;if(a){const g=u.len>nc,y=!h||t&&t.start<=o||h-o>nc&&!this.fragmentTracker.getPartialFragment(o);if(g||y)return;this.moved=!1}if(!this.moved&&this.stalled!==null){var f;if(!(u.len>0)&&!h)return;const y=Math.max(h,u.start||0)-o,v=this.hls.levels?this.hls.levels[this.hls.currentLevel]:null,C=(v==null||(f=v.details)==null?void 0:f.live)?v.details.targetduration*2:nc,x=this.fragmentTracker.getPartialFragment(o);if(y>0&&(y<=C||x)){s.paused||this._trySkipBufferHole(x);return}}const d=self.performance.now();if(r===null){this.stalled=d;return}const p=d-r;if(!a&&p>=T9&&(this._reportStall(u),!this.media))return;const m=Ze.bufferInfo(s,o,i.maxBufferHole);this._tryFixBufferStall(m,p)}_tryFixBufferStall(e,t){const{config:i,fragmentTracker:s,media:r}=this;if(r===null)return;const o=r.currentTime,a=s.getPartialFragment(o);a&&(this._trySkipBufferHole(a)||!this.media)||(e.len>i.maxBufferHole||e.nextStart&&e.nextStart-o<i.maxBufferHole)&&t>i.highBufferWatchdogPeriod*1e3&&(j.warn("Trying to nudge playhead over buffer-hole"),this.stalled=null,this._tryNudgeBuffer())}_reportStall(e){const{hls:t,media:i,stallReported:s}=this;if(!s&&i){this.stallReported=!0;const r=new Error(`Playback stalling at @${i.currentTime} due to low buffer (${JSON.stringify(e)})`);j.warn(r.message),t.trigger(D.ERROR,{type:_e.MEDIA_ERROR,details:te.BUFFER_STALLED_ERROR,fatal:!1,error:r,buffer:e.len})}}_trySkipBufferHole(e){const{config:t,hls:i,media:s}=this;if(s===null)return 0;const r=s.currentTime,o=Ze.bufferInfo(s,r,0),a=r<o.start?o.start:o.nextStart;if(a){const c=o.len<=t.maxBufferHole,l=o.len>0&&o.len<1&&s.readyState<3,u=a-r;if(u>0&&(c||l)){if(u>t.maxBufferHole){const{fragmentTracker:f}=this;let d=!1;if(r===0){const p=f.getAppendedFrag(0,we.MAIN);p&&a<p.end&&(d=!0)}if(!d){const p=e||f.getAppendedFrag(r,we.MAIN);if(p){let m=!1,g=p.end;for(;g<a;){const y=f.getPartialFragment(g);if(y)g+=y.duration;else{m=!0;break}}if(m)return 0}}}const h=Math.max(a+_9,r+B9);if(j.warn(`skipping hole, adjusting currentTime from ${r} to ${h}`),this.moved=!0,this.stalled=null,s.currentTime=h,e&&!e.gap){const f=new Error(`fragment loaded with buffer holes, seeking from ${r} to ${h}`);i.trigger(D.ERROR,{type:_e.MEDIA_ERROR,details:te.BUFFER_SEEK_OVER_HOLE,fatal:!1,error:f,reason:f.message,frag:e})}return h}}return 0}_tryNudgeBuffer(){const{config:e,hls:t,media:i,nudgeRetry:s}=this;if(i===null)return;const r=i.currentTime;if(this.nudgeRetry++,s<e.nudgeMaxRetry){const o=r+(s+1)*e.nudgeOffset,a=new Error(`Nudging 'currentTime' from ${r} to ${o}`);j.warn(a.message),i.currentTime=o,t.trigger(D.ERROR,{type:_e.MEDIA_ERROR,details:te.BUFFER_NUDGE_ON_STALL,error:a,fatal:!1})}else{const o=new Error(`Playhead still not moving while enough data buffered @${r} after ${e.nudgeMaxRetry} nudges`);j.error(o.message),t.trigger(D.ERROR,{type:_e.MEDIA_ERROR,details:te.BUFFER_STALLED_ERROR,error:o,fatal:!0})}}}const R9=100;class D9 extends Hc{constructor(e,t,i){super(e,t,i,"[stream-controller]",we.MAIN),this.audioCodecSwap=!1,this.gapController=null,this.level=-1,this._forceStartLoad=!1,this.altAudio=!1,this.audioOnly=!1,this.fragPlaying=null,this.onvplaying=null,this.onvseeked=null,this.fragLastKbps=0,this.couldBacktrack=!1,this.backtrackFragment=null,this.audioCodecSwitch=!1,this.videoBuffer=null,this._registerListeners()}_registerListeners(){const{hls:e}=this;e.on(D.MEDIA_ATTACHED,this.onMediaAttached,this),e.on(D.MEDIA_DETACHING,this.onMediaDetaching,this),e.on(D.MANIFEST_LOADING,this.onManifestLoading,this),e.on(D.MANIFEST_PARSED,this.onManifestParsed,this),e.on(D.LEVEL_LOADING,this.onLevelLoading,this),e.on(D.LEVEL_LOADED,this.onLevelLoaded,this),e.on(D.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.on(D.ERROR,this.onError,this),e.on(D.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.on(D.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.on(D.BUFFER_CREATED,this.onBufferCreated,this),e.on(D.BUFFER_FLUSHED,this.onBufferFlushed,this),e.on(D.LEVELS_UPDATED,this.onLevelsUpdated,this),e.on(D.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){const{hls:e}=this;e.off(D.MEDIA_ATTACHED,this.onMediaAttached,this),e.off(D.MEDIA_DETACHING,this.onMediaDetaching,this),e.off(D.MANIFEST_LOADING,this.onManifestLoading,this),e.off(D.MANIFEST_PARSED,this.onManifestParsed,this),e.off(D.LEVEL_LOADED,this.onLevelLoaded,this),e.off(D.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),e.off(D.ERROR,this.onError,this),e.off(D.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),e.off(D.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),e.off(D.BUFFER_CREATED,this.onBufferCreated,this),e.off(D.BUFFER_FLUSHED,this.onBufferFlushed,this),e.off(D.LEVELS_UPDATED,this.onLevelsUpdated,this),e.off(D.FRAG_BUFFERED,this.onFragBuffered,this)}onHandlerDestroying(){this._unregisterListeners(),super.onHandlerDestroying()}startLoad(e){if(this.levels){const{lastCurrentTime:t,hls:i}=this;if(this.stopLoad(),this.setInterval(R9),this.level=-1,!this.startFragRequested){let s=i.startLevel;s===-1&&(i.config.testBandwidth&&this.levels.length>1?(s=0,this.bitrateTest=!0):s=i.firstAutoLevel),i.nextLoadLevel=s,this.level=i.loadLevel,this.loadedmetadata=!1}t>0&&e===-1&&(this.log(`Override startPosition with lastCurrentTime @${t.toFixed(3)}`),e=t),this.state=le.IDLE,this.nextLoadPosition=this.startPosition=this.lastCurrentTime=e,this.tick()}else this._forceStartLoad=!0,this.state=le.STOPPED}stopLoad(){this._forceStartLoad=!1,super.stopLoad()}doTick(){switch(this.state){case le.WAITING_LEVEL:{const{levels:t,level:i}=this,s=t==null?void 0:t[i],r=s==null?void 0:s.details;if(r&&(!r.live||this.levelLastLoaded===s)){if(this.waitForCdnTuneIn(r))break;this.state=le.IDLE;break}else if(this.hls.nextLoadLevel!==this.level){this.state=le.IDLE;break}break}case le.FRAG_LOADING_WAITING_RETRY:{var e;const t=self.performance.now(),i=this.retryDate;if(!i||t>=i||(e=this.media)!=null&&e.seeking){const{levels:s,level:r}=this,o=s==null?void 0:s[r];this.resetStartWhenNotLoaded(o||null),this.state=le.IDLE}}break}this.state===le.IDLE&&this.doTickIdle(),this.onTickEnd()}onTickEnd(){super.onTickEnd(),this.checkBuffer(),this.checkFragmentChanged()}doTickIdle(){const{hls:e,levelLastLoaded:t,levels:i,media:s}=this;if(t===null||!s&&(this.startFragRequested||!e.config.startFragPrefetch)||this.altAudio&&this.audioOnly)return;const r=e.nextLoadLevel;if(!(i!=null&&i[r]))return;const o=i[r],a=this.getMainFwdBufferInfo();if(a===null)return;const c=this.getLevelDetails();if(c&&this._streamEnded(a,c)){const m={};this.altAudio&&(m.type="video"),this.hls.trigger(D.BUFFER_EOS,m),this.state=le.ENDED;return}e.loadLevel!==r&&e.manualLevel===-1&&this.log(`Adapting to level ${r} from level ${this.level}`),this.level=e.nextLoadLevel=r;const l=o.details;if(!l||this.state===le.WAITING_LEVEL||l.live&&this.levelLastLoaded!==o){this.level=r,this.state=le.WAITING_LEVEL;return}const u=a.len,h=this.getMaxBufferLength(o.maxBitrate);if(u>=h)return;this.backtrackFragment&&this.backtrackFragment.start>a.end&&(this.backtrackFragment=null);const f=this.backtrackFragment?this.backtrackFragment.start:a.end;let d=this.getNextFragment(f,l);if(this.couldBacktrack&&!this.fragPrevious&&d&&d.sn!=="initSegment"&&this.fragmentTracker.getState(d)!==bt.OK){var p;const g=((p=this.backtrackFragment)!=null?p:d).sn-l.startSN,y=l.fragments[g-1];y&&d.cc===y.cc&&(d=y,this.fragmentTracker.removeFragment(y))}else this.backtrackFragment&&a.len&&(this.backtrackFragment=null);if(d&&this.isLoopLoading(d,f)){if(!d.gap){const g=this.audioOnly&&!this.altAudio?$e.AUDIO:$e.VIDEO,y=(g===$e.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;y&&this.afterBufferFlushed(y,g,we.MAIN)}d=this.getNextFragmentLoopLoading(d,l,a,we.MAIN,h)}d&&(d.initSegment&&!d.initSegment.data&&!this.bitrateTest&&(d=d.initSegment),this.loadFragment(d,o,f))}loadFragment(e,t,i){const s=this.fragmentTracker.getState(e);this.fragCurrent=e,s===bt.NOT_LOADED||s===bt.PARTIAL?e.sn==="initSegment"?this._loadInitSegment(e,t):this.bitrateTest?(this.log(`Fragment ${e.sn} of level ${e.level} is being downloaded to test bitrate and will not be buffered`),this._loadBitrateTestFrag(e,t)):(this.startFragRequested=!0,super.loadFragment(e,t,i)):this.clearTrackerIfNeeded(e)}getBufferedFrag(e){return this.fragmentTracker.getBufferedFrag(e,we.MAIN)}followingBufferedFrag(e){return e?this.getBufferedFrag(e.end+.5):null}immediateLevelSwitch(){this.abortCurrentFrag(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY)}nextLevelSwitch(){const{levels:e,media:t}=this;if(t!=null&&t.readyState){let i;const s=this.getAppendedFrag(t.currentTime);s&&s.start>1&&this.flushMainBuffer(0,s.start-1);const r=this.getLevelDetails();if(r!=null&&r.live){const a=this.getMainFwdBufferInfo();if(!a||a.len<r.targetduration*2)return}if(!t.paused&&e){const a=this.hls.nextLoadLevel,c=e[a],l=this.fragLastKbps;l&&this.fragCurrent?i=this.fragCurrent.duration*c.maxBitrate/(1e3*l)+1:i=0}else i=0;const o=this.getBufferedFrag(t.currentTime+i);if(o){const a=this.followingBufferedFrag(o);if(a){this.abortCurrentFrag();const c=a.maxStartPTS?a.maxStartPTS:a.start,l=a.duration,u=Math.max(o.end,c+Math.min(Math.max(l-this.config.maxFragLookUpTolerance,l*(this.couldBacktrack?.5:.125)),l*(this.couldBacktrack?.75:.25)));this.flushMainBuffer(u,Number.POSITIVE_INFINITY)}}}}abortCurrentFrag(){const e=this.fragCurrent;switch(this.fragCurrent=null,this.backtrackFragment=null,e&&(e.abortRequests(),this.fragmentTracker.removeFragment(e)),this.state){case le.KEY_LOADING:case le.FRAG_LOADING:case le.FRAG_LOADING_WAITING_RETRY:case le.PARSING:case le.PARSED:this.state=le.IDLE;break}this.nextLoadPosition=this.getLoadPosition()}flushMainBuffer(e,t){super.flushMainBuffer(e,t,this.altAudio?"video":null)}onMediaAttached(e,t){super.onMediaAttached(e,t);const i=t.media;this.onvplaying=this.onMediaPlaying.bind(this),this.onvseeked=this.onMediaSeeked.bind(this),i.addEventListener("playing",this.onvplaying),i.addEventListener("seeked",this.onvseeked),this.gapController=new b9(this.config,i,this.fragmentTracker,this.hls)}onMediaDetaching(){const{media:e}=this;e&&this.onvplaying&&this.onvseeked&&(e.removeEventListener("playing",this.onvplaying),e.removeEventListener("seeked",this.onvseeked),this.onvplaying=this.onvseeked=null,this.videoBuffer=null),this.fragPlaying=null,this.gapController&&(this.gapController.destroy(),this.gapController=null),super.onMediaDetaching()}onMediaPlaying(){this.tick()}onMediaSeeked(){const e=this.media,t=e?e.currentTime:null;ve(t)&&this.log(`Media seeked to ${t.toFixed(3)}`);const i=this.getMainFwdBufferInfo();if(i===null||i.len===0){this.warn(`Main forward buffer length on "seeked" event ${i?i.len:"empty"})`);return}this.tick()}onManifestLoading(){this.log("Trigger BUFFER_RESET"),this.hls.trigger(D.BUFFER_RESET,void 0),this.fragmentTracker.removeAllFragments(),this.couldBacktrack=!1,this.startPosition=this.lastCurrentTime=this.fragLastKbps=0,this.levels=this.fragPlaying=this.backtrackFragment=this.levelLastLoaded=null,this.altAudio=this.audioOnly=this.startFragRequested=!1}onManifestParsed(e,t){let i=!1,s=!1;t.levels.forEach(r=>{const o=r.audioCodec;o&&(i=i||o.indexOf("mp4a.40.2")!==-1,s=s||o.indexOf("mp4a.40.5")!==-1)}),this.audioCodecSwitch=i&&s&&!w9(),this.audioCodecSwitch&&this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=t.levels,this.startFragRequested=!1}onLevelLoading(e,t){const{levels:i}=this;if(!i||this.state!==le.IDLE)return;const s=i[t.level];(!s.details||s.details.live&&this.levelLastLoaded!==s||this.waitForCdnTuneIn(s.details))&&(this.state=le.WAITING_LEVEL)}onLevelLoaded(e,t){var i;const{levels:s}=this,r=t.level,o=t.details,a=o.totalduration;if(!s){this.warn(`Levels were reset while loading level ${r}`);return}this.log(`Level ${r} loaded [${o.startSN},${o.endSN}]${o.lastPartSn?`[part-${o.lastPartSn}-${o.lastPartIndex}]`:""}, cc [${o.startCC}, ${o.endCC}] duration:${a}`);const c=s[r],l=this.fragCurrent;l&&(this.state===le.FRAG_LOADING||this.state===le.FRAG_LOADING_WAITING_RETRY)&&l.level!==t.level&&l.loader&&this.abortCurrentFrag();let u=0;if(o.live||(i=c.details)!=null&&i.live){var h;if(this.checkLiveUpdate(o),o.deltaUpdateFailed)return;u=this.alignPlaylists(o,c.details,(h=this.levelLastLoaded)==null?void 0:h.details)}if(c.details=o,this.levelLastLoaded=c,this.hls.trigger(D.LEVEL_UPDATED,{details:o,level:r}),this.state===le.WAITING_LEVEL){if(this.waitForCdnTuneIn(o))return;this.state=le.IDLE}this.startFragRequested?o.live&&this.synchronizeToLiveEdge(o):this.setStartPosition(o,u),this.tick()}_handleFragmentLoadProgress(e){var t;const{frag:i,part:s,payload:r}=e,{levels:o}=this;if(!o){this.warn(`Levels were reset while fragment load was in progress. Fragment ${i.sn} of level ${i.level} will not be buffered`);return}const a=o[i.level],c=a.details;if(!c){this.warn(`Dropping fragment ${i.sn} of level ${i.level} after level details were reset`),this.fragmentTracker.removeFragment(i);return}const l=a.videoCodec,u=c.PTSKnown||!c.live,h=(t=i.initSegment)==null?void 0:t.data,f=this._getAudioCodec(a),d=this.transmuxer=this.transmuxer||new Tg(this.hls,we.MAIN,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),p=s?s.index:-1,m=p!==-1,g=new zc(i.level,i.sn,i.stats.chunkCount,r.byteLength,p,m),y=this.initPTS[i.cc];d.push(r,h,f,l,i,s,c.totalduration,u,g,y)}onAudioTrackSwitching(e,t){const i=this.altAudio;if(!!!t.url){if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;const o=this.fragCurrent;o&&(this.log("Switching to main audio track, cancel main fragment load"),o.abortRequests(),this.fragmentTracker.removeFragment(o)),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();const r=this.hls;i&&(r.trigger(D.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:null}),this.fragmentTracker.removeAllFragments()),r.trigger(D.AUDIO_TRACK_SWITCHED,t)}}onAudioTrackSwitched(e,t){const i=t.id,s=!!this.hls.audioTracks[i].url;if(s){const r=this.videoBuffer;r&&this.mediaBuffer!==r&&(this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=r)}this.altAudio=s,this.tick()}onBufferCreated(e,t){const i=t.tracks;let s,r,o=!1;for(const a in i){const c=i[a];if(c.id==="main"){if(r=a,s=c,a==="video"){const l=i[a];l&&(this.videoBuffer=l.buffer)}}else o=!0}o&&s?(this.log(`Alternate track found, use ${r}.buffered to schedule main fragment loading`),this.mediaBuffer=s.buffer):this.mediaBuffer=this.media}onFragBuffered(e,t){const{frag:i,part:s}=t;if(i&&i.type!==we.MAIN)return;if(this.fragContextChanged(i)){this.warn(`Fragment ${i.sn}${s?" p: "+s.index:""} of level ${i.level} finished buffering, but was aborted. state: ${this.state}`),this.state===le.PARSED&&(this.state=le.IDLE);return}const r=s?s.stats:i.stats;this.fragLastKbps=Math.round(8*r.total/(r.buffering.end-r.loading.first)),i.sn!=="initSegment"&&(this.fragPrevious=i),this.fragBufferedComplete(i,s)}onError(e,t){var i;if(t.fatal){this.state=le.ERROR;return}switch(t.details){case te.FRAG_GAP:case te.FRAG_PARSING_ERROR:case te.FRAG_DECRYPT_ERROR:case te.FRAG_LOAD_ERROR:case te.FRAG_LOAD_TIMEOUT:case te.KEY_LOAD_ERROR:case te.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(we.MAIN,t);break;case te.LEVEL_LOAD_ERROR:case te.LEVEL_LOAD_TIMEOUT:case te.LEVEL_PARSING_ERROR:!t.levelRetry&&this.state===le.WAITING_LEVEL&&((i=t.context)==null?void 0:i.type)===Ge.LEVEL&&(this.state=le.IDLE);break;case te.BUFFER_APPEND_ERROR:case te.BUFFER_FULL_ERROR:if(!t.parent||t.parent!=="main")return;if(t.details===te.BUFFER_APPEND_ERROR){this.resetLoadingState();return}this.reduceLengthAndFlushBuffer(t)&&this.flushMainBuffer(0,Number.POSITIVE_INFINITY);break;case te.INTERNAL_EXCEPTION:this.recoverWorkerError(t);break}}checkBuffer(){const{media:e,gapController:t}=this;if(!(!e||!t||!e.readyState)){if(this.loadedmetadata||!Ze.getBuffered(e).length){const i=this.state!==le.IDLE?this.fragCurrent:null;t.poll(this.lastCurrentTime,i)}this.lastCurrentTime=e.currentTime}}onFragLoadEmergencyAborted(){this.state=le.IDLE,this.loadedmetadata||(this.startFragRequested=!1,this.nextLoadPosition=this.startPosition),this.tickImmediate()}onBufferFlushed(e,{type:t}){if(t!==$e.AUDIO||this.audioOnly&&!this.altAudio){const i=(t===$e.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;this.afterBufferFlushed(i,t,we.MAIN),this.tick()}}onLevelsUpdated(e,t){this.level>-1&&this.fragCurrent&&(this.level=this.fragCurrent.level),this.levels=t.levels}swapAudioCodec(){this.audioCodecSwap=!this.audioCodecSwap}seekToStartPos(){const{media:e}=this;if(!e)return;const t=e.currentTime;let i=this.startPosition;if(i>=0&&t<i){if(e.seeking){this.log(`could not seek to ${i}, already seeking at ${t}`);return}const s=Ze.getBuffered(e),o=(s.length?s.start(0):0)-i;o>0&&(o<this.config.maxBufferHole||o<this.config.maxFragLookUpTolerance)&&(this.log(`adjusting start position by ${o} to match buffer start`),i+=o,this.startPosition=i),this.log(`seek to target start position ${i} from current time ${t}`),e.currentTime=i}}_getAudioCodec(e){let t=this.config.defaultAudioCodec||e.audioCodec;return this.audioCodecSwap&&t&&(this.log("Swapping audio codec"),t.indexOf("mp4a.40.5")!==-1?t="mp4a.40.2":t="mp4a.40.5"),t}_loadBitrateTestFrag(e,t){e.bitrateTest=!0,this._doFragLoad(e,t).then(i=>{const{hls:s}=this;if(!i||this.fragContextChanged(e))return;t.fragmentError=0,this.state=le.IDLE,this.startFragRequested=!1,this.bitrateTest=!1;const r=e.stats;r.parsing.start=r.parsing.end=r.buffering.start=r.buffering.end=self.performance.now(),s.trigger(D.FRAG_LOADED,i),e.bitrateTest=!1})}_handleTransmuxComplete(e){var t;const i="main",{hls:s}=this,{remuxResult:r,chunkMeta:o}=e,a=this.getCurrentContext(o);if(!a){this.resetWhenMissingContext(o);return}const{frag:c,part:l,level:u}=a,{video:h,text:f,id3:d,initSegment:p}=r,{details:m}=u,g=this.altAudio?void 0:r.audio;if(this.fragContextChanged(c)){this.fragmentTracker.removeFragment(c);return}if(this.state=le.PARSING,p){if(p!=null&&p.tracks){const E=c.initSegment||c;this._bufferInitSegment(u,p.tracks,E,o),s.trigger(D.FRAG_PARSING_INIT_SEGMENT,{frag:E,id:i,tracks:p.tracks})}const y=p.initPTS,v=p.timescale;ve(y)&&(this.initPTS[c.cc]={baseTime:y,timescale:v},s.trigger(D.INIT_PTS_FOUND,{frag:c,id:i,initPTS:y,timescale:v}))}if(h&&m&&c.sn!=="initSegment"){const y=m.fragments[c.sn-1-m.startSN],v=c.sn===m.startSN,E=!y||c.cc>y.cc;if(r.independent!==!1){const{startPTS:C,endPTS:x,startDTS:I,endDTS:S}=h;if(l)l.elementaryStreams[h.type]={startPTS:C,endPTS:x,startDTS:I,endDTS:S};else if(h.firstKeyFrame&&h.independent&&o.id===1&&!E&&(this.couldBacktrack=!0),h.dropped&&h.independent){const w=this.getMainFwdBufferInfo(),B=(w?w.end:this.getLoadPosition())+this.config.maxBufferHole,T=h.firstKeyFramePTS?h.firstKeyFramePTS:C;if(!v&&B<T-this.config.maxBufferHole&&!E){this.backtrack(c);return}else E&&(c.gap=!0);c.setElementaryStreamInfo(h.type,c.start,x,c.start,S,!0)}else v&&C>nc&&(c.gap=!0);c.setElementaryStreamInfo(h.type,C,x,I,S),this.backtrackFragment&&(this.backtrackFragment=c),this.bufferFragmentData(h,c,l,o,v||E)}else if(v||E)c.gap=!0;else{this.backtrack(c);return}}if(g){const{startPTS:y,endPTS:v,startDTS:E,endDTS:C}=g;l&&(l.elementaryStreams[$e.AUDIO]={startPTS:y,endPTS:v,startDTS:E,endDTS:C}),c.setElementaryStreamInfo($e.AUDIO,y,v,E,C),this.bufferFragmentData(g,c,l,o)}if(m&&d!=null&&(t=d.samples)!=null&&t.length){const y={id:i,frag:c,details:m,samples:d.samples};s.trigger(D.FRAG_PARSING_METADATA,y)}if(m&&f){const y={id:i,frag:c,details:m,samples:f.samples};s.trigger(D.FRAG_PARSING_USERDATA,y)}}_bufferInitSegment(e,t,i,s){if(this.state!==le.PARSING)return;this.audioOnly=!!t.audio&&!t.video,this.altAudio&&!this.audioOnly&&delete t.audio;const{audio:r,video:o,audiovideo:a}=t;if(r){let c=e.audioCodec;const l=navigator.userAgent.toLowerCase();if(this.audioCodecSwitch){c&&(c.indexOf("mp4a.40.5")!==-1?c="mp4a.40.2":c="mp4a.40.5");const u=r.metadata;u&&"channelCount"in u&&(u.channelCount||1)!==1&&l.indexOf("firefox")===-1&&(c="mp4a.40.5")}c&&c.indexOf("mp4a.40.5")!==-1&&l.indexOf("android")!==-1&&r.container!=="audio/mpeg"&&(c="mp4a.40.2",this.log(`Android: force audio codec to ${c}`)),e.audioCodec&&e.audioCodec!==c&&this.log(`Swapping manifest audio codec "${e.audioCodec}" for "${c}"`),r.levelCodec=c,r.id="main",this.log(`Init audio buffer, container:${r.container}, codecs[selected/level/parsed]=[${c||""}/${e.audioCodec||""}/${r.codec}]`)}o&&(o.levelCodec=e.videoCodec,o.id="main",this.log(`Init video buffer, container:${o.container}, codecs[level/parsed]=[${e.videoCodec||""}/${o.codec}]`)),a&&this.log(`Init audiovideo buffer, container:${a.container}, codecs[level/parsed]=[${e.codecs}/${a.codec}]`),this.hls.trigger(D.BUFFER_CODECS,t),Object.keys(t).forEach(c=>{const u=t[c].initSegment;u!=null&&u.byteLength&&this.hls.trigger(D.BUFFER_APPENDING,{type:c,data:u,frag:i,part:null,chunkMeta:s,parent:i.type})}),this.tickImmediate()}getMainFwdBufferInfo(){return this.getFwdBufferInfo(this.mediaBuffer?this.mediaBuffer:this.media,we.MAIN)}backtrack(e){this.couldBacktrack=!0,this.backtrackFragment=e,this.resetTransmuxer(),this.flushBufferGap(e),this.fragmentTracker.removeFragment(e),this.fragPrevious=null,this.nextLoadPosition=e.start,this.state=le.IDLE}checkFragmentChanged(){const e=this.media;let t=null;if(e&&e.readyState>1&&e.seeking===!1){const i=e.currentTime;if(Ze.isBuffered(e,i)?t=this.getAppendedFrag(i):Ze.isBuffered(e,i+.1)&&(t=this.getAppendedFrag(i+.1)),t){this.backtrackFragment=null;const s=this.fragPlaying,r=t.level;(!s||t.sn!==s.sn||s.level!==r)&&(this.fragPlaying=t,this.hls.trigger(D.FRAG_CHANGED,{frag:t}),(!s||s.level!==r)&&this.hls.trigger(D.LEVEL_SWITCHED,{level:r}))}}}get nextLevel(){const e=this.nextBufferedFrag;return e?e.level:-1}get currentFrag(){const e=this.media;return e?this.fragPlaying||this.getAppendedFrag(e.currentTime):null}get currentProgramDateTime(){const e=this.media;if(e){const t=e.currentTime,i=this.currentFrag;if(i&&ve(t)&&ve(i.programDateTime)){const s=i.programDateTime+(t-i.start)*1e3;return new Date(s)}}return null}get currentLevel(){const e=this.currentFrag;return e?e.level:-1}get nextBufferedFrag(){const e=this.currentFrag;return e?this.followingBufferedFrag(e):null}get forceStartLoad(){return this._forceStartLoad}}class Us{static get version(){return"1.5.17"}static isMSESupported(){return vf()}static isSupported(){return t2()}static getMediaSource(){return zs()}static get Events(){return D}static get ErrorTypes(){return _e}static get ErrorDetails(){return te}static get DefaultConfig(){return Us.defaultConfig?Us.defaultConfig:Zg}static set DefaultConfig(e){Us.defaultConfig=e}constructor(e={}){this.config=void 0,this.userConfig=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this.started=!1,this._emitter=new pf,this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.emeController=void 0,this.cmcdController=void 0,this._media=null,this.url=null,this.triggeringException=void 0,LI(e.debug||!1,"Hls instance");const t=this.config=x9(Us.DefaultConfig,e);this.userConfig=e,t.progressive&&C9(t);const{abrController:i,bufferController:s,capLevelController:r,errorController:o,fpsController:a}=t,c=new o(this),l=this.abrController=new i(this),u=this.bufferController=new s(this),h=this.capLevelController=new r(this),f=new a(this),d=new w5(this),p=new R5(this),m=t.contentSteeringController,g=m?new m(this):null,y=this.levelController=new I9(this,g),v=new s6(this),E=new S9(this.config),C=this.streamController=new D9(this,v,E);h.setStreamController(C),f.setStreamController(C);const x=[d,y,C];g&&x.splice(1,0,g),this.networkControllers=x;const I=[l,u,h,f,p,v];this.audioTrackController=this.createController(t.audioTrackController,x);const S=t.audioStreamController;S&&x.push(new S(this,v,E)),this.subtitleTrackController=this.createController(t.subtitleTrackController,x);const w=t.subtitleStreamController;w&&x.push(new w(this,v,E)),this.createController(t.timelineController,I),E.emeController=this.emeController=this.createController(t.emeController,I),this.cmcdController=this.createController(t.cmcdController,I),this.latencyController=this.createController(D5,I),this.coreComponents=I,x.push(c);const B=c.onErrorOut;typeof B=="function"&&this.on(D.ERROR,B,c)}createController(e,t){if(e){const i=new e(this);return t&&t.push(i),i}return null}on(e,t,i=this){this._emitter.on(e,t,i)}once(e,t,i=this){this._emitter.once(e,t,i)}removeAllListeners(e){this._emitter.removeAllListeners(e)}off(e,t,i=this,s){this._emitter.off(e,t,i,s)}listeners(e){return this._emitter.listeners(e)}emit(e,t,i){return this._emitter.emit(e,t,i)}trigger(e,t){if(this.config.debug)return this.emit(e,e,t);try{return this.emit(e,e,t)}catch(i){if(j.error("An internal error happened while handling event "+e+'. Error message: "'+i.message+'". Here is a stacktrace:',i),!this.triggeringException){this.triggeringException=!0;const s=e===D.ERROR;this.trigger(D.ERROR,{type:_e.OTHER_ERROR,details:te.INTERNAL_EXCEPTION,fatal:s,event:e,error:i}),this.triggeringException=!1}}return!1}listenerCount(e){return this._emitter.listenerCount(e)}destroy(){j.log("destroy"),this.trigger(D.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this.url=null,this.networkControllers.forEach(t=>t.destroy()),this.networkControllers.length=0,this.coreComponents.forEach(t=>t.destroy()),this.coreComponents.length=0;const e=this.config;e.xhrSetup=e.fetchSetup=void 0,this.userConfig=null}attachMedia(e){j.log("attachMedia"),this._media=e,this.trigger(D.MEDIA_ATTACHING,{media:e})}detachMedia(){j.log("detachMedia"),this.trigger(D.MEDIA_DETACHING,void 0),this._media=null}loadSource(e){this.stopLoad();const t=this.media,i=this.url,s=this.url=nf.buildAbsoluteURL(self.location.href,e,{alwaysNormalize:!0});this._autoLevelCapping=-1,this._maxHdcpLevel=null,j.log(`loadSource:${s}`),t&&i&&(i!==s||this.bufferController.hasSourceTypes())&&(this.detachMedia(),this.attachMedia(t)),this.trigger(D.MANIFEST_LOADING,{url:e})}startLoad(e=-1){j.log(`startLoad(${e})`),this.started=!0,this.networkControllers.forEach(t=>{t.startLoad(e)})}stopLoad(){j.log("stopLoad"),this.started=!1,this.networkControllers.forEach(e=>{e.stopLoad()})}resumeBuffering(){this.started&&this.networkControllers.forEach(e=>{"fragmentLoader"in e&&e.startLoad(-1)})}pauseBuffering(){this.networkControllers.forEach(e=>{"fragmentLoader"in e&&e.stopLoad()})}swapAudioCodec(){j.log("swapAudioCodec"),this.streamController.swapAudioCodec()}recoverMediaError(){j.log("recoverMediaError");const e=this._media;this.detachMedia(),e&&this.attachMedia(e)}removeLevel(e){this.levelController.removeLevel(e)}get levels(){const e=this.levelController.levels;return e||[]}get currentLevel(){return this.streamController.currentLevel}set currentLevel(e){j.log(`set currentLevel:${e}`),this.levelController.manualLevel=e,this.streamController.immediateLevelSwitch()}get nextLevel(){return this.streamController.nextLevel}set nextLevel(e){j.log(`set nextLevel:${e}`),this.levelController.manualLevel=e,this.streamController.nextLevelSwitch()}get loadLevel(){return this.levelController.level}set loadLevel(e){j.log(`set loadLevel:${e}`),this.levelController.manualLevel=e}get nextLoadLevel(){return this.levelController.nextLoadLevel}set nextLoadLevel(e){this.levelController.nextLoadLevel=e}get firstLevel(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)}set firstLevel(e){j.log(`set firstLevel:${e}`),this.levelController.firstLevel=e}get startLevel(){const e=this.levelController.startLevel;return e===-1&&this.abrController.forcedAutoLevel>-1?this.abrController.forcedAutoLevel:e}set startLevel(e){j.log(`set startLevel:${e}`),e!==-1&&(e=Math.max(e,this.minAutoLevel)),this.levelController.startLevel=e}get capLevelToPlayerSize(){return this.config.capLevelToPlayerSize}set capLevelToPlayerSize(e){const t=!!e;t!==this.config.capLevelToPlayerSize&&(t?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=t)}get autoLevelCapping(){return this._autoLevelCapping}get bandwidthEstimate(){const{bwEstimator:e}=this.abrController;return e?e.getEstimate():NaN}set bandwidthEstimate(e){this.abrController.resetEstimator(e)}get ttfbEstimate(){const{bwEstimator:e}=this.abrController;return e?e.getEstimateTTFB():NaN}set autoLevelCapping(e){this._autoLevelCapping!==e&&(j.log(`set autoLevelCapping:${e}`),this._autoLevelCapping=e,this.levelController.checkMaxAutoUpdated())}get maxHdcpLevel(){return this._maxHdcpLevel}set maxHdcpLevel(e){M5(e)&&this._maxHdcpLevel!==e&&(this._maxHdcpLevel=e,this.levelController.checkMaxAutoUpdated())}get autoLevelEnabled(){return this.levelController.manualLevel===-1}get manualLevel(){return this.levelController.manualLevel}get minAutoLevel(){const{levels:e,config:{minAutoBitrate:t}}=this;if(!e)return 0;const i=e.length;for(let s=0;s<i;s++)if(e[s].maxBitrate>=t)return s;return 0}get maxAutoLevel(){const{levels:e,autoLevelCapping:t,maxHdcpLevel:i}=this;let s;if(t===-1&&e!=null&&e.length?s=e.length-1:s=t,i)for(let r=s;r--;){const o=e[r].attrs["HDCP-LEVEL"];if(o&&o<=i)return r}return s}get firstAutoLevel(){return this.abrController.firstAutoLevel}get nextAutoLevel(){return this.abrController.nextAutoLevel}set nextAutoLevel(e){this.abrController.nextAutoLevel=e}get playingDate(){return this.streamController.currentProgramDateTime}get mainForwardBufferInfo(){return this.streamController.getMainFwdBufferInfo()}setAudioOption(e){var t;return(t=this.audioTrackController)==null?void 0:t.setAudioOption(e)}setSubtitleOption(e){var t;return(t=this.subtitleTrackController)==null||t.setSubtitleOption(e),null}get allAudioTracks(){const e=this.audioTrackController;return e?e.allAudioTracks:[]}get audioTracks(){const e=this.audioTrackController;return e?e.audioTracks:[]}get audioTrack(){const e=this.audioTrackController;return e?e.audioTrack:-1}set audioTrack(e){const t=this.audioTrackController;t&&(t.audioTrack=e)}get allSubtitleTracks(){const e=this.subtitleTrackController;return e?e.allSubtitleTracks:[]}get subtitleTracks(){const e=this.subtitleTrackController;return e?e.subtitleTracks:[]}get subtitleTrack(){const e=this.subtitleTrackController;return e?e.subtitleTrack:-1}get media(){return this._media}set subtitleTrack(e){const t=this.subtitleTrackController;t&&(t.subtitleTrack=e)}get subtitleDisplay(){const e=this.subtitleTrackController;return e?e.subtitleDisplay:!1}set subtitleDisplay(e){const t=this.subtitleTrackController;t&&(t.subtitleDisplay=e)}get lowLatencyMode(){return this.config.lowLatencyMode}set lowLatencyMode(e){this.config.lowLatencyMode=e}get liveSyncPosition(){return this.latencyController.liveSyncPosition}get latency(){return this.latencyController.latency}get maxLatency(){return this.latencyController.maxLatency}get targetLatency(){return this.latencyController.targetLatency}get drift(){return this.latencyController.drift}get forceStartLoad(){return this.streamController.forceStartLoad}}Us.defaultConfig=void 0;const M9=Object.freeze(Object.defineProperty({__proto__:null,AbrController:cg,AttrList:rt,AudioStreamController:_g,AudioTrackController:bg,BasePlaylistController:Gc,BaseSegment:of,BaseStreamController:Hc,BufferController:Mg,CMCDController:jg,CapLevelController:Kc,ChunkMetadata:zc,ContentSteeringController:Jg,DateRange:rf,EMEController:cn,ErrorActionFlags:Ei,ErrorController:og,ErrorDetails:te,ErrorTypes:_e,Events:D,FPSController:Hg,Fragment:qa,Hls:Us,HlsSkip:To,HlsUrlParameters:hh,KeySystemFormats:$t,KeySystems:je,Level:un,LevelDetails:Qp,LevelKey:gr,LoadStats:Qo,MetadataSchema:Si,NetworkErrorAction:Ct,Part:Up,PlaylistLevelType:we,SubtitleStreamController:Rg,SubtitleTrackController:Dg,TimelineController:Gg,default:Us,getMediaSource:zs,isMSESupported:vf,isSupported:t2},Symbol.toStringTag,{value:"Module"}));var wA,TA;const L9=typeof window<"u"&&typeof((wA=window.document)==null?void 0:wA.createElement)=="function"&&typeof((TA=window.navigator)==null?void 0:TA.userAgent)=="string";let au=null;async function P9(...n){var e;(e=au)!==null&&e!==void 0||(au=await A1(()=>Promise.resolve().then(()=>M9),void 0));const t=au.default;return t.isSupported()?new t(...n):null}function i2(n,{unsuspend:e="loadedmetadata",start:t=!0,hls:i={},crossOrigin:s="anonymous",muted:r=!0,loop:o=!0,playsInline:a=!0,...c}={}){const l=Z(f=>f.gl),u=A.useRef(null),h=dn(()=>new Promise(async f=>{let d,p;typeof n=="string"?d=n:p=n;const m=Object.assign(document.createElement("video"),{src:d,srcObject:p,crossOrigin:s,loop:o,muted:r,playsInline:a,...c});if(d&&L9&&d.endsWith(".m3u8")){const y=u.current=await P9(i);y&&(y.on(D.MEDIA_ATTACHED,()=>void y.loadSource(d)),y.attachMedia(m))}const g=new zy(m);"colorSpace"in g?g.colorSpace=l.outputColorSpace:g.encoding=l.outputEncoding,m.addEventListener(e,()=>f(g))}),[n]);return A.useEffect(()=>(t&&h.image.play(),()=>{u.current&&(u.current.destroy(),u.current=null)}),[h,t]),h}const e7=({children:n,src:e,...t})=>{const i=i2(e,t);return A.useEffect(()=>()=>void i.dispose(),[i]),A.createElement(A.Fragment,null,n==null?void 0:n(i))},rc=(n,e)=>{if(Array.isArray(n))return n[0];{const t=e??Object.keys(n)[0];return n[t][0]}},F9=n=>{for(let e=3;e<n.length;e+=4)if(n[e]!==0)return!1;return!0};function xf(n,e,t,i,s,r){const o=A.useRef(Z(_=>_.viewport)),a=A.useRef(null),c=A.useRef(0),l=.1,u=A.useRef(n),h=A.useRef(e),f=A.useRef(t),[d,p]=A.useState(null),[m,g]=A.useState(new as),y=A.useMemo(()=>new Bs,[]),[v,E]=A.useState(null),C=A.useCallback((_,L,O)=>{const U=L*(o.current.aspect>_/L?o.current.width/_:o.current.height/L),G=_*(o.current.aspect>_/L?o.current.width/_:o.current.height/L)*O,z=U*O,H=1;let N=Math.min(H,G),V=Math.min(H,z);return G>H&&(N=H,V=z/G*H),new b(N,V,1)},[]),x=A.useCallback((_,L)=>{if(_.image){const O=document.createElement("canvas"),U=O.getContext("2d",r);if(!U)throw new Error("Failed to get 2d context");O.width=_.image.width,O.height=_.image.height,U.drawImage(_.image,0,0);const Q=_.image.width,G=_.image.height,z=Math.round(Math.sqrt(L*(Q/G))),H=Math.round(L/z),N=Q/z,V=G/H,$=[];for(let Y=0;Y<H;Y++)for(let M=0;M<z;M++){if(Y*z+M>=L){$.push({row:Y,col:M});continue}const P=U.getImageData(M*N,Y*V,N,V).data;F9(P)&&$.push({row:Y,col:M})}return{rows:H,columns:z,frameWidth:N,frameHeight:V,emptyFrames:$}}else return{rows:0,columns:0,frameWidth:0,frameHeight:0,emptyFrames:[]}},[r]),I=A.useCallback(_=>{const L=O=>{let U=null;for(const G of O){const{w:z,h:H}=G.frame,N=z*H;(!U||N>U.area)&&(U={w:z,h:H,area:N})}return O.map(G=>{const{w:z,h:H}=G.frame,N=z*H,V=U?N===U.area?1:Math.sqrt(N/U.area):1;return{...G,scaleRatio:V}})};if(Array.isArray(_))return L(_);{const O={};for(const U in _)O[U]=L(_[U]);return O}},[]),S=A.useCallback(()=>{const _={},L=a.current,O=f.current;if(L)if(O&&Array.isArray(L.frames)){for(let U=0;U<O.length;U++){_[O[U]]=[];for(const Q of L.frames){const G=Q.frame,z=Q.sourceSize.w,H=Q.sourceSize.h;typeof Q.filename=="string"&&Q.filename.toLowerCase().indexOf(O[U].toLowerCase())!==-1&&_[O[U]].push({...Q,frame:G,sourceSize:{w:z,h:H}})}}for(const U in _){const Q=I(_[U]);Array.isArray(Q)&&(_[U]=Q)}return _}else if(O&&typeof L.frames=="object"){for(let U=0;U<O.length;U++){_[O[U]]=[];for(const Q in L.frames){const G=L.frames[Q],z=G.frame,H=G.sourceSize.w,N=G.sourceSize.h;typeof Q=="string"&&Q.toLowerCase().indexOf(O[U].toLowerCase())!==-1&&_[O[U]].push({...G,frame:z,sourceSize:{w:H,h:N}})}}for(const U in _){const Q=I(_[U]);Array.isArray(Q)&&(_[U]=Q)}return _}else{let U=[];return L!=null&&L.frames&&(Array.isArray(L.frames)?U=L.frames.map(Q=>({...Q,x:Q.frame.x,y:Q.frame.y,w:Q.frame.w,h:Q.frame.h})):U=Object.values(L.frames).flat().map(Q=>({...Q,x:Q.frame.x,y:Q.frame.y,w:Q.frame.w,h:Q.frame.h}))),I(U)}return[]},[I,a]),w=A.useCallback((_,L)=>{let O=new b(1,1,1);if(_===null){if(L&&i){const U=L.image.width,Q=L.image.height;c.current=i;const{rows:G,columns:z,frameWidth:H,frameHeight:N,emptyFrames:V}=x(L,i),$={frames:[],meta:{version:"1.0",size:{w:U,h:Q},rows:G,columns:z,frameWidth:H,frameHeight:N,scale:"1"}};for(let Y=0;Y<G;Y++)for(let M=0;M<z;M++)(V??[]).some(P=>P.row===Y&&P.col===M)||Array.isArray($.frames)&&$.frames.push({frame:{x:M*H,y:Y*N,w:H,h:N},scaleRatio:1,rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:H,h:N},sourceSize:{w:H,h:N}});O=C(H,N,l),a.current=$}a.current&&a.current.frames&&(a.current.frames=I(a.current.frames))}else if(L){a.current=_,a.current.frames=S(),c.current=Array.isArray(_.frames)?_.frames.length:Object.keys(_.frames).length;const{w:U,h:Q}=rc(_.frames).sourceSize;O=C(U,Q,l)}p(a.current),"encoding"in L?L.encoding=3001:"colorSpace"in L&&(L.colorSpace=Hy),g(L),E({spriteTexture:L,spriteData:a.current,aspect:O})},[x,i,S,C,I]),B=A.useCallback((_,L,O)=>{const U=fetch(_).then(G=>G.json()),Q=new Promise(G=>{y.load(L,G)});Promise.all([U,Q]).then(G=>{O(G[0],G[1])})},[y]),T=A.useCallback(_=>{if(!_&&!u.current)throw new Error("Either textureUrl or input must be provided");const L=_??u.current;if(!L)throw new Error("A valid texture URL must be provided");y.load(L,O=>w(null,O))},[y,w]),R=A.useCallback((_,L)=>{L&&_?B(L,_,w):T(_)},[B,T,w]);return A.useLayoutEffect(()=>{h.current&&u.current?B(h.current,u.current,w):u.current&&T();const _=u.current;return()=>{_&&gt.clear(Bs,_)}},[B,T,w]),A.useLayoutEffect(()=>{s==null||s(m,d??null)},[m,d,s]),{spriteObj:v,loadJsonAndTexture:R}}xf.preload=n=>gt.preload(Bs,n);xf.clear=n=>gt.clear(Bs,n);function s2(n,e,...t){const i=A.useRef(),s=Z(r=>r.scene);return A.useLayoutEffect(()=>{let r;if(n&&n!=null&&n.current&&e&&(i.current=r=new e(n.current,...t)),r)return r.traverse(o=>o.raycast=()=>null),s.add(r),()=>{i.current=void 0,s.remove(r),r.dispose==null||r.dispose()}},[s,e,n,...t]),Ee(()=>{var r;return void((r=i.current)==null||r.update==null?void 0:r.update())}),i}const t7=({type:n,args:e=[]})=>{const t=A.useRef(null),i=A.useRef(null);return A.useLayoutEffect(()=>{i.current=t.current.parent}),s2(i,n,...e),A.createElement("object3D",{ref:t})};var n2={exports:{}};(function(n,e){(function(t,i){n.exports=i()})(Ky,function(){var t=function(){function i(d){return o.appendChild(d.dom),d}function s(d){for(var p=0;p<o.children.length;p++)o.children[p].style.display=p===d?"block":"none";r=d}var r=0,o=document.createElement("div");o.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",o.addEventListener("click",function(d){d.preventDefault(),s(++r%o.children.length)},!1);var a=(performance||Date).now(),c=a,l=0,u=i(new t.Panel("FPS","#0ff","#002")),h=i(new t.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var f=i(new t.Panel("MB","#f08","#201"));return s(0),{REVISION:16,dom:o,addPanel:i,showPanel:s,begin:function(){a=(performance||Date).now()},end:function(){l++;var d=(performance||Date).now();if(h.update(d-a,200),d>c+1e3&&(u.update(1e3*l/(d-c),100),c=d,l=0,f)){var p=performance.memory;f.update(p.usedJSHeapSize/1048576,p.jsHeapSizeLimit/1048576)}return d},update:function(){a=this.end()},domElement:o,setMode:s}};return t.Panel=function(i,s,r){var o=1/0,a=0,c=Math.round,l=c(window.devicePixelRatio||1),u=80*l,h=48*l,f=3*l,d=2*l,p=3*l,m=15*l,g=74*l,y=30*l,v=document.createElement("canvas");v.width=u,v.height=h,v.style.cssText="width:80px;height:48px";var E=v.getContext("2d");return E.font="bold "+9*l+"px Helvetica,Arial,sans-serif",E.textBaseline="top",E.fillStyle=r,E.fillRect(0,0,u,h),E.fillStyle=s,E.fillText(i,f,d),E.fillRect(p,m,g,y),E.fillStyle=r,E.globalAlpha=.9,E.fillRect(p,m,g,y),{dom:v,update:function(C,x){o=Math.min(o,C),a=Math.max(a,C),E.fillStyle=r,E.globalAlpha=1,E.fillRect(0,0,u,m),E.fillStyle=s,E.fillText(c(C)+" "+i+" ("+c(o)+"-"+c(a)+")",f,d),E.drawImage(v,p+l,m,g-l,y,p,m,g-l,y),E.fillRect(p+g-l,m,l,y),E.fillStyle=r,E.globalAlpha=.9,E.fillRect(p+g-l,m,l,c((1-C/x)*y))}}},t})})(n2);var k9=n2.exports;const O9=kh(k9);function U9(n,e=[],t){const[i,s]=A.useState();return A.useLayoutEffect(()=>{const r=n();return s(r),()=>void 0},e),i}function i7({showPanel:n=0,className:e,parent:t}){const i=U9(()=>new O9,[]);return A.useEffect(()=>{if(i){const s=t&&t.current||document.body;i.showPanel(n),s==null||s.appendChild(i.dom);const r=(e??"").split(" ").filter(c=>c);r.length&&i.dom.classList.add(...r);const o=m1(()=>i.begin()),a=Oh(()=>i.end());return()=>{r.length&&i.dom.classList.remove(...r),s==null||s.removeChild(i.dom),o(),a()}}},[t,i,e,n]),null}class Q9{constructor(e,t,i){this.name=e,this.fg=t,this.bg=i,this.gradient=null,this.PR=Math.round(window.devicePixelRatio||1),this.WIDTH=90*this.PR,this.HEIGHT=48*this.PR,this.TEXT_X=3*this.PR,this.TEXT_Y=2*this.PR,this.GRAPH_X=3*this.PR,this.GRAPH_Y=15*this.PR,this.GRAPH_WIDTH=84*this.PR,this.GRAPH_HEIGHT=30*this.PR,this.canvas=document.createElement("canvas"),this.canvas.width=this.WIDTH,this.canvas.height=this.HEIGHT,this.canvas.style.width="90px",this.canvas.style.height="48px",this.canvas.style.position="absolute",this.canvas.style.cssText="width:90px;height:48px",this.context=this.canvas.getContext("2d"),this.initializeCanvas()}createGradient(){if(!this.context)throw new Error("No context");const e=this.context.createLinearGradient(0,this.GRAPH_Y,0,this.GRAPH_Y+this.GRAPH_HEIGHT);let t;const i=this.fg;switch(this.fg.toLowerCase()){case"#0ff":t="#006666";break;case"#0f0":t="#006600";break;case"#ff0":t="#666600";break;case"#e1e1e1":t="#666666";break;default:t=this.bg;break}return e.addColorStop(0,t),e.addColorStop(1,i),e}initializeCanvas(){this.context&&(this.context.font="bold "+9*this.PR+"px Helvetica,Arial,sans-serif",this.context.textBaseline="top",this.gradient=this.createGradient(),this.context.fillStyle=this.bg,this.context.fillRect(0,0,this.WIDTH,this.HEIGHT),this.context.fillStyle=this.fg,this.context.fillText(this.name,this.TEXT_X,this.TEXT_Y),this.context.fillStyle=this.fg,this.context.fillRect(this.GRAPH_X,this.GRAPH_Y,this.GRAPH_WIDTH,this.GRAPH_HEIGHT),this.context.fillStyle=this.bg,this.context.globalAlpha=.9,this.context.fillRect(this.GRAPH_X,this.GRAPH_Y,this.GRAPH_WIDTH,this.GRAPH_HEIGHT))}update(e,t,i,s,r=0){if(!this.context||!this.gradient)return;const o=Math.min(1/0,e),a=Math.max(i,e);s=Math.max(s,t),this.context.globalAlpha=1,this.context.fillStyle=this.bg,this.context.fillRect(0,0,this.WIDTH,this.GRAPH_Y),this.context.fillStyle=this.fg,this.context.fillText(`${e.toFixed(r)} ${this.name} (${o.toFixed(r)}-${parseFloat(a.toFixed(r))})`,this.TEXT_X,this.TEXT_Y),this.context.drawImage(this.canvas,this.GRAPH_X+this.PR,this.GRAPH_Y,this.GRAPH_WIDTH-this.PR,this.GRAPH_HEIGHT,this.GRAPH_X,this.GRAPH_Y,this.GRAPH_WIDTH-this.PR,this.GRAPH_HEIGHT);const c=this.GRAPH_HEIGHT-(1-t/s)*this.GRAPH_HEIGHT;c>0&&(this.context.globalAlpha=1,this.context.fillStyle=this.gradient,this.context.fillRect(this.GRAPH_X+this.GRAPH_WIDTH-this.PR,this.GRAPH_Y+this.GRAPH_HEIGHT-c,this.PR,c))}}const r2=class tr{constructor({trackGPU:e=!1,logsPerSecond:t=30,samplesLog:i=60,samplesGraph:s=10,precision:r=2,minimal:o=!1,horizontal:a=!0,mode:c=0}={}){this.gl=null,this.ext=null,this.activeQuery=null,this.gpuQueries=[],this.threeRendererPatched=!1,this.frames=0,this.renderCount=0,this.isRunningCPUProfiling=!1,this.totalCpuDuration=0,this.totalGpuDuration=0,this.totalGpuDurationCompute=0,this.totalFps=0,this.gpuPanel=null,this.gpuPanelCompute=null,this.averageFps={logs:[],graph:[]},this.averageCpu={logs:[],graph:[]},this.averageGpu={logs:[],graph:[]},this.averageGpuCompute={logs:[],graph:[]},this.handleClick=l=>{l.preventDefault(),this.showPanel(++this.mode%this.dom.children.length)},this.handleResize=()=>{this.resizePanel(this.fpsPanel,0),this.resizePanel(this.msPanel,1),this.gpuPanel&&this.resizePanel(this.gpuPanel,2),this.gpuPanelCompute&&this.resizePanel(this.gpuPanelCompute,3)},this.mode=c,this.horizontal=a,this.minimal=o,this.trackGPU=e,this.samplesLog=i,this.samplesGraph=s,this.precision=r,this.logsPerSecond=t,this.dom=document.createElement("div"),this.initializeDOM(),this.beginTime=performance.now(),this.prevTime=this.beginTime,this.prevCpuTime=this.beginTime,this.fpsPanel=this.addPanel(new tr.Panel("FPS","#0ff","#002"),0),this.msPanel=this.addPanel(new tr.Panel("CPU","#0f0","#020"),1),this.setupEventListeners()}initializeDOM(){this.dom.style.cssText=`
      position: fixed;
      top: 0;
      left: 0;
      opacity: 0.9;
      z-index: 10000;
      ${this.minimal?"cursor: pointer;":""}
    `}setupEventListeners(){this.minimal?(this.dom.addEventListener("click",this.handleClick),this.showPanel(this.mode)):window.addEventListener("resize",this.handleResize)}async init(e){if(!e){console.error('Stats: The "canvas" parameter is undefined.');return}this.handleThreeRenderer(e)||await this.handleWebGPURenderer(e)||this.initializeWebGL(e)}handleThreeRenderer(e){return e.isWebGLRenderer&&!this.threeRendererPatched?(this.patchThreeRenderer(e),this.gl=e.getContext(),this.trackGPU&&this.initializeGPUTracking(),!0):!1}async handleWebGPURenderer(e){return e.isWebGPURenderer?(this.trackGPU&&(e.backend.trackTimestamp=!0,await e.hasFeatureAsync("timestamp-query")&&this.initializeWebGPUPanels()),this.info=e.info,!0):!1}initializeWebGPUPanels(){this.gpuPanel=this.addPanel(new tr.Panel("GPU","#ff0","#220"),2),this.gpuPanelCompute=this.addPanel(new tr.Panel("CPT","#e1e1e1","#212121"),3)}initializeWebGL(e){if(e instanceof WebGL2RenderingContext)this.gl=e;else if(e instanceof HTMLCanvasElement||e instanceof OffscreenCanvas){if(this.gl=e.getContext("webgl2"),!this.gl)return console.error("Stats: Unable to obtain WebGL2 context."),!1}else return console.error("Stats: Invalid input type. Expected WebGL2RenderingContext, HTMLCanvasElement, or OffscreenCanvas."),!1;return!0}initializeGPUTracking(){this.gl&&(this.ext=this.gl.getExtension("EXT_disjoint_timer_query_webgl2"),this.ext&&(this.gpuPanel=this.addPanel(new tr.Panel("GPU","#ff0","#220"),2)))}begin(){this.isRunningCPUProfiling||this.beginProfiling("cpu-started"),!(!this.gl||!this.ext)&&(this.activeQuery&&this.gl.endQuery(this.ext.TIME_ELAPSED_EXT),this.activeQuery=this.gl.createQuery(),this.activeQuery&&this.gl.beginQuery(this.ext.TIME_ELAPSED_EXT,this.activeQuery))}end(){this.renderCount++,this.gl&&this.ext&&this.activeQuery&&(this.gl.endQuery(this.ext.TIME_ELAPSED_EXT),this.gpuQueries.push({query:this.activeQuery}),this.activeQuery=null)}update(){this.info?this.processWebGPUTimestamps():this.processGpuQueries(),this.endProfiling("cpu-started","cpu-finished","cpu-duration"),this.updateAverages(),this.resetCounters()}processWebGPUTimestamps(){this.totalGpuDuration=this.info.render.timestamp,this.totalGpuDurationCompute=this.info.compute.timestamp,this.addToAverage(this.totalGpuDurationCompute,this.averageGpuCompute)}updateAverages(){this.addToAverage(this.totalCpuDuration,this.averageCpu),this.addToAverage(this.totalGpuDuration,this.averageGpu)}resetCounters(){this.renderCount=0,this.totalCpuDuration===0&&this.beginProfiling("cpu-started"),this.totalCpuDuration=0,this.totalFps=0,this.beginTime=this.endInternal()}resizePanel(e,t){e.canvas.style.position="absolute",this.minimal?e.canvas.style.display="none":(e.canvas.style.display="block",this.horizontal?(e.canvas.style.top="0px",e.canvas.style.left=t*e.WIDTH/e.PR+"px"):(e.canvas.style.left="0px",e.canvas.style.top=t*e.HEIGHT/e.PR+"px"))}addPanel(e,t){return e.canvas&&(this.dom.appendChild(e.canvas),this.resizePanel(e,t)),e}showPanel(e){for(let t=0;t<this.dom.children.length;t++){const i=this.dom.children[t];i.style.display=t===e?"block":"none"}this.mode=e}processGpuQueries(){!this.gl||!this.ext||(this.totalGpuDuration=0,this.gpuQueries.forEach((e,t)=>{if(this.gl){const i=this.gl.getQueryParameter(e.query,this.gl.QUERY_RESULT_AVAILABLE),s=this.gl.getParameter(this.ext.GPU_DISJOINT_EXT);if(i&&!s){const o=this.gl.getQueryParameter(e.query,this.gl.QUERY_RESULT)*1e-6;this.totalGpuDuration+=o,this.gl.deleteQuery(e.query),this.gpuQueries.splice(t,1)}}}))}endInternal(){this.frames++;const e=(performance||Date).now(),t=e-this.prevTime;if(e>=this.prevCpuTime+1e3/this.logsPerSecond){const i=Math.round(this.frames*1e3/t);this.addToAverage(i,this.averageFps),this.updatePanel(this.fpsPanel,this.averageFps,0),this.updatePanel(this.msPanel,this.averageCpu,this.precision),this.updatePanel(this.gpuPanel,this.averageGpu,this.precision),this.gpuPanelCompute&&this.updatePanel(this.gpuPanelCompute,this.averageGpuCompute),this.frames=0,this.prevCpuTime=e,this.prevTime=e}return e}addToAverage(e,t){t.logs.push(e),t.logs.length>this.samplesLog&&t.logs.shift(),t.graph.push(e),t.graph.length>this.samplesGraph&&t.graph.shift()}beginProfiling(e){window.performance&&(window.performance.mark(e),this.isRunningCPUProfiling=!0)}endProfiling(e,t,i){if(window.performance&&t&&this.isRunningCPUProfiling){window.performance.mark(t);const s=performance.measure(i,e,t);this.totalCpuDuration+=s.duration,this.isRunningCPUProfiling=!1}}updatePanel(e,t,i=2){if(t.logs.length>0){let s=0,r=.01;for(let c=0;c<t.logs.length;c++)s+=t.logs[c],t.logs[c]>r&&(r=t.logs[c]);let o=0,a=.01;for(let c=0;c<t.graph.length;c++)o+=t.graph[c],t.graph[c]>a&&(a=t.graph[c]);e&&e.update(s/Math.min(t.logs.length,this.samplesLog),o/Math.min(t.graph.length,this.samplesGraph),r,a,i)}}get domElement(){return this.dom}patchThreeRenderer(e){const t=e.render,i=this;e.render=function(s,r){i.begin(),t.call(this,s,r),i.end()},this.threeRendererPatched=!0}};r2.Panel=Q9;let N9=r2;const G9=A.forwardRef(({className:n,parent:e,id:t,clearStatsGlStyle:i,...s},r)=>{const o=Z(c=>c.gl),a=A.useMemo(()=>{const c=new N9({...s});return c.init(o),c},[o]);return A.useImperativeHandle(r,()=>a.dom),A.useEffect(()=>{if(a){const c=e&&e.current||document.body;c==null||c.appendChild(a.dom),a.dom.querySelectorAll("canvas").forEach(h=>{h.style.removeProperty("position")}),t&&(a.dom.id=t),i&&a.dom.removeAttribute("style"),a.dom.removeAttribute("style");const l=(n??"").split(" ").filter(h=>h);l.length&&a.dom.classList.add(...l);const u=Oh(()=>a.update());return()=>{l.length&&a.dom.classList.remove(...l),c==null||c.removeChild(a.dom),u()}}},[e,a,n,t,i]),null});G9.displayName="StatsGl";function s7({size:n=256,frames:e=1/0}={}){const t=Z(u=>u.viewport.dpr),{width:i,height:s}=Z(u=>u.size),r=n||i*t,o=n||s*t,a=A.useMemo(()=>{const u=new Uh(r,o);return u.format=Qh,u.type=Mc,{depthTexture:u}},[r,o]);let c=0;const l=wi(r,o,a);return Ee(u=>{(e===1/0||c<e)&&(u.gl.setRenderTarget(l),u.gl.render(u.scene,u.camera),u.gl.setRenderTarget(null),c++)}),l.depthTexture}function n7(n,e,t=1){const i=Z(o=>o.viewport),s=e*(i.aspect>n/e?i.width/n:i.height/e);return[n*(i.aspect>n/e?i.width/n:i.height/e)*t,s*t,1]}function r7(n,e){const t=Z(s=>s.pointer),[i]=A.useState(()=>{const s=new bc;return e&&Ss(s,e,{}),function(r,o){s.setFromCamera(t,n instanceof p1?n:n.current);const a=this.constructor.prototype.raycast.bind(this);a&&a(s,o)}});return i}function cu(n,e,t,i){return new(t||(t=Promise))(function(s,r){function o(l){try{c(i.next(l))}catch(u){r(u)}}function a(l){try{c(i.throw(l))}catch(u){r(u)}}function c(l){var u;l.done?s(l.value):(u=l.value,u instanceof t?u:new t(function(h){h(u)})).then(o,a)}c((i=i.apply(n,[])).next())})}const z9=["geforce 320m","geforce 8600","geforce 8600m gt","geforce 8800 gs","geforce 8800 gt","geforce 9400","geforce 9400m g","geforce 9400m","geforce 9600m gt","geforce 9600m","geforce fx go5200","geforce gt 120","geforce gt 130","geforce gt 330m","geforce gtx 285","google swiftshader","intel g41","intel g45","intel gma 4500mhd","intel gma x3100","intel hd 3000","intel q45","legacy","mali-2","mali-3","mali-4","quadro fx 1500","quadro fx 4","quadro fx 5","radeon hd 2400","radeon hd 2600","radeon hd 4670","radeon hd 4850","radeon hd 4870","radeon hd 5670","radeon hd 5750","radeon hd 6290","radeon hd 6300","radeon hd 6310","radeon hd 6320","radeon hd 6490m","radeon hd 6630m","radeon hd 6750m","radeon hd 6770m","radeon hd 6970m","sgx 543","sgx543"];function BA(n){return n=n.toLowerCase().replace(/.*angle ?\((.+)\)(?: on vulkan [0-9.]+)?$/i,"$1").replace(/\s(\d{1,2}gb|direct3d.+$)|\(r\)| \([^)]+\)$/g,"").replace(/(?:vulkan|opengl) \d+\.\d+(?:\.\d+)?(?: \((.*)\))?/,"$1")}const o2=typeof window>"u",Wi=(()=>{if(o2)return;const{userAgent:n,platform:e,maxTouchPoints:t}=window.navigator,i=/(iphone|ipod|ipad)/i.test(n),s=e==="iPad"||e==="MacIntel"&&t>0&&!window.MSStream;return{isIpad:s,isMobile:/android/i.test(n)||i||s,isSafari12:/Version\/12.+Safari/.test(n),isFirefox:/Firefox/.test(n)}})();function H9(n,e,t){if(!t)return[e];const i=function(l){const u=`
    precision highp float;
    attribute vec3 aPosition;
    varying float vvv;
    void main() {
      vvv = 0.31622776601683794;
      gl_Position = vec4(aPosition, 1.0);
    }
  `,h=`
    precision highp float;
    varying float vvv;
    void main() {
      vec4 enc = vec4(1.0, 255.0, 65025.0, 16581375.0) * vvv;
      enc = fract(enc);
      enc -= enc.yzww * vec4(1.0 / 255.0, 1.0 / 255.0, 1.0 / 255.0, 0.0);
      gl_FragColor = enc;
    }
  `,f=l.createShader(35633),d=l.createShader(35632),p=l.createProgram();if(!(d&&f&&p))return;l.shaderSource(f,u),l.shaderSource(d,h),l.compileShader(f),l.compileShader(d),l.attachShader(p,f),l.attachShader(p,d),l.linkProgram(p),l.detachShader(p,f),l.detachShader(p,d),l.deleteShader(f),l.deleteShader(d),l.useProgram(p);const m=l.createBuffer();l.bindBuffer(34962,m),l.bufferData(34962,new Float32Array([-1,-1,0,3,-1,0,-1,3,0]),35044);const g=l.getAttribLocation(p,"aPosition");l.vertexAttribPointer(g,3,5126,!1,0,0),l.enableVertexAttribArray(g),l.clearColor(1,1,1,1),l.clear(16384),l.viewport(0,0,1,1),l.drawArrays(4,0,3);const y=new Uint8Array(4);return l.readPixels(0,0,1,1,6408,5121,y),l.deleteProgram(p),l.deleteBuffer(m),y.join("")}(n),s="801621810",r="8016218135",o="80162181161",a=Wi!=null&&Wi.isIpad?[["a7",o,12],["a8",r,15],["a8x",r,15],["a9",r,15],["a9x",r,15],["a10",r,15],["a10x",r,15],["a12",s,15],["a12x",s,15],["a12z",s,15],["a14",s,15],["a15",s,15],["m1",s,15],["m2",s,15]]:[["a7",o,12],["a8",r,12],["a9",r,15],["a10",r,15],["a11",s,15],["a12",s,15],["a13",s,15],["a14",s,15],["a15",s,15],["a16",s,15],["a17",s,15]];let c;return i==="80162181255"?c=a.filter(([,,l])=>l>=14):(c=a.filter(([,l])=>l===i),c.length||(c=a)),c.map(([l])=>`apple ${l} gpu`)}let _A=class extends Error{constructor(e){super(e),Object.setPrototypeOf(this,new.target.prototype)}};const lu=[],bA=[];function K9(n,e){if(n===e)return 0;const t=n;n.length>e.length&&(n=e,e=t);let i=n.length,s=e.length;for(;i>0&&n.charCodeAt(~-i)===e.charCodeAt(~-s);)i--,s--;let r,o=0;for(;o<i&&n.charCodeAt(o)===e.charCodeAt(o);)o++;if(i-=o,s-=o,i===0)return s;let a,c,l=0,u=0,h=0;for(;u<i;)bA[u]=n.charCodeAt(o+u),lu[u]=++u;for(;h<s;)for(r=e.charCodeAt(o+h),a=h++,l=h,u=0;u<i;u++)c=r===bA[u]?a:a+1,a=lu[u],l=lu[u]=a>l?c>l?l+1:c:c>a?a+1:c;return l}function V9(n){return n!=null}const Y9=({mobileTiers:n=[0,15,30,60],desktopTiers:e=[0,15,30,60],override:t={},glContext:i,failIfMajorPerformanceCaveat:s=!1,benchmarksURL:r="https://unpkg.com/detect-gpu@5.0.58/dist/benchmarks"}={})=>cu(void 0,void 0,void 0,function*(){const o={};if(o2)return{tier:0,type:"SSR"};const{isIpad:a=!!(Wi!=null&&Wi.isIpad),isMobile:c=!!(Wi!=null&&Wi.isMobile),screenSize:l=window.screen,loadBenchmarks:u=x=>cu(void 0,void 0,void 0,function*(){const I=yield fetch(`${r}/${x}`).then(S=>S.json());if(parseInt(I.shift().split(".")[0],10)<4)throw new _A("Detect GPU benchmark data is out of date. Please update to version 4x");return I})}=t;let{renderer:h}=t;const f=(x,I,S,w,B)=>({device:B,fps:w,gpu:S,isMobile:c,tier:x,type:I});let d,p="";if(h)h=BA(h),d=[h];else{const x=i||function(S,w=!1){const B={alpha:!1,antialias:!1,depth:!1,failIfMajorPerformanceCaveat:w,powerPreference:"high-performance",stencil:!1};S&&delete B.powerPreference;const T=window.document.createElement("canvas"),R=T.getContext("webgl",B)||T.getContext("experimental-webgl",B);return R??void 0}(Wi==null?void 0:Wi.isSafari12,s);if(!x)return f(0,"WEBGL_UNSUPPORTED");const I=Wi!=null&&Wi.isFirefox?null:x.getExtension("WEBGL_debug_renderer_info");if(h=I?x.getParameter(I.UNMASKED_RENDERER_WEBGL):x.getParameter(x.RENDERER),!h)return f(1,"FALLBACK");p=h,h=BA(h),d=function(S,w,B){return w==="apple gpu"?H9(S,w,B):[w]}(x,h,c)}const m=(yield Promise.all(d.map(function(x){var I;return cu(this,void 0,void 0,function*(){const S=(Y=>{const M=c?["adreno","apple","mali-t","mali","nvidia","powervr","samsung"]:["intel","apple","amd","radeon","nvidia","geforce","adreno"];for(const k of M)if(Y.includes(k))return k})(x);if(!S)return;const w=`${c?"m":"d"}-${S}${a?"-ipad":""}.json`,B=o[w]=(I=o[w])!==null&&I!==void 0?I:u(w);let T;try{T=yield B}catch(Y){if(Y instanceof _A)throw Y;return}const R=function(Y){var M;const k=(Y=Y.replace(/\([^)]+\)/,"")).match(/\d+/)||Y.match(/(\W|^)([A-Za-z]{1,3})(\W|$)/g);return(M=k==null?void 0:k.join("").replace(/\W|amd/g,""))!==null&&M!==void 0?M:""}(x);let _=T.filter(([,Y])=>Y===R);_.length||(_=T.filter(([Y])=>Y.includes(x)));const L=_.length;if(L===0)return;const O=x.split(/[.,()\[\]/\s]/g).sort().filter((Y,M,k)=>M===0||Y!==k[M-1]).join(" ");let U,[Q,,,,G]=L>1?_.map(Y=>[Y,K9(O,Y[2])]).sort(([,Y],[,M])=>Y-M)[0][0]:_[0],z=Number.MAX_VALUE;const{devicePixelRatio:H}=window,N=l.width*H*l.height*H;for(const Y of G){const[M,k]=Y,P=M*k,F=Math.abs(N-P);F<z&&(z=F,U=Y)}if(!U)return;const[,,V,$]=U;return[z,V,Q,$]})}))).filter(V9).sort(([x=Number.MAX_VALUE,I],[S=Number.MAX_VALUE,w])=>x===S?I-w:x-S);if(!m.length){const x=z9.find(I=>h.includes(I));return x?f(0,"BLOCKLISTED",x):f(1,"FALLBACK",`${h} (${p})`)}const[,g,y,v]=m[0];if(g===-1)return f(0,"BLOCKLISTED",y,g,v);const E=c?n:e;let C=0;for(let x=0;x<E.length;x++)g>=E[x]&&(C=x);return f(C,"BENCHMARK",y,g,v)}),$9=n=>dn(()=>Y9(n),["useDetectGPU"]);function a7({children:n,...e}){const t=$9(e);return A.createElement(A.Fragment,null,n==null?void 0:n(t))}const a2=0,W9=1,Vc=2,RA=2,uu=1.25,DA=1,Ns=6*4+4+4,Yc=65535,j9=Math.pow(2,-24),hu=Symbol("SKIP_GENERATION");function c2(n){return n.index?n.index.count:n.attributes.position.count}function wr(n){return c2(n)/3}function l2(n,e=ArrayBuffer){return n>65535?new Uint32Array(new e(4*n)):new Uint16Array(new e(2*n))}function J9(n,e){if(!n.index){const t=n.attributes.position.count,i=e.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,s=l2(t,i);n.setIndex(new Ye(s,1));for(let r=0;r<t;r++)s[r]=r}}function u2(n,e){const t=wr(n),i=e||n.drawRange,s=i.start/3,r=(i.start+i.count)/3,o=Math.max(0,s),a=Math.min(t,r)-o;return[{offset:Math.floor(o),count:Math.floor(a)}]}function h2(n,e){if(!n.groups||!n.groups.length)return u2(n,e);const t=[],i=new Set,s=e||n.drawRange,r=s.start/3,o=(s.start+s.count)/3;for(const c of n.groups){const l=c.start/3,u=(c.start+c.count)/3;i.add(Math.max(r,l)),i.add(Math.min(o,u))}const a=Array.from(i.values()).sort((c,l)=>c-l);for(let c=0;c<a.length-1;c++){const l=a[c],u=a[c+1];t.push({offset:Math.floor(l),count:Math.floor(u-l)})}return t}function q9(n,e){const t=wr(n),i=h2(n,e).sort((o,a)=>o.offset-a.offset),s=i[i.length-1];s.count=Math.min(t-s.offset,s.count);let r=0;return i.forEach(({count:o})=>r+=o),t!==r}function fu(n,e,t,i,s){let r=1/0,o=1/0,a=1/0,c=-1/0,l=-1/0,u=-1/0,h=1/0,f=1/0,d=1/0,p=-1/0,m=-1/0,g=-1/0;for(let y=e*6,v=(e+t)*6;y<v;y+=6){const E=n[y+0],C=n[y+1],x=E-C,I=E+C;x<r&&(r=x),I>c&&(c=I),E<h&&(h=E),E>p&&(p=E);const S=n[y+2],w=n[y+3],B=S-w,T=S+w;B<o&&(o=B),T>l&&(l=T),S<f&&(f=S),S>m&&(m=S);const R=n[y+4],_=n[y+5],L=R-_,O=R+_;L<a&&(a=L),O>u&&(u=O),R<d&&(d=R),R>g&&(g=R)}i[0]=r,i[1]=o,i[2]=a,i[3]=c,i[4]=l,i[5]=u,s[0]=h,s[1]=f,s[2]=d,s[3]=p,s[4]=m,s[5]=g}function X9(n,e=null,t=null,i=null){const s=n.attributes.position,r=n.index?n.index.array:null,o=wr(n),a=s.normalized;let c;e===null?(c=new Float32Array(o*6*4),t=0,i=o):(c=e,t=t||0,i=i||o);const l=s.array,u=s.offset||0;let h=3;s.isInterleavedBufferAttribute&&(h=s.data.stride);const f=["getX","getY","getZ"];for(let d=t;d<t+i;d++){const p=d*3,m=d*6;let g=p+0,y=p+1,v=p+2;r&&(g=r[g],y=r[y],v=r[v]),a||(g=g*h+u,y=y*h+u,v=v*h+u);for(let E=0;E<3;E++){let C,x,I;a?(C=s[f[E]](g),x=s[f[E]](y),I=s[f[E]](v)):(C=l[g+E],x=l[y+E],I=l[v+E]);let S=C;x<S&&(S=x),I<S&&(S=I);let w=C;x>w&&(w=x),I>w&&(w=I);const B=(w-S)/2,T=E*2;c[m+T+0]=S+B,c[m+T+1]=B+(Math.abs(S)+B)*j9}}return c}function ut(n,e,t){return t.min.x=e[n],t.min.y=e[n+1],t.min.z=e[n+2],t.max.x=e[n+3],t.max.y=e[n+4],t.max.z=e[n+5],t}function MA(n){let e=-1,t=-1/0;for(let i=0;i<3;i++){const s=n[i+3]-n[i];s>t&&(t=s,e=i)}return e}function LA(n,e){e.set(n)}function PA(n,e,t){let i,s;for(let r=0;r<3;r++){const o=r+3;i=n[r],s=e[r],t[r]=i<s?i:s,i=n[o],s=e[o],t[o]=i>s?i:s}}function va(n,e,t){for(let i=0;i<3;i++){const s=e[n+2*i],r=e[n+2*i+1],o=s-r,a=s+r;o<t[i]&&(t[i]=o),a>t[i+3]&&(t[i+3]=a)}}function eo(n){const e=n[3]-n[0],t=n[4]-n[1],i=n[5]-n[2];return 2*(e*t+t*i+i*e)}const gs=32,Z9=(n,e)=>n.candidate-e.candidate,Ms=new Array(gs).fill().map(()=>({count:0,bounds:new Float32Array(6),rightCacheBounds:new Float32Array(6),leftCacheBounds:new Float32Array(6),candidate:0})),xa=new Float32Array(6);function eS(n,e,t,i,s,r){let o=-1,a=0;if(r===a2)o=MA(e),o!==-1&&(a=(e[o]+e[o+3])/2);else if(r===W9)o=MA(n),o!==-1&&(a=tS(t,i,s,o));else if(r===Vc){const c=eo(n);let l=uu*s;const u=i*6,h=(i+s)*6;for(let f=0;f<3;f++){const d=e[f],g=(e[f+3]-d)/gs;if(s<gs/4){const y=[...Ms];y.length=s;let v=0;for(let C=u;C<h;C+=6,v++){const x=y[v];x.candidate=t[C+2*f],x.count=0;const{bounds:I,leftCacheBounds:S,rightCacheBounds:w}=x;for(let B=0;B<3;B++)w[B]=1/0,w[B+3]=-1/0,S[B]=1/0,S[B+3]=-1/0,I[B]=1/0,I[B+3]=-1/0;va(C,t,I)}y.sort(Z9);let E=s;for(let C=0;C<E;C++){const x=y[C];for(;C+1<E&&y[C+1].candidate===x.candidate;)y.splice(C+1,1),E--}for(let C=u;C<h;C+=6){const x=t[C+2*f];for(let I=0;I<E;I++){const S=y[I];x>=S.candidate?va(C,t,S.rightCacheBounds):(va(C,t,S.leftCacheBounds),S.count++)}}for(let C=0;C<E;C++){const x=y[C],I=x.count,S=s-x.count,w=x.leftCacheBounds,B=x.rightCacheBounds;let T=0;I!==0&&(T=eo(w)/c);let R=0;S!==0&&(R=eo(B)/c);const _=DA+uu*(T*I+R*S);_<l&&(o=f,l=_,a=x.candidate)}}else{for(let E=0;E<gs;E++){const C=Ms[E];C.count=0,C.candidate=d+g+E*g;const x=C.bounds;for(let I=0;I<3;I++)x[I]=1/0,x[I+3]=-1/0}for(let E=u;E<h;E+=6){let I=~~((t[E+2*f]-d)/g);I>=gs&&(I=gs-1);const S=Ms[I];S.count++,va(E,t,S.bounds)}const y=Ms[gs-1];LA(y.bounds,y.rightCacheBounds);for(let E=gs-2;E>=0;E--){const C=Ms[E],x=Ms[E+1];PA(C.bounds,x.rightCacheBounds,C.rightCacheBounds)}let v=0;for(let E=0;E<gs-1;E++){const C=Ms[E],x=C.count,I=C.bounds,w=Ms[E+1].rightCacheBounds;x!==0&&(v===0?LA(I,xa):PA(I,xa,xa)),v+=x;let B=0,T=0;v!==0&&(B=eo(xa)/c);const R=s-v;R!==0&&(T=eo(w)/c);const _=DA+uu*(B*v+T*R);_<l&&(o=f,l=_,a=C.candidate)}}}}else console.warn(`MeshBVH: Invalid build strategy value ${r} used.`);return{axis:o,pos:a}}function tS(n,e,t,i){let s=0;for(let r=e,o=e+t;r<o;r++)s+=n[r*6+i*2];return s/t}class du{constructor(){this.boundingData=new Float32Array(6)}}function iS(n,e,t,i,s,r){let o=i,a=i+s-1;const c=r.pos,l=r.axis*2;for(;;){for(;o<=a&&t[o*6+l]<c;)o++;for(;o<=a&&t[a*6+l]>=c;)a--;if(o<a){for(let u=0;u<3;u++){let h=e[o*3+u];e[o*3+u]=e[a*3+u],e[a*3+u]=h}for(let u=0;u<6;u++){let h=t[o*6+u];t[o*6+u]=t[a*6+u],t[a*6+u]=h}o++,a--}else return o}}function sS(n,e,t,i,s,r){let o=i,a=i+s-1;const c=r.pos,l=r.axis*2;for(;;){for(;o<=a&&t[o*6+l]<c;)o++;for(;o<=a&&t[a*6+l]>=c;)a--;if(o<a){let u=n[o];n[o]=n[a],n[a]=u;for(let h=0;h<6;h++){let f=t[o*6+h];t[o*6+h]=t[a*6+h],t[a*6+h]=f}o++,a--}else return o}}function Wt(n,e){return e[n+15]===65535}function ii(n,e){return e[n+6]}function ci(n,e){return e[n+14]}function Ti(n){return n+8}function li(n,e){return e[n+6]}function Cf(n,e){return e[n+7]}let f2,Eo,oc,d2;const nS=Math.pow(2,32);function xh(n){return"count"in n?1:1+xh(n.left)+xh(n.right)}function rS(n,e,t){return f2=new Float32Array(t),Eo=new Uint32Array(t),oc=new Uint16Array(t),d2=new Uint8Array(t),Ch(n,e)}function Ch(n,e){const t=n/4,i=n/2,s="count"in e,r=e.boundingData;for(let o=0;o<6;o++)f2[t+o]=r[o];if(s)if(e.buffer){const o=e.buffer;d2.set(new Uint8Array(o),n);for(let a=n,c=n+o.byteLength;a<c;a+=Ns){const l=a/2;Wt(l,oc)||(Eo[a/4+6]+=t)}return n+o.byteLength}else{const o=e.offset,a=e.count;return Eo[t+6]=o,oc[i+14]=a,oc[i+15]=Yc,n+Ns}else{const o=e.left,a=e.right,c=e.splitAxis;let l;if(l=Ch(n+Ns,o),l/4>nS)throw new Error("MeshBVH: Cannot store child pointer greater than 32 bits.");return Eo[t+6]=l/4,l=Ch(l,a),Eo[t+7]=c,l}}function oS(n,e){const t=(n.index?n.index.count:n.attributes.position.count)/3,i=t>2**16,s=i?4:2,r=e?new SharedArrayBuffer(t*s):new ArrayBuffer(t*s),o=i?new Uint32Array(r):new Uint16Array(r);for(let a=0,c=o.length;a<c;a++)o[a]=a;return o}function aS(n,e,t,i,s){const{maxDepth:r,verbose:o,maxLeafTris:a,strategy:c,onProgress:l,indirect:u}=s,h=n._indirectBuffer,f=n.geometry,d=f.index?f.index.array:null,p=u?sS:iS,m=wr(f),g=new Float32Array(6);let y=!1;const v=new du;return fu(e,t,i,v.boundingData,g),C(v,t,i,g),v;function E(x){l&&l(x/m)}function C(x,I,S,w=null,B=0){if(!y&&B>=r&&(y=!0,o&&(console.warn(`MeshBVH: Max depth of ${r} reached when generating BVH. Consider increasing maxDepth.`),console.warn(f))),S<=a||B>=r)return E(I+S),x.offset=I,x.count=S,x;const T=eS(x.boundingData,w,e,I,S,c);if(T.axis===-1)return E(I+S),x.offset=I,x.count=S,x;const R=p(h,d,e,I,S,T);if(R===I||R===I+S)E(I+S),x.offset=I,x.count=S;else{x.splitAxis=T.axis;const _=new du,L=I,O=R-I;x.left=_,fu(e,L,O,_.boundingData,g),C(_,L,O,g,B+1);const U=new du,Q=R,G=S-O;x.right=U,fu(e,Q,G,U.boundingData,g),C(U,Q,G,g,B+1)}return x}}function cS(n,e){const t=n.geometry;e.indirect&&(n._indirectBuffer=oS(t,e.useSharedArrayBuffer),q9(t,e.range)&&!e.verbose&&console.warn('MeshBVH: Provided geometry contains groups or a range that do not fully span the vertex contents while using the "indirect" option. BVH may incorrectly report intersections on unrendered portions of the geometry.')),n._indirectBuffer||J9(t,e);const i=e.useSharedArrayBuffer?SharedArrayBuffer:ArrayBuffer,s=X9(t),r=e.indirect?u2(t,e.range):h2(t,e.range);n._roots=r.map(o=>{const a=aS(n,s,o.offset,o.count,e),c=xh(a),l=new i(Ns*c);return rS(0,a,l),l})}class _s{constructor(){this.min=1/0,this.max=-1/0}setFromPointsField(e,t){let i=1/0,s=-1/0;for(let r=0,o=e.length;r<o;r++){const c=e[r][t];i=c<i?c:i,s=c>s?c:s}this.min=i,this.max=s}setFromPoints(e,t){let i=1/0,s=-1/0;for(let r=0,o=t.length;r<o;r++){const a=t[r],c=e.dot(a);i=c<i?c:i,s=c>s?c:s}this.min=i,this.max=s}isSeparated(e){return this.min>e.max||e.min>this.max}}_s.prototype.setFromBox=function(){const n=new b;return function(t,i){const s=i.min,r=i.max;let o=1/0,a=-1/0;for(let c=0;c<=1;c++)for(let l=0;l<=1;l++)for(let u=0;u<=1;u++){n.x=s.x*c+r.x*(1-c),n.y=s.y*l+r.y*(1-l),n.z=s.z*u+r.z*(1-u);const h=t.dot(n);o=Math.min(h,o),a=Math.max(h,a)}this.min=o,this.max=a}}();const lS=function(){const n=new b,e=new b,t=new b;return function(s,r,o){const a=s.start,c=n,l=r.start,u=e;t.subVectors(a,l),n.subVectors(s.end,s.start),e.subVectors(r.end,r.start);const h=t.dot(u),f=u.dot(c),d=u.dot(u),p=t.dot(c),g=c.dot(c)*d-f*f;let y,v;g!==0?y=(h*f-p*d)/g:y=0,v=(h+y*f)/d,o.x=y,o.y=v}}(),If=function(){const n=new de,e=new b,t=new b;return function(s,r,o,a){lS(s,r,n);let c=n.x,l=n.y;if(c>=0&&c<=1&&l>=0&&l<=1){s.at(c,o),r.at(l,a);return}else if(c>=0&&c<=1){l<0?r.at(0,a):r.at(1,a),s.closestPointToPoint(a,!0,o);return}else if(l>=0&&l<=1){c<0?s.at(0,o):s.at(1,o),r.closestPointToPoint(o,!0,a);return}else{let u;c<0?u=s.start:u=s.end;let h;l<0?h=r.start:h=r.end;const f=e,d=t;if(s.closestPointToPoint(h,!0,e),r.closestPointToPoint(u,!0,t),f.distanceToSquared(h)<=d.distanceToSquared(u)){o.copy(f),a.copy(h);return}else{o.copy(u),a.copy(d);return}}}}(),uS=function(){const n=new b,e=new b,t=new bs,i=new ns;return function(r,o){const{radius:a,center:c}=r,{a:l,b:u,c:h}=o;if(i.start=l,i.end=u,i.closestPointToPoint(c,!0,n).distanceTo(c)<=a||(i.start=l,i.end=h,i.closestPointToPoint(c,!0,n).distanceTo(c)<=a)||(i.start=u,i.end=h,i.closestPointToPoint(c,!0,n).distanceTo(c)<=a))return!0;const m=o.getPlane(t);if(Math.abs(m.distanceToPoint(c))<=a){const y=m.projectPoint(c,e);if(o.containsPoint(y))return!0}return!1}}(),hS=1e-15;function Au(n){return Math.abs(n)<hS}class Ni extends ir{constructor(...e){super(...e),this.isExtendedTriangle=!0,this.satAxes=new Array(4).fill().map(()=>new b),this.satBounds=new Array(4).fill().map(()=>new _s),this.points=[this.a,this.b,this.c],this.sphere=new si,this.plane=new bs,this.needsUpdate=!0}intersectsSphere(e){return uS(e,this)}update(){const e=this.a,t=this.b,i=this.c,s=this.points,r=this.satAxes,o=this.satBounds,a=r[0],c=o[0];this.getNormal(a),c.setFromPoints(a,s);const l=r[1],u=o[1];l.subVectors(e,t),u.setFromPoints(l,s);const h=r[2],f=o[2];h.subVectors(t,i),f.setFromPoints(h,s);const d=r[3],p=o[3];d.subVectors(i,e),p.setFromPoints(d,s),this.sphere.setFromPoints(this.points),this.plane.setFromNormalAndCoplanarPoint(a,e),this.needsUpdate=!1}}Ni.prototype.closestPointToSegment=function(){const n=new b,e=new b,t=new ns;return function(s,r=null,o=null){const{start:a,end:c}=s,l=this.points;let u,h=1/0;for(let f=0;f<3;f++){const d=(f+1)%3;t.start.copy(l[f]),t.end.copy(l[d]),If(t,s,n,e),u=n.distanceToSquared(e),u<h&&(h=u,r&&r.copy(n),o&&o.copy(e))}return this.closestPointToPoint(a,n),u=a.distanceToSquared(n),u<h&&(h=u,r&&r.copy(n),o&&o.copy(a)),this.closestPointToPoint(c,n),u=c.distanceToSquared(n),u<h&&(h=u,r&&r.copy(n),o&&o.copy(c)),Math.sqrt(h)}}();Ni.prototype.intersectsTriangle=function(){const n=new Ni,e=new Array(3),t=new Array(3),i=new _s,s=new _s,r=new b,o=new b,a=new b,c=new b,l=new b,u=new ns,h=new ns,f=new ns,d=new b;function p(m,g,y){const v=m.points;let E=0,C=-1;for(let x=0;x<3;x++){const{start:I,end:S}=u;I.copy(v[x]),S.copy(v[(x+1)%3]),u.delta(o);const w=Au(g.distanceToPoint(I));if(Au(g.normal.dot(o))&&w){y.copy(u),E=2;break}const B=g.intersectLine(u,d);if(!B&&w&&d.copy(I),(B||w)&&!Au(d.distanceTo(S))){if(E<=1)(E===1?y.start:y.end).copy(d),w&&(C=E);else if(E>=2){(C===1?y.start:y.end).copy(d),E=2;break}if(E++,E===2&&C===-1)break}}return E}return function(g,y=null,v=!1){this.needsUpdate&&this.update(),g.isExtendedTriangle?g.needsUpdate&&g.update():(n.copy(g),n.update(),g=n);const E=this.plane,C=g.plane;if(Math.abs(E.normal.dot(C.normal))>1-1e-10){const x=this.satBounds,I=this.satAxes;t[0]=g.a,t[1]=g.b,t[2]=g.c;for(let B=0;B<4;B++){const T=x[B],R=I[B];if(i.setFromPoints(R,t),T.isSeparated(i))return!1}const S=g.satBounds,w=g.satAxes;e[0]=this.a,e[1]=this.b,e[2]=this.c;for(let B=0;B<4;B++){const T=S[B],R=w[B];if(i.setFromPoints(R,e),T.isSeparated(i))return!1}for(let B=0;B<4;B++){const T=I[B];for(let R=0;R<4;R++){const _=w[R];if(r.crossVectors(T,_),i.setFromPoints(r,e),s.setFromPoints(r,t),i.isSeparated(s))return!1}}return y&&(v||console.warn("ExtendedTriangle.intersectsTriangle: Triangles are coplanar which does not support an output edge. Setting edge to 0, 0, 0."),y.start.set(0,0,0),y.end.set(0,0,0)),!0}else{const x=p(this,C,h);if(x===1&&g.containsPoint(h.end))return y&&(y.start.copy(h.end),y.end.copy(h.end)),!0;if(x!==2)return!1;const I=p(g,E,f);if(I===1&&this.containsPoint(f.end))return y&&(y.start.copy(f.end),y.end.copy(f.end)),!0;if(I!==2)return!1;if(h.delta(a),f.delta(c),a.dot(c)<0){let L=f.start;f.start=f.end,f.end=L}const S=h.start.dot(a),w=h.end.dot(a),B=f.start.dot(a),T=f.end.dot(a),R=w<B,_=S<T;return S!==T&&B!==w&&R===_?!1:(y&&(l.subVectors(h.start,f.start),l.dot(a)>0?y.start.copy(h.start):y.start.copy(f.start),l.subVectors(h.end,f.end),l.dot(a)<0?y.end.copy(h.end):y.end.copy(f.end)),!0)}}}();Ni.prototype.distanceToPoint=function(){const n=new b;return function(t){return this.closestPointToPoint(t,n),t.distanceTo(n)}}();Ni.prototype.distanceToTriangle=function(){const n=new b,e=new b,t=["a","b","c"],i=new ns,s=new ns;return function(o,a=null,c=null){const l=a||c?i:null;if(this.intersectsTriangle(o,l))return(a||c)&&(a&&l.getCenter(a),c&&l.getCenter(c)),0;let u=1/0;for(let h=0;h<3;h++){let f;const d=t[h],p=o[d];this.closestPointToPoint(p,n),f=p.distanceToSquared(n),f<u&&(u=f,a&&a.copy(n),c&&c.copy(p));const m=this[d];o.closestPointToPoint(m,n),f=m.distanceToSquared(n),f<u&&(u=f,a&&a.copy(m),c&&c.copy(n))}for(let h=0;h<3;h++){const f=t[h],d=t[(h+1)%3];i.set(this[f],this[d]);for(let p=0;p<3;p++){const m=t[p],g=t[(p+1)%3];s.set(o[m],o[g]),If(i,s,n,e);const y=n.distanceToSquared(e);y<u&&(u=y,a&&a.copy(n),c&&c.copy(e))}}return Math.sqrt(u)}}();class Xt{constructor(e,t,i){this.isOrientedBox=!0,this.min=new b,this.max=new b,this.matrix=new ce,this.invMatrix=new ce,this.points=new Array(8).fill().map(()=>new b),this.satAxes=new Array(3).fill().map(()=>new b),this.satBounds=new Array(3).fill().map(()=>new _s),this.alignedSatBounds=new Array(3).fill().map(()=>new _s),this.needsUpdate=!1,e&&this.min.copy(e),t&&this.max.copy(t),i&&this.matrix.copy(i)}set(e,t,i){this.min.copy(e),this.max.copy(t),this.matrix.copy(i),this.needsUpdate=!0}copy(e){this.min.copy(e.min),this.max.copy(e.max),this.matrix.copy(e.matrix),this.needsUpdate=!0}}Xt.prototype.update=function(){return function(){const e=this.matrix,t=this.min,i=this.max,s=this.points;for(let l=0;l<=1;l++)for(let u=0;u<=1;u++)for(let h=0;h<=1;h++){const f=1*l|2*u|4*h,d=s[f];d.x=l?i.x:t.x,d.y=u?i.y:t.y,d.z=h?i.z:t.z,d.applyMatrix4(e)}const r=this.satBounds,o=this.satAxes,a=s[0];for(let l=0;l<3;l++){const u=o[l],h=r[l],f=1<<l,d=s[f];u.subVectors(a,d),h.setFromPoints(u,s)}const c=this.alignedSatBounds;c[0].setFromPointsField(s,"x"),c[1].setFromPointsField(s,"y"),c[2].setFromPointsField(s,"z"),this.invMatrix.copy(this.matrix).invert(),this.needsUpdate=!1}}();Xt.prototype.intersectsBox=function(){const n=new _s;return function(t){this.needsUpdate&&this.update();const i=t.min,s=t.max,r=this.satBounds,o=this.satAxes,a=this.alignedSatBounds;if(n.min=i.x,n.max=s.x,a[0].isSeparated(n)||(n.min=i.y,n.max=s.y,a[1].isSeparated(n))||(n.min=i.z,n.max=s.z,a[2].isSeparated(n)))return!1;for(let c=0;c<3;c++){const l=o[c],u=r[c];if(n.setFromBox(l,t),u.isSeparated(n))return!1}return!0}}();Xt.prototype.intersectsTriangle=function(){const n=new Ni,e=new Array(3),t=new _s,i=new _s,s=new b;return function(o){this.needsUpdate&&this.update(),o.isExtendedTriangle?o.needsUpdate&&o.update():(n.copy(o),n.update(),o=n);const a=this.satBounds,c=this.satAxes;e[0]=o.a,e[1]=o.b,e[2]=o.c;for(let f=0;f<3;f++){const d=a[f],p=c[f];if(t.setFromPoints(p,e),d.isSeparated(t))return!1}const l=o.satBounds,u=o.satAxes,h=this.points;for(let f=0;f<3;f++){const d=l[f],p=u[f];if(t.setFromPoints(p,h),d.isSeparated(t))return!1}for(let f=0;f<3;f++){const d=c[f];for(let p=0;p<4;p++){const m=u[p];if(s.crossVectors(d,m),t.setFromPoints(s,e),i.setFromPoints(s,h),t.isSeparated(i))return!1}}return!0}}();Xt.prototype.closestPointToPoint=function(){return function(e,t){return this.needsUpdate&&this.update(),t.copy(e).applyMatrix4(this.invMatrix).clamp(this.min,this.max).applyMatrix4(this.matrix),t}}();Xt.prototype.distanceToPoint=function(){const n=new b;return function(t){return this.closestPointToPoint(t,n),t.distanceTo(n)}}();Xt.prototype.distanceToBox=function(){const n=["x","y","z"],e=new Array(12).fill().map(()=>new ns),t=new Array(12).fill().map(()=>new ns),i=new b,s=new b;return function(o,a=0,c=null,l=null){if(this.needsUpdate&&this.update(),this.intersectsBox(o))return(c||l)&&(o.getCenter(s),this.closestPointToPoint(s,i),o.closestPointToPoint(i,s),c&&c.copy(i),l&&l.copy(s)),0;const u=a*a,h=o.min,f=o.max,d=this.points;let p=1/0;for(let g=0;g<8;g++){const y=d[g];s.copy(y).clamp(h,f);const v=y.distanceToSquared(s);if(v<p&&(p=v,c&&c.copy(y),l&&l.copy(s),v<u))return Math.sqrt(v)}let m=0;for(let g=0;g<3;g++)for(let y=0;y<=1;y++)for(let v=0;v<=1;v++){const E=(g+1)%3,C=(g+2)%3,x=y<<E|v<<C,I=1<<g|y<<E|v<<C,S=d[x],w=d[I];e[m].set(S,w);const T=n[g],R=n[E],_=n[C],L=t[m],O=L.start,U=L.end;O[T]=h[T],O[R]=y?h[R]:f[R],O[_]=v?h[_]:f[R],U[T]=f[T],U[R]=y?h[R]:f[R],U[_]=v?h[_]:f[R],m++}for(let g=0;g<=1;g++)for(let y=0;y<=1;y++)for(let v=0;v<=1;v++){s.x=g?f.x:h.x,s.y=y?f.y:h.y,s.z=v?f.z:h.z,this.closestPointToPoint(s,i);const E=s.distanceToSquared(i);if(E<p&&(p=E,c&&c.copy(i),l&&l.copy(s),E<u))return Math.sqrt(E)}for(let g=0;g<12;g++){const y=e[g];for(let v=0;v<12;v++){const E=t[v];If(y,E,i,s);const C=i.distanceToSquared(s);if(C<p&&(p=C,c&&c.copy(i),l&&l.copy(s),C<u))return Math.sqrt(C)}}return Math.sqrt(p)}}();class Sf{constructor(e){this._getNewPrimitive=e,this._primitives=[]}getPrimitive(){const e=this._primitives;return e.length===0?this._getNewPrimitive():e.pop()}releasePrimitive(e){this._primitives.push(e)}}class fS extends Sf{constructor(){super(()=>new Ni)}}const Bi=new fS;class dS{constructor(){this.float32Array=null,this.uint16Array=null,this.uint32Array=null;const e=[];let t=null;this.setBuffer=i=>{t&&e.push(t),t=i,this.float32Array=new Float32Array(i),this.uint16Array=new Uint16Array(i),this.uint32Array=new Uint32Array(i)},this.clearBuffer=()=>{t=null,this.float32Array=null,this.uint16Array=null,this.uint32Array=null,e.length!==0&&this.setBuffer(e.pop())}}}const it=new dS;let Qs,rr;const On=[],Ca=new Sf(()=>new st);function AS(n,e,t,i,s,r){Qs=Ca.getPrimitive(),rr=Ca.getPrimitive(),On.push(Qs,rr),it.setBuffer(n._roots[e]);const o=Ih(0,n.geometry,t,i,s,r);it.clearBuffer(),Ca.releasePrimitive(Qs),Ca.releasePrimitive(rr),On.pop(),On.pop();const a=On.length;return a>0&&(rr=On[a-1],Qs=On[a-2]),o}function Ih(n,e,t,i,s=null,r=0,o=0){const{float32Array:a,uint16Array:c,uint32Array:l}=it;let u=n*2;if(Wt(u,c)){const f=ii(n,l),d=ci(u,c);return ut(n,a,Qs),i(f,d,!1,o,r+n,Qs)}else{let T=function(_){const{uint16Array:L,uint32Array:O}=it;let U=_*2;for(;!Wt(U,L);)_=Ti(_),U=_*2;return ii(_,O)},R=function(_){const{uint16Array:L,uint32Array:O}=it;let U=_*2;for(;!Wt(U,L);)_=li(_,O),U=_*2;return ii(_,O)+ci(U,L)};const f=Ti(n),d=li(n,l);let p=f,m=d,g,y,v,E;if(s&&(v=Qs,E=rr,ut(p,a,v),ut(m,a,E),g=s(v),y=s(E),y<g)){p=d,m=f;const _=g;g=y,y=_,v=E}v||(v=Qs,ut(p,a,v));const C=Wt(p*2,c),x=t(v,C,g,o+1,r+p);let I;if(x===RA){const _=T(p),O=R(p)-_;I=i(_,O,!0,o+1,r+p,v)}else I=x&&Ih(p,e,t,i,s,r,o+1);if(I)return!0;E=rr,ut(m,a,E);const S=Wt(m*2,c),w=t(E,S,y,o+1,r+m);let B;if(w===RA){const _=T(m),O=R(m)-_;B=i(_,O,!0,o+1,r+m,E)}else B=w&&Ih(m,e,t,i,s,r,o+1);return!!B}}const to=new b,mu=new b;function mS(n,e,t={},i=0,s=1/0){const r=i*i,o=s*s;let a=1/0,c=null;if(n.shapecast({boundsTraverseOrder:u=>(to.copy(e).clamp(u.min,u.max),to.distanceToSquared(e)),intersectsBounds:(u,h,f)=>f<a&&f<o,intersectsTriangle:(u,h)=>{u.closestPointToPoint(e,to);const f=e.distanceToSquared(to);return f<a&&(mu.copy(to),a=f,c=h),f<r}}),a===1/0)return null;const l=Math.sqrt(a);return t.point?t.point.copy(mu):t.point=mu.clone(),t.distance=l,t.faceIndex=c,t}const Un=new b,Qn=new b,Nn=new b,Ia=new de,Sa=new de,wa=new de,FA=new b,kA=new b,OA=new b,Ta=new b;function pS(n,e,t,i,s,r,o,a){let c;if(r===Cr?c=n.intersectTriangle(i,t,e,!0,s):c=n.intersectTriangle(e,t,i,r!==Tt,s),c===null)return null;const l=n.origin.distanceTo(s);return l<o||l>a?null:{distance:l,point:s.clone()}}function gS(n,e,t,i,s,r,o,a,c,l,u){Un.fromBufferAttribute(e,r),Qn.fromBufferAttribute(e,o),Nn.fromBufferAttribute(e,a);const h=pS(n,Un,Qn,Nn,Ta,c,l,u);if(h){i&&(Ia.fromBufferAttribute(i,r),Sa.fromBufferAttribute(i,o),wa.fromBufferAttribute(i,a),h.uv=ir.getInterpolation(Ta,Un,Qn,Nn,Ia,Sa,wa,new de)),s&&(Ia.fromBufferAttribute(s,r),Sa.fromBufferAttribute(s,o),wa.fromBufferAttribute(s,a),h.uv1=ir.getInterpolation(Ta,Un,Qn,Nn,Ia,Sa,wa,new de)),t&&(FA.fromBufferAttribute(t,r),kA.fromBufferAttribute(t,o),OA.fromBufferAttribute(t,a),h.normal=ir.getInterpolation(Ta,Un,Qn,Nn,FA,kA,OA,new b),h.normal.dot(n.direction)>0&&h.normal.multiplyScalar(-1));const f={a:r,b:o,c:a,normal:new b,materialIndex:0};ir.getNormal(Un,Qn,Nn,f.normal),h.face=f,h.faceIndex=r}return h}function $c(n,e,t,i,s,r,o){const a=i*3;let c=a+0,l=a+1,u=a+2;const h=n.index;n.index&&(c=h.getX(c),l=h.getX(l),u=h.getX(u));const{position:f,normal:d,uv:p,uv1:m}=n.attributes,g=gS(t,f,d,p,m,c,l,u,e,r,o);return g?(g.faceIndex=i,s&&s.push(g),g):null}function mt(n,e,t,i){const s=n.a,r=n.b,o=n.c;let a=e,c=e+1,l=e+2;t&&(a=t.getX(a),c=t.getX(c),l=t.getX(l)),s.x=i.getX(a),s.y=i.getY(a),s.z=i.getZ(a),r.x=i.getX(c),r.y=i.getY(c),r.z=i.getZ(c),o.x=i.getX(l),o.y=i.getY(l),o.z=i.getZ(l)}function yS(n,e,t,i,s,r,o,a){const{geometry:c,_indirectBuffer:l}=n;for(let u=i,h=i+s;u<h;u++)$c(c,e,t,u,r,o,a)}function ES(n,e,t,i,s,r,o){const{geometry:a,_indirectBuffer:c}=n;let l=1/0,u=null;for(let h=i,f=i+s;h<f;h++){let d;d=$c(a,e,t,h,null,r,o),d&&d.distance<l&&(u=d,l=d.distance)}return u}function vS(n,e,t,i,s,r,o){const{geometry:a}=t,{index:c}=a,l=a.attributes.position;for(let u=n,h=e+n;u<h;u++){let f;if(f=u,mt(o,f*3,c,l),o.needsUpdate=!0,i(o,f,s,r))return!0}return!1}function xS(n,e=null){e&&Array.isArray(e)&&(e=new Set(e));const t=n.geometry,i=t.index?t.index.array:null,s=t.attributes.position;let r,o,a,c,l=0;const u=n._roots;for(let f=0,d=u.length;f<d;f++)r=u[f],o=new Uint32Array(r),a=new Uint16Array(r),c=new Float32Array(r),h(0,l),l+=r.byteLength;function h(f,d,p=!1){const m=f*2;if(a[m+15]===Yc){const y=o[f+6],v=a[m+14];let E=1/0,C=1/0,x=1/0,I=-1/0,S=-1/0,w=-1/0;for(let B=3*y,T=3*(y+v);B<T;B++){let R=i[B];const _=s.getX(R),L=s.getY(R),O=s.getZ(R);_<E&&(E=_),_>I&&(I=_),L<C&&(C=L),L>S&&(S=L),O<x&&(x=O),O>w&&(w=O)}return c[f+0]!==E||c[f+1]!==C||c[f+2]!==x||c[f+3]!==I||c[f+4]!==S||c[f+5]!==w?(c[f+0]=E,c[f+1]=C,c[f+2]=x,c[f+3]=I,c[f+4]=S,c[f+5]=w,!0):!1}else{const y=f+8,v=o[f+6],E=y+d,C=v+d;let x=p,I=!1,S=!1;e?x||(I=e.has(E),S=e.has(C),x=!I&&!S):(I=!0,S=!0);const w=x||I,B=x||S;let T=!1;w&&(T=h(y,d,x));let R=!1;B&&(R=h(v,d,x));const _=T||R;if(_)for(let L=0;L<3;L++){const O=y+L,U=v+L,Q=c[O],G=c[O+3],z=c[U],H=c[U+3];c[f+L]=Q<z?Q:z,c[f+L+3]=G>H?G:H}return _}}}function Hs(n,e,t,i,s){let r,o,a,c,l,u;const h=1/t.direction.x,f=1/t.direction.y,d=1/t.direction.z,p=t.origin.x,m=t.origin.y,g=t.origin.z;let y=e[n],v=e[n+3],E=e[n+1],C=e[n+3+1],x=e[n+2],I=e[n+3+2];return h>=0?(r=(y-p)*h,o=(v-p)*h):(r=(v-p)*h,o=(y-p)*h),f>=0?(a=(E-m)*f,c=(C-m)*f):(a=(C-m)*f,c=(E-m)*f),r>c||a>o||((a>r||isNaN(r))&&(r=a),(c<o||isNaN(o))&&(o=c),d>=0?(l=(x-g)*d,u=(I-g)*d):(l=(I-g)*d,u=(x-g)*d),r>u||l>o)?!1:((l>r||r!==r)&&(r=l),(u<o||o!==o)&&(o=u),r<=s&&o>=i)}function CS(n,e,t,i,s,r,o,a){const{geometry:c,_indirectBuffer:l}=n;for(let u=i,h=i+s;u<h;u++){let f=l?l[u]:u;$c(c,e,t,f,r,o,a)}}function IS(n,e,t,i,s,r,o){const{geometry:a,_indirectBuffer:c}=n;let l=1/0,u=null;for(let h=i,f=i+s;h<f;h++){let d;d=$c(a,e,t,c?c[h]:h,null,r,o),d&&d.distance<l&&(u=d,l=d.distance)}return u}function SS(n,e,t,i,s,r,o){const{geometry:a}=t,{index:c}=a,l=a.attributes.position;for(let u=n,h=e+n;u<h;u++){let f;if(f=t.resolveTriangleIndex(u),mt(o,f*3,c,l),o.needsUpdate=!0,i(o,f,s,r))return!0}return!1}function wS(n,e,t,i,s,r,o){it.setBuffer(n._roots[e]),Sh(0,n,t,i,s,r,o),it.clearBuffer()}function Sh(n,e,t,i,s,r,o){const{float32Array:a,uint16Array:c,uint32Array:l}=it,u=n*2;if(Wt(u,c)){const f=ii(n,l),d=ci(u,c);yS(e,t,i,f,d,s,r,o)}else{const f=Ti(n);Hs(f,a,i,r,o)&&Sh(f,e,t,i,s,r,o);const d=li(n,l);Hs(d,a,i,r,o)&&Sh(d,e,t,i,s,r,o)}}const TS=["x","y","z"];function BS(n,e,t,i,s,r){it.setBuffer(n._roots[e]);const o=wh(0,n,t,i,s,r);return it.clearBuffer(),o}function wh(n,e,t,i,s,r){const{float32Array:o,uint16Array:a,uint32Array:c}=it;let l=n*2;if(Wt(l,a)){const h=ii(n,c),f=ci(l,a);return ES(e,t,i,h,f,s,r)}else{const h=Cf(n,c),f=TS[h],p=i.direction[f]>=0;let m,g;p?(m=Ti(n),g=li(n,c)):(m=li(n,c),g=Ti(n));const v=Hs(m,o,i,s,r)?wh(m,e,t,i,s,r):null;if(v){const x=v.point[f];if(p?x<=o[g+h]:x>=o[g+h+3])return v}const C=Hs(g,o,i,s,r)?wh(g,e,t,i,s,r):null;return v&&C?v.distance<=C.distance?v:C:v||C||null}}const Ba=new st,Gn=new Ni,zn=new Ni,io=new ce,UA=new Xt,_a=new Xt;function _S(n,e,t,i){it.setBuffer(n._roots[e]);const s=Th(0,n,t,i);return it.clearBuffer(),s}function Th(n,e,t,i,s=null){const{float32Array:r,uint16Array:o,uint32Array:a}=it;let c=n*2;if(s===null&&(t.boundingBox||t.computeBoundingBox(),UA.set(t.boundingBox.min,t.boundingBox.max,i),s=UA),Wt(c,o)){const u=e.geometry,h=u.index,f=u.attributes.position,d=t.index,p=t.attributes.position,m=ii(n,a),g=ci(c,o);if(io.copy(i).invert(),t.boundsTree)return ut(n,r,_a),_a.matrix.copy(io),_a.needsUpdate=!0,t.boundsTree.shapecast({intersectsBounds:v=>_a.intersectsBox(v),intersectsTriangle:v=>{v.a.applyMatrix4(i),v.b.applyMatrix4(i),v.c.applyMatrix4(i),v.needsUpdate=!0;for(let E=m*3,C=(g+m)*3;E<C;E+=3)if(mt(zn,E,h,f),zn.needsUpdate=!0,v.intersectsTriangle(zn))return!0;return!1}});for(let y=m*3,v=(g+m)*3;y<v;y+=3){mt(Gn,y,h,f),Gn.a.applyMatrix4(io),Gn.b.applyMatrix4(io),Gn.c.applyMatrix4(io),Gn.needsUpdate=!0;for(let E=0,C=d.count;E<C;E+=3)if(mt(zn,E,d,p),zn.needsUpdate=!0,Gn.intersectsTriangle(zn))return!0}}else{const u=n+8,h=a[n+6];return ut(u,r,Ba),!!(s.intersectsBox(Ba)&&Th(u,e,t,i,s)||(ut(h,r,Ba),s.intersectsBox(Ba)&&Th(h,e,t,i,s)))}}const ba=new ce,pu=new Xt,so=new Xt,bS=new b,RS=new b,DS=new b,MS=new b;function LS(n,e,t,i={},s={},r=0,o=1/0){e.boundingBox||e.computeBoundingBox(),pu.set(e.boundingBox.min,e.boundingBox.max,t),pu.needsUpdate=!0;const a=n.geometry,c=a.attributes.position,l=a.index,u=e.attributes.position,h=e.index,f=Bi.getPrimitive(),d=Bi.getPrimitive();let p=bS,m=RS,g=null,y=null;s&&(g=DS,y=MS);let v=1/0,E=null,C=null;return ba.copy(t).invert(),so.matrix.copy(ba),n.shapecast({boundsTraverseOrder:x=>pu.distanceToBox(x),intersectsBounds:(x,I,S)=>S<v&&S<o?(I&&(so.min.copy(x.min),so.max.copy(x.max),so.needsUpdate=!0),!0):!1,intersectsRange:(x,I)=>{if(e.boundsTree)return e.boundsTree.shapecast({boundsTraverseOrder:w=>so.distanceToBox(w),intersectsBounds:(w,B,T)=>T<v&&T<o,intersectsRange:(w,B)=>{for(let T=w,R=w+B;T<R;T++){mt(d,3*T,h,u),d.a.applyMatrix4(t),d.b.applyMatrix4(t),d.c.applyMatrix4(t),d.needsUpdate=!0;for(let _=x,L=x+I;_<L;_++){mt(f,3*_,l,c),f.needsUpdate=!0;const O=f.distanceToTriangle(d,p,g);if(O<v&&(m.copy(p),y&&y.copy(g),v=O,E=_,C=T),O<r)return!0}}}});{const S=wr(e);for(let w=0,B=S;w<B;w++){mt(d,3*w,h,u),d.a.applyMatrix4(t),d.b.applyMatrix4(t),d.c.applyMatrix4(t),d.needsUpdate=!0;for(let T=x,R=x+I;T<R;T++){mt(f,3*T,l,c),f.needsUpdate=!0;const _=f.distanceToTriangle(d,p,g);if(_<v&&(m.copy(p),y&&y.copy(g),v=_,E=T,C=w),_<r)return!0}}}}}),Bi.releasePrimitive(f),Bi.releasePrimitive(d),v===1/0?null:(i.point?i.point.copy(m):i.point=m.clone(),i.distance=v,i.faceIndex=E,s&&(s.point?s.point.copy(y):s.point=y.clone(),s.point.applyMatrix4(ba),m.applyMatrix4(ba),s.distance=m.sub(s.point).length(),s.faceIndex=C),i)}function PS(n,e=null){e&&Array.isArray(e)&&(e=new Set(e));const t=n.geometry,i=t.index?t.index.array:null,s=t.attributes.position;let r,o,a,c,l=0;const u=n._roots;for(let f=0,d=u.length;f<d;f++)r=u[f],o=new Uint32Array(r),a=new Uint16Array(r),c=new Float32Array(r),h(0,l),l+=r.byteLength;function h(f,d,p=!1){const m=f*2;if(a[m+15]===Yc){const y=o[f+6],v=a[m+14];let E=1/0,C=1/0,x=1/0,I=-1/0,S=-1/0,w=-1/0;for(let B=y,T=y+v;B<T;B++){const R=3*n.resolveTriangleIndex(B);for(let _=0;_<3;_++){let L=R+_;L=i?i[L]:L;const O=s.getX(L),U=s.getY(L),Q=s.getZ(L);O<E&&(E=O),O>I&&(I=O),U<C&&(C=U),U>S&&(S=U),Q<x&&(x=Q),Q>w&&(w=Q)}}return c[f+0]!==E||c[f+1]!==C||c[f+2]!==x||c[f+3]!==I||c[f+4]!==S||c[f+5]!==w?(c[f+0]=E,c[f+1]=C,c[f+2]=x,c[f+3]=I,c[f+4]=S,c[f+5]=w,!0):!1}else{const y=f+8,v=o[f+6],E=y+d,C=v+d;let x=p,I=!1,S=!1;e?x||(I=e.has(E),S=e.has(C),x=!I&&!S):(I=!0,S=!0);const w=x||I,B=x||S;let T=!1;w&&(T=h(y,d,x));let R=!1;B&&(R=h(v,d,x));const _=T||R;if(_)for(let L=0;L<3;L++){const O=y+L,U=v+L,Q=c[O],G=c[O+3],z=c[U],H=c[U+3];c[f+L]=Q<z?Q:z,c[f+L+3]=G>H?G:H}return _}}}function FS(n,e,t,i,s,r,o){it.setBuffer(n._roots[e]),Bh(0,n,t,i,s,r,o),it.clearBuffer()}function Bh(n,e,t,i,s,r,o){const{float32Array:a,uint16Array:c,uint32Array:l}=it,u=n*2;if(Wt(u,c)){const f=ii(n,l),d=ci(u,c);CS(e,t,i,f,d,s,r,o)}else{const f=Ti(n);Hs(f,a,i,r,o)&&Bh(f,e,t,i,s,r,o);const d=li(n,l);Hs(d,a,i,r,o)&&Bh(d,e,t,i,s,r,o)}}const kS=["x","y","z"];function OS(n,e,t,i,s,r){it.setBuffer(n._roots[e]);const o=_h(0,n,t,i,s,r);return it.clearBuffer(),o}function _h(n,e,t,i,s,r){const{float32Array:o,uint16Array:a,uint32Array:c}=it;let l=n*2;if(Wt(l,a)){const h=ii(n,c),f=ci(l,a);return IS(e,t,i,h,f,s,r)}else{const h=Cf(n,c),f=kS[h],p=i.direction[f]>=0;let m,g;p?(m=Ti(n),g=li(n,c)):(m=li(n,c),g=Ti(n));const v=Hs(m,o,i,s,r)?_h(m,e,t,i,s,r):null;if(v){const x=v.point[f];if(p?x<=o[g+h]:x>=o[g+h+3])return v}const C=Hs(g,o,i,s,r)?_h(g,e,t,i,s,r):null;return v&&C?v.distance<=C.distance?v:C:v||C||null}}const Ra=new st,Hn=new Ni,Kn=new Ni,no=new ce,QA=new Xt,Da=new Xt;function US(n,e,t,i){it.setBuffer(n._roots[e]);const s=bh(0,n,t,i);return it.clearBuffer(),s}function bh(n,e,t,i,s=null){const{float32Array:r,uint16Array:o,uint32Array:a}=it;let c=n*2;if(s===null&&(t.boundingBox||t.computeBoundingBox(),QA.set(t.boundingBox.min,t.boundingBox.max,i),s=QA),Wt(c,o)){const u=e.geometry,h=u.index,f=u.attributes.position,d=t.index,p=t.attributes.position,m=ii(n,a),g=ci(c,o);if(no.copy(i).invert(),t.boundsTree)return ut(n,r,Da),Da.matrix.copy(no),Da.needsUpdate=!0,t.boundsTree.shapecast({intersectsBounds:v=>Da.intersectsBox(v),intersectsTriangle:v=>{v.a.applyMatrix4(i),v.b.applyMatrix4(i),v.c.applyMatrix4(i),v.needsUpdate=!0;for(let E=m,C=g+m;E<C;E++)if(mt(Kn,3*e.resolveTriangleIndex(E),h,f),Kn.needsUpdate=!0,v.intersectsTriangle(Kn))return!0;return!1}});for(let y=m,v=g+m;y<v;y++){const E=e.resolveTriangleIndex(y);mt(Hn,3*E,h,f),Hn.a.applyMatrix4(no),Hn.b.applyMatrix4(no),Hn.c.applyMatrix4(no),Hn.needsUpdate=!0;for(let C=0,x=d.count;C<x;C+=3)if(mt(Kn,C,d,p),Kn.needsUpdate=!0,Hn.intersectsTriangle(Kn))return!0}}else{const u=n+8,h=a[n+6];return ut(u,r,Ra),!!(s.intersectsBox(Ra)&&bh(u,e,t,i,s)||(ut(h,r,Ra),s.intersectsBox(Ra)&&bh(h,e,t,i,s)))}}const Ma=new ce,gu=new Xt,ro=new Xt,QS=new b,NS=new b,GS=new b,zS=new b;function HS(n,e,t,i={},s={},r=0,o=1/0){e.boundingBox||e.computeBoundingBox(),gu.set(e.boundingBox.min,e.boundingBox.max,t),gu.needsUpdate=!0;const a=n.geometry,c=a.attributes.position,l=a.index,u=e.attributes.position,h=e.index,f=Bi.getPrimitive(),d=Bi.getPrimitive();let p=QS,m=NS,g=null,y=null;s&&(g=GS,y=zS);let v=1/0,E=null,C=null;return Ma.copy(t).invert(),ro.matrix.copy(Ma),n.shapecast({boundsTraverseOrder:x=>gu.distanceToBox(x),intersectsBounds:(x,I,S)=>S<v&&S<o?(I&&(ro.min.copy(x.min),ro.max.copy(x.max),ro.needsUpdate=!0),!0):!1,intersectsRange:(x,I)=>{if(e.boundsTree){const S=e.boundsTree;return S.shapecast({boundsTraverseOrder:w=>ro.distanceToBox(w),intersectsBounds:(w,B,T)=>T<v&&T<o,intersectsRange:(w,B)=>{for(let T=w,R=w+B;T<R;T++){const _=S.resolveTriangleIndex(T);mt(d,3*_,h,u),d.a.applyMatrix4(t),d.b.applyMatrix4(t),d.c.applyMatrix4(t),d.needsUpdate=!0;for(let L=x,O=x+I;L<O;L++){const U=n.resolveTriangleIndex(L);mt(f,3*U,l,c),f.needsUpdate=!0;const Q=f.distanceToTriangle(d,p,g);if(Q<v&&(m.copy(p),y&&y.copy(g),v=Q,E=L,C=T),Q<r)return!0}}}})}else{const S=wr(e);for(let w=0,B=S;w<B;w++){mt(d,3*w,h,u),d.a.applyMatrix4(t),d.b.applyMatrix4(t),d.c.applyMatrix4(t),d.needsUpdate=!0;for(let T=x,R=x+I;T<R;T++){const _=n.resolveTriangleIndex(T);mt(f,3*_,l,c),f.needsUpdate=!0;const L=f.distanceToTriangle(d,p,g);if(L<v&&(m.copy(p),y&&y.copy(g),v=L,E=T,C=w),L<r)return!0}}}}}),Bi.releasePrimitive(f),Bi.releasePrimitive(d),v===1/0?null:(i.point?i.point.copy(m):i.point=m.clone(),i.distance=v,i.faceIndex=E,s&&(s.point?s.point.copy(y):s.point=y.clone(),s.point.applyMatrix4(Ma),m.applyMatrix4(Ma),s.distance=m.sub(s.point).length(),s.faceIndex=C),i)}function KS(){return typeof SharedArrayBuffer<"u"}const Bo=new it.constructor,Bc=new it.constructor,Os=new Sf(()=>new st),Vn=new st,Yn=new st,yu=new st,Eu=new st;let vu=!1;function VS(n,e,t,i){if(vu)throw new Error("MeshBVH: Recursive calls to bvhcast not supported.");vu=!0;const s=n._roots,r=e._roots;let o,a=0,c=0;const l=new ce().copy(t).invert();for(let u=0,h=s.length;u<h;u++){Bo.setBuffer(s[u]),c=0;const f=Os.getPrimitive();ut(0,Bo.float32Array,f),f.applyMatrix4(l);for(let d=0,p=r.length;d<p&&(Bc.setBuffer(r[d]),o=Oi(0,0,t,l,i,a,c,0,0,f),Bc.clearBuffer(),c+=r[d].length,!o);d++);if(Os.releasePrimitive(f),Bo.clearBuffer(),a+=s[u].length,o)break}return vu=!1,o}function Oi(n,e,t,i,s,r=0,o=0,a=0,c=0,l=null,u=!1){let h,f;u?(h=Bc,f=Bo):(h=Bo,f=Bc);const d=h.float32Array,p=h.uint32Array,m=h.uint16Array,g=f.float32Array,y=f.uint32Array,v=f.uint16Array,E=n*2,C=e*2,x=Wt(E,m),I=Wt(C,v);let S=!1;if(I&&x)u?S=s(ii(e,y),ci(e*2,v),ii(n,p),ci(n*2,m),c,o+e,a,r+n):S=s(ii(n,p),ci(n*2,m),ii(e,y),ci(e*2,v),a,r+n,c,o+e);else if(I){const w=Os.getPrimitive();ut(e,g,w),w.applyMatrix4(t);const B=Ti(n),T=li(n,p);ut(B,d,Vn),ut(T,d,Yn);const R=w.intersectsBox(Vn),_=w.intersectsBox(Yn);S=R&&Oi(e,B,i,t,s,o,r,c,a+1,w,!u)||_&&Oi(e,T,i,t,s,o,r,c,a+1,w,!u),Os.releasePrimitive(w)}else{const w=Ti(e),B=li(e,y);ut(w,g,yu),ut(B,g,Eu);const T=l.intersectsBox(yu),R=l.intersectsBox(Eu);if(T&&R)S=Oi(n,w,t,i,s,r,o,a,c+1,l,u)||Oi(n,B,t,i,s,r,o,a,c+1,l,u);else if(T)if(x)S=Oi(n,w,t,i,s,r,o,a,c+1,l,u);else{const _=Os.getPrimitive();_.copy(yu).applyMatrix4(t);const L=Ti(n),O=li(n,p);ut(L,d,Vn),ut(O,d,Yn);const U=_.intersectsBox(Vn),Q=_.intersectsBox(Yn);S=U&&Oi(w,L,i,t,s,o,r,c,a+1,_,!u)||Q&&Oi(w,O,i,t,s,o,r,c,a+1,_,!u),Os.releasePrimitive(_)}else if(R)if(x)S=Oi(n,B,t,i,s,r,o,a,c+1,l,u);else{const _=Os.getPrimitive();_.copy(Eu).applyMatrix4(t);const L=Ti(n),O=li(n,p);ut(L,d,Vn),ut(O,d,Yn);const U=_.intersectsBox(Vn),Q=_.intersectsBox(Yn);S=U&&Oi(B,L,i,t,s,o,r,c,a+1,_,!u)||Q&&Oi(B,O,i,t,s,o,r,c,a+1,_,!u),Os.releasePrimitive(_)}}return S}const La=new Xt,NA=new st,YS={strategy:a2,maxDepth:40,maxLeafTris:10,useSharedArrayBuffer:!1,setBoundingBox:!0,onProgress:null,indirect:!1,verbose:!0,range:null};class Wc{static serialize(e,t={}){t={cloneBuffers:!0,...t};const i=e.geometry,s=e._roots,r=e._indirectBuffer,o=i.getIndex();let a;return t.cloneBuffers?a={roots:s.map(c=>c.slice()),index:o?o.array.slice():null,indirectBuffer:r?r.slice():null}:a={roots:s,index:o?o.array:null,indirectBuffer:r},a}static deserialize(e,t,i={}){i={setIndex:!0,indirect:!!e.indirectBuffer,...i};const{index:s,roots:r,indirectBuffer:o}=e,a=new Wc(t,{...i,[hu]:!0});if(a._roots=r,a._indirectBuffer=o||null,i.setIndex){const c=t.getIndex();if(c===null){const l=new Ye(e.index,1,!1);t.setIndex(l)}else c.array!==s&&(c.array.set(s),c.needsUpdate=!0)}return a}get indirect(){return!!this._indirectBuffer}constructor(e,t={}){if(e.isBufferGeometry){if(e.index&&e.index.isInterleavedBufferAttribute)throw new Error("MeshBVH: InterleavedBufferAttribute is not supported for the index attribute.")}else throw new Error("MeshBVH: Only BufferGeometries are supported.");if(t=Object.assign({...YS,[hu]:!1},t),t.useSharedArrayBuffer&&!KS())throw new Error("MeshBVH: SharedArrayBuffer is not available.");this.geometry=e,this._roots=null,this._indirectBuffer=null,t[hu]||(cS(this,t),!e.boundingBox&&t.setBoundingBox&&(e.boundingBox=this.getBoundingBox(new st))),this.resolveTriangleIndex=t.indirect?i=>this._indirectBuffer[i]:i=>i}refit(e=null){return(this.indirect?PS:xS)(this,e)}traverse(e,t=0){const i=this._roots[t],s=new Uint32Array(i),r=new Uint16Array(i);o(0);function o(a,c=0){const l=a*2,u=r[l+15]===Yc;if(u){const h=s[a+6],f=r[l+14];e(c,u,new Float32Array(i,a*4,6),h,f)}else{const h=a+Ns/4,f=s[a+6],d=s[a+7];e(c,u,new Float32Array(i,a*4,6),d)||(o(h,c+1),o(f,c+1))}}}raycast(e,t=Do,i=0,s=1/0){const r=this._roots,o=this.geometry,a=[],c=t.isMaterial,l=Array.isArray(t),u=o.groups,h=c?t.side:t,f=this.indirect?FS:wS;for(let d=0,p=r.length;d<p;d++){const m=l?t[u[d].materialIndex].side:h,g=a.length;if(f(this,d,m,e,a,i,s),l){const y=u[d].materialIndex;for(let v=g,E=a.length;v<E;v++)a[v].face.materialIndex=y}}return a}raycastFirst(e,t=Do,i=0,s=1/0){const r=this._roots,o=this.geometry,a=t.isMaterial,c=Array.isArray(t);let l=null;const u=o.groups,h=a?t.side:t,f=this.indirect?OS:BS;for(let d=0,p=r.length;d<p;d++){const m=c?t[u[d].materialIndex].side:h,g=f(this,d,m,e,i,s);g!=null&&(l==null||g.distance<l.distance)&&(l=g,c&&(g.face.materialIndex=u[d].materialIndex))}return l}intersectsGeometry(e,t){let i=!1;const s=this._roots,r=this.indirect?US:_S;for(let o=0,a=s.length;o<a&&(i=r(this,o,e,t),!i);o++);return i}shapecast(e){const t=Bi.getPrimitive(),i=this.indirect?SS:vS;let{boundsTraverseOrder:s,intersectsBounds:r,intersectsRange:o,intersectsTriangle:a}=e;if(o&&a){const h=o;o=(f,d,p,m,g)=>h(f,d,p,m,g)?!0:i(f,d,this,a,p,m,t)}else o||(a?o=(h,f,d,p)=>i(h,f,this,a,d,p,t):o=(h,f,d)=>d);let c=!1,l=0;const u=this._roots;for(let h=0,f=u.length;h<f;h++){const d=u[h];if(c=AS(this,h,r,o,s,l),c)break;l+=d.byteLength}return Bi.releasePrimitive(t),c}bvhcast(e,t,i){let{intersectsRanges:s,intersectsTriangles:r}=i;const o=Bi.getPrimitive(),a=this.geometry.index,c=this.geometry.attributes.position,l=this.indirect?p=>{const m=this.resolveTriangleIndex(p);mt(o,m*3,a,c)}:p=>{mt(o,p*3,a,c)},u=Bi.getPrimitive(),h=e.geometry.index,f=e.geometry.attributes.position,d=e.indirect?p=>{const m=e.resolveTriangleIndex(p);mt(u,m*3,h,f)}:p=>{mt(u,p*3,h,f)};if(r){const p=(m,g,y,v,E,C,x,I)=>{for(let S=y,w=y+v;S<w;S++){d(S),u.a.applyMatrix4(t),u.b.applyMatrix4(t),u.c.applyMatrix4(t),u.needsUpdate=!0;for(let B=m,T=m+g;B<T;B++)if(l(B),o.needsUpdate=!0,r(o,u,B,S,E,C,x,I))return!0}return!1};if(s){const m=s;s=function(g,y,v,E,C,x,I,S){return m(g,y,v,E,C,x,I,S)?!0:p(g,y,v,E,C,x,I,S)}}else s=p}return VS(this,e,t,s)}intersectsBox(e,t){return La.set(e.min,e.max,t),La.needsUpdate=!0,this.shapecast({intersectsBounds:i=>La.intersectsBox(i),intersectsTriangle:i=>La.intersectsTriangle(i)})}intersectsSphere(e){return this.shapecast({intersectsBounds:t=>e.intersectsBox(t),intersectsTriangle:t=>t.intersectsSphere(e)})}closestPointToGeometry(e,t,i={},s={},r=0,o=1/0){return(this.indirect?HS:LS)(this,e,t,i,s,r,o)}closestPointToPoint(e,t={},i=0,s=1/0){return mS(this,e,t,i,s)}getBoundingBox(e){return e.makeEmpty(),this._roots.forEach(i=>{ut(0,new Float32Array(i),NA),e.union(NA)}),e}}function GA(n,e,t){return n===null?null:(n.point.applyMatrix4(e.matrixWorld),n.distance=n.point.distanceTo(t.ray.origin),n.object=e,n)}const zA=Vy||null,Pa=new Fo,HA=new b,KA=new ce,$S=ye.prototype.raycast,WS=zA!==null?zA.prototype.raycast:null,VA=new b,kt=new ye,Fa=[];function A2(n,e){this.isBatchedMesh?jS.call(this,n,e):JS.call(this,n,e)}function jS(n,e){if(this.boundsTrees){const t=this.boundsTrees,i=this._drawInfo,s=this._drawRanges,r=this.matrixWorld;kt.material=this.material,kt.geometry=this.geometry;const o=kt.geometry.boundsTree,a=kt.geometry.drawRange;kt.geometry.boundingSphere===null&&(kt.geometry.boundingSphere=new si);for(let c=0,l=i.length;c<l;c++){if(!this.getVisibleAt(c))continue;const u=i[c].geometryIndex;if(kt.geometry.boundsTree=t[u],this.getMatrixAt(c,kt.matrixWorld).premultiply(r),!kt.geometry.boundsTree){this.getBoundingBoxAt(u,kt.geometry.boundingBox),this.getBoundingSphereAt(u,kt.geometry.boundingSphere);const h=s[u];kt.geometry.setDrawRange(h.start,h.count)}kt.raycast(n,Fa);for(let h=0,f=Fa.length;h<f;h++){const d=Fa[h];d.object=this,d.batchId=c,e.push(d)}Fa.length=0}kt.geometry.boundsTree=o,kt.geometry.drawRange=a,kt.material=null,kt.geometry=null}else WS.call(this,n,e)}function JS(n,e){if(this.geometry.boundsTree){if(this.material===void 0)return;KA.copy(this.matrixWorld).invert(),Pa.copy(n.ray).applyMatrix4(KA),VA.setFromMatrixScale(this.matrixWorld),HA.copy(Pa.direction).multiply(VA);const t=HA.length(),i=n.near/t,s=n.far/t,r=this.geometry.boundsTree;if(n.firstHitOnly===!0){const o=GA(r.raycastFirst(Pa,this.material,i,s),this,n);o&&e.push(o)}else{const o=r.raycast(Pa,this.material,i,s);for(let a=0,c=o.length;a<c;a++){const l=GA(o[a],this,n);l&&e.push(l)}}}else $S.call(this,n,e)}function m2(n={}){return this.boundsTree=new Wc(this,n),this.boundsTree}function p2(){this.boundsTree=null}function qS(n){switch(n){case 1:return"R";case 2:return"RG";case 3:return"RGBA";case 4:return"RGBA"}throw new Error}function XS(n){switch(n){case 1:return Is;case 2:return sr;case 3:return jt;case 4:return jt}}function YA(n){switch(n){case 1:return $y;case 2:return g1;case 3:return uc;case 4:return uc}}class g2 extends ln{constructor(){super(),this.minFilter=Xe,this.magFilter=Xe,this.generateMipmaps=!1,this.overrideItemSize=null,this._forcedType=null}updateFrom(e){const t=this.overrideItemSize,i=e.itemSize,s=e.count;if(t!==null){if(i*s%t!==0)throw new Error("VertexAttributeTexture: overrideItemSize must divide evenly into buffer length.");e.itemSize=t,e.count=s*i/t}const r=e.itemSize,o=e.count,a=e.normalized,c=e.array.constructor,l=c.BYTES_PER_ELEMENT;let u=this._forcedType,h=r;if(u===null)switch(c){case Float32Array:u=Jt;break;case Uint8Array:case Uint16Array:case Uint32Array:u=cr;break;case Int8Array:case Int16Array:case Int32Array:u=tl;break}let f,d,p,m,g=qS(r);switch(u){case Jt:p=1,d=XS(r),a&&l===1?(m=c,g+="8",c===Uint8Array?f=Yt:(f=Rf,g+="_SNORM")):(m=Float32Array,g+="32F",f=Jt);break;case tl:g+=l*8+"I",p=a?Math.pow(2,c.BYTES_PER_ELEMENT*8-1):1,d=YA(r),l===1?(m=Int8Array,f=Rf):l===2?(m=Int16Array,f=Yy):(m=Int32Array,f=tl);break;case cr:g+=l*8+"UI",p=a?Math.pow(2,c.BYTES_PER_ELEMENT*8-1):1,d=YA(r),l===1?(m=Uint8Array,f=Yt):l===2?(m=Uint16Array,f=Mc):(m=Uint32Array,f=cr);break}h===3&&(d===jt||d===uc)&&(h=4);const y=Math.ceil(Math.sqrt(o))||1,v=h*y*y,E=new m(v),C=e.normalized;e.normalized=!1;for(let x=0;x<o;x++){const I=h*x;E[I]=e.getX(x)/p,r>=2&&(E[I+1]=e.getY(x)/p),r>=3&&(E[I+2]=e.getZ(x)/p,h===4&&(E[I+3]=1)),r>=4&&(E[I+3]=e.getW(x)/p)}e.normalized=C,this.internalFormat=g,this.format=d,this.type=f,this.image.width=y,this.image.height=y,this.image.data=E,this.needsUpdate=!0,this.dispose(),e.itemSize=i,e.count=s}}class ZS extends g2{constructor(){super(),this._forcedType=cr}}class ew extends g2{constructor(){super(),this._forcedType=Jt}}class y2{constructor(){this.index=new ZS,this.position=new ew,this.bvhBounds=new ln,this.bvhContents=new ln,this._cachedIndexAttr=null,this.index.overrideItemSize=3}updateFrom(e){const{geometry:t}=e;if(iw(e,this.bvhBounds,this.bvhContents),this.position.updateFrom(t.attributes.position),e.indirect){const i=e._indirectBuffer;if(this._cachedIndexAttr===null||this._cachedIndexAttr.count!==i.length)if(t.index)this._cachedIndexAttr=t.index.clone();else{const s=l2(c2(t));this._cachedIndexAttr=new Ye(s,1,!1)}tw(t,i,this._cachedIndexAttr),this.index.updateFrom(this._cachedIndexAttr)}else this.index.updateFrom(t.index)}dispose(){const{index:e,position:t,bvhBounds:i,bvhContents:s}=this;e&&e.dispose(),t&&t.dispose(),i&&i.dispose(),s&&s.dispose()}}function tw(n,e,t){const i=t.array,s=n.index?n.index.array:null;for(let r=0,o=e.length;r<o;r++){const a=3*r,c=3*e[r];for(let l=0;l<3;l++)i[a+l]=s?s[c+l]:c+l}}function iw(n,e,t){const i=n._roots;if(i.length!==1)throw new Error("MeshBVHUniformStruct: Multi-root BVHs not supported.");const s=i[0],r=new Uint16Array(s),o=new Uint32Array(s),a=new Float32Array(s),c=s.byteLength/Ns,l=2*Math.ceil(Math.sqrt(c/2)),u=new Float32Array(4*l*l),h=Math.ceil(Math.sqrt(c)),f=new Uint32Array(2*h*h);for(let d=0;d<c;d++){const p=d*Ns/4,m=p*2,g=p;for(let y=0;y<3;y++)u[8*d+0+y]=a[g+0+y],u[8*d+4+y]=a[g+3+y];if(Wt(m,r)){const y=ci(m,r),v=ii(p,o),E=4294901760|y;f[d*2+0]=E,f[d*2+1]=v}else{const y=4*li(p,o)/Ns,v=Cf(p,o);f[d*2+0]=v,f[d*2+1]=y}}e.image.data=u,e.image.width=l,e.image.height=l,e.format=jt,e.type=Jt,e.internalFormat="RGBA32F",e.minFilter=Xe,e.magFilter=Xe,e.generateMipmaps=!1,e.needsUpdate=!0,e.dispose(),t.image.data=f,t.image.width=h,t.image.height=h,t.format=g1,t.type=cr,t.internalFormat="RG32UI",t.minFilter=Xe,t.magFilter=Xe,t.generateMipmaps=!1,t.needsUpdate=!0,t.dispose()}const sw=`

// A stack of uint32 indices can can store the indices for
// a perfectly balanced tree with a depth up to 31. Lower stack
// depth gets higher performance.
//
// However not all trees are balanced. Best value to set this to
// is the trees max depth.
#ifndef BVH_STACK_DEPTH
#define BVH_STACK_DEPTH 60
#endif

#ifndef INFINITY
#define INFINITY 1e20
#endif

// Utilities
uvec4 uTexelFetch1D( usampler2D tex, uint index ) {

	uint width = uint( textureSize( tex, 0 ).x );
	uvec2 uv;
	uv.x = index % width;
	uv.y = index / width;

	return texelFetch( tex, ivec2( uv ), 0 );

}

ivec4 iTexelFetch1D( isampler2D tex, uint index ) {

	uint width = uint( textureSize( tex, 0 ).x );
	uvec2 uv;
	uv.x = index % width;
	uv.y = index / width;

	return texelFetch( tex, ivec2( uv ), 0 );

}

vec4 texelFetch1D( sampler2D tex, uint index ) {

	uint width = uint( textureSize( tex, 0 ).x );
	uvec2 uv;
	uv.x = index % width;
	uv.y = index / width;

	return texelFetch( tex, ivec2( uv ), 0 );

}

vec4 textureSampleBarycoord( sampler2D tex, vec3 barycoord, uvec3 faceIndices ) {

	return
		barycoord.x * texelFetch1D( tex, faceIndices.x ) +
		barycoord.y * texelFetch1D( tex, faceIndices.y ) +
		barycoord.z * texelFetch1D( tex, faceIndices.z );

}

void ndcToCameraRay(
	vec2 coord, mat4 cameraWorld, mat4 invProjectionMatrix,
	out vec3 rayOrigin, out vec3 rayDirection
) {

	// get camera look direction and near plane for camera clipping
	vec4 lookDirection = cameraWorld * vec4( 0.0, 0.0, - 1.0, 0.0 );
	vec4 nearVector = invProjectionMatrix * vec4( 0.0, 0.0, - 1.0, 1.0 );
	float near = abs( nearVector.z / nearVector.w );

	// get the camera direction and position from camera matrices
	vec4 origin = cameraWorld * vec4( 0.0, 0.0, 0.0, 1.0 );
	vec4 direction = invProjectionMatrix * vec4( coord, 0.5, 1.0 );
	direction /= direction.w;
	direction = cameraWorld * direction - origin;

	// slide the origin along the ray until it sits at the near clip plane position
	origin.xyz += direction.xyz * near / dot( direction, lookDirection );

	rayOrigin = origin.xyz;
	rayDirection = direction.xyz;

}
`,nw=`

#ifndef TRI_INTERSECT_EPSILON
#define TRI_INTERSECT_EPSILON 1e-5
#endif

// Raycasting
bool intersectsBounds( vec3 rayOrigin, vec3 rayDirection, vec3 boundsMin, vec3 boundsMax, out float dist ) {

	// https://www.reddit.com/r/opengl/comments/8ntzz5/fast_glsl_ray_box_intersection/
	// https://tavianator.com/2011/ray_box.html
	vec3 invDir = 1.0 / rayDirection;

	// find intersection distances for each plane
	vec3 tMinPlane = invDir * ( boundsMin - rayOrigin );
	vec3 tMaxPlane = invDir * ( boundsMax - rayOrigin );

	// get the min and max distances from each intersection
	vec3 tMinHit = min( tMaxPlane, tMinPlane );
	vec3 tMaxHit = max( tMaxPlane, tMinPlane );

	// get the furthest hit distance
	vec2 t = max( tMinHit.xx, tMinHit.yz );
	float t0 = max( t.x, t.y );

	// get the minimum hit distance
	t = min( tMaxHit.xx, tMaxHit.yz );
	float t1 = min( t.x, t.y );

	// set distance to 0.0 if the ray starts inside the box
	dist = max( t0, 0.0 );

	return t1 >= dist;

}

bool intersectsTriangle(
	vec3 rayOrigin, vec3 rayDirection, vec3 a, vec3 b, vec3 c,
	out vec3 barycoord, out vec3 norm, out float dist, out float side
) {

	// https://stackoverflow.com/questions/42740765/intersection-between-line-and-triangle-in-3d
	vec3 edge1 = b - a;
	vec3 edge2 = c - a;
	norm = cross( edge1, edge2 );

	float det = - dot( rayDirection, norm );
	float invdet = 1.0 / det;

	vec3 AO = rayOrigin - a;
	vec3 DAO = cross( AO, rayDirection );

	vec4 uvt;
	uvt.x = dot( edge2, DAO ) * invdet;
	uvt.y = - dot( edge1, DAO ) * invdet;
	uvt.z = dot( AO, norm ) * invdet;
	uvt.w = 1.0 - uvt.x - uvt.y;

	// set the hit information
	barycoord = uvt.wxy; // arranged in A, B, C order
	dist = uvt.z;
	side = sign( det );
	norm = side * normalize( norm );

	// add an epsilon to avoid misses between triangles
	uvt += vec4( TRI_INTERSECT_EPSILON );

	return all( greaterThanEqual( uvt, vec4( 0.0 ) ) );

}

bool intersectTriangles(
	// geometry info and triangle range
	sampler2D positionAttr, usampler2D indexAttr, uint offset, uint count,

	// ray
	vec3 rayOrigin, vec3 rayDirection,

	// outputs
	inout float minDistance, inout uvec4 faceIndices, inout vec3 faceNormal, inout vec3 barycoord,
	inout float side, inout float dist
) {

	bool found = false;
	vec3 localBarycoord, localNormal;
	float localDist, localSide;
	for ( uint i = offset, l = offset + count; i < l; i ++ ) {

		uvec3 indices = uTexelFetch1D( indexAttr, i ).xyz;
		vec3 a = texelFetch1D( positionAttr, indices.x ).rgb;
		vec3 b = texelFetch1D( positionAttr, indices.y ).rgb;
		vec3 c = texelFetch1D( positionAttr, indices.z ).rgb;

		if (
			intersectsTriangle( rayOrigin, rayDirection, a, b, c, localBarycoord, localNormal, localDist, localSide )
			&& localDist < minDistance
		) {

			found = true;
			minDistance = localDist;

			faceIndices = uvec4( indices.xyz, i );
			faceNormal = localNormal;

			side = localSide;
			barycoord = localBarycoord;
			dist = localDist;

		}

	}

	return found;

}

bool intersectsBVHNodeBounds( vec3 rayOrigin, vec3 rayDirection, sampler2D bvhBounds, uint currNodeIndex, out float dist ) {

	uint cni2 = currNodeIndex * 2u;
	vec3 boundsMin = texelFetch1D( bvhBounds, cni2 ).xyz;
	vec3 boundsMax = texelFetch1D( bvhBounds, cni2 + 1u ).xyz;
	return intersectsBounds( rayOrigin, rayDirection, boundsMin, boundsMax, dist );

}

// use a macro to hide the fact that we need to expand the struct into separate fields
#define	bvhIntersectFirstHit(		bvh,		rayOrigin, rayDirection, faceIndices, faceNormal, barycoord, side, dist	)	_bvhIntersectFirstHit(		bvh.position, bvh.index, bvh.bvhBounds, bvh.bvhContents,		rayOrigin, rayDirection, faceIndices, faceNormal, barycoord, side, dist	)

bool _bvhIntersectFirstHit(
	// bvh info
	sampler2D bvh_position, usampler2D bvh_index, sampler2D bvh_bvhBounds, usampler2D bvh_bvhContents,

	// ray
	vec3 rayOrigin, vec3 rayDirection,

	// output variables split into separate variables due to output precision
	inout uvec4 faceIndices, inout vec3 faceNormal, inout vec3 barycoord,
	inout float side, inout float dist
) {

	// stack needs to be twice as long as the deepest tree we expect because
	// we push both the left and right child onto the stack every traversal
	int ptr = 0;
	uint stack[ BVH_STACK_DEPTH ];
	stack[ 0 ] = 0u;

	float triangleDistance = INFINITY;
	bool found = false;
	while ( ptr > - 1 && ptr < BVH_STACK_DEPTH ) {

		uint currNodeIndex = stack[ ptr ];
		ptr --;

		// check if we intersect the current bounds
		float boundsHitDistance;
		if (
			! intersectsBVHNodeBounds( rayOrigin, rayDirection, bvh_bvhBounds, currNodeIndex, boundsHitDistance )
			|| boundsHitDistance > triangleDistance
		) {

			continue;

		}

		uvec2 boundsInfo = uTexelFetch1D( bvh_bvhContents, currNodeIndex ).xy;
		bool isLeaf = bool( boundsInfo.x & 0xffff0000u );

		if ( isLeaf ) {

			uint count = boundsInfo.x & 0x0000ffffu;
			uint offset = boundsInfo.y;

			found = intersectTriangles(
				bvh_position, bvh_index, offset, count,
				rayOrigin, rayDirection, triangleDistance,
				faceIndices, faceNormal, barycoord, side, dist
			) || found;

		} else {

			uint leftIndex = currNodeIndex + 1u;
			uint splitAxis = boundsInfo.x & 0x0000ffffu;
			uint rightIndex = boundsInfo.y;

			bool leftToRight = rayDirection[ splitAxis ] >= 0.0;
			uint c1 = leftToRight ? leftIndex : rightIndex;
			uint c2 = leftToRight ? rightIndex : leftIndex;

			// set c2 in the stack so we traverse it later. We need to keep track of a pointer in
			// the stack while we traverse. The second pointer added is the one that will be
			// traversed first
			ptr ++;
			stack[ ptr ] = c2;

			ptr ++;
			stack[ ptr ] = c1;

		}

	}

	return found;

}
`,rw=`
struct BVH {

	usampler2D index;
	sampler2D position;

	sampler2D bvhBounds;
	usampler2D bvhContents;

};
`,ow=rw,aw=`
	${sw}
	${nw}
`,$A=n=>n.isMesh;function c7(n,e){e={strategy:Vc,verbose:!1,setBoundingBox:!0,maxDepth:40,maxLeafTris:10,indirect:!1,...e},A.useEffect(()=>{if(n.current){n.current.raycast=A2;const t=n.current.geometry;return t.computeBoundsTree=m2,t.disposeBoundsTree=p2,t.computeBoundsTree(e),()=>{t.boundsTree&&t.disposeBoundsTree()}}},[n,JSON.stringify(e)])}const l7=A.forwardRef(({enabled:n=!0,firstHitOnly:e=!1,children:t,strategy:i=Vc,verbose:s=!1,setBoundingBox:r=!0,maxDepth:o=40,maxLeafTris:a=10,indirect:c=!1,...l},u)=>{const h=A.useRef(null),f=Z(d=>d.raycaster);return A.useImperativeHandle(u,()=>h.current,[]),A.useEffect(()=>{if(n){const d={strategy:i,verbose:s,setBoundingBox:r,maxDepth:o,maxLeafTris:a,indirect:c},p=h.current;return f.firstHitOnly=e,p.traverse(m=>{$A(m)&&!m.geometry.boundsTree&&m.raycast===ye.prototype.raycast&&(m.raycast=A2,m.geometry.computeBoundsTree=m2,m.geometry.disposeBoundsTree=p2,m.geometry.computeBoundsTree(d))}),()=>{delete f.firstHitOnly,p.traverse(m=>{$A(m)&&m.geometry.boundsTree&&(m.geometry.disposeBoundsTree(),m.raycast=ye.prototype.raycast)})}}},[]),A.createElement("group",ie({ref:h},l),t)});function u7(...n){const e=A.useRef([]);return e.current=n.map(t=>A.useContext(t)),A.useMemo(()=>({children:t})=>n.reduceRight((i,s,r)=>A.createElement(s.Provider,{value:e.current[r],children:i}),t),[])}function h7(n,e){const t=A.useRef(),[i]=A.useState(()=>e?e instanceof lt?{current:e}:e:t),[s]=A.useState(()=>new qm(void 0));A.useLayoutEffect(()=>{e&&(i.current=e instanceof lt?e:e.current),s._root=i.current});const r=A.useRef({}),o=A.useMemo(()=>{const a={};return n.forEach(c=>Object.defineProperty(a,c.name,{enumerable:!0,get(){if(i.current)return r.current[c.name]||(r.current[c.name]=s.clipAction(c,i.current))},configurable:!0})),{ref:i,clips:n,actions:a,names:n.map(c=>c.name),mixer:s}},[n]);return Ee((a,c)=>s.update(c)),A.useEffect(()=>{const a=i.current;return()=>{r.current={},s.stopAllAction(),Object.values(o.actions).forEach(c=>{a&&s.uncacheAction(c,a)})}},[n]),o}function cw(n){const e=A.useRef(null),t=A.useRef(!1),i=A.useRef(!1),s=A.useRef(n);return A.useLayoutEffect(()=>void(s.current=n),[n]),A.useEffect(()=>{const r=e.current;if(r){const o=m1(()=>(t.current=!1,!0)),a=r.onBeforeRender;r.onBeforeRender=()=>t.current=!0;const c=Oh(()=>(t.current!==i.current&&(s.current==null||s.current(i.current=t.current)),!0));return()=>{r.onBeforeRender=a,o(),c()}}},[]),e}const lw=`
#if defined( USE_ENVMAP ) || defined( DISTANCE ) || defined ( USE_SHADOWMAP )
  vec4 worldPosition = modelMatrix * vec4( transformed, 1.0 );
  #ifdef BOX_PROJECTED_ENV_MAP
    vWorldPosition = worldPosition.xyz;
  #endif
#endif
`,uw=`
#ifdef BOX_PROJECTED_ENV_MAP
  uniform vec3 envMapSize;
  uniform vec3 envMapPosition;
  varying vec3 vWorldPosition;
    
  vec3 parallaxCorrectNormal( vec3 v, vec3 cubeSize, vec3 cubePos ) {
    vec3 nDir = normalize( v );
    vec3 rbmax = ( .5 * cubeSize + cubePos - vWorldPosition ) / nDir;
    vec3 rbmin = ( -.5 * cubeSize + cubePos - vWorldPosition ) / nDir;
    vec3 rbminmax;
    rbminmax.x = ( nDir.x > 0. ) ? rbmax.x : rbmin.x;
    rbminmax.y = ( nDir.y > 0. ) ? rbmax.y : rbmin.y;
    rbminmax.z = ( nDir.z > 0. ) ? rbmax.z : rbmin.z;
    float correction = min( min( rbminmax.x, rbminmax.y ), rbminmax.z );
    vec3 boxIntersection = vWorldPosition + nDir * correction;    
    return boxIntersection - cubePos;
  }
#endif
`,hw=`
#ifdef BOX_PROJECTED_ENV_MAP
  worldNormal = parallaxCorrectNormal( worldNormal, envMapSize, envMapPosition );
#endif
`,fw=`
#ifdef BOX_PROJECTED_ENV_MAP
  reflectVec = parallaxCorrectNormal( reflectVec, envMapSize, envMapPosition );
#endif
`;function dw(n,e,t){n.defines.BOX_PROJECTED_ENV_MAP=!0,n.uniforms.envMapPosition={value:e},n.uniforms.envMapSize={value:t},n.vertexShader=`
  varying vec3 vWorldPosition;
  ${n.vertexShader.replace("#include <worldpos_vertex>",lw)}`,n.fragmentShader=`
    ${uw}
    ${n.fragmentShader.replace("#include <envmap_physical_pars_fragment>",mo.envmap_physical_pars_fragment).replace("vec3 worldNormal = inverseTransformDirection( normal, viewMatrix );",`vec3 worldNormal = inverseTransformDirection( normal, viewMatrix );
         ${hw}
         `).replace("reflectVec = inverseTransformDirection( reflectVec, viewMatrix );",`reflectVec = inverseTransformDirection( reflectVec, viewMatrix );
         ${fw}
        `)}`}function f7(n=new b,e=new b){const[t]=A.useState(()=>({position:new b,size:new b}));Ss(t,{position:n,size:e});const i=A.useRef(null),s=A.useMemo(()=>({ref:i,onBeforeCompile:r=>dw(r,t.position,t.size),customProgramCacheKey:()=>JSON.stringify(t.position.toArray())+JSON.stringify(t.size.toArray())}),[...t.position.toArray(),...t.size.toArray()]);return A.useLayoutEffect(()=>void(i.current.needsUpdate=!0),[t]),s}const WA=new st,ka=new b,d7=({anchor:n,...e})=>{const t=A.useRef(null),i=A.useRef(null);return A.useEffect(()=>{var s;(s=t.current)!=null&&(s=s.parent)!=null&&s.parent&&(i.current=t.current.parent,t.current.parent.parent.add(t.current))},[]),Ee(()=>{i.current&&(WA.setFromObject(i.current),WA.getSize(ka),t.current.position.set(i.current.position.x+ka.x*(Array.isArray(n)?n[0]:n.x)/2,i.current.position.y+ka.y*(Array.isArray(n)?n[1]:n.y)/2,i.current.position.z+ka.z*(Array.isArray(n)?n[2]:n.z)/2))}),A.createElement("group",ie({ref:t},e))};function Aw(n,e,t=.9){return e*t+n*(1-t)}const mw=n=>Math.sqrt(1-Math.pow(n-1,2));class pw{constructor({size:e=256,maxAge:t=750,radius:i=.3,intensity:s=.2,interpolate:r=0,smoothing:o=0,minForce:a=.3,blend:c="screen",ease:l=mw}={}){this.size=e,this.maxAge=t,this.radius=i,this.intensity=s,this.ease=l,this.interpolate=r,this.smoothing=o,this.minForce=a,this.blend=c,this.trail=[],this.force=0,this.initTexture()}initTexture(){this.canvas=document.createElement("canvas"),this.canvas.width=this.canvas.height=this.size;const e=this.canvas.getContext("2d");if(e===null)throw new Error("2D not available");this.ctx=e,this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.texture=new as(this.canvas),this.canvas.id="touchTexture",this.canvas.style.width=this.canvas.style.height=`${this.canvas.width}px`}update(e){this.clear(),this.trail.forEach((t,i)=>{t.age+=e*1e3,t.age>this.maxAge&&this.trail.splice(i,1)}),this.trail.length||(this.force=0),this.trail.forEach(t=>{this.drawTouch(t)}),this.texture.needsUpdate=!0}clear(){this.ctx.globalCompositeOperation="source-over",this.ctx.fillStyle="black",this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}addTouch(e){const t=this.trail[this.trail.length-1];if(t){const i=t.x-e.x,s=t.y-e.y,r=i*i+s*s,o=Math.max(this.minForce,Math.min(r*1e4,1));if(this.force=Aw(o,this.force,this.smoothing),this.interpolate){const a=Math.ceil(r/Math.pow(this.radius*.5/this.interpolate,2));if(a>1)for(let c=1;c<a;c++)this.trail.push({x:t.x-i/a*c,y:t.y-s/a*c,age:0,force:o})}}this.trail.push({x:e.x,y:e.y,age:0,force:this.force})}drawTouch(e){const t={x:e.x*this.size,y:(1-e.y)*this.size};let i=1;e.age<this.maxAge*.3?i=this.ease(e.age/(this.maxAge*.3)):i=this.ease(1-(e.age-this.maxAge*.3)/(this.maxAge*.7)),i*=e.force,this.ctx.globalCompositeOperation=this.blend;const s=this.size*this.radius*i,r=this.ctx.createRadialGradient(t.x,t.y,Math.max(0,s*.25),t.x,t.y,Math.max(0,s));r.addColorStop(0,`rgba(255, 255, 255, ${this.intensity})`),r.addColorStop(1,"rgba(0, 0, 0, 0.0)"),this.ctx.beginPath(),this.ctx.fillStyle=r,this.ctx.arc(t.x,t.y,Math.max(0,s),0,Math.PI*2),this.ctx.fill()}}function gw(n={}){const{size:e,maxAge:t,radius:i,intensity:s,interpolate:r,smoothing:o,minForce:a,blend:c,ease:l}=n,u=A.useMemo(()=>new pw(n),[e,t,i,s,r,o,a,c,l]);Ee((f,d)=>void u.update(d));const h=A.useCallback(f=>u.addTouch(f.uv),[u]);return[u.texture,h]}const A7=({children:n,...e})=>{const t=gw(e);return A.createElement(A.Fragment,null,n==null?void 0:n(t))},E2=A.forwardRef(function({children:e,disable:t,disableX:i,disableY:s,disableZ:r,left:o,right:a,top:c,bottom:l,front:u,back:h,onCentered:f,precise:d=!0,cacheKey:p=0,...m},g){const y=A.useRef(null),v=A.useRef(null),E=A.useRef(null);return A.useLayoutEffect(()=>{v.current.matrixWorld.identity();const C=new st().setFromObject(E.current,d),x=new b,I=new si,S=C.max.x-C.min.x,w=C.max.y-C.min.y,B=C.max.z-C.min.z;C.getCenter(x),C.getBoundingSphere(I);const T=c?w/2:l?-w/2:0,R=o?-S/2:a?S/2:0,_=u?B/2:h?-B/2:0;v.current.position.set(t||i?0:-x.x+R,t||s?0:-x.y+T,t||r?0:-x.z+_),typeof f<"u"&&f({parent:y.current.parent,container:y.current,width:S,height:w,depth:B,boundingBox:C,boundingSphere:I,center:x,verticalAlignment:T,horizontalAlignment:R,depthAlignment:_})},[p,f,c,o,u,t,i,s,r,d,a,l,h]),A.useImperativeHandle(g,()=>y.current,[]),A.createElement("group",ie({ref:y},m),A.createElement("group",{ref:v},A.createElement("group",{ref:E},e)))}),m7=A.forwardRef(({font:n,color:e="#cbcbcb",bevelSize:t=.04,debug:i=!1,children:s,...r},o)=>{const[a,c]=A.useState(0),l=A.useCallback((f=1)=>c(a+f),[a]),u=A.useCallback((f=1)=>c(a-f),[a]),h=A.useMemo(()=>({incr:l,decr:u}),[l,u]);return A.useImperativeHandle(o,()=>h,[h]),A.createElement("group",r,A.createElement(A.Suspense,{fallback:null},A.createElement(E2,{top:!0,cacheKey:JSON.stringify({counter:a,font:n})},A.createElement(PC,{bevelEnabled:!0,bevelSize:t,font:n},i?A.createElement("meshNormalMaterial",{wireframe:!0}):A.createElement("meshStandardMaterial",{color:e}),a))),s)});var v2={exports:{}},yw="SECRET_DO_NOT_PASS_THIS_OR_YOU_WILL_BE_FIRED",Ew=yw,vw=Ew;function x2(){}function C2(){}C2.resetWarningCache=x2;var xw=function(){function n(i,s,r,o,a,c){if(c!==vw){var l=new Error("Calling PropTypes validators directly is not supported by the `prop-types` package. Use PropTypes.checkPropTypes() to call them. Read more at http://fb.me/use-check-prop-types");throw l.name="Invariant Violation",l}}n.isRequired=n;function e(){return n}var t={array:n,bigint:n,bool:n,func:n,number:n,object:n,string:n,symbol:n,any:n,arrayOf:e,element:n,elementType:n,instanceOf:e,node:n,objectOf:e,oneOf:e,oneOfType:e,shape:e,exact:e,checkPropTypes:C2,resetWarningCache:x2};return t.PropTypes=t,t};v2.exports=xw();var Cw=v2.exports;const oo=kh(Cw);function I2(n){return S2(n.children,n.components)}I2.propTypes={children:oo.func.isRequired,components:oo.arrayOf(oo.oneOfType([oo.element,oo.func])).isRequired};function S2(n,e,t){if(t=t||[],!e[0])return n(t);function i(s){return S2(n,e.slice(1),t.concat([s]))}return typeof e[0]=="function"?e[0]({results:t,render:i}):A.cloneElement(e[0],{children:i})}function Iw(n){return typeof n=="function"}const jA=new ce,JA=new ce,Oa=[],ao=new ye;class Sw extends ws{constructor(){super(),this.color=new xe("white"),this.instance={current:void 0},this.instanceKey={current:void 0}}get geometry(){var e;return(e=this.instance.current)==null?void 0:e.geometry}raycast(e,t){const i=this.instance.current;if(!i||!i.geometry||!i.material)return;ao.geometry=i.geometry;const s=i.matrixWorld,r=i.userData.instances.indexOf(this.instanceKey);if(!(r===-1||r>i.count)){i.getMatrixAt(r,jA),JA.multiplyMatrices(s,jA),ao.matrixWorld=JA,i.material instanceof $a?ao.material.side=i.material.side:ao.material.side=i.material[0].side,ao.raycast(e,Oa);for(let o=0,a=Oa.length;o<a;o++){const c=Oa[o];c.instanceId=r,c.object=this,t.push(c)}Oa.length=0}}}const w2=A.createContext(null),qA=new ce,XA=new ce,ww=new ce,ZA=new b,em=new Be,tm=new b,Tw=n=>n.isInstancedBufferAttribute,wf=A.forwardRef(({context:n,children:e,...t},i)=>{A.useMemo(()=>dt({PositionMesh:Sw}),[]);const s=A.useRef();A.useImperativeHandle(i,()=>s.current,[]);const{subscribe:r,getParent:o}=A.useContext(n||w2);return A.useLayoutEffect(()=>r(s),[]),A.createElement("positionMesh",ie({instance:o(),instanceKey:s,ref:s},t),e)}),Tf=A.forwardRef(({context:n,children:e,range:t,limit:i=1e3,frames:s=1/0,...r},o)=>{const[{localContext:a,instance:c}]=A.useState(()=>{const v=A.createContext(null);return{localContext:v,instance:A.forwardRef((E,C)=>A.createElement(wf,ie({context:v},E,{ref:C})))}}),l=A.useRef(null);A.useImperativeHandle(o,()=>l.current,[]);const[u,h]=A.useState([]),[[f,d]]=A.useState(()=>{const v=new Float32Array(i*16);for(let E=0;E<i;E++)ww.identity().toArray(v,E*16);return[v,new Float32Array([...new Array(i*3)].map(()=>1))]});A.useEffect(()=>{l.current.instanceMatrix.needsUpdate=!0});let p=0,m=0;const g=A.useRef([]);A.useLayoutEffect(()=>{g.current=Object.entries(l.current.geometry.attributes).filter(([v,E])=>Tw(E))}),Ee(()=>{if(s===1/0||p<s){l.current.updateMatrix(),l.current.updateMatrixWorld(),qA.copy(l.current.matrixWorld).invert(),m=Math.min(i,t!==void 0?t:i,u.length),l.current.count=m,xo(l.current.instanceMatrix,{offset:0,count:m*16}),xo(l.current.instanceColor,{offset:0,count:m*3});for(let v=0;v<u.length;v++){const E=u[v].current;E.matrixWorld.decompose(ZA,em,tm),XA.compose(ZA,em,tm).premultiply(qA),XA.toArray(f,v*16),l.current.instanceMatrix.needsUpdate=!0,E.color.toArray(d,v*3),l.current.instanceColor.needsUpdate=!0}p++}});const y=A.useMemo(()=>({getParent:()=>l,subscribe:v=>(h(E=>[...E,v]),()=>h(E=>E.filter(C=>C.current!==v.current)))}),[]);return A.createElement("instancedMesh",ie({userData:{instances:u,limit:i,frames:s},matrixAutoUpdate:!1,ref:l,args:[null,null,0],raycast:()=>null},r),A.createElement("instancedBufferAttribute",{attach:"instanceMatrix",count:f.length/16,array:f,itemSize:16,usage:Gt}),A.createElement("instancedBufferAttribute",{attach:"instanceColor",count:d.length/3,array:d,itemSize:3,usage:Gt}),Iw(e)?A.createElement(a.Provider,{value:y},e(c)):n?A.createElement(n.Provider,{value:y},e):A.createElement(w2.Provider,{value:y},e))}),p7=A.forwardRef(function({meshes:e,children:t,...i},s){const r=Array.isArray(e);if(!r)for(const o of Object.keys(e))e[o].isMesh||delete e[o];return A.createElement("group",{ref:s},A.createElement(I2,{components:(r?e:Object.values(e)).map(({geometry:o,material:a})=>A.createElement(Tf,ie({key:o.uuid,geometry:o,material:a},i)))},o=>r?t(...o):t(Object.keys(e).filter(a=>e[a].isMesh).reduce((a,c,l)=>({...a,[c]:o[l]}),{}))))});function g7(){const n=A.createContext(null);return[A.forwardRef((e,t)=>A.createElement(Tf,ie({ref:t,context:n},e))),A.forwardRef((e,t)=>A.createElement(wf,ie({ref:t,context:n},e)))]}const y7=A.forwardRef(({name:n,defaultValue:e,normalized:t,usage:i=Gt},s)=>{const r=A.useRef(null);A.useImperativeHandle(s,()=>r.current,[]),A.useLayoutEffect(()=>{const a=r.current.__r3f.parent;a.geometry.attributes[n]=r.current;const c=Array.isArray(e)?e:[e],l=Array.from({length:a.userData.limit},()=>c).flat();return r.current.array=new Float32Array(l),r.current.itemSize=c.length,r.current.count=l.length/r.current.itemSize,()=>{delete a.geometry.attributes[n]}},[n]);let o=0;return Ee(()=>{const a=r.current.__r3f.parent;if(a.userData.frames===1/0||o<a.userData.frames){for(let c=0;c<a.userData.instances.length;c++){const u=a.userData.instances[c].current[n];u!==void 0&&(r.current.set(Array.isArray(u)?u:typeof u.toArray=="function"?u.toArray():[u],c*r.current.itemSize),r.current.needsUpdate=!0)}o++}}),A.createElement("instancedBufferAttribute",{ref:r,usage:i,normalized:t})}),T2=A.createContext(null);function E7(){return A.useContext(T2)}function Bw(n){return n!==null&&"meta"in n&&"frames"in n}const im=new Ji(1,1),v7=A.forwardRef(({startFrame:n=0,endFrame:e,fps:t=30,frameName:i="",textureDataURL:s,textureImageURL:r,loop:o=!1,numberOfFrames:a=1,autoPlay:c=!0,animationNames:l,onStart:u,onEnd:h,onLoopEnd:f,onFrame:d,play:p,pause:m=!1,flipX:g=!1,alphaTest:y=0,children:v,asSprite:E=!1,offset:C,playBackwards:x=!1,resetOnEnd:I=!1,maxItems:S=1,instanceItems:w=[[0,0,0]],spriteDataset:B,canvasRenderingContext2DSettings:T,roundFramePosition:R=!1,meshProps:_={},...L},O)=>{const U=A.useRef(new ws),Q=A.useRef(null),G=A.useRef(null),z=A.useRef(null),H=A.useRef(window.performance.now()),N=A.useRef(n),V=A.useRef(i),$=t>0?1e3/t:0,[Y,M]=A.useState(new as),k=A.useRef(0),[P,F]=A.useState(new b(1,1,1)),J=g?-1:1,se=A.useRef(m),q=A.useRef(C),re=A.useRef(!1),{spriteObj:he,loadJsonAndTexture:fe}=xf(null,null,l,a,void 0,T),ae=A.useRef(i),ue=A.useCallback((Se,be)=>{if(be===null)a&&(k.current=a,x&&(N.current=a-1),Q.current=be);else{var De,Ne;Q.current=be,Q.current&&Array.isArray(Q.current.frames)?k.current=Q.current.frames.length:Q.current&&typeof Q.current=="object"&&ae.current?k.current=Q.current.frames[ae.current].length:k.current=0,x&&(N.current=k.current-1);const{w:ot,h:Je}=rc((De=(Ne=Q.current)==null?void 0:Ne.frames)!==null&&De!==void 0?De:[],ae.current).sourceSize,Ht=W(ot,Je);F(Ht),G.current&&(G.current.map=Se)}M(Se)},[a,x]),ge=A.useCallback(()=>{if(!Q.current)return;const{meta:{size:Se},frames:be}=Q.current,{w:De,h:Ne}=Array.isArray(be)?be[0].sourceSize:i?be[i]?be[i][0].sourceSize:{w:0,h:0}:{w:0,h:0};G.current&&G.current.map&&(G.current.map.wrapS=G.current.map.wrapT=ui,G.current.map.center.set(0,0),G.current.map.repeat.set(1*J/(Se.w/De),1/(Se.h/Ne)));const Je=1/((Se.h-1)/Ne);G.current&&G.current.map&&(G.current.map.offset.x=0,G.current.map.offset.y=1-Je),u&&u({currentFrameName:i??"",currentFrame:N.current})},[J,i,u]),me=A.useMemo(()=>({current:q.current,offset:q.current,imageUrl:r,hasEnded:!1,ref:O}),[r,O]);A.useImperativeHandle(O,()=>U.current,[]),A.useLayoutEffect(()=>{q.current=C},[C]);const W=(Se,be)=>{var De;const Ne=new b,ot=be/Se;return Ne.set(1,ot,1),(De=z.current)==null||De.scale.copy(Ne),Ne};A.useEffect(()=>{if(B){var Se;ue(B==null||(Se=B.spriteTexture)==null?void 0:Se.clone(),B.spriteData)}else r&&s&&fe(r,s)},[fe,B,s,r,ue]),A.useEffect(()=>{if(he){var Se;ue(he==null||(Se=he.spriteTexture)==null?void 0:Se.clone(),he==null?void 0:he.spriteData)}},[he,ue]),A.useEffect(()=>{if(me.hasEnded=!1,Q.current&&x===!0){var Se;N.current=((Se=Q.current.frames.length)!==null&&Se!==void 0?Se:0)-1}else N.current=0},[x,me]),A.useLayoutEffect(()=>{ge()},[Y,g,ge]),A.useEffect(()=>{c&&(se.current=!1)},[c]),A.useLayoutEffect(()=>{if(V.current!==i&&i&&(N.current=0,V.current=i,me.hasEnded=!1,$<=0&&(N.current=e||n||0),Q.current)){const{w:Se,h:be}=rc(Q.current.frames,i).sourceSize,De=W(Se,be);F(De)}},[i,$,me,e,n]);const K=()=>{if(!Bw(Q.current))return;const{meta:{size:Se},frames:be}=Q.current,{w:De,h:Ne}=rc(be,i).sourceSize,ot=Array.isArray(be)?be:i?be[i]:[],Je=e||ot.length-1;var Ht=C===void 0?me.current:C;if($<=0){N.current=e||n||0,pe(De,Ne,Se,ot);return}const Kt=window.performance.now(),Qt=Kt-H.current;if(!(Qt<=$)){var hi=x?N.current<0:N.current>Je,ni=x?N.current===Je:N.current===0,Ks=x?N.current<0:N.current>=Je;if(hi){if(N.current=o?n??0:0,x&&(N.current=Je),o?f==null||f({currentFrameName:i??"",currentFrame:N.current}):(h==null||h({currentFrameName:i??"",currentFrame:N.current}),me.hasEnded=!I,I&&(se.current=!0)),!o)return}else ni&&(u==null||u({currentFrameName:i??"",currentFrame:N.current}));Ht!==void 0&&Ks?re.current===!1&&(h==null||h({currentFrameName:i??"",currentFrame:N.current}),re.current=!0):re.current=!1,!(Qt<=$)&&(H.current=Kt-Qt%$,pe(De,Ne,Se,ot))}},pe=(Se,be,De,Ne)=>{var ot=C===void 0?me.current:C;const Je=N.current;let Ht=0,Kt=0;W(Se,be);const Qt=R?Math.round((De.w-1)/Se):(De.w-1)/Se,hi=R?Math.round((De.h-1)/be):(De.h-1)/be;if(!Ne[Je])return;const{frame:{x:ni,y:Ks},sourceSize:{w:gn,h:Jc}}=Ne[Je],Go=1/Qt,zo=1/hi;if(G.current&&G.current.map&&(Ht=J>0?Go*(ni/gn):Go*(ni/gn)-G.current.map.repeat.x,Kt=Math.abs(1-zo)-zo*(Ks/Jc),G.current.map.offset.x=Ht,G.current.map.offset.y=Kt),ot!=null){let Di=Math.floor(ot*Ne.length);Di=Math.max(0,Math.min(Di,Ne.length-1)),isNaN(Di)&&(Di=0),N.current=Di}else x?N.current-=1:N.current+=1};Ee((Se,be)=>{var De,Ne;!((De=Q.current)!=null&&De.frames)||!((Ne=G.current)!=null&&Ne.map)||se.current||!me.hasEnded&&(c||p)&&(K(),d==null||d({currentFrameName:V.current,currentFrame:N.current}))});function Fe(Se=new b(1,1,1),be=1){if(typeof be=="number")return Se.multiplyScalar(be);if(Array.isArray(be))return Se.multiply(new b(...be));if(be instanceof b)return Se.multiply(be)}return A.createElement("group",ie({},L,{ref:U,scale:Fe(P,L.scale)}),A.createElement(T2.Provider,{value:me},E&&A.createElement(CC,null,A.createElement("mesh",ie({ref:z,scale:1,geometry:im},_),A.createElement("meshBasicMaterial",{premultipliedAlpha:!1,toneMapped:!1,side:Tt,ref:G,map:Y,transparent:!0,alphaTest:y??0}))),!E&&A.createElement(Tf,ie({geometry:im,limit:S??1},_),A.createElement("meshBasicMaterial",{premultipliedAlpha:!1,toneMapped:!1,side:Tt,ref:G,map:Y,transparent:!0,alphaTest:y??0}),(w??[0]).map((Se,be)=>A.createElement(wf,ie({key:be,ref:(w==null?void 0:w.length)===1?z:null,position:Se,scale:1},_)))),v))}),x7=A.forwardRef(({children:n,curve:e},t)=>{const[i]=A.useState(()=>new Sr),[s,r]=A.useState(),o=A.useRef();return A.useEffect(()=>{o.current=new Ov(i.children[0]),r(o.current.object3D)},[n]),A.useEffect(()=>{var a;e&&((a=o.current)==null||a.updateCurve(0,e))},[e]),A.useImperativeHandle(t,()=>({moveAlongCurve:a=>{var c;(c=o.current)==null||c.moveAlongCurve(a)}})),A.createElement(A.Fragment,null,Ir(n,i),s&&A.createElement("primitive",{object:s}))});var _w=`#define GLSLIFY 1
vec3 mod289(vec3 x){return x-floor(x*(1.0/289.0))*289.0;}vec4 mod289(vec4 x){return x-floor(x*(1.0/289.0))*289.0;}vec4 permute(vec4 x){return mod289(((x*34.0)+1.0)*x);}vec4 taylorInvSqrt(vec4 r){return 1.79284291400159-0.85373472095314*r;}float snoise(vec3 v){const vec2 C=vec2(1.0/6.0,1.0/3.0);const vec4 D=vec4(0.0,0.5,1.0,2.0);vec3 i=floor(v+dot(v,C.yyy));vec3 x0=v-i+dot(i,C.xxx);vec3 g=step(x0.yzx,x0.xyz);vec3 l=1.0-g;vec3 i1=min(g.xyz,l.zxy);vec3 i2=max(g.xyz,l.zxy);vec3 x1=x0-i1+C.xxx;vec3 x2=x0-i2+C.yyy;vec3 x3=x0-D.yyy;i=mod289(i);vec4 p=permute(permute(permute(i.z+vec4(0.0,i1.z,i2.z,1.0))+i.y+vec4(0.0,i1.y,i2.y,1.0))+i.x+vec4(0.0,i1.x,i2.x,1.0));float n_=0.142857142857;vec3 ns=n_*D.wyz-D.xzx;vec4 j=p-49.0*floor(p*ns.z*ns.z);vec4 x_=floor(j*ns.z);vec4 y_=floor(j-7.0*x_);vec4 x=x_*ns.x+ns.yyyy;vec4 y=y_*ns.x+ns.yyyy;vec4 h=1.0-abs(x)-abs(y);vec4 b0=vec4(x.xy,y.xy);vec4 b1=vec4(x.zw,y.zw);vec4 s0=floor(b0)*2.0+1.0;vec4 s1=floor(b1)*2.0+1.0;vec4 sh=-step(h,vec4(0.0));vec4 a0=b0.xzyw+s0.xzyw*sh.xxyy;vec4 a1=b1.xzyw+s1.xzyw*sh.zzww;vec3 p0=vec3(a0.xy,h.x);vec3 p1=vec3(a0.zw,h.y);vec3 p2=vec3(a1.xy,h.z);vec3 p3=vec3(a1.zw,h.w);vec4 norm=taylorInvSqrt(vec4(dot(p0,p0),dot(p1,p1),dot(p2,p2),dot(p3,p3)));p0*=norm.x;p1*=norm.y;p2*=norm.z;p3*=norm.w;vec4 m=max(0.6-vec4(dot(x0,x0),dot(x1,x1),dot(x2,x2),dot(x3,x3)),0.0);m=m*m;return 42.0*dot(m*m,vec4(dot(p0,x0),dot(p1,x1),dot(p2,x2),dot(p3,x3)));}`;class bw extends bi{constructor(e={}){super(e),this.setValues(e),this._time={value:0},this._distort={value:.4},this._radius={value:1}}onBeforeCompile(e){e.uniforms.time=this._time,e.uniforms.radius=this._radius,e.uniforms.distort=this._distort,e.vertexShader=`
      uniform float time;
      uniform float radius;
      uniform float distort;
      ${_w}
      ${e.vertexShader}
    `,e.vertexShader=e.vertexShader.replace("#include <begin_vertex>",`
        float updateTime = time / 50.0;
        float noise = snoise(vec3(position / 2.0 + updateTime * 5.0));
        vec3 transformed = vec3(position * (noise * pow(distort, 2.0) + radius));
        `)}get time(){return this._time.value}set time(e){this._time.value=e}get distort(){return this._distort.value}set distort(e){this._distort.value=e}get radius(){return this._radius.value}set radius(e){this._radius.value=e}}const C7=A.forwardRef(({speed:n=1,...e},t)=>{const[i]=A.useState(()=>new bw);return Ee(s=>i&&(i.time=s.clock.getElapsedTime()*n)),A.createElement("primitive",ie({object:i,ref:t,attach:"material"},e))});class Rw extends Rc{constructor(e={}){super(e),this.setValues(e),this._time={value:0},this._factor={value:1}}onBeforeCompile(e){e.uniforms.time=this._time,e.uniforms.factor=this._factor,e.vertexShader=`
      uniform float time;
      uniform float factor;
      ${e.vertexShader}
    `,e.vertexShader=e.vertexShader.replace("#include <begin_vertex>",`float theta = sin( time + position.y ) / 2.0 * factor;
        float c = cos( theta );
        float s = sin( theta );
        mat3 m = mat3( c, 0, s, 0, 1, 0, -s, 0, c );
        vec3 transformed = vec3( position ) * m;
        vNormal = vNormal * m;`)}get time(){return this._time.value}set time(e){this._time.value=e}get factor(){return this._factor.value}set factor(e){this._factor.value=e}}const I7=A.forwardRef(({speed:n=1,...e},t)=>{const[i]=A.useState(()=>new Rw);return Ee(s=>i&&(i.time=s.clock.getElapsedTime()*n)),A.createElement("primitive",ie({object:i,ref:t,attach:"material"},e))});class Dw extends Dt{constructor(e=new de){super({uniforms:{inputBuffer:new ri(null),depthBuffer:new ri(null),resolution:new ri(new de),texelSize:new ri(new de),halfTexelSize:new ri(new de),kernel:new ri(0),scale:new ri(1),cameraNear:new ri(0),cameraFar:new ri(1),minDepthThreshold:new ri(0),maxDepthThreshold:new ri(1),depthScale:new ri(0),depthToBlurRatioBias:new ri(.25)},fragmentShader:`#include <common>
        #include <dithering_pars_fragment>      
        uniform sampler2D inputBuffer;
        uniform sampler2D depthBuffer;
        uniform float cameraNear;
        uniform float cameraFar;
        uniform float minDepthThreshold;
        uniform float maxDepthThreshold;
        uniform float depthScale;
        uniform float depthToBlurRatioBias;
        varying vec2 vUv;
        varying vec2 vUv0;
        varying vec2 vUv1;
        varying vec2 vUv2;
        varying vec2 vUv3;

        void main() {
          float depthFactor = 0.0;
          
          #ifdef USE_DEPTH
            vec4 depth = texture2D(depthBuffer, vUv);
            depthFactor = smoothstep(minDepthThreshold, maxDepthThreshold, 1.0-(depth.r * depth.a));
            depthFactor *= depthScale;
            depthFactor = max(0.0, min(1.0, depthFactor + 0.25));
          #endif
          
          vec4 sum = texture2D(inputBuffer, mix(vUv0, vUv, depthFactor));
          sum += texture2D(inputBuffer, mix(vUv1, vUv, depthFactor));
          sum += texture2D(inputBuffer, mix(vUv2, vUv, depthFactor));
          sum += texture2D(inputBuffer, mix(vUv3, vUv, depthFactor));
          gl_FragColor = sum * 0.25 ;

          #include <dithering_fragment>
          #include <tonemapping_fragment>
          #include <${qt>=154?"colorspace_fragment":"encodings_fragment"}>
        }`,vertexShader:`uniform vec2 texelSize;
        uniform vec2 halfTexelSize;
        uniform float kernel;
        uniform float scale;
        varying vec2 vUv;
        varying vec2 vUv0;
        varying vec2 vUv1;
        varying vec2 vUv2;
        varying vec2 vUv3;

        void main() {
          vec2 uv = position.xy * 0.5 + 0.5;
          vUv = uv;

          vec2 dUv = (texelSize * vec2(kernel) + halfTexelSize) * scale;
          vUv0 = vec2(uv.x - dUv.x, uv.y + dUv.y);
          vUv1 = vec2(uv.x + dUv.x, uv.y + dUv.y);
          vUv2 = vec2(uv.x + dUv.x, uv.y - dUv.y);
          vUv3 = vec2(uv.x - dUv.x, uv.y - dUv.y);

          gl_Position = vec4(position.xy, 1.0, 1.0);
        }`,blending:Zm,depthWrite:!1,depthTest:!1}),this.toneMapped=!1,this.setTexelSize(e.x,e.y),this.kernel=new Float32Array([0,1,2,2,3])}setTexelSize(e,t){this.uniforms.texelSize.value.set(e,t),this.uniforms.halfTexelSize.value.set(e,t).multiplyScalar(.5)}setResolution(e){this.uniforms.resolution.value.copy(e)}}class B2{constructor({gl:e,resolution:t,width:i=500,height:s=500,minDepthThreshold:r=0,maxDepthThreshold:o=1,depthScale:a=0,depthToBlurRatioBias:c=.25}){this.renderToScreen=!1,this.renderTargetA=new It(t,t,{minFilter:zt,magFilter:zt,stencilBuffer:!1,depthBuffer:!1,type:Qi}),this.renderTargetB=this.renderTargetA.clone(),this.convolutionMaterial=new Dw,this.convolutionMaterial.setTexelSize(1/i,1/s),this.convolutionMaterial.setResolution(new de(i,s)),this.scene=new Sr,this.camera=new p1,this.convolutionMaterial.uniforms.minDepthThreshold.value=r,this.convolutionMaterial.uniforms.maxDepthThreshold.value=o,this.convolutionMaterial.uniforms.depthScale.value=a,this.convolutionMaterial.uniforms.depthToBlurRatioBias.value=c,this.convolutionMaterial.defines.USE_DEPTH=a>0;const l=new Float32Array([-1,-1,0,3,-1,0,-1,3,0]),u=new Float32Array([0,0,2,0,0,2]),h=new St;h.setAttribute("position",new Ye(l,3)),h.setAttribute("uv",new Ye(u,2)),this.screen=new ye(h,this.convolutionMaterial),this.screen.frustumCulled=!1,this.scene.add(this.screen)}render(e,t,i){const s=this.scene,r=this.camera,o=this.renderTargetA,a=this.renderTargetB;let c=this.convolutionMaterial,l=c.uniforms;l.depthBuffer.value=t.depthTexture;const u=c.kernel;let h=t,f,d,p;for(d=0,p=u.length-1;d<p;++d)f=d&1?a:o,l.kernel.value=u[d],l.inputBuffer.value=h.texture,e.setRenderTarget(f),e.render(s,r),h=f;l.kernel.value=u[d],l.inputBuffer.value=h.texture,e.setRenderTarget(this.renderToScreen?null:i),e.render(s,r)}}let _2=class extends Rc{constructor(e={}){super(e),this._tDepth={value:null},this._distortionMap={value:null},this._tDiffuse={value:null},this._tDiffuseBlur={value:null},this._textureMatrix={value:null},this._hasBlur={value:!1},this._mirror={value:0},this._mixBlur={value:0},this._blurStrength={value:.5},this._minDepthThreshold={value:.9},this._maxDepthThreshold={value:1},this._depthScale={value:0},this._depthToBlurRatioBias={value:.25},this._distortion={value:1},this._mixContrast={value:1},this.setValues(e)}onBeforeCompile(e){var t;(t=e.defines)!=null&&t.USE_UV||(e.defines.USE_UV=""),e.uniforms.hasBlur=this._hasBlur,e.uniforms.tDiffuse=this._tDiffuse,e.uniforms.tDepth=this._tDepth,e.uniforms.distortionMap=this._distortionMap,e.uniforms.tDiffuseBlur=this._tDiffuseBlur,e.uniforms.textureMatrix=this._textureMatrix,e.uniforms.mirror=this._mirror,e.uniforms.mixBlur=this._mixBlur,e.uniforms.mixStrength=this._blurStrength,e.uniforms.minDepthThreshold=this._minDepthThreshold,e.uniforms.maxDepthThreshold=this._maxDepthThreshold,e.uniforms.depthScale=this._depthScale,e.uniforms.depthToBlurRatioBias=this._depthToBlurRatioBias,e.uniforms.distortion=this._distortion,e.uniforms.mixContrast=this._mixContrast,e.vertexShader=`
        uniform mat4 textureMatrix;
        varying vec4 my_vUv;
      ${e.vertexShader}`,e.vertexShader=e.vertexShader.replace("#include <project_vertex>",`#include <project_vertex>
        my_vUv = textureMatrix * vec4( position, 1.0 );
        gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );`),e.fragmentShader=`
        uniform sampler2D tDiffuse;
        uniform sampler2D tDiffuseBlur;
        uniform sampler2D tDepth;
        uniform sampler2D distortionMap;
        uniform float distortion;
        uniform float cameraNear;
			  uniform float cameraFar;
        uniform bool hasBlur;
        uniform float mixBlur;
        uniform float mirror;
        uniform float mixStrength;
        uniform float minDepthThreshold;
        uniform float maxDepthThreshold;
        uniform float mixContrast;
        uniform float depthScale;
        uniform float depthToBlurRatioBias;
        varying vec4 my_vUv;
        ${e.fragmentShader}`,e.fragmentShader=e.fragmentShader.replace("#include <emissivemap_fragment>",`#include <emissivemap_fragment>

      float distortionFactor = 0.0;
      #ifdef USE_DISTORTION
        distortionFactor = texture2D(distortionMap, vUv).r * distortion;
      #endif

      vec4 new_vUv = my_vUv;
      new_vUv.x += distortionFactor;
      new_vUv.y += distortionFactor;

      vec4 base = texture2DProj(tDiffuse, new_vUv);
      vec4 blur = texture2DProj(tDiffuseBlur, new_vUv);

      vec4 merge = base;

      #ifdef USE_NORMALMAP
        vec2 normal_uv = vec2(0.0);
        vec4 normalColor = texture2D(normalMap, vUv * normalScale);
        vec3 my_normal = normalize( vec3( normalColor.r * 2.0 - 1.0, normalColor.b,  normalColor.g * 2.0 - 1.0 ) );
        vec3 coord = new_vUv.xyz / new_vUv.w;
        normal_uv = coord.xy + coord.z * my_normal.xz * 0.05;
        vec4 base_normal = texture2D(tDiffuse, normal_uv);
        vec4 blur_normal = texture2D(tDiffuseBlur, normal_uv);
        merge = base_normal;
        blur = blur_normal;
      #endif

      float depthFactor = 0.0001;
      float blurFactor = 0.0;

      #ifdef USE_DEPTH
        vec4 depth = texture2DProj(tDepth, new_vUv);
        depthFactor = smoothstep(minDepthThreshold, maxDepthThreshold, 1.0-(depth.r * depth.a));
        depthFactor *= depthScale;
        depthFactor = max(0.0001, min(1.0, depthFactor));

        #ifdef USE_BLUR
          blur = blur * min(1.0, depthFactor + depthToBlurRatioBias);
          merge = merge * min(1.0, depthFactor + 0.5);
        #else
          merge = merge * depthFactor;
        #endif

      #endif

      float reflectorRoughnessFactor = roughness;
      #ifdef USE_ROUGHNESSMAP
        vec4 reflectorTexelRoughness = texture2D( roughnessMap, vUv );
        reflectorRoughnessFactor *= reflectorTexelRoughness.g;
      #endif

      #ifdef USE_BLUR
        blurFactor = min(1.0, mixBlur * reflectorRoughnessFactor);
        merge = mix(merge, blur, blurFactor);
      #endif

      vec4 newMerge = vec4(0.0, 0.0, 0.0, 1.0);
      newMerge.r = (merge.r - 0.5) * mixContrast + 0.5;
      newMerge.g = (merge.g - 0.5) * mixContrast + 0.5;
      newMerge.b = (merge.b - 0.5) * mixContrast + 0.5;

      diffuseColor.rgb = diffuseColor.rgb * ((1.0 - min(1.0, mirror)) + newMerge.rgb * mixStrength);
      `)}get tDiffuse(){return this._tDiffuse.value}set tDiffuse(e){this._tDiffuse.value=e}get tDepth(){return this._tDepth.value}set tDepth(e){this._tDepth.value=e}get distortionMap(){return this._distortionMap.value}set distortionMap(e){this._distortionMap.value=e}get tDiffuseBlur(){return this._tDiffuseBlur.value}set tDiffuseBlur(e){this._tDiffuseBlur.value=e}get textureMatrix(){return this._textureMatrix.value}set textureMatrix(e){this._textureMatrix.value=e}get hasBlur(){return this._hasBlur.value}set hasBlur(e){this._hasBlur.value=e}get mirror(){return this._mirror.value}set mirror(e){this._mirror.value=e}get mixBlur(){return this._mixBlur.value}set mixBlur(e){this._mixBlur.value=e}get mixStrength(){return this._blurStrength.value}set mixStrength(e){this._blurStrength.value=e}get minDepthThreshold(){return this._minDepthThreshold.value}set minDepthThreshold(e){this._minDepthThreshold.value=e}get maxDepthThreshold(){return this._maxDepthThreshold.value}set maxDepthThreshold(e){this._maxDepthThreshold.value=e}get depthScale(){return this._depthScale.value}set depthScale(e){this._depthScale.value=e}get depthToBlurRatioBias(){return this._depthToBlurRatioBias.value}set depthToBlurRatioBias(e){this._depthToBlurRatioBias.value=e}get distortion(){return this._distortion.value}set distortion(e){this._distortion.value=e}get mixContrast(){return this._mixContrast.value}set mixContrast(e){this._mixContrast.value=e}};const w7=A.forwardRef(({mixBlur:n=0,mixStrength:e=1,resolution:t=256,blur:i=[0,0],minDepthThreshold:s=.9,maxDepthThreshold:r=1,depthScale:o=0,depthToBlurRatioBias:a=.25,mirror:c=0,distortion:l=1,mixContrast:u=1,distortionMap:h,reflectorOffset:f=0,...d},p)=>{dt({MeshReflectorMaterialImpl:_2});const m=Z(({gl:V})=>V),g=Z(({camera:V})=>V),y=Z(({scene:V})=>V);i=Array.isArray(i)?i:[i,i];const v=i[0]+i[1]>0,E=A.useRef(null);A.useImperativeHandle(p,()=>E.current,[]);const[C]=A.useState(()=>new bs),[x]=A.useState(()=>new b),[I]=A.useState(()=>new b),[S]=A.useState(()=>new b),[w]=A.useState(()=>new ce),[B]=A.useState(()=>new b(0,0,-1)),[T]=A.useState(()=>new ft),[R]=A.useState(()=>new b),[_]=A.useState(()=>new b),[L]=A.useState(()=>new ft),[O]=A.useState(()=>new ce),[U]=A.useState(()=>new nt),Q=A.useCallback(()=>{var V;const $=E.current.parent||((V=E.current)==null?void 0:V.__r3f.parent);if(!$||(I.setFromMatrixPosition($.matrixWorld),S.setFromMatrixPosition(g.matrixWorld),w.extractRotation($.matrixWorld),x.set(0,0,1),x.applyMatrix4(w),I.addScaledVector(x,f),R.subVectors(I,S),R.dot(x)>0))return;R.reflect(x).negate(),R.add(I),w.extractRotation(g.matrixWorld),B.set(0,0,-1),B.applyMatrix4(w),B.add(S),_.subVectors(I,B),_.reflect(x).negate(),_.add(I),U.position.copy(R),U.up.set(0,1,0),U.up.applyMatrix4(w),U.up.reflect(x),U.lookAt(_),U.far=g.far,U.updateMatrixWorld(),U.projectionMatrix.copy(g.projectionMatrix),O.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),O.multiply(U.projectionMatrix),O.multiply(U.matrixWorldInverse),O.multiply($.matrixWorld),C.setFromNormalAndCoplanarPoint(x,I),C.applyMatrix4(U.matrixWorldInverse),T.set(C.normal.x,C.normal.y,C.normal.z,C.constant);const Y=U.projectionMatrix;L.x=(Math.sign(T.x)+Y.elements[8])/Y.elements[0],L.y=(Math.sign(T.y)+Y.elements[9])/Y.elements[5],L.z=-1,L.w=(1+Y.elements[10])/Y.elements[14],T.multiplyScalar(2/T.dot(L)),Y.elements[2]=T.x,Y.elements[6]=T.y,Y.elements[10]=T.z+1,Y.elements[14]=T.w},[g,f]),[G,z,H,N]=A.useMemo(()=>{const V={minFilter:zt,magFilter:zt,type:Qi},$=new It(t,t,V);$.depthBuffer=!0,$.depthTexture=new Uh(t,t),$.depthTexture.format=Qh,$.depthTexture.type=Mc;const Y=new It(t,t,V),M=new B2({gl:m,resolution:t,width:i[0],height:i[1],minDepthThreshold:s,maxDepthThreshold:r,depthScale:o,depthToBlurRatioBias:a}),k={mirror:c,textureMatrix:O,mixBlur:n,tDiffuse:$.texture,tDepth:$.depthTexture,tDiffuseBlur:Y.texture,hasBlur:v,mixStrength:e,minDepthThreshold:s,maxDepthThreshold:r,depthScale:o,depthToBlurRatioBias:a,distortion:l,distortionMap:h,mixContrast:u,"defines-USE_BLUR":v?"":void 0,"defines-USE_DEPTH":o>0?"":void 0,"defines-USE_DISTORTION":h?"":void 0};return[$,Y,M,k]},[m,i,O,t,c,v,n,e,s,r,o,a,l,h,u]);return Ee(()=>{var V;const $=E.current.parent||((V=E.current)==null?void 0:V.__r3f.parent);if(!$)return;$.visible=!1;const Y=m.xr.enabled,M=m.shadowMap.autoUpdate;Q(),m.xr.enabled=!1,m.shadowMap.autoUpdate=!1,m.setRenderTarget(G),m.state.buffers.depth.setMask(!0),m.autoClear||m.clear(),m.render(y,U),v&&H.render(m,G,z),m.xr.enabled=Y,m.shadowMap.autoUpdate=M,$.visible=!0,m.setRenderTarget(null)}),A.createElement("meshReflectorMaterialImpl",ie({attach:"material",key:"key"+N["defines-USE_BLUR"]+N["defines-USE_DEPTH"]+N["defines-USE_DISTORTION"],ref:E},N,d))}),Mw=Ri({envMap:null,bounces:3,ior:2.4,correctMips:!0,aberrationStrength:.01,fresnel:0,bvh:new y2,color:new xe("white"),opacity:1,resolution:new de,viewMatrixInverse:new ce,projectionMatrixInverse:new ce},`
  uniform mat4 viewMatrixInverse;

  varying vec3 vWorldPosition;
  varying vec3 vNormal;
  varying mat4 vModelMatrixInverse;

  #include <color_pars_vertex>

  void main() {
    #include <color_vertex>

    vec4 transformedNormal = vec4(normal, 0.0);
    vec4 transformedPosition = vec4(position, 1.0);
    #ifdef USE_INSTANCING
      transformedNormal = instanceMatrix * transformedNormal;
      transformedPosition = instanceMatrix * transformedPosition;
    #endif

    #ifdef USE_INSTANCING
      vModelMatrixInverse = inverse(modelMatrix * instanceMatrix);
    #else
      vModelMatrixInverse = inverse(modelMatrix);
    #endif

    vWorldPosition = (modelMatrix * transformedPosition).xyz;
    vNormal = normalize((viewMatrixInverse * vec4(normalMatrix * transformedNormal.xyz, 0.0)).xyz);
    gl_Position = projectionMatrix * viewMatrix * modelMatrix * transformedPosition;
  }`,`
  #define ENVMAP_TYPE_CUBE_UV
  precision highp isampler2D;
  precision highp usampler2D;
  varying vec3 vWorldPosition;
  varying vec3 vNormal;
  varying mat4 vModelMatrixInverse;

  #include <color_pars_fragment>

  #ifdef ENVMAP_TYPE_CUBEM
    uniform samplerCube envMap;
  #else
    uniform sampler2D envMap;
  #endif

  uniform float bounces;
  ${ow}
  ${aw}
  uniform BVH bvh;
  uniform float ior;
  uniform bool correctMips;
  uniform vec2 resolution;
  uniform float fresnel;
  uniform mat4 modelMatrix;
  uniform mat4 projectionMatrixInverse;
  uniform mat4 viewMatrixInverse;
  uniform float aberrationStrength;
  uniform vec3 color;
  uniform float opacity;

  float fresnelFunc(vec3 viewDirection, vec3 worldNormal) {
    return pow( 1.0 + dot( viewDirection, worldNormal), 10.0 );
  }

  vec3 totalInternalReflection(vec3 ro, vec3 rd, vec3 normal, float ior, mat4 modelMatrixInverse) {
    vec3 rayOrigin = ro;
    vec3 rayDirection = rd;
    rayDirection = refract(rayDirection, normal, 1.0 / ior);
    rayOrigin = vWorldPosition + rayDirection * 0.001;
    rayOrigin = (modelMatrixInverse * vec4(rayOrigin, 1.0)).xyz;
    rayDirection = normalize((modelMatrixInverse * vec4(rayDirection, 0.0)).xyz);
    for(float i = 0.0; i < bounces; i++) {
      uvec4 faceIndices = uvec4( 0u );
      vec3 faceNormal = vec3( 0.0, 0.0, 1.0 );
      vec3 barycoord = vec3( 0.0 );
      float side = 1.0;
      float dist = 0.0;
      bvhIntersectFirstHit( bvh, rayOrigin, rayDirection, faceIndices, faceNormal, barycoord, side, dist );
      vec3 hitPos = rayOrigin + rayDirection * max(dist - 0.001, 0.0);
      vec3 tempDir = refract(rayDirection, faceNormal, ior);
      if (length(tempDir) != 0.0) {
        rayDirection = tempDir;
        break;
      }
      rayDirection = reflect(rayDirection, faceNormal);
      rayOrigin = hitPos + rayDirection * 0.01;
    }
    rayDirection = normalize((modelMatrix * vec4(rayDirection, 0.0)).xyz);
    return rayDirection;
  }

  #include <common>
  #include <cube_uv_reflection_fragment>

  #ifdef ENVMAP_TYPE_CUBEM
    vec4 textureGradient(samplerCube envMap, vec3 rayDirection, vec3 directionCamPerfect) {
      return textureGrad(envMap, rayDirection, dFdx(correctMips ? directionCamPerfect: rayDirection), dFdy(correctMips ? directionCamPerfect: rayDirection));
    }
  #else
    vec4 textureGradient(sampler2D envMap, vec3 rayDirection, vec3 directionCamPerfect) {
      vec2 uvv = equirectUv( rayDirection );
      vec2 smoothUv = equirectUv( directionCamPerfect );
      return textureGrad(envMap, uvv, dFdx(correctMips ? smoothUv : uvv), dFdy(correctMips ? smoothUv : uvv));
    }
  #endif

  void main() {
    vec2 uv = gl_FragCoord.xy / resolution;
    vec3 directionCamPerfect = (projectionMatrixInverse * vec4(uv * 2.0 - 1.0, 0.0, 1.0)).xyz;
    directionCamPerfect = (viewMatrixInverse * vec4(directionCamPerfect, 0.0)).xyz;
    directionCamPerfect = normalize(directionCamPerfect);
    vec3 normal = vNormal;
    vec3 rayOrigin = cameraPosition;
    vec3 rayDirection = normalize(vWorldPosition - cameraPosition);

    vec4 diffuseColor = vec4(color, opacity);
    #include <color_fragment>

    #ifdef CHROMATIC_ABERRATIONS
      vec3 rayDirectionG = totalInternalReflection(rayOrigin, rayDirection, normal, max(ior, 1.0), vModelMatrixInverse);
      #ifdef FAST_CHROMA
        vec3 rayDirectionR = normalize(rayDirectionG + 1.0 * vec3(aberrationStrength / 2.0));
        vec3 rayDirectionB = normalize(rayDirectionG - 1.0 * vec3(aberrationStrength / 2.0));
      #else
        vec3 rayDirectionR = totalInternalReflection(rayOrigin, rayDirection, normal, max(ior * (1.0 - aberrationStrength), 1.0), vModelMatrixInverse);
        vec3 rayDirectionB = totalInternalReflection(rayOrigin, rayDirection, normal, max(ior * (1.0 + aberrationStrength), 1.0), vModelMatrixInverse);
      #endif
      float finalColorR = textureGradient(envMap, rayDirectionR, directionCamPerfect).r;
      float finalColorG = textureGradient(envMap, rayDirectionG, directionCamPerfect).g;
      float finalColorB = textureGradient(envMap, rayDirectionB, directionCamPerfect).b;
      diffuseColor.rgb *= vec3(finalColorR, finalColorG, finalColorB);
    #else
      rayDirection = totalInternalReflection(rayOrigin, rayDirection, normal, max(ior, 1.0), vModelMatrixInverse);
      diffuseColor.rgb *= textureGradient(envMap, rayDirection, directionCamPerfect).rgb;
    #endif

    vec3 viewDirection = normalize(vWorldPosition - cameraPosition);
    float nFresnel = fresnelFunc(viewDirection, normal) * fresnel;
    gl_FragColor = vec4(mix(diffuseColor.rgb, vec3(1.0), nFresnel), diffuseColor.a);

    #include <tonemapping_fragment>
    #include <${qt>=154?"colorspace_fragment":"encodings_fragment"}>
  }`),Lw=n=>n&&n.isCubeTexture;function T7({aberrationStrength:n=0,fastChroma:e=!0,envMap:t,...i}){dt({MeshRefractionMaterial:Mw});const s=A.useRef(),{size:r}=Z(),o=A.useMemo(()=>{var a,c;const l={},u=Lw(t),f=((a=u?(c=t.image[0])==null?void 0:c.width:t.image.width)!==null&&a!==void 0?a:1024)/4,d=Math.floor(Math.log2(f)),p=Math.pow(2,d),m=3*Math.max(p,16*7),g=4*p;return u&&(l.ENVMAP_TYPE_CUBEM=""),l.CUBEUV_TEXEL_WIDTH=`${1/m}`,l.CUBEUV_TEXEL_HEIGHT=`${1/g}`,l.CUBEUV_MAX_MIP=`${d}.0`,n>0&&(l.CHROMATIC_ABERRATIONS=""),e&&(l.FAST_CHROMA=""),l},[n,e]);return A.useLayoutEffect(()=>{var a;const c=(a=s.current)==null||(a=a.__r3f)==null||(a=a.parent)==null?void 0:a.geometry;c&&(s.current.bvh=new y2,s.current.bvh.updateFrom(new Wc(c.clone().toNonIndexed(),{strategy:Vc})))},[]),Ee(({camera:a})=>{s.current.viewMatrixInverse=a.matrixWorld,s.current.projectionMatrixInverse=a.projectionMatrixInverse}),A.createElement("meshRefractionMaterial",ie({key:JSON.stringify(o),defines:o,ref:s,resolution:[r.width,r.height],aberrationStrength:n,envMap:t},i))}const Bf=Ri({},"void main() { }","void main() { gl_FragColor = vec4(0.0, 0.0, 0.0, 0.0); discard;  }");class Pw extends bi{constructor(e=6,t=!1){super(),this.uniforms={chromaticAberration:{value:.05},transmission:{value:0},_transmission:{value:1},transmissionMap:{value:null},roughness:{value:0},thickness:{value:0},thicknessMap:{value:null},attenuationDistance:{value:1/0},attenuationColor:{value:new xe("white")},anisotropicBlur:{value:.1},time:{value:0},distortion:{value:0},distortionScale:{value:.5},temporalDistortion:{value:0},buffer:{value:null}},this.onBeforeCompile=i=>{i.uniforms={...i.uniforms,...this.uniforms},this.anisotropy>0&&(i.defines.USE_ANISOTROPY=""),t?i.defines.USE_SAMPLER="":i.defines.USE_TRANSMISSION="",i.fragmentShader=`
      uniform float chromaticAberration;         
      uniform float anisotropicBlur;      
      uniform float time;
      uniform float distortion;
      uniform float distortionScale;
      uniform float temporalDistortion;
      uniform sampler2D buffer;

      vec3 random3(vec3 c) {
        float j = 4096.0*sin(dot(c,vec3(17.0, 59.4, 15.0)));
        vec3 r;
        r.z = fract(512.0*j);
        j *= .125;
        r.x = fract(512.0*j);
        j *= .125;
        r.y = fract(512.0*j);
        return r-0.5;
      }

      uint hash( uint x ) {
        x += ( x << 10u );
        x ^= ( x >>  6u );
        x += ( x <<  3u );
        x ^= ( x >> 11u );
        x += ( x << 15u );
        return x;
      }

      // Compound versions of the hashing algorithm I whipped together.
      uint hash( uvec2 v ) { return hash( v.x ^ hash(v.y)                         ); }
      uint hash( uvec3 v ) { return hash( v.x ^ hash(v.y) ^ hash(v.z)             ); }
      uint hash( uvec4 v ) { return hash( v.x ^ hash(v.y) ^ hash(v.z) ^ hash(v.w) ); }

      // Construct a float with half-open range [0:1] using low 23 bits.
      // All zeroes yields 0.0, all ones yields the next smallest representable value below 1.0.
      float floatConstruct( uint m ) {
        const uint ieeeMantissa = 0x007FFFFFu; // binary32 mantissa bitmask
        const uint ieeeOne      = 0x3F800000u; // 1.0 in IEEE binary32
        m &= ieeeMantissa;                     // Keep only mantissa bits (fractional part)
        m |= ieeeOne;                          // Add fractional part to 1.0
        float  f = uintBitsToFloat( m );       // Range [1:2]
        return f - 1.0;                        // Range [0:1]
      }

      // Pseudo-random value in half-open range [0:1].
      float randomBase( float x ) { return floatConstruct(hash(floatBitsToUint(x))); }
      float randomBase( vec2  v ) { return floatConstruct(hash(floatBitsToUint(v))); }
      float randomBase( vec3  v ) { return floatConstruct(hash(floatBitsToUint(v))); }
      float randomBase( vec4  v ) { return floatConstruct(hash(floatBitsToUint(v))); }
      float rand(float seed) {
        float result = randomBase(vec3(gl_FragCoord.xy, seed));
        return result;
      }

      const float F3 =  0.3333333;
      const float G3 =  0.1666667;

      float snoise(vec3 p) {
        vec3 s = floor(p + dot(p, vec3(F3)));
        vec3 x = p - s + dot(s, vec3(G3));
        vec3 e = step(vec3(0.0), x - x.yzx);
        vec3 i1 = e*(1.0 - e.zxy);
        vec3 i2 = 1.0 - e.zxy*(1.0 - e);
        vec3 x1 = x - i1 + G3;
        vec3 x2 = x - i2 + 2.0*G3;
        vec3 x3 = x - 1.0 + 3.0*G3;
        vec4 w, d;
        w.x = dot(x, x);
        w.y = dot(x1, x1);
        w.z = dot(x2, x2);
        w.w = dot(x3, x3);
        w = max(0.6 - w, 0.0);
        d.x = dot(random3(s), x);
        d.y = dot(random3(s + i1), x1);
        d.z = dot(random3(s + i2), x2);
        d.w = dot(random3(s + 1.0), x3);
        w *= w;
        w *= w;
        d *= w;
        return dot(d, vec4(52.0));
      }

      float snoiseFractal(vec3 m) {
        return 0.5333333* snoise(m)
              +0.2666667* snoise(2.0*m)
              +0.1333333* snoise(4.0*m)
              +0.0666667* snoise(8.0*m);
      }
`+i.fragmentShader,i.fragmentShader=i.fragmentShader.replace("#include <transmission_pars_fragment>",`
        #ifdef USE_TRANSMISSION
          // Transmission code is based on glTF-Sampler-Viewer
          // https://github.com/KhronosGroup/glTF-Sample-Viewer
          uniform float _transmission;
          uniform float thickness;
          uniform float attenuationDistance;
          uniform vec3 attenuationColor;
          #ifdef USE_TRANSMISSIONMAP
            uniform sampler2D transmissionMap;
          #endif
          #ifdef USE_THICKNESSMAP
            uniform sampler2D thicknessMap;
          #endif
          uniform vec2 transmissionSamplerSize;
          uniform sampler2D transmissionSamplerMap;
          uniform mat4 modelMatrix;
          uniform mat4 projectionMatrix;
          varying vec3 vWorldPosition;
          vec3 getVolumeTransmissionRay( const in vec3 n, const in vec3 v, const in float thickness, const in float ior, const in mat4 modelMatrix ) {
            // Direction of refracted light.
            vec3 refractionVector = refract( - v, normalize( n ), 1.0 / ior );
            // Compute rotation-independant scaling of the model matrix.
            vec3 modelScale;
            modelScale.x = length( vec3( modelMatrix[ 0 ].xyz ) );
            modelScale.y = length( vec3( modelMatrix[ 1 ].xyz ) );
            modelScale.z = length( vec3( modelMatrix[ 2 ].xyz ) );
            // The thickness is specified in local space.
            return normalize( refractionVector ) * thickness * modelScale;
          }
          float applyIorToRoughness( const in float roughness, const in float ior ) {
            // Scale roughness with IOR so that an IOR of 1.0 results in no microfacet refraction and
            // an IOR of 1.5 results in the default amount of microfacet refraction.
            return roughness * clamp( ior * 2.0 - 2.0, 0.0, 1.0 );
          }
          vec4 getTransmissionSample( const in vec2 fragCoord, const in float roughness, const in float ior ) {
            float framebufferLod = log2( transmissionSamplerSize.x ) * applyIorToRoughness( roughness, ior );            
            #ifdef USE_SAMPLER
              #ifdef texture2DLodEXT
                return texture2DLodEXT(transmissionSamplerMap, fragCoord.xy, framebufferLod);
              #else
                return texture2D(transmissionSamplerMap, fragCoord.xy, framebufferLod);
              #endif
            #else
              return texture2D(buffer, fragCoord.xy);
            #endif
          }
          vec3 applyVolumeAttenuation( const in vec3 radiance, const in float transmissionDistance, const in vec3 attenuationColor, const in float attenuationDistance ) {
            if ( isinf( attenuationDistance ) ) {
              // Attenuation distance is +∞, i.e. the transmitted color is not attenuated at all.
              return radiance;
            } else {
              // Compute light attenuation using Beer's law.
              vec3 attenuationCoefficient = -log( attenuationColor ) / attenuationDistance;
              vec3 transmittance = exp( - attenuationCoefficient * transmissionDistance ); // Beer's law
              return transmittance * radiance;
            }
          }
          vec4 getIBLVolumeRefraction( const in vec3 n, const in vec3 v, const in float roughness, const in vec3 diffuseColor,
            const in vec3 specularColor, const in float specularF90, const in vec3 position, const in mat4 modelMatrix,
            const in mat4 viewMatrix, const in mat4 projMatrix, const in float ior, const in float thickness,
            const in vec3 attenuationColor, const in float attenuationDistance ) {
            vec3 transmissionRay = getVolumeTransmissionRay( n, v, thickness, ior, modelMatrix );
            vec3 refractedRayExit = position + transmissionRay;
            // Project refracted vector on the framebuffer, while mapping to normalized device coordinates.
            vec4 ndcPos = projMatrix * viewMatrix * vec4( refractedRayExit, 1.0 );
            vec2 refractionCoords = ndcPos.xy / ndcPos.w;
            refractionCoords += 1.0;
            refractionCoords /= 2.0;
            // Sample framebuffer to get pixel the refracted ray hits.
            vec4 transmittedLight = getTransmissionSample( refractionCoords, roughness, ior );
            vec3 attenuatedColor = applyVolumeAttenuation( transmittedLight.rgb, length( transmissionRay ), attenuationColor, attenuationDistance );
            // Get the specular component.
            vec3 F = EnvironmentBRDF( n, v, specularColor, specularF90, roughness );
            return vec4( ( 1.0 - F ) * attenuatedColor * diffuseColor, transmittedLight.a );
          }
        #endif
`),i.fragmentShader=i.fragmentShader.replace("#include <transmission_fragment>",`  
        // Improve the refraction to use the world pos
        material.transmission = _transmission;
        material.transmissionAlpha = 1.0;
        material.thickness = thickness;
        material.attenuationDistance = attenuationDistance;
        material.attenuationColor = attenuationColor;
        #ifdef USE_TRANSMISSIONMAP
          material.transmission *= texture2D( transmissionMap, vUv ).r;
        #endif
        #ifdef USE_THICKNESSMAP
          material.thickness *= texture2D( thicknessMap, vUv ).g;
        #endif
        
        vec3 pos = vWorldPosition;
        float runningSeed = 0.0;
        vec3 v = normalize( cameraPosition - pos );
        vec3 n = inverseTransformDirection( normal, viewMatrix );
        vec3 transmission = vec3(0.0);
        float transmissionR, transmissionB, transmissionG;
        float randomCoords = rand(runningSeed++);
        float thickness_smear = thickness * max(pow(roughnessFactor, 0.33), anisotropicBlur);
        vec3 distortionNormal = vec3(0.0);
        vec3 temporalOffset = vec3(time, -time, -time) * temporalDistortion;
        if (distortion > 0.0) {
          distortionNormal = distortion * vec3(snoiseFractal(vec3((pos * distortionScale + temporalOffset))), snoiseFractal(vec3(pos.zxy * distortionScale - temporalOffset)), snoiseFractal(vec3(pos.yxz * distortionScale + temporalOffset)));
        }
        for (float i = 0.0; i < ${e}.0; i ++) {
          vec3 sampleNorm = normalize(n + roughnessFactor * roughnessFactor * 2.0 * normalize(vec3(rand(runningSeed++) - 0.5, rand(runningSeed++) - 0.5, rand(runningSeed++) - 0.5)) * pow(rand(runningSeed++), 0.33) + distortionNormal);
          transmissionR = getIBLVolumeRefraction(
            sampleNorm, v, material.roughness, material.diffuseColor, material.specularColor, material.specularF90,
            pos, modelMatrix, viewMatrix, projectionMatrix, material.ior, material.thickness  + thickness_smear * (i + randomCoords) / float(${e}),
            material.attenuationColor, material.attenuationDistance
          ).r;
          transmissionG = getIBLVolumeRefraction(
            sampleNorm, v, material.roughness, material.diffuseColor, material.specularColor, material.specularF90,
            pos, modelMatrix, viewMatrix, projectionMatrix, material.ior  * (1.0 + chromaticAberration * (i + randomCoords) / float(${e})) , material.thickness + thickness_smear * (i + randomCoords) / float(${e}),
            material.attenuationColor, material.attenuationDistance
          ).g;
          transmissionB = getIBLVolumeRefraction(
            sampleNorm, v, material.roughness, material.diffuseColor, material.specularColor, material.specularF90,
            pos, modelMatrix, viewMatrix, projectionMatrix, material.ior * (1.0 + 2.0 * chromaticAberration * (i + randomCoords) / float(${e})), material.thickness + thickness_smear * (i + randomCoords) / float(${e}),
            material.attenuationColor, material.attenuationDistance
          ).b;
          transmission.r += transmissionR;
          transmission.g += transmissionG;
          transmission.b += transmissionB;
        }
        transmission /= ${e}.0;
        totalDiffuse = mix( totalDiffuse, transmission.rgb, material.transmission );
`)},Object.keys(this.uniforms).forEach(i=>Object.defineProperty(this,i,{get:()=>this.uniforms[i].value,set:s=>this.uniforms[i].value=s}))}}const B7=A.forwardRef(({buffer:n,transmissionSampler:e=!1,backside:t=!1,side:i=Do,transmission:s=1,thickness:r=0,backsideThickness:o=0,backsideEnvMapIntensity:a=1,samples:c=10,resolution:l,backsideResolution:u,background:h,anisotropy:f,anisotropicBlur:d,...p},m)=>{dt({MeshTransmissionMaterial:Pw});const g=A.useRef(null),[y]=A.useState(()=>new Bf),v=wi(u||l),E=wi(l);let C,x,I,S;return Ee(w=>{g.current.time=w.clock.getElapsedTime(),g.current.buffer===E.texture&&!e&&(S=g.current.__r3f.parent,S&&(I=w.gl.toneMapping,C=w.scene.background,x=g.current.envMapIntensity,w.gl.toneMapping=Wy,h&&(w.scene.background=h),S.material=y,t&&(w.gl.setRenderTarget(v),w.gl.render(w.scene,w.camera),S.material=g.current,S.material.buffer=v.texture,S.material.thickness=o,S.material.side=Cr,S.material.envMapIntensity=a),w.gl.setRenderTarget(E),w.gl.render(w.scene,w.camera),S.material=g.current,S.material.thickness=r,S.material.side=i,S.material.buffer=E.texture,S.material.envMapIntensity=x,w.scene.background=C,w.gl.setRenderTarget(null),w.gl.toneMapping=I))}),A.useImperativeHandle(m,()=>g.current,[]),A.createElement("meshTransmissionMaterial",ie({args:[c,e],ref:g},p,{buffer:n||E.texture,_transmission:s,anisotropicBlur:d??f,transmission:e?s:0,thickness:r,side:i}))}),_7=A.forwardRef((n,e)=>(dt({DiscardMaterialImpl:Bf}),A.createElement("discardMaterialImpl",ie({ref:e},n))));function b7(n){const e=A.useRef(null);return A.useLayoutEffect(()=>{var t;const i=(t=e.current)==null?void 0:t.parent,s=i==null?void 0:i.geometry;if(s){const r=i.material;i.material=e.current.__r3f.objects;const o=[...s.groups];return s.clearGroups(),i.material.forEach((a,c)=>{c<i.material.length-1&&(a.depthWrite=!1),s.addGroup(0,1/0,c)}),()=>{i.material=r,s.groups=o}}}),A.createElement("group",ie({ref:e},n))}const xu=qt>=154?"opaque_fragment":"output_fragment";class Fw extends i1{constructor(e){super(e),this.onBeforeCompile=(t,i)=>{const{isWebGL2:s}=i.capabilities;t.fragmentShader=t.fragmentShader.replace(`#include <${xu}>`,`
        ${s?`#include <${xu}>`:`#extension GL_OES_standard_derivatives : enable
#include <${xu}>`}
      vec2 cxy = 2.0 * gl_PointCoord - 1.0;
      float r = dot(cxy, cxy);
      float delta = fwidth(r);     
      float mask = 1.0 - smoothstep(1.0 - delta, 1.0 + delta, r);
      gl_FragColor = vec4(gl_FragColor.rgb, mask * gl_FragColor.a );
      #include <tonemapping_fragment>
      #include <${qt>=154?"colorspace_fragment":"encodings_fragment"}>
      `)}}}const R7=A.forwardRef((n,e)=>{const[t]=A.useState(()=>new Fw(null));return A.createElement("primitive",ie({},n,{object:t,ref:e,attach:"material"}))}),kw=({focus:n=0,size:e=25,samples:t=10}={})=>`
#define PENUMBRA_FILTER_SIZE float(${e})
#define RGB_NOISE_FUNCTION(uv) (randRGB(uv))
vec3 randRGB(vec2 uv) {
  return vec3(
    fract(sin(dot(uv, vec2(12.75613, 38.12123))) * 13234.76575),
    fract(sin(dot(uv, vec2(19.45531, 58.46547))) * 43678.23431),
    fract(sin(dot(uv, vec2(23.67817, 78.23121))) * 93567.23423)
  );
}

vec3 lowPassRandRGB(vec2 uv) {
  // 3x3 convolution (average)
  // can be implemented as separable with an extra buffer for a total of 6 samples instead of 9
  vec3 result = vec3(0);
  result += RGB_NOISE_FUNCTION(uv + vec2(-1.0, -1.0));
  result += RGB_NOISE_FUNCTION(uv + vec2(-1.0,  0.0));
  result += RGB_NOISE_FUNCTION(uv + vec2(-1.0, +1.0));
  result += RGB_NOISE_FUNCTION(uv + vec2( 0.0, -1.0));
  result += RGB_NOISE_FUNCTION(uv + vec2( 0.0,  0.0));
  result += RGB_NOISE_FUNCTION(uv + vec2( 0.0, +1.0));
  result += RGB_NOISE_FUNCTION(uv + vec2(+1.0, -1.0));
  result += RGB_NOISE_FUNCTION(uv + vec2(+1.0,  0.0));
  result += RGB_NOISE_FUNCTION(uv + vec2(+1.0, +1.0));
  result *= 0.111111111; // 1.0 / 9.0
  return result;
}
vec3 highPassRandRGB(vec2 uv) {
  // by subtracting the low-pass signal from the original signal, we're being left with the high-pass signal
  // hp(x) = x - lp(x)
  return RGB_NOISE_FUNCTION(uv) - lowPassRandRGB(uv) + 0.5;
}


vec2 vogelDiskSample(int sampleIndex, int sampleCount, float angle) {
  const float goldenAngle = 2.399963f; // radians
  float r = sqrt(float(sampleIndex) + 0.5f) / sqrt(float(sampleCount));
  float theta = float(sampleIndex) * goldenAngle + angle;
  float sine = sin(theta);
  float cosine = cos(theta);
  return vec2(cosine, sine) * r;
}
float penumbraSize( const in float zReceiver, const in float zBlocker ) { // Parallel plane estimation
  return (zReceiver - zBlocker) / zBlocker;
}
float findBlocker(sampler2D shadowMap, vec2 uv, float compare, float angle) {
  float texelSize = 1.0 / float(textureSize(shadowMap, 0).x);
  float blockerDepthSum = float(${n});
  float blockers = 0.0;

  int j = 0;
  vec2 offset = vec2(0.);
  float depth = 0.;

  #pragma unroll_loop_start
  for(int i = 0; i < ${t}; i ++) {
    offset = (vogelDiskSample(j, ${t}, angle) * texelSize) * 2.0 * PENUMBRA_FILTER_SIZE;
    depth = unpackRGBAToDepth( texture2D( shadowMap, uv + offset));
    if (depth < compare) {
      blockerDepthSum += depth;
      blockers++;
    }
    j++;
  }
  #pragma unroll_loop_end

  if (blockers > 0.0) {
    return blockerDepthSum / blockers;
  }
  return -1.0;
}

        
float vogelFilter(sampler2D shadowMap, vec2 uv, float zReceiver, float filterRadius, float angle) {
  float texelSize = 1.0 / float(textureSize(shadowMap, 0).x);
  float shadow = 0.0f;
  int j = 0;
  vec2 vogelSample = vec2(0.0);
  vec2 offset = vec2(0.0);
  #pragma unroll_loop_start
  for (int i = 0; i < ${t}; i++) {
    vogelSample = vogelDiskSample(j, ${t}, angle) * texelSize;
    offset = vogelSample * (1.0 + filterRadius * float(${e}));
    shadow += step( zReceiver, unpackRGBAToDepth( texture2D( shadowMap, uv + offset ) ) );
    j++;
  }
  #pragma unroll_loop_end
  return shadow * 1.0 / ${t}.0;
}

float PCSS (sampler2D shadowMap, vec4 coords) {
  vec2 uv = coords.xy;
  float zReceiver = coords.z; // Assumed to be eye-space z in this code
  float angle = highPassRandRGB(gl_FragCoord.xy).r * PI2;
  float avgBlockerDepth = findBlocker(shadowMap, uv, zReceiver, angle);
  if (avgBlockerDepth == -1.0) {
    return 1.0;
  }
  float penumbraRatio = penumbraSize(zReceiver, avgBlockerDepth);
  return vogelFilter(shadowMap, uv, zReceiver, 1.25 * penumbraRatio, angle);
}`;function sm(n,e,t){e.traverse(i=>{i.material&&(n.properties.remove(i.material),i.material.dispose==null||i.material.dispose())}),n.info.programs.length=0,n.compile(e,t)}function D7({focus:n=0,samples:e=10,size:t=25}){const i=Z(o=>o.gl),s=Z(o=>o.scene),r=Z(o=>o.camera);return A.useEffect(()=>{const o=mo.shadowmap_pars_fragment;return mo.shadowmap_pars_fragment=mo.shadowmap_pars_fragment.replace("#ifdef USE_SHADOWMAP",`#ifdef USE_SHADOWMAP
`+kw({size:t,samples:e,focus:n})).replace("#if defined( SHADOWMAP_TYPE_PCF )",`
return PCSS(shadowMap, shadowCoord);
#if defined( SHADOWMAP_TYPE_PCF )`),sm(i,s,r),()=>{mo.shadowmap_pars_fragment=o,sm(i,s,r)}},[n,t,e]),null}function Bt(n,e){const t=n+"Geometry";return A.forwardRef(({args:i,children:s,...r},o)=>{const a=A.useRef(null);return A.useImperativeHandle(o,()=>a.current),A.useLayoutEffect(()=>void(e==null?void 0:e(a.current))),A.createElement("mesh",ie({ref:a},r),A.createElement(t,{attach:"geometry",args:i}),s)})}const M7=Bt("box"),L7=Bt("circle"),P7=Bt("cone"),F7=Bt("cylinder"),k7=Bt("sphere"),O7=Bt("plane"),U7=Bt("tube"),Q7=Bt("torus"),N7=Bt("torusKnot"),G7=Bt("tetrahedron"),z7=Bt("ring"),H7=Bt("polyhedron"),K7=Bt("icosahedron"),V7=Bt("octahedron"),Y7=Bt("dodecahedron"),$7=Bt("extrude"),W7=Bt("lathe"),j7=Bt("capsule"),J7=Bt("shape",({geometry:n})=>{const e=n.attributes.position,t=new st().setFromBufferAttribute(e),i=new b;t.getSize(i);const s=[];let r=0,o=0,a=0,c=0;for(let l=0;l<e.count;l++)r=e.getX(l),o=e.getY(l),a=(r-t.min.x)/i.x,c=(o-t.min.y)/i.y,s.push(a,c);n.setAttribute("uv",new Rt(s,2))}),$i=1e-5;function Ow(n,e,t){const i=new o1,s=t-$i;return i.absarc($i,$i,$i,-Math.PI/2,-Math.PI,!0),i.absarc($i,e-s*2,$i,Math.PI,Math.PI/2,!0),i.absarc(n-s*2,e-s*2,$i,Math.PI/2,0,!0),i.absarc(n-s*2,$i,$i,0,-Math.PI/2,!0),i}const q7=A.forwardRef(function({args:[e=1,t=1,i=1]=[],radius:s=.05,steps:r=1,smoothness:o=4,bevelSegments:a=4,creaseAngle:c=.4,children:l,...u},h){const f=A.useMemo(()=>Ow(e,t,s),[e,t,s]),d=A.useMemo(()=>({depth:i-s*2,bevelEnabled:!0,bevelSegments:a*2,steps:r,bevelSize:s-$i,bevelThickness:s,curveSegments:o}),[i,s,o]),p=A.useRef(null);return A.useLayoutEffect(()=>{p.current&&(p.current.center(),z1(p.current,c))},[f,d]),A.createElement("mesh",ie({ref:h},u),A.createElement("extrudeGeometry",{ref:p,args:[f,d]}),l)});function Uw(){const n=new St,e=new Float32Array([-1,-1,3,-1,-1,3]);return n.boundingSphere=new si,n.boundingSphere.set(new b,1/0),n.setAttribute("position",new Ye(e,2)),n}const X7=A.forwardRef(function({children:e,...t},i){const s=A.useMemo(Uw,[]);return A.createElement("mesh",ie({ref:i,geometry:s,frustumCulled:!1},t),e)}),Z7=A.forwardRef(({children:n,width:e,height:t,depth:i,box3:s,precise:r=!0,...o},a)=>{const c=A.useRef(null),l=A.useRef(null),u=A.useRef(null);return A.useLayoutEffect(()=>{l.current.matrixWorld.identity();let h=s||new st().setFromObject(u.current,r);const f=h.max.x-h.min.x,d=h.max.y-h.min.y,p=h.max.z-h.min.z;let m=Math.max(f,d,p);e&&(m=f),t&&(m=d),i&&(m=p),l.current.scale.setScalar(1/m)},[e,t,i,s,r]),A.useImperativeHandle(a,()=>c.current,[]),A.createElement("group",ie({ref:c},o),A.createElement("group",{ref:l},A.createElement("group",{ref:u},n)))});var yi=function(n){return n[n.NONE=0]="NONE",n[n.START=1]="START",n[n.ACTIVE=2]="ACTIVE",n}(yi||{});const $n=n=>n&&n.isOrthographicCamera,Qw=n=>n&&n.isBox3,Nw=n=>1-Math.exp(-5*n)+.007*n,b2=A.createContext(null);function Gw({children:n,maxDuration:e=1,margin:t=1.2,observe:i,fit:s,clip:r,interpolateFunc:o=Nw,onFit:a}){const c=A.useRef(null),{camera:l,size:u,invalidate:h}=Z(),f=Z(x=>x.controls),d=A.useRef(a);d.current=a;const p=A.useRef({camPos:new b,camRot:new Be,camZoom:1}),m=A.useRef({camPos:void 0,camRot:void 0,camZoom:void 0,camUp:void 0,target:void 0}),g=A.useRef(yi.NONE),y=A.useRef(0),[v]=A.useState(()=>new st),E=A.useMemo(()=>{function x(){const I=v.getSize(new b),S=v.getCenter(new b),w=Math.max(I.x,I.y,I.z),B=$n(l)?w*4:w/(2*Math.atan(Math.PI*l.fov/360)),T=$n(l)?w*4:B/l.aspect,R=t*Math.max(B,T);return{box:v,size:I,center:S,distance:R}}return{getSize:x,refresh(I){if(Qw(I))v.copy(I);else{const S=I||c.current;if(!S)return this;S.updateWorldMatrix(!0,!0),v.setFromObject(S)}if(v.isEmpty()){const S=l.position.length()||10;v.setFromCenterAndSize(new b,new b(S,S,S))}return p.current.camPos.copy(l.position),p.current.camRot.copy(l.quaternion),$n(l)&&(p.current.camZoom=l.zoom),m.current.camPos=void 0,m.current.camRot=void 0,m.current.camZoom=void 0,m.current.camUp=void 0,m.current.target=void 0,this},reset(){const{center:I,distance:S}=x(),w=l.position.clone().sub(I).normalize();m.current.camPos=I.clone().addScaledVector(w,S),m.current.target=I.clone();const B=new ce().lookAt(m.current.camPos,m.current.target,l.up);return m.current.camRot=new Be().setFromRotationMatrix(B),g.current=yi.START,y.current=0,this},moveTo(I){return m.current.camPos=Array.isArray(I)?new b(...I):I.clone(),g.current=yi.START,y.current=0,this},lookAt({target:I,up:S}){m.current.target=Array.isArray(I)?new b(...I):I.clone(),S?m.current.camUp=Array.isArray(S)?new b(...S):S.clone():m.current.camUp=l.up.clone();const w=new ce().lookAt(m.current.camPos||l.position,m.current.target,m.current.camUp);return m.current.camRot=new Be().setFromRotationMatrix(w),g.current=yi.START,y.current=0,this},to({position:I,target:S}){return this.moveTo(I).lookAt({target:S})},fit(){if(!$n(l))return this.reset();let I=0,S=0;const w=[new b(v.min.x,v.min.y,v.min.z),new b(v.min.x,v.max.y,v.min.z),new b(v.min.x,v.min.y,v.max.z),new b(v.min.x,v.max.y,v.max.z),new b(v.max.x,v.max.y,v.max.z),new b(v.max.x,v.max.y,v.min.z),new b(v.max.x,v.min.y,v.max.z),new b(v.max.x,v.min.y,v.min.z)],B=m.current.camPos||l.position,T=m.current.target||(f==null?void 0:f.target),R=m.current.camUp||l.up,_=T?new ce().lookAt(B,T,R).setPosition(B).invert():l.matrixWorldInverse;for(const U of w)U.applyMatrix4(_),I=Math.max(I,Math.abs(U.y)),S=Math.max(S,Math.abs(U.x));I*=2,S*=2;const L=(l.top-l.bottom)/I,O=(l.right-l.left)/S;return m.current.camZoom=Math.min(L,O)/t,g.current=yi.START,y.current=0,d.current&&d.current(this.getSize()),this},clip(){const{distance:I}=x();return l.near=I/100,l.far=I*100,l.updateProjectionMatrix(),f&&(f.maxDistance=I*10,f.update()),h(),this}}},[v,l,f,t,h]);A.useLayoutEffect(()=>{if(f){const x=()=>{if(f&&m.current.target&&g.current!==yi.NONE){const I=new b().setFromMatrixColumn(l.matrix,2),S=p.current.camPos.distanceTo(f.target),w=(m.current.camPos||p.current.camPos).distanceTo(m.current.target),B=(1-y.current)*S+y.current*w;f.target.copy(l.position).addScaledVector(I,-B),f.update()}g.current=yi.NONE};return f.addEventListener("start",x),()=>f.removeEventListener("start",x)}},[f]);const C=A.useRef(0);return A.useLayoutEffect(()=>{(i||C.current++===0)&&(E.refresh(),s&&E.reset().fit(),r&&E.clip())},[u,r,s,i,l,f]),Ee((x,I)=>{if(g.current===yi.START)g.current=yi.ACTIVE,h();else if(g.current===yi.ACTIVE){if(y.current+=I/e,y.current>=1)m.current.camPos&&l.position.copy(m.current.camPos),m.current.camRot&&l.quaternion.copy(m.current.camRot),m.current.camUp&&l.up.copy(m.current.camUp),m.current.camZoom&&$n(l)&&(l.zoom=m.current.camZoom),l.updateMatrixWorld(),l.updateProjectionMatrix(),f&&m.current.target&&(f.target.copy(m.current.target),f.update()),g.current=yi.NONE;else{const S=o(y.current);m.current.camPos&&l.position.lerpVectors(p.current.camPos,m.current.camPos,S),m.current.camRot&&l.quaternion.slerpQuaternions(p.current.camRot,m.current.camRot,S),m.current.camUp&&l.up.set(0,1,0).applyQuaternion(l.quaternion),m.current.camZoom&&$n(l)&&(l.zoom=(1-S)*p.current.camZoom+S*m.current.camZoom),l.updateMatrixWorld(),l.updateProjectionMatrix()}h()}}),A.createElement("group",{ref:c},A.createElement(b2.Provider,{value:E},n))}function zw(){return A.useContext(b2)}const eb=A.forwardRef(({intensity:n=1,decay:e,decayRate:t=.65,maxYaw:i=.1,maxPitch:s=.1,maxRoll:r=.1,yawFrequency:o=.1,pitchFrequency:a=.1,rollFrequency:c=.1},l)=>{const u=Z(v=>v.camera),h=Z(v=>v.controls),f=A.useRef(n),d=A.useRef(u.rotation.clone()),[p]=A.useState(()=>new cl),[m]=A.useState(()=>new cl),[g]=A.useState(()=>new cl),y=()=>{(f.current<0||f.current>1)&&(f.current=f.current<0?0:1)};return A.useImperativeHandle(l,()=>({getIntensity:()=>f.current,setIntensity:v=>{f.current=v,y()}}),[]),A.useEffect(()=>{if(h){const v=()=>void(d.current=u.rotation.clone());return h.addEventListener("change",v),v(),()=>void h.removeEventListener("change",v)}},[u,h]),Ee((v,E)=>{const C=Math.pow(f.current,2),x=i*C*p.noise(v.clock.elapsedTime*o,1),I=s*C*m.noise(v.clock.elapsedTime*a,1),S=r*C*g.noise(v.clock.elapsedTime*c,1);u.rotation.set(d.current.x+I,d.current.y+x,d.current.z+S),e&&f.current>0&&(f.current-=t*E,y())}),null}),Hw=A.forwardRef(({scale:n=10,frames:e=1/0,opacity:t=1,width:i=1,height:s=1,blur:r=1,near:o=0,far:a=10,resolution:c=512,smooth:l=!0,color:u="#000000",depthWrite:h=!1,renderOrder:f,...d},p)=>{const m=A.useRef(null),g=Z(O=>O.scene),y=Z(O=>O.gl),v=A.useRef(null);i=i*(Array.isArray(n)?n[0]:n||1),s=s*(Array.isArray(n)?n[1]:n||1);const[E,C,x,I,S,w,B]=A.useMemo(()=>{const O=new It(c,c),U=new It(c,c);U.texture.generateMipmaps=O.texture.generateMipmaps=!1;const Q=new Ji(i,s).rotateX(Math.PI/2),G=new ye(Q),z=new jy;z.depthTest=z.depthWrite=!1,z.onBeforeCompile=V=>{V.uniforms={...V.uniforms,ucolor:{value:new xe(u)}},V.fragmentShader=V.fragmentShader.replace("void main() {",`uniform vec3 ucolor;
           void main() {
          `),V.fragmentShader=V.fragmentShader.replace("vec4( vec3( 1.0 - fragCoordZ ), opacity );","vec4( ucolor * fragCoordZ * 2.0, ( 1.0 - fragCoordZ ) * 1.0 );")};const H=new Dt(E4),N=new Dt(v4);return N.depthTest=H.depthTest=!1,[O,Q,z,G,H,N,U]},[c,i,s,n,u]),T=O=>{I.visible=!0,I.material=S,S.uniforms.tDiffuse.value=E.texture,S.uniforms.h.value=O*1/256,y.setRenderTarget(B),y.render(I,v.current),I.material=w,w.uniforms.tDiffuse.value=B.texture,w.uniforms.v.value=O*1/256,y.setRenderTarget(E),y.render(I,v.current),I.visible=!1};let R=0,_,L;return Ee(()=>{v.current&&(e===1/0||R<e)&&(R++,_=g.background,L=g.overrideMaterial,m.current.visible=!1,g.background=null,g.overrideMaterial=x,y.setRenderTarget(E),y.render(g,v.current),T(r),l&&T(r*.4),y.setRenderTarget(null),m.current.visible=!0,g.overrideMaterial=L,g.background=_)}),A.useImperativeHandle(p,()=>m.current,[]),A.createElement("group",ie({"rotation-x":Math.PI/2},d,{ref:m}),A.createElement("mesh",{renderOrder:f,geometry:C,scale:[1,-1,1],rotation:[-Math.PI/2,0,0]},A.createElement("meshBasicMaterial",{transparent:!0,map:E.texture,opacity:t,depthWrite:h})),A.createElement("orthographicCamera",{ref:v,args:[-i/2,i/2,s/2,-s/2,o,a]}))});function Kw(n){return n.isLight}function Vw(n){return!!n.geometry}const R2=A.createContext(null),Yw=Ri({color:new xe,blend:2,alphaTest:.75,opacity:0,map:null},`varying vec2 vUv;
   void main() {
     gl_Position = projectionMatrix * viewMatrix * modelMatrix * vec4(position, 1.);
     vUv = uv;
   }`,`varying vec2 vUv;
   uniform sampler2D map;
   uniform vec3 color;
   uniform float opacity;
   uniform float alphaTest;
   uniform float blend;
   void main() {
     vec4 sampledDiffuseColor = texture2D(map, vUv);
     gl_FragColor = vec4(color * sampledDiffuseColor.r * blend, max(0.0, (1.0 - (sampledDiffuseColor.r + sampledDiffuseColor.g + sampledDiffuseColor.b) / alphaTest)) * opacity);
     #include <tonemapping_fragment>
     #include <${qt>=154?"colorspace_fragment":"encodings_fragment"}>
   }`),$w=A.forwardRef(({children:n,temporal:e,frames:t=40,limit:i=1/0,blend:s=20,scale:r=10,opacity:o=1,alphaTest:a=.75,color:c="black",colorBlend:l=2,resolution:u=1024,toneMapped:h=!0,...f},d)=>{dt({SoftShadowMaterial:Yw});const p=Z(I=>I.gl),m=Z(I=>I.scene),g=Z(I=>I.camera),y=Z(I=>I.invalidate),v=A.useRef(null),E=A.useRef(null),[C]=A.useState(()=>new jw(p,m,u));A.useLayoutEffect(()=>{C.configure(v.current)},[]);const x=A.useMemo(()=>({lights:new Map,temporal:!!e,frames:Math.max(2,t),blend:Math.max(2,t===1/0?s:t),count:0,getMesh:()=>v.current,reset:()=>{C.clear();const I=v.current.material;I.opacity=0,I.alphaTest=0,x.count=0},update:(I=1)=>{const S=v.current.material;x.temporal?(S.opacity=Math.min(o,S.opacity+o/x.blend),S.alphaTest=Math.min(a,S.alphaTest+a/x.blend)):(S.opacity=o,S.alphaTest=a),E.current.visible=!0,C.prepare();for(let w=0;w<I;w++)x.lights.forEach(B=>B.update()),C.update(g,x.blend);E.current.visible=!1,C.finish()}}),[C,g,m,e,t,s,o,a]);return A.useLayoutEffect(()=>{x.reset(),!x.temporal&&x.frames!==1/0&&x.update(x.blend)}),A.useImperativeHandle(d,()=>x,[x]),Ee(()=>{(x.temporal||x.frames===1/0)&&x.count<x.frames&&x.count<i&&(y(),x.update(),x.count++)}),A.createElement("group",f,A.createElement("group",{traverse:()=>null,ref:E},A.createElement(R2.Provider,{value:x},n)),A.createElement("mesh",{receiveShadow:!0,ref:v,scale:r,rotation:[-Math.PI/2,0,0]},A.createElement("planeGeometry",null),A.createElement("softShadowMaterial",{transparent:!0,depthWrite:!1,toneMapped:h,color:c,blend:l,map:C.progressiveLightMap2.texture})))}),Ww=A.forwardRef(({castShadow:n=!0,bias:e=.001,mapSize:t=512,size:i=5,near:s=.5,far:r=500,frames:o=1,position:a=[0,0,0],radius:c=1,amount:l=8,intensity:u=qt>=155?Math.PI:1,ambient:h=.5,...f},d)=>{const p=A.useRef(null),m=new b(...a).length(),g=A.useContext(R2),y=A.useCallback(()=>{let E;if(p.current)for(let C=0;C<p.current.children.length;C++)if(E=p.current.children[C],Math.random()>h)E.position.set(a[0]+Ce.randFloatSpread(c),a[1]+Ce.randFloatSpread(c),a[2]+Ce.randFloatSpread(c));else{let x=Math.acos(2*Math.random()-1)-Math.PI/2,I=2*Math.PI*Math.random();E.position.set(Math.cos(x)*Math.cos(I)*m,Math.abs(Math.cos(x)*Math.sin(I)*m),Math.sin(x)*m)}},[c,h,m,...a]),v=A.useMemo(()=>({update:y}),[y]);return A.useImperativeHandle(d,()=>v,[v]),A.useLayoutEffect(()=>{var E;const C=p.current;return g&&((E=g.lights)==null||E.set(C.uuid,v)),()=>{var x;return void(g==null||(x=g.lights)==null?void 0:x.delete(C.uuid))}},[g,v]),A.createElement("group",ie({ref:p},f),Array.from({length:l},(E,C)=>A.createElement("directionalLight",{key:C,castShadow:n,"shadow-bias":e,"shadow-mapSize":[t,t],intensity:u/l},A.createElement("orthographicCamera",{attach:"shadow-camera",args:[-i,i,i,-i,s,r]}))))});class jw{constructor(e,t,i=1024){this.renderer=e,this.res=i,this.scene=t,this.buffer1Active=!1,this.lights=[],this.meshes=[],this.object=null,this.clearColor=new xe,this.clearAlpha=0;const s={type:Qi,magFilter:Xe,minFilter:Xe};this.progressiveLightMap1=new It(this.res,this.res,s),this.progressiveLightMap2=new It(this.res,this.res,s),this.discardMat=new Bf,this.targetMat=new Lh({fog:!1}),this.previousShadowMap={value:this.progressiveLightMap1.texture},this.averagingWindow={value:100},this.targetMat.onBeforeCompile=r=>{r.vertexShader=`varying vec2 vUv;
`+r.vertexShader.slice(0,-1)+"vUv = uv; gl_Position = vec4((uv - 0.5) * 2.0, 1.0, 1.0); }";const o=r.fragmentShader.indexOf("void main() {");r.fragmentShader=`varying vec2 vUv;
`+r.fragmentShader.slice(0,o)+`uniform sampler2D previousShadowMap;
	uniform float averagingWindow;
`+r.fragmentShader.slice(o-1,-1)+`
vec3 texelOld = texture2D(previousShadowMap, vUv).rgb;
        gl_FragColor.rgb = mix(texelOld, gl_FragColor.rgb, 1.0/ averagingWindow);
      }`,r.uniforms.previousShadowMap=this.previousShadowMap,r.uniforms.averagingWindow=this.averagingWindow}}clear(){this.renderer.getClearColor(this.clearColor),this.clearAlpha=this.renderer.getClearAlpha(),this.renderer.setClearColor("black",1),this.renderer.setRenderTarget(this.progressiveLightMap1),this.renderer.clear(),this.renderer.setRenderTarget(this.progressiveLightMap2),this.renderer.clear(),this.renderer.setRenderTarget(null),this.renderer.setClearColor(this.clearColor,this.clearAlpha),this.lights=[],this.meshes=[],this.scene.traverse(e=>{Vw(e)?this.meshes.push({object:e,material:e.material}):Kw(e)&&this.lights.push({object:e,intensity:e.intensity})})}prepare(){this.lights.forEach(e=>e.object.intensity=0),this.meshes.forEach(e=>e.object.material=this.discardMat)}finish(){this.lights.forEach(e=>e.object.intensity=e.intensity),this.meshes.forEach(e=>e.object.material=e.material)}configure(e){this.object=e}update(e,t=100){if(!this.object)return;this.averagingWindow.value=t,this.object.material=this.targetMat;const i=this.buffer1Active?this.progressiveLightMap1:this.progressiveLightMap2,s=this.buffer1Active?this.progressiveLightMap2:this.progressiveLightMap1,r=this.scene.background;this.scene.background=null,this.renderer.setRenderTarget(i),this.previousShadowMap.value=s.texture,this.buffer1Active=!this.buffer1Active,this.renderer.render(this.scene,e),this.renderer.setRenderTarget(null),this.scene.background=r}}const Jw={rembrandt:{main:[1,2,1],fill:[-2,-.5,-2]},portrait:{main:[-1,2,.5],fill:[-1,.5,-1.5]},upfront:{main:[0,2,1],fill:[-1,.5,-1.5]},soft:{main:[-2,4,4],fill:[-1,.5,-1.5]}};function qw({radius:n,adjustCamera:e}){const t=zw();return A.useEffect(()=>{e&&t.refresh().clip().fit()},[n,e]),null}function tb({children:n,center:e,adjustCamera:t=!0,intensity:i=.5,shadows:s="contact",environment:r="city",preset:o="rembrandt",...a}){var c,l,u,h,f,d,p,m;const g=typeof o=="string"?Jw[o]:o,[{radius:y,height:v},E]=A.useState({radius:0,width:0,height:0,depth:0}),C=(c=s==null?void 0:s.bias)!==null&&c!==void 0?c:-1e-4,x=(l=s==null?void 0:s.normalBias)!==null&&l!==void 0?l:0,I=(u=s==null?void 0:s.size)!==null&&u!==void 0?u:1024,S=(h=s==null?void 0:s.offset)!==null&&h!==void 0?h:0,w=s==="contact"||(s==null?void 0:s.type)==="contact",B=s==="accumulative"||(s==null?void 0:s.type)==="accumulative",T={...typeof s=="object"?s:{}},R=r?typeof r=="string"?{preset:r}:r:null,_=A.useCallback(L=>{const{width:O,height:U,depth:Q,boundingSphere:G}=L;E({radius:G.radius,width:O,height:U,depth:Q}),e!=null&&e.onCentered&&e.onCentered(L)},[]);return A.createElement(A.Fragment,null,A.createElement("ambientLight",{intensity:i/3}),A.createElement("spotLight",{penumbra:1,position:[g.main[0]*y,g.main[1]*y,g.main[2]*y],intensity:i*2,castShadow:!!s,"shadow-bias":C,"shadow-normalBias":x,"shadow-mapSize":I}),A.createElement("pointLight",{position:[g.fill[0]*y,g.fill[1]*y,g.fill[2]*y],intensity:i}),A.createElement(Gw,ie({fit:!!t,clip:!!t,margin:Number(t),observe:!0},a),A.createElement(qw,{radius:y,adjustCamera:t}),A.createElement(E2,ie({},e,{position:[0,S/2,0],onCentered:_}),n)),A.createElement("group",{position:[0,-v/2-S/2,0]},w&&A.createElement(Hw,ie({scale:y*4,far:y,blur:2},T)),B&&A.createElement($w,ie({temporal:!0,frames:100,alphaTest:.9,toneMapped:!0,scale:y*4},T),A.createElement(Ww,{amount:(f=T.amount)!==null&&f!==void 0?f:8,radius:(d=T.radius)!==null&&d!==void 0?d:y,ambient:(p=T.ambient)!==null&&p!==void 0?p:.5,intensity:(m=T.intensity)!==null&&m!==void 0?m:1,position:[g.main[0]*y,g.main[1]*y,g.main[2]*y],size:y*4,bias:-C,mapSize:I}))),r&&A.createElement(Jy,R))}const Xw=n=>n===0?0:Math.pow(2,10*n-10);function ib({children:n,floor:e=.25,segments:t=20,receiveShadow:i,...s}){const r=A.useRef(null);return A.useLayoutEffect(()=>{let o=0;const a=t/t/2,c=r.current.attributes.position;for(let l=0;l<t+1;l++)for(let u=0;u<t+1;u++)c.setXYZ(o++,l/t-a+(l===0?-e:0),u/t-a,Xw(l/t));c.needsUpdate=!0,r.current.computeVertexNormals()},[t,e]),A.createElement("group",s,A.createElement("mesh",{receiveShadow:i,rotation:[-Math.PI/2,0,Math.PI/2]},A.createElement("planeGeometry",{ref:r,args:[1,1,t,t]}),n))}const sb=A.forwardRef(({fog:n=!1,renderOrder:e,depthWrite:t=!1,colorStop:i=0,color:s="black",opacity:r=.5,...o},a)=>{const c=A.useMemo(()=>{const l=document.createElement("canvas");l.width=128,l.height=128;const u=l.getContext("2d"),h=u.createRadialGradient(l.width/2,l.height/2,0,l.width/2,l.height/2,l.width/2);return h.addColorStop(i,new xe(s).getStyle()),h.addColorStop(1,"rgba(0,0,0,0)"),u.fillStyle=h,u.fillRect(0,0,l.width,l.height),l},[s,i]);return A.createElement("mesh",ie({renderOrder:e,ref:a,"rotation-x":-Math.PI/2},o),A.createElement("planeGeometry",null),A.createElement("meshBasicMaterial",{transparent:!0,opacity:r,fog:n,depthWrite:t,side:Tt},A.createElement("canvasTexture",{attach:"map",args:[c]})))});function nm(n=Do){const e={value:new ce};return Object.assign(new Zy({side:n}),{viewMatrix:e,onBeforeCompile:t=>{t.uniforms.viewMatrix=e,t.fragmentShader=`vec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {
           return normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );
         }
`+t.fragmentShader.replace("#include <normal_fragment_maps>",`#include <normal_fragment_maps>
           normal = inverseTransformDirection( normal, viewMatrix );
`)}})}const Zw=Ri({causticsTexture:null,causticsTextureB:null,color:new xe,lightProjMatrix:new ce,lightViewMatrix:new ce},`varying vec3 vWorldPosition;
   void main() {
     gl_Position = projectionMatrix * viewMatrix * modelMatrix * vec4(position, 1.);
     vec4 worldPosition = modelMatrix * vec4(position, 1.);
     vWorldPosition = worldPosition.xyz;
   }`,`varying vec3 vWorldPosition;
  uniform vec3 color;
  uniform sampler2D causticsTexture;
  uniform sampler2D causticsTextureB;
  uniform mat4 lightProjMatrix;
  uniform mat4 lightViewMatrix;
   void main() {
    // Apply caustics
    vec4 lightSpacePos = lightProjMatrix * lightViewMatrix * vec4(vWorldPosition, 1.0);
    lightSpacePos.xyz /= lightSpacePos.w;
    lightSpacePos.xyz = lightSpacePos.xyz * 0.5 + 0.5;
    vec3 front = texture2D(causticsTexture, lightSpacePos.xy).rgb;
    vec3 back = texture2D(causticsTextureB, lightSpacePos.xy).rgb;
    gl_FragColor = vec4((front + back) * color, 1.0);
    #include <tonemapping_fragment>
    #include <${qt>=154?"colorspace_fragment":"encodings_fragment"}>
   }`),eT=Ri({cameraMatrixWorld:new ce,cameraProjectionMatrixInv:new ce,normalTexture:null,depthTexture:null,lightDir:new b(0,1,0),lightPlaneNormal:new b(0,1,0),lightPlaneConstant:0,near:.1,far:100,modelMatrix:new ce,worldRadius:1/40,ior:1.1,bounces:0,resolution:1024,size:10,intensity:.5},`
  varying vec2 vUv;
  void main() {
      vUv = uv;
      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
  }`,`
  uniform mat4 cameraMatrixWorld;
  uniform mat4 cameraProjectionMatrixInv;
  uniform vec3 lightDir;
  uniform vec3 lightPlaneNormal;
  uniform float lightPlaneConstant;
  uniform float near;
  uniform float far;
  uniform float time;
  uniform float worldRadius;
  uniform float resolution;
  uniform float size;
  uniform float intensity;
  uniform float ior;
  precision highp isampler2D;
  precision highp usampler2D;
  uniform sampler2D normalTexture;
  uniform sampler2D depthTexture;
  uniform float bounces;
  varying vec2 vUv;
  vec3 WorldPosFromDepth(float depth, vec2 coord) {
    float z = depth * 2.0 - 1.0;
    vec4 clipSpacePosition = vec4(coord * 2.0 - 1.0, z, 1.0);
    vec4 viewSpacePosition = cameraProjectionMatrixInv * clipSpacePosition;
    // Perspective division
    viewSpacePosition /= viewSpacePosition.w;
    vec4 worldSpacePosition = cameraMatrixWorld * viewSpacePosition;
    return worldSpacePosition.xyz;
  }
  float sdPlane( vec3 p, vec3 n, float h ) {
    // n must be normalized
    return dot(p,n) + h;
  }
  float planeIntersect( vec3 ro, vec3 rd, vec4 p ) {
    return -(dot(ro,p.xyz)+p.w)/dot(rd,p.xyz);
  }
  vec3 totalInternalReflection(vec3 ro, vec3 rd, vec3 pos, vec3 normal, float ior, out vec3 rayOrigin, out vec3 rayDirection) {
    rayOrigin = ro;
    rayDirection = rd;
    rayDirection = refract(rayDirection, normal, 1.0 / ior);
    rayOrigin = pos + rayDirection * 0.1;
    return rayDirection;
  }
  void main() {
    // Each sample consists of random offset in the x and y direction
    float caustic = 0.0;
    float causticTexelSize = (1.0 / resolution) * size * 2.0;
    float texelsNeeded = worldRadius / causticTexelSize;
    float sampleRadius = texelsNeeded / resolution;
    float sum = 0.0;
    if (texture2D(depthTexture, vUv).x == 1.0) {
      gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
      return;
    }
    vec2 offset1 = vec2(-0.5, -0.5);//vec2(rand() - 0.5, rand() - 0.5);
    vec2 offset2 = vec2(-0.5, 0.5);//vec2(rand() - 0.5, rand() - 0.5);
    vec2 offset3 = vec2(0.5, 0.5);//vec2(rand() - 0.5, rand() - 0.5);
    vec2 offset4 = vec2(0.5, -0.5);//vec2(rand() - 0.5, rand() - 0.5);
    vec2 uv1 = vUv + offset1 * sampleRadius;
    vec2 uv2 = vUv + offset2 * sampleRadius;
    vec2 uv3 = vUv + offset3 * sampleRadius;
    vec2 uv4 = vUv + offset4 * sampleRadius;
    vec3 normal1 = texture2D(normalTexture, uv1, -10.0).rgb * 2.0 - 1.0;
    vec3 normal2 = texture2D(normalTexture, uv2, -10.0).rgb * 2.0 - 1.0;
    vec3 normal3 = texture2D(normalTexture, uv3, -10.0).rgb * 2.0 - 1.0;
    vec3 normal4 = texture2D(normalTexture, uv4, -10.0).rgb * 2.0 - 1.0;
    float depth1 = texture2D(depthTexture, uv1, -10.0).x;
    float depth2 = texture2D(depthTexture, uv2, -10.0).x;
    float depth3 = texture2D(depthTexture, uv3, -10.0).x;
    float depth4 = texture2D(depthTexture, uv4, -10.0).x;
    // Sanity check the depths
    if (depth1 == 1.0 || depth2 == 1.0 || depth3 == 1.0 || depth4 == 1.0) {
      gl_FragColor = vec4(0.0, 0.0, 0.0, 1.0);
      return;
    }
    vec3 pos1 = WorldPosFromDepth(depth1, uv1);
    vec3 pos2 = WorldPosFromDepth(depth2, uv2);
    vec3 pos3 = WorldPosFromDepth(depth3, uv3);
    vec3 pos4 = WorldPosFromDepth(depth4, uv4);
    vec3 originPos1 = WorldPosFromDepth(0.0, uv1);
    vec3 originPos2 = WorldPosFromDepth(0.0, uv2);
    vec3 originPos3 = WorldPosFromDepth(0.0, uv3);
    vec3 originPos4 = WorldPosFromDepth(0.0, uv4);
    vec3 endPos1, endPos2, endPos3, endPos4;
    vec3 endDir1, endDir2, endDir3, endDir4;
    totalInternalReflection(originPos1, lightDir, pos1, normal1, ior, endPos1, endDir1);
    totalInternalReflection(originPos2, lightDir, pos2, normal2, ior, endPos2, endDir2);
    totalInternalReflection(originPos3, lightDir, pos3, normal3, ior, endPos3, endDir3);
    totalInternalReflection(originPos4, lightDir, pos4, normal4, ior, endPos4, endDir4);
    float lightPosArea = length(cross(originPos2 - originPos1, originPos3 - originPos1)) + length(cross(originPos3 - originPos1, originPos4 - originPos1));
    float t1 = planeIntersect(endPos1, endDir1, vec4(lightPlaneNormal, lightPlaneConstant));
    float t2 = planeIntersect(endPos2, endDir2, vec4(lightPlaneNormal, lightPlaneConstant));
    float t3 = planeIntersect(endPos3, endDir3, vec4(lightPlaneNormal, lightPlaneConstant));
    float t4 = planeIntersect(endPos4, endDir4, vec4(lightPlaneNormal, lightPlaneConstant));
    vec3 finalPos1 = endPos1 + endDir1 * t1;
    vec3 finalPos2 = endPos2 + endDir2 * t2;
    vec3 finalPos3 = endPos3 + endDir3 * t3;
    vec3 finalPos4 = endPos4 + endDir4 * t4;
    float finalArea = length(cross(finalPos2 - finalPos1, finalPos3 - finalPos1)) + length(cross(finalPos3 - finalPos1, finalPos4 - finalPos1));
    caustic += intensity * (lightPosArea / finalArea);
    // Calculate the area of the triangle in light spaces
    gl_FragColor = vec4(vec3(max(caustic, 0.0)), 1.0);
  }`),rm={depth:!0,minFilter:zt,magFilter:zt,type:Yt},om={minFilter:Po,magFilter:zt,type:Jt,generateMipmaps:!0},nb=A.forwardRef(({debug:n,children:e,frames:t=1,ior:i=1.1,color:s="white",causticsOnly:r=!1,backside:o=!1,backsideIOR:a=1.1,worldRadius:c=.3125,intensity:l=.05,resolution:u=2024,lightSource:h=[5,5,5],...f},d)=>{dt({CausticsProjectionMaterial:Zw});const p=A.useRef(null),m=A.useRef(null),g=A.useRef(null),y=A.useRef(null),v=Z(P=>P.gl),E=s2(n&&m,qy),C=wi(u,u,rm),x=wi(u,u,rm),I=wi(u,u,om),S=wi(u,u,om),[w]=A.useState(()=>nm()),[B]=A.useState(()=>nm(Cr)),[T]=A.useState(()=>new eT),[R]=A.useState(()=>new xs(T));A.useLayoutEffect(()=>{p.current.updateWorldMatrix(!1,!0)});let _=0;const L=new b,O=new r1,U=new ce,Q=new bs,G=new b,z=new b,H=new st,N=new b,V=[],$=[],Y=[],M=[],k=new b;for(let P=0;P<8;P++)V.push(new b),$.push(new b),Y.push(new b),M.push(new b);return Ee(()=>{if(t===1/0||_++<t){var P,F;Array.isArray(h)?G.fromArray(h).normalize():G.copy(p.current.worldToLocal(h.current.getWorldPosition(L)).normalize()),z.copy(G).multiplyScalar(-1),(P=g.current.parent)==null||P.matrixWorld.identity(),H.setFromObject(g.current,!0),V[0].set(H.min.x,H.min.y,H.min.z),V[1].set(H.min.x,H.min.y,H.max.z),V[2].set(H.min.x,H.max.y,H.min.z),V[3].set(H.min.x,H.max.y,H.max.z),V[4].set(H.max.x,H.min.y,H.min.z),V[5].set(H.max.x,H.min.y,H.max.z),V[6].set(H.max.x,H.max.y,H.min.z),V[7].set(H.max.x,H.max.y,H.max.z);for(let K=0;K<8;K++)$[K].copy(V[K]);H.getCenter(N),V.map(K=>K.sub(N));const J=Q.set(z,0);V.map((K,pe)=>J.projectPoint(K,Y[pe]));const se=Y.reduce((K,pe)=>K.add(pe),L.set(0,0,0)).divideScalar(Y.length),q=Y.map(K=>K.distanceTo(se)).reduce((K,pe)=>Math.max(K,pe)),re=V.map(K=>K.dot(G)).reduce((K,pe)=>Math.max(K,pe));m.current.position.copy(k.copy(G).multiplyScalar(re).add(N)),m.current.lookAt(g.current.localToWorld(N));const he=U.lookAt(m.current.position,N,L.set(0,1,0));m.current.left=-q,m.current.right=q,m.current.top=q,m.current.bottom=-q;const fe=L.set(0,q,0).applyMatrix4(he),ae=(m.current.position.y+fe.y)/G.y;m.current.near=.1,m.current.far=ae,m.current.updateProjectionMatrix(),m.current.updateMatrixWorld();const ue=$.map((K,pe)=>K.add(M[pe].copy(G).multiplyScalar(-K.y/G.y))),ge=ue.reduce((K,pe)=>K.add(pe),L.set(0,0,0)).divideScalar(ue.length),me=2*ue.map(K=>Math.hypot(K.x-ge.x,K.z-ge.z)).reduce((K,pe)=>Math.max(K,pe));y.current.scale.setScalar(me),y.current.position.copy(ge),n&&((F=E.current)==null||F.update()),B.viewMatrix.value=w.viewMatrix.value=m.current.matrixWorldInverse;const W=O.setFromProjectionMatrix(U.multiplyMatrices(m.current.projectionMatrix,m.current.matrixWorldInverse)).planes[4];T.cameraMatrixWorld=m.current.matrixWorld,T.cameraProjectionMatrixInv=m.current.projectionMatrixInverse,T.lightDir=z,T.lightPlaneNormal=W.normal,T.lightPlaneConstant=W.constant,T.near=m.current.near,T.far=m.current.far,T.resolution=u,T.size=q,T.intensity=l,T.worldRadius=c,g.current.visible=!0,v.setRenderTarget(C),v.clear(),g.current.overrideMaterial=w,v.render(g.current,m.current),v.setRenderTarget(x),v.clear(),o&&(g.current.overrideMaterial=B,v.render(g.current,m.current)),g.current.overrideMaterial=null,T.ior=i,y.current.material.lightProjMatrix=m.current.projectionMatrix,y.current.material.lightViewMatrix=m.current.matrixWorldInverse,T.normalTexture=C.texture,T.depthTexture=C.depthTexture,v.setRenderTarget(I),v.clear(),R.render(v),T.ior=a,T.normalTexture=x.texture,T.depthTexture=x.depthTexture,v.setRenderTarget(S),v.clear(),o&&R.render(v),v.setRenderTarget(null),r&&(g.current.visible=!1)}}),A.useImperativeHandle(d,()=>p.current,[]),A.createElement("group",ie({ref:p},f),A.createElement("scene",{ref:g},A.createElement("orthographicCamera",{ref:m,up:[0,1,0]}),e),A.createElement("mesh",{renderOrder:2,ref:y,"rotation-x":-Math.PI/2},A.createElement("planeGeometry",null),A.createElement("causticsProjectionMaterial",{transparent:!0,color:s,causticsTexture:I.texture,causticsTextureB:S.texture,blending:l1,blendSrc:u1,blendDst:Xy,depthWrite:!1}),n&&A.createElement(UC,null,A.createElement("lineBasicMaterial",{color:"#ffff00",toneMapped:!1}))))}),rb=A.forwardRef(({mixBlur:n=0,mixStrength:e=.5,resolution:t=256,blur:i=[0,0],args:s=[1,1],minDepthThreshold:r=.9,maxDepthThreshold:o=1,depthScale:a=0,depthToBlurRatioBias:c=.25,mirror:l=0,children:u,debug:h=0,distortion:f=1,mixContrast:d=1,distortionMap:p,...m},g)=>{dt({MeshReflectorMaterial:_2}),A.useEffect(()=>{console.warn("Reflector has been deprecated and will be removed next major. Replace it with <MeshReflectorMaterial />!")},[]);const y=Z(({gl:Y})=>Y),v=Z(({camera:Y})=>Y),E=Z(({scene:Y})=>Y);i=Array.isArray(i)?i:[i,i];const C=i[0]+i[1]>0,x=A.useRef(null);A.useImperativeHandle(g,()=>x.current,[]);const[I]=A.useState(()=>new bs),[S]=A.useState(()=>new b),[w]=A.useState(()=>new b),[B]=A.useState(()=>new b),[T]=A.useState(()=>new ce),[R]=A.useState(()=>new b(0,0,-1)),[_]=A.useState(()=>new ft),[L]=A.useState(()=>new b),[O]=A.useState(()=>new b),[U]=A.useState(()=>new ft),[Q]=A.useState(()=>new ce),[G]=A.useState(()=>new nt),z=A.useCallback(()=>{if(w.setFromMatrixPosition(x.current.matrixWorld),B.setFromMatrixPosition(v.matrixWorld),T.extractRotation(x.current.matrixWorld),S.set(0,0,1),S.applyMatrix4(T),L.subVectors(w,B),L.dot(S)>0)return;L.reflect(S).negate(),L.add(w),T.extractRotation(v.matrixWorld),R.set(0,0,-1),R.applyMatrix4(T),R.add(B),O.subVectors(w,R),O.reflect(S).negate(),O.add(w),G.position.copy(L),G.up.set(0,1,0),G.up.applyMatrix4(T),G.up.reflect(S),G.lookAt(O),G.far=v.far,G.updateMatrixWorld(),G.projectionMatrix.copy(v.projectionMatrix),Q.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),Q.multiply(G.projectionMatrix),Q.multiply(G.matrixWorldInverse),Q.multiply(x.current.matrixWorld),I.setFromNormalAndCoplanarPoint(S,w),I.applyMatrix4(G.matrixWorldInverse),_.set(I.normal.x,I.normal.y,I.normal.z,I.constant);const Y=G.projectionMatrix;U.x=(Math.sign(_.x)+Y.elements[8])/Y.elements[0],U.y=(Math.sign(_.y)+Y.elements[9])/Y.elements[5],U.z=-1,U.w=(1+Y.elements[10])/Y.elements[14],_.multiplyScalar(2/_.dot(U)),Y.elements[2]=_.x,Y.elements[6]=_.y,Y.elements[10]=_.z+1,Y.elements[14]=_.w},[]),[H,N,V,$]=A.useMemo(()=>{const Y={type:Qi,minFilter:zt,magFilter:zt},M=new It(t,t,Y);M.depthBuffer=!0,M.depthTexture=new Uh(t,t),M.depthTexture.format=Qh,M.depthTexture.type=Mc;const k=new It(t,t,Y),P=new B2({gl:y,resolution:t,width:i[0],height:i[1],minDepthThreshold:r,maxDepthThreshold:o,depthScale:a,depthToBlurRatioBias:c}),F={mirror:l,textureMatrix:Q,mixBlur:n,tDiffuse:M.texture,tDepth:M.depthTexture,tDiffuseBlur:k.texture,hasBlur:C,mixStrength:e,minDepthThreshold:r,maxDepthThreshold:o,depthScale:a,depthToBlurRatioBias:c,transparent:!0,debug:h,distortion:f,distortionMap:p,mixContrast:d,"defines-USE_BLUR":C?"":void 0,"defines-USE_DEPTH":a>0?"":void 0,"defines-USE_DISTORTION":p?"":void 0};return[M,k,P,F]},[y,i,Q,t,l,C,n,e,r,o,a,c,h,f,p,d]);return Ee(()=>{if(!(x!=null&&x.current))return;x.current.visible=!1;const Y=y.xr.enabled,M=y.shadowMap.autoUpdate;z(),y.xr.enabled=!1,y.shadowMap.autoUpdate=!1,y.setRenderTarget(H),y.state.buffers.depth.setMask(!0),y.autoClear||y.clear(),y.render(E,G),C&&V.render(y,H,N),y.xr.enabled=Y,y.shadowMap.autoUpdate=M,x.current.visible=!0,y.setRenderTarget(null)}),A.createElement("mesh",ie({ref:x},m),A.createElement("planeGeometry",{args:s}),u?u("meshReflectorMaterial",$):A.createElement("meshReflectorMaterial",$))});class tT extends Dt{constructor(){super({uniforms:{depth:{value:null},opacity:{value:1},attenuation:{value:2.5},anglePower:{value:12},spotPosition:{value:new b(0,0,0)},lightColor:{value:new xe("white")},cameraNear:{value:0},cameraFar:{value:1},resolution:{value:new de(0,0)}},transparent:!0,depthWrite:!1,vertexShader:`
        varying vec3 vNormal;
        varying float vViewZ;
        varying float vIntensity;
        uniform vec3 spotPosition;
        uniform float attenuation;

        #include <common>
        #include <logdepthbuf_pars_vertex>

        void main() {
          // compute intensity
          vNormal = normalize(normalMatrix * normal);
          vec4 worldPosition = modelMatrix * vec4(position, 1);
          vec4 viewPosition = viewMatrix * worldPosition;
          vViewZ = viewPosition.z;

          vIntensity = 1.0 - saturate(distance(worldPosition.xyz, spotPosition) / attenuation);

          gl_Position = projectionMatrix * viewPosition;

          #include <logdepthbuf_vertex>
        }
      `,fragmentShader:`
        varying vec3 vNormal;
        varying float vViewZ;
        varying float vIntensity;

        uniform vec3 lightColor;
        uniform float anglePower;
        uniform sampler2D depth;
        uniform vec2 resolution;
        uniform float cameraNear;
        uniform float cameraFar;
        uniform float opacity;

        #include <packing>
        #include <logdepthbuf_pars_fragment>

        float readDepth(sampler2D depthSampler, vec2 uv) {
          float fragCoordZ = texture(depthSampler, uv).r;

          // https://github.com/mrdoob/three.js/issues/23072
          #ifdef USE_LOGDEPTHBUF
            float viewZ = 1.0 - exp2(fragCoordZ * log(cameraFar + 1.0) / log(2.0));
          #else
            float viewZ = perspectiveDepthToViewZ(fragCoordZ, cameraNear, cameraFar);
          #endif

          return viewZ;
        }

        void main() {
          #include <logdepthbuf_fragment>

          vec3 normal = vec3(vNormal.x, vNormal.y, abs(vNormal.z));
          float angleIntensity = pow(dot(normal, vec3(0, 0, 1)), anglePower);
          float intensity = vIntensity * angleIntensity;

          // fades when z is close to sampled depth, meaning the cone is intersecting existing geometry
          bool isSoft = resolution[0] > 0.0 && resolution[1] > 0.0;
          if (isSoft) {
            vec2 uv = gl_FragCoord.xy / resolution;
            intensity *= smoothstep(0.0, 1.0, vViewZ - readDepth(depth, uv));
          }

          gl_FragColor = vec4(lightColor, intensity * opacity);

          #include <tonemapping_fragment>
          #include <${qt>=154?"colorspace_fragment":"encodings_fragment"}>
        }
      `})}}var iT=`#define GLSLIFY 1
varying vec2 vUv;uniform sampler2D uShadowMap;uniform float uTime;void main(){vec3 color=texture2D(uShadowMap,vUv).xyz;gl_FragColor=vec4(color,1.);}`;const sT=n=>n==null?void 0:n.isSpotLight;function nT({opacity:n=1,radiusTop:e,radiusBottom:t,depthBuffer:i,color:s="white",distance:r=5,angle:o=.15,attenuation:a=5,anglePower:c=5}){const l=A.useRef(null),u=Z(g=>g.size),h=Z(g=>g.camera),f=Z(g=>g.viewport.dpr),[d]=A.useState(()=>new tT),[p]=A.useState(()=>new b);e=e===void 0?.1:e,t=t===void 0?o*7:t,Ee(()=>{d.uniforms.spotPosition.value.copy(l.current.getWorldPosition(p)),l.current.lookAt(l.current.parent.target.getWorldPosition(p))});const m=A.useMemo(()=>{const g=new gi(e,t,r,128,64,!0);return g.applyMatrix4(new ce().makeTranslation(0,-r/2,0)),g.applyMatrix4(new ce().makeRotationX(-Math.PI/2)),g},[r,e,t]);return A.createElement(A.Fragment,null,A.createElement("mesh",{ref:l,geometry:m,raycast:()=>null},A.createElement("primitive",{object:d,attach:"material","uniforms-opacity-value":n,"uniforms-lightColor-value":s,"uniforms-attenuation-value":a,"uniforms-anglePower-value":c,"uniforms-depth-value":i,"uniforms-cameraNear-value":h.near,"uniforms-cameraFar-value":h.far,"uniforms-resolution-value":i?[u.width*f,u.height*f]:[0,0]})))}function D2(n,e,t,i,s){const[[r,o]]=A.useState(()=>[new b,new b]);A.useLayoutEffect(()=>{if(sT(n.current))n.current.shadow.mapSize.set(t,i),n.current.shadow.needsUpdate=!0;else throw new Error("SpotlightShadow must be a child of a SpotLight")},[n,t,i]),Ee(()=>{if(!n.current)return;const a=n.current.position,c=n.current.target.position;o.copy(c).sub(a);var l=o.length();o.normalize().multiplyScalar(l*s),r.copy(a).add(o),e.current.position.copy(r),e.current.lookAt(n.current.target.position)})}function rT({distance:n=.4,alphaTest:e=.5,map:t,shader:i=iT,width:s=512,height:r=512,scale:o=1,children:a,...c}){const l=A.useRef(null),u=c.spotlightRef,h=c.debug;D2(u,l,s,r,n);const f=A.useMemo(()=>new It(s,r,{format:jt,stencilBuffer:!1}),[s,r]),d=A.useRef({uShadowMap:{value:t},uTime:{value:0}});A.useEffect(()=>void(d.current.uShadowMap.value=t),[t]);const p=A.useMemo(()=>new xs(new Dt({uniforms:d.current,vertexShader:`
          varying vec2 vUv;

          void main() {
            vUv = uv;
            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
          }
          `,fragmentShader:i})),[i]);return A.useEffect(()=>()=>{p.material.dispose(),p.dispose()},[p]),A.useEffect(()=>()=>f.dispose(),[f]),Ee(({gl:m},g)=>{d.current.uTime.value+=g,m.setRenderTarget(f),p.render(m),m.setRenderTarget(null)}),A.createElement(A.Fragment,null,A.createElement("mesh",{ref:l,scale:o,castShadow:!0},A.createElement("planeGeometry",null),A.createElement("meshBasicMaterial",{transparent:!0,side:Tt,alphaTest:e,alphaMap:f.texture,"alphaMap-wrapS":ui,"alphaMap-wrapT":ui,opacity:h?1:0},a)))}function oT({distance:n=.4,alphaTest:e=.5,map:t,width:i=512,height:s=512,scale:r,children:o,...a}){const c=A.useRef(null),l=a.spotlightRef,u=a.debug;return D2(l,c,i,s,n),A.createElement(A.Fragment,null,A.createElement("mesh",{ref:c,scale:r,castShadow:!0},A.createElement("planeGeometry",null),A.createElement("meshBasicMaterial",{transparent:!0,side:Tt,alphaTest:e,alphaMap:t,"alphaMap-wrapS":ui,"alphaMap-wrapT":ui,opacity:u?1:0},o)))}function ob(n){return n.shader?A.createElement(rT,n):A.createElement(oT,n)}const ab=A.forwardRef(({opacity:n=1,radiusTop:e,radiusBottom:t,depthBuffer:i,color:s="white",distance:r=5,angle:o=.15,attenuation:a=5,anglePower:c=5,volumetric:l=!0,debug:u=!1,children:h,...f},d)=>{const p=A.useRef(null);return A.useImperativeHandle(d,()=>p.current,[]),A.createElement("group",null,u&&p.current&&A.createElement("spotLightHelper",{args:[p.current]}),A.createElement("spotLight",ie({ref:p,angle:o,color:s,distance:r,castShadow:!0},f),l&&A.createElement(nT,{debug:u,opacity:n,radiusTop:e,radiusBottom:t,depthBuffer:i,color:s,distance:r,angle:o,attenuation:a,anglePower:c})),h&&A.cloneElement(h,{spotlightRef:p,debug:u}))}),cb=A.forwardRef(({light:n,args:e,map:t,toneMapped:i=!1,color:s="white",form:r="rect",intensity:o=1,scale:a=1,target:c=[0,0,0],children:l,...u},h)=>{const f=A.useRef(null);return A.useImperativeHandle(h,()=>f.current,[]),A.useLayoutEffect(()=>{!l&&!u.material&&(Ss(f.current.material,{color:s}),f.current.material.color.multiplyScalar(o))},[s,o,l,u.material]),A.useLayoutEffect(()=>{u.rotation||f.current.quaternion.identity(),c&&!u.rotation&&(typeof c=="boolean"?f.current.lookAt(0,0,0):f.current.lookAt(Array.isArray(c)?new b(...c):c))},[c,u.rotation]),a=Array.isArray(a)&&a.length===2?[a[0],a[1],1]:a,A.createElement("mesh",ie({ref:f,scale:a},u),r==="circle"?A.createElement("ringGeometry",{args:e||[0,.5,64]}):r==="ring"?A.createElement("ringGeometry",{args:e||[.25,.5,64]}):r==="rect"||r==="plane"?A.createElement("planeGeometry",{args:e||[1,1]}):r==="box"?A.createElement("boxGeometry",{args:e||[1,1,1]}):A.createElement(r,{args:e}),l||A.createElement("meshBasicMaterial",{toneMapped:i,map:t,side:Tt}),n&&A.createElement("pointLight",ie({castShadow:!0},n)))});function aT(n,e,t=new b){const i=Math.PI*(n-.5),s=2*Math.PI*(e-.5);return t.x=Math.cos(s),t.y=Math.sin(i),t.z=Math.sin(s),t}const lb=A.forwardRef(({inclination:n=.6,azimuth:e=.1,distance:t=1e3,mieCoefficient:i=.005,mieDirectionalG:s=.8,rayleigh:r=.5,turbidity:o=10,sunPosition:a=aT(n,e),...c},l)=>{const u=A.useMemo(()=>new b().setScalar(t),[t]),[h]=A.useState(()=>new Vh);return A.createElement("primitive",ie({object:h,ref:l,"material-uniforms-mieCoefficient-value":i,"material-uniforms-mieDirectionalG-value":s,"material-uniforms-rayleigh-value":r,"material-uniforms-sunPosition-value":a,"material-uniforms-turbidity-value":o,scale:u},c))});class cT extends Dt{constructor(){super({uniforms:{time:{value:0},fade:{value:1}},vertexShader:`
      uniform float time;
      attribute float size;
      varying vec3 vColor;
      void main() {
        vColor = color;
        vec4 mvPosition = modelViewMatrix * vec4(position, 0.5);
        gl_PointSize = size * (30.0 / -mvPosition.z) * (3.0 + sin(time + 100.0));
        gl_Position = projectionMatrix * mvPosition;
      }`,fragmentShader:`
      uniform sampler2D pointTexture;
      uniform float fade;
      varying vec3 vColor;
      void main() {
        float opacity = 1.0;
        if (fade == 1.0) {
          float d = distance(gl_PointCoord, vec2(0.5, 0.5));
          opacity = 1.0 / (1.0 + exp(16.0 * (d - 0.25)));
        }
        gl_FragColor = vec4(vColor, opacity);

        #include <tonemapping_fragment>
	      #include <${qt>=154?"colorspace_fragment":"encodings_fragment"}>
      }`})}}const lT=n=>new b().setFromSpherical(new _c(n,Math.acos(1-Math.random()*2),Math.random()*2*Math.PI)),ub=A.forwardRef(({radius:n=100,depth:e=50,count:t=5e3,saturation:i=0,factor:s=4,fade:r=!1,speed:o=1},a)=>{const c=A.useRef(),[l,u,h]=A.useMemo(()=>{const d=[],p=[],m=Array.from({length:t},()=>(.5+.5*Math.random())*s),g=new xe;let y=n+e;const v=e/t;for(let E=0;E<t;E++)y-=v*Math.random(),d.push(...lT(y).toArray()),g.setHSL(E/t,i,.9),p.push(g.r,g.g,g.b);return[new Float32Array(d),new Float32Array(p),new Float32Array(m)]},[t,e,s,n,i]);Ee(d=>c.current&&(c.current.uniforms.time.value=d.clock.getElapsedTime()*o));const[f]=A.useState(()=>new cT);return A.createElement("points",{ref:a},A.createElement("bufferGeometry",null,A.createElement("bufferAttribute",{attach:"attributes-position",args:[l,3]}),A.createElement("bufferAttribute",{attach:"attributes-color",args:[u,3]}),A.createElement("bufferAttribute",{attach:"attributes-size",args:[h,1]})),A.createElement("primitive",{ref:c,object:f,attach:"material",blending:e3,"uniforms-fade-value":r,depthWrite:!1,transparent:!0,vertexColors:!0}))});let Ua;const uT=new Uint8Array(16);function hT(){if(!Ua&&(Ua=typeof crypto<"u"&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Ua))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Ua(uT)}const Ot=[];for(let n=0;n<256;++n)Ot.push((n+256).toString(16).slice(1));function fT(n,e=0){return Ot[n[e+0]]+Ot[n[e+1]]+Ot[n[e+2]]+Ot[n[e+3]]+"-"+Ot[n[e+4]]+Ot[n[e+5]]+"-"+Ot[n[e+6]]+Ot[n[e+7]]+"-"+Ot[n[e+8]]+Ot[n[e+9]]+"-"+Ot[n[e+10]]+Ot[n[e+11]]+Ot[n[e+12]]+Ot[n[e+13]]+Ot[n[e+14]]+Ot[n[e+15]]}const dT=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),am={randomUUID:dT};function AT(n,e,t){if(am.randomUUID&&!e&&!n)return am.randomUUID();n=n||{};const i=n.random||(n.rng||hT)();return i[6]=i[6]&15|64,i[8]=i[8]&63|128,fT(i)}const mT="https://rawcdn.githack.com/pmndrs/drei-assets/9225a9f1fbd449d9411125c2f419b843d0308c9f/cloud.png",cm=new ce,Qa=new b,Na=new Be,lm=new b,um=new Be,co=new b,_f=A.createContext(null),pT=A.forwardRef(({children:n,material:e=Lh,texture:t=mT,range:i,limit:s=200,frustumCulled:r,...o},a)=>{var c,l;const u=A.useMemo(()=>class extends e{constructor(){super();const w=parseInt(xr.replace(/\D+/g,""))>=154?"opaque_fragment":"output_fragment";this.onBeforeCompile=B=>{B.vertexShader=`attribute float cloudOpacity;
               varying float vOpacity;
              `+B.vertexShader.replace("#include <fog_vertex>",`#include <fog_vertex>
                 vOpacity = cloudOpacity;
                `),B.fragmentShader=`varying float vOpacity;
              `+B.fragmentShader.replace(`#include <${w}>`,`#include <${w}>
                 gl_FragColor = vec4(outgoingLight, diffuseColor.a * vOpacity);
                `)}}},[e]);dt({CloudMaterial:u});const h=A.useRef(null),f=A.useRef([]),d=A.useMemo(()=>new Float32Array(Array.from({length:s},()=>1)),[s]),p=A.useMemo(()=>new Float32Array(Array.from({length:s},()=>[1,1,1]).flat()),[s]),m=pn(t);let g=0,y=0,v;const E=new Be,C=new b(0,0,1),x=new b;Ee((w,B)=>{for(g=w.clock.getElapsedTime(),cm.copy(h.current.matrixWorld).invert(),w.camera.matrixWorld.decompose(lm,um,co),y=0;y<f.current.length;y++)v=f.current[y],v.ref.current.matrixWorld.decompose(Qa,Na,co),Qa.add(x.copy(v.position).applyQuaternion(Na).multiply(co)),Na.copy(um).multiply(E.setFromAxisAngle(C,v.rotation+=B*v.rotationFactor)),co.multiplyScalar(v.volume+(1+Math.sin(g*v.density*v.speed))/2*v.growth),v.matrix.compose(Qa,Na,co).premultiply(cm),v.dist=Qa.distanceTo(lm);for(f.current.sort((T,R)=>R.dist-T.dist),y=0;y<f.current.length;y++)v=f.current[y],d[y]=v.opacity*(v.dist<v.fade-1?v.dist/v.fade:1),h.current.setMatrixAt(y,v.matrix),h.current.setColorAt(y,v.color);h.current.geometry.attributes.cloudOpacity.needsUpdate=!0,h.current.instanceMatrix.needsUpdate=!0,h.current.instanceColor&&(h.current.instanceColor.needsUpdate=!0)}),A.useLayoutEffect(()=>{const w=Math.min(s,i!==void 0?i:s,f.current.length);h.current.count=w,xo(h.current.instanceMatrix,{offset:0,count:w*16}),h.current.instanceColor&&xo(h.current.instanceColor,{offset:0,count:w*3}),xo(h.current.geometry.attributes.cloudOpacity,{offset:0,count:w})});let I=[(c=m.image.width)!==null&&c!==void 0?c:1,(l=m.image.height)!==null&&l!==void 0?l:1];const S=Math.max(I[0],I[1]);return I=[I[0]/S,I[1]/S],A.createElement("group",ie({ref:a},o),A.createElement(_f.Provider,{value:f},n,A.createElement("instancedMesh",{matrixAutoUpdate:!1,ref:h,args:[null,null,s],frustumCulled:r},A.createElement("instancedBufferAttribute",{usage:Gt,attach:"instanceColor",args:[p,3]}),A.createElement("planeGeometry",{args:[...I]},A.createElement("instancedBufferAttribute",{usage:Gt,attach:"attributes-cloudOpacity",args:[d,1]})),A.createElement("cloudMaterial",{key:e.name,map:m,transparent:!0,depthWrite:!1}))))}),hm=A.forwardRef(({opacity:n=1,speed:e=0,bounds:t=[5,1,1],segments:i=20,color:s="#ffffff",fade:r=10,volume:o=6,smallestVolume:a=.25,distribute:c=null,growth:l=4,concentrate:u="inside",seed:h=Math.random(),...f},d)=>{function p(){const E=Math.sin(h++)*1e4;return E-Math.floor(E)}const m=A.useContext(_f),g=A.useRef(null),[y]=A.useState(()=>AT()),v=A.useMemo(()=>[...new Array(i)].map((E,C)=>({segments:i,bounds:new b(1,1,1),position:new b,uuid:y,index:C,ref:g,dist:0,matrix:new ce,color:new xe,rotation:C*(Math.PI/i)})),[i,y]);return A.useLayoutEffect(()=>{v.forEach((E,C)=>{Ss(E,{volume:o,color:s,speed:e,growth:l,opacity:n,fade:r,bounds:t,density:Math.max(.5,p()),rotationFactor:Math.max(.2,.5*p())*e});const x=c==null?void 0:c(E,C);if(x||i>1){var I;E.position.copy(E.bounds).multiply((I=x==null?void 0:x.point)!==null&&I!==void 0?I:{x:p()*2-1,y:p()*2-1,z:p()*2-1})}const S=Math.abs(E.position.x),w=Math.abs(E.position.y),B=Math.abs(E.position.z),T=Math.max(S,w,B);E.length=1,S===T&&(E.length-=S/E.bounds.x),w===T&&(E.length-=w/E.bounds.y),B===T&&(E.length-=B/E.bounds.z),E.volume=((x==null?void 0:x.volume)!==void 0?x.volume:Math.max(Math.max(0,a),u==="random"?p():u==="inside"?E.length:1-E.length))*o})},[u,t,r,s,n,l,o,h,i,e]),A.useLayoutEffect(()=>{const E=v;return m.current=[...m.current,...E],()=>{m.current=m.current.filter(C=>C.uuid!==y)}},[v]),A.useImperativeHandle(d,()=>g.current,[]),A.createElement("group",ie({ref:g},f))}),hb=A.forwardRef((n,e)=>A.useContext(_f)?A.createElement(hm,ie({ref:e},n)):A.createElement(pT,null,A.createElement(hm,ie({ref:e},n)))),gT=Ri({time:0,pixelRatio:1},` uniform float pixelRatio;
    uniform float time;
    attribute float size;  
    attribute float speed;  
    attribute float opacity;
    attribute vec3 noise;
    attribute vec3 color;
    varying vec3 vColor;
    varying float vOpacity;
    void main() {
      vec4 modelPosition = modelMatrix * vec4(position, 1.0);
      modelPosition.y += sin(time * speed + modelPosition.x * noise.x * 100.0) * 0.2;
      modelPosition.z += cos(time * speed + modelPosition.x * noise.y * 100.0) * 0.2;
      modelPosition.x += cos(time * speed + modelPosition.x * noise.z * 100.0) * 0.2;
      vec4 viewPosition = viewMatrix * modelPosition;
      vec4 projectionPostion = projectionMatrix * viewPosition;
      gl_Position = projectionPostion;
      gl_PointSize = size * 25. * pixelRatio;
      gl_PointSize *= (1.0 / - viewPosition.z);
      vColor = color;
      vOpacity = opacity;
    }`,` varying vec3 vColor;
    varying float vOpacity;
    void main() {
      float distanceToCenter = distance(gl_PointCoord, vec2(0.5));
      float strength = 0.05 / distanceToCenter - 0.1;
      gl_FragColor = vec4(vColor, strength * vOpacity);
      #include <tonemapping_fragment>
      #include <${qt>=154?"colorspace_fragment":"encodings_fragment"}>
    }`),M2=n=>n&&n.constructor===Float32Array,yT=n=>[n.r,n.g,n.b],L2=n=>n instanceof de||n instanceof b||n instanceof ft,P2=n=>Array.isArray(n)?n:L2(n)?n.toArray():[n,n,n];function lo(n,e,t){return A.useMemo(()=>{if(e!==void 0){if(M2(e))return e;if(e instanceof xe){const i=Array.from({length:n*3},()=>yT(e)).flat();return Float32Array.from(i)}else if(L2(e)||Array.isArray(e)){const i=Array.from({length:n*3},()=>P2(e)).flat();return Float32Array.from(i)}return Float32Array.from({length:n},()=>e)}return Float32Array.from({length:n},t)},[e])}const fb=A.forwardRef(({noise:n=1,count:e=100,speed:t=1,opacity:i=1,scale:s=1,size:r,color:o,children:a,...c},l)=>{A.useMemo(()=>dt({SparklesImplMaterial:gT}),[]);const u=A.useRef(null),h=Z(E=>E.viewport.dpr),f=P2(s),d=A.useMemo(()=>Float32Array.from(Array.from({length:e},()=>f.map(Ce.randFloatSpread)).flat()),[e,...f]),p=lo(e,r,Math.random),m=lo(e,i),g=lo(e,t),y=lo(e*3,n),v=lo(o===void 0?e*3:e,M2(o)?o:new xe(o),()=>1);return Ee(E=>{u.current&&u.current.material&&(u.current.material.time=E.clock.elapsedTime)}),A.useImperativeHandle(l,()=>u.current,[]),A.createElement("points",ie({key:`particle-${e}-${JSON.stringify(s)}`},c,{ref:u}),A.createElement("bufferGeometry",null,A.createElement("bufferAttribute",{attach:"attributes-position",args:[d,3]}),A.createElement("bufferAttribute",{attach:"attributes-size",args:[p,1]}),A.createElement("bufferAttribute",{attach:"attributes-opacity",args:[m,1]}),A.createElement("bufferAttribute",{attach:"attributes-speed",args:[g,1]}),A.createElement("bufferAttribute",{attach:"attributes-color",args:[v,3]}),A.createElement("bufferAttribute",{attach:"attributes-noise",args:[y,3]})),a||A.createElement("sparklesImplMaterial",{transparent:!0,pixelRatio:h,depthWrite:!1}))});function ET(n){switch(n){case 64:return"-64px";case 128:return"-128px";case 256:return"-256px";case 512:return"-512px";default:return""}}const vT="https://cdn.jsdelivr.net/gh/pmndrs/drei-assets@master/matcaps.json",xT="https://rawcdn.githack.com/emmelleppi/matcaps/9b36ccaaf0a24881a39062d05566c9e92be4aa0d";function CT(n=0,e=1024,t){const i=dn(()=>fetch(vT).then(u=>u.json()),["matcapList"]),s=i[0],r=A.useMemo(()=>Object.keys(i).length,[]),a=`${A.useMemo(()=>typeof n=="string"?n:typeof n=="number"?i[n]:null,[n])||s}${ET(e)}.png`,c=`${xT}/${e}/${a}`;return[pn(c,t),c,r]}const db=({children:n,id:e,format:t,onLoad:i})=>{const s=CT(e,t,i);return A.createElement(A.Fragment,null,n==null?void 0:n(s))},IT="https://rawcdn.githack.com/pmndrs/drei-assets/7a3104997e1576f83472829815b00880d88b32fb",ST="https://cdn.jsdelivr.net/gh/pmndrs/drei-assets@master/normals/normals.json";function wT(n=0,e={},t){const{repeat:i=[1,1],anisotropy:s=1,offset:r=[0,0]}=e,o=dn(()=>fetch(ST).then(f=>f.json()),["normalsList"]),a=A.useMemo(()=>Object.keys(o).length,[]),c=o[0],l=o[n]||c,u=`${IT}/normals/${l}`,h=pn(u,t);return A.useLayoutEffect(()=>{h&&(h.wrapS=h.wrapT=ui,h.repeat=new de(i[0],i[1]),h.offset=new de(r[0],r[1]),h.anisotropy=s)},[h,s,i,r]),[h,u,a]}const Ab=({children:n,id:e,onLoad:t,...i})=>{const s=wT(e,i,t);return A.createElement(A.Fragment,null,n==null?void 0:n(s))},Gs={uniforms:{strokeOpacity:1,fillOpacity:.25,fillMix:0,thickness:.05,colorBackfaces:!1,dashInvert:!0,dash:!1,dashRepeats:4,dashLength:.5,squeeze:!1,squeezeMin:.2,squeezeMax:1,stroke:new xe("#ff0000"),backfaceStroke:new xe("#0000ff"),fill:new xe("#00ff00")},vertex:`
	  attribute vec3 barycentric;
	
		varying vec3 v_edges_Barycentric;
		varying vec3 v_edges_Position;

		void initWireframe() {
			v_edges_Barycentric = barycentric;
			v_edges_Position = position.xyz;
		}
	  `,fragment:`
		#ifndef PI
	  	#define PI 3.1415926535897932384626433832795
		#endif
  
	  varying vec3 v_edges_Barycentric;
	  varying vec3 v_edges_Position;
  
	  uniform float strokeOpacity;
	  uniform float fillOpacity;
	  uniform float fillMix;
	  uniform float thickness;
	  uniform bool colorBackfaces;
  
	  // Dash
	  uniform bool dashInvert;
	  uniform bool dash;
	  uniform bool dashOnly;
	  uniform float dashRepeats;
	  uniform float dashLength;
  
	  // Squeeze
	  uniform bool squeeze;
	  uniform float squeezeMin;
	  uniform float squeezeMax;
  
	  // Colors
	  uniform vec3 stroke;
	  uniform vec3 backfaceStroke;
	  uniform vec3 fill;
  
	  // This is like
	  float wireframe_aastep(float threshold, float dist) {
		  float afwidth = fwidth(dist) * 0.5;
		  return smoothstep(threshold - afwidth, threshold + afwidth, dist);
	  }
  
	  float wireframe_map(float value, float min1, float max1, float min2, float max2) {
		  return min2 + (value - min1) * (max2 - min2) / (max1 - min1);
	  }
  
	  float getWireframe() {
			vec3 barycentric = v_edges_Barycentric;
		
			// Distance from center of each triangle to its edges.
			float d = min(min(barycentric.x, barycentric.y), barycentric.z);

			// for dashed rendering, we can use this to get the 0 .. 1 value of the line length
			float positionAlong = max(barycentric.x, barycentric.y);
			if (barycentric.y < barycentric.x && barycentric.y < barycentric.z) {
				positionAlong = 1.0 - positionAlong;
			}

			// the thickness of the stroke
			float computedThickness = wireframe_map(thickness, 0.0, 1.0, 0.0, 0.34);

			// if we want to shrink the thickness toward the center of the line segment
			if (squeeze) {
				computedThickness *= mix(squeezeMin, squeezeMax, (1.0 - sin(positionAlong * PI)));
			}

			// Create dash pattern
			if (dash) {
				// here we offset the stroke position depending on whether it
				// should overlap or not
				float offset = 1.0 / dashRepeats * dashLength / 2.0;
				if (!dashInvert) {
					offset += 1.0 / dashRepeats / 2.0;
				}

				// if we should animate the dash or not
				// if (dashAnimate) {
				// 	offset += time * 0.22;
				// }

				// create the repeating dash pattern
				float pattern = fract((positionAlong + offset) * dashRepeats);
				computedThickness *= 1.0 - wireframe_aastep(dashLength, pattern);
			}

			// compute the anti-aliased stroke edge  
			float edge = 1.0 - wireframe_aastep(computedThickness, d);

			return edge;
	  }
	  `},TT=Ri(Gs.uniforms,Gs.vertex+`
  	void main() {
		initWireframe();
		gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
	}
  `,Gs.fragment+`
  void main () {
		// Compute color

		float edge = getWireframe();
		vec4 colorStroke = vec4(stroke, edge);

		#ifdef FLIP_SIDED
			colorStroke.rgb = backfaceStroke;
		#endif
    
		vec4 colorFill = vec4(fill, fillOpacity);
		vec4 outColor = mix(colorFill, colorStroke, edge * strokeOpacity);

		gl_FragColor = outColor;
	}
  `);function BT(n,e){n.onBeforeCompile=t=>{t.uniforms={...t.uniforms,...e},t.vertexShader=t.vertexShader.replace("void main() {",`
		  ${Gs.vertex}
		  void main() {
			initWireframe();
		`),t.fragmentShader=t.fragmentShader.replace("void main() {",`
		  ${Gs.fragment}
		  void main() {
		`),t.fragmentShader=t.fragmentShader.replace("#include <color_fragment>",`
		  #include <color_fragment>
			  float edge = getWireframe();
		  vec4 colorStroke = vec4(stroke, edge);
		  #ifdef FLIP_SIDED
			colorStroke.rgb = backfaceStroke;
		  #endif
		  vec4 colorFill = vec4(mix(diffuseColor.rgb, fill, fillMix), mix(diffuseColor.a, fillOpacity, fillMix));
		  vec4 outColor = mix(colorFill, colorStroke, edge * strokeOpacity);

		  diffuseColor.rgb = outColor.rgb;
		  diffuseColor.a *= outColor.a;
		`)},n.side=Tt,n.transparent=!0}function _T(n,e){A.useEffect(()=>{var t;return void(n.fillOpacity.value=(t=e.fillOpacity)!==null&&t!==void 0?t:n.fillOpacity.value)},[e.fillOpacity]),A.useEffect(()=>{var t;return void(n.fillMix.value=(t=e.fillMix)!==null&&t!==void 0?t:n.fillMix.value)},[e.fillMix]),A.useEffect(()=>{var t;return void(n.strokeOpacity.value=(t=e.strokeOpacity)!==null&&t!==void 0?t:n.strokeOpacity.value)},[e.strokeOpacity]),A.useEffect(()=>{var t;return void(n.thickness.value=(t=e.thickness)!==null&&t!==void 0?t:n.thickness.value)},[e.thickness]),A.useEffect(()=>void(n.colorBackfaces.value=!!e.colorBackfaces),[e.colorBackfaces]),A.useEffect(()=>void(n.dash.value=!!e.dash),[e.dash]),A.useEffect(()=>void(n.dashInvert.value=!!e.dashInvert),[e.dashInvert]),A.useEffect(()=>{var t;return void(n.dashRepeats.value=(t=e.dashRepeats)!==null&&t!==void 0?t:n.dashRepeats.value)},[e.dashRepeats]),A.useEffect(()=>{var t;return void(n.dashLength.value=(t=e.dashLength)!==null&&t!==void 0?t:n.dashLength.value)},[e.dashLength]),A.useEffect(()=>void(n.squeeze.value=!!e.squeeze),[e.squeeze]),A.useEffect(()=>{var t;return void(n.squeezeMin.value=(t=e.squeezeMin)!==null&&t!==void 0?t:n.squeezeMin.value)},[e.squeezeMin]),A.useEffect(()=>{var t;return void(n.squeezeMax.value=(t=e.squeezeMax)!==null&&t!==void 0?t:n.squeezeMax.value)},[e.squeezeMax]),A.useEffect(()=>void(n.stroke.value=e.stroke?new xe(e.stroke):n.stroke.value),[e.stroke]),A.useEffect(()=>void(n.fill.value=e.fill?new xe(e.fill):n.fill.value),[e.fill]),A.useEffect(()=>void(n.backfaceStroke.value=e.backfaceStroke?new xe(e.backfaceStroke):n.backfaceStroke.value),[e.backfaceStroke])}function bT(n){return!!(n!=null&&n.geometry)}function RT(n){return!!(n!=null&&n.isBufferGeometry)}function DT(n){return!!(n!=null&&n.current)}function fm(n){return(n==null?void 0:n.current)!==void 0}function dm(n){return n.type==="WireframeGeometry"}function MT(){const n={};for(const e in Gs.uniforms)n[e]={value:Gs.uniforms[e]};return n}function LT(n,e){const i=n.getAttribute("position").count,s=[];for(let r=0;r<i;r++){const o=r%2===0,a=e?1:0;o?s.push(0,0,1,0,1,0,1,0,a):s.push(0,1,0,0,0,1,1,0,a)}return new Ye(Float32Array.from(s),3)}function F2(n){const e=DT(n)?n.current:n;if(RT(e))return e;{if(dm(e))throw new Error("Wireframe: WireframeGeometry is not supported.");const t=e.parent;if(bT(t)){if(dm(t.geometry))throw new Error("Wireframe: WireframeGeometry is not supported.");return t.geometry}}}function k2(n,e){if(n.index){console.warn("Wireframe: Requires non-indexed geometry, converting to non-indexed geometry.");const i=n.toNonIndexed();n.copy(i),n.setIndex(null)}const t=LT(n,e);n.setAttribute("barycentric",t)}function PT({geometry:n,simplify:e=!1,...t}){dt({MeshWireframeMaterial:TT});const[i,s]=A.useState(null);A.useLayoutEffect(()=>{const o=F2(n);if(!o)throw new Error("Wireframe: geometry prop must be a BufferGeometry or a ref to a BufferGeometry.");k2(o,e),fm(n)&&s(o)},[e,n]);const r=fm(n)?i:n;return A.createElement(A.Fragment,null,r&&A.createElement("mesh",{geometry:r},A.createElement("meshWireframeMaterial",ie({attach:"material",transparent:!0,side:Tt,polygonOffset:!0,polygonOffsetFactor:-4},t,{extensions:{derivatives:!0,fragDepth:!1,drawBuffers:!1,shaderTextureLOD:!1}}))))}function FT({simplify:n=!1,...e}){const t=A.useRef(null),i=A.useMemo(()=>MT(),[Gs.uniforms]);return _T(i,e),A.useLayoutEffect(()=>{const s=F2(t);if(!s)throw new Error("Wireframe: Must be a child of a Mesh, Line or Points object or specify a geometry prop.");const r=s.clone();return k2(s,n),()=>{s.copy(r),r.dispose()}},[n]),A.useLayoutEffect(()=>{const s=t.current.parent,r=s.material.clone();return BT(s.material,i),()=>{s.material.dispose(),s.material=r}},[]),A.createElement("object3D",{ref:t})}function mb({geometry:n,...e}){return n?A.createElement(PT,ie({geometry:n},e)):A.createElement(FT,e)}function pb({opacity:n,alphaMap:e}){const t=A.useRef(null),i=A.useRef(null),s=A.useRef({value:1}),r=A.useRef({value:null}),o=A.useRef({value:!1});return A.useLayoutEffect(()=>{t.current.onBeforeCompile=i.current.onBeforeCompile=a=>{const c=a.fragmentShader.indexOf("void main");let l="",u,h=c;for(;u!==`
`&&h<c+100;)u=a.fragmentShader.charAt(h),l+=u,h++;l=l.trim(),a.vertexShader=a.vertexShader.replace("void main() {",`
        varying vec2 custom_vUv;

        void main() {
          custom_vUv = uv;
          
        `),a.fragmentShader=a.fragmentShader.replace(l,`
          uniform float uShadowOpacity;
          uniform sampler2D uAlphaMap;
          uniform bool uHasAlphaMap;

          varying vec2 custom_vUv;
  
          float bayerDither2x2( vec2 v ) {
            return mod( 3.0 * v.y + 2.0 * v.x, 4.0 );
          }
    
          float bayerDither4x4( vec2 v ) {
            vec2 P1 = mod( v, 2.0 );
            vec2 P2 = mod( floor( 0.5  * v ), 2.0 );
            return 4.0 * bayerDither2x2( P1 ) + bayerDither2x2( P2 );
          }
  
          void main() {
            float alpha = 
              uHasAlphaMap ? 
                uShadowOpacity * texture2D(uAlphaMap, custom_vUv).x
              : uShadowOpacity;

            if( ( bayerDither4x4( floor( mod( gl_FragCoord.xy, 4.0 ) ) ) ) / 16.0 >= alpha ) discard;
            
          `),a.uniforms.uShadowOpacity=s.current,a.uniforms.uAlphaMap=r.current,a.uniforms.uHasAlphaMap=o.current}},[]),Ee(()=>{var a;const c=(a=t.current.__r3f)==null?void 0:a.parent;if(c){const l=c.material;l&&(s.current.value=n??l.opacity,e===!1?(r.current.value=null,o.current.value=!1):(r.current.value=e||l.alphaMap,o.current.value=!!r.current.value))}}),A.createElement(A.Fragment,null,A.createElement("meshDepthMaterial",{ref:t,attach:"customDepthMaterial",depthPacking:t3}),A.createElement("meshDistanceMaterial",{ref:i,attach:"customDistanceMaterial"}))}const Am=new ce,Cu=new Fo,mm=new si,kT=new b;class OT extends ws{constructor(){super(),this.size=0,this.color=new xe("white"),this.instance={current:void 0},this.instanceKey={current:void 0}}get geometry(){var e;return(e=this.instance.current)==null?void 0:e.geometry}raycast(e,t){var i,s;const r=this.instance.current;if(!r||!r.geometry)return;const o=r.userData.instances.indexOf(this.instanceKey);if(o===-1||o>r.geometry.drawRange.count)return;const a=(i=(s=e.params.Points)==null?void 0:s.threshold)!==null&&i!==void 0?i:1;if(mm.set(this.getWorldPosition(kT),a),e.ray.intersectsSphere(mm)===!1)return;Am.copy(r.matrixWorld).invert(),Cu.copy(e.ray).applyMatrix4(Am);const c=a/((this.scale.x+this.scale.y+this.scale.z)/3),l=c*c,u=Cu.distanceSqToPoint(this.position);if(u<l){const h=new b;Cu.closestPointToPoint(this.position,h),h.applyMatrix4(this.matrixWorld);const f=e.ray.origin.distanceTo(h);if(f<e.near||f>e.far)return;t.push({distance:f,distanceToRay:Math.sqrt(u),point:h,index:o,face:null,object:this})}}}let Zs,uo;const O2=A.createContext(null),pm=new ce,gm=new b,UT=A.forwardRef(({children:n,range:e,limit:t=1e3,...i},s)=>{const r=A.useRef(null);A.useImperativeHandle(s,()=>r.current,[]);const[o,a]=A.useState([]),[[c,l,u]]=A.useState(()=>[new Float32Array(t*3),Float32Array.from({length:t*3},()=>1),Float32Array.from({length:t},()=>1)]);A.useEffect(()=>{r.current.geometry.attributes.position.needsUpdate=!0}),Ee(()=>{for(r.current.updateMatrix(),r.current.updateMatrixWorld(),pm.copy(r.current.matrixWorld).invert(),r.current.geometry.drawRange.count=Math.min(t,e!==void 0?e:t,o.length),Zs=0;Zs<o.length;Zs++)uo=o[Zs].current,uo.getWorldPosition(gm).applyMatrix4(pm),gm.toArray(c,Zs*3),r.current.geometry.attributes.position.needsUpdate=!0,uo.matrixWorldNeedsUpdate=!0,uo.color.toArray(l,Zs*3),r.current.geometry.attributes.color.needsUpdate=!0,u.set([uo.size],Zs),r.current.geometry.attributes.size.needsUpdate=!0});const h=A.useMemo(()=>({getParent:()=>r,subscribe:f=>(a(d=>[...d,f]),()=>a(d=>d.filter(p=>p.current!==f.current)))}),[]);return A.createElement("points",ie({userData:{instances:o},matrixAutoUpdate:!1,ref:r,raycast:()=>null},i),A.createElement("bufferGeometry",null,A.createElement("bufferAttribute",{attach:"attributes-position",count:c.length/3,array:c,itemSize:3,usage:Gt}),A.createElement("bufferAttribute",{attach:"attributes-color",count:l.length/3,array:l,itemSize:3,usage:Gt}),A.createElement("bufferAttribute",{attach:"attributes-size",count:u.length,array:u,itemSize:1,usage:Gt})),A.createElement(O2.Provider,{value:h},n))}),gb=A.forwardRef(({children:n,...e},t)=>{A.useMemo(()=>dt({PositionPoint:OT}),[]);const i=A.useRef(null);A.useImperativeHandle(t,()=>i.current,[]);const{subscribe:s,getParent:r}=A.useContext(O2);return A.useLayoutEffect(()=>s(i),[]),A.createElement("positionPoint",ie({instance:r(),instanceKey:i,ref:i},e),n)}),QT=A.forwardRef(({children:n,positions:e,colors:t,sizes:i,stride:s=3,...r},o)=>{const a=A.useRef(null);return A.useImperativeHandle(o,()=>a.current,[]),Ee(()=>{const c=a.current.geometry.attributes;c.position.needsUpdate=!0,t&&(c.color.needsUpdate=!0),i&&(c.size.needsUpdate=!0)}),A.createElement("points",ie({ref:a},r),A.createElement("bufferGeometry",null,A.createElement("bufferAttribute",{attach:"attributes-position",count:e.length/s,array:e,itemSize:s,usage:Gt}),t&&A.createElement("bufferAttribute",{attach:"attributes-color",count:t.length/s,array:t,itemSize:3,usage:Gt}),i&&A.createElement("bufferAttribute",{attach:"attributes-size",count:i.length/s,array:i,itemSize:1,usage:Gt})),n)}),yb=A.forwardRef((n,e)=>n.positions instanceof Float32Array?A.createElement(QT,ie({},n,{ref:e})):A.createElement(UT,ie({},n,{ref:e}))),U2=A.createContext(null),Eb=A.forwardRef((n,e)=>{A.useMemo(()=>dt({SegmentObject:NT}),[]);const{limit:t=1e3,lineWidth:i=1,children:s,...r}=n,[o,a]=A.useState([]),[c]=A.useState(()=>new Ip),[l]=A.useState(()=>new Uc),[u]=A.useState(()=>new Oc),[h]=A.useState(()=>new de(512,512)),[f]=A.useState(()=>Array(t*6).fill(0)),[d]=A.useState(()=>Array(t*6).fill(0)),p=A.useMemo(()=>({subscribe:m=>(a(g=>[...g,m]),()=>a(g=>g.filter(y=>y.current!==m.current)))}),[]);return Ee(()=>{for(let g=0;g<t;g++){var m;const y=(m=o[g])==null?void 0:m.current;y&&(f[g*6+0]=y.start.x,f[g*6+1]=y.start.y,f[g*6+2]=y.start.z,f[g*6+3]=y.end.x,f[g*6+4]=y.end.y,f[g*6+5]=y.end.z,d[g*6+0]=y.color.r,d[g*6+1]=y.color.g,d[g*6+2]=y.color.b,d[g*6+3]=y.color.r,d[g*6+4]=y.color.g,d[g*6+5]=y.color.b)}u.setColors(d),u.setPositions(f),c.computeLineDistances()}),A.createElement("primitive",{object:c,ref:e},A.createElement("primitive",{object:u,attach:"geometry"}),A.createElement("primitive",ie({object:l,attach:"material",vertexColors:!0,resolution:h,linewidth:i},r)),A.createElement(U2.Provider,{value:p},s))});class NT{constructor(){this.color=new xe("white"),this.start=new b(0,0,0),this.end=new b(0,0,0)}}const ym=n=>n instanceof b?n:new b(...typeof n=="number"?[n,n,n]:n),vb=A.forwardRef(({color:n,start:e,end:t},i)=>{const s=A.useContext(U2);if(!s)throw"Segment must used inside Segments component.";const r=A.useRef(null);return A.useImperativeHandle(i,()=>r.current,[]),A.useLayoutEffect(()=>s.subscribe(r),[]),A.createElement("segmentObject",{ref:r,color:n,start:ym(e),end:ym(t)})}),xb=A.forwardRef(({children:n,hysteresis:e=0,distances:t,...i},s)=>{const r=A.useRef(null);return A.useImperativeHandle(s,()=>r.current,[]),A.useLayoutEffect(()=>{const{current:o}=r;o.levels.length=0,o.children.forEach((a,c)=>o.levels.push({object:a,hysteresis:e,distance:t[c]}))}),Ee(o=>{var a;return(a=r.current)==null?void 0:a.update(o.camera)}),A.createElement("lOD",ie({ref:r},i),n)});function Cb({all:n,scene:e,camera:t}){const i=Z(({gl:o})=>o),s=Z(({camera:o})=>o),r=Z(({scene:o})=>o);return A.useLayoutEffect(()=>{const o=[];n&&(e||r).traverse(l=>{l.visible===!1&&(o.push(l),l.visible=!0)}),i.compile(e||r,t||s);const a=new Fh(128);new h1(.01,1e5,a).update(i,e||r),a.dispose(),o.forEach(l=>l.visible=!1)},[]),null}function Ib(){const n=Z(e=>e.gl);return A.useEffect(()=>(n.shadowMap.autoUpdate=!1,n.shadowMap.needsUpdate=!0,()=>{n.shadowMap.autoUpdate=n.shadowMap.needsUpdate=!0}),[n.shadowMap]),null}const Em=new ce,vm=new Fo,Iu=new si,Su=new b;function Sb(n,e){const t=this.geometry,i=this.material,s=this.matrixWorld;i!==void 0&&(t.boundingSphere===null&&t.computeBoundingSphere(),Iu.copy(t.boundingSphere),Iu.applyMatrix4(s),n.ray.intersectsSphere(Iu)!==!1&&(Em.copy(s).invert(),vm.copy(n.ray).applyMatrix4(Em),!(t.boundingBox!==null&&vm.intersectBox(t.boundingBox,Su)===null)&&e.push({distance:Su.distanceTo(n.ray.origin),point:Su.clone(),object:this})))}function wb({pixelated:n}){const e=Z(o=>o.gl),t=Z(o=>o.internal.active),i=Z(o=>o.performance.current),s=Z(o=>o.viewport.initialDpr),r=Z(o=>o.setDpr);return A.useEffect(()=>{const o=e.domElement;return()=>{t&&r(s),n&&o&&(o.style.imageRendering="auto")}},[]),A.useEffect(()=>{r(i*s),n&&e.domElement&&(e.domElement.style.imageRendering=i===1?"auto":"pixelated")},[i]),null}function Tb(){const n=Z(i=>i.get),e=Z(i=>i.setEvents),t=Z(i=>i.performance.current);return A.useEffect(()=>{const i=n().events.enabled;return()=>e({enabled:i})},[]),A.useEffect(()=>e({enabled:t===1}),[t]),null}const Q2=A.createContext(null);function Bb({iterations:n=10,ms:e=250,threshold:t=.75,step:i=.1,factor:s=.5,flipflops:r=1/0,bounds:o=f=>f>100?[60,100]:[40,60],onIncline:a,onDecline:c,onChange:l,onFallback:u,children:h}){const f=Math.pow(10,0),[d,p]=A.useState(()=>({fps:0,index:0,factor:s,flipped:0,refreshrate:0,fallback:!1,frames:[],averages:[],subscriptions:new Map,subscribe:g=>{const y=Symbol();return d.subscriptions.set(y,g.current),()=>void d.subscriptions.delete(y)}}));let m=0;return Ee(()=>{const{frames:g,averages:y}=d;if(!d.fallback&&y.length<n){g.push(performance.now());const v=g[g.length-1]-g[0];if(v>=e){if(d.fps=Math.round(g.length/v*1e3*f)/f,d.refreshrate=Math.max(d.refreshrate,d.fps),y[d.index++%n]=d.fps,y.length===n){const[E,C]=o(d.refreshrate),x=y.filter(S=>S>=C),I=y.filter(S=>S<E);x.length>n*t&&(d.factor=Math.min(1,d.factor+i),d.flipped++,a&&a(d),d.subscriptions.forEach(S=>S.onIncline&&S.onIncline(d))),I.length>n*t&&(d.factor=Math.max(0,d.factor-i),d.flipped++,c&&c(d),d.subscriptions.forEach(S=>S.onDecline&&S.onDecline(d))),m!==d.factor&&(m=d.factor,l&&l(d),d.subscriptions.forEach(S=>S.onChange&&S.onChange(d))),d.flipped>r&&!d.fallback&&(d.fallback=!0,u&&u(d),d.subscriptions.forEach(S=>S.onFallback&&S.onFallback(d))),d.averages=[]}d.frames=[]}}}),A.createElement(Q2.Provider,{value:d},h)}function _b({onIncline:n,onDecline:e,onChange:t,onFallback:i}){const s=A.useContext(Q2),r=A.useRef({onIncline:n,onDecline:e,onChange:t,onFallback:i});A.useLayoutEffect(()=>{r.current.onIncline=n,r.current.onDecline=e,r.current.onChange=t,r.current.onFallback=i},[n,e,t,i]),A.useLayoutEffect(()=>s.subscribe(r),[s])}const GT=A.forwardRef(({children:n,compute:e,width:t,height:i,samples:s=8,renderPriority:r=0,eventPriority:o=0,frames:a=1/0,stencilBuffer:c=!1,depthBuffer:l=!0,generateMipmaps:u=!1,...h},f)=>{const{size:d,viewport:p}=Z(),m=wi((t||d.width)*p.dpr,(i||d.height)*p.dpr,{samples:s,stencilBuffer:c,depthBuffer:l,generateMipmaps:u}),[g]=A.useState(()=>new Sr),y=A.useCallback((v,E,C)=>{var x,I;let S=(x=m.texture)==null?void 0:x.__r3f.parent;for(;S&&!(S instanceof lt);)S=S.__r3f.parent;if(!S)return!1;C.raycaster.camera||C.events.compute(v,C,(I=C.previousRoot)==null?void 0:I.getState());const[w]=C.raycaster.intersectObject(S);if(!w)return!1;const B=w.uv;if(!B)return!1;E.raycaster.setFromCamera(E.pointer.set(B.x*2-1,B.y*2-1),E.camera)},[]);return A.useImperativeHandle(f,()=>m.texture,[m]),A.createElement(A.Fragment,null,Ir(A.createElement(zT,{renderPriority:r,frames:a,fbo:m},n,A.createElement("group",{onPointerOver:()=>null})),g,{events:{compute:e||y,priority:o}}),A.createElement("primitive",ie({object:m.texture},h)))});function zT({frames:n,renderPriority:e,children:t,fbo:i}){let s=0,r,o,a,c;return Ee(l=>{(n===1/0||s<n)&&(r=l.gl.autoClear,o=l.gl.xr.enabled,a=l.gl.getRenderTarget(),c=l.gl.xr.isPresenting,l.gl.autoClear=!0,l.gl.xr.enabled=!1,l.gl.xr.isPresenting=!1,l.gl.setRenderTarget(i),l.gl.render(l.scene,l.camera),l.gl.setRenderTarget(a),l.gl.autoClear=r,l.gl.xr.enabled=o,l.gl.xr.isPresenting=c,s++)},e),A.createElement(A.Fragment,null,t)}const HT=A.forwardRef(({children:n,compute:e,renderPriority:t=-1,eventPriority:i=0,frames:s=1/0,stencilBuffer:r=!1,depthBuffer:o=!0,generateMipmaps:a=!1,resolution:c=896,near:l=.1,far:u=1e3,flip:h=!1,position:f,rotation:d,scale:p,quaternion:m,matrix:g,matrixAutoUpdate:y,...v},E)=>{const{size:C,viewport:x}=Z(),I=A.useRef(null),S=A.useMemo(()=>{const B=new Fh(Math.max((c||C.width)*x.dpr,(c||C.height)*x.dpr),{stencilBuffer:r,depthBuffer:o,generateMipmaps:a});return B.texture.isRenderTargetTexture=!h,B.texture.flipY=!0,B.texture.type=Qi,B},[c,h]);A.useEffect(()=>()=>S.dispose(),[S]);const[w]=A.useState(()=>new Sr);return A.useImperativeHandle(E,()=>({scene:w,fbo:S,camera:I.current}),[S]),A.createElement(A.Fragment,null,Ir(A.createElement(KT,{renderPriority:t,frames:s,camera:I},n,A.createElement("group",{onPointerOver:()=>null})),w,{events:{compute:e,priority:i}}),A.createElement("primitive",ie({object:S.texture},v)),A.createElement("cubeCamera",{ref:I,args:[l,u,S],position:f,rotation:d,scale:p,quaternion:m,matrix:g,matrixAutoUpdate:y}))});function KT({frames:n,renderPriority:e,children:t,camera:i}){let s=0;return Ee(r=>{(n===1/0||s<n)&&(i.current.update(r.gl,r.scene),s++)},e),A.createElement(A.Fragment,null,t)}const bb=A.forwardRef(({id:n=1,colorWrite:e=!1,depthWrite:t=!1,...i},s)=>{const r=A.useRef(null),o=A.useMemo(()=>({colorWrite:e,depthWrite:t,stencilWrite:!0,stencilRef:n,stencilFunc:i3,stencilFail:il,stencilZFail:il,stencilZPass:il}),[n,e,t]);return A.useLayoutEffect(()=>{Object.assign(r.current.material,o)}),A.useImperativeHandle(s,()=>r.current,[]),A.createElement("mesh",ie({ref:r,renderOrder:-n},i))});function Rb(n,e=!1){return{stencilWrite:!0,stencilRef:n,stencilFunc:e?s3:n3,stencilFail:sl,stencilZFail:sl,stencilZPass:sl}}function Db({renderPriority:n=1,zoom:e=0,segments:t=64,children:i,resolution:s=896,...r}){const o=A.useRef(null),a=A.useRef(null),{width:c,height:l}=Z(g=>g.size),[u]=A.useState(()=>new vt);A.useLayoutEffect(()=>{u.position.set(0,0,100),u.zoom=100,u.left=c/-2,u.right=c/2,u.top=l/2,u.bottom=l/-2,u.updateProjectionMatrix()},[c,l]);const h=Math.sqrt(c*c+l*l)/100*(.5+e/2),f=new b,d=new si(new b,h),p=new Ci,m=A.useCallback((g,y,v)=>{if(y.pointer.set(g.offsetX/y.size.width*2-1,-(g.offsetY/y.size.height)*2+1),y.raycaster.setFromCamera(y.pointer,u),y.raycaster.ray.intersectSphere(d,f))f.normalize();else return;p.getNormalMatrix(a.current.camera.matrixWorld),a.current.camera.getWorldPosition(y.raycaster.ray.origin),y.raycaster.ray.direction.set(0,0,1).reflect(f),y.raycaster.ray.direction.x*=-1,y.raycaster.ray.direction.applyNormalMatrix(p).multiplyScalar(-1)},[]);return Ee(g=>{n&&g.gl.render(o.current,u)},n),A.createElement(A.Fragment,null,A.createElement("mesh",ie({ref:o},r,{scale:h}),A.createElement("sphereGeometry",{args:[1,t,t]}),A.createElement("meshBasicMaterial",null,A.createElement(HT,{compute:m,attach:"envMap",flip:!0,resolution:s,ref:a},i,A.createElement(VT,{api:a})))))}function VT({api:n}){const e=new b,t=new Be,i=new b,s=new ai(0,Math.PI,0);return Ee(r=>{r.camera.matrixWorld.decompose(e,t,i),n.current.camera.position.copy(e),n.current.camera.quaternion.setFromEuler(s).premultiply(t)}),null}const YT=Ri({blur:0,map:null,sdf:null,blend:0,size:0,resolution:new de},`varying vec2 vUv;
   void main() {
     gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
     vUv = uv;
   }`,`uniform sampler2D sdf;
   uniform sampler2D map;
   uniform float blur;
   uniform float size;
   uniform float time;
   uniform vec2 resolution;
   varying vec2 vUv;
   #include <packing>
   void main() {
     vec2 uv = gl_FragCoord.xy / resolution.xy;
     vec4 t = texture2D(map, uv);
     float k = blur;
     float d = texture2D(sdf, vUv).r/size;
     float alpha = 1.0 - smoothstep(0.0, 1.0, clamp(d/k + 1.0, 0.0, 1.0));
     gl_FragColor = vec4(t.rgb, blur == 0.0 ? t.a : t.a * alpha);
     #include <tonemapping_fragment>
     #include <${qt>=154?"colorspace_fragment":"encodings_fragment"}>
   }`),Mb=A.forwardRef(({children:n,events:e=void 0,blur:t=0,eventPriority:i=0,renderPriority:s=0,worldUnits:r=!1,resolution:o=512,...a},c)=>{dt({PortalMaterialImpl:YT});const l=A.useRef(null),{scene:u,gl:h,size:f,viewport:d,setEvents:p}=Z(),m=wi(o,o),[g,y]=A.useState(0);Ee(()=>{const I=l.current.blend>0?Math.max(1,s):0;g!==I&&y(I)}),A.useEffect(()=>{e!==void 0&&p({enabled:!e})},[e]);const[v,E]=A.useState(!0),C=cw(E);A.useLayoutEffect(()=>{var I;C.current=(I=l.current)==null?void 0:I.__r3f.parent},[]),A.useLayoutEffect(()=>{if(C.current&&t&&l.current.sdf===null){const I=new ye(C.current.geometry,new Cs),S=new st().setFromBufferAttribute(I.geometry.attributes.position),w=new vt(S.min.x*(1+2/o),S.max.x*(1+2/o),S.max.y*(1+2/o),S.min.y*(1+2/o),.1,1e3);w.position.set(0,0,1),w.lookAt(0,0,0),h.setRenderTarget(m),h.render(I,w);const T=WT(o,o,h)(m.texture),R=new Float32Array(o*o);h.readRenderTargetPixels(T,0,0,o,o,R);let _=1/0;for(let L=0;L<R.length;L++)R[L]<_&&(_=R[L]);_=-_,l.current.size=_,l.current.sdf=T.texture,h.setRenderTarget(null)}},[o,t]),A.useImperativeHandle(c,()=>l.current);const x=A.useCallback((I,S,w)=>{var B;if(!C.current)return!1;if(S.pointer.set(I.offsetX/S.size.width*2-1,-(I.offsetY/S.size.height)*2+1),S.raycaster.setFromCamera(S.pointer,S.camera),((B=l.current)==null?void 0:B.blend)===0){const[T]=S.raycaster.intersectObject(C.current);if(!T)return S.raycaster.camera=void 0,!1}},[]);return A.createElement("portalMaterialImpl",ie({ref:l,blur:t,blend:0,resolution:[f.width*d.dpr,f.height*d.dpr],attach:"material"},a),A.createElement(GT,{attach:"map",frames:v?1/0:0,eventPriority:i,renderPriority:s,compute:x},n,A.createElement($T,{events:e,rootScene:u,priority:g,material:l,worldUnits:r})))});function $T({events:n=void 0,rootScene:e,material:t,priority:i,worldUnits:s}){const r=Z(h=>h.scene),o=Z(h=>h.setEvents),a=wi(),c=wi();A.useLayoutEffect(()=>{r.matrixAutoUpdate=!1},[]),A.useEffect(()=>{n!==void 0&&o({enabled:n})},[n]);const[l,u]=A.useMemo(()=>{const h={value:0};return[new xs(new Dt({uniforms:{a:{value:a.texture},b:{value:c.texture},blend:h},vertexShader:`
          varying vec2 vUv;
          void main() {
            vUv = uv;
            gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
          }`,fragmentShader:`
          uniform sampler2D a;
          uniform sampler2D b;
          uniform float blend;
          varying vec2 vUv;
          #include <packing>
          void main() {
            vec4 ta = texture2D(a, vUv);
            vec4 tb = texture2D(b, vUv);
            gl_FragColor = mix(tb, ta, blend);
            #include <tonemapping_fragment>
            #include <${qt>=154?"colorspace_fragment":"encodings_fragment"}>
          }`})),h]},[]);return Ee(h=>{var f;let d=t==null||(f=t.current)==null?void 0:f.__r3f.parent;if(d){if(s)r.matrixWorld.identity();else{var p;i&&((p=t.current)==null?void 0:p.blend)===1&&d.updateWorldMatrix(!0,!1),r.matrixWorld.copy(d.matrixWorld)}if(i){var m,g,y;((m=t.current)==null?void 0:m.blend)>0&&((g=t.current)==null?void 0:g.blend)<1?(u.value=t.current.blend,h.gl.setRenderTarget(a),h.gl.render(r,h.camera),h.gl.setRenderTarget(c),h.gl.render(e,h.camera),h.gl.setRenderTarget(null),l.render(h.gl)):((y=t.current)==null?void 0:y.blend)===1&&h.gl.render(r,h.camera)}}},i),A.createElement(A.Fragment,null)}const WT=(n,e,t)=>{let i=new It(n,e,{minFilter:Po,magFilter:zt,type:Jt,format:Is,generateMipmaps:!0}),s=new It(n,e,{minFilter:Xe,magFilter:Xe}),r=new It(n,e,{minFilter:Xe,magFilter:Xe}),o=new It(n,e,{minFilter:Xe,magFilter:Xe}),a=new It(n,e,{minFilter:Xe,magFilter:Xe}),c=new It(n,e,{minFilter:Xe,magFilter:Xe,type:Jt,format:Is}),l=new It(n,e,{minFilter:Xe,magFilter:Xe,type:Jt,format:Is});const u=new xs(new Dt({uniforms:{tex:{value:null}},vertexShader:`
        varying vec2 vUv;
        void main() {
          vUv = uv;
          gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        }`,fragmentShader:`
        uniform sampler2D tex;
        varying vec2 vUv;
        #include <packing>
        void main() {
          gl_FragColor = pack2HalfToRGBA(vUv * (round(texture2D(tex, vUv).x)));
        }`})),h=new xs(new Dt({uniforms:{tex:{value:null}},vertexShader:`
        varying vec2 vUv;
        void main() {
          vUv = uv;
          gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        }`,fragmentShader:`
        uniform sampler2D tex;
        varying vec2 vUv;
        #include <packing>
        void main() {
          gl_FragColor = pack2HalfToRGBA(vUv * (1.0 - round(texture2D(tex, vUv).x)));
        }`})),f=new xs(new Dt({uniforms:{tex:{value:null},offset:{value:0},level:{value:0},maxSteps:{value:0}},vertexShader:`
        varying vec2 vUv;
        void main() {
          vUv = uv;
          gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        }`,fragmentShader:`
        varying vec2 vUv;
        uniform sampler2D tex;
        uniform float offset;
        uniform float level;
        uniform float maxSteps;
        #include <packing>
        void main() {
          float closestDist = 9999999.9;
          vec2 closestPos = vec2(0.0);
          for (float x = -1.0; x <= 1.0; x += 1.0) {
            for (float y = -1.0; y <= 1.0; y += 1.0) {
              vec2 voffset = vUv;
              voffset += vec2(x, y) * vec2(${1/n}, ${1/e}) * offset;
              vec2 pos = unpackRGBATo2Half(texture2D(tex, voffset));
              float dist = distance(pos.xy, vUv);
              if(pos.x != 0.0 && pos.y != 0.0 && dist < closestDist) {
                closestDist = dist;
                closestPos = pos;
              }
            }
          }
          gl_FragColor = pack2HalfToRGBA(closestPos);
        }`})),d=new xs(new Dt({uniforms:{tex:{value:null},size:{value:new de(n,e)}},vertexShader:`
        varying vec2 vUv;
        void main() {
          vUv = uv;
          gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        }`,fragmentShader:`
        varying vec2 vUv;
        uniform sampler2D tex;
        uniform vec2 size;
        #include <packing>
        void main() {
          gl_FragColor = vec4(distance(size * unpackRGBATo2Half(texture2D(tex, vUv)), size * vUv), 0.0, 0.0, 0.0);
        }`})),p=new xs(new Dt({uniforms:{inside:{value:l.texture},outside:{value:c.texture},tex:{value:null}},vertexShader:`
        varying vec2 vUv;
        void main() {
          vUv = uv;
          gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
        }`,fragmentShader:`
        varying vec2 vUv;
        uniform sampler2D inside;
        uniform sampler2D outside;
        uniform sampler2D tex;
        #include <packing>
        void main() {
          float i = texture2D(inside, vUv).x;
          float o =texture2D(outside, vUv).x;
          if (texture2D(tex, vUv).x == 0.0) {
            gl_FragColor = vec4(o, 0.0, 0.0, 0.0);
          } else {
            gl_FragColor = vec4(-i, 0.0, 0.0, 0.0);
          }
        }`}));return m=>{let g=i;m.minFilter=Xe,m.magFilter=Xe,u.material.uniforms.tex.value=m,t.setRenderTarget(s),u.render(t);const y=Math.ceil(Math.log(Math.max(n,e))/Math.log(2));let v=s,E=null;for(let C=0;C<y;C++){const x=Math.pow(2,y-C-1);E=v===s?o:s,f.material.uniforms.level.value=C,f.material.uniforms.maxSteps.value=y,f.material.uniforms.offset.value=x,f.material.uniforms.tex.value=v.texture,t.setRenderTarget(E),f.render(t),v=E}t.setRenderTarget(c),d.material.uniforms.tex.value=E.texture,d.render(t),h.material.uniforms.tex.value=m,t.setRenderTarget(r),h.render(t),v=r;for(let C=0;C<y;C++){const x=Math.pow(2,y-C-1);E=v===r?a:r,f.material.uniforms.level.value=C,f.material.uniforms.maxSteps.value=y,f.material.uniforms.offset.value=x,f.material.uniforms.tex.value=v.texture,t.setRenderTarget(E),f.render(t),v=E}return t.setRenderTarget(l),d.material.uniforms.tex.value=E.texture,d.render(t),t.setRenderTarget(g),p.material.uniforms.tex.value=m,p.render(t),t.setRenderTarget(null),g}},jT={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1},xm=n=>{let e;const t=new Set,i=(u,h)=>{const f=typeof u=="function"?u(e):u;if(!Object.is(f,e)){const d=e;e=h??(typeof f!="object"||f===null)?f:Object.assign({},e,f),t.forEach(p=>p(e,d))}},s=()=>e,c={setState:i,getState:s,getInitialState:()=>l,subscribe:u=>(t.add(u),()=>t.delete(u)),destroy:()=>{(jT?"production":void 0)!=="production"&&console.warn("[DEPRECATED] The `destroy` method will be unsupported in a future version. Instead use unsubscribe function returned by subscribe. Everything will be garbage-collected if store is garbage-collected."),t.clear()}},l=e=n(i,s,c);return c},JT=n=>n?xm(n):xm;var N2={exports:{}},G2={},z2={exports:{}},H2={};/**
 * @license React
 * use-sync-external-store-shim.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var vr=A;function qT(n,e){return n===e&&(n!==0||1/n===1/e)||n!==n&&e!==e}var XT=typeof Object.is=="function"?Object.is:qT,ZT=vr.useState,eB=vr.useEffect,tB=vr.useLayoutEffect,iB=vr.useDebugValue;function sB(n,e){var t=e(),i=ZT({inst:{value:t,getSnapshot:e}}),s=i[0].inst,r=i[1];return tB(function(){s.value=t,s.getSnapshot=e,wu(s)&&r({inst:s})},[n,t,e]),eB(function(){return wu(s)&&r({inst:s}),n(function(){wu(s)&&r({inst:s})})},[n]),iB(t),t}function wu(n){var e=n.getSnapshot;n=n.value;try{var t=e();return!XT(n,t)}catch{return!0}}function nB(n,e){return e()}var rB=typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"?nB:sB;H2.useSyncExternalStore=vr.useSyncExternalStore!==void 0?vr.useSyncExternalStore:rB;z2.exports=H2;var oB=z2.exports;/**
 * @license React
 * use-sync-external-store-shim/with-selector.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var jc=A,aB=oB;function cB(n,e){return n===e&&(n!==0||1/n===1/e)||n!==n&&e!==e}var lB=typeof Object.is=="function"?Object.is:cB,uB=aB.useSyncExternalStore,hB=jc.useRef,fB=jc.useEffect,dB=jc.useMemo,AB=jc.useDebugValue;G2.useSyncExternalStoreWithSelector=function(n,e,t,i,s){var r=hB(null);if(r.current===null){var o={hasValue:!1,value:null};r.current=o}else o=r.current;r=dB(function(){function c(d){if(!l){if(l=!0,u=d,d=i(d),s!==void 0&&o.hasValue){var p=o.value;if(s(p,d))return h=p}return h=d}if(p=h,lB(u,d))return p;var m=i(d);return s!==void 0&&s(p,m)?p:(u=d,h=m)}var l=!1,u,h,f=t===void 0?null:t;return[function(){return c(e())},f===null?void 0:function(){return c(f())}]},[e,t,i,s]);var a=uB(n,r[0],r[1]);return fB(function(){o.hasValue=!0,o.value=a},[a]),AB(a),a};N2.exports=G2;var mB=N2.exports;const pB=kh(mB),K2={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1},{useDebugValue:gB}=is,{useSyncExternalStoreWithSelector:yB}=pB;let Cm=!1;const EB=n=>n;function vB(n,e=EB,t){(K2?"production":void 0)!=="production"&&t&&!Cm&&(console.warn("[DEPRECATED] Use `createWithEqualityFn` instead of `create` or use `useStoreWithEqualityFn` instead of `useStore`. They can be imported from 'zustand/traditional'. https://github.com/pmndrs/zustand/discussions/1937"),Cm=!0);const i=yB(n.subscribe,n.getState,n.getServerState||n.getInitialState,e,t);return gB(i),i}const Im=n=>{(K2?"production":void 0)!=="production"&&typeof n!="function"&&console.warn("[DEPRECATED] Passing a vanilla store will be unsupported in a future version. Instead use `import { useStore } from 'zustand'`.");const e=typeof n=="function"?JT(n):n,t=(i,s)=>vB(e,i,s);return Object.assign(t,e),t},xB=n=>n?Im(n):Im;var Sm,wm;const Tm=typeof window<"u"&&((Sm=window.document)!=null&&Sm.createElement||((wm=window.navigator)==null?void 0:wm.product)==="ReactNative")?is.useLayoutEffect:is.useEffect;function CB(){const n=xB(e=>({current:new Array,version:0,set:e}));return{In:({children:e})=>{const t=n(s=>s.set),i=n(s=>s.version);return Tm(()=>{t(s=>({version:s.version+1}))},[]),Tm(()=>(t(({current:s})=>({current:[...s,e]})),()=>t(({current:s})=>({current:s.filter(r=>r!==e)}))),[e,i]),null},Out:()=>{const e=n(t=>t.current);return is.createElement(is.Fragment,null,e)}}}const IB=n=>n&&n.isOrthographicCamera,Bm=new xe,V2=CB();function Y2(n){return"top"in n}function Tu(n,e){const{right:t,top:i,left:s,bottom:r,width:o,height:a}=e,c=e.bottom<0||i>n.height||t<0||e.left>n.width;if(Y2(n)){const h=n.top+n.height-r,f=s-n.left;return{position:{width:o,height:a,left:f,top:i,bottom:h,right:t},isOffscreen:c}}const l=n.height-r;return{position:{width:o,height:a,top:i,left:s,bottom:l,right:t},isOffscreen:c}}function Bu(n,{left:e,bottom:t,width:i,height:s}){let r;const o=i/s;return IB(n.camera)?(n.camera.left!==i/-2||n.camera.right!==i/2||n.camera.top!==s/2||n.camera.bottom!==s/-2)&&(Object.assign(n.camera,{left:i/-2,right:i/2,top:s/2,bottom:s/-2}),n.camera.updateProjectionMatrix()):n.camera.aspect!==o&&(n.camera.aspect=o,n.camera.updateProjectionMatrix()),r=n.gl.autoClear,n.gl.autoClear=!1,n.gl.setViewport(e,t,i,s),n.gl.setScissor(e,t,i,s),n.gl.setScissorTest(!0),r}function _u(n,e){n.gl.setScissorTest(!1),n.gl.autoClear=e}function _m(n){n.gl.getClearColor(Bm),n.gl.setClearColor(Bm,n.gl.getClearAlpha()),n.gl.clear(!0,!0)}function SB({visible:n=!0,canvasSize:e,scene:t,index:i,children:s,frames:r,rect:o,track:a}){const c=Z(),[l,u]=A.useState(!1);let h=0;return Ee(f=>{if(r===1/0||h<=r){var d;a&&(o.current=(d=a.current)==null?void 0:d.getBoundingClientRect()),h++}if(o.current){const{position:p,isOffscreen:m}=Tu(e,o.current);if(l!==m&&u(m),n&&!l&&o.current){const g=Bu(f,p);f.gl.render(s?f.scene:t,f.camera),_u(f,g)}}},i),A.useLayoutEffect(()=>{const f=o.current;if(f&&(!n||!l)){const{position:d}=Tu(e,f),p=Bu(c,d);_m(c),_u(c,p)}},[n,l]),A.useEffect(()=>{if(!a)return;const f=o.current,d=c.get().events.connected;return c.setEvents({connected:a.current}),()=>{if(f){const{position:p}=Tu(e,f),m=Bu(c,p);_m(c),_u(c,m)}c.setEvents({connected:d})}},[a]),A.useEffect(()=>{Y2(e)||console.warn(`Detected @react-three/fiber canvas size does not include position information. <View /> may not work as expected. Upgrade to @react-three/fiber ^8.1.0 for support.
 See https://github.com/pmndrs/drei/issues/944`)},[]),A.createElement(A.Fragment,null,s,A.createElement("group",{onPointerOver:()=>null}))}const $2=A.forwardRef(({track:n,visible:e=!0,index:t=1,id:i,style:s,className:r,frames:o=1/0,children:a,...c},l)=>{var u,h,f,d;const p=A.useRef(null),{size:m,scene:g}=Z(),[y]=A.useState(()=>new Sr),[v,E]=A.useReducer(()=>!0,!1),C=A.useCallback((x,I)=>{if(p.current&&n&&n.current&&x.target===n.current){const{width:S,height:w,left:B,top:T}=p.current,R=x.clientX-B,_=x.clientY-T;I.pointer.set(R/S*2-1,-(_/w)*2+1),I.raycaster.setFromCamera(I.pointer,I.camera)}},[p,n]);return A.useEffect(()=>{var x;n&&(p.current=(x=n.current)==null?void 0:x.getBoundingClientRect()),E()},[n]),A.createElement("group",ie({ref:l},c),v&&Ir(A.createElement(SB,{visible:e,canvasSize:m,frames:o,scene:g,track:n,rect:p,index:t},a),y,{events:{compute:C,priority:t},size:{width:(u=p.current)==null?void 0:u.width,height:(h=p.current)==null?void 0:h.height,top:(f=p.current)==null?void 0:f.top,left:(d=p.current)==null?void 0:d.left}}))}),wB=A.forwardRef(({as:n="div",id:e,visible:t,className:i,style:s,index:r=1,track:o,frames:a=1/0,children:c,...l},u)=>{const h=A.useId(),f=A.useRef(null);return A.useImperativeHandle(u,()=>f.current),A.createElement(A.Fragment,null,A.createElement(n,ie({ref:f,id:e,className:i,style:s},l)),A.createElement(V2.In,null,A.createElement($2,{visible:t,key:h,track:f,frames:a,index:r},c)))}),TB=A.forwardRef((n,e)=>A.useContext(Nu)?A.createElement($2,ie({ref:e},n)):A.createElement(wB,ie({ref:e},n)));TB.Port=()=>A.createElement(V2.Out,null);const No=A.createContext(null),Ga=new b,bm=new b,BB=(n,e,t,i)=>{const s=e.dot(e),r=e.dot(n)-e.dot(t),o=e.dot(i);return o===0?-r/s:(Ga.copy(i).multiplyScalar(s/o).sub(e),bm.copy(i).multiplyScalar(r/o).add(t).sub(n),-Ga.dot(bm)/Ga.dot(Ga))},_B=new b(0,1,0),Rm=new ce,bu=({direction:n,axis:e})=>{const{translation:t,translationLimits:i,annotations:s,annotationsClass:r,depthTest:o,scale:a,lineWidth:c,fixed:l,axisColors:u,hoveredColor:h,opacity:f,onDragStart:d,onDrag:p,onDragEnd:m,userData:g}=A.useContext(No),y=Z(G=>G.controls),v=A.useRef(null),E=A.useRef(null),C=A.useRef(null),x=A.useRef(0),[I,S]=A.useState(!1),w=A.useCallback(G=>{s&&(v.current.innerText=`${t.current[e].toFixed(2)}`,v.current.style.display="block"),G.stopPropagation();const z=new ce().extractRotation(E.current.matrixWorld),H=G.point.clone(),N=new b().setFromMatrixPosition(E.current.matrixWorld),V=n.clone().applyMatrix4(z).normalize();C.current={clickPoint:H,dir:V},x.current=t.current[e],d({component:"Arrow",axis:e,origin:N,directions:[V]}),y&&(y.enabled=!1),G.target.setPointerCapture(G.pointerId)},[s,n,y,d,t,e]),B=A.useCallback(G=>{if(G.stopPropagation(),I||S(!0),C.current){const{clickPoint:z,dir:H}=C.current,[N,V]=(i==null?void 0:i[e])||[void 0,void 0];let $=BB(z,H,G.ray.origin,G.ray.direction);N!==void 0&&($=Math.max($,N-x.current)),V!==void 0&&($=Math.min($,V-x.current)),t.current[e]=x.current+$,s&&(v.current.innerText=`${t.current[e].toFixed(2)}`),Rm.makeTranslation(H.x*$,H.y*$,H.z*$),p(Rm)}},[s,p,I,t,i,e]),T=A.useCallback(G=>{s&&(v.current.style.display="none"),G.stopPropagation(),C.current=null,m(),y&&(y.enabled=!0),G.target.releasePointerCapture(G.pointerId)},[s,y,m]),R=A.useCallback(G=>{G.stopPropagation(),S(!1)},[]),{cylinderLength:_,coneWidth:L,coneLength:O,matrixL:U}=A.useMemo(()=>{const G=l?c/a*1.6:a/20,z=l?.2:a/5,H=l?1-z:a-z,N=new Be().setFromUnitVectors(_B,n.clone().normalize()),V=new ce().makeRotationFromQuaternion(N);return{cylinderLength:H,coneWidth:G,coneLength:z,matrixL:V}},[n,a,c,l]),Q=I?h:u[e];return A.createElement("group",{ref:E},A.createElement("group",{matrix:U,matrixAutoUpdate:!1,onPointerDown:w,onPointerMove:B,onPointerUp:T,onPointerOut:R},s&&A.createElement(Lc,{position:[0,-O,0]},A.createElement("div",{style:{display:"none",background:"#151520",color:"white",padding:"6px 8px",borderRadius:7,whiteSpace:"nowrap"},className:r,ref:v})),A.createElement("mesh",{visible:!1,position:[0,(_+O)/2,0],userData:g},A.createElement("cylinderGeometry",{args:[L*1.4,L*1.4,_+O,8,1]})),A.createElement(cs,{transparent:!0,raycast:()=>null,depthTest:o,points:[0,0,0,0,_,0],lineWidth:c,side:Tt,color:Q,opacity:f,polygonOffset:!0,renderOrder:1,polygonOffsetFactor:-10,fog:!1}),A.createElement("mesh",{raycast:()=>null,position:[0,_+O/2,0],renderOrder:500},A.createElement("coneGeometry",{args:[L,O,24,1]}),A.createElement("meshBasicMaterial",{transparent:!0,depthTest:o,color:Q,opacity:f,polygonOffset:!0,polygonOffsetFactor:-10,fog:!1}))))},Ru=new b,Du=new b,Mu=n=>n*180/Math.PI,bB=n=>n*Math.PI/180,RB=(n,e,t,i,s)=>{Ru.copy(n).sub(t),Du.copy(e).sub(t);const r=i.dot(i),o=s.dot(s),a=Ru.dot(i)/r,c=Ru.dot(s)/o,l=Du.dot(i)/r,u=Du.dot(s)/o,h=Math.atan2(c,a);return Math.atan2(u,l)-h},DB=(n,e)=>{let t=Math.floor(n/e);return t=t<0?t+1:t,n-t*e},Dm=n=>{let e=DB(n,2*Math.PI);return Math.abs(e)<1e-6?0:(e<0&&(e+=2*Math.PI),e)},za=new ce,Mm=new b,Ha=new Fo,Lu=new b,Pu=({dir1:n,dir2:e,axis:t})=>{const{rotationLimits:i,annotations:s,annotationsClass:r,depthTest:o,scale:a,lineWidth:c,fixed:l,axisColors:u,hoveredColor:h,opacity:f,onDragStart:d,onDrag:p,onDragEnd:m,userData:g}=A.useContext(No),y=Z(Q=>Q.controls),v=A.useRef(null),E=A.useRef(null),C=A.useRef(0),x=A.useRef(0),I=A.useRef(null),[S,w]=A.useState(!1),B=A.useCallback(Q=>{s&&(v.current.innerText=`${Mu(x.current).toFixed(0)}º`,v.current.style.display="block"),Q.stopPropagation();const G=Q.point.clone(),z=new b().setFromMatrixPosition(E.current.matrixWorld),H=new b().setFromMatrixColumn(E.current.matrixWorld,0).normalize(),N=new b().setFromMatrixColumn(E.current.matrixWorld,1).normalize(),V=new b().setFromMatrixColumn(E.current.matrixWorld,2).normalize(),$=new bs().setFromNormalAndCoplanarPoint(V,z);I.current={clickPoint:G,origin:z,e1:H,e2:N,normal:V,plane:$},d({component:"Rotator",axis:t,origin:z,directions:[H,N,V]}),y&&(y.enabled=!1),Q.target.setPointerCapture(Q.pointerId)},[s,y,d,t]),T=A.useCallback(Q=>{if(Q.stopPropagation(),S||w(!0),I.current){const{clickPoint:G,origin:z,e1:H,e2:N,normal:V,plane:$}=I.current,[Y,M]=(i==null?void 0:i[t])||[void 0,void 0];Ha.copy(Q.ray),Ha.intersectPlane($,Lu),Ha.direction.negate(),Ha.intersectPlane($,Lu);let k=RB(G,Lu,z,H,N),P=Mu(k);Q.shiftKey&&(P=Math.round(P/10)*10,k=bB(P)),Y!==void 0&&M!==void 0&&M-Y<2*Math.PI?(k=Dm(k),k=k>Math.PI?k-2*Math.PI:k,k=Ce.clamp(k,Y-C.current,M-C.current),x.current=C.current+k):(x.current=Dm(C.current+k),x.current=x.current>Math.PI?x.current-2*Math.PI:x.current),s&&(P=Mu(x.current),v.current.innerText=`${P.toFixed(0)}º`),za.makeRotationAxis(V,k),Mm.copy(z).applyMatrix4(za).sub(z).negate(),za.setPosition(Mm),p(za)}},[s,p,S,i,t]),R=A.useCallback(Q=>{s&&(v.current.style.display="none"),Q.stopPropagation(),C.current=x.current,I.current=null,m(),y&&(y.enabled=!0),Q.target.releasePointerCapture(Q.pointerId)},[s,y,m]),_=A.useCallback(Q=>{Q.stopPropagation(),w(!1)},[]),L=A.useMemo(()=>{const Q=n.clone().normalize(),G=e.clone().normalize();return new ce().makeBasis(Q,G,Q.clone().cross(G))},[n,e]),O=l?.65:a*.65,U=A.useMemo(()=>{const G=[];for(let z=0;z<=32;z++){const H=z*(Math.PI/2)/32;G.push(new b(Math.cos(H)*O,Math.sin(H)*O,0))}return G},[O]);return A.createElement("group",{ref:E,onPointerDown:B,onPointerMove:T,onPointerUp:R,onPointerOut:_,matrix:L,matrixAutoUpdate:!1},s&&A.createElement(Lc,{position:[O,O,0]},A.createElement("div",{style:{display:"none",background:"#151520",color:"white",padding:"6px 8px",borderRadius:7,whiteSpace:"nowrap"},className:r,ref:v})),A.createElement(cs,{points:U,lineWidth:c*4,visible:!1,userData:g}),A.createElement(cs,{transparent:!0,raycast:()=>null,depthTest:o,points:U,lineWidth:c,side:Tt,color:S?h:u[t],opacity:f,polygonOffset:!0,polygonOffsetFactor:-10,fog:!1}))},MB=(n,e,t)=>{const i=Math.abs(n.x)>=Math.abs(n.y)&&Math.abs(n.x)>=Math.abs(n.z)?0:Math.abs(n.y)>=Math.abs(n.x)&&Math.abs(n.y)>=Math.abs(n.z)?1:2,s=[0,1,2].sort((p,m)=>Math.abs(e.getComponent(m))-Math.abs(e.getComponent(p))),r=i===s[0]?s[1]:s[0],o=n.getComponent(i),a=n.getComponent(r),c=e.getComponent(i),l=e.getComponent(r),u=t.getComponent(i),f=(t.getComponent(r)-u*(a/o))/(l-c*(a/o));return[(u-f*c)/o,f]},Ka=new Fo,Va=new b,Lm=new ce,Fu=({dir1:n,dir2:e,axis:t})=>{const{translation:i,translationLimits:s,annotations:r,annotationsClass:o,depthTest:a,scale:c,lineWidth:l,fixed:u,axisColors:h,hoveredColor:f,opacity:d,onDragStart:p,onDrag:m,onDragEnd:g,userData:y}=A.useContext(No),v=Z(H=>H.controls),E=A.useRef(null),C=A.useRef(null),x=A.useRef(null),I=A.useRef(0),S=A.useRef(0),[w,B]=A.useState(!1),T=A.useCallback(H=>{r&&(E.current.innerText=`${i.current[(t+1)%3].toFixed(2)}, ${i.current[(t+2)%3].toFixed(2)}`,E.current.style.display="block"),H.stopPropagation();const N=H.point.clone(),V=new b().setFromMatrixPosition(C.current.matrixWorld),$=new b().setFromMatrixColumn(C.current.matrixWorld,0).normalize(),Y=new b().setFromMatrixColumn(C.current.matrixWorld,1).normalize(),M=new b().setFromMatrixColumn(C.current.matrixWorld,2).normalize(),k=new bs().setFromNormalAndCoplanarPoint(M,V);x.current={clickPoint:N,e1:$,e2:Y,plane:k},I.current=i.current[(t+1)%3],S.current=i.current[(t+2)%3],p({component:"Slider",axis:t,origin:V,directions:[$,Y,M]}),v&&(v.enabled=!1),H.target.setPointerCapture(H.pointerId)},[r,v,p,t]),R=A.useCallback(H=>{if(H.stopPropagation(),w||B(!0),x.current){const{clickPoint:N,e1:V,e2:$,plane:Y}=x.current,[M,k]=(s==null?void 0:s[(t+1)%3])||[void 0,void 0],[P,F]=(s==null?void 0:s[(t+2)%3])||[void 0,void 0];Ka.copy(H.ray),Ka.intersectPlane(Y,Va),Ka.direction.negate(),Ka.intersectPlane(Y,Va),Va.sub(N);let[J,se]=MB(V,$,Va);M!==void 0&&(J=Math.max(J,M-I.current)),k!==void 0&&(J=Math.min(J,k-I.current)),P!==void 0&&(se=Math.max(se,P-S.current)),F!==void 0&&(se=Math.min(se,F-S.current)),i.current[(t+1)%3]=I.current+J,i.current[(t+2)%3]=S.current+se,r&&(E.current.innerText=`${i.current[(t+1)%3].toFixed(2)}, ${i.current[(t+2)%3].toFixed(2)}`),Lm.makeTranslation(J*V.x+se*$.x,J*V.y+se*$.y,J*V.z+se*$.z),m(Lm)}},[r,m,w,i,s,t]),_=A.useCallback(H=>{r&&(E.current.style.display="none"),H.stopPropagation(),x.current=null,g(),v&&(v.enabled=!0),H.target.releasePointerCapture(H.pointerId)},[r,v,g]),L=A.useCallback(H=>{H.stopPropagation(),B(!1)},[]),O=A.useMemo(()=>{const H=n.clone().normalize(),N=e.clone().normalize();return new ce().makeBasis(H,N,H.clone().cross(N))},[n,e]),U=u?1/7:c/7,Q=u?.225:c*.225,G=w?f:h[t],z=A.useMemo(()=>[new b(0,0,0),new b(0,Q,0),new b(Q,Q,0),new b(Q,0,0),new b(0,0,0)],[Q]);return A.createElement("group",{ref:C,matrix:O,matrixAutoUpdate:!1},r&&A.createElement(Lc,{position:[0,0,0]},A.createElement("div",{style:{display:"none",background:"#151520",color:"white",padding:"6px 8px",borderRadius:7,whiteSpace:"nowrap"},className:o,ref:E})),A.createElement("group",{position:[U*1.7,U*1.7,0]},A.createElement("mesh",{visible:!0,onPointerDown:T,onPointerMove:R,onPointerUp:_,onPointerOut:L,scale:Q,userData:y},A.createElement("planeGeometry",null),A.createElement("meshBasicMaterial",{transparent:!0,depthTest:a,color:G,polygonOffset:!0,polygonOffsetFactor:-10,side:Tt,fog:!1})),A.createElement(cs,{position:[-Q/2,-Q/2,0],transparent:!0,depthTest:a,points:z,lineWidth:l,color:G,opacity:d,polygonOffset:!0,polygonOffsetFactor:-10,userData:y,fog:!1})))},vo=new b,Pm=new b,LB=(n,e,t,i)=>{const s=e.dot(e),r=e.dot(n)-e.dot(t),o=e.dot(i);return o===0?-r/s:(vo.copy(i).multiplyScalar(s/o).sub(e),Pm.copy(i).multiplyScalar(r/o).add(t).sub(n),-vo.dot(Pm)/vo.dot(vo))},PB=new b(0,1,0),ho=new b,Fm=new ce,ku=({direction:n,axis:e})=>{const{scaleLimits:t,annotations:i,annotationsClass:s,depthTest:r,scale:o,lineWidth:a,fixed:c,axisColors:l,hoveredColor:u,opacity:h,onDragStart:f,onDrag:d,onDragEnd:p,userData:m}=A.useContext(No),g=Z(z=>z.size),y=Z(z=>z.controls),v=A.useRef(null),E=A.useRef(null),C=A.useRef(null),x=A.useRef(1),I=A.useRef(1),S=A.useRef(null),[w,B]=A.useState(!1),T=c?1.2:1.2*o,R=A.useCallback(z=>{i&&(v.current.innerText=`${I.current.toFixed(2)}`,v.current.style.display="block"),z.stopPropagation();const H=new ce().extractRotation(E.current.matrixWorld),N=z.point.clone(),V=new b().setFromMatrixPosition(E.current.matrixWorld),$=n.clone().applyMatrix4(H).normalize(),Y=E.current.matrixWorld.clone(),M=Y.clone().invert(),k=c?1/qh(E.current.getWorldPosition(vo),o,z.camera,g):1;S.current={clickPoint:N,dir:$,mPLG:Y,mPLGInv:M,offsetMultiplier:k},f({component:"Sphere",axis:e,origin:V,directions:[$]}),y&&(y.enabled=!1),z.target.setPointerCapture(z.pointerId)},[i,y,n,f,e,c,o,g]),_=A.useCallback(z=>{if(z.stopPropagation(),w||B(!0),S.current){const{clickPoint:H,dir:N,mPLG:V,mPLGInv:$,offsetMultiplier:Y}=S.current,[M,k]=(t==null?void 0:t[e])||[1e-5,void 0],F=LB(H,N,z.ray.origin,z.ray.direction)*Y,J=c?F:F/o;let se=Math.pow(2,J*.2);z.shiftKey&&(se=Math.round(se*10)/10),se=Math.max(se,M/x.current),k!==void 0&&(se=Math.min(se,k/x.current)),I.current=x.current*se,C.current.position.set(0,T+F,0),i&&(v.current.innerText=`${I.current.toFixed(2)}`),ho.set(1,1,1),ho.setComponent(e,se),Fm.makeScale(ho.x,ho.y,ho.z).premultiply(V).multiply($),d(Fm)}},[i,T,d,w,t,e]),L=A.useCallback(z=>{i&&(v.current.style.display="none"),z.stopPropagation(),x.current=I.current,S.current=null,C.current.position.set(0,T,0),p(),y&&(y.enabled=!0),z.target.releasePointerCapture(z.pointerId)},[i,y,p,T]),O=A.useCallback(z=>{z.stopPropagation(),B(!1)},[]),{radius:U,matrixL:Q}=A.useMemo(()=>{const z=c?a/o*1.8:o/22.5,H=new Be().setFromUnitVectors(PB,n.clone().normalize()),N=new ce().makeRotationFromQuaternion(H);return{radius:z,matrixL:N}},[n,o,a,c]),G=w?u:l[e];return A.createElement("group",{ref:E},A.createElement("group",{matrix:Q,matrixAutoUpdate:!1,onPointerDown:R,onPointerMove:_,onPointerUp:L,onPointerOut:O},i&&A.createElement(Lc,{position:[0,T/2,0]},A.createElement("div",{style:{display:"none",background:"#151520",color:"white",padding:"6px 8px",borderRadius:7,whiteSpace:"nowrap"},className:s,ref:v})),A.createElement("mesh",{ref:C,position:[0,T,0],renderOrder:500,userData:m},A.createElement("sphereGeometry",{args:[U,12,12]}),A.createElement("meshBasicMaterial",{transparent:!0,depthTest:r,color:G,opacity:h,polygonOffset:!0,polygonOffsetFactor:-10}))))},km=new ce,Om=new ce,Um=new ce,Ya=new ce,Ou=new ce,Wn=new ce,Qm=new ce,Nm=new ce,Gm=new ce,jn=new st,Uu=new st,zm=new b,Hm=new b,Km=new b,Vm=new b,fo=new b,Jn=new b(1,0,0),qn=new b(0,1,0),Xn=new b(0,0,1),Lb=A.forwardRef(({enabled:n=!0,matrix:e,onDragStart:t,onDrag:i,onDragEnd:s,autoTransform:r=!0,anchor:o,disableAxes:a=!1,disableSliders:c=!1,disableRotations:l=!1,disableScaling:u=!1,activeAxes:h=[!0,!0,!0],offset:f=[0,0,0],rotation:d=[0,0,0],scale:p=1,lineWidth:m=4,fixed:g=!1,translationLimits:y,rotationLimits:v,scaleLimits:E,depthTest:C=!0,axisColors:x=["#ff2060","#20df80","#2080ff"],hoveredColor:I="#ffff40",annotations:S=!1,annotationsClass:w,opacity:B=1,visible:T=!0,userData:R,children:_,...L},O)=>{const U=Z(k=>k.invalidate),Q=A.useRef(null),G=A.useRef(null),z=A.useRef(null),H=A.useRef(null),N=A.useRef([0,0,0]),V=A.useRef(new b(1,1,1)),$=A.useRef(new b(1,1,1));A.useLayoutEffect(()=>{o&&(H.current.updateWorldMatrix(!0,!0),Ya.copy(H.current.matrixWorld).invert(),jn.makeEmpty(),H.current.traverse(k=>{k.geometry&&(k.geometry.boundingBox||k.geometry.computeBoundingBox(),Wn.copy(k.matrixWorld).premultiply(Ya),Uu.copy(k.geometry.boundingBox),Uu.applyMatrix4(Wn),jn.union(Uu))}),zm.copy(jn.max).add(jn.min).multiplyScalar(.5),Hm.copy(jn.max).sub(jn.min).multiplyScalar(.5),Km.copy(Hm).multiply(new b(...o)).add(zm),Vm.set(...f).add(Km),z.current.position.copy(Vm),U())});const Y=A.useMemo(()=>({onDragStart:k=>{km.copy(G.current.matrix),Om.copy(G.current.matrixWorld),t&&t(k),U()},onDrag:k=>{Um.copy(Q.current.matrixWorld),Ya.copy(Um).invert(),Ou.copy(Om).premultiply(k),Wn.copy(Ou).premultiply(Ya),Qm.copy(km).invert(),Nm.copy(Wn).multiply(Qm),r&&G.current.matrix.copy(Wn),i&&i(Wn,Nm,Ou,k),U()},onDragEnd:()=>{s&&s(),U()},translation:N,translationLimits:y,rotationLimits:v,axisColors:x,hoveredColor:I,opacity:B,scale:p,lineWidth:m,fixed:g,depthTest:C,userData:R,annotations:S,annotationsClass:w}),[t,i,s,N,y,v,E,C,p,m,g,...x,I,B,R,r,S,w]),M=new b;return Ee(k=>{if(g){const P=qh(z.current.getWorldPosition(M),p,k.camera,k.size);V.current.setScalar(P)}e&&e instanceof ce&&(G.current.matrix=e),G.current.updateWorldMatrix(!0,!0),Gm.makeRotationFromEuler(z.current.rotation).setPosition(z.current.position).premultiply(G.current.matrixWorld),$.current.setFromMatrixScale(Gm),fo.copy(V.current).divide($.current),(Math.abs(z.current.scale.x-fo.x)>1e-4||Math.abs(z.current.scale.y-fo.y)>1e-4||Math.abs(z.current.scale.z-fo.z)>1e-4)&&(z.current.scale.copy(fo),k.invalidate())}),A.useImperativeHandle(O,()=>G.current,[]),A.createElement(No.Provider,{value:Y},A.createElement("group",{ref:Q},A.createElement("group",ie({ref:G,matrix:e,matrixAutoUpdate:!1},L),A.createElement("group",{visible:T,ref:z,position:f,rotation:d},n&&A.createElement(A.Fragment,null,!a&&h[0]&&A.createElement(bu,{axis:0,direction:Jn}),!a&&h[1]&&A.createElement(bu,{axis:1,direction:qn}),!a&&h[2]&&A.createElement(bu,{axis:2,direction:Xn}),!c&&h[0]&&h[1]&&A.createElement(Fu,{axis:2,dir1:Jn,dir2:qn}),!c&&h[0]&&h[2]&&A.createElement(Fu,{axis:1,dir1:Xn,dir2:Jn}),!c&&h[2]&&h[1]&&A.createElement(Fu,{axis:0,dir1:qn,dir2:Xn}),!l&&h[0]&&h[1]&&A.createElement(Pu,{axis:2,dir1:Jn,dir2:qn}),!l&&h[0]&&h[2]&&A.createElement(Pu,{axis:1,dir1:Xn,dir2:Jn}),!l&&h[2]&&h[1]&&A.createElement(Pu,{axis:0,dir1:qn,dir2:Xn}),!u&&h[0]&&A.createElement(ku,{axis:0,direction:Jn}),!u&&h[1]&&A.createElement(ku,{axis:1,direction:qn}),!u&&h[2]&&A.createElement(ku,{axis:2,direction:Xn}))),A.createElement("group",{ref:H},_))))}),FB=new b(0,0,-1),kB=function(){const n=new b,e=new b,t=new b,i=new b,s=new b;return function(r,o,a,c){return n.copy(r),e.copy(o),t.copy(a),i.copy(e).sub(n),s.copy(t).sub(n),c.crossVectors(s,i).normalize()}}();function OB(n,e){return n.clone().add(e).multiplyScalar(.5)}const UB=A.forwardRef(({points:n=Qu.SAMPLE_FACELANDMARKER_RESULT.faceLandmarks[0],face:e,facialTransformationMatrix:t,faceBlendshapes:i,offset:s,offsetScalar:r=80,width:o,height:a,depth:c=1,verticalTri:l=[159,386,152],origin:u,eyes:h=!0,eyesAsOrigin:f=!1,debug:d=!1,children:p,...m},g)=>{var y;e&&(n=e.keypoints,console.warn("Facemesh `face` prop is deprecated: use `points` instead"));const v=A.useRef(null),E=A.useRef(null),C=A.useRef(null),x=A.useRef(null),I=A.useRef(null),S=A.useRef(null),w=A.useRef(null),[B]=A.useState(()=>new b),[T]=A.useState(()=>new lt),[R]=A.useState(()=>new Be),[_]=A.useState(()=>new b),{invalidate:L}=Z();A.useEffect(()=>{var H;(H=I.current)==null||H.geometry.setIndex(Qu.TRIANGULATION)},[]);const[O]=A.useState(()=>new b);A.useEffect(()=>{var H,N;const V=(H=I.current)==null?void 0:H.geometry;if(!V)return;if(V.setFromPoints(n),V.setDrawRange(0,Qu.TRIANGULATION.length),t)if(T.matrix.fromArray(t.data),T.matrix.decompose(T.position,T.quaternion,T.scale),T.rotation.y*=-1,T.rotation.z*=-1,R.setFromEuler(T.rotation),s){var $;T.position.y*=-1,T.position.z*=-1,($=v.current)==null||$.position.copy(T.position.divideScalar(r))}else{var Y;(Y=v.current)==null||Y.position.set(0,0,0)}else kB(n[l[0]],n[l[1]],n[l[2]],B),R.setFromUnitVectors(FB,B);const M=R.clone().invert();if(V.computeBoundingBox(),d&&L(),V.center(),V.applyQuaternion(M),(N=x.current)==null||N.setRotationFromQuaternion(R),h){if(!i)console.warn("Facemesh `eyes` option only works if `faceBlendshapes` is provided: skipping.");else if(S.current&&w.current&&C.current)if(f){const k=S.current._computeSphere(V),P=w.current._computeSphere(V);u=OB(k.center,P.center).negate(),S.current._update(V,i,k),w.current._update(V,i,P)}else S.current._update(V,i),w.current._update(V,i)}if(C.current){if(u!==void 0)if(typeof u=="number"){const k=V.getAttribute("position");_.set(-k.getX(u),-k.getY(u),-k.getZ(u))}else u.isVector3&&_.copy(u);else _.setScalar(0);C.current.position.copy(_)}if(E.current){let k=1;(o||a||c)&&(V.boundingBox.getSize(O),o&&(k=o/O.x),a&&(k=a/O.y),c&&(k=c/O.z)),E.current.scale.setScalar(k!==1?k:1)}V.computeVertexNormals(),V.attributes.position.needsUpdate=!0},[n,t,i,T,s,r,o,a,c,l,u,h,d,L,B,R,O,_]);const U=A.useMemo(()=>({outerRef:x,meshRef:I,eyeRightRef:S,eyeLeftRef:w}),[]);A.useImperativeHandle(g,()=>U,[U]);const[Q]=A.useState(()=>new b),G=(y=I.current)==null?void 0:y.geometry.boundingBox,z=(G==null?void 0:G.getSize(Q).z)||1;return A.createElement("group",m,A.createElement("group",{ref:v},A.createElement("group",{ref:x},A.createElement("group",{ref:E},d?A.createElement(A.Fragment,null,A.createElement("axesHelper",{args:[z]}),A.createElement(cs,{points:[[0,0,0],[0,0,-z]],color:65535})):null,A.createElement("group",{ref:C},h&&i&&A.createElement("group",{name:"eyes"},A.createElement(Ym,{side:"left",ref:S,debug:d}),A.createElement(Ym,{side:"right",ref:w,debug:d})),A.createElement("mesh",{ref:I,name:"face"},p,d?A.createElement(A.Fragment,null,G&&A.createElement("box3Helper",{args:[G]})):null))))))}),Ao={contourLandmarks:{right:[33,133,159,145,153],left:[263,362,386,374,380]},blendshapes:{right:[14,16,18,12],left:[13,15,17,11]},color:{right:"red",left:"#00ff00"},fov:{horizontal:100,vertical:90}},Ym=A.forwardRef(({side:n,debug:e=!0},t)=>{const i=A.useRef(null),s=A.useRef(null),[r]=A.useState(()=>new si),o=A.useCallback(h=>{const f=h.getAttribute("position"),p=Ao.contourLandmarks[n].map(m=>new b(f.getX(m),f.getY(m),f.getZ(m)));return r.center.set(0,0,0),p.forEach(m=>r.center.add(m)),r.center.divideScalar(p.length),r.radius=p[0].sub(p[1]).length()/2,r},[r,n]),[a]=A.useState(()=>new ai),c=A.useCallback((h,f,d)=>{if(i.current){var p;(p=d)!==null&&p!==void 0||(d=o(h)),i.current.position.copy(d.center),i.current.scale.setScalar(d.radius)}if(f&&s.current){const m=Ao.blendshapes[n],g=f.categories[m[0]].score,y=f.categories[m[1]].score,v=f.categories[m[2]].score,E=f.categories[m[3]].score,C=Ao.fov.horizontal*Ce.DEG2RAD,x=Ao.fov.vertical*Ce.DEG2RAD,I=C*.5*(E-v),S=x*.5*(g-y)*(n==="left"?1:-1);a.set(I,S,0),s.current.setRotationFromEuler(a)}},[o,n,a]),l=A.useMemo(()=>({eyeMeshRef:i,irisDirRef:s,_computeSphere:o,_update:c}),[o,c]);A.useImperativeHandle(t,()=>l,[l]);const u=Ao.color[n];return A.createElement("group",null,A.createElement("group",{ref:i},e&&A.createElement("axesHelper",null),A.createElement("group",{ref:s},A.createElement(A.Fragment,null,e&&A.createElement(cs,{points:[[0,0,0],[0,0,-2]],lineWidth:1,color:u})))))}),Qu={TRIANGULATION:[127,34,139,11,0,37,232,231,120,72,37,39,128,121,47,232,121,128,104,69,67,175,171,148,157,154,155,118,50,101,73,39,40,9,151,108,48,115,131,194,204,211,74,40,185,80,42,183,40,92,186,230,229,118,202,212,214,83,18,17,76,61,146,160,29,30,56,157,173,106,204,194,135,214,192,203,165,98,21,71,68,51,45,4,144,24,23,77,146,91,205,50,187,201,200,18,91,106,182,90,91,181,85,84,17,206,203,36,148,171,140,92,40,39,193,189,244,159,158,28,247,246,161,236,3,196,54,68,104,193,168,8,117,228,31,189,193,55,98,97,99,126,47,100,166,79,218,155,154,26,209,49,131,135,136,150,47,126,217,223,52,53,45,51,134,211,170,140,67,69,108,43,106,91,230,119,120,226,130,247,63,53,52,238,20,242,46,70,156,78,62,96,46,53,63,143,34,227,173,155,133,123,117,111,44,125,19,236,134,51,216,206,205,154,153,22,39,37,167,200,201,208,36,142,100,57,212,202,20,60,99,28,158,157,35,226,113,160,159,27,204,202,210,113,225,46,43,202,204,62,76,77,137,123,116,41,38,72,203,129,142,64,98,240,49,102,64,41,73,74,212,216,207,42,74,184,169,170,211,170,149,176,105,66,69,122,6,168,123,147,187,96,77,90,65,55,107,89,90,180,101,100,120,63,105,104,93,137,227,15,86,85,129,102,49,14,87,86,55,8,9,100,47,121,145,23,22,88,89,179,6,122,196,88,95,96,138,172,136,215,58,172,115,48,219,42,80,81,195,3,51,43,146,61,171,175,199,81,82,38,53,46,225,144,163,110,246,33,7,52,65,66,229,228,117,34,127,234,107,108,69,109,108,151,48,64,235,62,78,191,129,209,126,111,35,143,163,161,246,117,123,50,222,65,52,19,125,141,221,55,65,3,195,197,25,7,33,220,237,44,70,71,139,122,193,245,247,130,33,71,21,162,153,158,159,170,169,150,188,174,196,216,186,92,144,160,161,2,97,167,141,125,241,164,167,37,72,38,12,145,159,160,38,82,13,63,68,71,226,35,111,158,153,154,101,50,205,206,92,165,209,198,217,165,167,97,220,115,218,133,112,243,239,238,241,214,135,169,190,173,133,171,208,32,125,44,237,86,87,178,85,86,179,84,85,180,83,84,181,201,83,182,137,93,132,76,62,183,61,76,184,57,61,185,212,57,186,214,207,187,34,143,156,79,239,237,123,137,177,44,1,4,201,194,32,64,102,129,213,215,138,59,166,219,242,99,97,2,94,141,75,59,235,24,110,228,25,130,226,23,24,229,22,23,230,26,22,231,112,26,232,189,190,243,221,56,190,28,56,221,27,28,222,29,27,223,30,29,224,247,30,225,238,79,20,166,59,75,60,75,240,147,177,215,20,79,166,187,147,213,112,233,244,233,128,245,128,114,188,114,217,174,131,115,220,217,198,236,198,131,134,177,132,58,143,35,124,110,163,7,228,110,25,356,389,368,11,302,267,452,350,349,302,303,269,357,343,277,452,453,357,333,332,297,175,152,377,384,398,382,347,348,330,303,304,270,9,336,337,278,279,360,418,262,431,304,408,409,310,415,407,270,409,410,450,348,347,422,430,434,313,314,17,306,307,375,387,388,260,286,414,398,335,406,418,364,367,416,423,358,327,251,284,298,281,5,4,373,374,253,307,320,321,425,427,411,421,313,18,321,405,406,320,404,405,315,16,17,426,425,266,377,400,369,322,391,269,417,465,464,386,257,258,466,260,388,456,399,419,284,332,333,417,285,8,346,340,261,413,441,285,327,460,328,355,371,329,392,439,438,382,341,256,429,420,360,364,394,379,277,343,437,443,444,283,275,440,363,431,262,369,297,338,337,273,375,321,450,451,349,446,342,467,293,334,282,458,461,462,276,353,383,308,324,325,276,300,293,372,345,447,382,398,362,352,345,340,274,1,19,456,248,281,436,427,425,381,256,252,269,391,393,200,199,428,266,330,329,287,273,422,250,462,328,258,286,384,265,353,342,387,259,257,424,431,430,342,353,276,273,335,424,292,325,307,366,447,345,271,303,302,423,266,371,294,455,460,279,278,294,271,272,304,432,434,427,272,407,408,394,430,431,395,369,400,334,333,299,351,417,168,352,280,411,325,319,320,295,296,336,319,403,404,330,348,349,293,298,333,323,454,447,15,16,315,358,429,279,14,15,316,285,336,9,329,349,350,374,380,252,318,402,403,6,197,419,318,319,325,367,364,365,435,367,397,344,438,439,272,271,311,195,5,281,273,287,291,396,428,199,311,271,268,283,444,445,373,254,339,263,466,249,282,334,296,449,347,346,264,447,454,336,296,299,338,10,151,278,439,455,292,407,415,358,371,355,340,345,372,390,249,466,346,347,280,442,443,282,19,94,370,441,442,295,248,419,197,263,255,359,440,275,274,300,383,368,351,412,465,263,467,466,301,368,389,380,374,386,395,378,379,412,351,419,436,426,322,373,390,388,2,164,393,370,462,461,164,0,267,302,11,12,374,373,387,268,12,13,293,300,301,446,261,340,385,384,381,330,266,425,426,423,391,429,355,437,391,327,326,440,457,438,341,382,362,459,457,461,434,430,394,414,463,362,396,369,262,354,461,457,316,403,402,315,404,403,314,405,404,313,406,405,421,418,406,366,401,361,306,408,407,291,409,408,287,410,409,432,436,410,434,416,411,264,368,383,309,438,457,352,376,401,274,275,4,421,428,262,294,327,358,433,416,367,289,455,439,462,370,326,2,326,370,305,460,455,254,449,448,255,261,446,253,450,449,252,451,450,256,452,451,341,453,452,413,464,463,441,413,414,258,442,441,257,443,442,259,444,443,260,445,444,467,342,445,459,458,250,289,392,290,290,328,460,376,433,435,250,290,392,411,416,433,341,463,464,453,464,465,357,465,412,343,412,399,360,363,440,437,399,456,420,456,363,401,435,288,372,383,353,339,255,249,448,261,255,133,243,190,133,155,112,33,246,247,33,130,25,398,384,286,362,398,414,362,463,341,263,359,467,263,249,255,466,467,260,75,60,166,238,239,79,162,127,139,72,11,37,121,232,120,73,72,39,114,128,47,233,232,128,103,104,67,152,175,148,173,157,155,119,118,101,74,73,40,107,9,108,49,48,131,32,194,211,184,74,185,191,80,183,185,40,186,119,230,118,210,202,214,84,83,17,77,76,146,161,160,30,190,56,173,182,106,194,138,135,192,129,203,98,54,21,68,5,51,4,145,144,23,90,77,91,207,205,187,83,201,18,181,91,182,180,90,181,16,85,17,205,206,36,176,148,140,165,92,39,245,193,244,27,159,28,30,247,161,174,236,196,103,54,104,55,193,8,111,117,31,221,189,55,240,98,99,142,126,100,219,166,218,112,155,26,198,209,131,169,135,150,114,47,217,224,223,53,220,45,134,32,211,140,109,67,108,146,43,91,231,230,120,113,226,247,105,63,52,241,238,242,124,46,156,95,78,96,70,46,63,116,143,227,116,123,111,1,44,19,3,236,51,207,216,205,26,154,22,165,39,167,199,200,208,101,36,100,43,57,202,242,20,99,56,28,157,124,35,113,29,160,27,211,204,210,124,113,46,106,43,204,96,62,77,227,137,116,73,41,72,36,203,142,235,64,240,48,49,64,42,41,74,214,212,207,183,42,184,210,169,211,140,170,176,104,105,69,193,122,168,50,123,187,89,96,90,66,65,107,179,89,180,119,101,120,68,63,104,234,93,227,16,15,85,209,129,49,15,14,86,107,55,9,120,100,121,153,145,22,178,88,179,197,6,196,89,88,96,135,138,136,138,215,172,218,115,219,41,42,81,5,195,51,57,43,61,208,171,199,41,81,38,224,53,225,24,144,110,105,52,66,118,229,117,227,34,234,66,107,69,10,109,151,219,48,235,183,62,191,142,129,126,116,111,143,7,163,246,118,117,50,223,222,52,94,19,141,222,221,65,196,3,197,45,220,44,156,70,139,188,122,245,139,71,162,145,153,159,149,170,150,122,188,196,206,216,92,163,144,161,164,2,167,242,141,241,0,164,37,11,72,12,144,145,160,12,38,13,70,63,71,31,226,111,157,158,154,36,101,205,203,206,165,126,209,217,98,165,97,237,220,218,237,239,241,210,214,169,140,171,32,241,125,237,179,86,178,180,85,179,181,84,180,182,83,181,194,201,182,177,137,132,184,76,183,185,61,184,186,57,185,216,212,186,192,214,187,139,34,156,218,79,237,147,123,177,45,44,4,208,201,32,98,64,129,192,213,138,235,59,219,141,242,97,97,2,141,240,75,235,229,24,228,31,25,226,230,23,229,231,22,230,232,26,231,233,112,232,244,189,243,189,221,190,222,28,221,223,27,222,224,29,223,225,30,224,113,247,225,99,60,240,213,147,215,60,20,166,192,187,213,243,112,244,244,233,245,245,128,188,188,114,174,134,131,220,174,217,236,236,198,134,215,177,58,156,143,124,25,110,7,31,228,25,264,356,368,0,11,267,451,452,349,267,302,269,350,357,277,350,452,357,299,333,297,396,175,377,381,384,382,280,347,330,269,303,270,151,9,337,344,278,360,424,418,431,270,304,409,272,310,407,322,270,410,449,450,347,432,422,434,18,313,17,291,306,375,259,387,260,424,335,418,434,364,416,391,423,327,301,251,298,275,281,4,254,373,253,375,307,321,280,425,411,200,421,18,335,321,406,321,320,405,314,315,17,423,426,266,396,377,369,270,322,269,413,417,464,385,386,258,248,456,419,298,284,333,168,417,8,448,346,261,417,413,285,326,327,328,277,355,329,309,392,438,381,382,256,279,429,360,365,364,379,355,277,437,282,443,283,281,275,363,395,431,369,299,297,337,335,273,321,348,450,349,359,446,467,283,293,282,250,458,462,300,276,383,292,308,325,283,276,293,264,372,447,346,352,340,354,274,19,363,456,281,426,436,425,380,381,252,267,269,393,421,200,428,371,266,329,432,287,422,290,250,328,385,258,384,446,265,342,386,387,257,422,424,430,445,342,276,422,273,424,306,292,307,352,366,345,268,271,302,358,423,371,327,294,460,331,279,294,303,271,304,436,432,427,304,272,408,395,394,431,378,395,400,296,334,299,6,351,168,376,352,411,307,325,320,285,295,336,320,319,404,329,330,349,334,293,333,366,323,447,316,15,315,331,358,279,317,14,316,8,285,9,277,329,350,253,374,252,319,318,403,351,6,419,324,318,325,397,367,365,288,435,397,278,344,439,310,272,311,248,195,281,375,273,291,175,396,199,312,311,268,276,283,445,390,373,339,295,282,296,448,449,346,356,264,454,337,336,299,337,338,151,294,278,455,308,292,415,429,358,355,265,340,372,388,390,466,352,346,280,295,442,282,354,19,370,285,441,295,195,248,197,457,440,274,301,300,368,417,351,465,251,301,389,385,380,386,394,395,379,399,412,419,410,436,322,387,373,388,326,2,393,354,370,461,393,164,267,268,302,12,386,374,387,312,268,13,298,293,301,265,446,340,380,385,381,280,330,425,322,426,391,420,429,437,393,391,326,344,440,438,458,459,461,364,434,394,428,396,262,274,354,457,317,316,402,316,315,403,315,314,404,314,313,405,313,421,406,323,366,361,292,306,407,306,291,408,291,287,409,287,432,410,427,434,411,372,264,383,459,309,457,366,352,401,1,274,4,418,421,262,331,294,358,435,433,367,392,289,439,328,462,326,94,2,370,289,305,455,339,254,448,359,255,446,254,253,449,253,252,450,252,256,451,256,341,452,414,413,463,286,441,414,286,258,441,258,257,442,257,259,443,259,260,444,260,467,445,309,459,250,305,289,290,305,290,460,401,376,435,309,250,392,376,411,433,453,341,464,357,453,465,343,357,412,437,343,399,344,360,440,420,437,456,360,420,363,361,401,288,265,372,353,390,339,249,339,448,255],SAMPLE_FACE:{keypoints:[{x:356.2804412841797,y:295.1960563659668,z:-23.786449432373047,name:"lips"},{x:354.8859405517578,y:264.69520568847656,z:-36.718435287475586},{x:355.2180862426758,y:275.3360366821289,z:-21.183712482452393},{x:347.349853515625,y:242.4400234222412,z:-25.093655586242676},{x:354.40135955810547,y:256.67933464050293,z:-38.23572635650635},{x:353.7689971923828,y:247.54886627197266,z:-34.5475435256958},{x:352.1288299560547,y:227.34312057495117,z:-13.095386028289795},{x:303.5013198852539,y:234.67002868652344,z:12.500141859054565,name:"rightEye"},{x:351.09378814697266,y:211.87547206878662,z:-6.413471698760986},{x:350.7115936279297,y:202.1251630783081,z:-6.413471698760986},{x:348.33667755126953,y:168.7741756439209,z:6.483500003814697,name:"faceOval"},{x:356.4806365966797,y:299.2995357513428,z:-23.144519329071045},{x:356.5511703491211,y:302.66146659851074,z:-21.020312309265137},{x:356.6239547729492,y:304.1536331176758,z:-18.137459754943848,name:"lips"},{x:356.5807342529297,y:305.1840591430664,z:-18.767719268798828,name:"lips"},{x:356.8241500854492,y:308.25711250305176,z:-20.16829490661621},{x:357.113037109375,y:312.26277351379395,z:-22.10575819015503},{x:357.34962463378906,y:317.1123218536377,z:-21.837315559387207,name:"lips"},{x:357.6658630371094,y:325.51036834716797,z:-16.27002477645874},{x:355.0201416015625,y:269.36279296875,z:-33.73054027557373},{x:348.5237503051758,y:270.33411026000977,z:-24.93025302886963},{x:279.97331619262695,y:213.24176788330078,z:47.759642601013184,name:"faceOval"},{x:322.66529083251953,y:238.5027265548706,z:5.535193085670471},{x:316.0983657836914,y:239.94489669799805,z:5.777376294136047},{x:309.9431610107422,y:240.24518966674805,z:7.510589361190796},{x:301.31994247436523,y:237.86138534545898,z:13.118728399276733},{x:328.14266204833984,y:235.80496788024902,z:6.646900177001953},{x:313.7326431274414,y:222.11161136627197,z:3.9887237548828125},{x:320.45196533203125,y:221.87729358673096,z:4.601476192474365},{x:307.35679626464844,y:223.63793849945068,z:5.932023525238037},{x:303.0031204223633,y:226.3743782043457,z:8.479321002960205},{x:296.80023193359375,y:242.94299125671387,z:15.931552648544312},{x:332.2352981567383,y:340.77341079711914,z:-10.165848731994629},{x:301.38587951660156,y:233.46447944641113,z:14.764405488967896,name:"rightEye"},{x:279.0147018432617,y:244.37155723571777,z:45.77549457550049},{x:289.60548400878906,y:239.1807460784912,z:23.191204071044922},{x:320.32257080078125,y:267.1292781829834,z:-4.954537749290466},{x:347.64583587646484,y:294.4955062866211,z:-23.062820434570312,name:"lips"},{x:349.28138732910156,y:303.1095886230469,z:-20.238323211669922},{x:338.9453125,y:298.19186210632324,z:-19.456336498260498,name:"lips"},{x:333.36788177490234,y:302.6706790924072,z:-14.776077270507812,name:"lips"},{x:342.89188385009766,y:304.3561363220215,z:-17.752301692962646},{x:337.7375030517578,y:306.0098361968994,z:-13.410515785217285},{x:325.6159210205078,y:316.22995376586914,z:-6.681914925575256},{x:349.0104675292969,y:264.9818515777588,z:-36.274919509887695},{x:347.7138900756836,y:257.5664806365967,z:-37.67549514770508},{x:291.79357528686523,y:218.88171672821045,z:11.578094959259033,name:"rightEyebrow"},{x:332.2689437866211,y:247.56946563720703,z:-3.3730539679527283},{x:332.0074462890625,y:267.1201229095459,z:-19.969879388809204},{x:331.27952575683594,y:263.6967658996582,z:-17.47218608856201},{x:301.04373931884766,y:269.56552505493164,z:3.61815482378006},{x:347.4863815307617,y:249.0706443786621,z:-32.633421421051025},{x:307.26118087768555,y:208.2646894454956,z:1.1591226607561111,name:"rightEyebrow"},{x:297.91919708251953,y:212.22604751586914,z:5.914516448974609,name:"rightEyebrow"},{x:285.1651382446289,y:197.98450469970703,z:36.391637325286865,name:"faceOval"},{x:337.04097747802734,y:211.25229835510254,z:-4.548954665660858},{x:326.5912628173828,y:223.16698551177979,z:6.670243740081787},{x:320.05664825439453,y:309.5834255218506,z:-4.055835008621216},{x:289.6866226196289,y:314.617395401001,z:53.875489234924316,name:"faceOval"},{x:337.4256896972656,y:270.8755302429199,z:-17.67060160636902},{x:343.69922637939453,y:273.0000400543213,z:-18.756048679351807},{x:327.4242401123047,y:309.22399520874023,z:-4.703601002693176,name:"lips"},{x:330.37220001220703,y:308.3323001861572,z:-6.442649960517883},{x:293.87027740478516,y:207.7961826324463,z:9.821539521217346,name:"rightEyebrow"},{x:332.11437225341797,y:271.22812271118164,z:-16.64351224899292},{x:320.1197814941406,y:207.40366458892822,z:-2.48164564371109,name:"rightEyebrow"},{x:318.59575271606445,y:201.07443809509277,z:-3.110446035861969,name:"rightEyebrow"},{x:310.72303771972656,y:175.75075149536133,z:13.328815698623657,name:"faceOval"},{x:289.67578887939453,y:202.29835510253906,z:21.370456218719482},{x:315.30879974365234,y:187.35260009765625,z:5.0304025411605835},{x:287.8936767578125,y:216.54793739318848,z:17.81065821647644,name:"rightEyebrow"},{x:283.9391899108887,y:215.01142501831055,z:32.04984903335571},{x:348.35330963134766,y:299.4155788421631,z:-22.47924566268921},{x:341.1790466308594,y:301.8221855163574,z:-18.977805376052856},{x:335.69713592529297,y:304.4266891479492,z:-14.682706594467163},{x:339.4615173339844,y:272.3654365539551,z:-16.38674020767212},{x:328.99600982666016,y:308.86685371398926,z:-5.616893768310547},{x:332.00313568115234,y:309.1875743865967,z:-10.335084199905396},{x:331.0068130493164,y:307.9274368286133,z:-6.681914925575256,name:"lips"},{x:341.13792419433594,y:266.4876937866211,z:-26.56425952911377},{x:339.02950286865234,y:305.6663703918457,z:-12.33674168586731,name:"lips"},{x:344.22935485839844,y:304.9452781677246,z:-15.161235332489014,name:"lips"},{x:350.1844024658203,y:304.374303817749,z:-17.5305438041687,name:"lips"},{x:348.52630615234375,y:325.9562301635742,z:-16.164982318878174},{x:348.6581802368164,y:317.1624183654785,z:-21.510512828826904,name:"lips"},{x:348.9766311645508,y:312.1923065185547,z:-21.708929538726807},{x:349.2427444458008,y:308.0660820007324,z:-19.643079042434692},{x:349.67491149902344,y:305.42747497558594,z:-18.16080331802368,name:"lips"},{x:337.95589447021484,y:306.6535949707031,z:-12.803598642349243,name:"lips"},{x:337.06878662109375,y:307.63169288635254,z:-14.274203777313232},{x:335.77449798583984,y:309.8449516296387,z:-15.698124170303345},{x:334.6099090576172,y:312.7997016906738,z:-14.764405488967896,name:"lips"},{x:327.2330856323242,y:293.80866050720215,z:-11.864047050476074},{x:280.97679138183594,y:279.79928970336914,z:68.90834331512451,name:"faceOval"},{x:355.13843536376953,y:271.7875671386719,z:-25.350427627563477},{x:334.7235870361328,y:307.4656391143799,z:-9.302158951759338,name:"lips"},{x:333.5293960571289,y:307.89782524108887,z:-10.200862884521484},{x:346.29688262939453,y:276.4256286621094,z:-19.748122692108154},{x:335.16246795654297,y:276.22097969055176,z:-12.313398122787476},{x:345.09132385253906,y:274.7082996368408,z:-19.304605722427368},{x:325.4267883300781,y:252.95130729675293,z:-1.6661019623279572},{x:315.347843170166,y:259.05200958251953,z:-.25604281574487686},{x:330.44933319091797,y:267.7570152282715,z:-14.017432928085327},{x:294.96768951416016,y:185.26001930236816,z:23.903164863586426,name:"faceOval"},{x:299.63531494140625,y:192.7913761138916,z:12.640198469161987},{x:304.5452117919922,y:202.4142837524414,z:3.244667649269104,name:"rightEyebrow"},{x:331.6915512084961,y:320.0467872619629,z:-10.632705688476562},{x:334.5911407470703,y:201.27566814422607,z:-6.133356094360352,name:"rightEyebrow"},{x:331.4815902709961,y:185.44180870056152,z:.6627205014228821},{x:328.05816650390625,y:170.8385467529297,z:7.358860373497009,name:"faceOval"},{x:304.49764251708984,y:239.76297855377197,z:10.387605428695679},{x:290.6382179260254,y:248.85257720947266,z:19.03616428375244},{x:331.5682601928711,y:233.20727348327637,z:7.837390303611755},{x:295.5115509033203,y:228.9834451675415,z:14.41426157951355},{x:336.94332122802734,y:241.8259334564209,z:-5.27842104434967},{x:336.2792205810547,y:262.7049922943115,z:-26.12074375152588},{x:284.4102478027344,y:255.3262710571289,z:25.467140674591064},{x:295.1420593261719,y:253.02655220031738,z:12.430112361907959},{x:303.5196113586426,y:254.20703887939453,z:6.139191389083862},{x:315.73450088500977,y:251.64799690246582,z:3.3788898587226868},{x:324.69661712646484,y:247.56494522094727,z:2.3328344523906708},{x:331.57970428466797,y:243.02241325378418,z:1.1423448473215103},{x:345.6210708618164,y:229.9976634979248,z:-10.825285911560059},{x:286.26644134521484,y:270.37991523742676,z:21.708929538726807},{x:290.2525520324707,y:228.4921360015869,z:17.71728754043579},{x:351.65367126464844,y:269.3400764465332,z:-33.450424671173096},{x:333.1378936767578,y:253.88388633728027,z:-7.230473756790161},{x:277.8318977355957,y:246.95331573486328,z:68.20805549621582,name:"faceOval"},{x:336.6680908203125,y:238.10003757476807,z:.7688578963279724},{x:329.95800018310547,y:269.18323516845703,z:-7.207130789756775},{x:299.17491912841797,y:234.13324356079102,z:15.95489501953125},{x:335.61729431152344,y:258.71752738952637,z:-23.016133308410645},{x:284.1079330444336,y:297.0343494415283,z:63.25934886932373,name:"faceOval"},{x:331.44542694091797,y:230.6892442703247,z:9.92658257484436,name:"rightEye"},{x:341.41536712646484,y:253.01264762878418,z:-29.038610458374023},{x:303.5472869873047,y:327.5896739959717,z:16.725212335586548},{x:304.7756576538086,y:337.4389457702637,z:27.38126277923584,name:"faceOval"},{x:280.80501556396484,y:275.32050132751465,z:45.0752067565918},{x:295.43582916259766,y:318.4501647949219,z:26.2608003616333},{x:281.4303207397461,y:228.7355661392212,z:40.94350814819336},{x:331.2549591064453,y:349.4216537475586,z:-7.376367449760437},{x:352.4247741699219,y:271.7330074310303,z:-24.953596591949463},{x:327.5672912597656,y:260.41900634765625,z:-5.456410646438599},{x:284.5432472229004,y:241.7647933959961,z:29.668869972229004},{x:310,y:235.66174507141113,z:8.502663969993591,name:"rightEye"},{x:315.7071113586426,y:235.7572603225708,z:6.938687562942505,name:"rightEye"},{x:330.41088104248047,y:311.04143142700195,z:-9.325502514839172,name:"lips"},{x:288.5377502441406,y:285.31983375549316,z:21.837315559387207},{x:344.55039978027344,y:359.4300842285156,z:-6.705257892608643,name:"faceOval"},{x:323.41880798339844,y:351.67362213134766,z:7.802375555038452,name:"faceOval"},{x:314.64088439941406,y:346.11894607543945,z:16.36339783668518,name:"faceOval"},{x:349.4945526123047,y:184.8434829711914,z:-.21847527474164963},{x:359.24694061279297,y:359.8348903656006,z:-8.403456211090088,name:"faceOval"},{x:321.26182556152344,y:234.64492321014404,z:6.90950870513916,name:"rightEye"},{x:326.318359375,y:232.90250301361084,z:8.029969334602356,name:"rightEye"},{x:329.6211624145508,y:231.6195774078369,z:9.722331762313843,name:"rightEye"},{x:285.9398078918457,y:228.2351303100586,z:24.650139808654785},{x:325.79288482666016,y:227.88007736206055,z:7.469738721847534,name:"rightEye"},{x:320.1699447631836,y:227.5934886932373,z:6.168370842933655,name:"rightEye"},{x:314.85408782958984,y:227.85282611846924,z:6.2675780057907104,name:"rightEye"},{x:309.3084907531738,y:229.1516876220703,z:7.7031683921813965,name:"rightEye"},{x:305.5621337890625,y:230.92366218566895,z:9.722331762313843,name:"rightEye"},{x:277.8681945800781,y:228.5354232788086,z:59.71122741699219,name:"faceOval"},{x:306.1444664001465,y:235.1954698562622,z:10.603528022766113,name:"rightEye"},{x:355.4478454589844,y:281.96210861206055,z:-20.565123558044434},{x:333.02661895751953,y:288.0105400085449,z:-14.72939133644104},{x:337.15728759765625,y:269.2059516906738,z:-19.8414945602417},{x:345.9898376464844,y:283.5453128814697,z:-20.4834246635437},{x:351.48963928222656,y:219.98916149139404,z:-7.0378947257995605},{x:312.39574432373047,y:336.50628089904785,z:8.671900033950806},{x:321.32152557373047,y:343.1755256652832,z:.9067271649837494},{x:343.78379821777344,y:353.2975959777832,z:-14.355905055999756},{x:296.8791389465332,y:327.91497230529785,z:41.01353645324707,name:"faceOval"},{x:329.6939468383789,y:229.27897453308105,z:8.934508562088013,name:"rightEye"},{x:341.6905212402344,y:241.4073657989502,z:-14.589333534240723},{x:359.03079986572266,y:353.48859786987305,z:-15.803166627883911},{x:333.1861877441406,y:356.43213272094727,z:-1.0234417766332626,name:"faceOval"},{x:283.97483825683594,y:291.4318656921387,z:41.94725513458252},{x:343.33770751953125,y:305.830135345459,z:-15.756480693817139,name:"lips"},{x:342.40283966064453,y:307.7453899383545,z:-17.4021577835083},{x:341.53621673583984,y:311.0595703125,z:-19.047834873199463},{x:340.9107208251953,y:315.4837703704834,z:-18.5576331615448,name:"lips"},{x:339.1478729248047,y:323.42233657836914,z:-14.367576837539673},{x:333.3201599121094,y:307.4406337738037,z:-9.617288708686829},{x:331.2411117553711,y:306.9811820983887,z:-9.669809937477112},{x:329.23255920410156,y:306.0508346557617,z:-9.582273960113525,name:"lips"},{x:322.4586486816406,y:301.33323669433594,z:-7.720675468444824},{x:297.1712112426758,y:286.9552803039551,z:8.240055441856384},{x:341.3060760498047,y:235.4432201385498,z:-7.504753470420837},{x:336.9318389892578,y:224.3451976776123,z:5.829898118972778},{x:332.65323638916016,y:226.70403957366943,z:8.105834126472473},{x:334.67357635498047,y:306.4397621154785,z:-8.981193900108337,name:"lips"},{x:297.4601936340332,y:306.29210472106934,z:15.476365089416504},{x:342.9119110107422,y:222.37077713012695,z:-2.754466235637665},{x:335.4629898071289,y:332.20250129699707,z:-11.823196411132812},{x:353.2412338256836,y:240.56339263916016,z:-27.147831916809082},{x:346.3080596923828,y:236.41446590423584,z:-18.452589511871338},{x:352.6475143432617,y:234.1420555114746,z:-19.748122692108154},{x:337.3209762573242,y:253.39937210083008,z:-16.024924516677856},{x:358.6122131347656,y:344.90861892700195,z:-18.592647314071655},{x:358.1117248535156,y:334.64990615844727,z:-17.49552845954895},{x:346.4450454711914,y:335.0321102142334,z:-16.32838249206543},{x:319.17640686035156,y:320.2833938598633,z:-3.276764452457428},{x:325.2540588378906,y:276.2369728088379,z:-6.460157036781311},{x:326.7214584350586,y:327.3939514160156,z:-7.417217493057251},{x:310.7190132141113,y:277.2265148162842,z:-3.5452082753181458},{x:319.78355407714844,y:284.8238182067871,z:-6.4543211460113525},{x:305.773983001709,y:290.83580017089844,z:.06907138042151928},{x:344.4001770019531,y:344.85408782958984,z:-16.946970224380493},{x:333.1879425048828,y:258.74256134033203,z:-11.90489649772644},{x:313.80598068237305,y:327.08919525146484,z:2.2277912497520447},{x:322.9637908935547,y:334.6819496154785,z:-3.3643004298210144},{x:313.4055519104004,y:311.2166690826416,z:-1.1175429821014404},{x:291.0865783691406,y:298.2831001281738,z:22.467575073242188},{x:305.6580924987793,y:313.3707904815674,z:5.561453700065613},{x:288.23760986328125,y:305.9941864013672,z:36.765122413635254},{x:315.10692596435547,y:296.26991271972656,z:-4.604393839836121},{x:337.50518798828125,y:247.5944423675537,z:-10.597691535949707},{x:338.8450622558594,y:265.47778129577637,z:-27.778091430664062},{x:334.25254821777344,y:269.0671920776367,z:-20.938611030578613},{x:341.64512634277344,y:259.6387195587158,z:-32.189905643463135},{x:331.44081115722656,y:219.0976095199585,z:4.207563698291779},{x:320.56339263916016,y:216.49658203125,z:2.930997312068939},{x:311.21912002563477,y:216.57853603363037,z:2.9674705862998962},{x:303.46256256103516,y:218.54614734649658,z:5.357203483581543},{x:297.99999237060547,y:222.505202293396,z:9.325502514839172},{x:294.93839263916016,y:236.39654159545898,z:18.534289598464966},{x:278.87489318847656,y:259.7095584869385,z:45.68212032318115},{x:300.3782653808594,y:245.38593292236328,z:12.278382778167725},{x:307.06348419189453,y:246.36857986450195,z:8.164191246032715},{x:315.5229187011719,y:245.3949737548828,z:5.503097176551819},{x:323.71395111083984,y:242.75178909301758,z:4.6335723996162415},{x:330.2785873413086,y:239.34658527374268,z:4.937030673027039},{x:334.6982192993164,y:236.0460376739502,z:4.823233783245087},{x:279.3412208557129,y:263.5196113586426,z:70.91583728790283,name:"faceOval"},{x:334.65972900390625,y:271.6648578643799,z:-17.775644063949585},{x:342.05677032470703,y:246.99846267700195,z:-20.84523916244507},{x:344.0357971191406,y:264.5701503753662,z:-32.936880588531494},{x:348.25531005859375,y:268.6645030975342,z:-30.695960521697998},{x:344.12227630615234,y:266.34212493896484,z:-29.808926582336426},{x:337.12318420410156,y:274.2556858062744,z:-15.768152475357056},{x:349.49047088623047,y:269.071683883667,z:-32.51670837402344},{x:350.1683044433594,y:271.4691352844238,z:-24.93025302886963},{x:333.9634704589844,y:230.56639194488525,z:8.89949381351471},{x:338.2147979736328,y:231.4807891845703,z:4.6715047955513},{x:340.4712677001953,y:231.74463272094727,z:-.34996166825294495},{x:303.28975677490234,y:232.24980354309082,z:11.916568279266357,name:"rightEye"},{x:299.4649124145508,y:229.53842639923096,z:12.325069904327393},{x:359.09618377685547,y:241.77349090576172,z:-24.650139808654785},{x:399.46216583251953,y:229.89503860473633,z:15.919880867004395,name:"leftEye"},{x:361.38919830322266,y:269.6129894256592,z:-24.510080814361572},{x:416.9973373413086,y:206.0895538330078,z:53.26857566833496,name:"faceOval"},{x:381.32179260253906,y:235.5476474761963,z:7.6214683055877686},{x:387.8068542480469,y:236.25958442687988,z:8.345099091529846},{x:393.95751953125,y:235.8660364151001,z:10.475142002105713},{x:401.84600830078125,y:232.77019500732422,z:16.760226488113403},{x:375.70568084716797,y:233.48456382751465,z:8.234220147132874},{x:388.17752838134766,y:218.94717693328857,z:6.810300946235657},{x:381.64928436279297,y:219.2656660079956,z:6.711093783378601},{x:394.4760513305664,y:219.66821193695068,z:9.173773527145386},{x:398.8843536376953,y:221.8837022781372,z:12.03328251838684},{x:406.5454864501953,y:237.12156772613525,z:19.7131085395813},{x:383.87447357177734,y:337.6932907104492,z:-8.631049990653992},{x:401.2682342529297,y:228.5916566848755,z:18.359217643737793,name:"leftEye"},{x:422.0449447631836,y:236.73934936523438,z:51.16771221160889},{x:412.69153594970703,y:232.80198097229004,z:27.52131938934326},{x:387.3497772216797,y:263.298397064209,z:-2.8609684109687805},{x:364.5124053955078,y:293.39221000671387,z:-22.397546768188477,name:"lips"},{x:363.62987518310547,y:302.1291446685791,z:-19.643079042434692},{x:373.2334518432617,y:295.8647060394287,z:-18.125789165496826,name:"lips"},{x:378.83365631103516,y:299.5177745819092,z:-13.153743743896484,name:"lips"},{x:369.91477966308594,y:302.5704002380371,z:-16.65518283843994},{x:374.9167251586914,y:303.5416603088379,z:-11.963253021240234},{x:387.58888244628906,y:312.2716999053955,z:-4.680258631706238},{x:360.6635284423828,y:264.31986808776855,z:-35.94811677932739},{x:361.04564666748047,y:256.8225860595703,z:-37.278664112091064},{x:408.3855438232422,y:213.52088928222656,z:15.756480693817139,name:"leftEyebrow"},{x:373.2946014404297,y:245.38101196289062,z:-1.9316278398036957},{x:376.83860778808594,y:264.3721103668213,z:-18.510947227478027},{x:376.9546127319336,y:261.0010528564453,z:-15.989909172058105},{x:406.1498260498047,y:263.5030174255371,z:7.072908878326416},{x:360.07205963134766,y:248.3631706237793,z:-32.16656446456909},{x:393.11119079589844,y:205.10473251342773,z:3.7786373496055603,name:"leftEyebrow"},{x:402.12791442871094,y:207.89000988006592,z:9.383859634399414,name:"leftEyebrow"},{x:410.8693313598633,y:191.6182279586792,z:41.27030849456787,name:"faceOval"},{x:364.9509811401367,y:210.40483474731445,z:-3.758212625980377},{x:375.94444274902344,y:221.1331844329834,z:8.368442058563232},{x:392.1904754638672,y:305.0360298156738,z:-1.752179116010666},{x:419.50225830078125,y:307.25592613220215,z:58.96425247192383,name:"faceOval"},{x:372.0027160644531,y:268.7212657928467,z:-16.631840467453003},{x:366.1614227294922,y:271.6237449645996,z:-18.219159841537476},{x:385.00938415527344,y:305.3863334655762,z:-2.567722797393799},{x:381.99771881103516,y:304.9723720550537,z:-4.575215280056},{x:405.078125,y:203.21216583251953,z:13.713973760604858,name:"leftEyebrow"},{x:377.13207244873047,y:268.4710121154785,z:-15.266278982162476},{x:380.9713363647461,y:205.36980628967285,z:-.7250899076461792,name:"leftEyebrow"},{x:381.7788314819336,y:198.9268398284912,z:-1.184653863310814,name:"leftEyebrow"},{x:385.5204772949219,y:172.1484375,z:16.04826807975769,name:"faceOval"},{x:407.94189453125,y:196.76236152648926,z:25.723915100097656},{x:383.03890228271484,y:184.5157527923584,z:7.393874526023865},{x:411.61781311035156,y:210.79241752624512,z:22.315845489501953,name:"leftEyebrow"},{x:414.30870056152344,y:208.4643030166626,z:37.021894454956055},{x:364.28722381591797,y:298.35777282714844,z:-21.86065673828125},{x:371.3682556152344,y:299.78848457336426,z:-17.834001779556274},{x:376.88201904296875,y:301.6696071624756,z:-13.153743743896484},{x:370.2193832397461,y:270.49095153808594,z:-15.569736957550049},{x:383.5081100463867,y:305.2726364135742,z:-3.673594295978546},{x:380.73760986328125,y:305.96869468688965,z:-8.660228252410889},{x:381.2334442138672,y:304.63574409484863,z:-4.820316135883331,name:"lips"},{x:368.1698989868164,y:264.8884963989258,z:-25.653886795043945},{x:373.5087203979492,y:303.4233856201172,z:-10.95950722694397,name:"lips"},{x:368.4544372558594,y:303.29601287841797,z:-14.169161319732666,name:"lips"},{x:362.76554107666016,y:303.5735607147217,z:-16.911956071853638,name:"lips"},{x:366.60980224609375,y:324.8870658874512,z:-15.616422891616821},{x:365.7067108154297,y:315.95678329467773,z:-20.903596878051758,name:"lips"},{x:365.0083923339844,y:311.2232208251953,z:-21.066999435424805},{x:364.1508102416992,y:307.0583438873291,z:-18.907777070999146},{x:363.37512969970703,y:304.5721435546875,z:-17.42550015449524,name:"lips"},{x:374.580078125,y:304.3059539794922,z:-11.40302300453186,name:"lips"},{x:375.55362701416016,y:305.0998020172119,z:-12.861957550048828},{x:377.2437286376953,y:307.1674346923828,z:-14.215847253799438},{x:378.68587493896484,y:309.9015712738037,z:-13.223772048950195,name:"lips"},{x:383.8992691040039,y:290.29629707336426,z:-9.97326910495758},{x:423.3871841430664,y:271.91688537597656,z:74.37058925628662,name:"faceOval"},{x:377.68043518066406,y:304.62209701538086,z:-7.603961229324341,name:"lips"},{x:379.00428771972656,y:304.9314594268799,z:-8.57852816581726},{x:364.00279998779297,y:275.2813911437988,z:-19.25792098045349},{x:374.68231201171875,y:273.82555961608887,z:-11.28047227859497},{x:365.0354766845703,y:273.4548568725586,z:-18.791062831878662},{x:380.61901092529297,y:249.8848056793213,z:.15501167625188828},{x:391.14158630371094,y:254.7934627532959,z:2.0906515419483185},{x:378.1761169433594,y:264.9612236022949,z:-12.605184316635132},{x:400.9540557861328,y:179.99592304229736,z:27.82477855682373,name:"faceOval"},{x:398.0038833618164,y:188.50656509399414,z:16.094952821731567},{x:394.8717498779297,y:199.0359592437744,z:6.226727366447449,name:"leftEyebrow"},{x:382.10926055908203,y:316.83926582336426,z:-8.946179747581482},{x:366.51588439941406,y:200.32583713531494,z:-5.24632453918457,name:"leftEyebrow"},{x:367.4893569946289,y:183.87210845947266,z:1.9039081037044525},{x:368.6243438720703,y:168.8127565383911,z:8.736093044281006,name:"faceOval"},{x:398.96175384521484,y:234.9675178527832,z:13.713973760604858},{x:412.9645538330078,y:242.23042488098145,z:23.272905349731445},{x:372.05257415771484,y:231.41919136047363,z:9.226294755935669},{x:406.0722351074219,y:223.58965873718262,z:18.370890617370605},{x:368.27442169189453,y:240.2039337158203,z:-4.166713654994965},{x:372.3575210571289,y:260.66442489624023,z:-24.976940155029297},{x:419.2244338989258,y:247.9079246520996,z:30.299127101898193},{x:409.43885803222656,y:246.60913467407227,z:16.398411989212036},{x:401.69139862060547,y:248.76328468322754,z:9.395531415939331},{x:389.7608184814453,y:247.56915092468262,z:5.841569304466248},{x:380.5461883544922,y:244.55984115600586,z:4.263003468513489},{x:373.25817108154297,y:240.80214500427246,z:2.5356262922286987},{x:358.77086639404297,y:229.35615062713623,z:-10.387605428695679},{x:419.5793914794922,y:262.8478717803955,z:26.5175724029541},{x:410.8808898925781,y:222.51372814178467,z:22.199130058288574},{x:358.45714569091797,y:268.91467094421387,z:-33.17030906677246},{x:373.4129333496094,y:251.6385841369629,z:-5.771540403366089},{x:422.5408172607422,y:239.23919677734375,z:74.04378890991211,name:"faceOval"},{x:367.8171920776367,y:236.58040523529053,z:1.820748895406723},{x:378.51959228515625,y:266.2532329559326,z:-5.74819803237915},{x:403.3472442626953,y:229.05112266540527,z:19.689764976501465},{x:372.34840393066406,y:256.6451168060303,z:-21.872329711914062},{x:422.54566192626953,y:289.1587829589844,z:68.67491245269775,name:"faceOval"},{x:371.9297409057617,y:228.90116214752197,z:11.432201862335205,name:"leftEye"},{x:366.21360778808594,y:251.6158962249756,z:-28.19826364517212},{x:409.1571807861328,y:321.3156223297119,z:20.2266526222229},{x:408.52943420410156,y:331.44238471984863,z:31.09278917312622,name:"faceOval"},{x:424.2788314819336,y:267.1992301940918,z:50.467424392700195},{x:415.60352325439453,y:311.6528606414795,z:30.579242706298828},{x:418.12793731689453,y:221.59927368164062,z:46.26569747924805},{x:385.68286895751953,y:346.0184955596924,z:-5.70151150226593},{x:357.82936096191406,y:271.3758373260498,z:-24.836881160736084},{x:379.588623046875,y:257.5071716308594,z:-3.755294680595398},{x:417.4592590332031,y:234.71948146820068,z:34.5475435256958},{x:393.4684371948242,y:231.58967971801758,z:11.408859491348267,name:"leftEye"},{x:387.8864288330078,y:232.14245796203613,z:9.51808214187622,name:"leftEye"},{x:382.4981689453125,y:307.5654888153076,z:-7.522260546684265,name:"lips"},{x:419.00169372558594,y:277.8332805633545,z:26.424202919006348},{x:373.62953186035156,y:357.6375102996826,z:-5.75986921787262,name:"faceOval"},{x:392.8708267211914,y:347.72446632385254,z:10.154176950454712,name:"faceOval"},{x:400.3953552246094,y:341.0005187988281,z:19.39797878265381,name:"faceOval"},{x:382.25440979003906,y:231.66935920715332,z:8.998700976371765,name:"leftEye"},{x:377.14550018310547,y:230.4228687286377,z:9.804032444953918,name:"leftEye"},{x:373.8358688354492,y:229.64950561523438,z:11.292144060134888,name:"leftEye"},{x:414.5794677734375,y:221.67891025543213,z:29.412097930908203},{x:377.00672149658203,y:225.66201210021973,z:9.360517263412476,name:"leftEye"},{x:382.29530334472656,y:224.8431158065796,z:8.32175612449646,name:"leftEye"},{x:387.5133514404297,y:224.49507236480713,z:8.917000889778137,name:"leftEye"},{x:393.15906524658203,y:225.24795055389404,z:10.737749338150024,name:"leftEye"},{x:397.05554962158203,y:226.55359268188477,z:13.002015352249146,name:"leftEye"},{x:420.5299377441406,y:221.014666557312,z:65.40690422058105,name:"faceOval"},{x:397.06920623779297,y:230.6661558151245,z:13.807345628738403,name:"leftEye"},{x:377.94647216796875,y:285.1647090911865,z:-13.305472135543823},{x:372.1118927001953,y:267.1267318725586,z:-18.83774757385254},{x:364.9968719482422,y:282.24411964416504,z:-19.818150997161865},{x:401.973876953125,y:331.20131492614746,z:11.566424369812012},{x:394.3083190917969,y:338.86693954467773,z:3.142542541027069},{x:373.9820861816406,y:351.4504623413086,z:-13.50388765335083},{x:414.3888854980469,y:321.24735832214355,z:45.51872253417969,name:"faceOval"},{x:373.44234466552734,y:227.33163356781006,z:10.626870393753052,name:"leftEye"},{x:364.0731430053711,y:240.31539916992188,z:-13.807345628738403},{x:384.2658233642578,y:353.3793067932129,z:.7385850697755814,name:"faceOval"},{x:423.20526123046875,y:283.5176181793213,z:47.152724266052246},{x:369.42798614501953,y:304.0898895263672,z:-14.647691249847412,name:"lips"},{x:370.63812255859375,y:305.90051651000977,z:-16.211668252944946},{x:371.91192626953125,y:309.0167713165283,z:-17.84567356109619},{x:373.0583953857422,y:313.3545398712158,z:-17.378815412521362,name:"lips"},{x:375.39905548095703,y:321.09289169311523,z:-13.118728399276733},{x:379.2567825317383,y:304.3582534790039,z:-7.924926280975342},{x:381.18797302246094,y:303.7031364440918,z:-7.843226194381714},{x:383.0918502807617,y:302.4884605407715,z:-7.6506465673446655,name:"lips"},{x:389.09461975097656,y:297.1475315093994,z:-5.5497825145721436},{x:411.6408920288086,y:280.24898529052734,z:12.02161192893982},{x:363.3110809326172,y:234.27620887756348,z:-6.775286793708801},{x:366.0474395751953,y:223.29872131347656,z:6.827808618545532},{x:370.34427642822266,y:225.1457118988037,z:9.558931589126587},{x:377.5371551513672,y:303.60079765319824,z:-7.358860373497009,name:"lips"},{x:412.9557800292969,y:299.53579902648926,z:19.39797878265381},{x:360.0810241699219,y:221.72012329101562,z:-2.153385728597641},{x:379.82784271240234,y:329.47723388671875,z:-10.48097848892212},{x:359.08477783203125,y:235.7911491394043,z:-18.079102039337158},{x:369.6688461303711,y:251.5407943725586,z:-14.962821006774902},{x:369.5555114746094,y:333.5307312011719,z:-15.67478060722351},{x:394.0193176269531,y:315.6973171234131,z:-.9920747578144073},{x:383.78997802734375,y:272.7268695831299,z:-4.689012169837952},{x:387.67765045166016,y:323.6722755432129,z:-5.640236139297485},{x:397.8769302368164,y:272.1331214904785,z:-.9395531564950943},{x:389.87476348876953,y:280.5630111694336,z:-4.29218202829361},{x:403.83888244628906,y:285.1167869567871,z:3.0229100584983826},{x:372.5467300415039,y:343.1070327758789,z:-16.153310537338257},{x:374.1112518310547,y:256.3721466064453,z:-10.574349164962769},{x:399.73785400390625,y:321.77515983581543,z:4.849494695663452},{x:392.03365325927734,y:330.56447982788086,z:-1.3407598435878754},{x:398.59134674072266,y:305.93902587890625,z:1.517290621995926},{x:417.95997619628906,y:290.9716987609863,z:26.89105987548828},{x:406.04541778564453,y:307.35154151916504,z:8.666064143180847},{x:420.75328826904297,y:298.40752601623535,z:41.78385257720947},{x:395.4522705078125,y:291.4153575897217,z:-2.1752697229385376},{x:368.6452102661133,y:245.8882999420166,z:-9.453888535499573},{x:370.34900665283203,y:263.56690406799316,z:-26.75100326538086},{x:374.98477935791016,y:266.6126346588135,z:-19.77146625518799},{x:366.99840545654297,y:258.12140464782715,z:-31.372904777526855},{x:371.00616455078125,y:217.63479709625244,z:5.60522198677063},{x:381.30577087402344,y:214.14087295532227,z:4.983716309070587},{x:390.1496124267578,y:213.38221549987793,z:5.593550801277161},{x:397.7696990966797,y:214.3659782409668,z:8.57852816581726},{x:403.1652069091797,y:217.65509605407715,z:13.013685941696167},{x:407.3551940917969,y:230.72525024414062,z:22.444231510162354},{x:424.0876770019531,y:251.7839241027832,z:51.16771221160889},{x:403.50196838378906,y:239.88757610321045,z:15.803166627883911},{x:397.31719970703125,y:241.49806022644043,z:11.233787536621094},{x:388.99425506591797,y:241.4366912841797,z:7.948269248008728},{x:380.7804489135742,y:239.78078842163086,z:6.600214838981628},{x:374.01336669921875,y:237.11946487426758,z:6.349278092384338},{x:369.39125061035156,y:234.35351371765137,z:5.987462401390076},{x:422.9730987548828,y:255.76455116271973,z:76.61150932312012,name:"faceOval"},{x:374.73915100097656,y:269.24214363098145,z:-16.608498096466064},{x:364.61681365966797,y:245.71088790893555,z:-20.02823829650879},{x:365.3834533691406,y:263.34174156188965,z:-32.32996463775635},{x:361.58252716064453,y:267.8273677825928,z:-30.345816612243652},{x:365.37208557128906,y:265.0249671936035,z:-29.178667068481445},{x:372.72605895996094,y:272.05135345458984,z:-14.834434986114502},{x:360.48614501953125,y:268.34827423095703,z:-32.189905643463135},{x:359.9516296386719,y:270.8049201965332,z:-24.650139808654785},{x:369.5049285888672,y:229.01945114135742,z:10.107489824295044},{x:365.5447769165039,y:230.24096488952637,z:5.593550801277161},{x:363.50669860839844,y:230.6208372116089,z:.43622106313705444},{x:399.3529510498047,y:227.65677452087402,z:15.35965085029602,name:"leftEye"},{x:402.5693130493164,y:224.60190296173096,z:15.931552648544312}],box:{xMin:277.8318977355957,yMin:168.7741756439209,xMax:424.2788314819336,yMax:359.8348903656006,width:146.4469337463379,height:191.0607147216797}},SAMPLE_FACELANDMARKER_RESULT:{faceLandmarks:[[{x:.5760777592658997,y:.8639070391654968,z:-.030997956171631813},{x:.572094738483429,y:.7886289358139038,z:-.07189624011516571},{x:.5723551511764526,y:.8075382709503174,z:-.03578168898820877},{x:.5548420548439026,y:.7188365459442139,z:-.057787876576185226},{x:.5706077814102173,y:.7674974799156189,z:-.07740399986505508},{x:.5681378245353699,y:.7387768030166626,z:-.07356284558773041},{x:.5621535181999207,y:.6681165099143982,z:-.04189874976873398},{x:.46613582968711853,y:.6679812073707581,z:.011289681307971478},{x:.5579932928085327,y:.6174106597900391,z:-.03502821549773216},{x:.5563451647758484,y:.5905600190162659,z:-.03928658738732338},{x:.5487832427024841,y:.4900572597980499,z:-.029898937791585922},{x:.5765544176101685,y:.8692144751548767,z:-.02831427752971649},{x:.5771114230155945,y:.873644232749939,z:-.02345779910683632},{x:.5771905779838562,y:.877016007900238,z:-.016658689826726913},{x:.5778058767318726,y:.8770116567611694,z:-.014505492523312569},{x:.5783766508102417,y:.8835000991821289,z:-.015996402129530907},{x:.5792440176010132,y:.8913810849189758,z:-.01924579218029976},{x:.5796768069267273,y:.8996334671974182,z:-.018261712044477463},{x:.5817288160324097,y:.9255813956260681,z:-.007126849144697189},{x:.5726592540740967,y:.7992473244667053,z:-.0643521398305893},{x:.5579419136047363,y:.7996989488601685,z:-.04566684365272522},{x:.4216199815273285,y:.5958762764930725,z:.06776496022939682},{x:.5052269697189331,y:.6796539425849915,z:-.0010737782577052712},{x:.49243026971817017,y:.6838865876197815,z:-.0005227324436418712},{x:.4796970784664154,y:.6856290102005005,z:.002684245817363262},{x:.4618356227874756,y:.6764569878578186,z:.013439622707664967},{x:.5160380601882935,y:.6737282276153564,z:-17607348127057776e-21},{x:.48070961236953735,y:.6255870461463928,z:-.008339674212038517},{x:.49719780683517456,y:.6256808042526245,z:-.008027955889701843},{x:.46674346923828125,y:.6317623853683472,z:-.004460199736058712},{x:.4582492709159851,y:.641118049621582,z:.0011905613355338573},{x:.45408669114112854,y:.6911458969116211,z:.020514748990535736},{x:.535312294960022,y:.9619986414909363,z:.012499462813138962},{x:.4608460068702698,y:.6628725528717041,z:.01517564244568348},{x:.4206731915473938,y:.6828458309173584,z:.07848648726940155},{x:.4390624463558197,y:.6796106696128845,z:.03283142298460007},{x:.5029968619346619,y:.7701570391654968,z:-.009734481573104858},{x:.5595027208328247,y:.8607323169708252,z:-.030043255537748337},{x:.5621269941329956,y:.8738374710083008,z:-.021709579974412918},{x:.5451499819755554,y:.865527331829071,z:-.022014077752828598},{x:.5351184010505676,y:.8705098032951355,z:-.011602800339460373},{x:.5495014190673828,y:.8744956254959106,z:-.016490943729877472},{x:.5395170450210571,y:.8759440779685974,z:-.007333362940698862},{x:.5183624029159546,y:.8959754705429077,z:.010520773939788342},{x:.5604349374771118,y:.7895449995994568,z:-.07082037627696991},{x:.557381272315979,y:.7687489986419678,z:-.07590588927268982},{x:.4432901442050934,y:.6308897733688354,z:.0027153254486620426},{x:.5258325338363647,y:.7151225805282593,z:-.014676518738269806},{x:.5271827578544617,y:.7833116054534912,z:-.037643320858478546},{x:.5257382988929749,y:.7717816233634949,z:-.03401920944452286},{x:.46516409516334534,y:.7705106735229492,z:.0065747760236263275},{x:.5558893084526062,y:.7420997619628906,z:-.0694495290517807},{x:.4720408320426941,y:.6066038608551025,z:-.021204356104135513},{x:.45432573556900024,y:.6158540844917297,z:-.011054684408009052},{x:.4305151402950287,y:.5608053803443909,z:.0396830290555954},{x:.5310865640640259,y:.6157484650611877,z:-.03081176057457924},{x:.5114666223526001,y:.6329749226570129,z:-.00335998204536736},{x:.506435751914978,y:.8786543607711792,z:.012980876490473747},{x:.4480472207069397,y:.8640613555908203,z:.12569651007652283},{x:.5372058153152466,y:.7942581176757812,z:-.03168361634016037},{x:.5488379597663879,y:.8001630306243896,z:-.03280917927622795},{x:.5213388204574585,y:.8794381618499756,z:.011892606504261494},{x:.5242055654525757,y:.8789222240447998,z:.008370225317776203},{x:.4477175176143646,y:.6039950251579285,z:-.0050799972377717495},{x:.526964008808136,y:.7916748523712158,z:-.02968614175915718},{x:.4971255660057068,y:.6050706505775452,z:-.028175678104162216},{x:.4938119053840637,y:.5882453918457031,z:-.03210941329598427},{x:.4757143557071686,y:.5094879865646362,z:-.01300730835646391},{x:.43947282433509827,y:.5816648006439209,z:.01415177434682846},{x:.485664039850235,y:.5477864146232605,z:-.023685332387685776},{x:.43635931611061096,y:.6226438283920288,z:.013606148771941662},{x:.42910251021385193,y:.6102726459503174,z:.03926564007997513},{x:.5605402588844299,y:.8680099248886108,z:-.027318159118294716},{x:.5474816560745239,y:.8702861070632935,z:-.019686367362737656},{x:.5373021364212036,y:.8728838562965393,z:-.010484928265213966},{x:.540735125541687,y:.7979167103767395,z:-.029073253273963928},{x:.5228585004806519,y:.87913578748703,z:.009915109723806381},{x:.530497670173645,y:.8815253973007202,z:.0020524784922599792},{x:.5259912610054016,y:.8790552616119385,z:.007895970717072487},{x:.5433906316757202,y:.7882310748100281,z:-.05121905356645584},{x:.541388213634491,y:.8777219653129578,z:-.00466804439201951},{x:.5515822172164917,y:.8767023086547852,z:-.010475946590304375},{x:.5637003779411316,y:.877059817314148,z:-.015273625031113625},{x:.5640299320220947,y:.9263423085212708,z:-.00658724969252944},{x:.5642300248146057,y:.8993074893951416,z:-.017653480172157288},{x:.5637336373329163,y:.8910360932350159,z:-.01852807030081749},{x:.5637134313583374,y:.8837276697158813,z:-.01482592523097992},{x:.564205527305603,y:.8768964409828186,z:-.01331155002117157},{x:.5419867634773254,y:.8778373599052429,z:-.0037720394320786},{x:.5404468774795532,y:.880696177482605,z:-.005610354244709015},{x:.5392338633537292,y:.8845721483230591,z:-.007352025713771582},{x:.538469672203064,y:.8891173601150513,z:-.005154991988092661},{x:.5189250111579895,y:.8452741503715515,z:-.009755070321261883},{x:.4258975088596344,y:.7662280797958374,z:.1387351155281067},{x:.5725725293159485,y:.8041572570800781,z:-.04583907872438431},{x:.5342061519622803,y:.8785833120346069,z:.002659974154084921},{x:.5324031114578247,y:.8804071545600891,z:.0017832003068178892},{x:.5538818836212158,y:.8078407645225525,z:-.03254539892077446},{x:.5325431823730469,y:.8026832938194275,z:-.019140373915433884},{x:.5514076948165894,y:.8043903112411499,z:-.03313535451889038},{x:.5131856203079224,y:.7284771800041199,z:-.009399853646755219},{x:.49331504106521606,y:.7443980574607849,z:-.005225230939686298},{x:.5239617824554443,y:.7807451486587524,z:-.025881027802824974},{x:.4473606050014496,y:.5315827131271362,z:.011164786294102669},{x:.45718759298324585,y:.5604941248893738,z:-.005943301599472761},{x:.4670005738735199,y:.5909327268600464,z:-.019681761041283607},{x:.5311570167541504,y:.9076261520385742,z:.00389476353302598},{x:.5249923467636108,y:.5893563628196716,z:-.037981919944286346},{x:.5166932344436646,y:.5429551005363464,z:-.03319704160094261},{x:.5085030198097229,y:.49676206707954407,z:-.02691275253891945},{x:.4687720239162445,y:.6834565997123718,z:.008113506250083447},{x:.4426414966583252,y:.7069531679153442,z:.028577271848917007},{x:.5230373740196228,y:.6675713658332825,z:.001773772411979735},{x:.4481240212917328,y:.6527872085571289,z:.012414850294589996},{x:.5339856743812561,y:.7012367844581604,z:-.020220188423991203},{x:.5347223281860352,y:.7761190533638,z:-.05141595005989075},{x:.4315067231655121,y:.7211957573890686,z:.04381405934691429},{x:.45203351974487305,y:.7206180095672607,z:.017288070172071457},{x:.46892452239990234,y:.7265436053276062,z:.005602988880127668},{x:.49314674735069275,y:.7202282547950745,z:-.0006408205372281373},{x:.5104925632476807,y:.7091827392578125,z:-.00362918758764863},{x:.5232142210006714,y:.698553740978241,z:-.00787867046892643},{x:.5497883558273315,y:.6743605136871338,z:-.036349106580019},{x:.43658503890037537,y:.7627100348472595,z:.042555369436740875},{x:.4397648870944977,y:.6528646349906921,z:.017956094816327095},{x:.5653332471847534,y:.7992802858352661,z:-.06365057826042175},{x:.5285563468933105,y:.736810564994812,z:-.018836988136172295},{x:.4180678725242615,y:.6792560815811157,z:.12284679710865021},{x:.5328429937362671,y:.6865872144699097,z:-.010484723374247551},{x:.5230283141136169,y:.7809416055679321,z:-.011922398582100868},{x:.4551771283149719,y:.6650775074958801,z:.01774493046104908},{x:.5337203741073608,y:.7618928551673889,z:-.04697106033563614},{x:.43463975191116333,y:.8133478164672852,z:.1354849934577942},{x:.5225707292556763,y:.6605283617973328,z:.004980515688657761},{x:.5441933870315552,y:.7497199773788452,z:-.06091512367129326},{x:.4774007797241211,y:.9159183502197266,z:.059622734785079956},{x:.48068761825561523,y:.9364941716194153,z:.08404944837093353},{x:.4268292486667633,y:.7657528519630432,z:.09051097184419632},{x:.46051913499832153,y:.8880485892295837,z:.0738474428653717},{x:.4243420660495758,y:.6434382200241089,z:.06230505183339119},{x:.5342157483100891,y:.9835634231567383,z:.021662971004843712},{x:.5668109655380249,y:.8042187094688416,z:-.044937074184417725},{x:.5176341533660889,y:.7530587315559387,z:-.012967454269528389},{x:.430206298828125,y:.6835605502128601,z:.04612284153699875},{x:.4794231951236725,y:.6732114553451538,z:.003970044665038586},{x:.49073347449302673,y:.6722435355186462,z:.0008692514384165406},{x:.5294116139411926,y:.884677529335022,z:.004413890186697245},{x:.4430122375488281,y:.80235356092453,z:.04987282305955887},{x:.5603825449943542,y:1.0092442035675049,z:.026417359709739685},{x:.5186598300933838,y:.9828659892082214,z:.0513598807156086},{x:.5010536909103394,y:.9640932679176331,z:.06591596454381943},{x:.5524769425392151,y:.539441704750061,z:-.035816047340631485},{x:.5879997611045837,y:1.0091472864151,z:.02285068854689598},{x:.5016193985939026,y:.6684437990188599,z:.00028415941051207483},{x:.511952817440033,y:.6642197370529175,z:.0021144719794392586},{x:.5194343328475952,y:.6623469591140747,z:.004674181342124939},{x:.4321230351924896,y:.6496355533599854,z:.03124697133898735},{x:.508686363697052,y:.6479565501213074,z:-.00044765998609364033},{x:.4963986277580261,y:.6431032419204712,z:-.0032507688738405704},{x:.4845542013645172,y:.6430778503417969,z:-.002903624437749386},{x:.4733612537384033,y:.647506833076477,z:.00023347247042693198},{x:.4668654501438141,y:.653346598148346,z:.004762572236359119},{x:.41815051436424255,y:.633708119392395,z:.09809435904026031},{x:.47159942984580994,y:.6711485385894775,z:.007849935442209244},{x:.5734396576881409,y:.8256140351295471,z:-.03155219927430153},{x:.5306524038314819,y:.8337990641593933,z:-.018351426348090172},{x:.5371729135513306,y:.7910830974578857,z:-.037286680191755295},{x:.5549534559249878,y:.8275275826454163,z:-.030664825811982155},{x:.5597432255744934,y:.6418541669845581,z:-.03318847343325615},{x:.4958484172821045,y:.9429569244384766,z:.048340678215026855},{x:.5140507817268372,y:.9634028077125549,z:.03589847311377525},{x:.5587693452835083,y:.9951097369194031,z:.00908728688955307},{x:.46411189436912537,y:.9051855206489563,z:.10601935535669327},{x:.5181609392166138,y:.6554316878318787,z:.002546071307733655},{x:.5436590909957886,y:.7085841298103333,z:-.03844436630606651},{x:.5872187614440918,y:.9960382580757141,z:.0063423276878893375},{x:.5379653573036194,y:.9989125728607178,z:.03636329993605614},{x:.4350326955318451,y:.8088565468788147,z:.09147704392671585},{x:.5523084998130798,y:.8773422837257385,z:-.009068487212061882},{x:.5510149598121643,y:.8816931843757629,z:-.011043853126466274},{x:.5503793954849243,y:.88776695728302,z:-.01348799467086792},{x:.5501549243927002,y:.8954370617866516,z:-.012142189778387547},{x:.546072781085968,y:.9192524552345276,z:-.003157563041895628},{x:.5314661860466003,y:.8771666884422302,z:.0005075141089037061},{x:.5293324589729309,y:.8762547969818115,z:.00039177737198770046},{x:.5275698900222778,y:.8750609755516052,z:47732755774632096e-21},{x:.5104271173477173,y:.8607332110404968,z:.0012934643309563398},{x:.45938700437545776,y:.8134918212890625,z:.023569690063595772},{x:.5418947339057922,y:.6864100694656372,z:-.027333909645676613},{x:.531914234161377,y:.6456130743026733,z:-.005434140563011169},{x:.523697018623352,y:.647885262966156,z:-.0002466466394253075},{x:.5338191390037537,y:.8783687353134155,z:.002268768846988678},{x:.46226605772972107,y:.8610277771949768,z:.04718952998518944},{x:.5434442758560181,y:.6456181406974792,z:-.02327350154519081},{x:.5399754643440247,y:.940219521522522,z:.005075343884527683},{x:.5661457777023315,y:.71457839012146,z:-.06242101639509201},{x:.5523148775100708,y:.6974870562553406,z:-.04863070324063301},{x:.5639959573745728,y:.6923378109931946,z:-.05180761218070984},{x:.5367592573165894,y:.7423217296600342,z:-.03623027727007866},{x:.5853689908981323,y:.9752064943313599,z:-.002361974213272333},{x:.5835235118865967,y:.9493685960769653,z:-.003941743168979883},{x:.5615018606185913,y:.949194610118866,z:-.0015953965485095978},{x:.5068561434745789,y:.9048219323158264,z:.01862684078514576},{x:.5134067535400391,y:.7971825003623962,z:-.008485661819577217},{x:.5223897099494934,y:.925589919090271,z:.01249657291918993},{x:.48500555753707886,y:.7959478497505188,z:-.0032065745908766985},{x:.5037734508514404,y:.8184596300125122,z:-.004932103678584099},{x:.4766361117362976,y:.828806459903717,z:.01027688942849636},{x:.5589827299118042,y:.974656343460083,z:.0009666886180639267},{x:.5294582843780518,y:.7541216611862183,z:-.025603046640753746},{x:.4973002076148987,y:.9208990931510925,z:.031931452453136444},{x:.5163551568984985,y:.9432790875434875,z:.024321340024471283},{x:.49399662017822266,y:.8814862370491028,z:.018687399104237556},{x:.44948166608810425,y:.836137592792511,z:.05702034756541252},{x:.47898444533348083,y:.8836610913276672,z:.03150695189833641},{x:.4454479217529297,y:.8499438166618347,z:.08868525922298431},{x:.49572959542274475,y:.8452823758125305,z:.0036111653316766024},{x:.5362502336502075,y:.7222585678100586,z:-.027912352234125137},{x:.5393770337104797,y:.7850722074508667,z:-.05415399745106697},{x:.531399667263031,y:.7898418307304382,z:-.03883346915245056},{x:.5451627373695374,y:.7717036604881287,z:-.06480253487825394},{x:.5206395983695984,y:.6287745833396912,z:-.010521138086915016},{x:.4974782466888428,y:.6191938519477844,z:-.014098240062594414},{x:.4774145185947418,y:.6193130612373352,z:-.013643337413668633},{x:.4616098403930664,y:.6259890198707581,z:-.008448202162981033},{x:.4516478478908539,y:.6368461847305298,z:9050309745362028e-20},{x:.4485096037387848,y:.6719120740890503,z:.022984720766544342},{x:.42177659273147583,y:.7240667343139648,z:.08511673659086227},{x:.4616215229034424,y:.6988231539726257,z:.014238474890589714},{x:.4755798876285553,y:.7034608721733093,z:.00625590980052948},{x:.4924992024898529,y:.7005885243415833,z:.0009391739731654525},{x:.5082254409790039,y:.693384051322937,z:-.0009464038303121924},{x:.5203112959861755,y:.6849707961082458,z:-.0022114769089967012},{x:.52867591381073,y:.6779075860977173,z:-.002962538506835699},{x:.4213953912258148,y:.7219811677932739,z:.1350894570350647},{x:.5320829749107361,y:.794858992099762,z:-.03181503340601921},{x:.5452795028686523,y:.7286570072174072,z:-.04771539941430092},{x:.5496407747268677,y:.7866933345794678,z:-.06452003121376038},{x:.557040274143219,y:.7962084412574768,z:-.05837344378232956},{x:.549176812171936,y:.7895247936248779,z:-.057761140167713165},{x:.5362890362739563,y:.8005836606025696,z:-.026903774589300156},{x:.560200035572052,y:.7983731031417847,z:-.06172555685043335},{x:.5616944432258606,y:.8022753596305847,z:-.045200999826192856},{x:.5273328423500061,y:.6611284017562866,z:.0029021520167589188},{x:.534850537776947,y:.6660012006759644,z:-.005215510260313749},{x:.5394860506057739,y:.6701375246047974,z:-.014931917190551758},{x:.4634307324886322,y:.658291757106781,z:.009295716881752014},{x:.4538393020629883,y:.6519932150840759,z:.00930330716073513},{x:.5776031613349915,y:.7159298658370972,z:-.057365912944078445},{x:.6504855155944824,y:.6461779475212097,z:.014184834435582161},{x:.5860154032707214,y:.7962266206741333,z:-.04522843658924103},{x:.6842049360275269,y:.5631637573242188,z:.07207967340946198},{x:.6152560710906982,y:.6674962639808655,z:.0007529259892180562},{x:.6280948519706726,y:.6684326529502869,z:.0016892586136236787},{x:.6408625245094299,y:.6663892269134521,z:.005331226624548435},{x:.6557814478874207,y:.6534678936004639,z:.01646413467824459},{x:.6035663485527039,y:.6639701724052429,z:.0013799630105495453},{x:.6329053044319153,y:.608010470867157,z:-.006195899099111557},{x:.6167260408401489,y:.6117533445358276,z:-.006319951266050339},{x:.6471013426780701,y:.6112449765205383,z:-.0017843559617176652},{x:.6560901999473572,y:.6185776591300964,z:.004047257360070944},{x:.6666946411132812,y:.6651176810264587,z:.023647578433156013},{x:.6311345100402832,y:.9495396018028259,z:.014004078693687916},{x:.6544655561447144,y:.6397901773452759,z:.01809609681367874},{x:.6965808868408203,y:.6482675075531006,z:.08304904401302338},{x:.679817259311676,y:.650188148021698,z:.03632688894867897},{x:.6336516737937927,y:.7541458010673523,z:-.007742783520370722},{x:.5921701192855835,y:.8567668199539185,z:-.029399123042821884},{x:.591663658618927,y:.870215654373169,z:-.02103729173541069},{x:.6068367958068848,y:.8584195375442505,z:-.020668085664510727},{x:.6176617741584778,y:.860965371131897,z:-.009790095500648022},{x:.6040634512901306,y:.8686612844467163,z:-.015289564616978168},{x:.6143736839294434,y:.8671170473098755,z:-.005712216719985008},{x:.6373105049133301,y:.8815656900405884,z:.012672550976276398},{x:.5832505822181702,y:.7866312861442566,z:-.07051534950733185},{x:.5836675763130188,y:.7658692598342896,z:-.07566110789775848},{x:.6709531545639038,y:.604898989200592,z:.005951565690338612},{x:.6029891967773438,y:.705652117729187,z:-.013388276100158691},{x:.6131622195243835,y:.7728396058082581,z:-.036248479038476944},{x:.6123163104057312,y:.7612020373344421,z:-.03264721855521202},{x:.6696187853813171,y:.744706928730011,z:.009673702530562878},{x:.5803102254867554,y:.7385968565940857,z:-.0689152330160141},{x:.6404349207878113,y:.5877999663352966,z:-.01929756999015808},{x:.6588467955589294,y:.5929454565048218,z:-.008487257175147533},{x:.6720337867736816,y:.530631422996521,z:.043437421321868896},{x:.584305465221405,y:.6099005341529846,z:-.030301367864012718},{x:.6034283638000488,y:.6217452883720398,z:-.001970183802768588},{x:.6460927724838257,y:.8608663082122803,z:.015541625209152699},{x:.6957815289497375,y:.8326103091239929,z:.13015234470367432},{x:.6043362617492676,y:.7861682772636414,z:-.030476901680231094},{x:.594293475151062,y:.7942103147506714,z:-.032218821346759796},{x:.6324057579040527,y:.8665139675140381,z:.014255806803703308},{x:.6296147704124451,y:.8667733669281006,z:.010388285852968693},{x:.663644552230835,y:.5798642635345459,z:-.0022301070857793093},{x:.6140630841255188,y:.7809288501739502,z:-.02835679054260254},{x:.615908145904541,y:.5921698212623596,z:-.026804860681295395},{x:.617181122303009,y:.5748661756515503,z:-.03060605563223362},{x:.6222207546234131,y:.49137672781944275,z:-.011151673272252083},{x:.6669357419013977,y:.5541607141494751,z:.017466170713305473},{x:.6182981729507446,y:.5320425629615784,z:-.021793590858578682},{x:.6760554313659668,y:.595052182674408,z:.017115700989961624},{x:.6801463961601257,y:.5800720453262329,z:.043127160519361496},{x:.5922210812568665,y:.8644017577171326,z:-.02662893570959568},{x:.6054555177688599,y:.8637874722480774,z:-.018363753333687782},{x:.6161889433860779,y:.8641164898872375,z:-.008808949030935764},{x:.6017249822616577,y:.7901403307914734,z:-.028126630932092667},{x:.631446123123169,y:.8664817810058594,z:.012112865224480629},{x:.6249198913574219,y:.8716511130332947,z:.003882825840264559},{x:.6281915903091431,y:.867301881313324,z:.009891441091895103},{x:.5986843109130859,y:.7813931703567505,z:-.050227612257003784},{x:.6126407384872437,y:.869275689125061,z:-.0031255714129656553},{x:.6027271151542664,y:.8711842894554138,z:-.009324162267148495},{x:.59088134765625,y:.8742044568061829,z:-.014608660712838173},{x:.5984604358673096,y:.9216185212135315,z:-.005981989670544863},{x:.5950398445129395,y:.8964707255363464,z:-.01703473925590515},{x:.5941568613052368,y:.8882410526275635,z:-.017784785479307175},{x:.5928806662559509,y:.8803883194923401,z:-.014153128489851952},{x:.5909661054611206,y:.8748103976249695,z:-.012609979137778282},{x:.6128016710281372,y:.8702545762062073,z:-.0022550546564161777},{x:.6150846481323242,y:.8726804256439209,z:-.00414019962772727},{x:.6173093914985657,y:.8770190477371216,z:-.005970994010567665},{x:.619335412979126,y:.8814800977706909,z:-.0036864024586975574},{x:.6292637586593628,y:.8314558267593384,z:-.007714875973761082},{x:.702275276184082,y:.7320667505264282,z:.1433621346950531},{x:.6204835176467896,y:.8689177632331848,z:.0044869170524179935},{x:.6223508715629578,y:.8704851269721985,z:.00352082890458405},{x:.590448260307312,y:.8029727935791016,z:-.03200828656554222},{x:.6097423434257507,y:.7933741211891174,z:-.018042555078864098},{x:.59229576587677,y:.7993767261505127,z:-.032564569264650345},{x:.6171364188194275,y:.7153720259666443,z:-.007672437466681004},{x:.6389747858047485,y:.726390540599823,z:-.002999067772179842},{x:.6151940226554871,y:.769412100315094,z:-.024427521973848343},{x:.6526776552200317,y:.505868136882782,z:.01412637997418642},{x:.6475822329521179,y:.5375454425811768,z:-.0033899128902703524},{x:.6433356404304504,y:.5714520215988159,z:-.017428796738386154},{x:.626949667930603,y:.8962116837501526,z:.005602736957371235},{x:.5868416428565979,y:.5829002261161804,z:-.03727729618549347},{x:.5877229571342468,y:.5345035791397095,z:-.032396964728832245},{x:.5887066125869751,y:.48655083775520325,z:-.025856535881757736},{x:.6507197618484497,y:.6612282991409302,z:.011114613153040409},{x:.6803066730499268,y:.677992045879364,z:.032125361263751984},{x:.5963194370269775,y:.6598632335662842,z:.002976928371936083},{x:.667536199092865,y:.6274255514144897,z:.015618261881172657},{x:.5930740833282471,y:.6940041780471802,z:-.019217798486351967},{x:.6053346395492554,y:.7676517963409424,z:-.050308309495449066},{x:.6934473514556885,y:.6884298920631409,z:.04794462397694588},{x:.6738007664680481,y:.6934011578559875,z:.020697161555290222},{x:.6588084697723389,y:.7033141851425171,z:.008462334051728249},{x:.6346072554588318,y:.7029502391815186,z:.001542167621664703},{x:.6157816648483276,y:.6966525912284851,z:-.002009218093007803},{x:.6015574336051941,y:.688928484916687,z:-.006588225718587637},{x:.5746836066246033,y:.6711069345474243,z:-.03597589209675789},{x:.6947521567344666,y:.7309479117393494,z:.046707939356565475},{x:.6759101152420044,y:.6249120831489563,z:.021654341369867325},{x:.5794773101806641,y:.7971615195274353,z:-.06339326500892639},{x:.6041849851608276,y:.727514922618866,z:-.017512541264295578},{x:.6968844532966614,y:.6440950036048889,z:.12727996706962585},{x:.5910853147506714,y:.679325520992279,z:-.009497715160250664},{x:.6157375574111938,y:.7695677280426025,z:-.010624290443956852},{x:.6606494784355164,y:.6410489678382874,z:.0208158977329731},{x:.6040687561035156,y:.7531470656394958,z:-.045887019485235214},{x:.7012156248092651,y:.780247151851654,z:.14028730988502502},{x:.595149576663971,y:.6527782678604126,z:.006308757700026035},{x:.5925500392913818,y:.7436665892601013,z:-.060151755809783936},{x:.6780198812484741,y:.8905693888664246,z:.0626060739159584},{x:.676746666431427,y:.9113880395889282,z:.08726003766059875},{x:.7030686140060425,y:.7312687635421753,z:.09529774636030197},{x:.688987135887146,y:.8588417172431946,z:.07752864807844162},{x:.6883691549301147,y:.6109960675239563,z:.06669612973928452},{x:.6358906030654907,y:.9702065587043762,z:.023120900616049767},{x:.5781539678573608,y:.8023634552955627,z:-.044763918966054916},{x:.6170316934585571,y:.7408350706100464,z:-.011375460773706436},{x:.688542366027832,y:.6516284346580505,z:.050206027925014496},{x:.6385149359703064,y:.6540714502334595,z:.006462941411882639},{x:.6279382109642029,y:.6563615798950195,z:.003062846139073372},{x:.6268895268440247,y:.8736732006072998,z:.00627936702221632},{x:.6944946050643921,y:.7709181308746338,z:.053824134171009064},{x:.614617109298706,y:1.0022112131118774,z:.02719894051551819},{x:.6493719220161438,y:.9665167927742004,z:.053563784807920456},{x:.6624587178230286,y:.943530797958374,z:.068605437874794},{x:.6162528991699219,y:.6558693051338196,z:.002187855076044798},{x:.6058168411254883,y:.654328465461731,z:.0036193584091961384},{x:.5987918972969055,y:.6536934971809387,z:.006134530063718557},{x:.6831037402153015,y:.6195642948150635,z:.03511790186166763},{x:.6062582731246948,y:.6356398463249207,z:.001280312892049551},{x:.6174948811531067,y:.62776118516922,z:-.0013642468256875873},{x:.6297246217727661,y:.6253792643547058,z:-.0007034156005829573},{x:.6407091617584229,y:.627578616142273,z:.0028144705574959517},{x:.6479622721672058,y:.6322650909423828,z:.00750273372977972},{x:.6915091276168823,y:.5990704298019409,z:.10270945727825165},{x:.6457163095474243,y:.6504453420639038,z:.010696077719330788},{x:.6164222955703735,y:.8231936097145081,z:-.016772059723734856},{x:.6042401194572449,y:.7830976843833923,z:-.03630910441279411},{x:.5922216773033142,y:.8228387236595154,z:-.029992375522851944},{x:.6646111011505127,y:.92097008228302,z:.050967294722795486},{x:.651232898235321,y:.9460107088088989,z:.038000158965587616},{x:.6140977144241333,y:.9882472157478333,z:.009882091544568539},{x:.6870781183242798,y:.8768675327301025,z:.10980932414531708},{x:.5986856818199158,y:.6456438899040222,z:.003999010659754276},{x:.585981547832489,y:.7034481763839722,z:-.0377722829580307},{x:.6342031359672546,y:.9867448806762695,z:.03786521404981613},{x:.7013950943946838,y:.776049017906189,z:.09598205983638763},{x:.6030206680297852,y:.8719133138656616,z:-.007931148633360863},{x:.6050592064857483,y:.8767156004905701,z:-.009791925549507141},{x:.6073468923568726,y:.8831382393836975,z:-.012361008673906326},{x:.6087977290153503,y:.890143632888794,z:-.01098148338496685},{x:.6147705316543579,y:.9110084772109985,z:-.0018823575228452682},{x:.622577965259552,y:.8670604825019836,z:.002609190298244357},{x:.6241236329078674,y:.8651344180107117,z:.0025534380692988634},{x:.6257084608078003,y:.8638408184051514,z:.0023300074972212315},{x:.639931321144104,y:.8449671268463135,z:.0038123116828501225},{x:.6810906529426575,y:.7856625318527222,z:.02717764675617218},{x:.583532452583313,y:.6811994910240173,z:-.026588857173919678},{x:.5855660438537598,y:.6393819451332092,z:-.004512844607234001},{x:.5932201743125916,y:.6398029327392578,z:.0008020466193556786},{x:.6200879812240601,y:.8683351874351501,z:.00417016725987196},{x:.6842559576034546,y:.8330534100532532,z:.050836317241191864},{x:.5754412412643433,y:.6418221592903137,z:-.022838059812784195},{x:.6232790350914001,y:.9295297265052795,z:.006339520215988159},{x:.5764067769050598,y:.694546639919281,z:-.04825803264975548},{x:.59778892993927,y:.7343927621841431,z:-.035004377365112305},{x:.6042810678482056,y:.9441440105438232,z:-.0010970570147037506},{x:.6496372222900391,y:.8869078159332275,z:.021036235615611076},{x:.6274012327194214,y:.7830310463905334,z:-.006658440921455622},{x:.637792706489563,y:.9104999899864197,z:.014290250837802887},{x:.6549934148788452,y:.7748609185218811,z:-.0006672973395325243},{x:.6404005289077759,y:.801220715045929,z:-.0026642554439604282},{x:.6671456694602966,y:.8045546412467957,z:.013180811889469624},{x:.6107483506202698,y:.9680658578872681,z:.001778992242179811},{x:.6060343980789185,y:.744587242603302,z:-.024382334202528},{x:.6602751612663269,y:.8998945355415344,z:.0344940721988678},{x:.6463775038719177,y:.9262562394142151,z:.02617623284459114},{x:.6579852104187012,y:.8602304458618164,z:.021586716175079346},{x:.6926165223121643,y:.8053340315818787,z:.061075080186128616},{x:.6724731922149658,y:.8594399690628052,z:.03457934781908989},{x:.6975721716880798,y:.8183245062828064,z:.09300774335861206},{x:.6512877941131592,y:.8258221745491028,z:.006324059329926968},{x:.594887375831604,y:.7148372530937195,z:-.026898479089140892},{x:.6017440557479858,y:.7773507833480835,z:-.05312420800328255},{x:.6096571683883667,y:.7806998491287231,z:-.037646256387233734},{x:.5952993035316467,y:.7654367685317993,z:-.06398405134677887},{x:.5950021147727966,y:.6201304793357849,z:-.009297547861933708},{x:.6165438890457153,y:.6052900552749634,z:-.012455573305487633},{x:.6362661719322205,y:.6015968918800354,z:-.011649220250546932},{x:.6522727608680725,y:.6046400666236877,z:-.005903332494199276},{x:.6625409722328186,y:.6128141283988953,z:.0030042496509850025},{x:.6688099503517151,y:.6457712054252625,z:.026322703808546066},{x:.7013440728187561,y:.6893666386604309,z:.08984331786632538},{x:.6608623266220093,y:.6749406456947327,z:.0172116681933403},{x:.6482325196266174,y:.6823726296424866,z:.008881398476660252},{x:.6313265562057495,y:.6842025518417358,z:.0031308617908507586},{x:.6147016286849976,y:.6809731721878052,z:.0007630771724507213},{x:.6018834114074707,y:.6755372285842896,z:-.0008834321051836014},{x:.5925027132034302,y:.670681357383728,z:-.001968748401850462},{x:.700127363204956,y:.6871103644371033,z:.13980500400066376},{x:.6095665693283081,y:.7853189706802368,z:-.03074747882783413},{x:.5880423784255981,y:.7229287028312683,z:-.04691500961780548},{x:.5930182337760925,y:.7811514139175415,z:-.06398335844278336},{x:.5867722034454346,y:.7922660112380981,z:-.05794971063733101},{x:.5933279991149902,y:.7842848896980286,z:-.05714067071676254},{x:.6063535809516907,y:.7920218706130981,z:-.02590685710310936},{x:.5839452743530273,y:.794978141784668,z:-.0615212507545948},{x:.5828126072883606,y:.8000800013542175,z:-.0449722595512867},{x:.5909603834152222,y:.6541213393211365,z:.003991890233010054},{x:.5852181911468506,y:.6602938771247864,z:-.004428438376635313},{x:.5825737714767456,y:.6651063561439514,z:-.014345290139317513},{x:.6517343521118164,y:.6362385153770447,z:.012151890434324741},{x:.6615052819252014,y:.6281577944755554,z:.0123682152479887},{x:.4856873154640198,y:.6568945646286011,z:.000720038078725338},{x:.49988406896591187,y:.6547410488128662,z:.0006949726957827806},{x:.48438939452171326,y:.6392973065376282,z:.000705525919329375},{x:.47143134474754333,y:.6589511632919312,z:.0006980331381782889},{x:.48704618215560913,y:.6752797961235046,z:.0006921177846379578},{x:.6243702173233032,y:.640461802482605,z:-6592126737814397e-20},{x:.6390967965126038,y:.6385173797607422,z:-.00016105435497593135},{x:.6230536699295044,y:.6224825382232666,z:-.00016136496560648084},{x:.6095397472381592,y:.641917884349823,z:-.0001803556369850412},{x:.6250996589660645,y:.6586247682571411,z:-.0001785515050869435}]],faceBlendshapes:[{categories:[{index:0,score:5187174338061595e-21,categoryName:"_neutral",displayName:""},{index:1,score:.24521504342556,categoryName:"browDownLeft",displayName:""},{index:2,score:.1987743377685547,categoryName:"browDownRight",displayName:""},{index:3,score:.013400448486208916,categoryName:"browInnerUp",displayName:""},{index:4,score:.012361560948193073,categoryName:"browOuterUpLeft",displayName:""},{index:5,score:.019305096939206123,categoryName:"browOuterUpRight",displayName:""},{index:6,score:28426356948330067e-21,categoryName:"cheekPuff",displayName:""},{index:7,score:34500112633395474e-23,categoryName:"cheekSquintLeft",displayName:""},{index:8,score:483789051486383e-21,categoryName:"cheekSquintRight",displayName:""},{index:9,score:.07650448381900787,categoryName:"eyeBlinkLeft",displayName:""},{index:10,score:.05070012807846069,categoryName:"eyeBlinkRight",displayName:""},{index:11,score:.13978900015354156,categoryName:"eyeLookDownLeft",displayName:""},{index:12,score:.14198613166809082,categoryName:"eyeLookDownRight",displayName:""},{index:13,score:.2177766114473343,categoryName:"eyeLookInLeft",displayName:""},{index:14,score:.014739357866346836,categoryName:"eyeLookInRight",displayName:""},{index:15,score:.02361512929201126,categoryName:"eyeLookOutLeft",displayName:""},{index:16,score:.19679604470729828,categoryName:"eyeLookOutRight",displayName:""},{index:17,score:.04874616861343384,categoryName:"eyeLookUpLeft",displayName:""},{index:18,score:.049392376095056534,categoryName:"eyeLookUpRight",displayName:""},{index:19,score:.34944331645965576,categoryName:"eyeSquintLeft",displayName:""},{index:20,score:.2939716875553131,categoryName:"eyeSquintRight",displayName:""},{index:21,score:.005955042317509651,categoryName:"eyeWideLeft",displayName:""},{index:22,score:.006776117719709873,categoryName:"eyeWideRight",displayName:""},{index:23,score:16942436559475027e-21,categoryName:"jawForward",displayName:""},{index:24,score:.0045165494084358215,categoryName:"jawLeft",displayName:""},{index:25,score:.07803940027952194,categoryName:"jawOpen",displayName:""},{index:26,score:2090057751047425e-20,categoryName:"jawRight",displayName:""},{index:27,score:.06032035872340202,categoryName:"mouthClose",displayName:""},{index:28,score:.00228882092051208,categoryName:"mouthDimpleLeft",displayName:""},{index:29,score:.00781762320548296,categoryName:"mouthDimpleRight",displayName:""},{index:30,score:.0017093931091949344,categoryName:"mouthFrownLeft",displayName:""},{index:31,score:.0019319106359034777,categoryName:"mouthFrownRight",displayName:""},{index:32,score:8485237776767462e-20,categoryName:"mouthFunnel",displayName:""},{index:33,score:.0009051355300471187,categoryName:"mouthLeft",displayName:""},{index:34,score:.0003630454302765429,categoryName:"mouthLowerDownLeft",displayName:""},{index:35,score:.00017601238505449146,categoryName:"mouthLowerDownRight",displayName:""},{index:36,score:.12865161895751953,categoryName:"mouthPressLeft",displayName:""},{index:37,score:.20137207210063934,categoryName:"mouthPressRight",displayName:""},{index:38,score:.0022203284315764904,categoryName:"mouthPucker",displayName:""},{index:39,score:.0009096377179957926,categoryName:"mouthRight",displayName:""},{index:40,score:.34189721941947937,categoryName:"mouthRollLower",displayName:""},{index:41,score:.11409689486026764,categoryName:"mouthRollUpper",displayName:""},{index:42,score:.17172536253929138,categoryName:"mouthShrugLower",displayName:""},{index:43,score:.004038424696773291,categoryName:"mouthShrugUpper",displayName:""},{index:44,score:.00023205230536404997,categoryName:"mouthSmileLeft",displayName:""},{index:45,score:.00019313619122840464,categoryName:"mouthSmileRight",displayName:""},{index:46,score:.0018571305554360151,categoryName:"mouthStretchLeft",displayName:""},{index:47,score:.0023813238367438316,categoryName:"mouthStretchRight",displayName:""},{index:48,score:24323100660694763e-21,categoryName:"mouthUpperUpLeft",displayName:""},{index:49,score:3161552012898028e-20,categoryName:"mouthUpperUpRight",displayName:""},{index:50,score:108198406678639e-21,categoryName:"noseSneerLeft",displayName:""},{index:51,score:12652527630052646e-22,categoryName:"noseSneerRight",displayName:""}],headIndex:-1,headName:""}],facialTransformationMatrixes:[{rows:4,columns:4,data:[.9947517514228821,.10230544209480286,.0013679931871592999,0,-.10230997204780579,.9947447776794434,.003816320328041911,0,-.000970348424743861,-.0039362297393381596,.9999914169311523,0,2.8888821601867676,-7.808934211730957,-30.52109146118164,1]}]}},W2=A.createContext({}),$m={basePath:"https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.17/wasm",options:{baseOptions:{modelAssetPath:"https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task",delegate:"GPU"},runningMode:"VIDEO",outputFaceBlendshapes:!0,outputFacialTransformationMatrixes:!0}};function Pb({basePath:n=$m.basePath,options:e=$m.options,children:t}){const i=JSON.stringify(e),s=dn(async()=>{const{FilesetResolver:r,FaceLandmarker:o}=await A1(async()=>{const{FilesetResolver:c,FaceLandmarker:l}=await import("./vision_bundle-CPRQl8Yc.js");return{FilesetResolver:c,FaceLandmarker:l}},[]),a=await r.forVisionTasks(n);return o.createFromOptions(a,e)},[n,i]);return A.useEffect(()=>()=>{s==null||s.close(),Ph([n,i])},[s,n,i]),A.createElement(W2.Provider,{value:s},t)}function QB(){return A.useContext(W2)}function Wm(n,e){return n.clone().add(e).multiplyScalar(.5)}function Zn(n,e,t){const i=n.localToWorld(e);return t.worldToLocal(i)}const j2=A.createContext({}),Fb=A.forwardRef(({camera:n,autostart:e=!0,webcam:t=!0,webcamVideoTextureSrc:i,manualUpdate:s=!1,manualDetect:r=!1,onVideoFrame:o,smoothTime:a=.25,offset:c=!0,offsetScalar:l=80,eyes:u=!1,eyesAsOrigin:h=!0,depth:f=.15,debug:d=!1,facemesh:p,makeDefault:m},g)=>{var y,v;const E=Z(P=>P.scene),C=Z(P=>P.camera),x=Z(P=>P.set),I=Z(P=>P.get),S=n||C,w=A.useRef(null),B=A.useRef(null),[T]=A.useState(()=>new lt),[R]=A.useState(()=>new b),[_]=A.useState(()=>new b),[L]=A.useState(()=>new b),[O]=A.useState(()=>new b),U=A.useCallback(()=>{T.parent=S.parent;const P=B.current;if(P){const{outerRef:F,eyeRightRef:J,eyeLeftRef:se}=P;if(J.current&&se.current){const{irisDirRef:q}=J.current,{irisDirRef:re}=se.current;q.current&&re.current&&F.current&&(R.copy(Zn(q.current,new b(0,0,0),F.current)),_.copy(Zn(re.current,new b(0,0,0),F.current)),T.position.copy(Zn(F.current,Wm(R,_),S.parent||E)),L.copy(Zn(q.current,new b(0,0,1),F.current)),O.copy(Zn(re.current,new b(0,0,1),F.current)),T.lookAt(F.current.localToWorld(Wm(L,O))))}else F.current&&(T.position.copy(Zn(F.current,new b(0,0,0),S.parent||E)),T.lookAt(F.current.localToWorld(new b(0,0,1))))}return T},[S,_,O,R,L,E,T]),[Q]=A.useState(()=>new lt),G=A.useCallback(function(P,F){if(S){var J;(J=F)!==null&&J!==void 0||(F=U()),a>0?(Ar.damp3(Q.position,F.position,a,P,void 0,void 0,1e-9),Ar.dampE(Q.rotation,F.rotation,a,P,void 0,void 0,1e-9)):(Q.position.copy(F.position),Q.rotation.copy(F.rotation)),S.position.copy(Q.position),S.rotation.copy(Q.rotation)}},[S,U,a,Q.position,Q.rotation]),[z,H]=A.useState(),N=QB(),V=A.useCallback((P,F)=>{const J=N==null?void 0:N.detectForVideo(P,F);return H(J),J},[N]);Ee((P,F)=>{s||G(F)});const $=A.useMemo(()=>Object.assign(Object.create(hn.prototype),{detect:V,computeTarget:U,update:G,facemeshApiRef:B,webcamApiRef:w,play:()=>{var P;(P=w.current)==null||(P=P.videoTextureApiRef.current)==null||P.texture.source.data.play()},pause:()=>{var P;(P=w.current)==null||(P=P.videoTextureApiRef.current)==null||P.texture.source.data.pause()}}),[V,U,G]);A.useImperativeHandle(g,()=>$,[$]),A.useEffect(()=>{const P=F=>{r||V(F.texture.source.data,F.time),o&&o(F)};return $.addEventListener("videoFrame",P),()=>{$.removeEventListener("videoFrame",P)}},[$,V,N,r,o]),A.useEffect(()=>{if(m){const P=I().controls;return x({controls:$}),()=>x({controls:P})}},[m,$,I,x]);const Y=z==null?void 0:z.faceLandmarks[0],M=z==null||(y=z.facialTransformationMatrixes)==null?void 0:y[0],k=z==null||(v=z.faceBlendshapes)==null?void 0:v[0];return A.createElement(j2.Provider,{value:$},t&&A.createElement(A.Suspense,{fallback:null},A.createElement(NB,{ref:w,autostart:e,videoTextureSrc:i})),A.createElement(UB,ie({ref:B},p,{points:Y,depth:f,facialTransformationMatrix:M,faceBlendshapes:k,eyes:u,eyesAsOrigin:h,offset:c,offsetScalar:l,debug:d,"rotation-z":Math.PI,visible:d}),A.createElement("meshBasicMaterial",{side:Tt})))}),J2=()=>A.useContext(j2),NB=A.forwardRef(({videoTextureSrc:n,autostart:e=!0},t)=>{const i=A.useRef(null),s=J2(),r=dn(async()=>n?Promise.resolve(null):await navigator.mediaDevices.getUserMedia({audio:!1,video:{facingMode:"user"}}),[n]);A.useEffect(()=>(s.dispatchEvent({type:"stream",stream:r}),()=>{r==null||r.getTracks().forEach(a=>a.stop()),Ph([n])}),[r,s,n]);const o=A.useMemo(()=>({videoTextureApiRef:i}),[]);return A.useImperativeHandle(t,()=>o,[o]),A.createElement(A.Suspense,{fallback:null},A.createElement(GB,{ref:i,src:n||r,start:e}))}),GB=A.forwardRef(({src:n,start:e},t)=>{const i=i2(n,{start:e}),s=i.source.data,r=J2(),o=A.useCallback(c=>{r.dispatchEvent({type:"videoFrame",texture:i,time:c})},[i,r]);zB(s,o);const a=A.useMemo(()=>({texture:i}),[i]);return A.useImperativeHandle(t,()=>a,[a]),A.createElement(A.Fragment,null)}),zB=(n,e)=>{A.useEffect(()=>{if(!n||!n.requestVideoFrameCallback)return;let t;function i(...s){e(...s),t=n.requestVideoFrameCallback(i)}return n.requestVideoFrameCallback(i),()=>n.cancelVideoFrameCallback(t)},[n,e])};export{$w as AccumulativeShadows,wb as AdaptiveDpr,Tb as AdaptiveEvents,Q_ as ArcballControls,M_ as AsciiRenderer,d7 as BBAnchor,ib as Backdrop,Ib as BakeShadows,CC as Billboard,Gw as Bounds,M7 as Box,l7 as Bvh,H_ as CameraControls,eb as CameraShake,j7 as Capsule,m_ as CatmullRomLine,nb as Caustics,E2 as Center,L7 as Circle,mc as Clone,hb as Cloud,hm as CloudInstance,pT as Clouds,w_ as ComputedAttribute,P7 as Cone,Hw as ContactShadows,P_ as CubeCamera,j_ as CubeTexture,A_ as CubicBezierLine,x7 as CurveModifier,KB as CycleRaycast,F7 as Cylinder,b_ as Decal,xb as Detailed,a7 as DetectGPU,F_ as DeviceOrientationControls,Y7 as Dodecahedron,WB as DragControls,UC as Edges,y_ as Effects,Jy as Environment,Ub as EnvironmentCube,Qb as EnvironmentMap,Nb as EnvironmentPortal,m7 as Example,$7 as Extrude,Fb as FaceControls,Pb as FaceLandmarker,$m as FaceLandmarkerDefaults,UB as Facemesh,Qu as FacemeshDatas,Ym as FacemeshEye,Ao as FacemeshEyeDefaults,Gb as Fbo,J_ as Fbx,z_ as FirstPersonControls,Db as Fisheye,zb as Float,k_ as FlyControls,V_ as GizmoHelper,Y_ as GizmoViewcube,$_ as GizmoViewport,D_ as Gltf,Hb as GradientTexture,Kb as GradientType,W_ as Grid,t7 as Helper,Lc as Html,mI as Hud,K7 as Icosahedron,x_ as Image,wf as Instance,y7 as InstancedAttribute,Tf as Instances,So as IsObject,XB as KeyboardControls,q_ as Ktx2,W7 as Lathe,cb as Lightformer,cs as Line,$B as Loader,O_ as MapControls,B_ as MarchingCube,T_ as MarchingCubes,__ as MarchingPlane,bb as Mask,db as MatcapTexture,p7 as Merged,_7 as MeshDiscardMaterial,C7 as MeshDistortMaterial,Mb as MeshPortalMaterial,w7 as MeshReflectorMaterial,T7 as MeshRefractionMaterial,B7 as MeshTransmissionMaterial,I7 as MeshWobbleMaterial,K_ as MotionPathControls,b7 as MultiMaterial,Ab as NormalTexture,V7 as Octahedron,Vb as OrbitControls,oI as OrthographicCamera,C_ as Outlines,Bb as PerformanceMonitor,Yb as PerspectiveCamera,Lb as PivotControls,O7 as Plane,gb as Point,R7 as PointMaterial,Fw as PointMaterialImpl,G_ as PointerLockControls,yb as Points,QT as PointsBuffer,H7 as Polyhedron,Sw as PositionMesh,OT as PositionPoint,p_ as PositionalAudio,Cb as Preload,qB as PresentationControls,YB as Progress,d_ as QuadraticBezierLine,Ww as RandomizedLight,rb as Reflector,HT as RenderCubeTexture,GT as RenderTexture,Z7 as Resize,z7 as Ring,q7 as RoundedBox,S_ as Sampler,X7 as ScreenQuad,f_ as ScreenSizer,h_ as ScreenSpace,JB as Scroll,jB as ScrollControls,vb as Segment,NT as SegmentObject,Eb as Segments,l_ as Select,sb as Shadow,pb as ShadowAlpha,J7 as Shape,lb as Sky,D7 as SoftShadows,fb as Sparkles,k7 as Sphere,L_ as Splat,ab as SpotLight,ob as SpotLightShadow,v7 as SpriteAnimator,tb as Stage,ub as Stars,i7 as Stats,G9 as StatsGl,R_ as Svg,G7 as Tetrahedron,$b as Text,PC as Text3D,v_ as Texture,Q7 as Torus,N7 as TorusKnot,U_ as TrackballControls,I_ as Trail,A7 as TrailTexture,N_ as TransformControls,U7 as Tube,e7 as VideoTexture,TB as View,mb as Wireframe,R2 as accumulativeContext,aT as calcPosFromAngles,qh as calculateScaleFactor,F9 as checkIfFrameIsEmpty,g7 as createInstances,rc as getFirstFrame,g_ as isWebGL2Available,Sb as meshBounds,Ri as shaderMaterial,h7 as useAnimations,n7 as useAspect,c7 as useBVH,zw as useBounds,f7 as useBoxProjectedEnv,r7 as useCamera,u7 as useContextBridge,aI as useCubeCamera,Fp as useCubeTexture,VB as useCursor,s7 as useDepthBuffer,$9 as useDetectGPU,Wb as useEnvironment,wi as useFBO,tf as useFBX,J2 as useFaceControls,QB as useFaceLandmarker,Xh as useFont,Qc as useGLTF,ef as useGizmoContext,s2 as useHelper,cw as useIntersect,sf as useKTX2,ZB as useKeyboardControls,Rb as useMask,CT as useMatcapTexture,fI as useMotion,wT as useNormalTexture,_b as usePerformanceMonitor,v1 as useProgress,N1 as useScroll,u_ as useSelect,E7 as useSpriteAnimator,xf as useSpriteLoader,JC as useSurfaceSampler,pn as useTexture,jC as useTrail,gw as useTrailTexture,i2 as useVideoTexture};
